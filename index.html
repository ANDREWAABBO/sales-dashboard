<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quantum Solutions Sales Force</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Condensed:wght@400;600;700&display=swap" rel="stylesheet" />

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;
      background:#1e3a8a;min-height:100vh;padding:20px;color:#333;font-size:18px;
    }

    /* Company Switcher */
    .company-switcher{
      display:flex;justify-content:center;gap:20px;padding:20px;position:sticky;top:0;z-index:1000;
      background:#000;margin:-20px -20px 30px -20px;box-shadow:0 4px 20px rgba(0,0,0,.5)
    }
    .company-btn{
      padding:12px 25px;background:rgba(255,255,255,.1);border:2px solid rgba(255,255,255,.2);color:#fff;
      font-size:18px;font-weight:600;border-radius:50px;cursor:pointer;transition:.3s;display:flex;align-items:center;gap:12px;
      backdrop-filter:blur(10px);text-decoration:none
    }
    .company-btn:hover{background:rgba(255,255,255,.2);transform:translateY(-2px);box-shadow:0 10px 30px rgba(0,0,0,.3)}
    .company-btn.active{
      background:linear-gradient(135deg,#3b82f6 0%,#1e40af 100%);border-color:transparent;
      box-shadow:0 10px 30px rgba(59,130,246,.5),0 0 60px rgba(59,130,246,.3);animation:glow 2s ease-in-out infinite alternate
    }
    @keyframes glow{from{box-shadow:0 10px 30px rgba(59,130,246,.5),0 0 60px rgba(59,130,246,.3)} to{box-shadow:0 10px 40px rgba(59,130,246,.7),0 0 80px rgba(59,130,246,.5)}}
    .company-logo{height:35px;width:auto;filter:brightness(0) invert(1);transition:.3s}
    .abbondanza-logo{height:40px}
    .company-btn:hover .company-logo{transform:scale(1.05)}

    .dashboard-container{max-width:1400px;margin:0 auto;animation:fadeIn .8s ease-out}
    @keyframes fadeIn{from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)}}
    .header{text-align:center;margin-bottom:35px;color:#fff;position:relative}
    .header h1{
      font-size:3.2em;font-weight:700;margin-bottom:10px;color:#fff;font-family:'IBM Plex Sans Condensed','Arial Narrow',sans-serif;
      letter-spacing:2px;text-transform:uppercase;text-shadow:3px 3px 6px rgba(0,0,0,.5);animation:titleGlow 3s ease-in-out infinite alternate
    }
    @keyframes titleGlow{from{filter:brightness(1)} to{filter:brightness(1.3)}}
    .header p{font-size:1.3em;opacity:.9}

    /* Grid */
    .quantum-grid{display:grid;grid-template-columns:1fr;gap:20px;max-width:800px;margin:0 auto}
    .card{
      background:rgba(255,255,255,.95);border-radius:15px;padding:20px;box-shadow:0 8px 30px rgba(0,0,0,.25);
      transition:all .3s cubic-bezier(.4,0,.2,1);position:relative;overflow:hidden
    }
    .card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,#1e3a8a 0%,#1e40af 100%);transform:scaleX(0);transform-origin:left;transition:transform .3s ease}
    .card:hover::before{transform:scaleX(1)}
    .card:hover{transform:translateY(-3px);box-shadow:0 15px 45px rgba(0,0,0,.35)}
    .card h2{font-size:1.5em;margin-bottom:10px;color:#2d3748}
    .card p{color:#718096;margin-bottom:18px;line-height:1.5;font-size:1.1em}

    .btn{
      display:inline-block;padding:12px 26px;background:#1e3a8a;color:#fff;text-decoration:none;border-radius:25px;font-weight:600;
      transition:.3s;position:relative;overflow:hidden;border:none;cursor:pointer;font-size:1.05em
    }
    .btn::after{content:'';position:absolute;top:50%;left:50%;width:0;height:0;border-radius:50%;background:rgba(255,255,255,.3);
      transform:translate(-50%,-50%);transition:width .6s,height .6s}
    .btn:hover::after{width:300px;height:300px}
    .btn:hover{transform:translateY(-2px);box-shadow:0 8px 16px rgba(30,58,138,.4);background:#1e40af}
    .logout-btn{background:#fff!important;color:#000!important;font-weight:700!important;border:2px solid rgba(255,255,255,.3)!important;box-shadow:0 4px 15px rgba(0,0,0,.3)!important}
    .logout-btn:hover{background:#f0f0f0!important;transform:scale(1.05)!important;box-shadow:0 6px 20px rgba(0,0,0,.4)!important}

    /* Modal */
    .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:10000;backdrop-filter:blur(5px)}
    .modal{
      position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;border-radius:20px;padding:25px 35px;
      max-width:900px;width:95%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.3);z-index:10001
    }
    .modal h3{margin-bottom:15px;color:#2d3748;text-align:center;font-size:1.4em}

    .form-group{margin-bottom:20px}
    .form-group label{display:block;margin-bottom:5px;color:#4a5568;font-weight:600;font-size:1.05em}
    .form-group input,.form-group select,.form-group textarea{
      width:100%;padding:14px;border:2px solid #e2e8f0;border-radius:10px;font-size:1.05em;transition:border-color .3s
    }
    .form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:#1e3a8a}
    .form-group small{display:block;margin-top:5px;color:#718096;font-size:.95em}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:15px}

    .pricing-summary{background:linear-gradient(135deg,#dbeafe 0%,#bfdbfe 100%);padding:20px;border-radius:15px;margin:20px 0;border:2px solid #1e3a8a}
    .pricing-summary h4{margin:0 0 15px 0;color:#2d3748;font-size:1.3em;text-align:center}

    .modal-buttons{display:flex;gap:15px;margin-top:25px}
    .btn-primary{background:#1e3a8a;flex:2}
    .btn-primary:hover{background:#1e40af}
    .btn-secondary{background:#64748b;flex:1}
    .btn-secondary:hover{background:#475569}
    .close-btn{background:#e53e3e;color:#fff;border:none;padding:10px 22px;border-radius:20px;cursor:pointer;font-weight:600;transition:.3s;font-size:1.05em}
    .close-btn:hover{background:#c53030;transform:scale(1.05)}

    .success-popup{background:linear-gradient(135deg,#d4edda 0%,#c3e6cb 100%);border:2px solid #28a745;color:#155724;padding:20px;border-radius:15px;text-align:center;font-size:1.05em}
    .error-popup{background:linear-gradient(135deg,#f8d7da 0%,#f5c6cb 100%);border:2px solid #dc3545;color:#721c24;padding:20px;border-radius:15px;text-align:center;font-size:1.05em}
    .loading-spinner{display:inline-block;width:20px;height:20px;border:3px solid #f3f3f3;border-top:3px solid #1e3a8a;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
  </style>
</head>

<body>
  <!-- Company Switcher -->
  <div class="company-switcher">
    <a href="index.html" class="company-btn">
      <img src="images/abbondanza-logo.png" alt="Abbondanza" class="company-logo abbondanza-logo" />
      <span>Abbondanza Vending LLC</span>
    </a>
    <button class="company-btn active">
      <img src="images/quantum-logo-transparent.png" alt="Quantum Solutions" class="company-logo" />
      <span>Quantum Solutions</span>
    </button>
  </div>

  <div class="dashboard-container">
    <div class="header">
      <h1>Quantum Solutions Dashboard</h1>
      <p>Smart Food Fridge Solutions for Modern Businesses</p>
    </div>

    <!-- Cards -->
    <div class="quantum-grid">
      <div class="card">
        <h2>How We Stack Up</h2>
        <p>Marketing materials and competitive analysis showing Quantum Solutions advantages over traditional vending.</p>
        <button onclick="openQuantumAboutUs()" class="btn">View Materials</button>
      </div>

      <div class="card">
        <h2>Proposal Management</h2>
        <p>Create and access Smart Food Fridge proposals with comprehensive pricing analysis and searchable library.</p>
        <div style="display:flex;gap:15px;margin-top:18px;">
          <button onclick="openQuantumProposalGenerator()" class="btn" style="flex:1;">Generate Proposal</button>
          <button onclick="openQuantumProposalViewer()" class="btn" style="flex:1;">View Library</button>
        </div>
      </div>

      <div class="card">
        <h2>Master Service Agreement</h2>
        <p>Print to sign comprehensive service agreements for enterprise clients and partnerships.</p>
        <button onclick="openQuantumMasterAgreement()" class="btn">View Agreement</button>
      </div>

      <div class="card">
        <h2>ROI Calculator</h2>
        <p>Interactive calculator to demonstrate cost savings and return on investment for potential clients.</p>
        <button onclick="openQuantumROICalculator()" class="btn">Open Calculator</button>
      </div>

      <div class="card">
        <h2>Lead Logger</h2>
        <p>Track and manage sales leads with company-specific categorization and comprehensive follow-up system.</p>
        <button onclick="openQuantumLeadLogger()" class="btn">Open Lead Logger</button>
      </div>
    </div>
  </div>

  <!-- Proposal Generator Modal -->
  <div id="quantumProposalModal" class="modal-overlay">
    <div class="modal">
      <h3>Generate Smart Food Fridge Proposal</h3>

      <div class="form-row">
        <div class="form-group">
          <label for="quantumCompanyName">Company Name *</label>
          <input type="text" id="quantumCompanyName" required />
        </div>
        <div class="form-group">
          <label for="quantumContactName">Contact Name (Optional)</label>
          <input type="text" id="quantumContactName" placeholder="Leave blank if unknown" />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="customerAddress">Customer Address *</label>
          <input type="text" id="customerAddress" placeholder="City, State" required />
        </div>
        <div class="form-group">
          <label for="customerZip">Customer Zip Code *</label>
          <input type="text" id="customerZip" pattern="[0-9]{5}" maxlength="5" placeholder="12345" required onchange="updateQuantumPricingSummary()" />
          <small>Used for freight calculation</small>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="quantumPreparedBy">Your Name *</label>
          <input type="text" id="quantumPreparedBy" required />
        </div>
        <div class="form-group">
          <label for="quantumPreparedByPhone">Your Phone *</label>
          <input type="tel" id="quantumPreparedByPhone" required />
        </div>
      </div>

      <div class="form-group">
        <label for="quantumPreparedByEmail">Your Email *</label>
        <input type="email" id="quantumPreparedByEmail" required />
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="customerType">Customer Type *</label>
          <select id="customerType" required onchange="updateCustomerType()">
            <option value="new" selected>New Customer (includes scanner)</option>
            <option value="existing">Existing Customer (has scanner)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="quantumFridgeCount">Number of Fridges *</label>
          <input type="number" id="quantumFridgeCount" min="1" value="1" required onchange="updateQuantumPricingSummary()" />
        </div>
      </div>

      <div class="form-group">
        <label for="scannerCount">RFID Scanners Needed</label>
        <select id="scannerCount" onchange="updateQuantumPricingSummary()">
          <option value="0">0 scanners</option>
          <option value="1" selected>1 scanner</option>
          <option value="2">2 scanners</option>
          <option value="3">3 scanners</option>
          <option value="4">4 scanners</option>
          <option value="5">5 scanners</option>
          <option value="6">6 scanners</option>
          <option value="7">7 scanners</option>
          <option value="8">8 scanners</option>
          <option value="9">9 scanners</option>
          <option value="10">10 scanners</option>
          <option value="11">11 scanners</option>
          <option value="12">12 scanners</option>
          <option value="13">13 scanners</option>
          <option value="14">14 scanners</option>
          <option value="15">15 scanners</option>
        </select>
        <small>New customers typically need 1 scanner per location. Additional scanners for backup or multiple sites.</small>
      </div>

      <div class="form-group">
        <label for="rfidRolls">RFID Tag Rolls (1,000 tags per roll)</label>
        <input type="number" id="rfidRolls" min="0" max="50" value="5" onchange="updateQuantumPricingSummary()" />
        <small>Recommended starting quantity: 5 rolls. $0.18 per tag ($180 per roll).</small>
      </div>

      <div class="pricing-summary">
        <h4>Proposal Summary</h4>
        <div id="quantumPricingSummary"></div>
      </div>

      <div class="modal-buttons">
        <button class="btn btn-secondary" onclick="closeQuantumModal('quantumProposalModal')" style="flex:1;background:#64748b;">Cancel</button>
        <button class="btn btn-primary" id="generateQuantumBtn" type="button" onclick="generateQuantumProposal()">Generate Proposal PDF</button>
      </div>
    </div>
  </div>

  <script>
    // --- Login guard for dashboard ---
    const USER_MANAGEMENT_URL = 'https://script.google.com/macros/s/AKfycbx76lEJH6uwQuaLQ_ML0IfHnS4G3saXlF-Lz7G8vKbWrUT1IMa7BZtCz9ZiqX7tIava/exec';

    function checkAuth(){
      const ok = sessionStorage.getItem('dashboardAuth') === 'true';
      const user = sessionStorage.getItem('dashboardUser');
      if(!ok || !user){
        alert('Please login first. Redirecting to login page...');
        window.location.href = 'index.html';
        return false;
      }
      return true;
    }

    function addLogoutButton(){
      const header = document.querySelector('.header');
      const user = sessionStorage.getItem('dashboardUser');
      if (user) localStorage.setItem('dashboardUser', user);

      const existing = header.querySelector('.logout-container');
      if (existing) existing.remove();

      const box = document.createElement('div');
      box.className = 'logout-container';
      box.style.cssText = 'position:absolute;top:10px;right:10px;display:flex;align-items:center;gap:30px;';

      const userInfo = document.createElement('button');
      userInfo.textContent = `üë§ ${user}`;
      userInfo.style.cssText='background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.3);color:#fff;padding:8px 15px;border-radius:20px;cursor:pointer;font-size:.9em;';
      userInfo.onclick = openUserProfile;

      const logoutBtn = document.createElement('button');
      logoutBtn.textContent = 'Logout';
      logoutBtn.className = 'btn logout-btn';
      logoutBtn.style.cssText = 'padding:10px 20px;';
      logoutBtn.onclick = logout;

      box.appendChild(userInfo);
      box.appendChild(logoutBtn);
      header.appendChild(box);
    }

    function openUserProfile(){
      const user = sessionStorage.getItem('dashboardUser');
      const email = sessionStorage.getItem('userEmail');
      const company = sessionStorage.getItem('userCompany');
      alert(`Profile: ${user}\nEmail: ${email}\nCompany: ${company}\n\nPassword change feature coming soon!`);
    }

    function logout(){
      sessionStorage.clear();
      localStorage.removeItem('dashboardUser');
      window.location.href = 'index.html';
    }

    window.addEventListener('DOMContentLoaded', () => { if (checkAuth()) addLogoutButton(); });

    // -------- Materials Modal --------
    function openQuantumAboutUs(){
      const existing = document.querySelector('.modal-overlay'); if (existing) existing.remove();
      const overlay = document.createElement('div'); overlay.className='modal-overlay'; overlay.style.display='block';
      const modal = document.createElement('div'); modal.className='modal';

      const materials = [
        { title:'Restaurant Industry Trends Report', id:'1MejzxfsJ7VHR9OzwYuO7iEWUdDPrcLzO', description:'Current market trends and insights for the restaurant industry', type:'pdf' },
        { title:'Maximizing Revenue Per Square Foot in Food Service Operations', id:'1hTRsDlrx0MRzmdVrqrOyfqg5-Gj-6RQC', description:'Strategies to optimize space utilization and increase profitability', type:'pdf' },
        { title:'Fresh Food Fridge Spec Sheet', id:'1RO1IXd032eCKM4z4gr09QSouIyGXA8R74PSXj5afIas', description:'Technical specifications and features of our Smart Food Fridge', type:'slides' },
        { title:'Food Fridge Executive Overview', id:'1YFa7vPZC89YE4OM5wW5LTGwF5WD3lZAE', description:'High-level overview and business benefits for decision makers', type:'pdf' },
        { title:'Commercial Real Estate Premium Food Amenities', id:'1eUfU0i5WD9KEg46biTguBCyQef_OxBi0', description:'How premium food amenities enhance commercial property value', type:'pdf' },
        { title:'Smart RFID Refrigerated Fresh Food Fridge Technical Deep Dive and FAQ', id:'1zmo7_EccscAMQ-10q5yFF9k9vFdXHe3c', description:'Comprehensive technical documentation and frequently asked questions', type:'pdf' },
        { title:'Food Fridge Presentation Slide Deck With Proposal Example', id:'19hC90aDJgAQCiNOPACjzhxEdFoE2iaUMpfirP3kAgzs', description:'Robust presentation with how-to videos and proposal', type:'slides' }
      ];

      modal.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;padding-bottom:15px;border-bottom:2px solid #e2e8f0;">
          <h3 style="margin:0;color:#2d3748;font-size:1.8em;">How We Stack Up - Marketing Materials</h3>
          <button class="close-btn" onclick="closeModal()">‚úï</button>
        </div>
        <div style="display:grid;gap:20px;">
          ${materials.map(m=>{
            let viewUrl, downloadUrl;
            if (m.type==='slides'){ viewUrl=`https://docs.google.com/presentation/d/${m.id}/preview`; downloadUrl=`https://docs.google.com/presentation/d/${m.id}/export/pdf`; }
            else if (m.type==='docs'){ viewUrl=`https://docs.google.com/document/d/${m.id}/preview`; downloadUrl=`https://docs.google.com/document/d/${m.id}/export?format=pdf`; }
            else if (m.type==='sheets'){ viewUrl=`https://docs.google.com/spreadsheets/d/${m.id}/preview`; downloadUrl=`https://docs.google.com/spreadsheets/d/${m.id}/export?format=pdf`; }
            else { viewUrl=`https://drive.google.com/file/d/${m.id}/view`; downloadUrl=`https://drive.google.com/uc?export=download&id=${m.id}`; }
            return `
              <div style="background:#f8fafc;padding:25px;border-radius:15px;border:2px solid #e2e8f0;transition:.3s;">
                <div style="margin-bottom:20px;">
                  <h4 style="margin:0 0 10px 0;color:#1e3a8a;font-size:1.2em;font-weight:600">${m.title}</h4>
                  <p style="margin:0;color:#64748b;font-size:.95em;line-height:1.5">${m.description}</p>
                </div>
                <div style="display:flex;gap:15px;flex-wrap:wrap;">
                  <button class="btn btn-primary" onclick="window.open('${viewUrl}','_blank')" style="padding:12px 24px;font-size:.9em;min-width:120px;font-weight:600">üëÅÔ∏è View PDF</button>
                  <button class="btn btn-secondary" onclick="window.open('${downloadUrl}','_blank')" style="padding:12px 24px;font-size:.9em;min-width:120px;font-weight:600">üì• Download</button>
                </div>
              </div>`;
          }).join('')}
        </div>`;
      overlay.appendChild(modal); document.body.appendChild(overlay);
    }

    function closeModal(){ const o=document.querySelector('.modal-overlay'); if (o) o.remove(); }

    // -------- Proposal Generator --------
    function openQuantumProposalGenerator(){
      const existing = document.getElementById('quantumProposalModal');
      if (existing) existing.style.display='none';
      setTimeout(()=>{
        const modal = document.getElementById('quantumProposalModal');
        if (modal){
          modal.style.display='block';
          updateQuantumPricingSummary();
          const btn = document.getElementById('generateQuantumBtn');
          if (btn){
            const clone=btn.cloneNode(true); btn.parentNode.replaceChild(clone,btn);
            clone.addEventListener('click', generateQuantumProposal);
          }
        }
      },100);
    }
    function closeQuantumModal(id){ const el=document.getElementById(id); if (el) el.style.display='none'; }

    function updateCustomerType(){
      const t=document.getElementById('customerType').value;
      const s=document.getElementById('scannerCount');
      s.value = (t==='new') ? 1 : 0;
      updateQuantumPricingSummary();
    }
    function calculateFreight(){
      const n=parseInt(document.getElementById('quantumFridgeCount').value)||1;
      const zip=(document.getElementById('customerZip').value||'').trim();
      let base = (n===1)?895:(n===2)?1400:(n===3)?1800:n*550;
      let mult=1.0;
      if (zip){
        const z=+zip;
        if (z>=20000 && z<=39999) mult=1.2;
        else if (z>=40000) mult=1.5;
      }
      return Math.round(base*mult);
    }
    function updateQuantumPricingSummary(){
      const fc = +document.getElementById('quantumFridgeCount').value || 1;
      const sc = +document.getElementById('scannerCount').value || 0;
      const rr = +document.getElementById('rfidRolls').value || 0;

      const fridgePrice=7500, scannerPrice=455, rfidRollPrice=180;
      const freight = calculateFreight();

      const fridgeTotal = fc*fridgePrice;
      const scannerTotal= sc*scannerPrice;
      const rfidTotal   = rr*rfidRollPrice;

      const oneTimeTotal = fridgeTotal + scannerTotal + rfidTotal + freight;

      const monthlyLicense = fc*175;
      const monthlyLTE     = fc*25;
      const monthlyGold    = 0;
      const monthlyTotal   = monthlyLicense + monthlyLTE + monthlyGold;

      document.getElementById('quantumPricingSummary').innerHTML = `
        <div style="margin-bottom:15px;">
          <h4 style="color:#1e3a8a;margin-bottom:10px;">One-Time Costs</h4>
          <div>Food Fridges (${fc}): $${fridgeTotal.toLocaleString()}</div>
          ${sc>0?`<div>RFID Scanners (${sc}): $${scannerTotal.toLocaleString()}</div>`:''}
          ${rr>0?`<div>RFID Tags (${rr} rolls): $${rfidTotal.toLocaleString()}</div>`:''}
          <div>Freight: $${freight.toLocaleString()}</div>
          <div style="font-weight:bold;color:#1e3a8a;margin-top:10px;padding-top:10px;border-top:1px solid #e2e8f0;">
            One-Time Total: $${oneTimeTotal.toLocaleString()}
          </div>
        </div>
        <div>
          <h4 style="color:#1e3a8a;margin-bottom:10px;">Monthly Recurring</h4>
          <div>License Fees: $${monthlyLicense.toLocaleString()}/month</div>
          <div>LTE Service: $${monthlyLTE.toLocaleString()}/month</div>
          <div style="font-weight:bold;color:#1e3a8a;margin-top:10px;padding-top:10px;border-top:1px solid #e2e8f0;">
            Monthly Total: $${monthlyTotal.toLocaleString()}/month
          </div>
        </div>`;
    }

    async function generateQuantumProposal(ev){
      if (ev){ ev.preventDefault(); ev.stopPropagation(); }
      const btn = document.getElementById('generateQuantumBtn');
      const txt = btn.innerHTML; if (btn.disabled) return;
      btn.disabled=true; btn.innerHTML='<span class="loading-spinner"></span> Generating...';

      try{
        const data = {
          companyName:document.getElementById('quantumCompanyName').value,
          contactName:document.getElementById('quantumContactName').value||'',
          customerAddress:document.getElementById('customerAddress').value,
          customerZip:document.getElementById('customerZip').value,
          preparedBy:document.getElementById('quantumPreparedBy').value,
          preparedByPhone:document.getElementById('quantumPreparedByPhone').value,
          preparedByEmail:document.getElementById('quantumPreparedByEmail').value,
          customerType:document.getElementById('customerType').value,
          fridgeCount:document.getElementById('quantumFridgeCount').value,
          scannerCount:document.getElementById('scannerCount').value,
          rfidRolls:document.getElementById('rfidRolls').value||'0',
          vinylWrap:'No', goldSupport:'No'
        };
        if (!data.companyName || !data.preparedBy || !data.preparedByPhone || !data.preparedByEmail){
          throw new Error('Please fill in all required fields.');
        }

        const URL = 'https://script.google.com/macros/s/AKfycbxo7BkKNseerdgo0fBmIHkRcWF7XPt8EeuqRN_9hVgoqKVA1AxudQeStsdu_kyM7ADXHA/exec';
        const qs = new URLSearchParams(data).toString();
        const res = await fetch(`${URL}?${qs}`);
        const j   = await res.json();

        if (j.status==='success'){
          closeQuantumModal('quantumProposalModal');
          showQuantumPopup(`
            <div class="success-popup">
              <h3>‚úÖ Proposal Generated Successfully!</h3>
              <p>Your Smart Food Fridge proposal has been created and saved to Library.</p>
              <p><strong>Company:</strong> ${data.companyName}</p>
              <p><strong>Configuration:</strong> ${data.fridgeCount} fridges, ${data.scannerCount} scanners</p>
              <p><strong>Total Cost:</strong> $${j.data.pricing.oneTimeTotal.toLocaleString()} one-time + $${j.data.pricing.monthlyTotal}/month</p>
              <div style="margin-top:20px;display:flex;gap:10px;justify-content:center;">
                <button class="btn btn-primary" onclick="window.open('${j.pdfUrl}','_blank')" style="padding:12px 24px;">üìÑ View PDF</button>
                <button class="btn btn-secondary" onclick="window.open('${j.pdfUrl.replace('/view?','/export?format=pdf&')}','_blank')" style="padding:12px 24px;">üì• Download</button>
              </div>
            </div>`,`success`);
        } else {
          throw new Error(j.message || 'Failed to generate proposal');
        }
      }catch(err){
        showQuantumPopup(`
          <div class="error-popup">
            <h3>‚ùå Error Generating Proposal</h3>
            <p>${err.message}</p>
            <p>Please try again or contact support if the problem persists.</p>
          </div>`,`error`);
      }finally{
        btn.disabled=false; btn.innerHTML=txt;
      }
    }

    function showQuantumPopup(content,type){
      const pop=document.createElement('div');
      pop.className='modal-overlay'; pop.style.display='block';
      pop.innerHTML = `
        <div class="modal" style="max-width:600px;">
          ${content}
          <div style="margin-top:20px;text-align:center;">
            <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Close</button>
          </div>
        </div>`;
      document.body.appendChild(pop);
      if (type==='success'){ setTimeout(()=>{ if(pop.parentNode) pop.remove(); },15000); }
    }

    // -------- MSA Viewer --------
    function openQuantumMasterAgreement(){
      const existing=document.querySelector('.modal-overlay'); if (existing) existing.remove();
      const overlay=document.createElement('div'); overlay.className='modal-overlay'; overlay.style.display='block';
      const modal=document.createElement('div'); modal.className='modal';
      modal.style.maxWidth='1200px'; modal.style.height='90vh'; modal.style.display='flex'; modal.style.flexDirection='column';

      const docId='1ChcyX_PUlX48AhzAkNtsDWduamgQHomYSYM9LVwd3FA';
      const pdfUrl=`https://docs.google.com/document/d/${docId}/export?format=pdf`;
      const viewer=`https://docs.google.com/document/d/${docId}/preview`;

      modal.innerHTML = `
        <div style="padding:20px;background:#f7fafc;border-radius:20px 20px 0 0;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #e2e8f0;">
          <h3 style="margin:0;color:#2d3748;font-size:1.3em;">Master Services Agreement (Food Fridge)</h3>
          <div style="display:flex;gap:10px;align-items:center;">
            <button class="btn btn-secondary" onclick="window.open('${pdfUrl}','_blank')" style="padding:10px 20px;">üì• Download PDF</button>
            <button class="close-btn" onclick="closeModal()">‚úï</button>
          </div>
        </div>
        <div style="flex:1;padding:20px;overflow:hidden;">
          <iframe src="${viewer}" width="100%" height="100%" style="border:none;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.1);" allowfullscreen></iframe>
        </div>`;
      overlay.appendChild(modal); document.body.appendChild(overlay);
    }

    // -------- ROI Calculator in modal (local file) --------
    function openQuantumROICalculator(){
      const existing=document.querySelector('.modal-overlay.roi-overlay'); if (existing) existing.remove();
      const overlay=document.createElement('div'); overlay.className='modal-overlay roi-overlay'; overlay.style.display='block';
      const modal=document.createElement('div'); modal.className='modal';
      modal.style.maxWidth='1200px'; modal.style.height='90vh'; modal.style.display='flex'; modal.style.flexDirection='column';

      const src='roi-calculator.html'; // local keeps deep blue + Operator Mode
      modal.innerHTML = `
        <div style="padding:14px 16px;background:#f7fafc;border-radius:20px 20px 0 0;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #e2e8f0;">
          <h3 style="margin:0;color:#1e3a8a;font-size:1.2em;">ROI Calculator</h3>
          <button class="close-btn" onclick="document.querySelector('.roi-overlay').remove()">‚úï</button>
        </div>
        <div style="flex:1;padding:12px;overflow:hidden;">
          <iframe src="${src}" width="100%" height="100%" style="border:none;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.08);" allowfullscreen></iframe>
        </div>`;
      overlay.appendChild(modal); document.body.appendChild(overlay);
    }

    // -------- Lead Logger (separate page) --------
    function openQuantumLeadLogger(){ window.location.href='lead-logger.html'; }

    // -------- Proposal Library Viewer --------
    function openQuantumProposalViewer(){
      const existing=document.querySelector('.proposal-viewer-overlay'); if (existing) existing.remove();
      window.allQuantumProposals=null;

      const overlay=document.createElement('div'); overlay.className='modal-overlay proposal-viewer-overlay'; overlay.style.display='block';
      const modal=document.createElement('div'); modal.className='modal'; modal.style.maxWidth='1000px';

      modal.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;padding-bottom:15px;border-bottom:2px solid #e2e8f0;">
          <h3 style="margin:0;color:#2d3748;font-size:1.8em;">Quantum Proposal Library</h3>
          <button class="close-btn" onclick="closeQuantumProposalViewer()">‚úï</button>
        </div>
        <div style="margin-bottom:20px;position:relative;">
          <input type="text" id="quantumProposalSearch" placeholder="Search by company name..."
            style="width:100%;padding:15px 45px 15px 15px;font-size:16px;border:2px solid #e2e8f0;border-radius:10px;transition:.3s"
            onkeyup="filterQuantumProposals()" onfocus="this.style.borderColor='#1e3a8a'" onblur="this.style.borderColor='#e2e8f0'">
          <button id="clearQuantumSearchBtn" onclick="document.getElementById('quantumProposalSearch').value=''; this.style.display='none'; filterQuantumProposals();"
            style="position:absolute;right:10px;top:50%;transform:translateY(-50%);background:#e2e8f0;border:none;border-radius:50%;width:30px;height:30px;cursor:pointer;display:none;transition:.3s;font-size:18px;color:#4a5568;">√ó</button>
        </div>
        <div id="quantumProposalsList" style="display:grid;gap:15px;max-height:60vh;overflow-y:auto;">
          <div style="text-align:center;padding:40px;">
            <div class="loading-spinner"></div>
            <p style="margin-top:20px;color:#718096;">Loading proposals from library...</p>
          </div>
        </div>`;
      overlay.appendChild(modal); document.body.appendChild(overlay);
      setTimeout(loadQuantumProposalsFromDrive, 100);
    }
    function closeQuantumProposalViewer(){ const o=document.querySelector('.proposal-viewer-overlay'); if (o) o.remove(); }

    async function loadQuantumProposalsFromDrive(){
      try{
        const cb='quantumProposalsCb_'+Date.now();
        const promise=new Promise((resolve,reject)=>{
          window[cb]=(data)=>{ delete window[cb]; resolve(data); };
          setTimeout(()=>{ delete window[cb]; reject(new Error('Request timeout')); }, 20000);
        });
        const s=document.createElement('script');
        const url=`https://script.google.com/macros/s/AKfycbxo7BkKNseerdgo0fBmIHkRcWF7XPt8EeuqRN_9hVgoqKVA1AxudQeStsdu_kyM7ADXHA/exec?action=getProposals&callback=${cb}`;
        s.src=url; s.onerror=()=>{ delete window[cb]; showLoadErr(); }; document.body.appendChild(s);
        const data=await promise; document.body.removeChild(s);
        if (data.status==='success'){
          const list=(data.proposals||[]).sort((a,b)=>new Date(b.modifiedTime)-new Date(a.modifiedTime));
          window.allQuantumProposals=list; displayQuantumProposals(list);
        }else{ showLoadErr(data.message||'Failed to load proposals'); }
      }catch(err){ showLoadErr(err.message); }
      function showLoadErr(msg){
        const box=document.getElementById('quantumProposalsList');
        box.innerHTML = `
          <div style="text-align:center;padding:40px;">
            <p style="color:#e53e3e;margin-bottom:20px;font-size:18px;">Unable to load proposals.</p>
            <p style="color:#718096;margin-bottom:20px;">${msg||''}</p>
            <button class="btn btn-primary" onclick="loadQuantumProposalsFromDrive()">Try Again</button>
          </div>`;
      }
    }
    function displayQuantumProposals(proposals){
      const box=document.getElementById('quantumProposalsList'); if (!box) return;
      if (!proposals.length){ box.innerHTML=`<div style="text-align:center;padding:40px;color:#718096;">No proposals found in the library.</div>`; return; }
      box.innerHTML = proposals.map(p=>`
        <div class="proposal-item" style="background:#fff;padding:25px;border-radius:15px;border:2px solid #e2e8f0;transition:.3s;box-shadow:0 2px 8px rgba(0,0,0,.05);"
          onmouseover="this.style.borderColor='#1e3a8a';this.style.transform='translateY(-3px)';this.style.boxShadow='0 8px 20px rgba(0,0,0,.1)'"
          onmouseout="this.style.borderColor='#e2e8f0';this.style.transform='translateY(0)';this.style.boxShadow='0 2px 8px rgba(0,0,0,.05)'">
          <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:15px;">
            <div style="flex:1;min-width:200px;">
              <h4 style="margin:0 0 8px 0;color:#2d3748;font-size:18px;">${p.companyName}</h4>
              <p style="margin:0;color:#718096;font-size:14px;">
                ${p.name}<br>Modified: ${p.modifiedTime ? new Date(p.modifiedTime).toLocaleDateString() : 'Unknown'}
              </p>
            </div>
            <div style="display:flex;gap:12px;flex-wrap:wrap;">
              <button class="btn btn-primary" onclick="viewQuantumProposalPDF('${p.id}','${p.companyName.replace(/'/g,'\\\'')}')" style="padding:14px 28px;font-size:16px;font-weight:600;min-width:120px;">üìÑ View</button>
              <button class="btn btn-secondary" onclick="window.open('https://drive.google.com/uc?export=download&id=${p.id}','_blank')" style="padding:14px 28px;font-size:16px;font-weight:600;min-width:120px;">üì• Download</button>
            </div>
          </div>
        </div>`).join('');
    }
    function filterQuantumProposals(){
      const q=document.getElementById('quantumProposalSearch').value.toLowerCase();
      const clear=document.getElementById('clearQuantumSearchBtn'); clear.style.display = q.length>0?'block':'none';
      if (!window.allQuantumProposals) return;
      if (!q){ displayQuantumProposals(window.allQuantumProposals); return; }
      const f=window.allQuantumProposals.filter(p=>(p.companyName||'').toLowerCase().includes(q)||(p.name||'').toLowerCase().includes(q));
      const box=document.getElementById('quantumProposalsList');
      if (!f.length){
        box.innerHTML = `<div style="text-align:center;padding:40px;color:#718096;">
          <p style="font-size:18px;">No proposals found matching "<strong>${q}</strong>"</p>
          <p style="margin-top:10px;">Try searching for a different company name.</p>
        </div>`;
      } else displayQuantumProposals(f);
    }
    function viewQuantumProposalPDF(fileId, companyName){
      closeQuantumProposalViewer();
      const overlay=document.createElement('div'); overlay.className='modal-overlay'; overlay.style.display='block';
      const pdfModal=document.createElement('div'); pdfModal.className='modal'; pdfModal.style.maxWidth='1200px';
      pdfModal.style.height='90vh'; pdfModal.style.display='flex'; pdfModal.style.flexDirection='column';
      const viewerUrl=`https://drive.google.com/file/d/${fileId}/preview?usp=embed`;
      pdfModal.innerHTML = `
        <div style="padding:20px;background:#f7fafc;border-radius:20px 20px 0 0;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #e2e8f0;">
          <h3 style="margin:0;color:#2d3748;font-size:1.3em;">Proposal for ${companyName}</h3>
          <div style="display:flex;gap:10px;align-items:center;">
            <button class="btn btn-primary" onclick="closeModal(); setTimeout(openQuantumProposalViewer,200);" style="padding:10px 20px;">Back to Library</button>
            <button class="btn btn-secondary" onclick="window.open('https://drive.google.com/uc?export=download&id=${fileId}','_blank')" style="padding:10px 20px;">Download</button>
          </div>
        </div>
        <div style="flex:1;padding:20px;overflow:hidden;">
          <iframe src="${viewerUrl}" width="100%" height="100%" style="border:none;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.1);" allowfullscreen></iframe>
        </div>`;
      overlay.appendChild(pdfModal); document.body.appendChild(overlay);
    }

    // Close overlay when clicking outside
    window.onclick = function(ev){ if (ev.target.classList.contains('modal-overlay')) closeModal(); };
  </script>

  <!-- ========== JSONP Auth Helper (register/login/change/forgot) ‚Äî CORS-safe ========== -->
  <script>
    // Use the same Apps Script Web App URL you deployed for user management:
    const USER_API = 'https://script.google.com/macros/s/AKfycbx76lEJH6uwQuaLQ_ML0IfHnS4G3saXlF-Lz7G8vKbWrUT1IMa7BZtCz9ZiqX7tIava/exec';

    function jsonp(url, params={}){
      return new Promise((resolve,reject)=>{
        const cb='cb_'+Math.random().toString(36).slice(2);
        const qs=new URLSearchParams({ ...params, callback:cb });
        const s=document.createElement('script'); s.src = `${url}?${qs.toString()}`;
        window[cb]=(data)=>{ resolve(data); cleanup(); };
        s.onerror=()=>{ reject(new Error('JSONP request failed')); cleanup(); };
        document.head.appendChild(s);
        function cleanup(){ try{ delete window[cb]; }catch(_){ } if(s&&s.parentNode) s.parentNode.removeChild(s); }
      });
    }

    // Simple API facade you can call from any page/modal:
    const UM = {
      request(action, params){ return jsonp(USER_API, { action, ...params }); },
      register({ username, email, password, company }){ return UM.request('register', { username, email, password, company }); },
      login({ username, password }){ return UM.request('login', { username, password }); },
      changePassword({ username, oldPassword, newPassword }){ return UM.request('changePassword', { username, oldPassword, newPassword }); },
      requestPasswordReset({ usernameOrEmail }){ return UM.request('requestPasswordReset', { usernameOrEmail }); },
      resetPassword({ token, newPassword }){ return UM.request('resetPassword', { token, newPassword }); }
    };

    // Example (leave commented):
    // UM.login({ username:'demo', password:'Aa!23456' }).then(console.log);
  </script>
</body>
</html>
