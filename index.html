<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sales Team Dashboard</title>

<!-- Minimal styling to match your look without the giant file -->
<style>
  :root { --brand:#1e3a8a; --brand-dark:#1e40af; --ok:#059669; --err:#dc3545; }
  *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    background:#1e3a8a; color:#111; min-height:100vh}
  .header{max-width:1100px;margin:24px auto 8px; padding:0 16px; position:relative; color:#fff; text-align:center}
  .header h1{margin:.2rem 0;font-weight:800;letter-spacing:.5px}
  .company-switcher{display:flex;justify-content:center;gap:12px;padding:10px 16px;background:#000}
  .company-btn{display:flex;align-items:center;gap:10px;color:#fff;background:#000;border:1px solid #333;
    border-radius:999px;padding:10px 16px;cursor:pointer}
  .company-btn.active{background:linear-gradient(135deg,#3b82f6,#1e40af);border-color:transparent}
  .btn{display:inline-block;background:var(--brand);color:#fff;border:none;border-radius:10px;
    padding:12px 16px;font-weight:700;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .btn.secondary{background:#64748b}
  .btn.ok{background:var(--ok)} .btn.dark{background:#0f172a}
  .toast{position:fixed;top:18px;right:18px;background:#111;color:#fff;padding:10px 14px;border-radius:8px;z-index:99999}
  /* Modal */
  #loginOverlay{position:fixed;inset:0;background:rgba(0,0,0,.75);display:flex;align-items:center;justify-content:center;z-index:9999}
  #loginModal{width:min(440px,92vw);background:#fff;border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,.35);
    padding:26px}
  .muted{color:#64748b}
  .field{margin:10px 0 14px}
  .field input{width:100%;padding:12px 14px;border:2px solid #e2e8f0;border-radius:10px;font-size:16px}
  .tabs{display:flex;gap:14px;justify-content:center;margin:6px 0 10px}
  .tabs a{font-size:14px;color:#0f172a}
  .error{background:#f8d7da;color:#721c24;border:1px solid #dc3545;padding:10px 12px;border-radius:8px;margin-bottom:10px}
  .okmsg{background:#d4edda;color:#155724;border:1px solid #28a745;padding:10px 12px;border-radius:8px;margin-bottom:10px}
  .loading-spinner{display:inline-block;width:18px;height:18px;border:3px solid #eee;border-top:3px solid var(--brand);
    border-radius:50%;animation:spin 1s linear infinite;vertical-align:-3px;margin-right:8px}
  @keyframes spin{to{transform:rotate(360deg)}}
  .logout-container{position:absolute;right:16px;top:0}
</style>

<script>
/* ========= CONFIG: replace with your live /exec URLs if needed ========= */
const USER_MANAGEMENT_URL = 'https://script.google.com/macros/s/AKfycbx76lEJH6uwQuaLQ_ML0IfHnS4G3saXlF-Lz7G8vKbWrUT1IMa7BZtCz9ZiqX7tIava/exec';

/* ========= Auth helpers ========= */
const PASSWORD_COMPLEXITY=/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[^\w\s]).{8,}$/;

function jsonpCall(endpoint, params={}, timeoutMs=15000){
  return new Promise((resolve,reject)=>{
    const cb='cb_'+Date.now()+'_'+Math.floor(Math.random()*1e6);
    const usp=new URLSearchParams({...params,callback:cb}).toString();
    const url=endpoint+(endpoint.includes('?')?'&':'?')+usp;
    const s=document.createElement('script'); let done=false;
    window[cb]=(data)=>{if(done)return;done=true;cleanup();resolve(data)};
    s.onerror=()=>{if(done)return;done=true;cleanup();reject(new Error('network'))};
    s.src=url; document.body.appendChild(s);
    console.log('[auth] JSONP ->', url);
    const t=setTimeout(()=>{if(done)return;done=true;cleanup();reject(new Error('timeout'))},timeoutMs);
    function cleanup(){clearTimeout(t);try{delete window[cb]}catch{};if(s.parentNode)s.parentNode.removeChild(s)}
  });
}

function checkAuth(){
  const ok = sessionStorage.getItem('dashboardAuth')==='true' &&
             !!sessionStorage.getItem('dashboardUser');
  if(!ok) return showLoginForm(), false;
  addLogoutButton(); return true;
}

/* ========= UI (Modal) ========= */
function showLoginForm(){
  if(document.getElementById('loginOverlay')) return;
  const overlay=document.createElement('div'); overlay.id='loginOverlay';
  overlay.innerHTML = `
    <div id="loginModal">
      <h2 style="color:var(--brand);margin:0 0 6px;font-weight:800;text-align:center">Dashboard Access</h2>
      <p class="muted" style="text-align:center;margin:0 0 12px">Login or create a new account</p>

      <div id="banner" style="display:none"></div>

      <div class="tabs">
        <a href="#" onclick="switchTab('login');return false;">Login</a>
        <a href="#" onclick="switchTab('register');return false;">Create account</a>
        <a href="#" onclick="switchTab('forgot');return false;">Forgot password</a>
        <a href="#" onclick="switchTab('reset');return false;">Reset with token</a>
      </div>

      <div id="tab-login">
        <form id="loginForm">
          <div class="field"><input id="loginUsername" placeholder="Username or Email" autocomplete="username"></div>
          <div class="field"><input id="loginPassword" type="password" placeholder="Password" autocomplete="current-password"></div>
          <button class="btn" type="submit" style="width:100%">Login</button>
        </form>
      </div>

      <div id="tab-register" style="display:none">
        <form id="registerForm">
          <div class="field"><input id="regUsername" placeholder="Choose Username" autocomplete="off"></div>
          <div class="field"><input id="regEmail" type="email" placeholder="Email Address" autocomplete="email"></div>
          <div class="field"><input id="regPassword" type="password" placeholder="Choose Password"></div>
          <div class="field"><input id="regConfirmPassword" type="password" placeholder="Confirm Password"></div>
          <div class="field"><input id="regCompany" placeholder="Company (optional)" value="None"></div>
          <div class="muted" style="font-size:13px;margin-bottom:8px">
            Password must be 8+ chars and include upper, lower, number, special
          </div>
          <button class="btn ok" type="submit" style="width:100%">Create Account</button>
          <button class="btn secondary" type="button" style="width:100%;margin-top:8px" onclick="switchTab('login')">Back to Login</button>
        </form>
      </div>

      <div id="tab-forgot" style="display:none">
        <div class="field"><input id="fpUser" placeholder="Username or Email"></div>
        <button class="btn" style="width:100%" onclick="doRequestReset()">Send reset token</button>
        <p class="muted" style="margin-top:10px">Youâ€™ll get a reset token (shown here for testing). In production, email this.</p>
      </div>

      <div id="tab-reset" style="display:none">
        <div class="field"><input id="rpToken" placeholder="Paste reset token"></div>
        <div class="field"><input id="rpNew" type="password" placeholder="New password"></div>
        <button class="btn" style="width:100%" onclick="doApplyReset()">Apply new password</button>
      </div>

      <div id="authError" class="error" style="display:none"></div>
      <div id="authSuccess" class="okmsg" style="display:none"></div>
    </div>`;
  document.body.appendChild(overlay);
  setupLoginHandler(); setupRegisterHandler();
  setTimeout(()=>document.getElementById('loginUsername')?.focus(),100);
}
function switchTab(name){
  ['login','register','forgot','reset'].forEach(n=>{
    document.getElementById('tab-'+n).style.display = (n===name)?'block':'none';
  });
  hideMessages();
}

/* ========= Handlers ========= */
function setupLoginHandler(){
  document.getElementById('loginForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const btn=e.target.querySelector('button[type="submit"]'), txt=btn.innerHTML;
    btn.disabled=true; btn.innerHTML='<span class="loading-spinner"></span> Logging in...';
    hideMessages();
    const username=document.getElementById('loginUsername').value.trim();
    const password=document.getElementById('loginPassword').value;
    try{
      const res=await jsonpCall(USER_MANAGEMENT_URL,{action:'login',username,password});
      if(res?.success){
        sessionStorage.setItem('dashboardAuth','true');
        sessionStorage.setItem('dashboardUser',res.username||username);
        sessionStorage.setItem('userEmail',res.email||'');
        sessionStorage.setItem('userCompany',res.company||'');
        document.getElementById('loginOverlay')?.remove();
        addLogoutButton(); toast('Login successful');
      }else{
        showError(res?.message||'Invalid username or password');
      }
    }catch(_){ showError('Network error during login'); }
    finally{ btn.disabled=false; btn.innerHTML=txt; }
  });
}
function setupRegisterHandler(){
  document.getElementById('registerForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const btn=e.target.querySelector('button[type="submit"]'), txt=btn.innerHTML;
    btn.disabled=true; btn.innerHTML='<span class="loading-spinner"></span> Creating...';
    hideMessages();
    const u=document.getElementById('regUsername').value.trim();
    const em=document.getElementById('regEmail').value.trim();
    const pw=document.getElementById('regPassword').value;
    const pw2=document.getElementById('regConfirmPassword').value;
    const co=(document.getElementById('regCompany').value||'').trim()||'None';

    if(pw!==pw2){ btnReset(); return showError('Passwords do not match'); }
    if(!PASSWORD_COMPLEXITY.test(pw)){ btnReset(); return showError('Password must be 8+ chars and include upper, lower, number, special'); }
    if(u.length<3){ btnReset(); return showError('Username must be at least 3 characters'); }

    try{
      const res=await jsonpCall(USER_MANAGEMENT_URL,{action:'register',username:u,email:em,password:pw,company:co});
      if(res?.success){
        showSuccess('Account created! You can now login.');
        setTimeout(()=>{ switchTab('login'); document.getElementById('loginUsername').value=u; }, 800);
      }else{ showError(res?.message||'Registration failed'); }
    }catch(_){ showError('Network error during registration'); }
    finally{ btnReset(); }
    function btnReset(){ btn.disabled=false; btn.innerHTML=txt; }
  });
}

/* ========= Forgot/Reset flows ========= */
async function doRequestReset(){
  hideMessages();
  const el=document.getElementById('fpUser'); const id=el.value.trim(); if(!id) return showError('Enter username or email.');
  try{
    const res=await jsonpCall(USER_MANAGEMENT_URL,{action:'requestReset',usernameOrEmail:id});
    if(res?.success){ showSuccess('Reset token generated: '+(res.resetToken||'(check sheet)')); }
    else{ showError(res?.message||'Could not generate reset token'); }
  }catch(_){ showError('Network error requesting reset'); }
}
async function doApplyReset(){
  hideMessages();
  const token=document.getElementById('rpToken').value.trim();
  const newPw=document.getElementById('rpNew').value;
  if(!token || !newPw) return showError('Enter token and new password.');
  if(!PASSWORD_COMPLEXITY.test(newPw)) return showError('New password must be 8+ chars and include upper, lower, number, special');
  try{
    const res=await jsonpCall(USER_MANAGEMENT_URL,{action:'resetPassword',token:token,newPassword:newPw});
    if(res?.success){ showSuccess('Password has been reset. Please login.'); switchTab('login'); }
    else{ showError(res?.message||'Reset failed'); }
  }catch(_){ showError('Network error applying reset'); }
}

/* ========= Misc UI helpers ========= */
function showError(m){ const e=document.getElementById('authError'); e.textContent=m; e.style.display='block';
  document.getElementById('authSuccess').style.display='none'; }
function showSuccess(m){ const s=document.getElementById('authSuccess'); s.textContent=m; s.style.display='block';
  document.getElementById('authError').style.display='none'; }
function hideMessages(){ document.getElementById('authError').style.display='none'; document.getElementById('authSuccess').style.display='none'; }
function toast(msg){ const t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t);
  setTimeout(()=>t.remove(),2500); }

function addLogoutButton(){
  const header=document.querySelector('.header'); if(!header) return;
  header.querySelector('.logout-container')?.remove();
  const wrap=document.createElement('div'); wrap.className='logout-container';
  const user=sessionStorage.getItem('dashboardUser')||'';
  wrap.innerHTML=`<button class="btn dark" onclick="logout()">Logout</button>
                  <span style="color:#fff;margin-left:8px">ðŸ‘¤ ${user}</span>`;
  header.appendChild(wrap);
}
function logout(){ sessionStorage.clear(); location.reload(); }

/* ========= On load ========= */
document.addEventListener('DOMContentLoaded',()=>{ checkAuth(); });
</script>
</head>

<body>
  <!-- Company Switcher (kept simple) -->
  <div class="company-switcher">
    <button class="company-btn active" onclick="this.classList.add('active')">Abbondanza Vending LLC</button>
    <button class="company-btn" onclick="location.href='quantum.html'">Quantum Solutions</button>
  </div>

  <!-- Header -->
  <div class="header">
    <h1>Abbondanza Sales Force</h1>
    <p>Access all your sales resources in one place</p>
  </div>

  <!-- Main content placeholder (keep lightweight; your existing cards/sections can go here) -->
  <main style="max-width:1100px;margin:0 auto;padding:0 16px;color:#fff;text-align:center">
    <p style="opacity:.9">Content loads after you sign in.</p>
    <button class="btn" onclick="showLoginForm()">Open Login</button>
  </main>
</body>
</html>
