<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Account Login</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Condensed:wght@400;600;700&display=swap" rel="stylesheet"/>
  <style>
    :root { --bg:#153e9f; --card:#fff; --ink:#1f2937; }
    * { box-sizing: border-box; }
    body {
      margin:0; min-height:100vh; display:grid; place-items:center;
      background:var(--bg); font-family: "IBM Plex Sans Condensed", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink); padding: 24px;
    }
    .card {
      background:var(--card); width:100%; max-width:520px; border-radius:16px;
      padding:28px; box-shadow:0 12px 40px rgba(0,0,0,.25);
    }
    h1 { margin:0 0 12px; font-size:28px; }
    p.muted { margin:0 0 18px; color:#6b7280; }
    form { display:grid; gap:12px; }
    label { font-weight:600; font-size:14px; }
    input {
      width:100%; border:1px solid #e5e7eb; border-radius:10px; padding:12px 14px; font-size:16px;
    }
    .row { display:grid; gap:12px; grid-template-columns: 1fr 1fr; }
    .btn {
      appearance:none; border:0; border-radius:12px; padding:12px 16px; font-weight:700; font-size:16px;
      background:#111827; color:white; cursor:pointer;
    }
    .btn.secondary { background:#374151; }
    .btn.link { background:transparent; color:#111827; text-decoration:underline; padding:0; }
    .stack { display:grid; gap:10px; }
    .hidden { display:none !important; }
    .msg { border-radius:10px; padding:10px 12px; font-size:14px; }
    .msg.ok { background:#ecfdf5; color:#065f46; border:1px solid #a7f3d0; }
    .msg.err { background:#fef2f2; color:#991b1b; border:1px solid #fecaca; }
    small.hint { color:#6b7280; display:block; margin-top:4px; }
    .center { text-align:center; }
  </style>
</head>

<!-- IMPORTANT: keep data-page="login" here so the guard knows this is the login page -->
<body data-page="login">
  <div class="card">
    <h1 class="center">Quantum Solutions — Sign in</h1>
    <p class="muted center">Use your dashboard credentials to continue.</p>

    <div id="alert" class="msg hidden"></div>

    <!-- Tabs -->
    <div class="stack center" style="margin-bottom:14px;">
      <button class="btn link" id="tab-login">Login</button>
      <button class="btn link" id="tab-register">Create account</button>
      <button class="btn link" id="tab-forgot">Forgot password</button>
      <button class="btn link" id="tab-reset">Reset with token</button>
    </div>

    <!-- LOGIN -->
    <form id="form-login" autocomplete="on">
      <label>Username or Email
        <input id="login-username" required />
      </label>
      <label>Password
        <input id="login-password" type="password" required />
      </label>
      <button class="btn" type="submit" id="btn-login">Login</button>
    </form>

    <!-- REGISTER -->
    <form id="form-register" class="hidden" autocomplete="off">
      <div class="row">
        <label>Username
          <input id="reg-username" required />
        </label>
        <label>Company
          <input id="reg-company" placeholder="Optional" />
        </label>
      </div>
      <label>Email
        <input id="reg-email" type="email" required />
      </label>
      <label>Password
        <input id="reg-password" type="password" required />
        <small class="hint">At least 8 chars with upper, lower, number, and special.</small>
      </label>
      <button class="btn" type="submit" id="btn-register">Create account</button>
    </form>

    <!-- FORGOT (request token) -->
    <form id="form-forgot" class="hidden" autocomplete="off">
      <label>Username or Email
        <input id="forgot-id" required />
      </label>
      <button class="btn" type="submit" id="btn-forgot">Send reset token</button>
    </form>

    <!-- RESET (apply token) -->
    <form id="form-reset" class="hidden" autocomplete="off">
      <label>Reset token
        <input id="reset-token" required />
      </label>
      <label>New password
        <input id="reset-password" type="password" required />
        <small class="hint">At least 8 chars with upper, lower, number, and special.</small>
      </label>
      <button class="btn" type="submit" id="btn-reset">Set new password</button>
    </form>

    <div class="stack center" style="margin-top:16px;">
      <button class="btn secondary" id="btn-go-dashboard" type="button">Go to Dashboard</button>
      <button class="btn secondary" id="btn-logout" type="button">Logout</button>
    </div>
  </div>

  <script>
    // ====== CONFIG ======
    // 1) Replace with your deployed Apps Script Web App URL:
    const USER_MANAGEMENT_URL = '<<PASTE_YOUR_APPS_SCRIPT_WEB_APP_URL_HERE>>';
    // 2) Where to send users AFTER successful login:
    const DASHBOARD_URL = './quantum.html';

    // ====== SMALL UTILS ======
    const q = sel => document.querySelector(sel);
    const alertBox = q('#alert');

    function showMsg(text, ok=false) {
      alertBox.classList.remove('hidden','ok','err');
      alertBox.classList.add('msg', ok ? 'ok' : 'err');
      alertBox.textContent = text;
    }
    function clearMsg() {
      alertBox.classList.add('hidden');
      alertBox.textContent = '';
    }

    // Client-side complexity (mirrors backend)
    const PASSWORD_COMPLEXITY = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[^\w\s]).{8,}$/;

    // JSONP helper (avoids CORS)
    function jsonp(url, params = {}) {
      return new Promise((resolve, reject) => {
        const cbName = 'cb_' + Math.random().toString(36).slice(2);
        const s = document.createElement('script');
        const query = new URLSearchParams({ ...params, callback: cbName }).toString();
        const full = url + (url.includes('?') ? '&' : '?') + query;
        window[cbName] = (data) => { resolve(data); cleanup(); };
        s.src = full;
        s.onerror = () => { reject(new Error('Network error')); cleanup(); };
        document.body.appendChild(s);
        function cleanup() {
          delete window[cbName];
          s.remove();
        }
      });
    }

    // ====== AUTH STORAGE ======
    function saveSession(user) {
      localStorage.setItem('authUser', JSON.stringify(user));
    }
    function getSession() {
      try { return JSON.parse(localStorage.getItem('authUser') || 'null'); }
      catch { return null; }
    }
    function clearSession() {
      localStorage.removeItem('authUser');
    }

    // ====== TABS ======
    const tabs = {
      login: q('#form-login'),
      register: q('#form-register'),
      forgot: q('#form-forgot'),
      reset: q('#form-reset'),
    };
    function showTab(name) {
      Object.values(tabs).forEach(el => el.classList.add('hidden'));
      tabs[name].classList.remove('hidden');
      clearMsg();
    }
    q('#tab-login').onclick = () => showTab('login');
    q('#tab-register').onclick = () => showTab('register');
    q('#tab-forgot').onclick = () => showTab('forgot');
    q('#tab-reset').onclick = () => showTab('reset');

    // ====== FORM HANDLERS ======
    q('#form-login').addEventListener('submit', async (e) => {
      e.preventDefault();
      clearMsg();
      const id = q('#login-username').value.trim();
      const pw = q('#login-password').value;
      if (!id || !pw) return showMsg('Please fill both fields.');
      try {
        // Backend expects action=login and username=<id>
        const res = await jsonp(USER_MANAGEMENT_URL, { action:'login', username:id, password:pw });
        if (res.success) {
          saveSession({ username:res.username, email:res.email, company:res.company, ts:Date.now() });
          showMsg('Login successful. Redirecting…', true);
          setTimeout(() => location.href = DASHBOARD_URL, 400);
        } else {
          showMsg(res.message || 'Login failed');
        }
      } catch (err) { showMsg('Network error during login'); }
    });

    q('#form-register').addEventListener('submit', async (e) => {
      e.preventDefault();
      clearMsg();
      const username = q('#reg-username').value.trim();
      const email    = q('#reg-email').value.trim();
      const company  = q('#reg-company').value.trim();
      const password = q('#reg-password').value;

      if (!username || !email || !password) return showMsg('All fields are required');
      if (!PASSWORD_COMPLEXITY.test(password)) {
        return showMsg('Password must be 8+ chars and include upper, lower, number, special');
      }
      try {
        // Backend expects action=register (username,email,password,company)
        const res = await jsonp(USER_MANAGEMENT_URL, {
          action:'register', username, email, password, company
        });
        if (res.success) {
          showMsg('Account created. You can sign in now.', true);
          showTab('login');
          q('#login-username').value = username;
        } else {
          showMsg(res.message || 'Registration failed');
        }
      } catch { showMsg('Network error during registration'); }
    });

    q('#form-forgot').addEventListener('submit', async (e) => {
      e.preventDefault();
      clearMsg();
      const id = q('#forgot-id').value.trim();
      if (!id) return showMsg('Enter your username or email');
      try {
        // IMPORTANT: your backend uses action=requestpasswordreset and param usernameOrEmail
        const res = await jsonp(USER_MANAGEMENT_URL, { action:'requestpasswordreset', usernameOrEmail:id });
        if (res.success) {
          showMsg('Reset token generated. Check your email (or copy from sheet).', true);
          // If you want to show the token for testing (remove in prod):
          if (res.resetToken) showMsg('Reset token: ' + res.resetToken, true);
          showTab('reset');
        } else {
          showMsg(res.message || 'Could not generate reset token');
        }
      } catch { showMsg('Network error requesting reset'); }
    });

    q('#form-reset').addEventListener('submit', async (e) => {
      e.preventDefault();
      clearMsg();
      const token = q('#reset-token').value.trim();
      const pw    = q('#reset-password').value;
      if (!token || !pw) return showMsg('Token and new password required');
      if (!PASSWORD_COMPLEXITY.test(pw)) {
        return showMsg('New password must be 8+ chars and include upper, lower, number, special');
      }
      try {
        // Backend expects action=resetpassword with token & newPassword
        const res = await jsonp(USER_MANAGEMENT_URL, { action:'resetpassword', token, newPassword:pw });
        if (res.success) {
          showMsg('Password reset. Please log in.', true);
          showTab('login');
        } else {
          showMsg(res.message || 'Could not reset password');
        }
      } catch { showMsg('Network error resetting password'); }
    });

    // Go to dashboard
    q('#btn-go-dashboard').onclick = () => {
      // Optional: soft guard — if not logged in, explain
      if (!getSession()) return showMsg('Please log in first.');
      location.href = DASHBOARD_URL;
    };

    // Logout (for convenience if user lands here)
    q('#btn-logout').onclick = () => {
      clearSession();
      showMsg('Logged out. You can sign in below.', true);
      showTab('login');
    };

    // ====== PAGE-GUARD NOTE ======
    // This page is the LOGIN page (data-page="login"), so NO guard runs here.
    // On protected pages (e.g., quantum.html), include this small guard script:
    //
    //   (function guard(){
    //     if (document.body.dataset.page === 'login') return; // not protected
    //     const u = localStorage.getItem('authUser');
    //     if (!u) { alert('Please login first. Redirecting to login page…'); location.href = './index.html'; }
    //   })();
    //
    // That avoids the redirect loop you hit earlier.

    // Default to login tab
    showTab('login');
  </script>
</body>
</html>
