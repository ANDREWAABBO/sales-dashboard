<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sales Team Dashboard</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Condensed:wght@400;600;700&display=swap" rel="stylesheet"/>

  <!-- Page styles (unchanged) -->
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #1e3a8a;
      min-height: 100vh;
      padding: 20px;
      color: #333;
      font-size: 18px;
    }

    /* Company Switcher */
    .company-switcher {
      display: flex;
      justify-content: center;
      gap: 20px;
      padding: 20px;
      position: sticky;
      top: 0;
      z-index: 1000;
      background: #000000;
      margin: -20px -20px 30px -20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    }

    .company-btn {
      padding: 12px 25px;
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.2);
      color: white;
      font-size: 18px;
      font-weight: 600;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 12px;
      backdrop-filter: blur(10px);
      text-decoration: none;
    }

    .company-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .company-btn.active {
      background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
      border-color: transparent;
      box-shadow: 0 10px 30px rgba(59, 130, 246, 0.5), 0 0 60px rgba(59, 130, 246, 0.3);
      animation: glow 2s ease-in-out infinite alternate;
    }

    @keyframes glow {
      from { box-shadow: 0 10px 30px rgba(59, 130, 246, 0.5), 0 0 60px rgba(59, 130, 246, 0.3); }
      to   { box-shadow: 0 10px 40px rgba(59, 130, 246, 0.7), 0 0 80px rgba(59, 130, 246, 0.5); }
    }

    .company-logo { height: 35px; width: auto; filter: brightness(0) invert(1); transition: all 0.3s ease; }
    .abbondanza-logo { height: 40px; }
    .company-btn:hover .company-logo { transform: scale(1.05); }

    .dashboard-container { max-width: 1400px; margin: 0 auto; animation: fadeIn 0.8s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    .header { text-align: center; margin-bottom: 35px; color: white; position: relative; }
    .header h1 {
      font-size: 3.2em; font-weight: 700; margin-bottom: 10px; color: white;
      font-family: 'IBM Plex Sans Condensed', 'Arial Narrow', sans-serif;
      letter-spacing: 2px; text-transform: uppercase;
      text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.5);
      animation: titleGlow 3s ease-in-out infinite alternate;
    }
    @keyframes titleGlow { from { filter: brightness(1); } to { filter: brightness(1.3); } }
    .header p { font-size: 1.3em; opacity: 0.9; }

    /* Vertical stack grid */
    .quantum-grid { display: grid; grid-template-columns: 1fr; gap: 20px; max-width: 800px; margin: 0 auto; }

    .card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px; padding: 20px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.25);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative; overflow: hidden;
    }
    .card::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px;
      background: linear-gradient(90deg, #1e3a8a 0%, #1e40af 100%);
      transform: scaleX(0); transform-origin: left; transition: transform 0.3s ease;
    }
    .card:hover::before { transform: scaleX(1); }
    .card:hover { transform: translateY(-3px); box-shadow: 0 15px 45px rgba(0, 0, 0, 0.35); }
    .card h2 { font-size: 1.5em; margin-bottom: 10px; color: #2d3748; }
    .card p  { color: #718096; margin-bottom: 18px; line-height: 1.5; font-size: 1.1em; }

    .btn {
      display: inline-block; padding: 12px 26px; background: #1e3a8a; color: white;
      text-decoration: none; border-radius: 25px; font-weight: 600; transition: all 0.3s ease;
      position: relative; overflow: hidden; border: none; cursor: pointer; font-size: 1.05em;
    }
    .btn::after {
      content: ''; position: absolute; top: 50%; left: 50%; width: 0; height: 0;
      border-radius: 50%; background: rgba(255, 255, 255, 0.3);
      transform: translate(-50%, -50%); transition: width 0.6s, height 0.6s;
    }
    .btn:hover::after { width: 300px; height: 300px; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(30, 58, 138, 0.4); background: #1e40af; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

    /* Modal / PDF viewer */
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.7); z-index: 10000; backdrop-filter: blur(5px); }
    .modal {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: white; border-radius: 20px; padding: 25px 35px; max-width: 750px; width: 95%; max-height: 98vh;
      overflow-y: auto; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); z-index: 10001;
    }
    .pdf-modal {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white;
      border-radius: 20px; width: 90%; height: 90%; max-width: 1200px; max-height: 90vh;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); z-index: 10001; display: flex; flex-direction: column;
    }
    .pdf-header { padding: 20px; background: #f7fafc; border-radius: 20px 20px 0 0; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e2e8f0; }
    .pdf-header h3 { margin: 0; color: #2d3748; font-size: 1.3em; }
    .pdf-viewer { flex: 1; padding: 20px; overflow: hidden; }
    .pdf-viewer iframe { width: 100%; height: 100%; border: none; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }

    .close-btn { background: #e53e3e; color: white; border: none; padding: 10px 22px; border-radius: 20px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; font-size: 1.05em; }
    .close-btn:hover { background: #c53030; transform: scale(1.05); }

    .modal h3 { margin-bottom: 15px; color: #2d3748; text-align: center; font-size: 1.4em; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 5px; color: #4a5568; font-weight: 600; font-size: 1.05em; }
    .form-group input, .form-group select { width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 1.05em; transition: border-color 0.3s ease; }
    .form-group input:focus, .form-group select:focus { outline: none; border-color: #1e3a8a; }
    .form-group small { display: block; margin-top: 5px; color: #718096; font-size: 0.95em; }

    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }

    .pricing-summary {
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
      padding: 15px; border-radius: 10px; margin: 15px 0; border: 2px solid #1e3a8a;
    }
    .pricing-summary h4 { margin: 0 0 10px 0; color: #2d3748; font-size: 1.2em; }
    .pricing-display { font-size: 1.1em; color: #1e3a8a; font-weight: 600; }

    .modal-buttons { display: flex; gap: 15px; margin-top: 20px; }
    .btn-secondary { background: #64748b; flex: 1; }
    .btn-secondary:hover { background: #475569; }
    .btn-primary { background: #1e3a8a; flex: 2; }
    .btn-primary:hover { background: #1e40af; }

    .success-popup { background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); border: 2px solid #28a745; color: #155724; padding: 20px; border-radius: 15px; text-align: center; font-size: 1.05em; }
    .error-popup   { background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%); border: 2px solid #dc3545; color: #721c24; padding: 20px; border-radius: 15px; text-align: center; font-size: 1.05em; }

    .loading-spinner {
      display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #1e3a8a;
      border-radius: 50%; animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .link-btn { background: transparent; border: none; color: #1e3a8a; font-weight: 600; cursor: pointer; padding: 8px 0; }
    .link-btn:hover { text-decoration: underline; }

    /* NEW: Archive functionality styling */
    .filter-container {
      display: flex;
      gap: 15px;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .archive-filter {
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 16px;
      background: white;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 180px;
    }

    .archive-filter:focus {
      outline: none;
      border-color: #1e3a8a;
    }

    .refresh-btn {
      background: #10b981 !important;
      font-size: 14px !important;
      padding: 10px 20px !important;
      min-width: 90px !important;
    }

    .refresh-btn:hover {
      background: #059669 !important;
    }

    .archive-btn {
      background: #f59e0b !important;
      font-size: 14px !important;
      padding: 10px 20px !important;
      min-width: 80px !important;
    }

    .archive-btn:hover {
      background: #d97706 !important;
    }

    .archived-item {
      opacity: 0.7;
      background: #f8fafc !important;
    }

    .archived-badge {
      background: #f59e0b;
      color: white;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 12px;
      font-weight: 600;
      margin-left: 10px;
    }
  </style>

  <!-- Optional override config for password.js (must be BEFORE password.js) -->
  <script>
    window.AUTH_CONFIG = {
      USER_MANAGEMENT_URL: 'https://script.google.com/macros/s/AKfycbx76lEJH6uwQuaLQ_ML0IfHnS4G3saXlF-Lz7G8vKbWrUT1IMa7BZtCz9ZiqX7tIava/exec',
      SHOW_RESET_TOKEN_FOR_TESTING: false
    };
  </script>

  <!-- Auth first, then the user bar -->
  <script defer src="password.js"></script>
  <script defer src="userbar.js?v=1"></script>
</head>
<body>

  <!-- Company Switcher -->
  <div class="company-switcher">
    <button class="company-btn active" onclick="switchCompany('abbondanza', event)">
      <img src="images/abbondanza-logo.png" alt="Abbondanza" class="company-logo abbondanza-logo">
      <span>Abbondanza Vending LLC</span>
    </button>

    <button class="company-btn" onclick="switchCompany('quantum', event)">
      <img src="images/quantum-logo-transparent.png" alt="Quantum Solutions" class="company-logo">
      <span>Quantum Solutions</span>
    </button>
  </div>

  <div class="dashboard-container">
    <div class="header">
      <h1 id="dashboard-title">Abbondanza Sales Force</h1>
      <p>Access all your sales resources in one place</p>
    </div>

    <!-- Abbondanza Dashboard - 5 Cards Vertical Stack -->
    <div class="quantum-grid">
      <div class="card">
        <h2>About Us - How We Work</h2>
        <p>Marketing materials, proposals, flyers, and product information for your sales calls.</p>
        <div style="display: flex; gap: 15px; margin-top: 18px;">
          <button onclick="openPDFViewer()" class="btn" style="flex: 1;">View</button>
          <button onclick="downloadPresentationPDF()" class="btn" style="flex: 1;">Download</button>
        </div>
      </div>

      <div class="card">
        <h2>Product List</h2>
        <p>Complete catalog of all Abbondanza fresh food products with pricing and descriptions.</p>
        <div style="display: flex; gap: 15px; margin-top: 18px;">
          <button onclick="openProductListPDF()" class="btn" style="flex: 1;">View</button>
          <button onclick="downloadProductListPDF()" class="btn" style="flex: 1;">Download</button>
        </div>
      </div>

      <div class="card">
        <h2>Proposal Management</h2>
        <p>Create customized PDF proposals instantly and access generated proposals library with archive functionality.</p>
        <div style="display: flex; gap: 15px; margin-top: 18px;">
          <button onclick="openProposalGenerator()" class="btn" style="flex: 1;">Generate Proposal</button>
          <button onclick="openProposalViewer()" class="btn" style="flex: 1;">View Library</button>
        </div>
      </div>

      <div class="card">
        <h2>Service Agreement Management</h2>
        <p>Generate subsidy agreements with automated pricing calculations and access all service agreements library with archive functionality.</p>
        <div style="display: flex; gap: 15px; margin-top: 18px;">
          <button onclick="generateServiceAgreement()" class="btn" style="flex: 1;">Create Agreement</button>
          <button onclick="openServiceAgreementViewer()" class="btn" style="flex: 1;">View Library</button>
        </div>
      </div>

      <div class="card">
        <h2>Lead Logger</h2>
        <p>Log and track sales leads with follow-up management and status tracking.</p>
        <a href="lead-logger.html" class="btn">Open Lead Logger</a>
      </div>
    </div>
  </div>

  <!-- Proposal Generator Modal -->
  <div id="proposalModal" class="modal-overlay">
    <div class="modal">
      <h3>Generate Fresh Food Solutions Proposal</h3>

      <div class="form-group">
        <label for="companyName">Company Name *</label>
        <input type="text" id="companyName" name="companyName" required>
      </div>

      <div class="form-group">
        <label for="contactName">Contact Name (Optional)</label>
        <input type="text" id="contactName" name="contactName" placeholder="Leave blank if unknown">
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="preparedBy">Your Name *</label>
          <input type="text" id="preparedBy" name="preparedBy" required>
        </div>

        <div class="form-group">
          <label for="preparedByPhone">Your Phone *</label>
          <input type="tel" id="preparedByPhone" name="preparedByPhone" required>
        </div>
      </div>

      <div class="form-group">
        <label for="preparedByEmail">Your Email *</label>
        <input type="email" id="preparedByEmail" name="preparedByEmail" required>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="fridgeCount">Number of Fridges *</label>
          <input type="number" id="fridgeCount" name="fridgeCount" min="1" value="1" required onchange="updatePricingSummary()">
        </div>

        <div class="form-group">
          <label for="monthlyFee">Base Monthly Rate (1st Unit) *</label>
          <select id="monthlyFee" name="monthlyFee" required onchange="updatePricingSummary()">
            <option value="395">$395/month</option>
            <option value="495">$495/month</option>
            <option value="595">$595/month</option>
            <option value="695">$695/month</option>
            <option value="795" selected>$795/month</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label for="deliveryFee">Additional Delivery Charges (Optional)</label>
        <input type="number" id="deliveryFee" name="deliveryFee" min="0" max="5000" step="50" placeholder="$0.00" onchange="updatePricingSummary();">
        <small>Add extra charges for difficult deliveries, long distances, or 10+ units. Must be in $50 increments.</small>
      </div>

      <div class="pricing-summary">
        <h4>Pricing Summary</h4>
        <div class="pricing-display" id="pricingSummary">
          Monthly Total: $795/month<br>
          Setup Fee: $295 (one-time)
        </div>
      </div>

      <div class="modal-buttons">
        <button class="btn btn-secondary" onclick="closeModal('proposalModal')">Cancel</button>
        <button class="btn btn-primary" id="generateBtn" type="button" onclick="generateProposal()">Generate Proposal PDF</button>
      </div>
    </div>
  </div>

  <!-- Service Agreement Modal -->
  <div id="serviceAgreementModal" class="modal-overlay">
    <div class="modal">
      <h3>Generate Service Agreement</h3>

      <div class="form-group">
        <label for="serviceCompanyName">Company Name *</label>
        <input type="text" id="serviceCompanyName" name="serviceCompanyName" required>
      </div>

      <div class="form-group">
        <label for="serviceContactName">Contact Name (Optional)</label>
        <input type="text" id="serviceContactName" name="serviceContactName" placeholder="Leave blank if unknown">
      </div>

      <div class="form-group">
        <label for="serviceStreet">Street Address *</label>
        <input type="text" id="serviceStreet" name="serviceStreet" required>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="serviceCity">City *</label>
          <input type="text" id="serviceCity" name="serviceCity" required>
        </div>

        <div class="form-group">
          <label for="serviceState">State *</label>
          <select id="serviceState" name="serviceState" required>
            <option value="">Select State</option>
            <option value="MA" selected>MA</option>
            <option value="NH">NH</option>
            <option value="ME">ME</option>
            <option value="VT">VT</option>
            <option value="RI">RI</option>
            <option value="CT">CT</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label for="serviceZip">Zip Code *</label>
        <input type="text" id="serviceZip" name="serviceZip" pattern="[0-9]{5}" maxlength="5" required>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="servicePreparedBy">Your Name *</label>
          <input type="text" id="servicePreparedBy" name="servicePreparedBy" required>
        </div>

        <div class="form-group">
          <label for="servicePreparedByPhone">Your Phone *</label>
          <input type="tel" id="servicePreparedByPhone" name="servicePreparedByPhone" required>
        </div>
      </div>

      <div class="form-group">
        <label for="servicePreparedByEmail">Your Email *</label>
        <input type="email" id="servicePreparedByEmail" name="servicePreparedByEmail" required>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="serviceFridgeCount">Total Kiosks to Install *</label>
          <input type="number" id="serviceFridgeCount" name="serviceFridgeCount" min="1" value="1" required onchange="updateServiceAgreementPricing()">
        </div>

        <div class="form-group">
          <label for="serviceMonthlyFee">Monthly Service Fee (1st Unit) *</label>
          <select id="serviceMonthlyFee" name="serviceMonthlyFee" required onchange="updateServiceAgreementPricing()">
            <option value="395">$395/month</option>
            <option value="495">$495/month</option>
            <option value="595">$595/month</option>
            <option value="695">$695/month</option>
            <option value="795" selected>$795/month</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="subsidyPercentage">Subsidy Percentage *</label>
          <select id="subsidyPercentage" name="subsidyPercentage" required onchange="updateServiceAgreementPricing()">
            <option value="0" selected>0%</option>
            <option value="10">10%</option>
            <option value="20">20%</option>
            <option value="25">25%</option>
            <option value="30">30%</option>
            <option value="40">40%</option>
            <option value="50">50%</option>
            <option value="60">60%</option>
            <option value="70">70%</option>
            <option value="75">75%</option>
            <option value="80">80%</option>
            <option value="90">90%</option>
            <option value="100">100%</option>
          </select>
          <small>Discount on purchases billed back to company</small>
        </div>

        <div class="form-group">
          <label for="freeMonths">Free Months</label>
          <select id="freeMonths" name="freeMonths" onchange="calculateFirstBillDate()">
            <option value="0" selected>No free months</option>
            <option value="1">1 month free</option>
            <option value="2">2 months free</option>
            <option value="3">3 months free</option>
            <option value="4">4 months free</option>
            <option value="5">5 months free</option>
            <option value="6">6 months free</option>
          </select>
          <small>Service fee waived for initial months</small>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="installDate">Install Date</label>
          <input type="date" id="installDate" name="installDate" onchange="calculateFirstBillDate()">
          <small>Leave blank for TBD</small>
        </div>

        <div class="form-group">
          <label for="firstBillDate">First Bill Date</label>
          <input type="date" id="firstBillDate" name="firstBillDate" readonly style="background-color: #f0f0f0;">
          <small>Auto-calculated based on install date and free months</small>
        </div>
      </div>

      <div class="pricing-summary">
        <h4>Agreement Summary</h4>
        <div class="pricing-display" id="servicePricingSummary">
          Total Kiosks: 1<br>
          Monthly Service Fee: $795.00<br>
          Subsidy: 0% discount<br>
          Monthly Subsidy Amount: $0.00
        </div>
      </div>

      <div class="modal-buttons">
        <button class="btn btn-secondary" onclick="closeModal('serviceAgreementModal')">Cancel</button>
        <button class="btn btn-primary" id="generateServiceBtn" type="button" onclick="generateServiceAgreementPDF()">Generate Service Agreement PDF</button>
      </div>
    </div>
  </div>

  <!-- App script (unchanged logic) -->
  <script>
    /* ====== App Endpoints ====== */
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxAeTdnlfZbcCsxAoASHRQqX_zEsxyzYRJK4EP5QUWvYkQUEneWrKozR-A1XxRSgmtjxQ/exec';
    const PROPOSALS_API_URL = 'https://script.google.com/macros/s/AKfycbxLigSx069wQveXiAS7M9stBH7lItBRt88iLHno_qYFIlmdKZgdpQfNTinIbl92DGo68Q/exec';
    const SERVICE_AGREEMENT_URL = 'https://script.google.com/macros/s/AKfycbyJ0DLErQzyIVWWbLwRXnLWESJtWq0n4FYKsa3oGXC0_0pOn4fNlnWxp11FLbPXalPihg/exec';
    const SERVICE_AGREEMENTS_API_URL = 'https://script.google.com/macros/s/AKfycbyZDkhdIwynj2JAA1S07b6a1G9IBuUZXcn3AyJrX7s6cQm65g-ZX8fd4FXH7oCp2pe3/exec';

    // NEW: Global variables for archive functionality
    window.allProposals = null;
    window.allServiceAgreements = null;
    window.currentProposalFilter = 'active';
    window.currentServiceFilter = 'active';

    /* ====== Tiny UI helpers ====== */
    const helperCSS = document.createElement('style');
    helperCSS.textContent = `
      @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    `;
    document.head.appendChild(helperCSS);

    function showPopup(content, type) {
      const popup = document.createElement('div');
      popup.className = 'modal-overlay';
      popup.style.display = 'block';
      popup.innerHTML = `
        <div class="modal">
          <div class="${type === 'error' ? 'error-popup' : 'success-popup'}">
            ${content}
            <div style="margin-top: 20px;">
              <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Close</button>
            </div>
          </div>
        </div>`;
      document.body.appendChild(popup);
      if (type === 'success') setTimeout(() => popup.remove(), 10000);
    }

    /* ====== Company switcher ====== */
    function switchCompany(company, ev) {
      document.querySelectorAll('.company-btn').forEach(btn => btn.classList.remove('active'));
      const clickedBtn = ev?.currentTarget || ev?.target?.closest('.company-btn');
      if (clickedBtn) clickedBtn.classList.add('active');

      const title = document.getElementById('dashboard-title');
      if (company === 'abbondanza') {
        title.textContent = 'Abbondanza Sales Force';
      } else if (company === 'quantum') {
        title.textContent = 'Quantum Solutions Dashboard';
        window.location.href = 'quantum.html';
      }
    }

    /* ====== PDF: Product List ====== */
    function openProductListPDF() {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.style.display = 'block';

      const pdfModal = document.createElement('div');
      pdfModal.className = 'pdf-modal';

      const sheetsId = '1FVnd5kMEpT6PnAnd5KbSZ4nrm3BONEsSULUejOCjdEw';
      const pdfUrl = `https://docs.google.com/spreadsheets/d/${sheetsId}/export?format=pdf&portrait=true&fitw=true&gridlines=true`;
      const viewerUrl = `https://docs.google.com/viewer?url=${encodeURIComponent(pdfUrl)}&embedded=true`;

      pdfModal.innerHTML = `
        <div class="pdf-header">
          <h3>Abbondanza Product List</h3>
          <div>
            <button class="btn btn-secondary" onclick="window.open('${pdfUrl}', '_blank')" style="margin-right: 10px;">Download PDF</button>
            <button class="close-btn" onclick="closePDFViewer()">Close</button>
          </div>
        </div>
        <div class="pdf-viewer">
          <iframe src="${viewerUrl}" allowfullscreen></iframe>
        </div>`;
      overlay.appendChild(pdfModal);
      document.body.appendChild(overlay);
    }
    function downloadProductListPDF() {
      const sheetsId = '1FVnd5kMEpT6PnAnd5KbSZ4nrm3BONEsSULUejOCjdEw';
      const pdfUrl = `https://docs.google.com/spreadsheets/d/${sheetsId}/export?format=pdf&size=letter&portrait=true&fitw=true&sheetnames=false&printtitle=false&pagenumbers=false&gridlines=true`;
      window.open(pdfUrl, '_blank');
    }

    /* ====== PDF: About Us Deck ====== */
    function openPDFViewer() {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.style.display = 'block';

      const pdfModal = document.createElement('div');
      pdfModal.className = 'pdf-modal';

      const slidesId = '13MgZEuaHvneWrIqomnU_NFKFuR_tY4g0WH6Wc041LDU';
      const pdfUrl = `https://docs.google.com/presentation/d/${slidesId}/export/pdf`;

      pdfModal.innerHTML = `
        <div class="pdf-header">
          <h3>Abbondanza About Us - How We Work</h3>
          <div>
            <button class="btn btn-secondary" onclick="downloadPresentationPDF()" style="margin-right: 10px;">Download PDF</button>
            <button class="close-btn" onclick="closePDFViewer()">Close</button>
          </div>
        </div>
        <div class="pdf-viewer">
          <iframe src="https://docs.google.com/viewerng/viewer?embedded=true&url=${encodeURIComponent(pdfUrl)}" allowfullscreen></iframe>
        </div>`;
      overlay.appendChild(pdfModal);
      document.body.appendChild(overlay);
    }
    function downloadPresentationPDF() {
      const slidesId = '13MgZEuaHvneWrIqomnU_NFKFuR_tY4g0WH6Wc041LDU';
      const pdfUrl = `https://docs.google.com/presentation/d/${slidesId}/export/pdf`;
      window.open(pdfUrl, '_blank');
    }
    function closePDFViewer() {
      document.querySelectorAll('.modal-overlay').forEach(ov => {
        if (ov && ov.querySelector('.pdf-modal')) ov.remove();
      });
      window.allProposals = null;
      window.allServiceAgreements = null;
    }

    /* ====== Proposal Generator ====== */
    function openProposalGenerator() {
      const proposalModal = document.getElementById('proposalModal');
      if (proposalModal) {
        proposalModal.style.display = 'block';
        updatePricingSummary();
      }
    }
    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) modal.style.display = 'none';
    }
    function updatePricingSummary() {
      const fridgeCount = parseInt(document.getElementById('fridgeCount').value) || 1;
      const basePrice   = parseInt(document.getElementById('monthlyFee').value) || 795;
      const additionalDeliveryFee = parseInt(document.getElementById('deliveryFee').value) || 0;

      let monthlyTotal = basePrice;
      let baseSetupFee = 295;

      if (fridgeCount > 1) {
        const additionalUnits = fridgeCount - 1;
        const discountedPrice = basePrice - 100;
        monthlyTotal = basePrice + (discountedPrice * additionalUnits);
        baseSetupFee = 295 + (79 * additionalUnits);
      }

      const totalSetupFee = baseSetupFee + additionalDeliveryFee;

      let pricingText = `Monthly Total: $${monthlyTotal}/month`;
      if (fridgeCount > 1) {
        pricingText += ` (${fridgeCount} fridges)<br>`;
        pricingText += `First unit: $${basePrice}/month<br>`;
        pricingText += `Additional units: $${basePrice - 100}/month each<br>`;
      } else {
        pricingText += '<br>';
      }
      pricingText += `Setup & Delivery Fee: $${totalSetupFee} (one-time)`;
      if (additionalDeliveryFee > 0) {
        pricingText += `<br><small style="color: #1e3a8a;">Base: $${baseSetupFee} + Additional: ${additionalDeliveryFee.toFixed(2)}</small>`;
      }
      document.getElementById('pricingSummary').innerHTML = pricingText;
    }
    async function generateProposal(event) {
      if (event) { event.preventDefault(); event.stopPropagation(); }
      const submitBtn = document.getElementById('generateBtn');
      const originalText = submitBtn.innerHTML;
      if (submitBtn.disabled) return;

      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="loading-spinner"></span> Generating...';

      try {
        const formData = {
          companyName: document.getElementById('companyName').value,
          contactName: document.getElementById('contactName').value || '',
          preparedBy: document.getElementById('preparedBy').value,
          preparedByPhone: document.getElementById('preparedByPhone').value,
          preparedByEmail: document.getElementById('preparedByEmail').value,
          fridgeCount: document.getElementById('fridgeCount').value,
          monthlyFee: document.getElementById('monthlyFee').value,
          deliveryFee: document.getElementById('deliveryFee').value || ''
        };
        if (!formData.companyName || !formData.preparedBy || !formData.preparedByPhone || !formData.preparedByEmail) {
          throw new Error('Please fill in all required fields.');
        }

        const params = new URLSearchParams();
        Object.keys(formData).forEach(k => params.append(k, formData[k]));
        const url = `${WEB_APP_URL}?${params.toString()}`;
        window.open(url, '_blank');

        closeModal('proposalModal');
        showPopup(`
          <div class="success-popup">
            <h3>Proposal Generation Started!</h3>
            <p>Your proposal is being generated. A new tab has opened with the results.</p>
            <p><strong>Company:</strong> ${formData.companyName}</p>
            <p><strong>Prepared by:</strong> ${formData.preparedBy}</p>
          </div>
        `, 'success');
      } catch (error) {
        showPopup(`Error generating proposal: ${error.message}`, 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
      }
    }

    /* ====== ENHANCED Proposal Library with Archive ====== */
    function openProposalViewer() {
      const existingOverlay = document.querySelector('.modal-overlay');
      if (existingOverlay) existingOverlay.remove();

      window.allProposals = null;
      window.currentProposalFilter = 'active';

      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.style.display = 'block';

      const modal = document.createElement('div');
      modal.className = 'pdf-modal';

      modal.innerHTML = `
        <div class="pdf-header">
          <h3>Proposal Library</h3>
          <button class="close-btn" onclick="closePDFViewer()">Close</button>
        </div>
        <div class="pdf-viewer" style="padding: 20px;">
          <div class="filter-container">
            <select id="proposalArchiveFilter" class="archive-filter" onchange="changeProposalArchiveFilter()">
              <option value="active">Active Proposals</option>
              <option value="archived">Archived Proposals</option>
              <option value="all">All Proposals</option>
            </select>
            
            <button class="btn refresh-btn" onclick="refreshProposals()">ðŸ”„ Refresh</button>
            
            <div style="position: relative; flex: 1;">
              <input type="text" id="proposalSearch" placeholder="Search by company name..."
                style="width: 100%; padding: 15px 45px 15px 15px; font-size: 16px; border: 2px solid #e2e8f0;
                       border-radius: 10px; transition: all 0.3s ease;"
                onkeyup="filterProposals()"
                onfocus="this.style.borderColor='#1e3a8a'"
                onblur="this.style.borderColor='#e2e8f0'">
              <button id="clearSearchBtn"
                onclick="document.getElementById('proposalSearch').value=''; this.style.display='none'; filterProposals();"
                style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
                       background: #e2e8f0; border: none; border-radius: 50%; width: 30px; height: 30px;
                       cursor: pointer; display: none; transition: all 0.3s ease; font-size: 18px; color: #4a5568;">Ã—</button>
            </div>
          </div>
          <div id="proposalsList" style="display: grid; gap: 15px; max-height: 60vh; overflow-y: auto;">
            <div style="text-align: center; padding: 40px;">
              <div class="loading-spinner"></div>
              <p style="margin-top: 20px; color: #718096;">Loading proposals from Google Drive...</p>
            </div>
          </div>
        </div>`;
      overlay.appendChild(modal);
      document.body.appendChild(overlay);
      setTimeout(() => { loadProposalsFromDrive(); }, 100);
    }

    // NEW: Archive filter functions
    window.changeProposalArchiveFilter = function() {
      const filter = document.getElementById('proposalArchiveFilter');
      window.currentProposalFilter = filter.value;
      filterProposals();
    };

    window.refreshProposals = function() {
      window.allProposals = null;
      loadProposalsFromDrive();
    };

    // NEW: Archive toggle function
    window.toggleProposalArchive = async function(proposalId, currentStatus, event) {
      const newStatus = currentStatus === 'archived' ? 'active' : 'archived';
      const proposal = window.allProposals ? window.allProposals.find(p => p.id === proposalId) : null;
      const companyName = proposal ? proposal.name : '';
      
      const button = event.target;
      const originalText = button.innerHTML;
      button.disabled = true;
      button.innerHTML = '...';
      
      try {
        const callbackName = 'archiveCallback_' + Date.now();
        const promise = new Promise((resolve, reject) => {
          window[callbackName] = (data) => { delete window[callbackName]; resolve(data); };
          setTimeout(() => { delete window[callbackName]; reject(new Error('Request timeout')); }, 10000);
        });

        const script = document.createElement('script');
        const params = new URLSearchParams({
          action: 'updateArchiveStatus',
          fileId: proposalId,
          status: newStatus,
          companyName: companyName,
          callback: callbackName
        });
        script.src = `${PROPOSALS_API_URL}?${params.toString()}`;
        script.onerror = () => {
          delete window[callbackName];
          throw new Error('Failed to connect to archive service');
        };

        document.body.appendChild(script);
        const result = await promise;
        document.body.removeChild(script);

        if (result.status === 'success') {
          if (window.allProposals && proposal) {
            proposal.status = newStatus;
            proposal.archivedDate = result.data.archivedDate;
          }
          filterProposals();
          showPopup(`Proposal ${newStatus === 'archived' ? 'archived' : 'restored'} successfully!`, 'success');
        } else {
          throw new Error(result.message || 'Failed to update archive status');
        }
      } catch (error) {
        console.error('Archive toggle error:', error);
        showPopup(`Archive update failed: ${error.message}`, 'error');
      } finally {
        button.disabled = false;
        button.innerHTML = originalText;
      }
    };

    async function loadProposalsFromDrive() {
      try {
        const callbackName = 'proposalsCallback_' + Date.now();
        const promise = new Promise((resolve, reject) => {
          window[callbackName] = (data) => { delete window[callbackName]; resolve(data); };
          setTimeout(() => { delete window[callbackName]; reject(new Error('Request timeout')); }, 20000);
        });

        const script = document.createElement('script');
        script.src = `${PROPOSALS_API_URL}?action=getProposals&callback=${callbackName}`;
        script.onerror = () => {
          delete window[callbackName];
          const proposalsList = document.getElementById('proposalsList');
          if (proposalsList) {
            proposalsList.innerHTML = `
              <div style="text-align: center; padding: 40px;">
                <p style="color: #e53e3e; margin-bottom: 20px; font-size: 18px;">Unable to load proposals.</p>
                <button class="btn btn-primary" onclick="loadProposalsFromDrive()">Try Again</button>
              </div>`;
          }
        };

        document.body.appendChild(script);
        const data = await promise;
        document.body.removeChild(script);

        if (data.status === 'success') {
          const sorted = (data.proposals || []).sort((a, b) => new Date(b.modifiedTime) - new Date(a.modifiedTime));
          sorted.forEach(proposal => {
            if (!proposal.status) {
              proposal.status = 'active';
            }
          });
          window.allProposals = sorted;
          filterProposals();
        } else {
          throw new Error(data.message || 'Failed to load proposals');
        }
      } catch (error) {
        const proposalsList = document.getElementById('proposalsList');
        if (proposalsList) {
          proposalsList.innerHTML = `
            <div style="text-align: center; padding: 40px;">
              <p style="color: #e53e3e; margin-bottom: 20px; font-size: 18px;">Unable to load proposals.</p>
              <p style="color: #718096; margin-bottom: 20px;">Error: ${error.message}</p>
              <button class="btn btn-primary" onclick="loadProposalsFromDrive()">Try Again</button>
            </div>`;
        }
      }
    }

    function displayProposals(proposals) {
      const list = document.getElementById('proposalsList');
      if (!list) return;
      if (proposals.length === 0) {
        const filterText = window.currentProposalFilter === 'active' ? 'active' : 
                          window.currentProposalFilter === 'archived' ? 'archived' : '';
        list.innerHTML = `<div style="text-align: center; padding: 40px; color: #718096;"><p>No ${filterText} proposals found.</p></div>`;
        return;
      }
      
      list.innerHTML = proposals.map(p => {
        const isArchived = p.status === 'archived';
        const archiveButtonText = isArchived ? 'Restore' : 'Archive';
        const itemClass = isArchived ? 'archived-item' : '';
        const archivedBadge = isArchived ? '<span class="archived-badge">Archived</span>' : '';
        
        return `
          <div class="proposal-item ${itemClass}" style="background: white; padding: 25px; border-radius: 15px; border: 2px solid #e2e8f0; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.05);"
               onmouseover="this.style.borderColor='#1e3a8a'; this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.1)'"
               onmouseout="this.style.borderColor='#e2e8f0'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.05)'">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
              <div style="flex: 1; min-width: 200px;">
                <h4 style="margin: 0 0 8px 0; color: #2d3748; font-size: 18px;">${p.name}${archivedBadge}</h4>
                <p style="margin: 0; color: #718096; font-size: 14px;">
                  Modified: ${p.modifiedTime ? new Date(p.modifiedTime).toLocaleDateString() : 'Unknown'}
                  ${isArchived && p.archivedDate ? `<br>Archived: ${new Date(p.archivedDate).toLocaleDateString()}` : ''}
                </p>
              </div>
              <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="viewProposalPDF('${p.id}', '${p.name}')" style="padding: 10px 20px; font-size: 14px; min-width: 80px;">View</button>
                <button class="btn btn-secondary" onclick="window.open('https://drive.google.com/uc?export=download&id=${p.id}', '_blank')" style="padding: 10px 20px; font-size: 14px; min-width: 80px;">Download</button>
                <button class="btn archive-btn" onclick="toggleProposalArchive('${p.id}', '${p.status || 'active'}', event)">${archiveButtonText}</button>
              </div>
            </div>
          </div>`;
      }).join('');
    }

    function filterProposals() {
      const input = document.getElementById('proposalSearch');
      const term = input ? input.value.toLowerCase() : '';
      const clearBtn = document.getElementById('clearSearchBtn');
      if (clearBtn) clearBtn.style.display = term.length > 0 ? 'block' : 'none';
      if (!window.allProposals || window.allProposals.length === 0) return;

      // Filter by archive status first
      let filteredByStatus = window.allProposals;
      if (window.currentProposalFilter === 'active') {
        filteredByStatus = window.allProposals.filter(p => p.status !== 'archived');
      } else if (window.currentProposalFilter === 'archived') {
        filteredByStatus = window.allProposals.filter(p => p.status === 'archived');
      }

      // Then filter by search term
      let finalFiltered = filteredByStatus;
      if (term) {
        finalFiltered = filteredByStatus.filter(p => p.name.toLowerCase().includes(term));
      }

      displayProposals(finalFiltered);
    }

    function viewProposalPDF(fileId, fileName) {
      closePDFViewer();
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.style.display = 'block';

      const pdfModal = document.createElement('div');
      pdfModal.className = 'pdf-modal';
      const viewerUrl = `https://drive.google.com/file/d/${fileId}/preview`;

      pdfModal.innerHTML = `
        <div class="pdf-header">
          <h3>${fileName}</h3>
          <div style="display: flex; gap: 10px; align-items: center;">
            <button class="btn btn-primary" onclick="closePDFViewer(); setTimeout(openProposalViewer, 200);" style="padding: 10px 20px;">Back to Library</button>
            <button class="btn btn-secondary" onclick="window.open('https://drive.google.com/uc?export=download&id=${fileId}', '_blank')" style="padding: 10px 20px;">Download</button>
          </div>
        </div>
        <div class="pdf-viewer"><iframe src="${viewerUrl}" allowfullscreen></iframe></div>`;
      overlay.appendChild(pdfModal);
      document.body.appendChild(overlay);
    }

    /* ====== Service Agreement ====== */
    function generateServiceAgreement() {
      const serviceModal = document.getElementById('serviceAgreementModal');
      if (serviceModal) {
        serviceModal.style.display = 'block';
        updateServiceAgreementPricing();
      }
    }

    function updateServiceAgreementPricing() {
      const fridgeCount = parseInt(document.getElementById('serviceFridgeCount').value) || 1;
      const basePrice   = parseInt(document.getElementById('serviceMonthlyFee').value) || 795;
      const subsidyPercentage = parseInt(document.getElementById('subsidyPercentage').value) || 0;

      let monthlyTotal = basePrice;
      if (fridgeCount > 1) {
        const additionalUnits = fridgeCount - 1;
        const discountedPrice = basePrice - 100;
        monthlyTotal = basePrice + (discountedPrice * additionalUnits);
      }

      const estimatedMonthlyPurchases = fridgeCount * 300;
      const monthlySubsidyAmount = (estimatedMonthlyPurchases * subsidyPercentage) / 100;

      let txt = `Total Kiosks: ${fridgeCount}<br>`;
      txt += `Monthly Service Fee: $${monthlyTotal.toFixed(2)}<br>`;
      txt += `Subsidy: ${subsidyPercentage}% discount<br>`;
      txt += `Estimated Monthly Subsidy: $${monthlySubsidyAmount.toFixed(2)}`;
      document.getElementById('servicePricingSummary').innerHTML = txt;
    }

    function calculateFirstBillDate() {
      const installDate = document.getElementById('installDate').value;
      const freeMonths = parseInt(document.getElementById('freeMonths').value) || 0;
      const firstBillDateInput = document.getElementById('firstBillDate');

      if (installDate) {
        const install = new Date(installDate);
        const firstBill = new Date(install);
        firstBill.setMonth(firstBill.getMonth() + 1 + freeMonths);
        const year = firstBill.getFullYear();
        const month = String(firstBill.getMonth() + 1).padStart(2, '0');
        const day = String(firstBill.getDate()).padStart(2, '0');
        firstBillDateInput.value = `${year}-${month}-${day}`;
      } else {
        firstBillDateInput.value = '';
      }
    }

    async function generateServiceAgreementPDF() {
      const submitBtn = document.getElementById('generateServiceBtn');
      const originalText = submitBtn.innerHTML;
      if (submitBtn.disabled) return;

      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="loading-spinner"></span> Generating...';

      try {
        const formData = {
          companyName: document.getElementById('serviceCompanyName').value,
          contactName: document.getElementById('serviceContactName').value || '',
          street: document.getElementById('serviceStreet').value,
          city: document.getElementById('serviceCity').value,
          state: document.getElementById('serviceState').value,
          zip: document.getElementById('serviceZip').value,
          preparedBy: document.getElementById('servicePreparedBy').value,
          preparedByPhone: document.getElementById('servicePreparedByPhone').value,
          preparedByEmail: document.getElementById('servicePreparedByEmail').value,
          fridgeCount: document.getElementById('serviceFridgeCount').value,
          monthlyFee: document.getElementById('serviceMonthlyFee').value,
          subsidyPercentage: document.getElementById('subsidyPercentage').value,
          freeMonths: document.getElementById('freeMonths').value,
          installDate: document.getElementById('installDate').value,
          firstBillDate: document.getElementById('firstBillDate').value
        };

        const required = ['companyName','street','city','state','zip','preparedBy','preparedByPhone','preparedByEmail'];
        for (const f of required) {
          if (!formData[f]) {
            const name = f.replace(/([A-Z])/g, ' $1').toLowerCase();
            throw new Error(`Please fill in the ${name} field.`);
          }
        }

        const fridgeCount = parseInt(formData.fridgeCount) || 1;
        const basePrice   = parseInt(formData.monthlyFee) || 795;
        const subsidyPct  = parseInt(formData.subsidyPercentage) || 0;

        let monthlyTotal = basePrice;
        if (fridgeCount > 1) {
          const discountedPrice = basePrice - 100;
          monthlyTotal = basePrice + (discountedPrice * (fridgeCount - 1));
        }

        const estimatedMonthlyPurchases = fridgeCount * 300;
        const monthlySubsidyAmount = (estimatedMonthlyPurchases * subsidyPct) / 100;

        const params = new URLSearchParams({
          type: 'serviceAgreement',
          customer: formData.companyName,
          street: formData.street,
          city: formData.city,
          state: formData.state,
          zip: formData.zip,
          subsidyPercentage: formData.subsidyPercentage,
          serviceFee: formData.monthlyFee,
          installDate: formData.installDate,
          totalKiosks: formData.fridgeCount,
          firstBillDate: formData.firstBillDate,
          freeMonths: formData.freeMonths,
          preparedBy: formData.preparedBy,
          preparedByPhone: formData.preparedByPhone,
          preparedByEmail: formData.preparedByEmail,
          contactName: formData.contactName,
          monthlyTotal: String(monthlyTotal),
          monthlySubsidyAmount: String(monthlySubsidyAmount),
          estimatedMonthlyPurchases: String(estimatedMonthlyPurchases)
        });

        const url = `${SERVICE_AGREEMENT_URL}?${params.toString()}`;
        window.open(url, '_blank');

        closeModal('serviceAgreementModal');
        showPopup(`Service Agreement Generation Started!`, 'success');
      } catch (error) {
        showPopup(`Error: ${error.message}`, 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
      }
    }

    /* ====== ENHANCED Service Agreement Library with Archive ====== */
    function openServiceAgreementViewer() {
      const existingOverlay = document.querySelector('.modal-overlay');
      if (existingOverlay) existingOverlay.remove();

      window.allServiceAgreements = null;
      window.currentServiceFilter = 'active';

      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.style.display = 'block';

      const modal = document.createElement('div');
      modal.className = 'pdf-modal';

      modal.innerHTML = `
        <div class="pdf-header">
          <h3>Service Agreement Library</h3>
          <button class="close-btn" onclick="closePDFViewer()">Close</button>
        </div>
        <div class="pdf-viewer" style="padding: 20px;">
          <div class="filter-container">
            <select id="serviceArchiveFilter" class="archive-filter" onchange="changeServiceArchiveFilter()">
              <option value="active">Active Agreements</option>
              <option value="archived">Archived Agreements</option>
              <option value="all">All Agreements</option>
            </select>
            
            <button class="btn refresh-btn" onclick="refreshServiceAgreements()">ðŸ”„ Refresh</button>
            
            <div style="position: relative; flex: 1;">
              <input type="text" id="serviceAgreementSearch" placeholder="Search by company name..."
                style="width: 100%; padding: 15px 45px 15px 15px; font-size: 16px; border: 2px solid #e2e8f0;
                       border-radius: 10px; transition: all 0.3s ease;"
                onkeyup="filterServiceAgreements()"
                onfocus="this.style.borderColor='#1e3a8a'"
                onblur="this.style.borderColor='#e2e8f0'">
              <button id="clearServiceSearchBtn"
                onclick="document.getElementById('serviceAgreementSearch').value=''; this.style.display='none'; filterServiceAgreements();"
                style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
                       background: #e2e8f0; border: none; border-radius: 50%; width: 30px; height: 30px;
                       cursor: pointer; display: none; transition: all 0.3s ease; font-size: 18px; color: #4a5568;">Ã—</button>
            </div>
          </div>

          <div id="serviceAgreementsList" style="display: grid; gap: 15px; max-height: 60vh; overflow-y: auto;">
            <div style="text-align: center; padding: 40px;">
              <div class="loading-spinner"></div>
              <p style="margin-top: 20px; color: #718096;">Loading service agreements from Google Drive...</p>
            </div>
          </div>
        </div>`;
      overlay.appendChild(modal);
      document.body.appendChild(overlay);
      setTimeout(() => { loadServiceAgreementsFromDrive(); }, 100);
    }

    // NEW: Service Agreement Archive Functions
    window.changeServiceArchiveFilter = function() {
      const filter = document.getElementById('serviceArchiveFilter');
      window.currentServiceFilter = filter.value;
      filterServiceAgreements();
    };

    window.refreshServiceAgreements = function() {
      window.allServiceAgreements = null;
      loadServiceAgreementsFromDrive();
    };

    window.toggleServiceAgreementArchive = async function(agreementId, currentStatus, event) {
      const newStatus = currentStatus === 'archived' ? 'active' : 'archived';
      const agreement = window.allServiceAgreements ? window.allServiceAgreements.find(a => a.id === agreementId) : null;
      const companyName = agreement ? agreement.name : '';
      
      const button = event.target;
      const originalText = button.innerHTML;
      button.disabled = true;
      button.innerHTML = '...';
      
      try {
        const callbackName = 'serviceArchiveCallback_' + Date.now();
        const promise = new Promise((resolve, reject) => {
          window[callbackName] = (data) => { delete window[callbackName]; resolve(data); };
          setTimeout(() => { delete window[callbackName]; reject(new Error('Request timeout')); }, 10000);
        });

        const script = document.createElement('script');
        const params = new URLSearchParams({
          action: 'updateArchiveStatus',
          fileId: agreementId,
          status: newStatus,
          companyName: companyName,
          callback: callbackName
        });
        script.src = `${SERVICE_AGREEMENTS_API_URL}?${params.toString()}`;
        script.onerror = () => {
          delete window[callbackName];
          throw new Error('Failed to connect to archive service');
        };

        document.body.appendChild(script);
        const result = await promise;
        document.body.removeChild(script);

        if (result.status === 'success') {
          if (window.allServiceAgreements && agreement) {
            agreement.status = newStatus;
            agreement.archivedDate = result.data.archivedDate;
          }
          filterServiceAgreements();
          showPopup(`Service agreement ${newStatus === 'archived' ? 'archived' : 'restored'} successfully!`, 'success');
        } else {
          throw new Error(result.message || 'Failed to update archive status');
        }
      } catch (error) {
        console.error('Service archive error:', error);
        showPopup(`Archive update failed: ${error.message}`, 'error');
      } finally {
        button.disabled = false;
        button.innerHTML = originalText;
      }
    };

    async function loadServiceAgreementsFromDrive() {
      try {
        const callbackName = 'serviceAgreementsCallback_' + Date.now();
        const promise = new Promise((resolve, reject) => {
          window[callbackName] = (data) => { delete window[callbackName]; resolve(data); };
          setTimeout(() => { delete window[callbackName]; reject(new Error('Request timeout')); }, 20000);
        });

        const script = document.createElement('script');
        script.src = `${SERVICE_AGREEMENTS_API_URL}?action=getServiceAgreements&callback=${callbackName}`;
        script.onerror = () => {
          delete window[callbackName];
          const list = document.getElementById('serviceAgreementsList');
          if (list) {
            list.innerHTML = `
              <div style="text-align: center; padding: 40px;">
                <p style="color: #e53e3e; margin-bottom: 20px; font-size: 18px;">Unable to load service agreements.</p>
                <button class="btn btn-primary" onclick="loadServiceAgreementsFromDrive()">Try Again</button>
              </div>`;
          }
        };

        document.body.appendChild(script);
        const data = await promise;
        document.body.removeChild(script);

        if (data.status === 'success') {
          const sorted = (data.serviceAgreements || []).sort((a, b) => new Date(b.modifiedTime) - new Date(a.modifiedTime));
          sorted.forEach(agreement => {
            if (!agreement.status) {
              agreement.status = 'active';
            }
          });
          window.allServiceAgreements = sorted;
          filterServiceAgreements();
        } else {
          throw new Error(data.message || 'Failed to load service agreements');
        }
      } catch (error) {
        const list = document.getElementById('serviceAgreementsList');
        if (list) {
          list.innerHTML = `
            <div style="text-align: center; padding: 40px;">
              <p style="color: #e53e3e; margin-bottom: 20px; font-size: 18px;">Unable to load service agreements.</p>
              <p style="color: #718096; margin-bottom: 20px;">Error: ${error.message}</p>
              <button class="btn btn-primary" onclick="loadServiceAgreementsFromDrive()">Try Again</button>
            </div>`;
        }
      }
    }

    function displayServiceAgreements(agreements) {
      const list = document.getElementById('serviceAgreementsList');
      if (!list) return;
      if (agreements.length === 0) {
        const filterText = window.currentServiceFilter === 'active' ? 'active' : 
                          window.currentServiceFilter === 'archived' ? 'archived' : '';
        list.innerHTML = `<div style="text-align: center; padding: 40px; color: #718096;"><p>No ${filterText} service agreements found.</p></div>`;
        return;
      }
      
      list.innerHTML = agreements.map(a => {
        const isArchived = a.status === 'archived';
        const archiveButtonText = isArchived ? 'Restore' : 'Archive';
        const itemClass = isArchived ? 'archived-item' : '';
        const archivedBadge = isArchived ? '<span class="archived-badge">Archived</span>' : '';
        
        return `
          <div class="agreement-item ${itemClass}" style="background: white; padding: 25px; border-radius: 15px; border: 2px solid #e2e8f0; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.05);"
               onmouseover="this.style.borderColor='#1e3a8a'; this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.1)'"
               onmouseout="this.style.borderColor='#e2e8f0'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.05)'">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
              <div style="flex: 1; min-width: 200px;">
                <h4 style="margin: 0 0 8px 0; color: #2d3748; font-size: 18px;">${a.name}${archivedBadge}</h4>
                <p style="margin: 0; color: #718096; font-size: 14px;">
                  Modified: ${a.modifiedTime ? new Date(a.modifiedTime).toLocaleDateString() : 'Unknown'}
                  ${isArchived && a.archivedDate ? `<br>Archived: ${new Date(a.archivedDate).toLocaleDateString()}` : ''}
                </p>
              </div>
              <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="viewServiceAgreementPDF('${a.id}', '${a.name}')" style="padding: 10px 20px; font-size: 14px; min-width: 80px;">View</button>
                <button class="btn btn-secondary" onclick="window.open('https://drive.google.com/uc?export=download&id=${a.id}', '_blank')" style="padding: 10px 20px; font-size: 14px; min-width: 80px;">Download</button>
                <button class="btn archive-btn" onclick="toggleServiceAgreementArchive('${a.id}', '${a.status || 'active'}', event)">${archiveButtonText}</button>
              </div>
            </div>
          </div>`;
      }).join('');
    }

    function filterServiceAgreements() {
      const input = document.getElementById('serviceAgreementSearch');
      const term = input ? input.value.toLowerCase() : '';
      const clearBtn = document.getElementById('clearServiceSearchBtn');
      if (clearBtn) clearBtn.style.display = term.length > 0 ? 'block' : 'none';
      if (!window.allServiceAgreements || window.allServiceAgreements.length === 0) return;

      // Filter by archive status first
      let filteredByStatus = window.allServiceAgreements;
      if (window.currentServiceFilter === 'active') {
        filteredByStatus = window.allServiceAgreements.filter(a => a.status !== 'archived');
      } else if (window.currentServiceFilter === 'archived') {
        filteredByStatus = window.allServiceAgreements.filter(a => a.status === 'archived');
      }

      // Then filter by search term
      let finalFiltered = filteredByStatus;
      if (term) {
        finalFiltered = filteredByStatus.filter(a => a.name.toLowerCase().includes(term));
      }

      displayServiceAgreements(finalFiltered);
    }

    function viewServiceAgreementPDF(fileId, fileName) {
      closePDFViewer();
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.style.display = 'block';

      const pdfModal = document.createElement('div');
      pdfModal.className = 'pdf-modal';
      const viewerUrl = `https://drive.google.com/file/d/${fileId}/preview`;

      pdfModal.innerHTML = `
        <div class="pdf-header">
          <h3>${fileName}</h3>
          <div style="display: flex; gap: 10px; align-items: center;">
            <button class="btn btn-primary" onclick="closePDFViewer(); setTimeout(openServiceAgreementViewer, 200);" style="padding: 10px 20px;">Back to Library</button>
            <button class="btn btn-secondary" onclick="window.open('https://drive.google.com/uc?export=download&id=${fileId}', '_blank')" style="padding: 10px 20px;">Download</button>
          </div>
        </div>
        <div class="pdf-viewer"><iframe src="${viewerUrl}" allowfullscreen></iframe></div>`;
      overlay.appendChild(pdfModal);
      document.body.appendChild(overlay);
    }

    /* ====== Backdrop close for all overlays (ignore auth overlay) ====== */
    window.addEventListener('click', function (event) {
      if (event.target.classList.contains('modal-overlay') && event.target.id !== 'loginOverlay') {
        event.target.remove();
      }
    });
  </script>

  <!-- Reusable Username + Logout pill (init call only) -->
  <script>
    if (window.UserBar && typeof UserBar.init === 'function') {
      UserBar.init({ redirectOnLogout: 'index.html', hideForGuests: true });
    }
  </script>
</body>
</html>
