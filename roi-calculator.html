<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Smart Food Fridge ROI Calculator - Quantum Solutions</title>
  <style>
    :root{
      --qs-blue:#1e3a8a;
      --qs-blue-2:#1e40af;
      --bg:#0b2a6c;
      --muted:#64748b;
      --card:#ffffff;
      --pill:#eef2ff;
      --good:#059669;
      --bad:#dc2626;
      --ring:#e2e8f0;
      --panel:#f8fafc;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Ubuntu,'Helvetica Neue',sans-serif;
      background: radial-gradient(1200px 600px at 10% 0%, #2443a3 0%, #102a78 40%, #0b1f5f 70%, #071845 100%);
      min-height:100vh; padding:24px; color:#111827;
    }
    .wrap{max-width:960px;margin:0 auto;}
    .card{
      background:var(--card);
      border-radius:16px;
      box-shadow:0 20px 60px rgba(0,0,0,.25);
      padding:20px 20px 24px;
      border:1px solid #e5e7eb;
    }
    .header{
      display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px;
    }
    .title{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
    }
    h1{font-size:20px; font-weight:800; color:var(--qs-blue)}
    .badge{
      font-size:12px; font-weight:700; color:#334155; background:#f1f5f9; border:1px solid #e2e8f0;
      padding:6px 10px; border-radius:999px;
    }
    .actions{display:flex; gap:8px;}
    .btn{
      background:var(--qs-blue); color:#fff; border:none; border-radius:8px; padding:10px 14px; font-weight:700;
      cursor:pointer; transition:.2s; box-shadow:0 6px 14px rgba(30,58,138,.25);
    }
    .btn:hover{background:var(--qs-blue-2); transform:translateY(-1px)}
    .btn.secondary{background:#64748b}.btn.secondary:hover{background:#475569}
    .note{
      background:#fff7e6; color:#92400e; border:1px solid #f59e0b; padding:10px 14px; border-radius:10px; margin-bottom:16px;
      font-size:13px; text-align:center;
    }

    .grid{display:grid; gap:16px}
    @media(min-width:880px){ .grid.cols-2{grid-template-columns:1fr 1fr;} }

    .section{background:var(--panel); border:1px solid var(--ring); border-radius:12px; padding:16px}
    .section h3{font-size:14px; font-weight:800; color:var(--qs-blue); margin-bottom:12px}
    .row{display:grid; grid-template-columns:1fr 140px; gap:12px; align-items:center; margin-bottom:10px}
    .row label{font-size:13px; color:#374151; font-weight:600}
    input{
      width:100%; border:2px solid #d1d5db; border-radius:8px; padding:10px 12px; font-size:14px; background:#fff;
    }
    input:focus{outline:none;border-color:var(--qs-blue); box-shadow:0 0 0 3px rgba(30,58,138,.12)}
    .muted{color:var(--muted); font-size:13px}
    .fixed-box{background:#eef2ff; border:1px dashed #93c5fd; padding:12px; border-radius:8px; font-size:12px; color:#1f2937}

    .results{background:linear-gradient(135deg,#e8f1ff,#ddecff); border:2px solid var(--qs-blue); border-radius:12px; padding:16px}
    .results h3{text-align:center; margin-bottom:10px}
    .cards{display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:12px}
    .cardStat{background:#fff;border:1px solid #e5e7eb; border-radius:10px; padding:14px; text-align:center}
    .label{font-size:12px; color:#6b7280; font-weight:700}
    .value{font-size:20px; font-weight:800; color:var(--qs-blue); margin-top:6px}
    .value.good{color:var(--good)} .value.bad{color:var(--bad)}

    .timeline{background:#fff;border:1px solid #e5e7eb; border-radius:10px; padding:14px}
    .timelineGrid{display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:10px}
    .tItem{background:#f8fafc;border:1px solid #e5e7eb;border-radius:8px;padding:12px;text-align:center}
    .tLabel{font-size:12px; color:#6b7280}
    .tVal{font-size:16px; font-weight:800; color:var(--good)}

    .footerActions{display:flex; gap:10px; justify-content:center; margin-top:14px}

    /* overlay / modal */
    .overlay{position:fixed; inset:0; background:rgba(0,0,0,.65); display:none; align-items:center; justify-content:center; z-index:9999}
    .modal{background:#fff; border-radius:16px; padding:18px; width:min(95vw,560px); box-shadow:0 30px 70px rgba(0,0,0,.35)}
    .modal h4{font-size:16px; font-weight:800; color:#111827; margin-bottom:10px}
    .modal .row{grid-template-columns:120px 1fr}
    .badge-pill{display:inline-block; font-size:11px; background:#f1f5f9; padding:4px 8px; border-radius:999px; border:1px solid #e5e7eb}
    .list{margin-top:10px; max-height:340px; overflow:auto; border:1px solid #e5e7eb; border-radius:10px}
    .listItem{padding:10px 12px; border-bottom:1px solid #f1f5f9; font-size:13px}
    .listItem:last-child{border-bottom:none}
    .chip{display:inline-block; font-size:11px; background:#eef2ff; color:#1f2937; padding:2px 6px; border-radius:999px; border:1px solid #dbeafe}

    /* loader */
    .loading{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(30,58,138,.9); z-index:9998}
    .loadingBox{background:#fff; padding:24px; border-radius:16px; text-align:center; width:min(92vw,360px)}
    .spinner{width:36px;height:36px;border-radius:50%; border:4px solid #e5e7eb;border-top-color:var(--qs-blue); margin:0 auto 12px; animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .operator-only{display:none}
    .mode-operator .operator-only{display:inline-flex}
  </style>
</head>
<body>
  <!-- Loading -->
  <div id="loading" class="loading" aria-hidden="true">
    <div class="loadingBox">
      <div class="spinner"></div>
      <div style="color:var(--qs-blue); font-weight:800; margin-bottom:6px">Loading ROI Calculator…</div>
      <div class="muted">Validating access and retrieving latest data</div>
    </div>
  </div>

  <div id="app" class="wrap" style="display:none">
    <div class="card">
      <div class="header">
        <div class="title">
          <h1>Smart Food Fridge ROI Calculator</h1>
          <span id="modeBadge" class="badge">Operator Mode</span>
        </div>
        <div class="actions operator-only">
          <button class="btn secondary" id="btnManage">Manage Links</button>
          <button class="btn" id="btnShare">Share / Get Link</button>
        </div>
      </div>

      <div class="note">
        These are estimated calculations. True profit is determined by your actual business model and operational factors.
      </div>

      <div class="grid cols-2">
        <div class="section">
          <h3>Business Assumptions</h3>

          <div class="row">
            <label for="fridgeCount">Number of Fridges</label>
            <input id="fridgeCount" type="number" min="1" value="1" />
          </div>
          <div class="row">
            <label for="transactions">Monthly Transactions (per fridge)</label>
            <input id="transactions" type="number" min="50" value="330" />
          </div>
          <div class="row">
            <label for="foodPrice">Food Price per Sale</label>
            <input id="foodPrice" type="number" step="0.25" value="10"/>
          </div>
          <div class="row">
            <label for="foodPercent">Food Sales %</label>
            <input id="foodPercent" type="number" min="0" max="100" value="90"/>
          </div>
          <div class="row">
            <label for="beveragePrice">Beverage Price per Sale</label>
            <input id="beveragePrice" type="number" step="0.25" value="3.99"/>
          </div>
          <div class="row">
            <label for="beveragePercent">Beverage Sales %</label>
            <input id="beveragePercent" type="number" min="0" max="100" value="10"/>
          </div>
          <div class="row">
            <label for="margin">Your Profit Margin %</label>
            <input id="margin" type="number" min="10" max="80" value="60"/>
          </div>
          <div class="row">
            <label for="spoilage">Spoilage %</label>
            <input id="spoilage" type="number" min="0" max="25" step="0.5" value="0"/>
          </div>
          <div class="row">
            <label for="serviceFee">Monthly Service Fee (per fridge)</label>
            <input id="serviceFee" type="number" min="0" step="1" value="395"/>
          </div>
        </div>

        <div class="section">
          <h3>Operational Costs</h3>

          <div class="row">
            <label for="financing">Monthly Financing Payment</label>
            <input id="financing" type="number" min="0" value="295"/>
          </div>
          <div class="row">
            <label for="laborRate">Labor Rate ($/hour)</label>
            <input id="laborRate" type="number" min="0" value="20"/>
          </div>
          <div class="row">
            <label for="laborHours">Hours per Week (per fridge)</label>
            <input id="laborHours" type="number" min="0" step="0.25" value="0.75"/>
          </div>
          <div class="row">
            <label for="miscCosts">Miscellaneous Monthly Costs</label>
            <input id="miscCosts" type="number" min="0" step="1" value="0"/>
          </div>

          <div class="fixed-box" style="margin-top:6px">
            <div style="font-weight:800; margin-bottom:6px">Fixed Costs & Fees (per fridge):</div>
            <ul style="margin-left:18px; line-height:1.5">
              <li>Cellular: $25/month</li>
              <li>License Fee: $175/month</li>
              <li>Engage Transaction: $0.15 per tx</li>
              <li>Gateway Transaction: $0.07 per tx</li>
              <li>Merchant Interchange: 2.5% of revenue</li>
              <li>Merchant Swipe Fee: $0.03 per tx</li>
              <li>RFID Tags: $0.18 per tag</li>
            </ul>
          </div>
        </div>
      </div>

      <div class="results" style="margin-top:16px">
        <h3>Financial Performance</h3>
        <div class="cards" style="margin-bottom:12px">
          <div class="cardStat">
            <div class="label">Monthly Revenue</div>
            <div id="monthlyRevenue" class="value">$0</div>
          </div>
          <div class="cardStat">
            <div class="label">Monthly Costs</div>
            <div id="monthlyCosts" class="value">$0</div>
          </div>
          <div class="cardStat">
            <div class="label">Monthly Net Profit</div>
            <div id="monthlyProfit" class="value">$0</div>
          </div>
          <div class="cardStat">
            <div class="label">Annual Net Profit</div>
            <div id="annualProfit" class="value">$0</div>
          </div>
          <div class="cardStat">
            <div class="label">ROI %</div>
            <div id="roiPercent" class="value">—</div>
          </div>
          <div class="cardStat">
            <div class="label">Payback Period</div>
            <div id="paybackPeriod" class="value">—</div>
          </div>
        </div>

        <div class="timeline">
          <div class="muted" style="text-align:center; font-weight:700; margin-bottom:10px">Multi-Year Projection</div>
          <div id="timelineGrid" class="timelineGrid"></div>
        </div>
      </div>

      <div class="footerActions">
        <button class="btn" onclick="generatePDFReport()">Download PDF Report</button>
      </div>
    </div>
  </div>

  <!-- Share / Manage overlays -->
  <div id="shareOverlay" class="overlay" aria-hidden="true">
    <div class="modal">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
        <h4>Create a 7-day share link</h4>
        <span class="badge-pill">Operator</span>
      </div>

      <div class="row">
        <label>Client name</label>
        <input id="shareClient" placeholder="optional"/>
      </div>
      <div class="row">
        <label>Link</label>
        <input id="shareUrl" readonly placeholder="Click Generate to create link"/>
      </div>

      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px">
        <button class="btn secondary" onclick="copyShare()">Copy</button>
        <button class="btn" onclick="createShare()">Generate</button>
        <button class="btn secondary" onclick="closeShare()">Close</button>
      </div>
    </div>
  </div>

  <div id="manageOverlay" class="overlay" aria-hidden="true">
    <div class="modal">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
        <h4>Manage Links</h4>
        <span class="badge-pill">Last 50</span>
      </div>

      <div class="row">
        <label>Created by</label>
        <input id="filterCreatedBy" placeholder="defaults to your operator name"/>
      </div>

      <div class="list">
        <div id="tokenList" class="listInner"></div>
      </div>

      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px">
        <button class="btn" onclick="loadTokens()">Refresh</button>
        <button class="btn secondary" onclick="closeManage()">Close</button>
      </div>
    </div>
  </div>

  <script>
    // ---------------- CONFIG ----------------
    const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbyliQpOEuz0QMKWMtHW7Cjlhqf2qEmLNTXI4TDY8THVPbKXzyqkIJ5dbIsHtb8JegHc_Q/exec';

    // --------------- STATE ------------------
    let baseRates = null;
    let accessToken = null;
    let operatorName = null;
    let accessValidated = false;

    // -------------- UTIL: JSONP -------------
    function jsonp(action, params = {}) {
      return new Promise((resolve, reject) => {
        const cb = 'jsonp_cb_' + Math.random().toString(36).slice(2);
        params.action = action;
        params.callback = cb;

        const qs = new URLSearchParams(params).toString();
        const s = document.createElement('script');
        s.src = `${BACKEND_URL}?${qs}`;
        s.async = true;

        const timer = setTimeout(() => {
          cleanup();
          reject(new Error('JSONP timeout'));
        }, 15000);

        function cleanup(){
          clearTimeout(timer);
          delete window[cb];
          s.remove();
        }

        window[cb] = (data) => { cleanup(); resolve(data); };
        s.onerror = () => { cleanup(); reject(new Error('JSONP error')); };
        document.body.appendChild(s);
      });
    }

    // ---------- INIT ----------
    window.addEventListener('DOMContentLoaded', init);

    async function init(){
      // Operator name (mirrored from quantum.html)
      operatorName = localStorage.getItem('dashboardUser') || '';

      // Read token from URL
      const url = new URL(location.href);
      accessToken = url.searchParams.get('token');

      // UI mode
      const isOperator = !accessToken;
      document.body.classList.toggle('mode-operator', isOperator);
      document.getElementById('modeBadge').textContent = isOperator ? 'Operator Mode' : 'Public Link';

      // Hook buttons
      document.getElementById('btnShare')?.addEventListener('click', openShare);
      document.getElementById('btnManage')?.addEventListener('click', openManage);

      // Try to validate access only if token present
      if (accessToken) {
        try {
          const resp = await jsonp('validateAccess', { token: accessToken, userAgent: navigator.userAgent });
          if (resp.status !== 'success') throw new Error(resp.message || 'Access denied');
          accessValidated = true;
        } catch(e) {
          console.warn('Falling back to defaults: ', e.message);
        }
      }

      // Get base rates (only via token; otherwise fallback)
      baseRates = getDefaultRates();

      // Show app
      document.getElementById('loading').style.display = 'none';
      document.getElementById('app').style.display = 'block';

      // Inputs listeners
      document.querySelectorAll('input').forEach(inp=>{
        inp.addEventListener('input', ()=>{highlight(inp); updateCalculations();});
      });

      updateCalculations();
    }

    function highlight(el){
      el.style.borderColor = '#1e3a8a';
      setTimeout(()=>{ el.style.borderColor = '#d1d5db'; }, 400);
    }

    // ----------- DEFAULT RATES -------------
    function getDefaultRates(){
      return {
        fixedCosts:{
          cellular:25,
          licenseFee:175,
          rfidTagsPerTag:0.18,
          engageTransactionFee:0.15,
          gatewayTransactionFee:0.07,
          merchantAccountPercent:2.5,
          merchantAccountSwipeFee:0.03
        },
        defaults:{
          transactions:330, foodPrice:10, foodPercent:90,
          beveragePrice:3.99, beveragePercent:10,
          margin:60, spoilage:0,
          financing:295, laborRate:20, laborHours:0.75
        }
      };
    }

    // --------------- CALC -------------------
    function updateCalculations(){
      const inputs = {
        fridgeCount: parseInt(document.getElementById('fridgeCount').value) || 1,
        transactions: parseInt(document.getElementById('transactions').value) || 0,
        foodPrice: parseFloat(document.getElementById('foodPrice').value) || 0,
        foodPercent: parseFloat(document.getElementById('foodPercent').value) || 0,
        beveragePrice: parseFloat(document.getElementById('beveragePrice').value) || 0,
        beveragePercent: parseFloat(document.getElementById('beveragePercent').value) || 0,
        margin: parseFloat(document.getElementById('margin').value) || 0,
        spoilage: parseFloat(document.getElementById('spoilage').value) || 0,
        financing: parseFloat(document.getElementById('financing').value) || 0,
        laborRate: parseFloat(document.getElementById('laborRate').value) || 0,
        laborHours: parseFloat(document.getElementById('laborHours').value) || 0,
        miscCosts: parseFloat(document.getElementById('miscCosts').value) || 0,
        serviceFee: parseFloat(document.getElementById('serviceFee').value) || 0
      };

      const res = calculateROI(inputs);
      displayResults(res, inputs);
      renderTimeline(res);
      if (!accessToken) trackUsage('calculation_performed', inputs); // operator only
    }

    function calculateROI(inputs){
      const per = calculatePerFridge(inputs);
      return {
        monthlyRevenue: per.monthlyRevenue * inputs.fridgeCount,
        monthlyCosts:   per.monthlyCosts   * inputs.fridgeCount,
        monthlyProfit:  per.monthlyProfit  * inputs.fridgeCount,
        annualProfit:   per.monthlyProfit  * inputs.fridgeCount * 12,
        roi: per.roi,
        paybackMonths: per.paybackMonths
      };
    }

    // *** Sheet-aligned math ***
    function calculatePerFridge(inputs){
      const r = (baseRates && baseRates.fixedCosts) || getDefaultRates().fixedCosts;

      // Revenue (per fridge)
      const avgTicket = (inputs.foodPrice * (inputs.foodPercent/100))
                      + (inputs.beveragePrice * (inputs.beveragePercent/100));
      const revenue = inputs.transactions * avgTicket;

      // COGS from margin
      const cogs = revenue * (1 - inputs.margin/100);

      // Fixed/variable costs per the sheet
      const rfid    = inputs.transactions * r.rfidTagsPerTag;          // 0.18 / tx
      const engage  = inputs.transactions * r.engageTransactionFee;    // 0.15 / tx
      const gateway = inputs.transactions * r.gatewayTransactionFee;   // 0.07 / tx
      const mPct    = revenue * (r.merchantAccountPercent/100);        // 2.5% of rev
      const swipe   = inputs.transactions * r.merchantAccountSwipeFee; // 0.03 / tx
      const cellular= r.cellular;
      const license = r.licenseFee;
      const spoilage= revenue * (inputs.spoilage/100);

      const opCosts = cellular + license + rfid + engage + gateway + mPct + swipe + spoilage;

      const financing = inputs.financing;
      const labor     = inputs.laborRate * inputs.laborHours * 4.33; // weeks/month
      const misc      = inputs.miscCosts;
      const service   = inputs.serviceFee || 0; // *** simple + at the very end ***

      // Profit = (Revenue - COGS) - all costs - financing - labor - misc + service
      const grossProfit   = revenue - cogs;
      const monthlyProfit = grossProfit - opCosts - financing - labor - misc + service;

      // For cards: keep revenue vs costs "pure" (service fee is not counted as revenue)
      const monthlyRevenueCard = revenue;
      const monthlyCostsCard   = cogs + opCosts + financing + labor + misc;

      // ROI / Payback
      const initial = 7500;
      const annualProfit = monthlyProfit * 12;
      const roi = (annualProfit / initial) * 100;
      const paybackMonths = monthlyProfit > 0 ? (initial / monthlyProfit) : Infinity;

      return {
        monthlyRevenue: monthlyRevenueCard,
        monthlyCosts: monthlyCostsCard,
        monthlyProfit,
        roi,
        paybackMonths
      };
    }

    function displayResults(res){
      setText('monthlyRevenue', money(res.monthlyRevenue));
      setText('monthlyCosts',   money(res.monthlyCosts));

      const mp = document.getElementById('monthlyProfit');
      mp.textContent = money(res.monthlyProfit);
      mp.className = 'value ' + (res.monthlyProfit >= 0 ? 'good' : 'bad');

      const ap = document.getElementById('annualProfit');
      ap.textContent = money(res.annualProfit);
      ap.className = 'value ' + (res.annualProfit >= 0 ? 'good' : 'bad');

      document.getElementById('roiPercent').textContent =
        Number.isFinite(res.roi) ? res.roi.toFixed(1) + '%' : '—';

      document.getElementById('paybackPeriod').textContent =
        Number.isFinite(res.paybackMonths) ? Math.round(res.paybackMonths) + ' months' : 'N/A';
    }

    function renderTimeline(res){
      const grid = document.getElementById('timelineGrid');
      grid.innerHTML = '';
      const items = [
        {label:'Year 1', val: res.monthlyProfit * 12},
        {label:'Year 2', val: res.monthlyProfit * 24},
        {label:'Year 3', val: res.monthlyProfit * 36}
      ];
      items.forEach(it=>{
        const d = document.createElement('div');
        d.className = 'tItem';
        d.innerHTML = `<div class="tLabel">${it.label}</div><div class="tVal">${money(it.val)}</div>`;
        grid.appendChild(d);
      });
    }

    // --------- SHARE / MANAGE ----------
    function openShare(){
      document.getElementById('shareClient').value = '';
      document.getElementById('shareUrl').value = '';
      document.getElementById('shareOverlay').style.display = 'flex';
    }
    function closeShare(){ document.getElementById('shareOverlay').style.display = 'none'; }

    async function createShare(){
      const client = document.getElementById('shareClient').value.trim();
      try{
        const resp = await jsonp('generateToken', { createdBy: operatorName || 'Operator', clientName: client });
        if(resp.status !== 'success') throw new Error(resp.message || 'Could not generate');
        const url = resp.data && (resp.data.shareUrl || `${location.origin}${location.pathname}?token=${resp.data.token}`);
        document.getElementById('shareUrl').value = url || '';
      }catch(err){
        alert('Error: ' + err.message);
      }
    }
    function copyShare(){
      const el = document.getElementById('shareUrl');
      el.select(); el.setSelectionRange(0,99999);
      document.execCommand('copy');
      alert('Link copied');
    }

    function openManage(){
      document.getElementById('filterCreatedBy').value = operatorName || '';
      document.getElementById('manageOverlay').style.display = 'flex';
      loadTokens();
    }
    function closeManage(){ document.getElementById('manageOverlay').style.display='none'; }

    async function loadTokens(){
      const list = document.getElementById('tokenList');
      list.innerHTML = '<div class="listItem">Loading…</div>';
      try{
        const createdBy = (document.getElementById('filterCreatedBy').value || operatorName || '').trim();
        const resp = await jsonp('listTokens', { createdBy, onlyActive:'false', maxRows:'50' });
        if(resp.status !== 'success') throw new Error(resp.message || 'Failed');
        const rows = resp.data.tokens || [];
        if(!rows.length){ list.innerHTML = '<div class="listItem muted">No tokens found.</div>'; return; }
        list.innerHTML = rows.map(t => {
          const active = t.active ? 'active' : 'inactive';
          return `
            <div class="listItem">
              <div><strong>${t.clientName || '(no client name)'}</strong> <span class="chip">${active}</span></div>
              <div class="muted" style="margin:2px 0">Created: ${t.createdDate ? new Date(t.createdDate).toLocaleString() : '—'} · Accesses: ${t.accessCount ?? 0}</div>
              <div class="muted" style="margin:2px 0">Link: <a href="${t.shareUrl}" target="_blank">${t.shareUrl}</a></div>
              <div style="margin-top:6px; display:flex; gap:8px">
                <button class="btn secondary" onclick="copyText('${t.shareUrl.replace(/'/g, "\\'")}')">Copy Link</button>
                ${t.active ? `<button class="btn" onclick="revokeToken('${t.token}')">Revoke</button>` : ''}
              </div>
            </div>`;
        }).join('');
      }catch(err){
        list.innerHTML = `<div class="listItem">Error: ${err.message}</div>`;
      }
    }
    function copyText(text){
      const ta = document.createElement('textarea');
      ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove();
      alert('Copied!');
    }
    async function revokeToken(tok){
      if(!confirm('Revoke this link?')) return;
      try{
        const resp = await jsonp('deactivateToken', { token: tok });
        if(resp.status !== 'success') throw new Error(resp.message || 'Failed');
        await loadTokens();
      }catch(err){
        alert('Error: ' + err.message);
      }
    }

    // --------- MISC ----------
    function trackUsage(action, inputData){
      try{
        jsonp('trackUsage', {
          token: accessToken || '',
          action,
          userAgent: navigator.userAgent,
          inputs: inputData ? JSON.stringify(inputData) : ''
        });
      }catch(_e){}
    }
    function setText(id, val){ document.getElementById(id).textContent = val; }
    function money(n){ return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',maximumFractionDigits:0}).format(n||0); }

    function generatePDFReport(){
      alert('PDF Report generation coming soon!');
    }

    // close overlays when clicking the dim
    document.addEventListener('click', (e)=>{
      if(e.target === document.getElementById('shareOverlay')) closeShare();
      if(e.target === document.getElementById('manageOverlay')) closeManage();
    });
  </script>
</body>
</html>
