<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Smart Food Fridge ROI Calculator - Quantum Solutions</title>

<!-- Shared auth (operator mode only requires login) -->
<script defer src="password.js"></script>
<!-- Add jsPDF library for PDF generation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  :root{
    --brand:#1e3a8a; --brand-2:#3b82f6; --ink:#0f172a; --muted:#64748b;
    --good:#059669; --bad:#dc2626; --panel:#f8fafc; --line:#e2e8f0;
  }
  *{box-sizing:border-box}
  /* Deep blue like dashboard */
  body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,system-ui,sans-serif;
    background:linear-gradient(135deg,#0b1f63 0%, #1e3a8a 40%, #2c5edc 100%);
    min-height:100vh;
    color:#111827
  }
  .wrap{max-width:980px;margin:40px auto;padding:0 14px}
  .card{background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.25);overflow:hidden}
  .hdr{display:flex;align-items:center;justify-content:space-between;padding:18px 20px;border-bottom:3px solid var(--brand)}
  .hdr-left h1{margin:0;font-size:20px;color:var(--brand)}
  .tag{display:inline-block;margin-left:10px;padding:4px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;font-weight:600;font-size:12px}
  .hdr-right{display:flex;gap:10px}
  .btn{background:var(--brand);color:#fff;border:none;border-radius:8px;padding:10px 14px;font-weight:600;cursor:pointer}
  .btn.secondary{background:#64748b}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  /* more breathing room above the orange note */
  .note{background:#fff7ed;border:2px solid #fb923c;color:#92400e;margin:12px 20px 16px;border-radius:10px;padding:12px 14px;font-weight:600}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;padding:0 20px 20px}
  .panel{background:#f8fafc;border:2px solid var(--line);border-radius:12px;padding:16px}
  .panel h3{margin:0 0 10px;color:var(--brand);font-size:16px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .fg{margin-bottom:12px}
  .fg label{display:block;font-weight:600;color:#374151;margin-bottom:6px;font-size:14px}
  .fg input{width:100%;padding:10px 12px;border:2px solid #d1d5db;border-radius:8px;background:#fff;font-size:14px}
  .fg input:focus{outline:none;border-color:var(--brand);box-shadow:0 0 0 3px rgba(30,58,138,.12)}
  @media (max-width:840px){.grid{grid-template-columns:1fr}}
  .results{margin:0 20px 16px;padding:16px;border:3px solid var(--brand);border-radius:12px;background:linear-gradient(135deg,#dbeafe 0%,#bfdbfe 100%)}
  .results h3{margin:0 0 12px;text-align:center;color:var(--brand)}
  .rg{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:12px}
  .rg2{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  @media (max-width:840px){.rg,.rg2{grid-template-columns:1fr 1fr}}
  .kpi{background:#fff;border:2px solid var(--line);border-radius:10px;text-align:center;padding:16px}
  .kpi .l{color:#6b7280;font-weight:600;font-size:12px;margin-bottom:6px}
  .kpi .v{font-weight:800;color:var(--brand);font-size:20px}
  .kpi .v.positive{color:#059669} .kpi .v.negative{color:#dc2626}

  .breakdown{margin:0 20px 20px;background:#fff;border:2px solid var(--line);border-radius:12px;overflow:hidden}
  .bd-h{padding:12px 14px;border-bottom:2px solid var(--line);font-weight:800;color:var(--brand)}
  table{width:100%;border-collapse:collapse;font-size:14px}
  thead th{background:#f8fafc;color:#374151;font-weight:700;font-size:12px;padding:10px;border-bottom:1px solid var(--line)}
  tbody td{padding:10px;border-bottom:1px solid var(--line)}
  tbody tr.b-total td{font-weight:800}
  tbody tr.b-section td{background:#f8fafc;font-weight:700;color:#475569}
  .subtle{font-size:12px;color:#6b7280;padding:8px 14px}
  .footerBtns{display:flex;gap:10px;justify-content:center;padding:8px 20px 20px}

  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:1000}
  .modal{background:#fff;border-radius:14px;max-width:520px;width:92%;padding:18px;border:2px solid var(--line)}
  .modal h4{margin:0 0 12px;color:#1e3a8a}
  .modal .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
  .pill{display:inline-block;font-size:11px;padding:3px 8px;border-radius:999px;background:#eff6ff;color:#1d4ed8;font-weight:700}
  .tableBadge{font-size:11px;padding:2px 6px;border-radius:999px;background:#eef2ff;color:#3730a3}

  /* Spinner for "Generate" */
  .btn .spin{
    display:inline-block;width:14px;height:14px;
    border:2px solid rgba(255,255,255,.85);
    border-right-color:transparent;border-radius:50%;
    margin-right:8px;vertical-align:-2px;
    animation:shareSpin .75s linear infinite;
  }
  @keyframes shareSpin{to{transform:rotate(360deg)}}

  /* Quick toast used after auto-copy */
  .toast{
    position:fixed; top:20px; right:20px; z-index:100000;
    background:#059669; color:#fff; padding:14px 18px; border-radius:10px;
    box-shadow:0 8px 30px rgba(0,0,0,.25); font-weight:700; max-width:320px;
    animation:toastIn .25s ease-out both;
  }
  @keyframes toastIn{from{opacity:0;transform:translateY(-8px)} to{opacity:1;transform:translateY(0)}}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="hdr">
      <div class="hdr-left">
        <h1>Smart Food Fridge ROI Calculator
          <span id="modeTag" class="tag" title="No token in URL ‚Üí Operator Mode">Operator Mode</span>
        </h1>
      </div>
      <div class="hdr-right" id="opButtons" style="display:flex">
        <button class="btn secondary" id="btnManage">Manage Links</button>
        <button class="btn" id="btnShare">Share / Get Link</button>
      </div>
    </div>

    <div class="note">These are estimated calculations. True profit is determined by your actual business model and operational factors.</div>

    <div class="grid">
      <div class="panel">
        <h3>Business Assumptions</h3>

        <div class="fg">
          <label>Number of Fridges</label>
          <input id="fridgeCount" type="number" min="1" value="1">
        </div>

        <div class="fg">
          <label>Monthly Transactions (per fridge)</label>
          <input id="transactions" type="number" min="0" value="330">
        </div>

        <div class="row">
          <div class="fg">
            <label>Food Price per Sale</label>
            <input id="foodPrice" type="number" step="0.01" min="0" value="10">
          </div>
          <div class="fg">
            <label>Food Sales %</label>
            <input id="foodPercent" type="number" min="0" max="100" value="90">
          </div>
        </div>

        <div class="row">
          <div class="fg">
            <label>Beverage Price per Sale</label>
            <input id="beveragePrice" type="number" step="0.01" min="0" value="3.99">
          </div>
          <div class="fg">
            <label>Beverage Sales %</label>
            <input id="beveragePercent" type="number" min="0" max="100" value="10">
          </div>
        </div>

        <div class="row">
          <div class="fg">
            <label>Your Profit Margin %</label>
            <input id="margin" type="number" min="0" max="100" value="60">
          </div>
          <div class="fg">
            <label>Spoilage % (at cost)</label>
            <input id="spoilage" type="number" min="0" step="0.5" value="0">
          </div>
        </div>

        <div class="fg">
          <label>Monthly Service Fee Charged to Client (per fridge)</label>
          <input id="serviceFee" type="number" min="0" step="1" value="395">
        </div>
      </div>

      <div class="panel">
        <h3>Operational Costs</h3>

        <div class="fg">
          <label>Monthly Financing Payment</label>
          <input id="financing" type="number" min="0" value="295">
        </div>

        <div class="row">
          <div class="fg">
            <label>Labor Rate ($/hour)</label>
            <input id="laborRate" type="number" min="0" value="20">
          </div>
          <div class="fg">
            <label>Hours per Week (per fridge)</label>
            <input id="laborHours" type="number" step="0.25" min="0" value="0.75">
          </div>
        </div>

        <div class="fg">
          <label>Miscellaneous Monthly Costs</label>
          <input id="miscCosts" type="number" min="0" value="0">
        </div>

        <div class="panel" style="background:#eef6ff;border-color:#bfdbfe;margin-top:8px">
          <h3 style="margin-bottom:6px">Fixed Costs & Fees (per fridge):</h3>
          <div id="fixedCostsSummary" class="subtle">
            ‚Ä¢ Cellular: $25.00 /month<br>
            ‚Ä¢ License Fee: $175.00 /month<br>
            ‚Ä¢ Engage <b>Transactions</b> Fees <i>($0.15/tx)</i><br>
            ‚Ä¢ Gateway <b>Transactions</b> Fees <i>($0.07/tx)</i><br>
            ‚Ä¢ Merchant Interchange: 2.50% of sales revenue<br>
            ‚Ä¢ Merchant Swipe Fee: $0.03 per tx<br>
            ‚Ä¢ RFID Tags: $0.18 per tag
          </div>
        </div>
      </div>
    </div>

    <div class="results">
      <h3>Financial Performance</h3>

      <!-- row 1 -->
      <div class="rg">
        <div class="kpi">
          <div class="l">Monthly <u>Sales</u> Revenue (products)</div>
          <div id="kpiSalesRevenue" class="v">$0.00</div>
        </div>
        <div class="kpi">
          <div class="l">Monthly Service Fee Revenue</div>
          <div id="kpiServiceRevenue" class="v">$0.00</div>
        </div>
        <div class="kpi">
          <div class="l">Monthly Costs (incl. financing)</div>
          <div id="kpiCosts" class="v">$0.00</div>
        </div>
      </div>

      <!-- row 2 -->
      <div class="rg2">
        <div class="kpi">
          <div class="l">Total Revenue (Sales + Service Fee)</div>
          <div id="kpiTotalRevenue" class="v">$0.00</div>
        </div>
        <div class="kpi">
          <div class="l">Monthly Net Profit</div>
          <div id="kpiNet" class="v positive">$0.00</div>
        </div>
        <div class="kpi">
          <div class="l">Annual Net Profit</div>
          <div id="kpiAnnual" class="v positive">$0.00</div>
        </div>
      </div>
    </div>

    <!-- Multi-Year Projection removed -->

    <div class="breakdown">
      <div class="bd-h">Cost Breakdown</div>
      <table>
        <thead>
          <tr>
            <th>Component</th>
            <th style="width:160px">Per Fridge</th>
            <th style="width:160px">All Fridges</th>
          </tr>
        </thead>
        <tbody id="breakdownBody"><tr><td colspan="3" class="subtle">Enter inputs to see a detailed cost breakdown‚Ä¶</td></tr></tbody>
      </table>
    </div>

    <div class="footerBtns">
      <button class="btn" id="btnPDF">Download PDF Report</button>
      <button class="btn secondary" id="btnShare2">Share Results</button>
    </div>

  </div>
</div>

<!-- Share Modal -->
<div class="overlay" id="shareOverlay">
  <div class="modal">
    <h4>Share / Get Link <span class="pill">7-day access</span></h4>
    <div class="fg">
      <label>Client/Prospect Name <span style="color:#dc2626">*</span></label>
      <input id="clientName" type="text" placeholder="e.g., Acme HQ, Jefferson, Costa Rica Lead" required>
      <div style="font-size:12px;color:#64748b;margin-top:4px;">Required for tracking on dashboard</div>
    </div>
    <div class="fg">
      <label>Link</label>
      <input id="shareUrlBox" type="text" readonly placeholder="Enter client name, then click Generate">
    </div>
    <div class="actions">
      <button class="btn" id="btnGenShare">Generate</button>
      <button class="btn secondary" onclick="closeShare()">Close</button>
    </div>
  </div>
</div>

<!-- Manage Modal -->
<div class="overlay" id="manageOverlay">
  <div class="modal" style="max-width:720px">
    <h4>Manage Links</h4>
    <div class="fg">
      <label>Filter by "Created By"</label>
      <input id="filterCreatedBy" type="text" placeholder="(optional)">
    </div>
    <div id="tokenList" class="subtle">Loading‚Ä¶</div>
    <div class="actions">
      <button class="btn secondary" onclick="closeManage()">Close</button>
    </div>
  </div>
</div>

<script>
/* ===========================
   Backend configuration
=========================== */
var BACKEND_URL = 'https://script.google.com/macros/s/AKfycbyliQpOEuz0QMKWMtHW7Cjlhqf2qEmLNTXI4TDY8THVPbKXzyqkIJ5dbIsHtb8JegHc_Q/exec';

/* "What the sheet includes in Total Costs" switches */
var IN_NET_INCLUDE_CELLULAR   = true;
var IN_NET_INCLUDE_LICENSE    = true;
var IN_NET_INCLUDE_RFID       = true;
var IN_NET_INCLUDE_ENGAGE     = true;
var IN_NET_INCLUDE_GATEWAY    = true;
var IN_NET_INCLUDE_MERCHANT   = true;
var IN_NET_INCLUDE_SWIPE      = true;
var IN_NET_INCLUDE_LABOR      = true;
var IN_NET_INCLUDE_MISC       = true;
var IN_NET_INCLUDE_FINANCING  = true;

var baseRates = {
  fixedCosts:{
    cellular:25, licenseFee:175, rfidTagsPerTag:0.18,
    engageTransactionFee:0.15, gatewayTransactionFee:0.13,
    merchantAccountPercent:2.5, merchantAccountSwipeFee:0.03
  }
};
var accessToken = null;
var operatorMode = true;
var sessionStartTime = null;
var downloadedPDF = false;

/* ===========================
   PDF Generation Function
=========================== */
function generatePDF() {
  try {
    if (typeof window.jspdf === 'undefined') {
      alert('PDF library not loaded. Please refresh the page.');
      return;
    }

    var inputs = readInputs();
    var pf = calcPerFridge(inputs);
    
    var salesRevenue = pf.salesRevenue * inputs.fridgeCount;
    var serviceRev = pf.serviceRevenue * inputs.fridgeCount;
    var totalRevenue = salesRevenue + serviceRev;
    var monthlyCosts = pf.totalCosts * inputs.fridgeCount;
    var monthlyNet = pf.netSheet * inputs.fridgeCount;
    var annual = (monthlyNet * 12) + (pf.serviceRevenue * inputs.fridgeCount * 12);

    var jsPDF = window.jspdf.jsPDF;
    var doc = new jsPDF();

    // Header with brand styling (matching web interface)
    doc.setFillColor(30, 58, 138);
    doc.rect(0, 0, 210, 25, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(16);
    doc.setFont('helvetica', 'bold');
    doc.text('Smart Food Fridge ROI Calculator', 20, 16);
    
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    doc.text('Operator Mode', 140, 16);
    doc.text('Generated: ' + new Date().toLocaleDateString(), 140, 20);

    // Disclaimer note (matching orange note)
    doc.setTextColor(146, 64, 14);
    doc.setFillColor(255, 247, 237);
    doc.rect(15, 30, 180, 12, 'F');
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    doc.text('These are estimated calculations. True profit is determined by your actual', 20, 36);
    doc.text('business model and operational factors.', 20, 40);

    var y = 50;

    // Two-column layout matching web interface
    // Left column - Business Assumptions
    doc.setTextColor(30, 58, 138);
    doc.setFillColor(248, 250, 252);
    doc.rect(15, y, 85, 8, 'F');
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.text('Business Assumptions', 20, y + 5);
    y += 12;

    doc.setTextColor(0, 0, 0);
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    doc.text('Number of Fridges: ' + inputs.fridgeCount, 20, y); y += 5;
    doc.text('Monthly Transactions (per fridge): ' + inputs.transactions, 20, y); y += 5;
    doc.text('Food Price per Sale: ' + usd2(inputs.foodPrice), 20, y); y += 5;
    doc.text('Food Sales %: ' + inputs.foodPercent + '%', 20, y); y += 5;
    doc.text('Beverage Price per Sale: ' + usd2(inputs.beveragePrice), 20, y); y += 5;
    doc.text('Beverage Sales %: ' + inputs.beveragePercent + '%', 20, y); y += 5;
    doc.text('Your Profit Margin %: ' + inputs.margin + '%', 20, y); y += 5;
    doc.text('Spoilage % (at cost): ' + inputs.spoilage + '%', 20, y); y += 5;
    doc.text('Monthly Service Fee: ' + usd2(inputs.serviceFee), 20, y);

    // Right column - Operational Costs
    var rightY = 62;
    doc.setTextColor(30, 58, 138);
    doc.setFillColor(248, 250, 252);
    doc.rect(110, rightY, 85, 8, 'F');
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.text('Operational Costs', 115, rightY + 5);
    rightY += 12;

    doc.setTextColor(0, 0, 0);
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    doc.text('Monthly Financing Payment: ' + usd2(inputs.financing), 115, rightY); rightY += 5;
    doc.text('Labor Rate ($/hour): ' + usd2(inputs.laborRate), 115, rightY); rightY += 5;
    doc.text('Hours per Week (per fridge): ' + inputs.laborHours, 115, rightY); rightY += 5;
    doc.text('Miscellaneous Monthly Costs: ' + usd2(inputs.miscCosts), 115, rightY); rightY += 8;

    // Fixed Costs section (right column continued)
    doc.setTextColor(30, 58, 138);
    doc.setFontSize(10);
    doc.setFont('helvetica', 'bold');
    doc.text('Fixed Costs & Fees (per fridge):', 115, rightY);
    rightY += 5;

    doc.setTextColor(107, 114, 128);
    doc.setFontSize(8);
    doc.setFont('helvetica', 'normal');
    doc.text('‚Ä¢ Cellular: $25.00 /month', 115, rightY); rightY += 4;
    doc.text('‚Ä¢ License Fee: $175.00 /month', 115, rightY); rightY += 4;
    doc.text('‚Ä¢ Engage Transaction Fees ($0.15/tx)', 115, rightY); rightY += 4;
    doc.text('‚Ä¢ Gateway Transaction Fees ($0.07/tx)', 115, rightY); rightY += 4;
    doc.text('‚Ä¢ Merchant Interchange: 2.50% of sales', 115, rightY); rightY += 4;
    doc.text('‚Ä¢ Merchant Swipe Fee: $0.03 per tx', 115, rightY); rightY += 4;
    doc.text('‚Ä¢ RFID Tags: $0.18 per tag', 115, rightY);

    y = Math.max(y + 10, rightY + 10);

    // Financial Performance section (matching KPI cards layout)
    doc.setTextColor(30, 58, 138);
    doc.setFillColor(219, 234, 254);
    doc.rect(15, y, 180, 8, 'F');
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.text('Financial Performance', 20, y + 5);
    y += 12;

    // KPI cards layout (3x2 grid matching web interface)
    var cardWidth = 55;
    var cardHeight = 18;
    var cardGap = 7;

    // Row 1
    var cards = [
      {label: 'Monthly Sales Revenue (products)', value: usd2(salesRevenue)},
      {label: 'Monthly Service Fee Revenue', value: usd2(serviceRev)},
      {label: 'Monthly Costs (incl. financing)', value: usd2(monthlyCosts)}
    ];

    for (var i = 0; i < 3; i++) {
      var x = 20 + i * (cardWidth + cardGap);
      doc.setFillColor(255, 255, 255);
      doc.rect(x, y, cardWidth, cardHeight, 'F');
      doc.setDrawColor(226, 232, 240);
      doc.rect(x, y, cardWidth, cardHeight, 'S');
      
      doc.setTextColor(107, 114, 128);
      doc.setFontSize(7);
      doc.setFont('helvetica', 'bold');
      doc.text(cards[i].label, x + 2, y + 5);
      
      doc.setTextColor(30, 58, 138);
      doc.setFontSize(11);
      doc.setFont('helvetica', 'bold');
      doc.text(cards[i].value, x + 2, y + 13);
    }

    y += cardHeight + 5;

    // Row 2
    var cards2 = [
      {label: 'Total Revenue (Sales + Service Fee)', value: usd2(totalRevenue)},
      {label: 'Monthly Net Profit', value: usd2(monthlyNet), color: monthlyNet >= 0 ? [5, 150, 105] : [220, 38, 38]},
      {label: 'Annual Net Profit', value: usd2(annual), color: annual >= 0 ? [5, 150, 105] : [220, 38, 38]}
    ];

    for (var i = 0; i < 3; i++) {
      var x = 20 + i * (cardWidth + cardGap);
      doc.setFillColor(255, 255, 255);
      doc.rect(x, y, cardWidth, cardHeight, 'F');
      doc.setDrawColor(226, 232, 240);
      doc.rect(x, y, cardWidth, cardHeight, 'S');
      
      doc.setTextColor(107, 114, 128);
      doc.setFontSize(7);
      doc.setFont('helvetica', 'bold');
      doc.text(cards2[i].label, x + 2, y + 5);
      
      if (cards2[i].color) {
        doc.setTextColor(cards2[i].color[0], cards2[i].color[1], cards2[i].color[2]);
      } else {
        doc.setTextColor(30, 58, 138);
      }
      doc.setFontSize(11);
      doc.setFont('helvetica', 'bold');
      doc.text(cards2[i].value, x + 2, y + 13);
    }

    y += cardHeight + 15;

    // Check if we need a new page
    if (y > 200) {
      doc.addPage();
      y = 30;
    }

    // Cost Breakdown Table (matching web table layout)
    doc.setTextColor(30, 58, 138);
    doc.setFillColor(248, 250, 252);
    doc.rect(15, y, 180, 8, 'F');
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.text('Cost Breakdown', 20, y + 5);
    y += 12;

    // Table header
    doc.setFillColor(248, 250, 252);
    doc.rect(15, y, 180, 8, 'F');
    doc.setTextColor(55, 65, 81);
    doc.setFontSize(8);
    doc.setFont('helvetica', 'bold');
    doc.text('Component', 20, y + 5);
    doc.text('Per Fridge', 120, y + 5);
    doc.text('All Fridges', 160, y + 5);
    y += 10;

    // Table data matching breakdown table
    var breakdownData = [
      {label: 'COGS', per: pf.cogs, all: pf.cogs * inputs.fridgeCount},
      {label: 'Spoilage (at cost)', per: pf.spoilageCost, all: pf.spoilageCost * inputs.fridgeCount},
      {label: 'Cellular', per: pf.cellular, all: pf.cellular * inputs.fridgeCount},
      {label: 'License Fee', per: pf.license, all: pf.license * inputs.fridgeCount},
      {label: 'Engage Transaction Fees', per: pf.engage, all: pf.engage * inputs.fridgeCount},
      {label: 'Gateway Transaction Fees', per: pf.gateway, all: pf.gateway * inputs.fridgeCount},
      {label: 'Merchant % Fee', per: pf.merchantPct, all: pf.merchantPct * inputs.fridgeCount},
      {label: 'Merchant Swipe Fee', per: pf.swipe, all: pf.swipe * inputs.fridgeCount},
      {label: 'RFID Tags', per: pf.rfid, all: pf.rfid * inputs.fridgeCount},
      {label: 'Labor', per: pf.labor, all: pf.labor * inputs.fridgeCount},
      {label: 'Miscellaneous', per: pf.misc, all: pf.misc * inputs.fridgeCount},
      {label: 'Financing', per: pf.financing, all: pf.financing * inputs.fridgeCount}
    ];

    doc.setTextColor(0, 0, 0);
    doc.setFontSize(8);
    doc.setFont('helvetica', 'normal');

    for (var i = 0; i < breakdownData.length; i++) {
      if (y > 270) {
        doc.addPage();
        y = 30;
      }
      doc.text(breakdownData[i].label, 20, y);
      doc.text(usd2(breakdownData[i].per), 120, y);
      doc.text(usd2(breakdownData[i].all), 160, y);
      y += 5;
    }

    // Total line
    y += 2;
    doc.setFont('helvetica', 'bold');
    doc.text('Total Costs (incl. financing)', 20, y);
    doc.text(usd2(pf.totalCosts), 120, y);
    doc.text(usd2(pf.totalCosts * inputs.fridgeCount), 160, y);

    // Footer
    doc.setFontSize(7);
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(107, 114, 128);
    doc.text('This report contains estimated calculations. Actual results may vary based on operational factors.', 20, 280);
    doc.text('Generated by Smart Food Fridge ROI Calculator - Quantum Solutions', 20, 285);

    var timestamp = new Date().toISOString().slice(0, 10);
    var filename = 'Smart-Fridge-ROI-Report-' + timestamp + '.pdf';
    
 doc.save(filename);
    
    // Track PDF download for guests
    if (!operatorMode) {
      downloadedPDF = true;
      sendSessionData();
    }
    
    toast('PDF downloaded to your Downloads folder!');

  } catch (error) {
    console.error('PDF Error:', error);
    alert('Failed to generate PDF: ' + error.message);
  }
}

/* ===========================
   Init
=========================== */
window.addEventListener('DOMContentLoaded', init);

function init(){
  var p = new URLSearchParams(location.search);
  accessToken = p.get('token');
  operatorMode = !accessToken;

  // Require login ONLY in operator mode
  if (operatorMode && window.Auth && !Auth.checkAuth()) return;

  document.getElementById('modeTag').textContent = operatorMode ? 'Operator Mode' : 'Guest Link';
  document.getElementById('modeTag').title = operatorMode ? 'No token in URL ‚Üí Operator Mode' : 'Viewing with a time-limited token';
  document.getElementById('opButtons').style.display = operatorMode ? 'flex' : 'none';

  // If guest mode (has token), validate it FIRST before allowing access
  if (!operatorMode) {
    validateGuestAccess();
    return; // Don't continue until validation completes
  }

  // Operator mode continues normally
  setupCalculator();
}



function validateGuestAccess() {
  fetch(BACKEND_URL + '?action=validateAccess&token=' + encodeURIComponent(accessToken))
  .then(function(res){ return res.json(); })
  .then(function(result){
    if (result.status === 'success') {
      // Valid token - show calculator
      setupCalculator();
      // Optionally show expiration warning if close to expiry
      if (result.data && result.data.daysRemaining <= 2) {
        toast('This link expires in ' + result.data.daysRemaining + ' day(s)', 'warn');
      }
    } else {
      // Invalid or expired - block access
      showAccessDenied(result.message, result.data && result.data.expired);
    }
  })
  .catch(function(err){
    showAccessDenied('Unable to verify access. Please try again later.', false);
  });
}




  function showAccessDenied(message, isExpired) {
  var card = document.querySelector('.card');
  card.innerHTML = 
    '<div style="padding:60px 40px;text-align:center">' +
      '<div style="font-size:64px;margin-bottom:20px">' + (isExpired ? '‚è∞' : 'üîí') + '</div>' +
      '<h2 style="color:#b91c1c;margin:0 0 12px">' + (isExpired ? 'Link Expired' : 'Access Denied') + '</h2>' +
      '<p style="color:#64748b;margin:0 0 24px;max-width:400px;margin-left:auto;margin-right:auto">' + 
        (isExpired 
          ? 'This ROI calculator link has expired. Please contact your sales representative for a new link.'
          : message || 'This link is invalid or has been revoked.') +
      '</p>' +
    '</div>';
}

  
  


function setupCalculator() {
  // wire buttons
  var s1 = document.getElementById('btnShare'); var s2 = document.getElementById('btnShare2');
  if (s1) s1.onclick = openShare;
  if (s2) s2.onclick = openShare;
  var manageBtn = document.getElementById('btnManage');
  if (manageBtn) manageBtn.onclick = openManage;
  var genBtn = document.getElementById('btnGenShare');
  if (genBtn) genBtn.onclick = createShare;
  var pdfBtn = document.getElementById('btnPDF');
  if (pdfBtn) pdfBtn.onclick = generatePDF;

  // inputs -> recalc
  document.querySelectorAll('input').forEach(function(el){
    el.addEventListener('input', function(){ if (el.id==='foodPercent'){ syncPercents(); } update(); });
  });

// try to fetch base rates from backend (token optional)
  fetchBaseRates();
  renderFixedCosts();
  syncPercents();
  update();

  // Start session tracking for guests
  if (!operatorMode && accessToken) {
    sessionStartTime = new Date();
    
    // Track when they leave the page
    window.addEventListener('beforeunload', sendSessionData);
    
    // Also send data every 60 seconds in case they close abruptly
    setInterval(function() {
      sendSessionData();
    }, 60000);
  }
}


function sendSessionData() {
  if (operatorMode || !accessToken || !sessionStartTime) return;
  
  try {
    var inputs = readInputs();
    var pf = calcPerFridge(inputs);
    var monthlyNet = pf.netSheet * inputs.fridgeCount;
    var annual = (monthlyNet * 12) + (pf.serviceRevenue * inputs.fridgeCount * 12);
    
    var duration = Math.round((new Date() - sessionStartTime) / 1000);
    
    var params = new URLSearchParams();
    params.append('action', 'trackSession');
    params.append('token', accessToken);
    params.append('fridgeCount', inputs.fridgeCount);
    params.append('transactions', inputs.transactions);
    params.append('margin', inputs.margin);
    params.append('monthlyProfit', monthlyNet.toFixed(2));
    params.append('annualProfit', annual.toFixed(2));
    params.append('sessionDuration', duration);
    params.append('downloadedPDF', downloadedPDF ? 'true' : 'false');
    
    // Use sendBeacon for reliability on page unload
    if (navigator.sendBeacon) {
      navigator.sendBeacon(BACKEND_URL + '?' + params.toString());
    } else {
      fetch(BACKEND_URL + '?' + params.toString());
    }
  } catch (e) {
    // Silent fail
  }
}


function fetchBaseRates(){
  try{
    if (accessToken){
      fetch(BACKEND_URL + '?action=validateAccess&token=' + encodeURIComponent(accessToken))
      .then(function(res){ return res.json(); })
      .then(function(ok){ if (ok.status!=='success') throw new Error('Invalid token'); });
    }
    var url = BACKEND_URL + '?action=getBaseRates' + (accessToken ? '&token=' + encodeURIComponent(accessToken) : '');
    fetch(url)
    .then(function(res){ return res.json(); })
    .then(function(j){
      if (j.status==='success' && j.data && j.data.baseRates) baseRates = j.data.baseRates;
      renderFixedCosts();
    });
  }catch(_){}
}

function syncPercents(){
  var f = Number(document.getElementById('foodPercent').value||0);
  document.getElementById('beveragePercent').value = Math.max(0,Math.min(100,100 - f));
}

function renderFixedCosts(){
  var r = baseRates.fixedCosts;
  document.getElementById('fixedCostsSummary').innerHTML = 
    '‚Ä¢ Cellular: $' + fmt2(r.cellular) + ' /month<br>' +
    '‚Ä¢ License Fee: $' + fmt2(r.licenseFee) + ' /month<br>' +
    '‚Ä¢ Engage <b>Transactions</b> Fees <i>($' + fmt2(r.engageTransactionFee) + '/tx)</i><br>' +
    '‚Ä¢ Gateway <b>Transactions</b> Fees <i>($' + fmt2(r.gatewayTransactionFee) + '/tx)</i><br>' +
    '‚Ä¢ Merchant Interchange: ' + Number(r.merchantAccountPercent).toFixed(2) + '% of sales revenue<br>' +
    '‚Ä¢ Merchant Swipe Fee: $' + fmt2(r.merchantAccountSwipeFee) + ' per tx<br>' +
    '‚Ä¢ RFID Tags: $' + fmt2(r.rfidTagsPerTag) + ' per tag';
}

/* ===========================
   Calculations
=========================== */
function readInputs(){
  var g = function(id){ return Number(document.getElementById(id).value||0); };
  return {
    fridgeCount: Math.max(1, Math.floor(g('fridgeCount'))),
    transactions: g('transactions'),
    foodPrice: g('foodPrice'),
    foodPercent: g('foodPercent'),
    beveragePrice: g('beveragePrice'),
    beveragePercent: g('beveragePercent'),
    margin: g('margin'),
    spoilage: g('spoilage'),
    financing: g('financing'),
    laborRate: g('laborRate'),
    laborHours: g('laborHours'),
    miscCosts: g('miscCosts'),
    serviceFee: g('serviceFee')
  };
}

function calcPerFridge(inputs){
  var r = baseRates.fixedCosts;

  var avgTicket = (inputs.foodPrice * inputs.foodPercent/100) + (inputs.beveragePrice * inputs.beveragePercent/100);
  var salesRevenue = inputs.transactions * avgTicket;

  var serviceRevenue = inputs.serviceFee;

  var cogs = salesRevenue * (1 - inputs.margin/100);
  var spoilageCost = cogs * (inputs.spoilage/100);

  var rfid   = inputs.transactions * r.rfidTagsPerTag;
  var engage = inputs.transactions * r.engageTransactionFee;
  var gateway= inputs.transactions * r.gatewayTransactionFee;
  var merchantPct = salesRevenue * (r.merchantAccountPercent/100);
  var swipe  = inputs.transactions * r.merchantAccountSwipeFee;

  var cellular = r.cellular;
  var license  = r.licenseFee;
  var labor    = inputs.laborRate * inputs.laborHours * 4;
  var misc     = inputs.miscCosts;
  var financing= inputs.financing;

  var costsNoFinance =
      cogs + spoilageCost + cellular + license + rfid + engage + gateway + merchantPct + swipe + labor + misc;

  var totalCosts = costsNoFinance + financing;

  var totalCostsBlock =
      (IN_NET_INCLUDE_CELLULAR ? cellular : 0) +
      (IN_NET_INCLUDE_LICENSE  ? license  : 0) +
      (IN_NET_INCLUDE_RFID     ? rfid     : 0) +
      (IN_NET_INCLUDE_ENGAGE   ? engage   : 0) +
      (IN_NET_INCLUDE_GATEWAY  ? gateway  : 0) +
      (IN_NET_INCLUDE_MERCHANT ? merchantPct : 0) +
      (IN_NET_INCLUDE_SWIPE    ? swipe    : 0) +
      (IN_NET_INCLUDE_LABOR    ? labor    : 0) +
      (IN_NET_INCLUDE_MISC     ? misc     : 0);

  var netSheet =
      (salesRevenue + serviceRevenue) -
      (cogs + spoilageCost + totalCostsBlock + (IN_NET_INCLUDE_FINANCING ? financing : 0));

  return {
    salesRevenue: salesRevenue, serviceRevenue: serviceRevenue,
    cogs: cogs, spoilageCost: spoilageCost, cellular: cellular, license: license, rfid: rfid, engage: engage, gateway: gateway, merchantPct: merchantPct, swipe: swipe, labor: labor, misc: misc, financing: financing,
    totalCosts: totalCosts,
    netSheet: netSheet
  };
}

/* ===========================
   UI Update
=========================== */
function update(){
  var i = readInputs();
  var pf = calcPerFridge(i);

  var salesRevenue = pf.salesRevenue * i.fridgeCount;
  var serviceRev   = pf.serviceRevenue * i.fridgeCount;
  var totalRevenue = salesRevenue + serviceRev;
  var monthlyCosts = pf.totalCosts     * i.fridgeCount;
  var monthlyNet   = pf.netSheet       * i.fridgeCount;

  var annual       = (monthlyNet * 12) + (pf.serviceRevenue * i.fridgeCount * 12);

  setText('kpiSalesRevenue',  usd2(salesRevenue));
  setText('kpiServiceRevenue',usd2(serviceRev));
  setText('kpiCosts',         usd2(monthlyCosts));
  setText('kpiTotalRevenue',  usd2(totalRevenue));

  var netEl = document.getElementById('kpiNet');
  netEl.textContent = usd2(monthlyNet);
  netEl.className = 'v ' + (monthlyNet>=0 ? 'positive':'negative');

  var annEl = document.getElementById('kpiAnnual');
  annEl.textContent = usd2(annual);
  annEl.className = 'v ' + (annual>=0 ? 'positive':'negative');

  renderBreakdown(pf, i);
}

/* ===========================
   Breakdown table
=========================== */
function renderBreakdown(pf, inputs){
  var tb = document.getElementById('breakdownBody');
  tb.innerHTML = '';

  var addSec = function(t){
    var tr = document.createElement('tr');
    tr.className = 'b-section';
    tr.innerHTML = '<td colspan="3">' + t + '</td>';
    tb.appendChild(tr);
  };
  var addRow = function(label, per, all, cls){
    var tr = document.createElement('tr'); 
    if (cls) tr.classList.add(cls);
    tr.innerHTML = '<td>' + label + '</td><td>' + usd2(per) + '</td><td>' + usd2(all) + '</td>';
    tb.appendChild(tr);
  };

  var fc = inputs.fridgeCount;

  addSec('Costs');
  addRow('COGS',                               pf.cogs,           pf.cogs*fc);
  addRow('Spoilage (at cost)',                 pf.spoilageCost,   pf.spoilageCost*fc);
  addRow('Cellular',                           pf.cellular,       pf.cellular*fc);
  addRow('License Fee',                        pf.license,        pf.license*fc);
  addRow('Engage <b>Transactions</b> Fees ($0.15/tx)',   pf.engage,         pf.engage*fc);
  addRow('Gateway <b>Transactions</b> Fees ($0.13/tx)',  pf.gateway,        pf.gateway*fc);
  addRow('Merchant % Fee (2.50% of sales)',    pf.merchantPct,    pf.merchantPct*fc);
  addRow('Merchant Swipe Fee ($0.03/tx)',      pf.swipe,          pf.swipe*fc);
  addRow('RFID Tags ($0.18/tx)',               pf.rfid,           pf.rfid*fc);
  
  var laborCalc = 'Labor ($' + inputs.laborRate + '/hr √ó ' + inputs.laborHours + ' hrs/week √ó 4 weeks)';
  addRow(laborCalc,                            pf.labor,          pf.labor*fc);
  
  addRow('Miscellaneous',                      pf.misc,           pf.misc*fc);
  addRow('Financing',                          pf.financing,      pf.financing*fc);
  addRow('Total Costs (incl. financing)',      pf.totalCosts,     pf.totalCosts*fc, 'b-total');

  addSec('Revenue (for reference)');
  var foodRev = inputs.transactions * (inputs.foodPercent/100)     * inputs.foodPrice;
  var bevRev  = inputs.transactions * (inputs.beveragePercent/100) * inputs.beveragePrice;
  addRow('Food Revenue',          foodRev,         foodRev*fc);
  addRow('Beverage Revenue',      bevRev,          bevRev*fc);
  addRow('Service Fee Revenue',   pf.serviceRevenue, pf.serviceRevenue*fc);
}

/* ===========================
   Share / Manage (Operator)
=========================== */
function openShare(){
  if (!operatorMode) return;
  document.getElementById('shareOverlay').style.display='flex';

  var name = localStorage.getItem('dashboardUser')||sessionStorage.getItem('dashboardUser')||'';
  var nameBox = document.getElementById('clientName');
  if (!nameBox.value && name) nameBox.value = name;

  var gen = document.getElementById('btnGenShare');
  if (gen){
    gen.disabled = false;
    gen.innerHTML = 'Generate';
  }
}
function closeShare(){ document.getElementById('shareOverlay').style.display='none'; }

function createShare(){
  if (!operatorMode) return;

  var btn       = document.getElementById('btnGenShare');
  var urlBox    = document.getElementById('shareUrlBox');
  var createdBy = (localStorage.getItem('dashboardUser')||sessionStorage.getItem('dashboardUser')||'Operator');
  var clientName = (document.getElementById('clientName').value || '').trim();

  // Require client name
  if (!clientName) {
    document.getElementById('clientName').style.borderColor = '#dc2626';
    document.getElementById('clientName').focus();
    toast('Please enter a client/prospect name for tracking', 'warn');
    return;
  }
  document.getElementById('clientName').style.borderColor = '#d1d5db';

  btn.disabled = true;
  btn.innerHTML = '<span class="spin"></span>Generating‚Ä¶';
  urlBox.value = '';

  var u = BACKEND_URL + '?action=generateToken&createdBy=' + encodeURIComponent(createdBy) + '&clientName=' + encodeURIComponent(clientName);
  fetch(u)
  .then(function(r){ return r.json(); })
  .then(function(j){
    if (j.status === 'success'){
      var link = j.data.shareUrl;
      urlBox.value = link;

      var copied = false;
      if (navigator.clipboard) {
        navigator.clipboard.writeText(link).then(function(){ copied = true; }).catch(function(){});
      }
      if (!copied) {
        urlBox.select(); urlBox.setSelectionRange(0,99999);
        try { document.execCommand('copy'); copied = true; } catch (_){}
      }

      if (copied) {
        closeShare();
        toast('Guest link copied. It\'s valid for 7 days ‚Äî share it with your client.');
      } else {
        urlBox.focus();
        toast('Couldn\'t auto-copy. Press Ctrl+C (Cmd+C on Mac) to copy the link.', 'warn');
      }

      btn.disabled = false;
      btn.innerHTML = 'Regenerate & Copy';
    }else{
      btn.disabled = false;
      btn.innerHTML = 'Generate';
      alert(j.message || 'Unable to generate link');
    }
  })
  .catch(function(err){
    btn.disabled = false;
    btn.innerHTML = 'Generate';
    alert('Network error. Please try again.');
  });
}

function openManage(){
  if (!operatorMode) return;
  document.getElementById('manageOverlay').style.display='flex';
  loadTokens();
}
function closeManage(){ document.getElementById('manageOverlay').style.display='none'; }

function loadTokens(){
  var listBox = document.getElementById('tokenList');
  listBox.textContent = 'Loading‚Ä¶';
  var createdBy = (document.getElementById('filterCreatedBy').value||'').trim();
  var url = BACKEND_URL + '?action=listTokens&onlyActive=false&maxRows=50' + (createdBy ? '&createdBy=' + encodeURIComponent(createdBy) : '');
  fetch(url)
  .then(function(r){ return r.json(); })
  .then(function(j){
    if (j.status!=='success') throw new Error(j.message||'Failed to load tokens');
    var items = j.data.tokens||[];
    if (!items.length){ listBox.innerHTML = '<div class="subtle">No tokens found.</div>'; return; }
    listBox.innerHTML = items.map(function(t){
      var active = t.active ? '<span class="tableBadge">active</span>' : '<span class="tableBadge" style="background:#fee2e2;color:#b91c1c">revoked</span>';
      return '<div style="border:1px solid var(--line);border-radius:10px;padding:10px 12px;margin:8px 0;background:#f8fafc">' +
        '<div style="display:flex;justify-content:space-between;gap:10px;align-items:center">' +
          '<div>' +
            '<div style="font-weight:700">' + (t.clientName || '(no client name)') + ' ' + active + '</div>' +
            '<div class="subtle">Created: ' + (t.createdDate ? new Date(t.createdDate).toLocaleDateString() : '‚Äî') + ' ‚Ä¢ Expires: ' + (t.expiresAt? new Date(t.expiresAt).toLocaleDateString():'‚Äî') + ' ‚Ä¢ Accesses: ' + (t.accessCount||0) + '</div>' +
            '<div class="subtle" style="word-break:break-all">' + t.shareUrl + '</div>' +
          '</div>' +
          '<div>' +
            '<button class="btn secondary" onclick="copyText(\'' + t.shareUrl.replace(/'/g,"\\'") + '\')">Copy Link</button>' +
            (t.active ? '<button class="btn" style="background:#b91c1c" onclick="revokeToken(\'' + t.token + '\')">Revoke</button>' : '') +
          '</div>' +
        '</div>' +
      '</div>';
    }).join('');
  })
  .catch(function(err){
    listBox.innerHTML = '<div class="subtle" style="color:#b91c1c">Error: ' + err.message + '</div>';
  });
}

function revokeToken(token){
  if (!confirm('Revoke this link?')) return;
  fetch(BACKEND_URL + '?action=deactivateToken&token=' + encodeURIComponent(token))
  .then(function(r){ return r.json(); })
  .then(function(j){
    if (j.status==='success'){ loadTokens(); } else { alert(j.message||'Failed to revoke'); }
  });
}

function copyText(t){ 
  if (navigator.clipboard) {
    navigator.clipboard.writeText(t).then(function(){ toast('Copied!'); });
  }
}

/* ===========================
   Helpers (with comma formatting)
=========================== */
function setText(id, txt){ var el=document.getElementById(id); if(el) el.textContent=txt; }
function usd2(n){ return '$' + fmt2(n); }
function fmt2(n){
  var num = Number(n||0);
  return num.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
}

function toast(message, kind){
  var d = document.createElement('div');
  d.className = 'toast';
  d.textContent = message;
  if (kind==='warn'){ d.style.background = '#f59e0b'; }
  if (kind==='error'){ d.style.background = '#dc2626'; }
  document.body.appendChild(d);
  setTimeout(function(){ d.style.opacity='0'; d.style.transition='opacity .25s'; setTimeout(function(){d.remove();}, 250); }, 2600);
}
</script>
</body>
</html>
