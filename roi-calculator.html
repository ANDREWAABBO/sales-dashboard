<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Smart Food Fridge ROI Calculator - Quantum Solutions</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{
    font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;
    background:linear-gradient(135deg,#1e3a8a 0%,#3b82f6 100%);
    min-height:100vh;padding:20px;color:#333
  }
  .calculator-container{
    max-width:1200px;margin:0 auto;background:rgba(255,255,255,.98);
    border-radius:20px;padding:40px;box-shadow:0 20px 60px rgba(0,0,0,.3);
    animation:fadeIn .8s ease-out
  }
  @keyframes fadeIn{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
  .header{display:flex;align-items:flex-start;gap:20px;justify-content:space-between;margin-bottom:30px;border-bottom:3px solid #1e3a8a;padding-bottom:20px}
  .header-left{text-align:left}
  .header h1{font-size:2.2em;color:#1e3a8a;margin-bottom:6px;font-weight:700}
  .header p{font-size:1.05em;color:#64748b}
  .header-actions{
    display:flex;gap:10px;align-items:center;flex-wrap:wrap
  }
  .header-actions .btn-ghost{
    background:#f8fafc;border:2px solid #e2e8f0;color:#1e3a8a;font-weight:600;
    padding:10px 14px;border-radius:10px;cursor:pointer
  }
  .header-actions .btn-ghost:hover{border-color:#1e3a8a}
  .disclaimer{
    background:#fef3c7;border:2px solid #f59e0b;padding:12px 15px;border-radius:10px;
    margin-bottom:20px;text-align:center;color:#92400e;font-weight:600
  }
  .calculator-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px}
  .input-section{
    background:#f8fafc;padding:20px;border-radius:15px;border:2px solid #e2e8f0;transition:.3s
  }
  .input-section:hover{border-color:#1e3a8a;box-shadow:0 5px 15px rgba(30,58,138,.1)}
  .section-title{font-size:1.2em;font-weight:700;color:#1e3a8a;margin-bottom:16px}
  .form-group{margin-bottom:16px}
  .form-group label{display:block;margin-bottom:6px;color:#374151;font-weight:600;font-size:.95em}
  .form-group input,.form-group select{width:100%;padding:11px 12px;border:2px solid #d1d5db;border-radius:8px;font-size:1em;background:white;transition:.2s}
  .form-group input:focus,.form-group select:focus{outline:none;border-color:#1e3a8a;box-shadow:0 0 0 3px rgba(30,58,138,.1)}
  .form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .results-section{
    grid-column:1 / -1;background:linear-gradient(135deg,#dbeafe 0%,#bfdbfe 100%);
    padding:22px;border-radius:15px;border:3px solid #1e3a8a;margin-top:10px
  }
  .results-title{font-size:1.5em;font-weight:700;color:#1e3a8a;margin-bottom:18px;text-align:center}
  .results-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;margin-bottom:16px}
  .result-card{background:white;padding:16px;border-radius:12px;text-align:center;border:2px solid #e5e7eb;transition:.2s}
  .result-card:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,.08)}
  .result-label{font-size:.9em;color:#6b7280;margin-bottom:6px;font-weight:600}
  .result-value{font-size:1.35em;font-weight:800;color:#1e3a8a;word-break:break-word}
  .result-value.positive{color:#059669}
  .result-value.negative{color:#dc2626}

  .breakdown{
    grid-column:1 / -1;display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:6px
  }
  .card{
    background:white;border:2px solid #e5e7eb;border-radius:12px;padding:16px
  }
  .card h4{font-size:1.1em;color:#1e3a8a;margin-bottom:10px}
  .row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed #e5e7eb}
  .row:last-child{border-bottom:none}
  .row .lbl{color:#475569}
  .row .val{font-weight:700;color:#111827}
  .subtle{color:#64748b;font-size:.92em;margin-top:6px}

  .timeline-section{background:white;padding:16px;border-radius:12px;border:2px solid #e5e7eb;margin-top:14px}
  .timeline-title{font-size:1.2em;font-weight:700;color:#1e3a8a;margin-bottom:10px;text-align:center}
  .timeline-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px}
  .timeline-item{background:#f8fafc;padding:12px;border-radius:8px;text-align:center;border:1px solid #e5e7eb}
  .timeline-period{font-size:.9em;color:#6b7280;margin-bottom:4px;font-weight:600}
  .timeline-profit{font-size:1.15em;font-weight:800;color:#059669}

  .download-section{text-align:center;margin-top:18px;padding:18px;background:#f1f5f9;border-radius:12px}
  .btn{
    display:inline-block;padding:12px 18px;background:#1e3a8a;color:white;text-decoration:none;border-radius:8px;
    font-weight:700;font-size:1em;border:none;cursor:pointer;transition:.2s;margin:0 8px
  }
  .btn:hover{background:#1e40af;transform:translateY(-1px);box-shadow:0 8px 18px rgba(30,58,138,.25)}
  .btn-secondary{background:#059669}.btn-secondary:hover{background:#047857}

  .expired-overlay{
    position:fixed;inset:0;background:rgba(0,0,0,.8);display:flex;justify-content:center;align-items:center;z-index:10000
  }
  .expired-modal{background:white;padding:28px;border-radius:16px;text-align:center;max-width:520px;margin:20px;box-shadow:0 20px 60px rgba(0,0,0,.3)}
  .expired-modal h2{color:#dc2626;margin-bottom:10px;font-size:1.6em}
  .expired-modal p{color:#6b7280;margin-bottom:16px;font-size:1.02em;line-height:1.5}

  .loading-overlay{
    position:fixed;inset:0;background:rgba(30,58,138,.9);display:flex;justify-content:center;align-items:center;z-index:10000
  }
  .loading-content{background:white;padding:28px;border-radius:16px;text-align:center;max-width:420px;margin:20px;box-shadow:0 20px 60px rgba(0,0,0,.3)}
  .spinner{display:inline-block;width:36px;height:36px;border:4px solid #f3f4f6;border-top:4px solid #1e3a8a;border-radius:50%;animation:spin 1s linear infinite;margin-bottom:14px}
  @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
  .share-note{font-size:.9em;color:#334155}

  @media (max-width: 900px){
    .calculator-grid{grid-template-columns:1fr}
    .breakdown{grid-template-columns:1fr}
    .header{flex-direction:column;gap:10px}
    .header-actions{align-self:flex-start}
  }
</style>
</head>
<body>
  <!-- Loading Screen -->
  <div id="loadingOverlay" class="loading-overlay" style="display:flex;">
    <div class="loading-content">
      <div class="spinner"></div>
      <h3 style="color:#1e3a8a;margin-bottom:6px;">Loading ROI Calculator…</h3>
      <p style="color:#6b7280">Validating access and retrieving latest data</p>
    </div>
  </div>

  <div id="calculatorContent" class="calculator-container" style="display:none;">
    <div class="header">
      <div class="header-left">
        <h1>Smart Food Fridge ROI Calculator</h1>
        <p>Quantum Solutions — Advanced Food Service Technology</p>
      </div>

      <!-- Share controls (only in Operator Mode) -->
      <div id="shareControls" class="header-actions" style="display:none;">
        <button id="btnShare" class="btn-ghost">Share / Get Link</button>
        <button id="btnManage" class="btn-ghost">Manage Links</button>
        <div class="share-note">Operator Mode</div>
      </div>
    </div>

    <div class="disclaimer">
      These are estimated calculations. True profit is determined by your actual business model and operational factors.
    </div>

    <div class="calculator-grid">
      <!-- Business Assumptions -->
      <div class="input-section">
        <div class="section-title">Business Assumptions</div>

        <div class="form-group">
          <label for="fridgeCount">Number of Fridges</label>
          <input type="number" id="fridgeCount" value="1" min="1" max="50" onchange="updateCalculations()"/>
        </div>

        <div class="form-group">
          <label for="transactions">Monthly Transactions (per fridge)</label>
          <input type="number" id="transactions" value="330" min="50" max="5000" step="1" onchange="updateCalculations()"/>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="foodPrice">Food Price per Sale</label>
            <input type="number" id="foodPrice" value="10.00" step="0.01" min="1" max="100" onchange="updateCalculations()"/>
          </div>
          <div class="form-group">
            <label for="foodPercent">Food Sales %</label>
            <input type="number" id="foodPercent" value="90" min="0" max="100" step="1" onchange="updatePercentages();updateCalculations()"/>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="beveragePrice">Beverage Price per Sale</label>
            <input type="number" id="beveragePrice" value="3.99" step="0.01" min="0" max="50" onchange="updateCalculations()"/>
          </div>
          <div class="form-group">
            <label for="beveragePercent">Beverage Sales %</label>
            <input type="number" id="beveragePercent" value="10" min="0" max="100" step="1" onchange="updatePercentages();updateCalculations()"/>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="margin">Your Profit Margin %</label>
            <input type="number" id="margin" value="60" min="10" max="95" step="0.5" onchange="updateCalculations()"/>
          </div>
          <div class="form-group">
            <label for="spoilage">Spoilage % (at cost)</label>
            <input type="number" id="spoilage" value="0" min="0" max="50" step="0.25" onchange="updateCalculations()"/>
          </div>
        </div>

        <div class="form-group">
          <label for="serviceFee">Monthly Service Fee Charged to Client (per fridge)</label>
          <input type="number" id="serviceFee" value="395" min="0" step="0.01" onchange="updateCalculations()"/>
        </div>
      </div>

      <!-- Operational Costs -->
      <div class="input-section">
        <div class="section-title">Operational Costs</div>

        <div class="form-group">
          <label for="financing">Monthly Financing Payment (per fridge)</label>
          <input type="number" id="financing" value="295" min="0" max="5000" step="0.01" onchange="updateCalculations()"/>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="laborRate">Labor Rate ($/hour)</label>
            <input type="number" id="laborRate" value="20" min="0" max="200" step="0.01" onchange="updateCalculations()"/>
          </div>
          <div class="form-group">
            <label for="laborHours">Hours per Week (per fridge)</label>
            <input type="number" id="laborHours" value="0.75" min="0" max="40" step="0.25" onchange="updateCalculations()"/>
          </div>
        </div>

        <div class="form-group">
          <label for="miscCosts">Miscellaneous Monthly Costs (per fridge)</label>
          <input type="number" id="miscCosts" value="0" min="0" max="5000" step="0.01" onchange="updateCalculations()"/>
        </div>

        <div style="background:#e0f2fe;padding:12px;border-radius:8px;margin-top:10px;">
          <h4 style="color:#0369a1;margin-bottom:6px;">Fixed Costs (per fridge):</h4>
          <div style="font-size:.95em;color:#0369a1;" id="fixedCostsSummary">Loading…</div>
        </div>
      </div>

      <!-- Results -->
      <div class="results-section">
        <div class="results-title">Financial Performance</div>

        <div class="results-grid">
          <div class="result-card">
            <div class="result-label">Monthly Sales Revenue</div>
            <div class="result-value" id="monthlySales">$0.00</div>
          </div>
          <div class="result-card">
            <div class="result-label">Monthly Service Fee Revenue</div>
            <div class="result-value" id="monthlyService">$0.00</div>
          </div>
          <div class="result-card">
            <div class="result-label">Total Revenue (Sales + Service Fee)</div>
            <div class="result-value" id="totalRevenue">$0.00</div>
          </div>
          <div class="result-card">
            <div class="result-label">Monthly Costs (incl. Financing)</div>
            <div class="result-value" id="monthlyCosts">$0.00</div>
          </div>
          <div class="result-card">
            <div class="result-label">Monthly Net Profit</div>
            <div class="result-value" id="monthlyProfit">$0.00</div>
          </div>
          <div class="result-card">
            <div class="result-label">Annual Net Profit</div>
            <div class="result-value" id="annualProfit">$0.00</div>
          </div>
          <div class="result-card">
            <div class="result-label">ROI %</div>
            <div class="result-value" id="roiPercent">0%</div>
          </div>
          <div class="result-card">
            <div class="result-label">Payback Period</div>
            <div class="result-value" id="paybackPeriod">0 months</div>
          </div>
        </div>

        <!-- Revenue & Cost breakdown -->
        <div class="breakdown">
          <div class="card">
            <h4>Revenue Breakdown</h4>
            <div class="row"><div class="lbl">Food Sales Revenue</div><div class="val" id="revFood">$0.00</div></div>
            <div class="row"><div class="lbl">Beverage Sales Revenue</div><div class="val" id="revBeverage">$0.00</div></div>
            <div class="row"><div class="lbl">Service Fee Revenue</div><div class="val" id="revService">$0.00</div></div>
          </div>

          <div class="card">
            <h4>Cost Breakdown</h4>
            <div class="row"><div class="lbl">COGS</div><div class="val" id="cogs">$0.00</div></div>
            <div class="row"><div class="lbl">Spoilage (at cost)</div><div class="val" id="spoilageCost">$0.00</div></div>
            <div class="row"><div class="lbl">Cellular</div><div class="val" id="cellular">$0.00</div></div>
            <div class="row"><div class="lbl">License Fee</div><div class="val" id="licenseFee">$0.00</div></div>
            <div class="row"><div class="lbl">Engage Transactions Fees ($0.15/txn)</div><div class="val" id="engageFees">$0.00</div></div>
            <div class="row"><div class="lbl">Gateway Transactions Fees ($0.065/txn)</div><div class="val" id="gatewayFees">$0.00</div></div>
            <div class="row"><div class="lbl">Merchant % Fee (2.50%)</div><div class="val" id="merchantPct">$0.00</div></div>
            <div class="row"><div class="lbl">Merchant Swipe Fee ($0.03/txn)</div><div class="val" id="merchantSwipe">$0.00</div></div>
            <div class="row"><div class="lbl">RFID Tags ($0.18/tag)</div><div class="val" id="rfid">$0.00</div></div>
            <div class="row"><div class="lbl">Labor</div><div class="val" id="labor">$0.00</div></div>
            <div class="row"><div class="lbl">Miscellaneous</div><div class="val" id="misc">$0.00</div></div>
            <div class="row"><div class="lbl">Financing</div><div class="val" id="financingCost">$0.00</div></div>
            <div class="subtle">All costs shown for the selected fridge count.</div>
          </div>
        </div>

        <!-- Projections -->
        <div class="timeline-section">
          <div class="timeline-title">Multi-Year Projection (constant assumptions)</div>
          <div class="timeline-grid" id="timelineGrid"></div>
        </div>
      </div>
    </div>

    <div class="download-section">
      <h3 style="margin-bottom:10px;color:#374151;">Export Your Analysis</h3>
      <button class="btn" onclick="generatePDFReport()">Download PDF Report</button>
      <button class="btn btn-secondary" onclick="shareResults()">Share Results</button>
    </div>
  </div>

  <script>
    // --- Backend URL (Apps Script Web App)
    const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbyliQpOEuz0QMKWMtHW7Cjlhqf2qEmLNTXI4TDY8THVPbKXzyqkIJ5dbIsHtb8JegHc_Q/exec';

    // --- State
    let baseRates = null;
    let accessToken = null;
    let accessValidated = false;
    let operatorMode = false;

    // Initialize
    window.addEventListener('DOMContentLoaded', async () => {
      await initializeCalculator();
    });

    async function initializeCalculator(){
      const urlParams = new URLSearchParams(window.location.search);
      accessToken = urlParams.get('token') || null;

      // Operator Mode if coming from dashboard (name mirrored into localStorage)
      const dashUser = localStorage.getItem('dashboardUser');
      operatorMode = !!dashUser || urlParams.get('op') === '1';

      // Show operator share controls if operator
      const shareCtrls = document.getElementById('shareControls');
      if (operatorMode && shareCtrls){
        shareCtrls.style.display = 'flex';
        document.getElementById('btnShare').onclick = openShareModal;
        document.getElementById('btnManage').onclick = openManageModal;
      }

      try{
        if (accessToken){
          const valid = await validateAccessJSONP(accessToken);
          if (!valid.valid){
            showExpiredModal(valid.message || (valid.expired ? 'Your access has expired.' : 'Invalid access token.'));
            return;
          }
          accessValidated = true;
        } else if (!operatorMode){
          // Guest without token
          showExpiredModal('Your access to this ROI Calculator has expired. Please contact your Quantum Solutions representative to request renewed access.');
          return;
        }

        // Base rates (from backend for guests with token, else local defaults)
        if (accessValidated){
          baseRates = await getBaseRatesJSONP(accessToken);
        }
        if (!baseRates){
          baseRates = getDefaultRates();
        }
        applyBaseRates();

        // Reveal UI
        document.getElementById('loadingOverlay').style.display = 'none';
        document.getElementById('calculatorContent').style.display = 'block';

        // Initial calc
        updateCalculations();
      }catch(e){
        console.error('Initialization error:', e);
        showExpiredModal('Unable to load calculator. Please try again or contact support.');
      }
    }

    // --- JSONP helpers
    function jsonp(url){
      return new Promise((resolve,reject)=>{
        const cbName = 'cb_' + Math.random().toString(36).slice(2);
        const s = document.createElement('script');
        const sep = url.includes('?') ? '&' : '?';
        s.src = `${url}${sep}callback=${cbName}`;
        const timeout = setTimeout(()=>{cleanup();reject(new Error('Request timeout'));}, 15000);

        window[cbName] = (data)=>{
          cleanup();
          resolve(data);
        };
        s.onerror = ()=>{cleanup();reject(new Error('Network error'));};

        document.body.appendChild(s);

        function cleanup(){
          clearTimeout(timeout);
          delete window[cbName];
          if (s && s.parentNode) s.parentNode.removeChild(s);
        }
      });
    }

    async function validateAccessJSONP(token){
      const url = `${BACKEND_URL}?action=validateAccess&token=${encodeURIComponent(token)}`;
      const res = await jsonp(url);
      if (res.status === 'success') return {valid:true, ...res.data};
      return {valid:false, expired:res?.data?.expired || false, message:res.message || 'Access denied'};
    }

    async function getBaseRatesJSONP(token){
      const url = `${BACKEND_URL}?action=getBaseRates&token=${encodeURIComponent(token)}`;
      const res = await jsonp(url);
      if (res.status === 'success') return res.data.baseRates;
      return null;
    }

    async function generateTokenJSONP(createdBy, clientName){
      const url = `${BACKEND_URL}?action=generateToken&createdBy=${encodeURIComponent(createdBy)}&clientName=${encodeURIComponent(clientName||'')}`;
      const res = await jsonp(url);
      if (res.status === 'success') return res.data;
      throw new Error(res.message || 'Unable to generate token');
    }

    async function listTokensJSONP(createdBy, onlyActive=true, maxRows=10){
      const url = `${BACKEND_URL}?action=listTokens&createdBy=${encodeURIComponent(createdBy)}&onlyActive=${onlyActive?'true':'false'}&maxRows=${maxRows}`;
      const res = await jsonp(url);
      if (res.status === 'success') return res.data.tokens || [];
      throw new Error(res.message || 'Unable to list tokens');
    }

    async function deactivateTokenJSONP(token){
      const url = `${BACKEND_URL}?action=deactivateToken&token=${encodeURIComponent(token)}`;
      const res = await jsonp(url);
      if (res.status === 'success') return true;
      throw new Error(res.message || 'Unable to deactivate token');
    }

    // --- UI helpers
    function showExpiredModal(msg){
      const overlay = document.createElement('div');
      overlay.className = 'expired-overlay';
      overlay.innerHTML = `
        <div class="expired-modal">
          <h2>Access Expired</h2>
          <p>${msg}</p>
          <button class="btn" onclick="window.close()">Close</button>
        </div>`;
      document.body.appendChild(overlay);
    }

    function getDefaultRates(){
      return {
        fixedCosts:{
          cellular:25,
          licenseFee:175,
          rfidTagsPerTag:0.18,
          engageTransactionFee:0.15,
          gatewayTransactionFee:0.065, // 6.5¢
          merchantAccountPercent:2.5,
          merchantAccountSwipeFee:0.03
        },
        defaults:{
          transactions:330,
          foodPrice:10.00,
          foodPercent:90,
          beveragePrice:3.99,
          beveragePercent:10,
          margin:60,
          spoilage:0,
          financing:295,
          laborRate:20,
          laborHours:0.75,
          serviceFee:395
        }
      };
    }

    function applyBaseRates(){
      if (!baseRates) return;
      const d = baseRates.defaults || {};

      setVal('transactions', d.transactions ?? 330);
      setVal('foodPrice', d.foodPrice ?? 10.00);
      setVal('foodPercent', d.foodPercent ?? 90);
      setVal('beveragePrice', d.beveragePrice ?? 3.99);
      setVal('beveragePercent', d.beveragePercent ?? 10);
      setVal('margin', d.margin ?? 60);
      setVal('spoilage', d.spoilage ?? 0);
      setVal('financing', d.financing ?? 295);
      setVal('laborRate', d.laborRate ?? 20);
      setVal('laborHours', d.laborHours ?? 0.75);
      setVal('serviceFee', d.serviceFee ?? 395);

      const f = baseRates.fixedCosts || {};
      document.getElementById('fixedCostsSummary').innerHTML = `
        • Cellular: $${fmt2(f.cellular)}/month<br>
        • License Fee: $${fmt2(f.licenseFee)}/month<br>
        • Transaction Fees: Engage $${fmt2(f.engageTransactionFee)}/txn, Gateway $${fmt2(f.gatewayTransactionFee)}/txn<br>
        • Merchant Fees: ${fmt2(f.merchantAccountPercent)}% + $${fmt2(f.merchantAccountSwipeFee)}/txn<br>
        • RFID Tags: $${fmt2(f.rfidTagsPerTag)} per tag
      `;
    }

    function setVal(id,val){ const el=document.getElementById(id); if(el) el.value=val; }

    function updatePercentages(){
      const fp = num('foodPercent');
      const bp = Math.max(0, Math.min(100, 100 - fp));
      document.getElementById('beveragePercent').value = bp;
    }

    function updateCalculations(){
      const inputs = readInputs();
      const results = calculateROI(inputs);
      displayKPIs(results);
      displayBreakdown(results);
      renderTimeline(results);
      trackUsage('calculation_performed', inputs);
    }

    function readInputs(){
      return {
        fridgeCount: int('fridgeCount',1),
        transactions: int('transactions',330),
        foodPrice: num('foodPrice',10),
        foodPercent: num('foodPercent',90),
        beveragePrice: num('beveragePrice',3.99),
        beveragePercent: num('beveragePercent',10),
        margin: num('margin',60),
        spoilage: num('spoilage',0), // % at cost
        financing: num('financing',295),
        laborRate: num('laborRate',20),
        laborHours: num('laborHours',0.75),
        miscCosts: num('miscCosts',0),
        serviceFee: num('serviceFee',395)
      };
    }

    function int(id,def){ const v=parseInt(document.getElementById(id).value); return isNaN(v)?def:v; }
    function num(id,def){ const v=parseFloat(document.getElementById(id).value); return isNaN(v)?def:v; }

    function calculateROI(inputs){
      // per fridge math then multiply
      const per = calcPerFridge(inputs);

      const monthlySales = per.salesRevenue * inputs.fridgeCount;
      const monthlyService = inputs.serviceFee * inputs.fridgeCount;
      const totalRevenue = monthlySales + monthlyService;

      const monthlyCostsInclFin = (per.costsExFin + per.financing) * inputs.fridgeCount;
      const monthlyNet = (per.netMonthly) * inputs.fridgeCount; // already adds service fee after all costs

      return {
        per,
        monthlySales,
        monthlyService,
        totalRevenue,
        monthlyCostsInclFin,
        monthlyNet,
        annualNet: monthlyNet * 12,
        roiPct: per.roiPct,
        paybackMonths: per.paybackMonths
      };
    }

    function calcPerFridge(inputs){
      const r = (baseRates && baseRates.fixedCosts) ? baseRates.fixedCosts : getDefaultRates().fixedCosts;

      // Mix
      const foodRev = inputs.transactions * (inputs.foodPercent/100) * inputs.foodPrice;
      const bevRev  = inputs.transactions * (inputs.beveragePercent/100) * inputs.beveragePrice;
      const salesRevenue = foodRev + bevRev;

      // COGS from margin
      const cogs = salesRevenue * ((100 - inputs.margin)/100);

      // Spoilage at cost
      const spoilageAtCost = cogs * (inputs.spoilage/100);

      // Fees & fixed
      const rfid = inputs.transactions * r.rfidTagsPerTag;
      const engage = inputs.transactions * r.engageTransactionFee;
      const gateway = inputs.transactions * r.gatewayTransactionFee;
      const merchantPct = salesRevenue * (r.merchantAccountPercent/100);
      const merchantSwipe = inputs.transactions * r.merchantAccountSwipeFee;

      const cellular = r.cellular;
      const license  = r.licenseFee;

      const labor = inputs.laborRate * inputs.laborHours * 4.33;
      const misc  = inputs.miscCosts;

      const costsExFin =
        cogs + spoilageAtCost + cellular + license + engage + gateway +
        merchantPct + merchantSwipe + rfid + labor + misc;

      const financing = inputs.financing;

      // Net from sales only:
      const netBase = salesRevenue - (costsExFin + financing);

      // Add service fee AFTER all costs (sheet logic)
      const netMonthly = netBase + inputs.serviceFee;

      // ROI / Payback
      const initialInvestment = 7500; // per fridge
      const profitPreFin = (salesRevenue - costsExFin) + inputs.serviceFee; // add back financing for ROI
      const roiPct = profitPreFin <= 0 ? 0 : (profitPreFin * 12 / initialInvestment) * 100;
      const paybackMonths = profitPreFin > 0 ? (initialInvestment / profitPreFin) : Infinity;

      return {
        salesRevenue,
        foodRev, bevRev,
        cogs,
        spoilageAtCost,
        cellular, license, engage, gateway,
        merchantPct, merchantSwipe, rfid,
        labor, misc,
        financing,
        costsExFin,
        netMonthly,
        serviceFee: inputs.serviceFee,
        roiPct,
        paybackMonths
      };
    }

    function displayKPIs(res){
      setText('monthlySales', money(res.monthlySales));
      setText('monthlyService', money(res.monthlyService));
      setText('totalRevenue', money(res.totalRevenue));
      setText('monthlyCosts', money(res.monthlyCostsInclFin));
      const pe = document.getElementById('monthlyProfit');
      pe.textContent = money(res.monthlyNet);
      pe.className = 'result-value ' + (res.monthlyNet >= 0 ? 'positive' : 'negative');
      setText('annualProfit', money(res.annualNet));
      setText('roiPercent', (isFinite(res.roiPct) ? res.roiPct.toFixed(1) : '0.0') + '%');
      setText('paybackPeriod', (isFinite(res.paybackMonths)? Math.round(res.paybackMonths) : '∞') + ' months');
    }

    function displayBreakdown(res){
      const p = res.per;
      setText('revFood', money(p.foodRev * get('fridgeCount')));
      setText('revBeverage', money(p.bevRev * get('fridgeCount')));
      setText('revService', money(p.serviceFee * get('fridgeCount')));

      setText('cogs', money(p.cogs * get('fridgeCount')));
      setText('spoilageCost', money(p.spoilageAtCost * get('fridgeCount')));
      setText('cellular', money(p.cellular * get('fridgeCount')));
      setText('licenseFee', money(p.license * get('fridgeCount')));
      setText('engageFees', money(p.engage * get('fridgeCount')));
      setText('gatewayFees', money(p.gateway * get('fridgeCount')));
      setText('merchantPct', money(p.merchantPct * get('fridgeCount')));
      setText('merchantSwipe', money(p.merchantSwipe * get('fridgeCount')));
      setText('rfid', money(p.rfid * get('fridgeCount')));
      setText('labor', money(p.labor * get('fridgeCount')));
      setText('misc', money(p.misc * get('fridgeCount')));
      setText('financingCost', money(p.financing * get('fridgeCount')));
    }

    function renderTimeline(res){
      const g = document.getElementById('timelineGrid');
      g.innerHTML = '';
      const months = [12,24,36];
      months.forEach((m,i)=>{
        const div = document.createElement('div');
        div.className = 'timeline-item';
        div.innerHTML = `
          <div class="timeline-period">Year ${i+1}</div>
          <div class="timeline-profit">${money(res.monthlyNet * 12)}</div>
        `;
        g.appendChild(div);
      });
    }

    function setText(id,txt){ const el=document.getElementById(id); if(el) el.textContent=txt; }
    function get(id){ return parseFloat(document.getElementById(id).value) || 0; }

    // Formatting
    function money(n){
      return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',minimumFractionDigits:2,maximumFractionDigits:2}).format(n);
    }
    function fmt2(n){
      return (Math.round(n*100)/100).toFixed(2);
    }

    // Share UI
    function openShareModal(){
      const createdBy = localStorage.getItem('dashboardUser') || 'Operator';
      const clientName = prompt('Optional: label this link (client name):','');
      if (createdBy){
        generateTokenJSONP(createdBy, clientName)
          .then(data=>{
            const link = data.shareUrl || `${location.origin}${location.pathname}?token=${data.token}`;
            alert(`7-day link created:\n\n${link}\n\nCopy and share with your client.`);
          })
          .catch(err=>alert('Error creating link: ' + err.message));
      } else {
        alert('Operator name not found. Please re-open from dashboard.');
      }
    }

    function openManageModal(){
      const createdBy = localStorage.getItem('dashboardUser') || '';
      if (!createdBy){ alert('Operator name not found. Please re-open from dashboard.'); return; }

      listTokensJSONP(createdBy,true,10)
        .then(tokens=>{
          if (!tokens.length){ alert('No active links yet.'); return; }
          const lines = tokens.map(t=>`${t.clientName? t.clientName+' — ' : ''}${t.shareUrl}\nExpires: ${new Date(t.expiresAt).toLocaleString()}`);
          const choice = prompt(`Active links (most recent first):\n\n${lines.join('\n\n')}\n\nEnter token to revoke (leave blank to cancel):`, '');
          if (choice){
            deactivateTokenJSONP(choice.trim())
              .then(()=>alert('Link revoked.'))
              .catch(err=>alert('Error revoking: ' + err.message));
          }
        })
        .catch(err=>alert('Error loading links: ' + err.message));
    }

    // Tracking (fire-and-forget; only when token is present)
    function trackUsage(action, inputs=null){
      if (!accessToken) return; // only track guest sessions
      try{
        const params = new URLSearchParams({
          action:'trackUsage',
          token: accessToken,
          actionName: action,
          userAgent: navigator.userAgent
        });
        if (inputs) params.append('inputs', JSON.stringify(inputs));
        fetch(`${BACKEND_URL}?${params.toString()}`).catch(()=>{});
      }catch(_){}
    }

    // Placeholder export/share buttons at bottom
    function generatePDFReport(){ alert('PDF Report generation coming soon.'); }
    function shareResults(){ openShareModal(); }

    // Visual feedback for inputs
    document.addEventListener('input', (e)=>{
      if (e.target && (e.target.tagName==='INPUT' || e.target.tagName==='SELECT')){
        e.target.style.borderColor = '#1e3a8a';
        setTimeout(()=>{ e.target.style.borderColor = '#d1d5db'; }, 400);
      }
    });
  </script>
</body>
</html>
