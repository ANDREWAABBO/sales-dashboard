<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Smart Food Fridge ROI Calculator - Quantum Solutions</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;background:linear-gradient(135deg,#1e3a8a 0%,#3b82f6 100%);min-height:100vh;padding:20px;color:#333}

    .calculator-container{max-width:1200px;margin:0 auto;background:rgba(255,255,255,.98);border-radius:20px;padding:40px;box-shadow:0 20px 60px rgba(0,0,0,.3);animation:fadeIn .8s ease-out}
    @keyframes fadeIn{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}

    .header{text-align:center;margin-bottom:40px;border-bottom:3px solid #1e3a8a;padding-bottom:30px}
    .header h1{font-size:2.5em;color:#1e3a8a;margin-bottom:10px;font-weight:700}
    .header p{font-size:1.2em;color:#64748b;margin-bottom:5px}

    /* Operator bar */
    .operator-bar{display:none;background:rgba(30,58,138,.08);border:2px solid #1e3a8a;border-radius:12px;padding:14px 16px;margin:-6px auto 18px auto;max-width:1200px}
    .operator-bar .tag{font-weight:800;color:#1e3a8a;margin-right:12px}
    .operator-actions{display:flex;gap:10px;flex-wrap:wrap}

    .disclaimer{background:#fef3c7;border:2px solid #f59e0b;padding:15px;border-radius:10px;margin-bottom:30px;text-align:center;color:#92400e;font-weight:600}

    .calculator-grid{display:grid;grid-template-columns:1fr 1fr;gap:30px;margin-bottom:30px}
    .input-section{background:#f8fafc;padding:25px;border-radius:15px;border:2px solid #e2e8f0;transition:.3s}
    .input-section:hover{border-color:#1e3a8a;box-shadow:0 5px 15px rgba(30,58,138,.1)}
    .section-title{font-size:1.3em;font-weight:700;color:#1e3a8a;margin-bottom:20px;display:flex;align-items:center;gap:10px}
    .form-group{margin-bottom:20px}
    .form-group label{display:block;margin-bottom:8px;color:#374151;font-weight:600;font-size:.95em}
    .form-group input,.form-group select{width:100%;padding:12px 15px;border:2px solid #d1d5db;border-radius:8px;font-size:1em;transition:.2s;background:#fff}
    .form-group input:focus,.form-group select:focus{outline:none;border-color:#1e3a8a;box-shadow:0 0 0 3px rgba(30,58,138,.1)}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:15px}

    .results-section{grid-column:1/-1;background:linear-gradient(135deg,#dbeafe 0%,#bfdbfe 100%);padding:30px;border-radius:15px;border:3px solid #1e3a8a;margin-top:20px}
    .results-title{font-size:1.8em;font-weight:700;color:#1e3a8a;margin-bottom:25px;text-align:center}
    .results-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:30px}
    .result-card{background:#fff;padding:20px;border-radius:12px;text-align:center;border:2px solid #e5e7eb;transition:.2s}
    .result-card:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,.1)}
    .result-label{font-size:.9em;color:#6b7280;margin-bottom:8px;font-weight:600}
    .result-value{font-size:1.8em;font-weight:700;color:#1e3a8a}
    .result-value.positive{color:#059669}
    .result-value.negative{color:#dc2626}

    .timeline-section{background:#fff;padding:25px;border-radius:12px;border:2px solid #e5e7eb;margin-top:20px}
    .timeline-title{font-size:1.4em;font-weight:700;color:#1e3a8a;margin-bottom:20px;text-align:center}
    .timeline-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px}
    .timeline-item{background:#f8fafc;padding:15px;border-radius:8px;text-align:center;border:1px solid #e5e7eb}
    .timeline-period{font-size:.9em;color:#6b7280;margin-bottom:5px;font-weight:600}
    .timeline-profit{font-size:1.3em;font-weight:700;color:#059669}

    .download-section{text-align:center;margin-top:30px;padding:25px;background:#f1f5f9;border-radius:12px}

    .btn{display:inline-block;padding:12px 22px;background:#1e3a8a;color:#fff;text-decoration:none;border-radius:8px;font-weight:700;font-size:1em;border:none;cursor:pointer;transition:.2s}
    .btn:hover{background:#1e40af;transform:translateY(-2px);box-shadow:0 8px 20px rgba(30,58,138,.3)}
    .btn-secondary{background:#059669}
    .btn-secondary:hover{background:#047857}
    .btn-ghost{background:#fff;color:#1e3a8a;border:2px solid #1e3a8a}
    .btn-danger{background:#dc2626}
    .btn-danger:hover{background:#b91c1c}

    .scaling-section{grid-column:1/-1;background:#fef7ff;padding:25px;border-radius:15px;border:2px solid #a855f7;margin-top:20px}
    .scaling-title{font-size:1.4em;font-weight:700;color:#7c3aed;margin-bottom:20px;text-align:center}
    .scaling-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px}
    .scaling-item{background:#fff;padding:15px;border-radius:10px;text-align:center;border:2px solid #e5e7eb}
    .scaling-fridges{font-size:1.2em;font-weight:700;color:#7c3aed;margin-bottom:8px}
    .scaling-profit{font-size:1.1em;font-weight:600;color:#059669}

    .expired-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);display:flex;justify-content:center;align-items:center;z-index:10000}
    .expired-modal{background:#fff;padding:40px;border-radius:20px;text-align:center;max-width:500px;margin:20px;box-shadow:0 20px 60px rgba(0,0,0,.3)}
    .expired-modal h2{color:#dc2626;margin-bottom:20px;font-size:1.8em}
    .expired-modal p{color:#6b7280;margin-bottom:25px;font-size:1.1em;line-height:1.6}

    .loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(30,58,138,.9);display:flex;justify-content:center;align-items:center;z-index:10000}
    .loading-content{background:#fff;padding:40px;border-radius:20px;text-align:center;max-width:400px;margin:20px;box-shadow:0 20px 60px rgba(0,0,0,.3)}
    .spinner{display:inline-block;width:40px;height:40px;border:4px solid #f3f4f6;border-top:4px solid #1e3a8a;border-radius:50%;animation:spin 1s linear infinite;margin-bottom:20px}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

    /* Modals for sharing & manage links */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:10001}
    .modal{background:#fff;border-radius:16px;max-width:700px;width:95%;padding:24px;box-shadow:0 20px 50px rgba(0,0,0,.3)}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
    .modal h3{margin:0;font-size:1.3em;color:#1f2937}
    .modal .close{border:none;background:#e5e7eb;border-radius:8px;padding:8px 12px;cursor:pointer}
    .field-row{display:flex;gap:10px;margin:10px 0}
    .field-row input[type="text"]{flex:1;padding:12px;border:2px solid #e5e7eb;border-radius:10px}
    .token-list{display:grid;gap:10px;max-height:60vh;overflow:auto;margin-top:8px}
    .token-item{border:2px solid #e5e7eb;border-radius:12px;padding:12px;background:#f8fafc;display:flex;flex-wrap:wrap;gap:10px;justify-content:space-between;align-items:center}
    .token-meta{font-size:.9em;color:#475569}
    .muted{opacity:.7}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:.8em;font-weight:700}
    .badge-green{background:#dcfce7;color:#166534}
    .badge-gray{background:#e5e7eb;color:#374151}

    @media (max-width:768px){
      .calculator-grid{grid-template-columns:1fr}
      .form-row{grid-template-columns:1fr}
      .calculator-container{padding:20px}
      .header h1{font-size:2em}
    }
  </style>
</head>
<body>
  <!-- Operator bar (shown when no token in URL) -->
  <div id="operatorBar" class="operator-bar">
    <span class="tag">Operator Mode</span>
    <div class="operator-actions">
      <button class="btn btn-ghost" id="shareLinkBtn">Share / Get Link</button>
      <button class="btn btn-ghost" id="manageLinksBtn">Manage Links</button>
    </div>
  </div>

  <!-- Loading Screen -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-content">
      <div class="spinner"></div>
      <h3 style="color:#1e3a8a;margin-bottom:10px">Loading ROI Calculator...</h3>
      <p style="color:#6b7280">Validating access and retrieving latest data</p>
    </div>
  </div>

  <div id="calculatorContent" class="calculator-container" style="display:none">
    <div class="header">
      <h1>Smart Food Fridge ROI Calculator</h1>
      <p>Quantum Solutions - Advanced Food Service Technology</p>
      <p style="font-size:.9em;color:#6b7280">Calculate your return on investment with precision</p>
    </div>

    <div class="disclaimer">
      These are estimated calculations. True profit is determined by your actual business model and operational factors.
    </div>

    <div class="calculator-grid">
      <!-- Business Assumptions -->
      <div class="input-section">
        <div class="section-title">Business Assumptions</div>

        <div class="form-group">
          <label for="fridgeCount">Number of Fridges</label>
          <input type="number" id="fridgeCount" value="1" min="1" max="50" onchange="updateCalculations()"/>
        </div>

        <div class="form-group">
          <label for="transactions">Monthly Transactions (per fridge)</label>
          <input type="number" id="transactions" value="330" min="50" max="1000" onchange="updateCalculations()"/>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="foodPrice">Food Price per Sale</label>
            <input type="number" id="foodPrice" value="10.00" step="0.25" min="5" max="25" onchange="updateCalculations()"/>
          </div>
          <div class="form-group">
            <label for="foodPercent">Food Sales %</label>
            <input type="number" id="foodPercent" value="90" min="0" max="100" onchange="updatePercentages();updateCalculations()"/>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="beveragePrice">Beverage Price per Sale</label>
            <input type="number" id="beveragePrice" value="3.99" step="0.25" min="1" max="10" onchange="updateCalculations()"/>
          </div>
          <div class="form-group">
            <label for="beveragePercent">Beverage Sales %</label>
            <input type="number" id="beveragePercent" value="10" min="0" max="100" onchange="updatePercentages();updateCalculations()"/>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="margin">Your Profit Margin %</label>
            <input type="number" id="margin" value="60" min="20" max="80" onchange="updateCalculations()"/>
          </div>
          <div class="form-group">
            <label for="spoilage">Spoilage %</label>
            <input type="number" id="spoilage" value="0" min="0" max="20" step="0.5" onchange="updateCalculations()"/>
          </div>
        </div>
      </div>

      <!-- Operational Costs -->
      <div class="input-section">
        <div class="section-title">Operational Costs</div>

        <div class="form-group">
          <label for="financing">Monthly Financing Payment</label>
          <input type="number" id="financing" value="295" min="0" max="1000" onchange="updateCalculations()"/>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="laborRate">Labor Rate ($/hour)</label>
            <input type="number" id="laborRate" value="20" min="10" max="50" onchange="updateCalculations()"/>
          </div>
          <div class="form-group">
            <label for="laborHours">Hours per Week (per fridge)</label>
            <input type="number" id="laborHours" value="0.75" step="0.25" min="0" max="10" onchange="updateCalculations()"/>
          </div>
        </div>

        <div class="form-group">
          <label for="miscCosts">Miscellaneous Monthly Costs</label>
          <input type="number" id="miscCosts" value="0" min="0" max="500" onchange="updateCalculations()"/>
        </div>

        <div style="background:#e0f2fe;padding:15px;border-radius:8px;margin-top:20px">
          <h4 style="color:#0369a1;margin-bottom:10px">Fixed Costs (per fridge):</h4>
          <div style="font-size:.9em;color:#0369a1" id="fixedCostsSummary">Loading...</div>
        </div>
      </div>

      <!-- Results -->
      <div class="results-section">
        <div class="results-title">Financial Performance</div>

        <div class="results-grid">
          <div class="result-card"><div class="result-label">Monthly Revenue</div><div class="result-value" id="monthlyRevenue">$0</div></div>
          <div class="result-card"><div class="result-label">Monthly Costs</div><div class="result-value" id="monthlyCosts">$0</div></div>
          <div class="result-card"><div class="result-label">Monthly Net Profit</div><div class="result-value" id="monthlyProfit">$0</div></div>
          <div class="result-card"><div class="result-label">Annual Net Profit</div><div class="result-value" id="annualProfit">$0</div></div>
          <div class="result-card"><div class="result-label">ROI %</div><div class="result-value" id="roiPercent">0%</div></div>
          <div class="result-card"><div class="result-label">Payback Period</div><div class="result-value" id="paybackPeriod">0 months</div></div>
        </div>

        <div class="timeline-section">
          <div class="timeline-title">Multi-Year Projection</div>
          <div class="timeline-grid" id="timelineGrid"></div>
        </div>
      </div>

      <!-- Scaling Analysis -->
      <div class="scaling-section">
        <div class="scaling-title">Scaling Analysis</div>
        <div class="scaling-grid" id="scalingGrid"></div>
      </div>
    </div>

    <div class="download-section">
      <h3 style="margin-bottom:20px;color:#374151">Export Your Analysis</h3>
      <button class="btn" onclick="generatePDFReport()">Download PDF Report</button>
      <button class="btn btn-secondary" onclick="shareResults()">Share Results</button>
    </div>
  </div>

  <!-- SHARE / GET LINK Modal -->
  <div id="shareOverlay" class="overlay">
    <div class="modal">
      <div class="modal-header">
        <h3>Share Calculator Link</h3>
        <button class="close" onclick="closeShare()">Close</button>
      </div>
      <div>
        <label for="clientNameInput" style="font-weight:600;color:#374151">Client name (optional)</label>
        <div class="field-row">
          <input type="text" id="clientNameInput" placeholder="e.g., Acme Corp"/>
          <button class="btn" id="createLinkBtn">Generate Link</button>
        </div>
        <div id="shareResult" style="display:none;margin-top:12px">
          <div style="font-weight:700;color:#065f46;margin-bottom:6px">Link created (expires in 7 days):</div>
          <div class="field-row">
            <input type="text" id="shareUrlBox" readonly/>
            <button class="btn btn-secondary" onclick="copyShareUrl()">Copy</button>
          </div>
          <div class="muted" id="shareMeta" style="font-size:.9em;color:#475569"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- MANAGE LINKS Modal -->
  <div id="manageOverlay" class="overlay">
    <div class="modal" style="max-width:900px">
      <div class="modal-header">
        <h3>Manage Links</h3>
        <button class="close" onclick="closeManage()">Close</button>
      </div>
      <div class="field-row" style="align-items:center">
        <input type="text" id="filterCreatedBy" placeholder="Filter by Created By (optional)"/>
        <button class="btn" id="refreshTokensBtn">Refresh</button>
      </div>
      <div class="token-list" id="tokenList">
        <div class="muted">Loading…</div>
      </div>
    </div>
  </div>

  <script>
    // ===== Backend (Apps Script) URL =====
    const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbyliQpOEuz0QMKWMtHW7Cjlhqf2qEmLNTXI4TDY8THVPbKXzyqkIJ5dbIsHtb8JegHc_Q/exec';

    // ===== JSONP helper =====
    function jsonpRequest(action, params = {}, timeoutMs = 15000) {
      return new Promise((resolve, reject) => {
        const cbName = 'jsonp_cb_' + Math.random().toString(36).slice(2);
        const script = document.createElement('script');
        const url = new URL(BACKEND_URL);
        url.searchParams.set('action', action);
        url.searchParams.set('callback', cbName);
        Object.keys(params).forEach(k => url.searchParams.set(k, params[k]));

        const timer = setTimeout(() => {
          cleanup();
          reject(new Error('Request timeout'));
        }, timeoutMs);

        function cleanup() {
          clearTimeout(timer);
          try { delete window[cbName]; } catch(e){}
          if (script.parentNode) script.parentNode.removeChild(script);
        }

        window[cbName] = (data) => { cleanup(); resolve(data); };
        script.onerror = () => { cleanup(); reject(new Error('Network error')); };
        script.src = url.toString();
        document.body.appendChild(script);
      });
    }

    // ===== Global state =====
    let baseRates = null;
    let accessToken = null;
    let accessValidated = false;
    let operatorMode = false;

    // ===== Initialize =====
    window.addEventListener('DOMContentLoaded', async () => {
      await initializeCalculator();
      bindOperatorButtons();
      // Visual feedback for inputs
      document.querySelectorAll('input').forEach(input => {
        input.addEventListener('input', function(){
          this.style.borderColor = '#1e3a8a';
          setTimeout(()=>{ this.style.borderColor = '#d1d5db'; }, 500);
        });
      });
    });

    async function initializeCalculator() {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        accessToken = urlParams.get('token');
        operatorMode = !accessToken;

        if (operatorMode) {
          // Operator: skip validation; use defaults; show operator bar
          baseRates = getDefaultRates();
          applyBaseRates();
          document.getElementById('operatorBar').style.display = 'block';
          document.getElementById('loadingOverlay').style.display = 'none';
          document.getElementById('calculatorContent').style.display = 'block';
          accessValidated = true; // allow calculations
          updateCalculations();
          return;
        }

        // Guest with token: validate via JSONP
        const validation = await jsonpRequest('validateAccess', {
          token: accessToken,
          userAgent: navigator.userAgent
        });

        if (validation.status !== 'success') {
          const expired = validation?.data?.expired;
          showExpiredModal(expired ? null : (validation.message || 'Invalid access token.'));
          return;
        }

        // Get base rates via JSONP
        const rates = await jsonpRequest('getBaseRates', { token: accessToken });
        if (rates.status === 'success') {
          baseRates = rates.data.baseRates;
        } else {
          baseRates = getDefaultRates();
        }

        applyBaseRates();
        trackUsage('calculator_loaded');

        document.getElementById('loadingOverlay').style.display = 'none';
        document.getElementById('calculatorContent').style.display = 'block';
        accessValidated = true;
        updateCalculations();

      } catch (err) {
        console.error('Initialization error:', err);
        showExpiredModal('Unable to load calculator. Please try again or contact support.');
      }
    }

    function bindOperatorButtons() {
      const shareBtn = document.getElementById('shareLinkBtn');
      const manageBtn = document.getElementById('manageLinksBtn');
      if (shareBtn) shareBtn.addEventListener('click', openShare);
      if (manageBtn) manageBtn.addEventListener('click', openManage);

      const createLinkBtn = document.getElementById('createLinkBtn');
      if (createLinkBtn) createLinkBtn.addEventListener('click', generateShareLink);

      const refreshBtn = document.getElementById('refreshTokensBtn');
      if (refreshBtn) refreshBtn.addEventListener('click', loadTokens);
    }

    // ===== Apply base rates to UI =====
    function applyBaseRates() {
      if (!baseRates) return;
      const d = baseRates.defaults;
      document.getElementById('transactions').value = d.transactions ?? 330;
      document.getElementById('foodPrice').value = d.foodPrice ?? 10.00;
      document.getElementById('foodPercent').value = d.foodPercent ?? 90;
      document.getElementById('beveragePrice').value = d.beveragePrice ?? 3.99;
      document.getElementById('beveragePercent').value = d.beveragePercent ?? 10;
      document.getElementById('margin').value = d.margin ?? 60;
      document.getElementById('spoilage').value = d.spoilage ?? 0;
      document.getElementById('financing').value = d.financing ?? 295;
      document.getElementById('laborRate').value = d.laborRate ?? 20;
      document.getElementById('laborHours').value = d.laborHours ?? 0.75;

      const f = baseRates.fixedCosts;
      document.getElementById('fixedCostsSummary').innerHTML = `
        • Cellular: $${f.cellular}/month<br>
        • License Fee: $${f.licenseFee}/month<br>
        • Transaction Fees: Variable by usage<br>
        • RFID Tags: $${f.rfidTagsPerTag} per tag
      `;
    }

    // ===== Tracking (JSONP, fire-and-forget) =====
    function trackUsage(action, inputData = null) {
      try {
        const params = {
          action: 'trackUsage',
          token: accessToken || '',
          userAgent: navigator.userAgent
        };
        if (inputData) params.inputs = JSON.stringify(inputData);
        // Fire & forget
        jsonpRequest('trackUsage', params).catch(()=>{});
      } catch (_) {}
    }

    // ===== Expired modal =====
    function showExpiredModal(customMessage=null) {
      const msg = customMessage || 'Your access to this ROI Calculator has expired. Please contact your Quantum Solutions representative to request renewed access.';
      const overlay = document.createElement('div');
      overlay.className = 'expired-overlay';
      overlay.innerHTML = `
        <div class="expired-modal">
          <h2>Access Expired</h2>
          <p>${msg}</p>
          <button class="btn" onclick="window.close()">Close</button>
        </div>`;
      document.body.appendChild(overlay);
    }

    // ===== Defaults (fallback) =====
    function getDefaultRates() {
      return {
        fixedCosts: {
          cellular: 25,
          licenseFee: 175,
          rfidTagsPerTag: 0.18,
          engageTransactionFee: 0.15,
          gatewayTransactionFee: 0.07,
          merchantAccountPercent: 2.5,
          merchantAccountSwipeFee: 0.03
        },
        defaults: {
          transactions: 330,
          foodPrice: 10.00,
          foodPercent: 90,
          beveragePrice: 3.99,
          beveragePercent: 10,
          margin: 60,
          spoilage: 0,
          financing: 295,
          laborRate: 20,
          laborHours: 0.75
        }
      };
    }

    // ===== Inputs & calculations =====
    function updatePercentages() {
      const foodPercent = parseFloat(document.getElementById('foodPercent').value || 0);
      document.getElementById('beveragePercent').value = Math.max(0, 100 - foodPercent);
    }

    function updateCalculations() {
      if (!accessValidated) return;

      const inputs = {
        fridgeCount: parseInt(document.getElementById('fridgeCount').value) || 1,
        transactions: parseInt(document.getElementById('transactions').value) || 330,
        foodPrice: parseFloat(document.getElementById('foodPrice').value) || 10.00,
        foodPercent: parseFloat(document.getElementById('foodPercent').value) || 90,
        beveragePrice: parseFloat(document.getElementById('beveragePrice').value) || 3.99,
        beveragePercent: parseFloat(document.getElementById('beveragePercent').value) || 10,
        margin: parseFloat(document.getElementById('margin').value) || 60,
        spoilage: parseFloat(document.getElementById('spoilage').value) || 0,
        financing: parseFloat(document.getElementById('financing').value) || 295,
        laborRate: parseFloat(document.getElementById('laborRate').value) || 20,
        laborHours: parseFloat(document.getElementById('laborHours').value) || 0.75,
        miscCosts: parseFloat(document.getElementById('miscCosts').value) || 0
      };

      const results = calculateROI(inputs);
      displayResults(results, inputs);
      generateTimeline(results, inputs);
      generateScaling(inputs);

      trackUsage('calculation_performed', inputs);
    }

    function calculateROI(inputs) {
      const perFridge = calculatePerFridge(inputs);
      return {
        monthlyRevenue: perFridge.monthlyRevenue * inputs.fridgeCount,
        monthlyCosts: perFridge.monthlyCosts * inputs.fridgeCount,
        monthlyProfit: perFridge.monthlyProfit * inputs.fridgeCount,
        annualProfit: perFridge.monthlyProfit * inputs.fridgeCount * 12,
        roi: perFridge.roi,
        paybackMonths: perFridge.paybackMonths,
        perFridgeProfit: perFridge.monthlyProfit
      };
    }

    function calculatePerFridge(inputs) {
      const rates = baseRates?.fixedCosts || getDefaultRates().fixedCosts;

      // Revenue
      const avgTransactionValue =
        (inputs.foodPrice * inputs.foodPercent / 100) +
        (inputs.beveragePrice * inputs.beveragePercent / 100);
      const monthlyRevenue = inputs.transactions * avgTransactionValue;

      // COGS
      const cogs = monthlyRevenue * ((100 - inputs.margin) / 100);

      // Fixed operational costs
      const rfidTagsCost = inputs.transactions * rates.rfidTagsPerTag;
      const transactionFees = inputs.transactions * (rates.engageTransactionFee + rates.gatewayTransactionFee);
      const merchantFees =
        (monthlyRevenue * rates.merchantAccountPercent / 100) +
        (inputs.transactions * rates.merchantAccountSwipeFee);

      const fixedCosts = rates.cellular + rates.licenseFee + rfidTagsCost + transactionFees + merchantFees;

      // Variable costs
      const spoilageCost = monthlyRevenue * (inputs.spoilage / 100);
      const laborCost = inputs.laborRate * inputs.laborHours * 4.33; // weeks/month

      const totalCosts = cogs + fixedCosts + spoilageCost + laborCost + inputs.miscCosts;
      const monthlyProfit = monthlyRevenue - totalCosts;

      // ROI calc (exclude financing)
      const monthlyProfitPreFinancing = monthlyProfit + inputs.financing;
      const initialInvestment = 7500;
      const roi = (monthlyProfitPreFinancing * 12 / initialInvestment) * 100;

      // Payback
      const paybackMonths = initialInvestment / monthlyProfitPreFinancing;

      return {
        monthlyRevenue,
        monthlyCosts: totalCosts + inputs.financing,
        monthlyProfit: monthlyProfit - inputs.financing,
        roi,
        paybackMonths
      };
    }

    function displayResults(results, inputs) {
      document.getElementById('monthlyRevenue').textContent = formatCurrency(results.monthlyRevenue);
      document.getElementById('monthlyCosts').textContent = formatCurrency(results.monthlyCosts);

      const profitEl = document.getElementById('monthlyProfit');
      profitEl.textContent = formatCurrency(results.monthlyProfit);
      profitEl.className = 'result-value ' + (results.monthlyProfit >= 0 ? 'positive' : 'negative');

      const annualEl = document.getElementById('annualProfit');
      annualEl.textContent = formatCurrency(results.annualProfit);
      annualEl.className = 'result-value ' + (results.annualProfit >= 0 ? 'positive' : 'negative');

      document.getElementById('roiPercent').textContent = results.roi.toFixed(1) + '%';
      document.getElementById('paybackPeriod').textContent = Math.round(results.paybackMonths) + ' months';
    }

    function generateTimeline(results, inputs) {
      const timeline = document.getElementById('timelineGrid');
      timeline.innerHTML = '';
      const periods = [
        { label: 'Year 1', months: 12 },
        { label: 'Year 2', months: 24 },
        { label: 'Year 3', months: 36 },
        { label: 'Post-Financing', months: 48 }
      ];

      periods.forEach(period => {
        const item = document.createElement('div');
        item.className = 'timeline-item';
        let profit = (period.label === 'Post-Financing')
          ? (results.monthlyProfit + inputs.financing) * 12
          : results.monthlyProfit * period.months;
        item.innerHTML = `
          <div class="timeline-period">${period.label}</div>
          <div class="timeline-profit">${formatCurrency(profit)}</div>`;
        timeline.appendChild(item);
      });
    }

    function generateScaling(inputs) {
      const scaling = document.getElementById('scalingGrid');
      scaling.innerHTML = '';
      [1,3,5,10,20].forEach(fridgeCount => {
        const scaledInputs = { ...inputs, fridgeCount };
        const results = calculateROI(scaledInputs);
        const item = document.createElement('div');
        item.className = 'scaling-item';
        item.innerHTML = `
          <div class="scaling-fridges">${fridgeCount} Fridge${fridgeCount>1?'s':''}</div>
          <div class="scaling-profit">${formatCurrency(results.monthlyProfit)}/month</div>`;
        scaling.appendChild(item);
      });
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',minimumFractionDigits:0,maximumFractionDigits:0}).format(amount);
    }

    function generatePDFReport() {
      trackUsage('pdf_download_requested');
      alert('PDF Report generation coming soon! This will create a comprehensive analysis document with your calculations, assumptions, and Quantum Solutions branding.');
    }

    function shareResults() {
      trackUsage('share_results_requested');
      alert('Results sharing coming soon! This will generate a summary link you can share with stakeholders.');
    }

    // ===== Operator: Share / Manage =====
    function openShare(){ document.getElementById('shareOverlay').style.display='flex'; document.getElementById('shareResult').style.display='none'; }
    function closeShare(){ document.getElementById('shareOverlay').style.display='none'; }

    async function generateShareLink(){
      const clientName = document.getElementById('clientNameInput').value.trim();
      const createdBy = (localStorage.getItem('dashboardUser') || sessionStorage.getItem('dashboardUser') || 'Operator');
      const btn = document.getElementById('createLinkBtn');
      const orig = btn.textContent; btn.textContent='Generating…'; btn.disabled=true;
      try{
        const resp = await jsonpRequest('generateToken', { createdBy, clientName });
        if (resp.status !== 'success') throw new Error(resp.message || 'Failed to generate link');
        const { shareUrl, expiresAt } = resp.data;
        document.getElementById('shareUrlBox').value = shareUrl;
        document.getElementById('shareMeta').textContent = `Created by ${createdBy}${clientName?` · Client: ${clientName}`:''} · Expires: ${new Date(expiresAt).toLocaleString()}`;
        document.getElementById('shareResult').style.display='block';
      }catch(err){
        alert('Error: ' + err.message);
      }finally{
        btn.textContent = orig; btn.disabled=false;
      }
    }

    function copyShareUrl(){
      const inp = document.getElementById('shareUrlBox');
      inp.select(); inp.setSelectionRange(0, 99999);
      document.execCommand('copy');
      alert('Link copied to clipboard!');
    }

    function openManage(){ document.getElementById('manageOverlay').style.display='flex'; loadTokens(); }
    function closeManage(){ document.getElementById('manageOverlay').style.display='none'; }

    async function loadTokens(){
      const tokenList = document.getElementById('tokenList');
      tokenList.innerHTML = '<div class="muted">Loading…</div>';
      const createdBy = document.getElementById('filterCreatedBy').value.trim();
      try{
        const resp = await jsonpRequest('listTokens', {
          createdBy,
          onlyActive: 'false',  // show all
          maxRows: '50'
        });
        if (resp.status !== 'success') throw new Error(resp.message || 'Failed to load tokens');
        const items = resp.data.tokens || [];
        if (!items.length){ tokenList.innerHTML = '<div class="muted">No tokens found.</div>'; return; }
        tokenList.innerHTML = items.map(t => {
          const active = !!t.active;
          return `
            <div class="token-item">
              <div>
                <div class="token-meta"><strong>${t.clientName || '(no client name)'}</strong> <span class="badge ${active?'badge-green':'badge-gray'}">${active?'Active':'Inactive'}</span></div>
                <div class="token-meta muted">Created: ${t.createdDate ? new Date(t.createdDate).toLocaleString() : '—'} · Expires: ${t.expiresAt ? new Date(t.expiresAt).toLocaleString() : '—'}</div>
                <div class="token-meta muted">Created By: ${t.createdBy || '—'} · Accesses: ${t.accessCount ?? 0}</div>
              </div>
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button class="btn btn-ghost" onclick="copyDirect('${t.shareUrl.replace(/'/g,\"\\'\")}')">Copy Link</button>
                ${active ? `<button class="btn btn-danger" onclick="revokeToken('${t.token}')">Revoke</button>` : ''}
              </div>
            </div>`;
        }).join('');
      }catch(err){
        tokenList.innerHTML = `<div class="muted">Error: ${err.message}</div>`;
      }
    }

    function copyDirect(text){
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select(); document.execCommand('copy');
      document.body.removeChild(ta);
      alert('Link copied to clipboard!');
    }

    async function revokeToken(token){
      if (!confirm('Revoke this link? It will stop working immediately.')) return;
      try{
        const resp = await jsonpRequest('deactivateToken', { token });
        if (resp.status !== 'success') throw new Error(resp.message || 'Failed to revoke');
        loadTokens();
      }catch(err){
        alert('Error: ' + err.message);
      }
    }
  </script>
</body>
</html>
