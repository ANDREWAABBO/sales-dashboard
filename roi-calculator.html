<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smart Food Fridge ROI Calculator - Quantum Solutions</title>
  <style>
    :root{
      --q-blue:#1e3a8a;
      --q-blue-2:#1e40af;
      --q-bg:#0f172a;
      --panel:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;
      --soft:#f8fafc;
      --good:#059669;
      --bad:#dc2626;
      --chip:#dbeafe;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Inter,system-ui,Arial,sans-serif;
      background:linear-gradient(135deg,#1e3a8a 0%,#3b82f6 100%);
      color:var(--ink);
    }
    .wrap{
      max-width:980px;
      margin:40px auto;
      padding:0 16px;
    }
    .card{
      background:#fff;
      border-radius:16px;
      box-shadow:0 20px 60px rgba(0,0,0,.25);
      overflow:hidden;
      border:1px solid var(--line);
    }
    .card-hd{
      display:flex;align-items:center;justify-content:space-between;
      padding:20px 24px;border-bottom:1px solid var(--line);
      background:linear-gradient(180deg,#fff 0%,#fafafa 100%);
    }
    .title{
      margin:0;font-weight:800;color:var(--q-blue);letter-spacing:.2px;font-size:22px;
    }
    .hdr-actions{display:flex;gap:8px}
    .btn{
      appearance:none;border:0;cursor:pointer;border-radius:10px;
      padding:10px 14px;font-weight:700;color:#fff;background:var(--q-blue);
      transition:transform .15s ease, box-shadow .15s ease, background .2s ease;
      box-shadow:0 6px 20px rgba(30,58,138,.25);
    }
    .btn:hover{transform:translateY(-1px);background:var(--q-blue-2)}
    .btn.ghost{background:#fff;color:var(--q-blue);border:1px solid var(--line);box-shadow:none}
    .note{
      margin:16px 24px;padding:10px 12px;border-radius:10px;
      background:#fff7ed;border:1px solid #fed7aa;color:#9a3412;font-weight:700;
      text-align:center
    }
    .grid{
      display:grid;gap:20px;padding:20px 24px 8px 24px;
      grid-template-columns:1fr 1fr;
    }
    @media (max-width:860px){.grid{grid-template-columns:1fr}}
    .panel{
      border:1px solid var(--line);border-radius:12px;padding:16px;background:#fff
    }
    .panel h3{margin:0 0 10px 0;color:var(--q-blue);font-size:16px}
    .row{display:grid;gap:10px;margin:10px 0}
    .row.two{grid-template-columns:1fr 1fr}
    label{font-size:12px;color:#334155;font-weight:700;display:block;margin-bottom:6px}
    input{
      width:100%;padding:10px 12px;border:2px solid #d1d5db;border-radius:8px;font-size:15px;background:#fff
    }
    input:focus{outline:none;border-color:var(--q-blue);box-shadow:0 0 0 3px rgba(30,58,138,.12)}
    .fixed{
      background:#eff6ff;border:1px solid #bfdbfe;border-radius:10px;padding:10px;color:#0369a1;font-size:13px
    }
    .results{padding:8px 24px 24px 24px}
    .band{
      border:2px solid #bfdbfe;background:#eef2ff;border-radius:14px;padding:14px
    }
    .band h4{margin:0 0 10px 0;text-align:center;color:var(--q-blue)}
    .kpis{display:grid;gap:12px;grid-template-columns:repeat(4,1fr)}
    @media (max-width:860px){.kpis{grid-template-columns:repeat(2,1fr)}}
    .k{background:#fff;border:1px solid var(--line);border-radius:12px;padding:14px;text-align:center}
    .k small{display:block;color:var(--muted);font-weight:800}
    .k b{display:block;margin-top:6px;font-size:20px;color:var(--q-blue)}
    .k .pos{color:var(--good)}.k .neg{color:var(--bad)}
    .proj{display:grid;gap:12px;grid-template-columns:repeat(3,1fr);margin-top:12px}
    .tile{background:#fff;border:1px solid var(--line);border-radius:10px;padding:12px;text-align:center}
    .tile small{display:block;color:var(--muted);font-weight:800}
    .tile b{display:block;margin-top:6px;color:var(--q-blue)}
    .footer-actions{display:flex;gap:10px;justify-content:center;margin:18px 0 6px}
    /* overlays */
    .overlay{position:fixed;inset:0;background:rgba(15,23,42,.65);display:none;align-items:center;justify-content:center;z-index:1000}
    .modal{width:min(560px,92vw);background:#fff;border-radius:16px;border:1px solid var(--line);box-shadow:0 30px 80px rgba(0,0,0,.35);overflow:hidden}
    .modal-hd{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid var(--line)}
    .modal-hd h4{margin:0;color:var(--q-blue)}
    .modal-bd{padding:16px}
    .muted{color:var(--muted)}
    .inputs{display:grid;gap:10px}
    .btn-row{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
    .tag{display:inline-block;background:var(--chip);border:1px solid #bfdbfe;color:#1d4ed8;border-radius:20px;padding:2px 8px;margin-left:8px;font-size:12px}
    .pill{padding:10px 12px;border:1px dashed #cbd5e1;border-radius:10px;background:#f8fafc}
    .hidden{display:none !important}
    .loading{
      position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(30,58,138,.92);z-index:999
    }
    .load-card{background:#fff;border-radius:16px;padding:26px 28px;width:min(360px,92vw);text-align:center}
    .spinner{width:36px;height:36px;border-radius:50%;border:4px solid #e5e7eb;border-top-color:var(--q-blue);animation:spin 1s linear infinite;margin:0 auto 12px}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <!-- loading -->
  <div id="loading" class="loading">
    <div class="load-card">
      <div class="spinner"></div>
      <h4 style="margin:6px 0 6px;color:var(--q-blue)">Loading ROI Calculator…</h4>
      <div class="muted" style="font-size:13px">Validating access and retrieving latest data</div>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <div class="card-hd">
        <h1 class="title">Smart Food Fridge ROI Calculator
          <span id="modeTag" class="tag">Operator Mode</span>
        </h1>
        <div id="hdrActions" class="hdr-actions hidden">
          <button class="btn ghost" id="btnManage">Manage Links</button>
          <button class="btn" id="btnShare">Share / Get Link</button>
        </div>
      </div>

      <div class="note">
        These are estimated calculations. True profit is determined by your actual business model and operational factors.
      </div>

      <div class="grid">
        <!-- Business -->
        <div class="panel">
          <h3>Business Assumptions</h3>
          <div class="row">
            <label>Number of Fridges</label>
            <input id="fridgeCount" type="number" min="1" value="1">
          </div>

          <div class="row">
            <label>Monthly Transactions (per fridge)</label>
            <input id="transactions" type="number" min="50" value="330">
          </div>

          <div class="row two">
            <div>
              <label>Food Price per Sale</label>
              <input id="foodPrice" type="number" step="0.01" value="10.00">
            </div>
            <div>
              <label>Food Sales %</label>
              <input id="foodPercent" type="number" min="0" max="100" value="90">
            </div>
          </div>

          <div class="row two">
            <div>
              <label>Beverage Price per Sale</label>
              <input id="beveragePrice" type="number" step="0.01" value="3.99">
            </div>
            <div>
              <label>Beverage Sales %</label>
              <input id="beveragePercent" type="number" min="0" max="100" value="10">
            </div>
          </div>

          <div class="row two">
            <div>
              <label>Your Profit Margin %</label>
              <input id="margin" type="number" min="20" max="80" value="60">
            </div>
            <div>
              <label>Spoilage %</label>
              <input id="spoilage" type="number" min="0" max="20" step="0.5" value="0">
            </div>
          </div>

          <div class="row">
            <label>Monthly Service Fee Charged to Client (per fridge)</label>
            <input id="serviceFee" type="number" min="0" step="1" value="0">
          </div>
        </div>

        <!-- Ops -->
        <div class="panel">
          <h3>Operational Costs</h3>
          <div class="row">
            <label>Monthly Financing Payment (per fridge)</label>
            <input id="financing" type="number" min="0" value="295">
          </div>

          <div class="row two">
            <div>
              <label>Labor Rate ($/hour)</label>
              <input id="laborRate" type="number" min="0" value="20">
            </div>
            <div>
              <label>Hours per Week (per fridge)</label>
              <input id="laborHours" type="number" min="0" step="0.25" value="0.75">
            </div>
          </div>

          <div class="row">
            <label>Miscellaneous Monthly Costs (per fridge)</label>
            <input id="miscCosts" type="number" min="0" value="0">
          </div>

          <div class="fixed">
            <b>Fixed Costs & Fees (per fridge):</b>
            <ul style="margin:6px 0 0 18px;padding:0">
              <li>Cellular: $25/month</li>
              <li>License Fee: $175/month</li>
              <li>Engage Transaction: $0.15 per tx</li>
              <li>Gateway Transaction: $0.07 per tx</li>
              <li>Merchant Interchange: 2.5% of revenue</li>
              <li>Merchant Swipe Fee: $0.03 per tx</li>
              <li>RFID Tags: $0.18 per tag</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Results -->
      <div class="results">
        <div class="band">
          <h4>Financial Performance</h4>
          <div class="kpis">
            <div class="k">
              <small>Monthly Revenue</small>
              <b id="monthlyRevenue">$0</b>
            </div>
            <div class="k">
              <small>Monthly Costs</small>
              <b id="monthlyCosts">$0</b>
            </div>
            <div class="k">
              <small>Monthly Net Profit</small>
              <b id="monthlyProfit" class="pos">$0</b>
            </div>
            <div class="k">
              <small>Annual Net Profit</small>
              <b id="annualProfit" class="pos">$0</b>
            </div>
          </div>

          <div class="kpis" style="margin-top:10px">
            <div class="k">
              <small>ROI %</small>
              <b id="roiPercent">0%</b>
            </div>
            <div class="k">
              <small>Payback Period</small>
              <b id="paybackPeriod">0 months</b>
            </div>
            <div class="k">
              <small>—</small><b style="opacity:.2"> </b>
            </div>
            <div class="k">
              <small>—</small><b style="opacity:.2"> </b>
            </div>
          </div>
        </div>

        <div class="band" style="margin-top:12px">
          <h4>Multi-Year Projection</h4>
          <div class="proj">
            <div class="tile">
              <small>Year 1</small>
              <b id="y1">$0</b>
            </div>
            <div class="tile">
              <small>Year 2</small>
              <b id="y2">$0</b>
            </div>
            <div class="tile">
              <small>Year 3</small>
              <b id="y3">$0</b>
            </div>
          </div>
        </div>

        <div class="footer-actions">
          <button class="btn" id="btnPdf">Download PDF Report</button>
          <button class="btn ghost" id="btnShareFooter">Share Results</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Share Modal -->
  <div id="shareOverlay" class="overlay">
    <div class="modal">
      <div class="modal-hd">
        <h4>Create a 7-day share link</h4>
        <button class="btn ghost" id="shareClose">Close</button>
      </div>
      <div class="modal-bd">
        <div class="inputs">
          <div>
            <label>Client name (optional)</label>
            <input id="shareClient" type="text" placeholder="e.g., Acme HQ">
          </div>
          <div class="pill">
            Your name (for the token record): <b id="shareCreator">(detected)</b>
          </div>
          <div>
            <label>Link</label>
            <input id="shareLink" type="text" readonly placeholder="Click Generate to create link">
          </div>
        </div>
        <div class="btn-row">
          <button class="btn ghost" id="shareCopy" disabled>Copy</button>
          <button class="btn" id="shareGen">Generate</button>
        </div>
        <div id="shareHint" class="muted" style="margin-top:8px"></div>
      </div>
    </div>
  </div>

  <!-- Manage (placeholder if backend doesn’t support) -->
  <div id="manageOverlay" class="overlay">
    <div class="modal">
      <div class="modal-hd">
        <h4>Manage Links</h4>
        <button class="btn ghost" id="manageClose">Close</button>
      </div>
      <div class="modal-bd">
        <div class="muted">
          Token listing / revoke requires backend endpoints (e.g., <code>listTokens</code>, <code>deactivateToken</code>).
          If you haven’t added those yet in Apps Script, this panel will stay read-only.
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========= CONFIG =========
    const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbyliQpOEuz0QMKWMtHW7Cjlhqf2qEmLNTXI4TDY8THVPbKXzyqkIJ5dbIsHtb8JegHc_Q/exec';
    // Set this to your Apps Script auth key (must match the key in code.gs generateToken handler)
    const SHARE_AUTH_KEY = 'YOUR_SECRET_KEY';

    // Defaults (used if backend unreachable)
    const DEFAULTS = {
      fixedCosts: {
        cellular: 25,
        licenseFee: 175,
        rfidTagsPerTag: 0.18,
        engageTransactionFee: 0.15,
        gatewayTransactionFee: 0.07,
        merchantAccountPercent: 2.5,
        merchantAccountSwipeFee: 0.03
      },
      defaults: {
        transactions: 330,
        foodPrice: 10.00,
        foodPercent: 90,
        beveragePrice: 3.99,
        beveragePercent: 10,
        margin: 60,
        spoilage: 0,
        financing: 295,
        laborRate: 20,
        laborHours: 0.75,
        serviceFee: 0
      }
    };

    let baseRates = null;
    let accessToken = null;
    let operatorMode = true; // true when opened from the dashboard (no token)

    // ========= INIT =========
    window.addEventListener('DOMContentLoaded', init);

    async function init() {
      // Detect token
      const params = new URLSearchParams(location.search);
      accessToken = params.get('token');
      operatorMode = !accessToken;

      // Header actions visible only in operator mode
      document.getElementById('hdrActions').classList.toggle('hidden', !operatorMode);
      document.getElementById('modeTag').textContent = operatorMode ? 'Operator Mode' : 'Shared Link';

      // Wire UI
      hookInputs();
      document.getElementById('btnPdf').onclick = () => alert('PDF export coming soon.');
      document.getElementById('btnShare').onclick = openShare;
      document.getElementById('btnShareFooter').onclick = openShare;
      document.getElementById('btnManage').onclick = () => toggleOverlay('manageOverlay', true);
      document.getElementById('manageClose').onclick = () => toggleOverlay('manageOverlay', false);

      document.getElementById('shareClose').onclick = () => toggleOverlay('shareOverlay', false);
      document.getElementById('shareGen').onclick = generateShareLink;
      document.getElementById('shareCopy').onclick = copyShare;

      // detect operator name from localStorage (mirrored by dashboard login)
      const opName = localStorage.getItem('dashboardUser') || 'Unknown';
      document.getElementById('shareCreator').textContent = opName;

      // Load base rates (and validate token, if any)
      try {
        const ok = await validateAndLoad();
        if (!ok) throw new Error('Access invalid');
      } catch (e) {
        console.warn('Falling back to defaults:', e);
        baseRates = DEFAULTS;
      } finally {
        // Apply defaults to inputs, compute
        applyDefaults();
        computeAll();
        document.getElementById('loading').style.display = 'none';
      }
    }

    async function validateAndLoad() {
      if (accessToken) {
        // validate
        const v = await apiGet('validateAccess', { token: accessToken });
        if (v?.status !== 'success') return false;
      }
      // load rates
      const r = await apiGet('getBaseRates', { token: accessToken || '' });
      if (r?.status !== 'success') return false;
      baseRates = r.data.baseRates || DEFAULTS;
      return true;
    }

    // ========= API (fetch JSON) =========
    async function apiGet(action, params = {}) {
      try {
        const qs = new URLSearchParams({ action, ...params });
        const res = await fetch(`${BACKEND_URL}?${qs.toString()}`, { method:'GET', credentials:'omit' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
      } catch (e) {
        console.debug('apiGet failed', action, e);
        return null;
      }
    }

    // ========= INPUTS / CALC =========
    function hookInputs() {
      const ids = ['fridgeCount','transactions','foodPrice','foodPercent','beveragePrice','beveragePercent','margin','spoilage','financing','laborRate','laborHours','miscCosts','serviceFee'];
      ids.forEach(id=>{
        const el = document.getElementById(id);
        el.addEventListener('input', ()=>{
          if (id==='foodPercent') document.getElementById('beveragePercent').value = String(Math.max(0, 100 - (+el.value||0)));
          if (id==='beveragePercent') document.getElementById('foodPercent').value = String(Math.max(0, 100 - (+el.value||0)));
          computeAll();
        });
      });
    }

    function applyDefaults() {
      const d = (baseRates?.defaults) || DEFAULTS.defaults;
      const set = (id,v)=>{ const el=document.getElementById(id); if (el && (el.value===''||el.value==null)) el.value = v; };
      set('transactions', d.transactions);
      set('foodPrice', d.foodPrice);
      set('foodPercent', d.foodPercent);
      set('beveragePrice', d.beveragePrice);
      set('beveragePercent', d.beveragePercent);
      set('margin', d.margin);
      set('spoilage', d.spoilage);
      set('financing', d.financing);
      set('laborRate', d.laborRate);
      set('laborHours', d.laborHours);
      set('serviceFee', d.serviceFee ?? 0);
    }

    function num(id){ return parseFloat(document.getElementById(id).value)||0; }
    function int(id){ return parseInt(document.getElementById(id).value)||0; }

    function fmt(n, digits=0){
      return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',minimumFractionDigits:digits,maximumFractionDigits:digits}).format(n);
    }

    function computeAll(){
      const inputs = {
        fridgeCount: Math.max(1, int('fridgeCount')),
        transactions: Math.max(0, int('transactions')),
        foodPrice: num('foodPrice'),
        foodPercent: num('foodPercent'),
        beveragePrice: num('beveragePrice'),
        beveragePercent: num('beveragePercent'),
        margin: num('margin'),
        spoilage: num('spoilage'),
        financing: num('financing'),
        laborRate: num('laborRate'),
        laborHours: num('laborHours'),
        miscCosts: num('miscCosts'),
        serviceFee: num('serviceFee')
      };

      const r = calcPerFridge(inputs);
      const monthlyRevenue  = r.monthlyRevenue * inputs.fridgeCount;
      const monthlyCosts    = r.monthlyCosts   * inputs.fridgeCount;
      const monthlyProfit   = r.monthlyProfit  * inputs.fridgeCount;
      const annualProfit    = monthlyProfit * 12;

      // KPI paint
      document.getElementById('monthlyRevenue').textContent = fmt(monthlyRevenue);
      document.getElementById('monthlyCosts').textContent   = fmt(monthlyCosts);
      const mp = document.getElementById('monthlyProfit');
      mp.textContent = fmt(monthlyProfit);
      mp.classList.toggle('pos', monthlyProfit >= 0);
      mp.classList.toggle('neg', monthlyProfit < 0);

      const ap = document.getElementById('annualProfit');
      ap.textContent = fmt(annualProfit);
      ap.classList.toggle('pos', annualProfit >= 0);
      ap.classList.toggle('neg', annualProfit < 0);

      document.getElementById('roiPercent').textContent = `${r.roi.toFixed(1)}%`;
      document.getElementById('paybackPeriod').textContent = `${Math.max(0, Math.round(r.paybackMonths))} months`;

      // Projection (cumulative net)
      document.getElementById('y1').textContent = fmt(monthlyProfit * 12);
      document.getElementById('y2').textContent = fmt(monthlyProfit * 24);
      document.getElementById('y3').textContent = fmt(monthlyProfit * 36);
    }

    function calcPerFridge(inp){
      const rates = baseRates?.fixedCosts || DEFAULTS.fixedCosts;

      // Revenue mix
      const atv = (inp.foodPrice * (inp.foodPercent/100)) + (inp.beveragePrice * (inp.beveragePercent/100));
      const monthlyRevenue = inp.transactions * atv;

      // COGS from margin (margin% is gross margin before operating costs)
      const cogs = monthlyRevenue * ((100 - inp.margin)/100);

      // Transaction-based fees
      const rfidCost  = inp.transactions * rates.rfidTagsPerTag;
      const engageFee = inp.transactions * rates.engageTransactionFee;
      const gateway   = inp.transactions * rates.gatewayTransactionFee;
      const swipe     = inp.transactions * rates.merchantAccountSwipeFee;
      const interchange = monthlyRevenue * (rates.merchantAccountPercent/100);

      // Fixed platform
      const platformFixed = rates.cellular + rates.licenseFee;

      // Variable ops
      const spoilageCost = monthlyRevenue * (inp.spoilage/100);
      const labor = inp.laborRate * inp.laborHours * 4.33; // weeks per month

      // Total OPEX for one fridge (includes financing)
      const totalCosts =
        cogs + platformFixed + rfidCost + engageFee + gateway + swipe + interchange +
        spoilageCost + labor + inp.miscCosts + inp.financing;

      // Net profit per fridge = revenue - costs + service fee charged to client
      const monthlyProfit = (monthlyRevenue - totalCosts) + inp.serviceFee;

      // ROI & Payback — use profit before financing for ROI on asset cost
      const monthlyPreFin = monthlyProfit + inp.financing; // remove financing effect
      const initialInvestment = 7500; // assumed fridge cost
      const roi = (monthlyPreFin * 12 / initialInvestment) * 100;
      const paybackMonths = (initialInvestment / Math.max(1, monthlyPreFin));

      return {
        monthlyRevenue,
        monthlyCosts: totalCosts, // note: service fee is NOT a cost
        monthlyProfit,
        roi,
        paybackMonths
      };
    }

    // ========= SHARE =========
    function openShare(){
      if (!operatorMode){
        alert('This is a shared link. Only operators (from the dashboard) can create new links.');
        return;
      }
      toggleOverlay('shareOverlay', true);
      document.getElementById('shareHint').textContent = '';
      document.getElementById('shareLink').value = '';
      document.getElementById('shareCopy').disabled = true;
    }

    async function generateShareLink(){
      const creator = localStorage.getItem('dashboardUser') || 'Operator';
      const clientName = document.getElementById('shareClient').value || '';

      if (!SHARE_AUTH_KEY || SHARE_AUTH_KEY === 'YOUR_SECRET_KEY'){
        document.getElementById('shareHint').textContent =
          'To enable link generation, set SHARE_AUTH_KEY in roi-calculator.html and update Apps Script to accept the same key.';
        return;
      }

      const resp = await apiGet('generateToken', {
        authKey: SHARE_AUTH_KEY,
        createdBy: creator,
        clientName
      });

      if (!resp || resp.status !== 'success'){
        document.getElementById('shareHint').textContent =
          (resp && resp.message) ? resp.message : 'Unable to generate link. Check your Apps Script deployment.';
        return;
      }

      const token = resp.data?.token;
      if (!token){
        document.getElementById('shareHint').textContent = 'No token returned from server.';
        return;
      }

      // Compose the public URL (same page with ?token=)
      const shareUrl = new URL(location.href);
      shareUrl.search = `?token=${encodeURIComponent(token)}`;
      document.getElementById('shareLink').value = shareUrl.toString();
      document.getElementById('shareCopy').disabled = false;
      document.getElementById('shareHint').textContent = `Expires: ${new Date(resp.data.expiresAt).toLocaleString()}`;
    }

    function copyShare(){
      const el = document.getElementById('shareLink');
      el.select(); el.setSelectionRange(0, 99999);
      document.execCommand('copy');
      document.getElementById('shareHint').textContent = 'Link copied to clipboard.';
    }

    // ========= UTILS =========
    function toggleOverlay(id, show){
      document.getElementById(id).style.display = show ? 'flex' : 'none';
    }
  </script>
</body>
</html>
