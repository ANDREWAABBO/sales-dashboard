<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Smart Food Fridge ROI Calculator - Quantum Solutions</title>
<style>
  *{box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Ubuntu,Cantarell,sans-serif;background:linear-gradient(135deg,#1e3a8a,#3b82f6);min-height:100vh;margin:0;padding:24px;color:#0f172a}
  .wrap{max-width:980px;margin:0 auto;background:#fff;border-radius:18px;box-shadow:0 18px 60px rgba(0,0,0,.25);padding:22px}
  .topbar{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .title{font-weight:800;font-size:22px;color:#0f172a}
  .mode-pill{font-size:12px;background:#e2e8f0;color:#0f172a;border-radius:999px;padding:4px 8px;margin-left:8px}
  .btn{border:0;border-radius:10px;background:#1e3a8a;color:#fff;padding:10px 14px;font-weight:600;cursor:pointer}
  .btn:hover{background:#1e40af}
  .btn-alt{background:#0f766e}.btn-alt:hover{background:#115e59}
  .note{background:#fff7ed;border:1px solid #fed7aa;color:#92400e;border-radius:10px;padding:10px 12px;margin:12px 0}
  .grid{display:grid;gap:16px}
  @media(min-width:860px){.grid-2{grid-template-columns:1fr 1fr}}
  .card{border:1px solid #e2e8f0;border-radius:14px;padding:16px;background:#fafafa}
  .card h3{margin:0 0 10px 0;color:#0f172a;font-size:16px}
  .muted{color:#64748b}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row>.col{display:flex;flex-direction:column;gap:8px}
  label{font-size:12px;color:#334155;font-weight:700}
  input{width:100%;padding:10px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px}
  input:focus{outline:0;border-color:#1e3a8a;box-shadow:0 0 0 3px rgba(30,58,138,.12)}
  .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  @media(max-width:860px){.kpis{grid-template-columns:1fr 1fr}}
  .kpi{background:linear-gradient(180deg,#eaf2ff,#dbeafe);border:1px solid #c7d2fe;border-radius:14px;padding:14px;text-align:center}
  .kpi .lab{font-size:12px;color:#64748b;margin-bottom:6px}
  .kpi .val{font-weight:800;font-size:20px;color:#0f172a}
  .val.good{color:#065f46}.val.bad{color:#b91c1c}
  .proj{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  @media(max-width:860px){.proj{grid-template-columns:1fr}}
  .proj .box{background:#f8fafc;border:1px solid #e2e8f0;border-radius:12px;padding:12px;text-align:center}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{border-bottom:1px solid #e5e7eb;padding:10px}
  .table th{font-size:12px;color:#475569;background:#f1f5f9;text-transform:uppercase;letter-spacing:.02em}
  .tr-strong td{font-weight:800}
  .green{color:#047857}.red{color:#b91c1c}
  .sep{height:8px}
  .subtle{font-size:12px;color:#64748b}
  .rev-title{background:#ecfeff;color:#155e75;border:1px solid #a5f3fc;padding:6px 10px;border-radius:8px;display:inline-block;margin:10px 0 6px}
  .pill{font-size:12px;background:#e2e8f0;border-radius:999px;padding:3px 8px}
  .toolbar{display:flex;gap:8px}
  .right{display:flex;gap:8px}
  .center{text-align:center}
</style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">Smart Food Fridge ROI Calculator <span id="modePill" class="mode-pill">Operator Mode</span></div>
      <div class="toolbar">
        <button class="btn-alt" id="manageBtn">Manage Links</button>
        <button class="btn" id="shareBtn">Share / Get Link</button>
      </div>
    </div>

    <div class="note">These are estimated calculations. True profit is determined by your actual business model and operational factors.</div>

    <div class="grid grid-2">
      <!-- Business -->
      <div class="card">
        <h3>Business Assumptions</h3>
        <div class="row">
          <div class="col">
            <label>Number of Fridges</label><input id="fridgeCount" type="number" min="1" value="1">
            <label>Monthly Transactions (per fridge)</label><input id="transactions" type="number" min="0" value="330">
            <label>Food Price per Sale</label><input id="foodPrice" type="number" step="0.01" value="10.00">
            <label>Beverage Price per Sale</label><input id="beveragePrice" type="number" step="0.01" value="3.99">
            <label>Your Profit Margin %</label><input id="margin" type="number" min="0" max="100" value="60">
            <label>Monthly Service Fee (per fridge)</label><input id="serviceFee" type="number" min="0" value="395">
          </div>
          <div class="col">
            <label>Food Sales %</label><input id="foodPercent" type="number" min="0" max="100" value="90">
            <label>Beverage Sales %</label><input id="beveragePercent" type="number" min="0" max="100" value="10">
            <label>Spoilage %</label><input id="spoilage" type="number" step="0.1" min="0" value="0">
          </div>
        </div>
      </div>

      <!-- Operational -->
      <div class="card">
        <h3>Operational Costs</h3>
        <div class="row">
          <div class="col">
            <label>Monthly Financing Payment</label><input id="financing" type="number" min="0" value="295">
            <label>Labor Rate ($/hour)</label><input id="laborRate" type="number" min="0" value="20">
            <label>Miscellaneous Monthly Costs</label><input id="miscCosts" type="number" min="0" value="0">
          </div>
          <div class="col">
            <label>Hours per Week (per fridge)</label><input id="laborHours" type="number" step="0.25" min="0" value="0.75">
            <div class="card" style="margin-top:8px;background:#eef6ff;border-color:#bfdbfe">
              <div class="muted" style="font-size:12px"><strong>Fixed Costs &amp; Fees (per fridge):</strong><br>
                • Cellular: $25/mo<br>
                • License Fee: $175/mo<br>
                • Engage: $0.15 /tx<br>
                • Gateway: $0.07 /tx<br>
                • Merchant %: 2.5% of revenue<br>
                • Merchant Swipe: $0.03 /tx<br>
                • RFID Tags: $0.18 per tag
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- KPIs -->
    <div class="card" style="margin-top:14px">
      <h3>Financial Performance</h3>
      <div class="kpis" style="margin-top:10px">
        <div class="kpi"><div class="lab">Monthly Revenue</div><div id="kpiRevenue" class="val">$0</div></div>
        <div class="kpi"><div class="lab">Monthly Costs</div><div id="kpiCosts" class="val">$0</div></div>
        <div class="kpi"><div class="lab">Monthly Net Profit</div><div id="kpiProfit" class="val good">$0</div></div>
        <div class="kpi"><div class="lab">Annual Net Profit</div><div id="kpiAnnual" class="val good">$0</div></div>
        <div class="kpi"><div class="lab">ROI %</div><div id="kpiROI" class="val">0%</div></div>
        <div class="kpi"><div class="lab">Payback Period</div><div id="kpiPayback" class="val">—</div></div>
      </div>
    </div>

    <!-- Projection -->
    <div class="card">
      <h3>Multi-Year Projection</h3>
      <div class="proj" style="margin-top:10px">
        <div class="box"><div class="muted">Year 1</div><div id="y1" class="val good">$0</div></div>
        <div class="box"><div class="muted">Year 2</div><div id="y2" class="val good">$0</div></div>
        <div class="box"><div class="muted">Year 3</div><div id="y3" class="val good">$0</div></div>
      </div>
    </div>

    <!-- Breakdown -->
    <div class="card">
      <h3>Cost Breakdown</h3>
      <table class="table" id="breakdownTable" style="margin-top:8px">
        <thead><tr><th>Component</th><th class="right">Per Fridge</th><th class="right">All Fridges</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="subtle" style="margin-top:8px">
        Note: “Total Costs (incl. financing)” matches the Monthly Costs card. Service fee is shown as a credit and applied to Net Profit, not counted as a cost. Spoilage is calculated at <strong>cost</strong> (COGS × spoilage%).
      </div>
    </div>

    <div class="center" style="margin-top:14px">
      <button class="btn" id="pdfBtn">Download PDF Report</button>
    </div>
  </div>

<script>
/* ------------------ Backend ------------------ */
const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbyliQpOEuz0QMKWMtHW7Cjlhqf2qEmLNTXI4TDY8THVPbKXzyqkIJ5dbIsHtb8JegHc_Q/exec';
let baseRates = {
  fixedCosts:{cellular:25,licenseFee:175,rfidTagsPerTag:0.18,engageTransactionFee:0.15,gatewayTransactionFee:0.07,merchantAccountPercent:2.5,merchantAccountSwipeFee:0.03},
  defaults:{transactions:330,foodPrice:10,foodPercent:90,beveragePrice:3.99,beveragePercent:10,margin:60,spoilage:0,financing:295,laborRate:20,laborHours:0.75}
};
let accessToken=null, accessValidated=false;

function jsonp(action, params={}) {
  return new Promise((resolve,reject)=>{
    const cb = 'cb_'+Math.random().toString(36).slice(2);
    params.action = action; params.callback = cb;
    const qp = new URLSearchParams(params).toString();
    const s = document.createElement('script');
    s.src = `${BACKEND_URL}?${qp}`;
    window[cb] = (data)=>{ delete window[cb]; document.body.removeChild(s); resolve(data); };
    s.onerror = ()=>{ delete window[cb]; document.body.removeChild(s); reject(new Error('Network error')); };
    document.body.appendChild(s);
  });
}

async function initializeCalculator() {
  // Operator mode (no token) by default
  const urlParams = new URLSearchParams(location.search);
  accessToken = urlParams.get('token');
  document.getElementById('modePill').textContent = accessToken ? 'Client Mode' : 'Operator Mode';

  try {
    if (accessToken) {
      const v = await jsonp('validateAccess', {token: accessToken});
      if (v.status !== 'success') throw new Error(v.message || 'Access error');
    }
    // Try to fetch base rates (fallback on error)
    try{
      if (accessToken) {
        const br = await jsonp('getBaseRates', {token: accessToken});
        if (br.status === 'success') baseRates = br.data.baseRates;
      }
    }catch(_){}
    accessValidated = true;
  } catch(e) {
    console.warn('Falling back to defaults:', e.message || e);
  }

  // Defaults to form
  const d = baseRates.defaults || {};
  setVal('transactions', d.transactions ?? 330);
  setVal('foodPrice', d.foodPrice ?? 10);
  setVal('foodPercent', d.foodPercent ?? 90);
  setVal('beveragePrice', d.beveragePrice ?? 3.99);
  setVal('beveragePercent', d.beveragePercent ?? 10);
  setVal('margin', d.margin ?? 60);
  setVal('spoilage', d.spoilage ?? 0);
  setVal('financing', d.financing ?? 295);
  setVal('laborRate', d.laborRate ?? 20);
  setVal('laborHours', d.laborHours ?? 0.75);
  setVal('serviceFee', 395);

  // Events
  document.querySelectorAll('input').forEach(i=>i.addEventListener('input', updateCalculations));
  document.getElementById('shareBtn').onclick = openShare;
  document.getElementById('manageBtn').onclick = openManage;
  document.getElementById('pdfBtn').onclick = ()=>alert('PDF export coming soon.');

  updateCalculations();
}

function val(id){ return parseFloat(document.getElementById(id).value||0); }
function setVal(id,v){ document.getElementById(id).value = v; }

/* ------------------ Math ------------------ */
function calculatePerFridge(inputs){
  const r = baseRates.fixedCosts;

  // Split revenue by category
  const foodRevPerTx = inputs.foodPrice * (inputs.foodPercent/100);
  const bevRevPerTx  = inputs.beveragePrice * (inputs.beveragePercent/100);
  const foodRevenue  = inputs.transactions * foodRevPerTx;
  const bevRevenue   = inputs.transactions * bevRevPerTx;
  const monthlyRevenue = foodRevenue + bevRevenue;

  // COGS from margin
  const cogs = monthlyRevenue * ((100 - inputs.margin)/100);

  // Spoilage at COST (requested)
  const spoilageCost = cogs * (inputs.spoilage/100);

  // Per-transaction fees
  const engageFee   = inputs.transactions * r.engageTransactionFee;
  const gatewayFee  = inputs.transactions * r.gatewayTransactionFee;
  const swipeFee    = inputs.transactions * r.merchantAccountSwipeFee;
  const merchantPct = monthlyRevenue * (r.merchantAccountPercent/100);

  // Other fixed/variable
  const rfidTags  = inputs.transactions * r.rfidTagsPerTag;
  const labor     = inputs.laborRate * inputs.laborHours * 4.33; // weeks/mo
  const cellular  = r.cellular;
  const license   = r.licenseFee;

  // Totals (excl/ incl financing)
  const costsExFin = cogs + spoilageCost + engageFee + gatewayFee + swipeFee + merchantPct + rfidTags + labor + cellular + license + inputs.miscCosts;
  const costsInclFin = costsExFin + inputs.financing;

  // Profit (service fee is a positive credit to net profit, not revenue)
  const monthlyProfit = monthlyRevenue - costsInclFin + inputs.serviceFee;

  // ROI/payback use pre-financing profit (add financing back)
  const monthlyProfitPreFin = monthlyProfit + inputs.financing;
  const initialInvestment = 7500;
  const roi = (monthlyProfitPreFin * 12 / initialInvestment) * 100;
  const paybackMonths = initialInvestment / Math.max(1, monthlyProfitPreFin);

  return {
    // revenue
    monthlyRevenue, foodRevenue, bevRevenue,
    // costs parts
    cogs, spoilageCost, engageFee, gatewayFee, merchantPct, swipeFee, rfidTags, labor, cellular, license,
    costsExFin, costsInclFin,
    // finance & fee
    financing: inputs.financing, serviceFee: inputs.serviceFee,
    // output
    monthlyProfit, monthlyProfitPreFin, roi, paybackMonths
  };
}

function updateCalculations(){
  if(!accessValidated) return;

  const inputs = {
    fridgeCount: Math.max(1, parseInt(val('fridgeCount')||1)),
    transactions: val('transactions'),
    foodPrice: val('foodPrice'),
    beveragePrice: val('beveragePrice'),
    foodPercent: val('foodPercent'),
    beveragePercent: val('beveragePercent'),
    margin: val('margin'),
    spoilage: val('spoilage'),
    financing: val('financing'),
    laborRate: val('laborRate'),
    laborHours: val('laborHours'),
    miscCosts: val('miscCosts'),
    serviceFee: val('serviceFee')
  };

  const per = calculatePerFridge(inputs);

  const totalRevenue = per.monthlyRevenue * inputs.fridgeCount;
  const totalCosts   = per.costsInclFin   * inputs.fridgeCount;
  const totalProfit  = (per.monthlyProfit)* inputs.fridgeCount;

  setHtml('kpiRevenue', money(totalRevenue));
  setHtml('kpiCosts',   money(totalCosts));
  setHtmlClass('kpiProfit', money(totalProfit), totalProfit>=0 ? 'val good':'val bad');
  setHtmlClass('kpiAnnual', money(totalProfit*12), totalProfit>=0 ? 'val good':'val bad');
  setHtml('kpiROI', per.roi.toFixed(1)+'%');
  setHtml('kpiPayback', Math.round(per.paybackMonths)+' months');

  // Projection (simple)
  setHtml('y1', money(totalProfit*12));
  setHtml('y2', money(totalProfit*24));
  setHtml('y3', money(totalProfit*36));

  renderBreakdown(inputs, per);
}

function setHtml(id, html){ document.getElementById(id).innerHTML = html; }
function setHtmlClass(id, html, cls){ const el = document.getElementById(id); el.className = cls; el.innerHTML = html; }
function money(n){ return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',maximumFractionDigits:0}).format(n||0); }

/* ------------------ Breakdown ------------------ */
function renderBreakdown(inputs, per){
  const tbody = document.querySelector('#breakdownTable tbody');
  const pc = (v)=>money(v); // per-fridge
  const tc = (v)=>money(v*inputs.fridgeCount); // total all fridges

  const rows = [];

  // Costs
  rows.push(row('COGS', pc(per.cogs), tc(per.cogs)));
  rows.push(row('Spoilage (at cost)', pc(per.spoilageCost), tc(per.spoilageCost)));
  rows.push(row('Cellular', pc(per.cellular), tc(per.cellular)));
  rows.push(row('License Fee', pc(per.license), tc(per.license)));
  rows.push(row('Engage Txn Fees', pc(per.engageFee), tc(per.engageFee)));
  rows.push(row('Gateway Txn Fees', pc(per.gatewayFee), tc(per.gatewayFee)));
  rows.push(row('Merchant % Fee', pc(per.merchantPct), tc(per.merchantPct)));
  rows.push(row('Merchant Swipe Fee', pc(per.swipeFee), tc(per.swipeFee)));
  rows.push(row('RFID Tags', pc(per.rfidTags), tc(per.rfidTags)));
  rows.push(row('Labor', pc(per.labor), tc(per.labor)));
  rows.push(row('Miscellaneous', pc(inputs.miscCosts), tc(inputs.miscCosts)));
  rows.push(row('Financing', pc(per.financing), tc(per.financing)));

  // Total costs (incl financing)
  rows.push(rowStrong('Total Costs (incl. financing)', pc(per.costsInclFin), tc(per.costsInclFin)));

  // Service fee credit (applied to net profit)
  rows.push(rowCredit('Service Fee Credit (not included above)', pc(per.serviceFee), tc(per.serviceFee)));

  // Revenue (reference) — separated
  rows.push(`<tr><td colspan="3"><span class="rev-title">Revenue (for reference)</span></td></tr>`);
  rows.push(row('Food Revenue', pc(per.foodRevenue), tc(per.foodRevenue)));
  rows.push(row('Beverage Revenue', pc(per.bevRevenue), tc(per.bevRevenue)));

  tbody.innerHTML = rows.join('');
}

function row(name, p, t){
  return `<tr><td>${name}</td><td class="right">${p}</td><td class="right">${t}</td></tr>`;
}
function rowStrong(name, p, t){
  return `<tr class="tr-strong"><td>${name}</td><td class="right">${p}</td><td class="right">${t}</td></tr>`;
}
function rowCredit(name, p, t){
  return `<tr><td>${name}</td><td class="right green">-${p}</td><td class="right green">-${t}</td></tr>`;
}

/* ------------------ Share UI (kept minimal) ------------------ */
function openShare(){
  const createdBy = localStorage.getItem('dashboardUser') || 'Operator';
  const clientName = prompt('Client name (optional):','');
  if (clientName===null) return;
  jsonp('generateToken',{createdBy,clientName}).then(r=>{
    if(r.status!=='success'){ alert('Error: '+(r.message||'Failed')); return; }
    const link = r.data.shareUrl;
    navigator.clipboard.writeText(link).catch(()=>{});
    alert('Link copied:\n\n'+link+'\n\n(Expires in 7 days)');
  }).catch(()=>alert('Could not create link.'));
}

function openManage(){
  const createdBy = localStorage.getItem('dashboardUser') || '';
  jsonp('listTokens',{createdBy,onlyActive:'false',maxRows:'10'}).then(r=>{
    if(r.status!=='success'){ alert('Error loading links'); return; }
    const items = r.data.tokens||[];
    if(!items.length){ alert('No links yet.'); return; }
    const lines = items.map(t=>{
      const exp = t.expiresAt? new Date(t.expiresAt).toLocaleDateString():'';
      return `${t.clientName||'(no name)'}  —  ${t.shareUrl}  —  exp ${exp}`;
    }).join('\n\n');
    alert(lines);
  }).catch(()=>alert('Error loading links'));
}

/* ------------------ Init ------------------ */
window.addEventListener('DOMContentLoaded', initializeCalculator);
</script>
</body>
</html>
