<script>
  // ====== CONFIG: your deployed Apps Script URL ======
  const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbw1uRg1v6Cjqp9g2J-Q3CMsUzj1KbBfuiKnLgsYjhQe1n2x9bMSShB5eCw7mhA9-StC/exec';

  let allLeads = [];
  let currentEditId = null;
  let knownCompanies = [];

  window.addEventListener('DOMContentLoaded', () => {
    document.getElementById('saveBtn').addEventListener('click', onSaveClick);
    loadLeads();
    loadCompanyLists();
    setupPhoneFormatting();
  });

  function setupPhoneFormatting(){
    const phoneInput = document.getElementById('phoneNumber');
    phoneInput.addEventListener('input', (e) => {
      let v = e.target.value.replace(/\D/g,'');
      if (v.length >= 6) v = v.slice(0,3)+'-'+v.slice(3,6)+'-'+v.slice(6,10);
      else if (v.length >= 3) v = v.slice(0,3)+'-'+v.slice(3);
      e.target.value = v;
    });
    phoneInput.addEventListener('keypress', (e) => {
      const ch = String.fromCharCode(e.which);
      if (!/[0-9-]/.test(ch)) e.preventDefault();
    });
  }

  async function loadLeads(){
    try{
      document.getElementById('loadingState').style.display='block';
      document.getElementById('leadsTable').style.display='none';
      document.getElementById('emptyState').style.display='none';

      const res = await fetch(WEB_APP_URL + '?action=getLeads', { method:'GET' });
      const data = await res.json();
      if (data.status !== 'success') throw new Error(data.message || 'Failed to load leads');

      allLeads = data.leads || [];
      displayLeads(allLeads);
      updateRepFilter();
    }catch(err){
      console.error('loadLeads error:', err);
      document.getElementById('loadingState').style.display='none';
      document.getElementById('emptyState').style.display='block';
      showToast('Error loading leads. Please refresh.', 'error');
    }
  }

  async function loadCompanyLists(){
    try{
      const res = await fetch(WEB_APP_URL + '?action=getCompanies');
      const data = await res.json();
      if (data.status !== 'success') return;

      knownCompanies = data.companies || [];
      const dl = document.getElementById('companySuggestions');
      dl.innerHTML = '';
      knownCompanies.forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        dl.appendChild(opt);
      });

      const units = data.businessUnits || ['Abbondanza Vending','Quantum Solutions'];
      const sel = document.getElementById('companyFilter');
      sel.innerHTML = '<option value="">All Companies</option>';
      units.sort().forEach(u => {
        const o = document.createElement('option'); o.value = u; o.textContent = u;
        sel.appendChild(o);
      });
    }catch(e){
      console.warn('getCompanies failed (using defaults).', e);
    }
  }

  function displayLeads(leads){
    const tbody = document.getElementById('leadsTableBody');
    const table = document.getElementById('leadsTable');
    const loading = document.getElementById('loadingState');
    const empty = document.getElementById('emptyState');

    tbody.innerHTML = '';
    loading.style.display = 'none';

    if (!leads.length){
      table.style.display = 'none';
      empty.style.display = 'block';
      return;
    }
    table.style.display = 'table';
    empty.style.display = 'none';

    leads.forEach(lead => tbody.appendChild(createLeadRow(lead)));
  }

  function createLeadRow(lead){
    const row = document.createElement('tr');
    const leadId = Number(lead.id || lead.ID || lead.iD);

    const dateAdded = formatDate(lead.dateAdded);
    const followUp = formatDate(lead.followUp);
    const appointmentDate = formatDate(lead.appointmentDate);
    const statusClass = getStatusClass(lead.status);
    const appointmentClass = (lead.appointmentMade === 'Yes') ? 'appointment-yes' : 'appointment-no';
    const notes = lead.notes || '';

    const cells = [
      dateAdded,
      `<strong>${lead.companyName || ''}</strong>`,
      lead.contactName || '',
      lead.phoneNumber || '',
      lead.emailAddress || '',
      lead.repName || '',
      `<span class="status-badge ${statusClass}">${lead.status || 'Active'}</span>`,
      followUp,
      `<span class="${appointmentClass}">${lead.appointmentMade || 'No'}</span>`,
      appointmentDate,
      notes,
      `<div class="action-buttons">
         <button class="btn btn-small" style="background:#2563eb" onclick="editLead(${leadId})">Edit</button>
         <button class="btn btn-small" style="background:linear-gradient(135deg,#ed8936 0%,#dd6b20 100%)" onclick="archiveLead(${leadId})">Archive</button>
       </div>`
    ];

    cells.forEach(html => {
      const td = document.createElement('td');
      td.innerHTML = html;
      row.appendChild(td);
    });

    return row;
  }

  function getStatusClass(status){
    const map = {'Active':'status-active','Follow Up Later':'status-followup','Not Qualified':'status-notqualified','Dead':'status-dead'};
    return map[status] || 'status-active';
  }

  function formatDate(s){
    if (!s) return '';
    const d = new Date(s);
    if (isNaN(d)) return '';
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    const y = d.getFullYear();
    return `${m}/${day}/${y}`;
  }

  function filterLeads(){
    const rep = document.getElementById('repFilter').value.toLowerCase();
    const company = document.getElementById('companyFilter').value;
    const status = document.getElementById('statusFilter').value;
    const q = document.getElementById('searchInput').value.toLowerCase();

    const filtered = (allLeads || []).filter(l => {
      const matchRep = !rep || ((l.repName || '').toLowerCase().includes(rep));
      const matchStatus = !status ? true : ((l.status || '') === status);
      const matchCompany = !company ? true : ((l.businessUnit || '') === company);
      const matchSearch = !q ||
        (l.companyName && l.companyName.toLowerCase().includes(q)) ||
        (l.contactName && l.contactName.toLowerCase().includes(q)) ||
        (l.phoneNumber && String(l.phoneNumber).toLowerCase().includes(q)) ||
        (l.emailAddress && l.emailAddress.toLowerCase().includes(q));
      return matchRep && matchStatus && matchCompany && matchSearch;
    });

    displayLeads(filtered);
  }

  function updateRepFilter(){
    const sel = document.getElementById('repFilter');
    const reps = [...new Set((allLeads || []).map(l => l.repName).filter(Boolean))].sort();
    sel.innerHTML = '<option value="">All Reps</option>';
    reps.forEach(r => {
      const o = document.createElement('option'); o.value = r; o.textContent = r;
      sel.appendChild(o);
    });
  }

  function openAddLeadModal(){
    currentEditId = null;
    document.getElementById('modalTitle').textContent = 'Add New Lead';
    document.getElementById('leadForm').reset();
    document.getElementById('status').value = 'Active';
    document.getElementById('appointmentMade').value = 'No';
    toggleAppointmentDate();
    document.getElementById('leadModal').style.display = 'block';
  }

  function editLead(leadId){
    leadId = Number(leadId);
    const lead = (allLeads || []).find(l => Number(l.id || l.ID || l.iD) === leadId);
    if (!lead) return;

    currentEditId = leadId;
    document.getElementById('modalTitle').textContent = 'Edit Lead';

    document.getElementById('businessUnit').value = lead.businessUnit || '';
    document.getElementById('companyName').value = lead.companyName || '';
    document.getElementById('contactName').value = lead.contactName || '';
    document.getElementById('phoneNumber').value = lead.phoneNumber || '';
    document.getElementById('emailAddress').value = lead.emailAddress || '';
    document.getElementById('repName').value = lead.repName || '';
    document.getElementById('status').value = lead.status || 'Active';
    document.getElementById('appointmentMade').value = lead.appointmentMade || 'No';
    document.getElementById('notes').value = lead.notes || '';

    if (lead.followUp){
      const d = new Date(lead.followUp);
      if (!isNaN(d)) document.getElementById('followUp').value = d.toISOString().split('T')[0];
    }
    if (lead.appointmentDate){
      const d = new Date(lead.appointmentDate);
      if (!isNaN(d)) document.getElementById('appointmentDate').value = d.toISOString().split('T')[0];
    }

    toggleAppointmentDate();
    document.getElementById('leadModal').style.display = 'block';
  }

  function closeModal(){
    document.getElementById('leadModal').style.display = 'none';
    document.getElementById('leadForm').reset();
    currentEditId = null;
  }

  function toggleAppointmentDate(){
    const show = document.getElementById('appointmentMade').value === 'Yes';
    document.getElementById('appointmentDateGroup').style.display = show ? 'block' : 'none';
  }

  // ---------- SAVE (Add/Update) ----------
  async function onSaveClick(e){
    e.preventDefault();
    const formEl = document.getElementById('leadForm');

    if (!formEl.checkValidity()){
      formEl.reportValidity();
      return;
    }

    const form = new FormData(formEl);
    const lead = Object.fromEntries(form.entries());
    const saveBtn = document.getElementById('saveBtn');
    const originalText = saveBtn.textContent;

    saveBtn.disabled = true;
    saveBtn.textContent = 'Saving...';

    try{
      const isUpdate = !!currentEditId;
      const action = isUpdate ? 'updateLead' : 'addLead';
      const url = WEB_APP_URL + '?action=' + encodeURIComponent(action)
        + (isUpdate ? ('&leadId=' + Number(currentEditId)) : '');

      // âœ… include action (and leadId) in the JSON body too
      const payload = isUpdate
        ? { action: 'updateLead', leadId: Number(currentEditId), updates: lead }
        : { action: 'addLead', lead: lead };

      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify(payload)
      });

      if (!res.ok) throw new Error(`Network ${res.status}`);
      const out = await res.json();
      if (out.status !== 'success') throw new Error(out.message || 'Save failed');

      showToast(isUpdate ? 'Lead updated!' : 'Lead added!', 'success');
      closeModal();
      await loadLeads();
    }catch(err){
      console.error('save error:', err);
      showToast('Error saving lead: ' + err.message, 'error');
    }finally{
      saveBtn.disabled = false;
      saveBtn.textContent = originalText;
    }
  }

  // ---------- Archive ----------
  function archiveLead(leadId){
    if (!confirm('Archive this lead?')) return;
    leadId = Number(leadId);
    const url = WEB_APP_URL + '?action=archiveLead&leadId=' + leadId;

    const payload = { action: 'archiveLead', leadId };

    fetch(url, {
      method:'POST',
      headers:{ 'Content-Type':'text/plain;charset=utf-8' },
      body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(out => {
      if (out.status !== 'success') throw new Error(out.message || 'Archive failed');
      showToast('Lead archived', 'success');
      loadLeads();
    })
    .catch(err => {
      console.error(err);
      showToast('Error archiving lead: ' + err.message, 'error');
    });
  }

  function showToast(msg, type='success'){
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.className = 'toast ' + type;
    el.style.position = 'fixed';
    el.style.bottom = '20px';
    el.style.right = '20px';
    el.style.background = type === 'success'
      ? 'linear-gradient(135deg,#48bb78 0%,#38a169 100%)'
      : 'linear-gradient(135deg,#e53e3e 0%,#c53030 100%)';
    el.style.color = '#fff';
    el.style.padding = '16px 24px';
    el.style.borderRadius = '8px';
    el.style.boxShadow = '0 4px 12px rgba(0,0,0,.2)';
    el.style.display = 'block';
    setTimeout(() => { el.style.display = 'none'; }, 3000);
  }

  window.onclick = function(e){
    const m = document.getElementById('leadModal');
    if (e.target === m) closeModal();
  }

  // Expose
  window.openAddLeadModal = openAddLeadModal;
  window.editLead = editLead;
  window.archiveLead = archiveLead;
  window.toggleAppointmentDate = toggleAppointmentDate;
  window.filterLeads = filterLeads;
  window.goToDashboard = () => { window.location.href = 'index.html'; };
</script>
