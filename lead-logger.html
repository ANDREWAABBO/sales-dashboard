<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lead Logging System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            animation: fadeIn 0.8s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Form Section */
        .form-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            margin-bottom: 30px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 600;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
            width: 100%;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            display: inline-block;
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            border-radius: 30px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
            margin-left: 10px;
        }

        /* Table Section */
        .table-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .filter-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-controls select,
        .filter-controls input {
            padding: 8px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 14px;
        }

        .table-wrapper {
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            margin: -1px;
            padding: 1px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
            table-layout: fixed;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 8px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            white-space: normal;
            word-wrap: break-word;
            z-index: 10;
            vertical-align: middle;
        }

        /* Fixed column widths to prevent jumping */
        th:nth-child(1), td:nth-child(1) { width: 80px; } /* Date Added */
        th:nth-child(2), td:nth-child(2) { width: 140px; } /* Company Name */
        th:nth-child(3), td:nth-child(3) { width: 140px; } /* Contact Name */
        th:nth-child(4), td:nth-child(4) { width: 120px; } /* Phone Number */
        th:nth-child(5), td:nth-child(5) { width: 160px; } /* Email Address */
        th:nth-child(6), td:nth-child(6) { width: 100px; } /* Rep Name */
        th:nth-child(7), td:nth-child(7) { width: 80px; } /* Follow Up */
        th:nth-child(8), td:nth-child(8) { width: 100px; } /* Status */
        th:nth-child(9), td:nth-child(9) { width: 80px; } /* Appt Made */
        th:nth-child(10), td:nth-child(10) { width: 80px; } /* Appt Date */
        th:nth-child(11), td:nth-child(11) { width: 200px; } /* Notes */
        th:nth-child(12), td:nth-child(12) { width: 80px; } /* Actions */

        td {
            padding: 0;
            border-bottom: 1px solid #e2e8f0;
            height: 50px;
            vertical-align: middle;
        }

        td.notes-cell {
            overflow: visible;
        }

        /* Remove old styling */
        thead {
            display: table-header-group;
        }

        tbody {
            display: table-row-group;
        }

        tbody tr {
            display: table-row;
        }

        tr {
            height: 50px;
        }

        tr:hover {
            background-color: #f7fafc;
        }

        .editable-cell {
            cursor: pointer;
            display: block;
            padding: 15px 8px;
            height: 50px;
            line-height: 20px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            box-sizing: border-box;
            position: relative;
        }

        /* Notes hover tooltip - fixed positioning and wrapping */
        .notes-cell {
            position: relative;
        }

        .notes-cell .editable-cell {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative;
            max-width: 180px;
        }

        .notes-tooltip {
            position: fixed;
            display: none;
            background: #2d3748;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.6;
            max-width: 400px;
            min-width: 200px;
            z-index: 10000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            white-space: pre-wrap;
            word-wrap: break-word;
            word-break: break-word;
        }

        .notes-tooltip::after {
            content: '';
            position: absolute;
            bottom: var(--arrow-bottom, -6px);
            top: var(--arrow-top, auto);
            left: 20px;
            width: 12px;
            height: 12px;
            background: #2d3748;
            transform: var(--arrow-transform, rotate(45deg));
        }

        /* Show tooltip on hover */
        .notes-cell:hover .notes-tooltip.has-content {
            display: block;
        }

        .editable-cell:hover {
            background-color: #edf2f7;
        }

        .edit-input {
            position: absolute;
            top: 1px;
            left: 1px;
            right: 1px;
            bottom: 1px;
            width: calc(100% - 2px);
            height: calc(100% - 2px);
            padding: 13px 8px;
            border: 2px solid #667eea;
            border-radius: 5px;
            font-size: 14px;
            font-family: inherit;
            background-color: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
            margin: 0;
        }

        .edit-input[type="date"] {
            cursor: pointer;
            padding: 10px 8px;
        }

        textarea.edit-input {
            min-height: 80px;
            height: auto;
            resize: vertical;
            position: relative;
        }

        .edit-input:focus {
            outline: none;
            border-color: #764ba2;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        .status-select {
            padding: 5px 10px;
            border: 2px solid #e2e8f0;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            background-color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
            max-width: 120px;
        }

        .status-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .action-btn {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .action-btn.archive {
            background-color: #ef4444;
            color: white;
        }

        .action-btn.archive:hover {
            background-color: #dc2626;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .message {
            padding: 12px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .message.success {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .message.error {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }

        /* Back button */
        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            text-decoration: none;
            border-radius: 10px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(-5px);
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .empty-state h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .table-header {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-controls {
                flex-direction: column;
                width: 100%;
            }

            .filter-controls select,
            .filter-controls input {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container" style="max-width: 100% !important; width: 100% !important; padding: 0 10px !important;">
        <button onclick="goBack()" class="back-btn">‚Üê Back to Dashboard</button>
        
        <div class="header">
            <h1>Lead Logging System</h1>
        </div>

        <div class="message" id="message"></div>

        <!-- Add New Lead Form -->
        <div class="form-section" style="max-width: 100% !important; margin: 0 0 20px 0 !important;">
            <h2 style="margin-bottom: 20px; color: #2d3748;">Add New Lead</h2>
            <form id="leadForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="companyName">Company Name*</label>
                        <input type="text" id="companyName" name="companyName" required>
                    </div>
                    <div class="form-group">
                        <label for="contactName">Contact Name*</label>
                        <input type="text" id="contactName" name="contactName" required>
                    </div>
                    <div class="form-group">
                        <label for="phoneNumber">Phone Number*</label>
                        <input type="tel" id="phoneNumber" name="phoneNumber" required>
                    </div>
                    <div class="form-group">
                        <label for="emailAddress">Email Address</label>
                        <input type="email" id="emailAddress" name="emailAddress">
                    </div>
                    <div class="form-group">
                        <label for="repName">Rep Name*</label>
                        <input type="text" id="repName" name="repName" placeholder="Enter your name" required>
                    </div>
                    <div class="form-group">
                        <label for="followUp">Follow Up Date</label>
                        <input type="date" id="followUp" name="followUp">
                    </div>
                    <div class="form-group full-width">
                        <label for="notes">Notes</label>
                        <textarea id="notes" name="notes" placeholder="Add any notes about this lead..."></textarea>
                    </div>
                </div>
                <button type="submit" class="btn" id="submitBtn">Add Lead</button>
                <button type="button" class="btn btn-secondary" onclick="resetForm()">Clear Form</button>
            </form>
        </div>

        <!-- Leads Table -->
        <div class="table-section" style="max-width: 100% !important; margin: 0 !important;">
            <div class="table-header">
                <h2 style="color: #2d3748;">Lead Database</h2>
                <div class="filter-controls">
                    <select id="repFilter" onchange="filterLeads()">
                        <option value="">All Reps</option>
                    </select>
                    <select id="statusFilter" onchange="filterLeads()">
                        <option value="">All Status</option>
                        <option value="Active">Active</option>
                        <option value="Not Qualified">Not Qualified</option>
                        <option value="Follow Up Later">Follow Up Later</option>
                        <option value="Dead">Dead</option>
                    </select>
                    <input type="text" id="searchBox" placeholder="Search leads..." onkeyup="filterLeads()">
                </div>
            </div>
            <div class="loading" id="loading">Loading leads...</div>
            <div class="table-wrapper">
                <div class="table-scroll">
                    <table id="leadsTable">
                        <colgroup>
                            <col>
                            <col>
                            <col>
                            <col>
                            <col>
                            <col>
                            <col>
                            <col>
                            <col>
                            <col>
                            <col>
                            <col>
                        </colgroup>
                        <thead>
                            <tr>
                                <th>Date Added</th>
                                <th>Company Name</th>
                                <th>Contact Name</th>
                                <th>Phone Number</th>
                                <th>Email Address</th>
                                <th>Rep Name</th>
                                <th>Follow Up</th>
                                <th>Status</th>
                                <th>Appt Made</th>
                                <th>Appt Date</th>
                                <th>Notes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="leadsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Force full width on load
        window.addEventListener('DOMContentLoaded', function() {
            // Override any inherited styles
            document.documentElement.style.width = '100%';
            document.documentElement.style.maxWidth = '100%';
            document.body.style.width = '100%';
            document.body.style.maxWidth = '100%';
            
            const container = document.querySelector('.container');
            if (container) {
                container.style.maxWidth = '100%';
                container.style.width = '100%';
                container.style.padding = '0 10px';
            }
            
            const formSection = document.querySelector('.form-section');
            if (formSection) {
                formSection.style.maxWidth = '100%';
                formSection.style.margin = '0 0 20px 0';
            }
            
            const tableSection = document.querySelector('.table-section');
            if (tableSection) {
                tableSection.style.maxWidth = '100%';
                tableSection.style.margin = '0';
            }
        });

        // Back button function
        function goBack() {
            window.location.replace('index.html');
        }
        
        // Google Sheets Integration
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxhceN7x_YJGrZVVG9nVU6wqb-lJhxxxY7Z-19ZAaimNLQ201XLOWV8zG73L5W6hrh4/exec';

        let leadsData = [];
        let currentEditingCell = null;

        // Load leads on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadLeads();
            
            // Load saved rep name if exists
            const savedRepName = localStorage.getItem('leadLoggerRepName');
            if (savedRepName) {
                document.getElementById('repName').value = savedRepName;
            }
        });

        // Form submission
        document.getElementById('leadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const repName = formData.get('repName');
            
            // Save rep name for next time
            localStorage.setItem('leadLoggerRepName', repName);
            
            const leadData = {
                companyName: formData.get('companyName').trim(),
                contactName: formData.get('contactName').trim(),
                phoneNumber: formData.get('phoneNumber').trim(),
                emailAddress: formData.get('emailAddress').trim() || '',
                repName: repName.trim(),
                followUp: formData.get('followUp') || '',
                notes: formData.get('notes').trim() || ''
            };

            // Show loading
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('submitBtn').textContent = 'Adding...';

            try {
                // Send to Google Sheets
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: JSON.stringify({
                        action: 'addLead',
                        lead: leadData
                    })
                });

                const result = await response.json();
                if (result.status === 'success') {
                    showMessage('Lead added successfully!', 'success');
                    resetForm();
                    
                    // Keep rep name filled
                    document.getElementById('repName').value = repName;
                    
                    await loadLeads(); // Reload the leads
                } else {
                    throw new Error(result.message || 'Failed to add lead');
                }
                
            } catch (error) {
                showMessage('Error adding lead. Please try again.', 'error');
                console.error('Error:', error);
            } finally {
                document.getElementById('submitBtn').disabled = false;
                document.getElementById('submitBtn').textContent = 'Add Lead';
            }
        });

        // Load and display leads from Google Sheets
        async function loadLeads() {
            document.getElementById('loading').style.display = 'block';
            
            try {
                const response = await fetch(SCRIPT_URL + '?action=getActiveLeads');
                const data = await response.json();
                
                if (data.status === 'success') {
                    // Filter out any test data
                    leadsData = (data.leads || []).filter(lead => {
                        // Skip if company name starts with TEST or is empty
                        return lead.companyName && 
                               !lead.companyName.toUpperCase().startsWith('TEST') &&
                               lead.companyName.trim() !== '';
                    });
                    
                    displayLeads();
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                console.error('Error loading leads:', error);
                showMessage('Error loading leads. Please refresh the page.', 'error');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // Display leads in table
        function displayLeads() {
            const tbody = document.getElementById('leadsTableBody');
            tbody.innerHTML = '';
            
            // Get unique rep names for filter
            const uniqueReps = [...new Set(leadsData.map(lead => lead.repName))].filter(Boolean).sort();
            updateRepFilter(uniqueReps);
            
            if (leadsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" class="empty-state"><h3>No leads found</h3><p>Add your first lead using the form above.</p></td></tr>';
                return;
            }
            
            // Add each lead as a row
            leadsData.forEach(lead => {
                if (lead.status !== 'Dead') {
                    const row = createLeadRow(lead);
                    tbody.appendChild(row);
                    
                    // Add click handlers after row is added to DOM
                    const leadId = lead.id || lead.iD || lead.ID;
                    
                    // Add click handlers for editable cells
                    row.querySelectorAll('.editable-cell').forEach((cell, index) => {
                        const parent = cell.parentElement;
                        const cellIndex = parent.cellIndex;
                        
                        console.log('Setting up cell:', index, 'Parent cellIndex:', cellIndex, 'Text:', cell.textContent.substring(0, 20));
                        
                        if (cellIndex === 1) { // Company Name
                            cell.onclick = () => window.makeEditable(cell, leadId, 'companyName');
                        } else if (cellIndex === 2) { // Contact Name
                            cell.onclick = () => window.makeEditable(cell, leadId, 'contactName');
                        } else if (cellIndex === 3) { // Phone Number
                            cell.onclick = () => window.makeEditable(cell, leadId, 'phoneNumber');
                        } else if (cellIndex === 4) { // Email
                            cell.onclick = () => window.makeEditable(cell, leadId, 'emailAddress');
                        } else if (cellIndex === 5) { // Rep Name
                            cell.onclick = () => window.makeEditable(cell, leadId, 'repName');
                        } else if (cellIndex === 6) { // Follow Up
                            cell.onclick = () => window.makeEditable(cell, leadId, 'followUp');
                        } else if (cellIndex === 9) { // Appt Date
                            cell.onclick = () => window.makeEditable(cell, leadId, 'appointmentDate');
                        } else if (cellIndex === 10) { // Notes
                            console.log('Setting notes click handler for cell:', cell);
                            cell.style.backgroundColor = '#f0f0f0'; // Visual indicator
                            cell.onclick = function(e) {
                                e.stopPropagation();
                                console.log('Notes clicked!', leadId);
                                console.log('Cell element:', cell);
                                console.log('Cell content:', cell.textContent);
                                
                                try {
                                    // Try calling directly
                                    makeEditable(cell, leadId, 'notes');
                                } catch (error) {
                                    console.error('Error calling makeEditable:', error);
                                }
                            };
                        }
                    });
                }
            });
        }

        // Create table row for a lead
        function createLeadRow(lead) {
            const leadId = lead.id || lead.iD || lead.ID;
            const row = document.createElement('tr');
            
            // Format dates
            const dateAdded = formatDate(lead.dateAdded);
            const followUpDate = formatDate(lead.followUp);
            const apptDate = formatDate(lead.appointmentDate);
            
            row.innerHTML = `
                <td style="padding: 8px; text-align: center;">${dateAdded}</td>
                <td><div class="editable-cell">${sanitizeText(lead.companyName) || ''}</div></td>
                <td><div class="editable-cell">${sanitizeText(lead.contactName) || ''}</div></td>
                <td><div class="editable-cell">${sanitizeText(lead.phoneNumber) || ''}</div></td>
                <td><div class="editable-cell">${sanitizeText(lead.emailAddress) || ''}</div></td>
                <td><div class="editable-cell">${sanitizeText(lead.repName) || ''}</div></td>
                <td><div class="editable-cell">${followUpDate || 'Set date'}</div></td>
                <td style="padding: 8px;">
                    <select class="status-select" onchange="updateStatus(this, ${leadId})">
                        <option value="Active" ${lead.status === 'Active' ? 'selected' : ''}>Active</option>
                        <option value="Not Qualified" ${lead.status === 'Not Qualified' ? 'selected' : ''}>Not Qualified</option>
                        <option value="Follow Up Later" ${lead.status === 'Follow Up Later' ? 'selected' : ''}>Follow Up Later</option>
                        <option value="Dead" ${lead.status === 'Dead' ? 'selected' : ''}>Dead (Archive)</option>
                    </select>
                </td>
                <td style="padding: 8px;">
                    <select class="status-select" onchange="updateAppointmentMade(this, ${leadId})">
                        <option value="No" ${(lead.appointmentMade || 'No') === 'No' ? 'selected' : ''}>No</option>
                        <option value="Yes" ${lead.appointmentMade === 'Yes' ? 'selected' : ''}>Yes</option>
                    </select>
                </td>
                <td><div class="editable-cell">${apptDate || 'Set date'}</div></td>
                <td class="notes-cell">
                    <div class="editable-cell" 
                         style="cursor: pointer;"
                         ${lead.notes && lead.notes.length > 20 ? `title="${sanitizeText(lead.notes)}"` : ''}>
                        ${sanitizeText(lead.notes) || 'Add notes'}
                    </div>
                </td>
                <td style="padding: 8px;">
                    <button class="action-btn archive" onclick="archiveLead(${leadId})">Archive</button>
                </td>
            `;
            
            return row;
        }

        // Sanitize text to remove newlines and trim
        function sanitizeText(text) {
            if (!text) return '';
            return String(text).replace(/[\r\n]+/g, ' ').trim();
        }

        // Update rep filter dropdown
        function updateRepFilter(reps) {
            const repFilter = document.getElementById('repFilter');
            repFilter.innerHTML = '<option value="">All Reps</option>';
            
            reps.forEach(rep => {
                const option = document.createElement('option');
                option.value = rep;
                option.textContent = rep;
                repFilter.appendChild(option);
            });
        }

        // Format date to MM/DD/YY
        function formatDate(dateValue) {
            if (!dateValue) return '';
            try {
                const date = new Date(dateValue);
                if (isNaN(date.getTime())) return '';
                
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                const year = date.getFullYear().toString().slice(-2);
                return `${month}/${day}/${year}`;
            } catch (e) {
                return '';
            }
        }

        // Make cell editable - final stable approach
        function makeEditable(cell, leadId, field) {
            // Check if already editing
            if (cell.querySelector('input, textarea')) return;
            
            const currentText = cell.textContent.trim();
            const isPlaceholder = currentText === 'Set date' || currentText === 'Add notes';
            
            // Save dimensions
            const cellRect = cell.getBoundingClientRect();
            cell.style.width = cellRect.width + 'px';
            cell.style.height = cellRect.height + 'px';
            cell.style.position = 'relative';
            
            // Hide text but keep it for spacing
            const textSpan = document.createElement('span');
            textSpan.textContent = currentText;
            textSpan.style.visibility = 'hidden';
            
            if (field === 'followUp' || field === 'appointmentDate') {
                const input = document.createElement('input');
                input.className = 'edit-input';
                input.type = 'date';
                
                if (!isPlaceholder && currentText) {
                    const parts = currentText.split('/');
                    if (parts.length === 3) {
                        const year = parts[2].length === 2 ? '20' + parts[2] : parts[2];
                        const month = parts[0].padStart(2, '0');
                        const day = parts[1].padStart(2, '0');
                        input.value = `${year}-${month}-${day}`;
                    }
                }
                
                const restore = () => {
                    if (input.value === '') {
                        // If cleared, show "Set date"
                        cell.textContent = 'Set date';
                    } else {
                        cell.textContent = currentText;
                    }
                    cell.style.width = '';
                    cell.style.height = '';
                    cell.style.position = '';
                };
                
                const save = async () => {
                    // Always save the value, even if empty
                    await updateLead(leadId, field, input.value);
                    if (input.value) {
                        cell.textContent = formatDate(input.value);
                    } else {
                        cell.textContent = 'Set date';
                    }
                    cell.style.width = '';
                    cell.style.height = '';
                    cell.style.position = '';
                };
                
                // Listen for both change and input events to catch clearing
                input.addEventListener('change', function() {
                    save();
                });
                
                input.addEventListener('input', function() {
                    if (input.value === '') {
                        save();
                    }
                });
                input.addEventListener('blur', function(e) {
                    setTimeout(() => {
                        if (!cell.contains(document.activeElement)) {
                            restore();
                        }
                    }, 200);
                });
                
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        restore();
                    }
                });
                
                cell.innerHTML = '';
                cell.appendChild(textSpan);
                cell.appendChild(input);
                input.focus();
                
                // Open picker
                setTimeout(() => {
                    try {
                        input.showPicker();
                    } catch (e) {}
                }, 10);
                
            } else {
                const isNotes = field === 'notes';
                const input = document.createElement(isNotes ? 'textarea' : 'input');
                input.className = 'edit-input';
                input.value = isPlaceholder ? '' : currentText;
                
                if (isNotes) {
                    input.style.position = 'relative';
                    cell.style.height = 'auto';
                    cell.style.minHeight = cellRect.height + 'px';
                }
                
                const restore = () => {
                    cell.textContent = currentText;
                    cell.style.width = '';
                    cell.style.height = '';
                    cell.style.minHeight = '';
                    cell.style.position = '';
                };
                
                const save = async () => {
                    const newValue = input.value.trim();
                    if (newValue !== currentText || (isPlaceholder && newValue)) {
                        await updateLead(leadId, field, newValue);
                        // Update cell with new content including tooltip if needed
                        if (isNotes) {
                            cell.textContent = newValue || 'Add notes';
                            
                            // Update parent td with tooltip
                            const parentTd = cell.parentElement;
                            parentTd.setAttribute('data-notes', newValue);
                            
                            // Remove old tooltip if exists
                            const oldTooltip = parentTd.querySelector('.notes-tooltip');
                            if (oldTooltip) oldTooltip.remove();
                            
                            // Add new tooltip
                            const tooltip = document.createElement('div');
                            tooltip.className = 'notes-tooltip';
                            if (newValue && newValue.length > 20) {
                                tooltip.classList.add('has-content');
                                tooltip.textContent = newValue;
                            }
                            parentTd.appendChild(tooltip);
                        } else {
                            cell.textContent = newValue || '';
                        }
                    } else {
                        cell.textContent = currentText;
                    }
                    cell.style.width = '';
                    cell.style.height = '';
                    cell.style.minHeight = '';
                    cell.style.position = '';
                };
                
                input.addEventListener('blur', save);
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && (!isNotes || e.ctrlKey)) {
                        e.preventDefault();
                        save();
                    }
                    if (e.key === 'Escape') {
                        restore();
                    }
                });
                
                cell.innerHTML = '';
                cell.appendChild(textSpan);
                cell.appendChild(input);
                input.focus();
                if (!isNotes) {
                    input.select();
                }
            }
        }

        // Update status
        async function updateStatus(selectElement, leadId) {
            const newStatus = selectElement.value;
            
            if (newStatus === 'Dead') {
                if (confirm('Setting status to "Dead" will archive this lead. Continue?')) {
                    await updateLead(leadId, 'status', newStatus);
                } else {
                    // Reset to previous value
                    const lead = leadsData.find(l => (l.id || l.iD) === leadId);
                    if (lead) {
                        selectElement.value = lead.status;
                    }
                }
            } else {
                await updateLead(leadId, 'status', newStatus);
            }
        }

        // Update appointment made status
        async function updateAppointmentMade(selectElement, leadId) {
            await updateLead(leadId, 'appointmentMade', selectElement.value);
        }

        // Update lead data
        async function updateLead(leadId, field, value) {
            try {
                const updates = {};
                // Explicitly handle empty strings for dates
                updates[field] = value === '' ? '' : value;
                
                console.log('Updating lead:', leadId, field, value); // Debug log
                
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: JSON.stringify({
                        action: 'updateLead',
                        leadId: leadId,
                        updates: updates
                    })
                });
                
                const result = await response.json();
                if (result.status === 'success') {
                    showMessage('Lead updated successfully!', 'success');
                    
                    // Update local data
                    const lead = leadsData.find(l => (l.id || l.iD) === leadId);
                    if (lead) {
                        lead[field] = value;
                    }
                    
                    // If status changed to Dead, reload to remove from list
                    if (field === 'status' && value === 'Dead') {
                        setTimeout(() => loadLeads(), 500);
                    }
                } else {
                    throw new Error(result.message || 'Failed to update lead');
                }
            } catch (error) {
                console.error('Error updating lead:', error);
                showMessage('Error updating lead. Please try again.', 'error');
                // Reload to restore original state
                setTimeout(() => loadLeads(), 1000);
            }
        }

        // Archive lead
        async function archiveLead(leadId) {
            if (confirm('Archive this lead? This will remove it from the active list.')) {
                await updateLead(leadId, 'status', 'Dead');
            }
        }

        // Filter leads
        function filterLeads() {
            const repFilter = document.getElementById('repFilter').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value.toLowerCase();
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            
            const rows = document.querySelectorAll('#leadsTableBody tr');
            
            rows.forEach(row => {
                // Skip empty state row
                if (row.querySelector('.empty-state')) return;
                
                const cells = row.querySelectorAll('td');
                const repName = cells[5]?.textContent.toLowerCase() || '';
                const status = row.querySelector('.status-select')?.value.toLowerCase() || '';
                
                let showRow = true;
                
                // Apply filters
                if (repFilter && repName !== repFilter) showRow = false;
                if (statusFilter && status !== statusFilter) showRow = false;
                
                // Search filter
                if (searchTerm && showRow) {
                    let matchFound = false;
                    cells.forEach(cell => {
                        if (cell.textContent.toLowerCase().includes(searchTerm)) {
                            matchFound = true;
                        }
                    });
                    if (!matchFound) showRow = false;
                }
                
                row.style.display = showRow ? '' : 'none';
            });
        }

        // Reset form
        function resetForm() {
            document.getElementById('leadForm').reset();
            // Keep rep name
            const savedRepName = localStorage.getItem('leadLoggerRepName');
            if (savedRepName) {
                document.getElementById('repName').value = savedRepName;
            }
        }

        // Show message
        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message ${type}`;
            messageEl.style.display = 'block';
            
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 3000);
        }
    </script>
</body>
</html>
