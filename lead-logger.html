<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lead Logger - Abbondanza Sales</title>
  <!-- Add SheetJS for Excel functionality -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;background:#1e3a8a;min-height:100vh;padding:20px}
    .container{max-width:98%;margin:0 auto;background:rgba(255,255,255,.95);border-radius:20px;padding:30px;box-shadow:0 20px 40px rgba(0,0,0,.1)}
    h1{color:#2d3748;margin-bottom:30px;text-align:center;font-size:2.2rem}

    /* STICKY CONTROLS - Stay at top when scrolling */
    .controls{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;flex-wrap:wrap;gap:15px;position:sticky;top:0;z-index:100;background:rgba(255,255,255,.98);padding:15px 0;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
    
    .btn{padding:12px 24px;background:#1e3a8a;color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600;transition:.2s;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
    .btn:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(30,58,138,.35);background:#1e40af}
    .btn-secondary{background:linear-gradient(135deg,#48bb78 0%,#38a169 100%)}
    .btn svg{width:16px;height:16px;flex-shrink:0}
    .filters{display:flex;gap:15px;align-items:center;flex-wrap:wrap}
    select,input[type="search"]{padding:10px 15px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;background:#fff;transition:border-color .2s}
    select:focus,input[type="search"]:focus{outline:none;border-color:#667eea}

    /* IMPROVED TABLE WITH SCROLLING AND CENTERED TEXT */
    .table-container{overflow:auto;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.1);max-height:70vh;position:relative}
    table{width:100%;border-collapse:collapse;background:#fff;min-width:1400px}
    th{background:#1e3a8a;color:#fff;padding:15px;text-align:center;font-weight:600;position:sticky;top:0;z-index:10;white-space:nowrap;border-bottom:1px solid #cbd5e1}
    td{padding:15px;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:250px;border-bottom:none;vertical-align:middle}
    tbody tr{border-bottom:1px solid #e2e8f0}
    tbody tr:last-child{border-bottom:none}
    tr:hover{background:#f7fafc}
    td:nth-child(2){white-space:normal;word-break:break-word;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;max-width:260px}
    
    /* Notes column with hover tooltip functionality */
    td:nth-child(11){
      white-space:normal;
      word-break:break-word;
      overflow:hidden;
      display:-webkit-box;
      -webkit-line-clamp:3;
      -webkit-box-orient:vertical;
      max-width:420px;
      vertical-align:top;
      line-height:1.4;
      padding:12px 15px;
      position:relative;
      cursor:pointer;
    }

    /* Tooltip styles for notes hover */
    .notes-tooltip {
      position: absolute;
      background: #2d3748;
      color: white;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.4;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
      z-index: 1000;
      max-width: 400px;
      word-wrap: break-word;
      white-space: normal;
      opacity: 0;
      transform: translateY(-10px);
      transition: opacity 0.2s, transform 0.2s;
      pointer-events: none;
    }
    
    .notes-tooltip.show {
      opacity: 1;
      transform: translateY(0);
    }
    
    .notes-tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 20px;
      border: 8px solid transparent;
      border-top-color: #2d3748;
    }

    .status-badge{padding:6px 12px;border-radius:20px;font-size:12px;font-weight:600;display:inline-block}
    .status-active{background:#d4f1d4;color:#2d5a2d}
    .status-followup{background:#fff3cd;color:#856404}
    .status-notqualified{background:#f8d7da;color:#721c24}
    .status-dead{background:#e2e8f0;color:#718096}
    .appointment-yes{color:#48bb78;font-weight:600}
    .appointment-no{color:#e53e3e}
    .empty-state{text-align:center;padding:60px 20px;color:#718096}
    .empty-state h3{font-size:1.25rem;margin-bottom:10px;color:#4a5568}
    .loading{text-align:center;padding:40px;color:#718096}
    .spinner{display:inline-block;width:40px;height:40px;border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

    /* --- MODAL: static backdrop, no accidental close --- */
    .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.5);animation:fadeIn .2s ease}
    .modal-content{background:#fff;margin:5% auto;padding:30px;border-radius:12px;width:90%;max-width:620px;box-shadow:0 20px 40px rgba(0,0,0,.2);animation:slideIn .2s ease}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes slideIn{from{transform:translateY(-40px);opacity:0}to{transform:translateY(0);opacity:1}}
    .close{color:#aaa;float:right;font-size:28px;font-weight:700;cursor:pointer}
    .close:hover{color:#000}
    
    .section-header{font-size:1.3em;font-weight:600;color:#2d3748;margin:25px 0 15px 0;padding-bottom:8px;border-bottom:2px solid #e2e8f0}
    .form-group{margin-bottom:16px}
    .form-group label{display:block;margin-bottom:6px;color:#4a5568;font-weight:600}
    .form-group input,.form-group select,.form-group textarea{width:100%;padding:10px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;transition:border-color .2s}
    .form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:#667eea}
    .form-group small{display:block;margin-top:5px;color:#718096;font-size:0.9em}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:15px}
    .form-actions{display:flex;gap:10px;margin-top:18px;justify-content:flex-end}
    .btn-cancel{background:linear-gradient(135deg,#a0aec0 0%,#718096 100%)}
    .action-buttons{display:flex;gap:8px;flex-wrap:wrap}
    .btn-small{padding:6px 12px;font-size:12px;border-radius:6px;white-space:nowrap}
    #leadModal .modal-content{max-height:90vh;display:flex;flex-direction:column;overflow-y:auto}
    #leadModal .form-actions{position:sticky;bottom:0;background:#fff;padding-top:12px;margin-top:12px;border-top:1px solid #e2e8f0;z-index:1}

    /* Import Modal Styles */
    #importModal .modal-content{max-width:800px}
    .file-preview{background:#f7fafc;padding:15px;border-radius:8px;margin:15px 0}
    .file-preview table{font-size:12px;border-collapse:collapse}
    .file-preview th{background:#1e3a8a;color:white;padding:8px;text-align:left;border:1px solid #ccc}
    .file-preview td{border:1px solid #ccc;padding:8px}
    
    /* Proposal Modal Styles */
    .pricing-info{background:#f0f8ff;padding:15px;border-radius:8px;margin:15px 0;border:2px solid #b3d9ff}
    .pricing-info h3{margin:0 0 10px 0;color:#2c5aa0;font-size:1.2em}
    .pricing-display{font-size:16px;color:#2c5aa0;font-weight:bold}

    /* DELETE CONFIRMATION MODAL */
    .delete-modal .modal-content{max-width:500px;text-align:center}
    .delete-modal h2{color:#e53e3e;margin-bottom:20px}
    .delete-modal .company-name{background:#f8d7da;padding:10px;border-radius:8px;margin:15px 0;font-weight:bold;color:#721c24}
    .delete-modal input{text-align:center;font-size:16px;font-weight:bold;margin:15px 0}
    .btn-danger{background:linear-gradient(135deg,#e53e3e 0%,#c53030 100%)}
    .btn-danger:hover{background:linear-gradient(135deg,#c53030 0%,#9b2c2c 100%)}

    /* Inline SVG icon styling */
    .icon-inline{display:inline-flex;align-items:center;justify-content:center;vertical-align:middle}
    .icon-inline svg{width:16px;height:16px;stroke:currentColor;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;fill:none}
    .icon-warning svg{width:18px;height:18px;stroke:#856404;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;fill:none}
    .icon-success svg{width:18px;height:18px;stroke:#38a169;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;fill:none}
    .icon-error svg{width:18px;height:18px;stroke:#e53e3e;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;fill:none}

/* Error Fixing Modal Styles */
    .error-row {
      background: #fff;
      border: 2px solid #e53e3e;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
    }

    .error-row.fixed {
      border-color: #48bb78;
      background: #f0fff4;
    }

    .error-row-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #e2e8f0;
    }

    .error-row-title {
      font-weight: 600;
      color: #2d3748;
    }

    .error-badge {
      background: #e53e3e;
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .error-badge.fixed {
      background: #48bb78;
    }

    .error-list {
      background: #fff5f5;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 15px;
    }

    .error-list ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .error-list li {
      color: #e53e3e;
      padding: 4px 0;
      font-size: 14px;
    }

    .error-list li:before {
      content: "? ";
      font-weight: bold;
    }

    .error-row-fields {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
    }

    .error-field-group {
      display: flex;
      flex-direction: column;
    }

    .error-field-group label {
      font-size: 12px;
      font-weight: 600;
      color: #4a5568;
      margin-bottom: 5px;
    }

    .error-field-group input,
    .error-field-group select {
      padding: 8px;
      border: 1px solid #cbd5e0;
      border-radius: 4px;
      font-size: 14px;
    }

    .error-field-group input.error,
    .error-field-group select.error {
      border-color: #e53e3e;
    }

    #fixErrorsModal .modal-content {
      max-width: 900px;
      max-height: 90vh;
      overflow-y: auto;
    }

    /* Settings Button */
    .btn-settings{background:linear-gradient(135deg,#4a5568 0%,#2d3748 100%);padding:12px 14px;border-radius:50%;width:46px;height:46px;display:inline-flex;align-items:center;justify-content:center}
    .btn-settings svg{width:20px;height:20px}
    .btn-settings:hover{transform:translateY(-2px) rotate(45deg)}

    /* Settings Modal */
    #settingsModal .modal-content{max-width:540px}
    .settings-section{background:#f7fafc;border:1px solid #e2e8f0;border-radius:10px;padding:20px;margin:20px 0}
    .settings-section h3{margin:0 0 16px 0;color:#2d3748;font-size:1.1em;display:flex;align-items:center;gap:8px}
    .setting-row{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid #e2e8f0}
    .setting-row:last-child{border-bottom:none}
    .setting-label{font-weight:600;color:#4a5568;font-size:14px}
    .setting-desc{font-size:12px;color:#718096;margin-top:4px}

    /* Toggle Switch */
    .toggle-switch{position:relative;width:52px;height:28px;flex-shrink:0}
    .toggle-switch input{opacity:0;width:0;height:0}
    .toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#cbd5e0;border-radius:28px;transition:.3s}
    .toggle-slider:before{content:'';position:absolute;height:22px;width:22px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:.3s;box-shadow:0 1px 3px rgba(0,0,0,.2)}
    .toggle-switch input:checked+.toggle-slider{background:#48bb78}
    .toggle-switch input:checked+.toggle-slider:before{transform:translateX(24px)}

    /* Status indicator */
    .status-dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px}
    .status-dot.active{background:#48bb78}
    .status-dot.inactive{background:#cbd5e0}
    .email-status{display:flex;align-items:center;font-size:13px;color:#718096;margin-top:12px;padding:10px;background:#fff;border-radius:6px;border:1px solid #e2e8f0}

    /* Clickable inline date cells */
    .date-clickable{cursor:pointer;color:#2563eb;border-bottom:1px dashed #2563eb;padding:2px 4px;border-radius:4px;transition:.2s;display:inline-block;min-width:80px;text-align:center}
    .date-clickable:hover{background:#ebf5ff;color:#1e40af}
    .date-clickable.empty{color:#a0aec0;border-bottom:1px dashed #cbd5e0;font-style:italic;font-size:13px}
    .date-clickable.empty:hover{background:#f7fafc;color:#718096}
    .date-inline-input{width:140px;padding:4px 8px;border:2px solid #2563eb;border-radius:6px;font-size:13px;text-align:center}
    .date-inline-input:focus{outline:none;box-shadow:0 0 0 3px rgba(37,99,235,.2)}

    
  </style>
</head>
<body>
  <div class="container">
    <h1>Lead Database</h1>

    <div class="controls">
      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <button class="btn" onclick="goToDashboard()" style="background:linear-gradient(135deg,#6b7280 0%,#4b5563 100%)"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg> Back to Dashboard</button>
        <button class="btn btn-secondary" onclick="openAddLeadModal()"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg> Add New Lead</button>
        <button class="btn" onclick="downloadLeadTemplate()" style="background:linear-gradient(135deg,#059669 0%,#047857 100%)"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg> Download Excel Template</button>
        <button class="btn" onclick="openImportModal()" style="background:linear-gradient(135deg,#7c3aed 0%,#6d28d9 100%)"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 16 12 12 8 16"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"/></svg> Import Excel File</button>
        <button class="btn" onclick="exportLeadsToExcel()" style="background:linear-gradient(135deg,#dc2626 0%,#b91c1c 100%)"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg> Export Current Leads</button>
        <button class="btn btn-settings" onclick="openSettingsModal()" title="Settings"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></button>
      </div>

      <div class="filters">
        <select id="repFilter" onchange="filterLeads()"><option value="">All Reps</option></select>
        <select id="companyFilter" onchange="filterLeads()"><option value="">All Business Units</option></select>
        <select id="statusFilter" onchange="filterLeads()">
          <option value="">All Status</option>
          <option value="Active" selected>Active</option>
          <option value="Follow Up Later">Follow Up Later</option>
          <option value="Not Qualified">Not Qualified</option>
          <option value="Dead">Dead (Archived)</option>
        </select>
        <input type="search" id="searchInput" placeholder="Search leads, city, state, zip..." onkeyup="filterLeads()"/>
      </div>
    </div>

    <div class="table-container">
      <div id="loadingState" class="loading">
        <div class="spinner"></div>
        <p>Loading leads...</p>
      </div>

      <table id="leadsTable" style="display:none;">
        <thead>
          <tr>
            <th>Date Added</th>
            <th>Company Name</th>
            <th>Contact Name</th>
            <th>Phone Number</th>
            <th>Email Address</th>
            <th>Rep Name</th>
            <th>Status</th>
            <th>Follow Up</th>
            <th>Appt Made</th>
            <th>Appt Date</th>
            <th>Notes</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="leadsTableBody"></tbody>
      </table>

      <div id="emptyState" class="empty-state" style="display:none;">
        <h3>No leads found</h3>
        <p>Add your first lead using the form above.</p>
      </div>
    </div>
  </div>

 <!-- Add/Edit Lead Modal -->
  <div id="leadModal" class="modal" aria-hidden="true">
    <div class="modal-content" id="leadModalContent">
      <span class="close" onclick="attemptCloseModal()">&times;</span>
      <h2 id="modalTitle">Add New Lead</h2>

      <form id="leadForm" onsubmit="return false;">
        <div class="form-group">
          <label for="businessUnit">Business Unit *</label>
          <select id="businessUnit" name="businessUnit" required onchange="toggleQuantumFields()">
            <option value="">Select...</option>
            <option value="Abbondanza Vending">Abbondanza Vending</option>
            <option value="Quantum Solutions">Quantum Solutions</option>
          </select>
        </div>

        <div class="form-group">
          <label for="companyName">Company Name *</label>
          <input type="text" id="companyName" name="companyName" list="companySuggestions" required />
          <datalist id="companySuggestions"></datalist>
        </div>

        <div class="form-group">
          <label for="customerAddress">Company Address</label>
          <input type="text" id="customerAddress" name="customerAddress" placeholder="123 Main Street, City"/>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="customerState">Company State</label>
            <select id="customerState" name="customerState">
              <option value="">Select...</option>
              <option value="AL">Alabama</option>
              <option value="AK">Alaska</option>
              <option value="AZ">Arizona</option>
              <option value="AR">Arkansas</option>
              <option value="CA">California</option>
              <option value="CO">Colorado</option>
              <option value="CT">Connecticut</option>
              <option value="DE">Delaware</option>
              <option value="FL">Florida</option>
              <option value="GA">Georgia</option>
              <option value="HI">Hawaii</option>
              <option value="ID">Idaho</option>
              <option value="IL">Illinois</option>
              <option value="IN">Indiana</option>
              <option value="IA">Iowa</option>
              <option value="KS">Kansas</option>
              <option value="KY">Kentucky</option>
              <option value="LA">Louisiana</option>
              <option value="ME">Maine</option>
              <option value="MD">Maryland</option>
              <option value="MA">Massachusetts</option>
              <option value="MI">Michigan</option>
              <option value="MN">Minnesota</option>
              <option value="MS">Mississippi</option>
              <option value="MO">Missouri</option>
              <option value="MT">Montana</option>
              <option value="NE">Nebraska</option>
              <option value="NV">Nevada</option>
              <option value="NH">New Hampshire</option>
              <option value="NJ">New Jersey</option>
              <option value="NM">New Mexico</option>
              <option value="NY">New York</option>
              <option value="NC">North Carolina</option>
              <option value="ND">North Dakota</option>
              <option value="OH">Ohio</option>
              <option value="OK">Oklahoma</option>
              <option value="OR">Oregon</option>
              <option value="PA">Pennsylvania</option>
              <option value="RI">Rhode Island</option>
              <option value="SC">South Carolina</option>
              <option value="SD">South Dakota</option>
              <option value="TN">Tennessee</option>
              <option value="TX">Texas</option>
              <option value="UT">Utah</option>
              <option value="VT">Vermont</option>
              <option value="VA">Virginia</option>
              <option value="WA">Washington</option>
              <option value="WV">West Virginia</option>
              <option value="WI">Wisconsin</option>
              <option value="WY">Wyoming</option>
            </select>
          </div>
          <div class="form-group">
            <label for="customerZip">Company Zip</label>
            <input type="text" id="customerZip" name="customerZip" pattern="[0-9]{5}" maxlength="5" placeholder="12345" inputmode="numeric"/>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="contactName">Contact Name</label>
            <input type="text" id="contactName" name="contactName"/>
          </div>
          <div class="form-group">
            <label for="phoneNumber">Phone Number</label>
            <input type="tel" id="phoneNumber" name="phoneNumber" placeholder="123-456-7890" maxlength="12"/>
          </div>
        </div>

        <div class="form-group">
          <label for="emailAddress">Email Address</label>
          <input type="email" id="emailAddress" name="emailAddress"/>
        </div>

        <div class="section-header">Sales Representative Information</div>
        <div class="form-row">
          <div class="form-group">
            <label for="repName">Rep Name *</label>
            <input type="text" id="repName" name="repName" required/>
          </div>
          <div class="form-group">
            <label for="status">Status</label>
            <select id="status" name="status">
              <option value="Active">Active</option>
              <option value="Follow Up Later">Follow Up Later</option>
              <option value="Not Qualified">Not Qualified</option>
              <option value="Dead">Dead (Archived)</option>
            </select>
          </div>
        </div>

        <!-- FIXED: Always show Rep Phone and Email fields -->
        <div class="form-row">
          <div class="form-group">
            <label for="repPhone">Rep Phone *</label>
            <input type="tel" id="repPhone" name="repPhone" placeholder="555-123-4567" maxlength="14" required/>
          </div>
          <div class="form-group">
            <label for="repEmail">Rep Email *</label>
            <input type="email" id="repEmail" name="repEmail" placeholder="rep@company.com" required/>
          </div>
        </div>

        <!-- Conditional section for Quantum Solutions ONLY -->
        <div id="quantumFieldsSection" style="display:none;">
          <div class="section-header">Customer Location (Required for Quantum Solutions)</div>
          <p style="color:#718096;font-size:14px;margin-bottom:15px;">Note: Company Address, State, and Zip are already filled above. This section is for additional Quantum-specific requirements only.</p>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="followUp">Follow Up Date</label>
            <input type="date" id="followUp" name="followUp"/>
          </div>
          <div class="form-group">
            <label for="appointmentMade">Appointment Made?</label>
            <select id="appointmentMade" name="appointmentMade" onchange="toggleAppointmentDate()">
              <option value="No">No</option>
              <option value="Yes">Yes</option>
            </select>
          </div>
        </div>

        <div class="form-group" id="appointmentDateGroup" style="display:none;">
          <label for="appointmentDate">Appointment Date</label>
          <input type="date" id="appointmentDate" name="appointmentDate"/>
        </div>

        <div class="form-group">
          <label for="notes">Notes</label>
          <textarea id="notes" name="notes" rows="4"></textarea>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-cancel" onclick="attemptCloseModal()">Cancel</button>
          <button type="button" id="saveBtn" class="btn">Save Lead</button>
        </div>
      </form>
    </div>
  </div>
  <!-- Excel Import Modal -->
  <div id="importModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <span class="close" onclick="closeImportModal()">&times;</span>
      <h2>Import Leads from Excel</h2>
      
      <div style="background:#f0f8ff;padding:20px;border-radius:8px;margin:20px 0;border:1px solid #b3d9ff;">
        <h3 style="color:#2c5aa0;margin-bottom:10px;">Instructions:</h3>
        <ol style="color:#4a5568;line-height:1.6;">
          <li>Download the Excel template using the "Download Excel Template" button</li>
          <li>Fill in your leads data (one lead per row)</li>
          <li>Save the file and select it below</li>
          <li>Click "Import Leads" to upload</li>
        </ol>
        <p style="color:#e53e3e;margin-top:10px;font-weight:600;">
          <span class="icon-inline"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#e53e3e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></span> Required fields: Business Unit, Company Name, Rep Name, Rep Phone, Rep Email
        </p>
      </div>

      <div class="form-group">
        <label for="excelFileInput">Select Excel File (.xlsx)</label>
        <input type="file" id="excelFileInput" accept=".xlsx,.xls" onchange="handleFileSelect(event)"/>
        <small>Supported formats: .xlsx, .xls</small>
      </div>

      <div id="filePreview" style="display:none;margin:20px 0;">
        <h3>File Preview:</h3>
        <div id="previewContent" class="file-preview" style="max-height:200px;overflow-y:auto;">
          <!-- Preview content will be inserted here -->
        </div>
        <p id="previewSummary" style="color:#4a5568;margin-top:10px;"></p>
      </div>

      <div class="form-actions">
        <button type="button" class="btn btn-cancel" onclick="closeImportModal()">Cancel</button>
        <button type="button" id="importBtn" class="btn" onclick="importLeads()" disabled>Import Leads</button>
      </div>
    </div>
  </div>

  <!-- Fix Import Errors Modal -->
  <div id="fixErrorsModal" class="modal" aria-hidden="true" style="display:none;">
    <div class="modal-content" style="max-width:900px;max-height:90vh;overflow-y:auto;">
      <span class="close" onclick="cancelErrorFix()">&times;</span>
      <h2>Fix Import Errors</h2>
      
      <div style="background:#fff3cd;padding:15px;border-radius:8px;margin:20px 0;border:1px solid #ffc107;">
        <p style="color:#856404;font-weight:600;margin-bottom:10px;">
          <span class="icon-inline"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#856404" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></span> <span id="errorSummary">Found validation errors in your import file</span>
        </p>
        <p style="color:#856404;font-size:14px;">
          Fix the errors below, or import only the valid rows and fix the rest later.
        </p>
      </div>

      <div id="errorRowsContainer" style="margin:20px 0;">
        <!-- Error rows will be dynamically inserted here -->
      </div>

      <div class="form-actions" style="display:flex;gap:10px;justify-content:space-between;">
        <button type="button" class="btn btn-cancel" onclick="cancelErrorFix()">Cancel Import</button>
        <div style="display:flex;gap:10px;">
          <button type="button" class="btn" style="background:#ffc107;color:#000;" onclick="importValidRowsOnly()">
            Import <span id="validCount">0</span> Valid Rows Only
          </button>
          <button type="button" id="completeImportBtn" class="btn" onclick="completeImportWithFixes()" disabled>
            Complete Import (All Rows)
          </button>
        </div>
      </div>
    </div>
  </div>


  


<!-- Confirmation Modal -->
  <div id="confirmModal" class="modal" aria-hidden="true" style="display:none;">
    <div class="modal-content" style="max-width:500px;text-align:center;">
      <h2 id="confirmTitle">Confirm Action</h2>
      <p id="confirmMessage" style="color:#4a5568;margin:20px 0;font-size:16px;"></p>
      <div class="form-actions" style="justify-content:center;gap:15px;">
        <button type="button" class="btn btn-cancel" onclick="closeConfirmModal(false)">Cancel</button>
        <button type="button" class="btn" id="confirmBtn" onclick="closeConfirmModal(true)">Confirm</button>
      </div>
    </div>
  </div>




  

  <!-- Delete Confirmation Modal -->
  <div id="deleteModal" class="modal delete-modal" aria-hidden="true">
    <div class="modal-content">
      <span class="close" onclick="closeDeleteModal()">&times;</span>
      <h2>Delete Lead Permanently</h2>
      <p style="color:#4a5568;margin-bottom:15px;">This action cannot be undone. The lead will be permanently deleted from the database.</p>
      
      <div class="company-name" id="deleteCompanyName">
        Company Name Will Show Here
      </div>
      
      <p style="margin:20px 0;font-weight:600;color:#721c24;">Type "yes" to confirm deletion:</p>
      
      <div class="form-group">
        <input type="text" id="deleteConfirmInput" placeholder="Type 'yes' to confirm" onkeyup="validateDeleteConfirmation()" style="border-color:#e53e3e"/>
      </div>

      <div class="form-actions">
        <button type="button" class="btn btn-cancel" onclick="closeDeleteModal()">Cancel</button>
        <button type="button" id="confirmDeleteBtn" class="btn btn-danger" onclick="confirmDeleteLead()" disabled>Delete Lead Permanently</button>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="modal" aria-hidden="true" style="display:none;">
    <div class="modal-content">
      <span class="close" onclick="closeSettingsModal()">&times;</span>
      <h2 style="display:flex;align-items:center;gap:10px;">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#2d3748" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
        Settings
      </h2>

      <div class="settings-section">
        <h3>
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#2d3748" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
          Follow-Up Email Reminders
        </h3>
        
        <div class="setting-row">
          <div>
            <div class="setting-label">Enable Email Reminders</div>
            <div class="setting-desc">Send follow-up reminder emails to reps</div>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="emailEnabled" onchange="toggleEmailSettings()">
            <span class="toggle-slider"></span>
          </label>
        </div>

        <div id="emailOptionsSection" style="display:none;">
          <div class="setting-row">
            <div>
              <div class="setting-label">Frequency</div>
              <div class="setting-desc">How often reminders are sent</div>
            </div>
            <select id="emailFrequency" style="width:160px;">
              <option value="daily">Daily (7:00 AM)</option>
              <option value="weekly_mon">Weekly (Monday)</option>
              <option value="weekly_fri">Weekly (Friday)</option>
            </select>
          </div>

          <div class="setting-row">
            <div>
              <div class="setting-label">Include Overdue</div>
              <div class="setting-desc">Also include leads with past-due follow-ups</div>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="includeOverdue" checked>
              <span class="toggle-slider"></span>
            </label>
          </div>

          <div class="setting-row">
            <div>
              <div class="setting-label">Look-Ahead Days</div>
              <div class="setting-desc">Include follow-ups within this many days</div>
            </div>
            <select id="lookAheadDays" style="width:160px;">
              <option value="0">Today only</option>
              <option value="1" selected>1 day ahead</option>
              <option value="3">3 days ahead</option>
              <option value="7">7 days ahead</option>
            </select>
          </div>
        </div>

        <div class="email-status" id="emailStatusDisplay">
          <span class="status-dot inactive" id="emailStatusDot"></span>
          <span id="emailStatusText">Loading status...</span>
        </div>
      </div>

      <div class="form-actions">
        <button type="button" class="btn btn-cancel" onclick="closeSettingsModal()">Cancel</button>
        <button type="button" class="btn" id="saveSettingsBtn" onclick="saveEmailSettings()">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
          Save Settings
        </button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // ====== SVG ICON HELPERS ======
    var SVG_ICONS = {
      warning: '<span class="icon-inline"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></span>',
      checkCircle: '<span class="icon-inline"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg></span>',
      xCircle: '<span class="icon-inline"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg></span>'
    };

    // ====== CONFIG ======
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbw1uRg1v6Cjqp9g2J-Q3CMsUzj1KbBfuiKnLgsYjhQe1n2x9bMSShB5eCw7mhA9-StC/exec';

    let allLeads = [];
    let currentEditId = null;
    let knownCompanies = [];
    let currentLeadForProposal = null;
    let currentLeadToDelete = null;
    let notesTooltip = null;
    // Import error fixing state
    let importValidLeads = [];
    let importErrorLeads = [];
    // Confirmation modal callback
    let confirmCallback = null;
    let importFileData = null;

    // Track unsaved edits in the modal
    let formInitialSnapshot = '';
    let formDirty = false;

    function safeLeadId(obj){
      const id = obj?.id ?? obj?.ID ?? obj?.Id ?? obj?.iD ?? obj?.leadId ?? '';
      return String(id).trim();
    }

    window.addEventListener('DOMContentLoaded', () => {
      document.getElementById('saveBtn').addEventListener('click', onSaveClick);

      // static backdrop
      const modal = document.getElementById('leadModal');
      modal.addEventListener('click', (e) => { if (e.target === modal) e.stopPropagation(); });

      loadLeads();
      loadCompanyLists();
      setupPhoneFormatting();
      setupRepPhoneFormatting();
      setupNotesTooltip();
    });

    function setupPhoneFormatting(){
      const phoneInput = document.getElementById('phoneNumber');
      phoneInput.addEventListener('input', (e) => {
        let v = e.target.value.replace(/\D/g,'');
        if (v.length >= 6) v = v.slice(0,3)+'-'+v.slice(3,6)+'-'+v.slice(6,10);
        else if (v.length >= 3) v = v.slice(0,3)+'-'+v.slice(3);
        e.target.value = v;
      });
      phoneInput.addEventListener('keypress', (e) => {
        const ch = String.fromCharCode(e.which);
        if (!/[0-9-]/.test(ch)) e.preventDefault();
      });
    }

    function setupRepPhoneFormatting() {
      const repPhoneInput = document.getElementById('repPhone');
      repPhoneInput.addEventListener('input', (e) => {
        let v = e.target.value.replace(/\D/g,'');
        if (v.length >= 6) v = v.slice(0,3)+'-'+v.slice(3,6)+'-'+v.slice(6,10);
        else if (v.length >= 3) v = v.slice(0,3)+'-'+v.slice(3);
        e.target.value = v;
      });
      repPhoneInput.addEventListener('keypress', (e) => {
        const ch = String.fromCharCode(e.which);
        if (!/[0-9-]/.test(ch)) e.preventDefault();
      });
    }

    function setupNotesTooltip() {
      // Create tooltip element
      notesTooltip = document.createElement('div');
      notesTooltip.className = 'notes-tooltip';
      document.body.appendChild(notesTooltip);
    }

    function showNotesTooltip(element, fullText) {
      if (!fullText || fullText.trim() === '') return;
      
      const rect = element.getBoundingClientRect();
      notesTooltip.textContent = fullText;
      notesTooltip.style.left = (rect.left + window.scrollX) + 'px';
      notesTooltip.style.top = (rect.top + window.scrollY - notesTooltip.offsetHeight - 10) + 'px';
      notesTooltip.classList.add('show');
    }

    function hideNotesTooltip() {
      notesTooltip.classList.remove('show');
    }

    // FIXED: Show/hide Quantum fields based on business unit selection
    function toggleQuantumFields() {
      const businessUnit = document.getElementById('businessUnit').value;
      const quantumSection = document.getElementById('quantumFieldsSection');
      
      if (businessUnit === 'Quantum Solutions') {
        quantumSection.style.display = 'block';
        // Make customer address required for Quantum
        document.getElementById('customerAddress').required = true;
        document.getElementById('customerZip').required = true;
      } else {
        quantumSection.style.display = 'none';
        // Remove required for other business units
        document.getElementById('customerAddress').required = false;
        document.getElementById('customerZip').required = false;
      }
    }

    async function loadLeads(){
      try{
        document.getElementById('loadingState').style.display='block';
        document.getElementById('leadsTable').style.display='none';
        document.getElementById('emptyState').style.display='none';

        const res = await fetch(WEB_APP_URL + '?action=getLeads');
        const data = await res.json();
        if (data.status !== 'success') throw new Error(data.message || 'Failed to load leads');

        allLeads = data.leads || [];
        
        // DEBUG: Check what data we're getting from the backend
        console.log('Loaded leads from backend:', allLeads);
        if (allLeads.length > 0) {
          console.log('Sample lead data:', allLeads[0]);
          console.log('Sample lead repPhone:', allLeads[0].repPhone);
          console.log('Sample lead repEmail:', allLeads[0].repEmail);
        }
        
        updateRepFilter();
        filterLeads(); // ? render using current dropdowns (default = Active)
      }catch(err){
        console.error('loadLeads error:', err);
        document.getElementById('loadingState').style.display='none';
        document.getElementById('emptyState').style.display='block';
        showToast('Error loading leads. ' + err.message, 'error');
      }
    }

    async function loadCompanyLists(){
      try{
        const res = await fetch(WEB_APP_URL + '?action=getCompanies');
        const data = await res.json();
        if (data.status !== 'success') throw new Error('API returned non-success status');

        knownCompanies = Array.isArray(data.companies) ? data.companies : [];
        const dl = document.getElementById('companySuggestions');
        dl.innerHTML = '';
        knownCompanies.forEach(name => {
          const opt = document.createElement('option'); opt.value = name; dl.appendChild(opt);
        });

        // FIXED: Normalize business units to prevent duplicates
        const normalizeUnit = function(unit) {
          if (!unit) return '';
          const normalized = unit.trim();
          // Fix common variations
          if (normalized.toLowerCase() === 'abbondanza vending') return 'Abbondanza Vending';
          if (normalized.toLowerCase() === 'quantum solutions') return 'Quantum Solutions';
          return normalized;
        };

        const unitsFromApi = Array.isArray(data.businessUnits) ? data.businessUnits.map(normalizeUnit) : [];
        const unitsFromLeads = [...new Set((allLeads||[]).map(l => normalizeUnit(l.businessUnit)).filter(Boolean))];
        const defaultUnits = ['Abbondanza Vending', 'Quantum Solutions'];
        const allUnits = [...new Set([...defaultUnits, ...unitsFromApi, ...unitsFromLeads])];
        const units = allUnits.sort();

        const sel = document.getElementById('companyFilter');
        sel.innerHTML = '<option value="">All Business Units</option>';
        units.forEach(u => {
          const o = document.createElement('option'); o.value = u; o.textContent = u; sel.appendChild(o);
        });

        const bu = document.getElementById('businessUnit');
        const current = bu.value;
        bu.innerHTML = '<option value="">Select...</option>' + units.map(u => '<option value="' + u + '">' + u + '</option>').join('');
        if (current) bu.value = current;
      }catch(e){
        console.warn('getCompanies failed, using defaults:', e);
        const fallback = ['Abbondanza Vending','Quantum Solutions'];

        const sel = document.getElementById('companyFilter');
        sel.innerHTML = '<option value="">All Business Units</option>' + fallback.map(u=>'<option value="' + u + '">' + u + '</option>').join('');

        const bu = document.getElementById('businessUnit');
        const current = bu.value;
        bu.innerHTML = '<option value="">Select...</option>' + fallback.map(u => '<option value="' + u + '">' + u + '</option>').join('');
        if (current) bu.value = current;
      }
    }

    function displayLeads(leads){
      const tbody = document.getElementById('leadsTableBody');
      const table = document.getElementById('leadsTable');
      const loading = document.getElementById('loadingState');
      const empty = document.getElementById('emptyState');

      tbody.innerHTML = '';
      loading.style.display = 'none';

      if (!leads.length){
        table.style.display = 'none';
        empty.style.display = 'block';
        return;
      }
      table.style.display = 'table';
      empty.style.display = 'none';

      leads.forEach(lead => tbody.appendChild(createLeadRow(lead)));
    }

    function createLeadRow(lead){
      const row = document.createElement('tr');
      const leadId = safeLeadId(lead);

      const dateAdded = formatDate(lead.dateAdded);
      const followUp = formatDate(lead.followUp);
      const appointmentDate = formatDate(lead.appointmentDate);
      const statusClass = getStatusClass(lead.status);
      const appointmentClass = (lead.appointmentMade === 'Yes') ? 'appointment-yes' : 'appointment-no';
      const notes = (lead.notes != null) ? String(lead.notes) : '';

      const cells = [
        dateAdded,
        `<strong>${lead.companyName || ''}</strong>`,
        lead.contactName || '',
        lead.phoneNumber || '',
        lead.emailAddress || '',
        lead.repName || '',
        `<span class="status-badge ${statusClass}">${lead.status || 'Active'}</span>`,
        followUp
          ? `<span class="date-clickable" onclick="inlineDateEdit(this,'${leadId}','followUp')">${followUp}</span>`
          : `<span class="date-clickable empty" onclick="inlineDateEdit(this,'${leadId}','followUp')">+ Add Date</span>`,
        `<span class="${appointmentClass}">${lead.appointmentMade || 'No'}</span>`,
        appointmentDate
          ? `<span class="date-clickable" onclick="inlineDateEdit(this,'${leadId}','appointmentDate')">${appointmentDate}</span>`
          : `<span class="date-clickable empty" onclick="inlineDateEdit(this,'${leadId}','appointmentDate')">+ Add Date</span>`,
        notes,
        `<div class="action-buttons">
           <button class="btn btn-small" style="background:#2563eb" onclick="editLead('${leadId}')">Edit</button>
           <button class="btn btn-small" style="background:linear-gradient(135deg,#48bb78 0%,#38a169 100%)" onclick="generateProposal('${leadId}')">Generate Proposal</button>
           <button class="btn btn-small" style="background:linear-gradient(135deg,#ed8936 0%,#dd6b20 100%)" onclick="archiveLead(this,'${leadId}')">Archive</button>
           <button class="btn btn-small btn-danger" onclick="openDeleteModal('${leadId}')">Delete</button>
         </div>`
      ];

      cells.forEach((html, index) => { 
        const td = document.createElement('td'); 
        td.innerHTML = html; 
        
        // Add hover functionality to notes column (11th column, index 10)
        if (index === 10 && notes.trim() !== '') {
          td.addEventListener('mouseenter', (e) => showNotesTooltip(e.target, notes));
          td.addEventListener('mouseleave', hideNotesTooltip);
        }
        
        row.appendChild(td); 
      });
      return row;
    }

    function getStatusClass(status){
      const map = {'Active':'status-active','Follow Up Later':'status-followup','Not Qualified':'status-notqualified','Dead':'status-dead'};
      return map[status] || 'status-active';
    }

    function formatDate(s){
      if (!s) return '';
      const d = new Date(s);
      if (isNaN(d)) return '';
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      const y = d.getFullYear();
      return `${m}/${day}/${y}`;
    }

    function filterLeads(){
      const rep = document.getElementById('repFilter').value.toLowerCase();
      const unit = document.getElementById('companyFilter').value;
      const status = document.getElementById('statusFilter').value;
      const q = document.getElementById('searchInput').value.toLowerCase();

      const filtered = (allLeads || []).filter(l => {
        const matchRep = !rep || ((l.repName||'').toLowerCase().includes(rep));
        const matchStatus = !status || (l.status === status);
        const matchUnit = !unit || (l.businessUnit === unit);
        const matchSearch = !q ||
          (l.companyName && l.companyName.toLowerCase().includes(q)) ||
          (l.contactName && l.contactName.toLowerCase().includes(q)) ||
          (l.phoneNumber && String(l.phoneNumber).toLowerCase().includes(q)) ||
          (l.emailAddress && l.emailAddress.toLowerCase().includes(q)) ||
          (l.customerAddress && l.customerAddress.toLowerCase().includes(q)) ||
          (l.customerState && l.customerState.toLowerCase().includes(q)) ||
          (l.customerZip && String(l.customerZip).toLowerCase().includes(q)) ||
          (l.notes && String(l.notes).toLowerCase().includes(q));
        return matchRep && matchStatus && matchUnit && matchSearch;
      });

      displayLeads(filtered);
    }

    function updateRepFilter(){
      const sel = document.getElementById('repFilter');
      const reps = [...new Set((allLeads || []).map(l => l.repName).filter(Boolean))].sort();
      sel.innerHTML = '<option value="">All Reps</option>';
      reps.forEach(r => { const o = document.createElement('option'); o.value = r; o.textContent = r; sel.appendChild(o); });
    }

    function openAddLeadModal(){
      currentEditId = null;
      document.getElementById('modalTitle').textContent = 'Add New Lead';
      document.getElementById('leadForm').reset();
      document.getElementById('status').value = 'Active';
      document.getElementById('appointmentMade').value = 'No';
      
      // FIXED: Clear all fields explicitly to prevent cache contamination
      document.getElementById('businessUnit').value = '';
      document.getElementById('companyName').value = '';
      document.getElementById('contactName').value = '';
      document.getElementById('phoneNumber').value = '';
      document.getElementById('emailAddress').value = '';
      document.getElementById('repName').value = '';
      document.getElementById('repPhone').value = '';
      document.getElementById('repEmail').value = '';
      document.getElementById('customerAddress').value = '';
      document.getElementById('customerState').value = '';
      document.getElementById('customerZip').value = '';
      document.getElementById('followUp').value = '';
      document.getElementById('appointmentDate').value = '';
      document.getElementById('notes').value = '';
      
      // Hide Quantum fields by default and remove required
      if (document.getElementById('quantumFieldsSection')) {
        document.getElementById('quantumFieldsSection').style.display = 'none';
        document.getElementById('customerAddress').required = false;
        document.getElementById('customerZip').required = false;
      }
      
      // Reset save button state
      const saveBtn = document.getElementById('saveBtn');
      saveBtn.disabled = false;
      saveBtn.textContent = 'Save Lead';
      
      toggleAppointmentDate();
      document.getElementById('leadModal').style.display = 'block';
      markFormPristineAndWatch();
    }

    function editLead(leadId){
      const lead = (allLeads || []).find(l => safeLeadId(l) === String(leadId));
      if (!lead) return;

      currentEditId = safeLeadId(lead);
      document.getElementById('modalTitle').textContent = 'Edit Lead';

      document.getElementById('businessUnit').value = lead.businessUnit || '';
      document.getElementById('companyName').value = lead.companyName || '';
      document.getElementById('contactName').value = lead.contactName || '';
      document.getElementById('phoneNumber').value = lead.phoneNumber || '';
      document.getElementById('emailAddress').value = lead.emailAddress || '';
      document.getElementById('repName').value = lead.repName || '';
      document.getElementById('status').value = lead.status || 'Active';
      document.getElementById('appointmentMade').value = lead.appointmentMade || 'No';
      document.getElementById('notes').value = lead.notes || '';

      // NEW FIELDS - Always populate these
      document.getElementById('repPhone').value = lead.repPhone || '';
      document.getElementById('repEmail').value = lead.repEmail || '';
      document.getElementById('customerAddress').value = lead.customerAddress || '';
      document.getElementById('customerState').value = lead.customerState || '';
      // FIXED: Only pad zip code if it exists and has a value
      const zipCode = lead.customerZip || '';
      if (zipCode && zipCode.toString().trim() !== '') {
        document.getElementById('customerZip').value = String(zipCode).padStart(5, '0');
      } else {
        document.getElementById('customerZip').value = '';
      }

      if (lead.followUp){
        const d = new Date(lead.followUp);
        if (!isNaN(d)) document.getElementById('followUp').value = d.toISOString().split('T')[0];
      }
      if (lead.appointmentDate){
        const d = new Date(lead.appointmentDate);
        if (!isNaN(d)) document.getElementById('appointmentDate').value = d.toISOString().split('T')[0];
      }

      // Reset save button state
      const saveBtn = document.getElementById('saveBtn');
      saveBtn.disabled = false;
      saveBtn.textContent = 'Save Lead';

      toggleQuantumFields();
      toggleAppointmentDate();
      document.getElementById('leadModal').style.display = 'block';
      markFormPristineAndWatch();
    }

    function attemptCloseModal(){
      if (formDirty){
        const ok = confirm('Discard your changes?');
        if (!ok) return;
      }
      closeModal();
    }

    function closeModal(){
      document.getElementById('leadModal').style.display = 'none';
      document.getElementById('leadForm').reset();
      currentEditId = null;
      formDirty = false;
      formInitialSnapshot = '';
      removeFormWatchers();
    }

    function toggleAppointmentDate(){
      const show = document.getElementById('appointmentMade').value === 'Yes';
      document.getElementById('appointmentDateGroup').style.display = show ? 'block' : 'none';
    }

    // Track pristine/dirty state
    function snapshotForm(){
      const formEl = document.getElementById('leadForm');
      const form = new FormData(formEl);
      const lead = Object.fromEntries(form.entries());
      if (lead.customerZip) {
        lead.customerZip = String(lead.customerZip).padStart(5, '0');
      }
      return JSON.stringify(lead);
    }
    function markFormPristineAndWatch(){
      formInitialSnapshot = snapshotForm();
      formDirty = false;
      removeFormWatchers();
      const formEl = document.getElementById('leadForm');
      const markDirty = () => { formDirty = (snapshotForm() !== formInitialSnapshot); };
      formEl.querySelectorAll('input,select,textarea').forEach(el => {
        el.addEventListener('input', markDirty);
        el.addEventListener('change', markDirty);
        el._dirtyHandlersAttached = true;
      });
    }
    function removeFormWatchers(){
      const formEl = document.getElementById('leadForm');
      if (!formEl) return;
      formEl.querySelectorAll('input,select,textarea').forEach(el => {
        if (el._dirtyHandlersAttached){
          const clone = el.cloneNode(true);
          el.parentNode.replaceChild(clone, el);
        }
      });
    }

    async function onSaveClick(e){
      e.preventDefault();
      const formEl = document.getElementById('leadForm');
      if (!formEl.checkValidity()){ formEl.reportValidity(); return; }

      const form = new FormData(formEl);
      const lead = Object.fromEntries(form.entries());
      const saveBtn = document.getElementById('saveBtn');
      const originalText = saveBtn.textContent;
      saveBtn.disabled = true; saveBtn.textContent = 'Saving...';

      try{
        const isUpdate = !!currentEditId;
        const action = isUpdate ? 'updateLead' : 'addLead';
        const url = WEB_APP_URL + '?action=' + encodeURIComponent(action)
          + (isUpdate ? ('&leadId=' + encodeURIComponent(String(currentEditId))) : '');

        const payload = isUpdate
          ? { action:'updateLead', leadId:String(currentEditId), updates:lead }
          : { action:'addLead',   lead:lead };

        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
          body: JSON.stringify(payload)
        });

        if (!res.ok) throw new Error(`Network ${res.status}`);
        const out = await res.json();
        if (out.status !== 'success') throw new Error(out.message || 'Save failed');

        showToast(isUpdate ? 'Lead updated' : 'Lead added', 'success');
        formDirty = false;
        closeModal();
        await loadLeads();
      }catch(err){
        console.error('save error:', err);
        showToast('Error saving lead: ' + err.message, 'error');
      }finally{
        saveBtn.disabled = false; saveBtn.textContent = originalText;
      }
    }

    async function archiveLead(btnEl, leadId){
      const id = String(leadId || '').trim();
      if (!id){ showToast('Could not determine lead ID ? refresh and try again.', 'error'); return; }
      if (!confirm('Archive this lead?')) return;

      const prevHtml = btnEl.innerHTML;
      btnEl.disabled = true; btnEl.innerHTML = 'Archiving?';

      try{
        const url = WEB_APP_URL + '?action=archiveLead&leadId=' + encodeURIComponent(id);
        const payload = { action:'archiveLead', leadId:id };

        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
          body: JSON.stringify(payload)
        });

        if (!res.ok) throw new Error(`Network ${res.status}`);
        const out = await res.json();
        if (out.status !== 'success') throw new Error(out.message || 'Archive failed');

        showToast('Lead archived', 'success');
        await loadLeads(); // list re-renders with current filter (Active)
      }catch(err){
        console.error(err);
        showToast('Error archiving lead: ' + err.message, 'error');
      }finally{
        btnEl.disabled = false; btnEl.innerHTML = prevHtml;
      }
    }

    // ============ DELETE LEAD FUNCTIONS ============

    function openDeleteModal(leadId) {
      const lead = allLeads.find(l => safeLeadId(l) === String(leadId));
      if (!lead) {
        showToast('Lead not found. Please refresh the page and try again.', 'error');
        return;
      }

      currentLeadToDelete = lead;
      document.getElementById('deleteCompanyName').textContent = lead.companyName;
      document.getElementById('deleteConfirmInput').value = '';
      document.getElementById('confirmDeleteBtn').disabled = true;
      document.getElementById('deleteModal').style.display = 'block';
    }

    function closeDeleteModal() {
      document.getElementById('deleteModal').style.display = 'none';
      currentLeadToDelete = null;
    }

    function validateDeleteConfirmation() {
      const input = document.getElementById('deleteConfirmInput').value.toLowerCase().trim();
      const confirmBtn = document.getElementById('confirmDeleteBtn');
      
      if (input === 'yes') {
        confirmBtn.disabled = false;
      } else {
        confirmBtn.disabled = true;
      }
    }

    async function confirmDeleteLead() {
      if (!currentLeadToDelete) {
        showToast('No lead selected for deletion.', 'error');
        return;
      }

      const leadId = safeLeadId(currentLeadToDelete);
      const confirmBtn = document.getElementById('confirmDeleteBtn');
      const originalText = confirmBtn.textContent;
      
      confirmBtn.disabled = true;
      confirmBtn.textContent = 'Deleting...';

      try {
        const url = WEB_APP_URL + '?action=deleteLead&leadId=' + encodeURIComponent(leadId);
        const payload = { action: 'deleteLead', leadId: leadId };

        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
          body: JSON.stringify(payload)
        });

        if (!res.ok) throw new Error(`Network ${res.status}`);
        const out = await res.json();
        if (out.status !== 'success') throw new Error(out.message || 'Delete failed');

        showToast('Lead "' + currentLeadToDelete.companyName + '" deleted permanently', 'success');
        closeDeleteModal();
        await loadLeads(); // Refresh the lead list
        
      } catch (err) {
        console.error('Delete error:', err);
        showToast('Error deleting lead: ' + err.message, 'error');
      } finally {
        confirmBtn.disabled = false;
        confirmBtn.textContent = originalText;
      }
    }

    // ============ PROPOSAL GENERATION FUNCTIONS ============

    // Generate Proposal - Navigate to Proposal Generator with Lead Data
    function generateProposal(leadId) {
      var lead = allLeads.find(function(l) { return safeLeadId(l) === String(leadId); });
      if (!lead) {
        showToast('Lead not found. Please refresh the page and try again.', 'error');
        return;
      }
      
      // Validate required fields
      if (!lead.repPhone || !lead.repEmail) {
        showToast('Missing sales rep contact information. Please edit the lead and add rep phone and email.', 'error');
        return;
      }
      
      // Build URL parameters from lead data
      var params = new URLSearchParams();
      
      if (lead.companyName) params.append('companyName', lead.companyName);
      if (lead.contactName) params.append('contactName', lead.contactName);
      if (lead.customerAddress) params.append('customerAddress', lead.customerAddress);
      if (lead.customerZip) params.append('customerZip', lead.customerZip);
      if (lead.repName) params.append('preparedBy', lead.repName);
      if (lead.repPhone) params.append('preparedByPhone', lead.repPhone);
      if (lead.repEmail) params.append('preparedByEmail', lead.repEmail);
      
      // Determine which proposal generator to open based on business unit
      var targetPage = '';
      if (lead.businessUnit === 'Quantum Solutions') {
        // Validate Quantum-specific required fields
        if (!lead.customerAddress || !lead.customerZip) {
          showToast('Missing customer address information required for Quantum Solutions. Please edit the lead first.', 'error');
          return;
        }
        targetPage = 'quantum.html';
      } else if (lead.businessUnit === 'Abbondanza Vending') {
        targetPage = 'index.html';
      } else {
        showToast('Invalid business unit: ' + lead.businessUnit, 'error');
        return;
      }
      
      // Navigate to the proposal generator page with pre-filled data
      window.location.href = targetPage + '?' + params.toString();
    }

  

 
    function getCurrentLead() {
      return currentLeadForProposal;
    }

  

    // ============ EXCEL IMPORT/EXPORT FUNCTIONS ============

    // Excel Template Download
 function downloadLeadTemplate() {
      // Headers - WITH LEAD ID
      const headers = [
        'Lead ID', 'Business Unit', 'Company Name', 'Contact Name', 'Phone Number', 'Email Address',
        'Rep Name', 'Rep Phone', 'Rep Email', 'Customer Address', 'Customer State', 'Customer Zip',
        'Status', 'Follow Up Date', 'Appointment Made', 'Appointment Date', 'Notes'
      ];
      
      // Sample data row - with clear instruction for Lead ID
      const sampleData = [
        'LEAVE BLANK', // Clear instruction for Lead ID
        'Abbondanza Vending',
        'Sample Company LLC',
        'John Smith',
        '555-123-4567',
        'john.smith@example.com',
        'Julie Garley',
        '806-316-5195',
        'julie.g@abbondanzavending.com',
        '123 Main Street',
        'NH',
        '03101',
        'Active',
        '2025-12-31',
        'No',
        '',
        'Sample notes here'
      ];
      
      const templateData = [headers, sampleData];
      
      // Create workbook and worksheet
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(templateData);
      
      // Set column widths
      const colWidths = [
        {wch: 25}, // Lead ID
        {wch: 18}, // Business Unit
        {wch: 25}, // Company Name
        {wch: 18}, // Contact Name
        {wch: 15}, // Phone Number
        {wch: 25}, // Email Address
        {wch: 18}, // Rep Name
        {wch: 15}, // Rep Phone
        {wch: 25}, // Rep Email
        {wch: 25}, // Customer Address
        {wch: 12}, // Customer State
        {wch: 12}, // Customer Zip
        {wch: 12}, // Status
        {wch: 15}, // Follow Up Date
        {wch: 15}, // Appointment Made
        {wch: 15}, // Appointment Date
        {wch: 30}  // Notes
      ];
      ws['!cols'] = colWidths;

      // Create Instructions sheet with prominent Lead ID warning
      const instructionsData = [
        ['LEAD IMPORT TEMPLATE - INSTRUCTIONS'],
        [''],
        ['IMPORTANT: LEAD ID COLUMN'],
        [''],
        ['FOR NEW LEADS:'],
        ['- DELETE the "LEAVE BLANK" text and leave the Lead ID cell EMPTY'],
        ['- The system will automatically generate a unique Lead ID when you import'],
        ['- DO NOT type anything in the Lead ID column for new leads'],
        [''],
        ['FOR UPDATING EXISTING LEADS:'],
        ['- Only use exports from the system (they have Lead IDs filled in)'],
        ['- Do NOT manually type Lead IDs'],
        [''],
        ['==============================================================='],
        [''],
        ['REQUIRED FIELDS (must have values):'],
        ['- Business Unit'],
        ['- Company Name'],
        ['- Rep Name'],
        ['- Rep Phone'],
        ['- Rep Email'],
        [''],
        ['VALID VALUES - Business Unit:'],
        ['- Abbondanza Vending'],
        ['- Quantum Solutions'],
        [''],
        ['VALID VALUES - Customer State (use 2-letter abbreviations):'],
        ['AL, AK, AZ, AR, CA, CO, CT, DE, FL, GA, HI, ID, IL, IN, IA, KS, KY, LA, ME, MD,'],
        ['MA, MI, MN, MS, MO, MT, NE, NV, NH, NJ, NM, NY, NC, ND, OH, OK, OR, PA, RI, SC,'],
        ['SD, TN, TX, UT, VT, VA, WA, WV, WI, WY'],
        [''],
        ['VALID VALUES - Status:'],
        ['- Active'],
        ['- Follow Up Later'],
        ['- Not Qualified'],
        ['- Dead'],
        [''],
        ['VALID VALUES - Appointment Made:'],
        ['- Yes'],
        ['- No'],
        [''],
        ['FORMAT REQUIREMENTS:'],
        ['- Customer Zip: 5 digits (will auto-add leading zeros if needed)'],
        ['- Rep Email: must be valid email format (name@domain.com)'],
        ['- Email Address: must be valid email format (name@domain.com)'],
        ['- Follow Up Date: format as MM/DD/YYYY or YYYY-MM-DD'],
        ['- Appointment Date: format as MM/DD/YYYY or YYYY-MM-DD'],
        [''],
        ['NOTE: After filling out the Lead Template sheet, import the file using'],
        ['the "Import Excel File" button. Any validation errors will be shown'],
        ['and you can fix them before completing the import.']
      ];
      
      const wsInstructions = XLSX.utils.aoa_to_sheet(instructionsData);
      wsInstructions['!cols'] = [{wch: 80}];

      // Add sheets to workbook
      XLSX.utils.book_append_sheet(wb, ws, 'Lead Template');
      XLSX.utils.book_append_sheet(wb, wsInstructions, 'Instructions');
      
      // Generate filename with current date
      const date = new Date().toISOString().split('T')[0];
      const filename = 'Lead_Import_Template_' + date + '.xlsx';
      
      // Download the file
      XLSX.writeFile(wb, filename);
      
      showToast('Template downloaded successfully', 'success');
    }






    
    // Import Modal Management
    function openImportModal() {
      document.getElementById('importModal').style.display = 'block';
      // Reset the modal state
      document.getElementById('excelFileInput').value = '';
      document.getElementById('filePreview').style.display = 'none';
      document.getElementById('importBtn').disabled = true;
    }

    function closeImportModal() {
      document.getElementById('importModal').style.display = 'none';
      // Clear any stored file data
      window.importFileData = null;
    }

    // File Selection and Preview
    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) {
        document.getElementById('filePreview').style.display = 'none';
        document.getElementById('importBtn').disabled = true;
        return;
      }

      // Check file type
      const allowedTypes = [
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', // .xlsx
        'application/vnd.ms-excel' // .xls
      ];
      
      if (!allowedTypes.includes(file.type)) {
        showToast('Please select a valid Excel file (.xlsx or .xls)', 'error');
        event.target.value = '';
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
          
          // Store the data for import
          window.importFileData = jsonData;
          
          // Show preview
          showFilePreview(jsonData);
          
        } catch (error) {
          console.error('Error reading Excel file:', error);
          showToast('Error reading Excel file. Please make sure it\'s a valid Excel file.', 'error');
          event.target.value = '';
        }
      };
      
      reader.readAsArrayBuffer(file);
    }

    function showFilePreview(data) {
      if (!data || data.length < 2) {
        showToast('Excel file appears to be empty or invalid.', 'error');
        return;
      }

      const headers = data[0];
      const rows = data.slice(1).filter(row => row.some(cell => cell && String(cell).trim() !== ''));
      
      // Create preview HTML
      let previewHTML = '<table style="width:100%;border-collapse:collapse;font-size:12px;">';
      
      // Headers
      previewHTML += '<tr style="background:#1e3a8a;color:white;">';
      headers.forEach(header => {
        previewHTML += `<th style="border:1px solid #ccc;padding:8px;text-align:left;">${header || ''}</th>`;
      });
      previewHTML += '</tr>';
      
      // Show first 5 rows as preview
      const previewRows = rows.slice(0, 5);
      previewRows.forEach(row => {
        previewHTML += '<tr>';
        headers.forEach((_, index) => {
          const cellValue = row[index] || '';
          previewHTML += `<td style="border:1px solid #ccc;padding:8px;">${String(cellValue).substring(0, 30)}${String(cellValue).length > 30 ? '...' : ''}</td>`;
        });
        previewHTML += '</tr>';
      });
      
      previewHTML += '</table>';
      
      document.getElementById('previewContent').innerHTML = previewHTML;
      document.getElementById('previewSummary').textContent = 
        `Found ${rows.length} lead${rows.length !== 1 ? 's' : ''} to import` + 
        (rows.length > 5 ? ` (showing first 5 rows)` : '');
      
      document.getElementById('filePreview').style.display = 'block';
      document.getElementById('importBtn').disabled = false;
    }

   async function importLeads() {
      if (!window.importFileData) {
        showToast('No file data found. Please select a file first.', 'error');
        return;
      }

      const importBtn = document.getElementById('importBtn');
      const originalText = importBtn.textContent;
      importBtn.disabled = true;
      importBtn.textContent = 'Validating...';

      try {
        const data = window.importFileData;
        const headers = data[0];
        const rows = data.slice(1).filter(row => row.some(cell => cell && String(cell).trim() !== ''));

        // Map headers to expected field names - WITH LEAD ID
        const fieldMapping = {
          'Lead ID': 'leadId',
          'Business Unit': 'businessUnit',
          'Company Name': 'companyName',
          'Contact Name': 'contactName',
          'Phone Number': 'phoneNumber',
          'Email Address': 'emailAddress',
          'Rep Name': 'repName',
          'Rep Phone': 'repPhone',
          'Rep Email': 'repEmail',
          'Customer Address': 'customerAddress',
          'Customer State': 'customerState',
          'Customer Zip': 'customerZip',
          'Status': 'status',
          'Follow Up Date': 'followUp',
          'Appointment Made': 'appointmentMade',
          'Appointment Date': 'appointmentDate',
          'Notes': 'notes'
        };

        // Valid values for validation
        const VALID_BUSINESS_UNITS = ['Abbondanza Vending', 'Quantum Solutions'];
        const VALID_STATUSES = ['Active', 'Follow Up Later', 'Not Qualified', 'Dead'];
        const VALID_APPOINTMENT = ['Yes', 'No'];
        const VALID_STATES = [
          'AL', 'AK', 'AZ', 'AR', 'CA', 'CO', 'CT', 'DE', 'FL', 'GA',
          'HI', 'ID', 'IL', 'IN', 'IA', 'KS', 'KY', 'LA', 'ME', 'MD',
          'MA', 'MI', 'MN', 'MS', 'MO', 'MT', 'NE', 'NV', 'NH', 'NJ',
          'NM', 'NY', 'NC', 'ND', 'OH', 'OK', 'OR', 'PA', 'RI', 'SC',
          'SD', 'TN', 'TX', 'UT', 'VT', 'VA', 'WA', 'WV', 'WI', 'WY'
        ];

        importValidLeads = [];
        importErrorLeads = [];

        rows.forEach((row, index) => {
          const lead = {};
          let rowErrors = [];
          const requiredFields = ['businessUnit', 'companyName', 'repName', 'repPhone', 'repEmail'];

          // Map each cell to the corresponding field
          headers.forEach((header, cellIndex) => {
            const fieldName = fieldMapping[header];
            if (fieldName && row[cellIndex] !== undefined && row[cellIndex] !== null) {
              const cellValue = String(row[cellIndex]).trim();
              if (cellValue.toLowerCase() === 'none' || cellValue === '') {
                return;
              }
              lead[fieldName] = cellValue;
            }
          });

          // GUARDRAIL 1: Remove "LEAVE BLANK" text from Lead ID
          if (lead.leadId) {
            const leadIdValue = lead.leadId.trim().toUpperCase();
            if (leadIdValue === 'LEAVE BLANK' || leadIdValue === 'LEAVEBLANK') {
              delete lead.leadId; // Remove it so it's treated as blank
            }
          }

          // Check if this is an update (has Lead ID) or new lead (no Lead ID)
          if (lead.leadId) {
            // HAS LEAD ID - Check if it exists in database
            const existingLead = allLeads.find(dbLead => dbLead.leadId === lead.leadId);
            if (existingLead) {
              lead._isUpdate = true;
              lead._existingLeadId = existingLead.id; // Store the numeric ID for updating
            } else {
              // Lead ID provided but doesn't exist in database
              rowErrors.push('Lead ID "' + lead.leadId + '" not found in database');
            }
          } else {
            // GUARDRAIL 2: NO LEAD ID - Check if this company already exists (possible accidental deletion)
            const existingLead = allLeads.find(dbLead => 
              dbLead.companyName && lead.companyName &&
              dbLead.companyName.toLowerCase().trim() === lead.companyName.toLowerCase().trim() &&
              ((dbLead.contactName && lead.contactName && 
                dbLead.contactName.toLowerCase().trim() === lead.contactName.toLowerCase().trim()) ||
               (!dbLead.contactName && !lead.contactName))
            );
            
            if (existingLead) {
              // DUPLICATE DETECTED - Lead ID missing but company exists
              lead._isDuplicate = true;
              lead._existingLead = existingLead;
              lead._duplicateAction = 'skip';
              lead._isUpdate = false;
              rowErrors.push('POSSIBLE DUPLICATE: Lead ID missing but company "' + lead.companyName + '" exists in database (Added: ' + formatDate(existingLead.dateAdded) + ')');
            } else {
              // Truly new lead
              lead._isUpdate = false;
            }
          }

          // Set defaults
          if (!lead.status) lead.status = 'Active';
          if (!lead.appointmentMade) lead.appointmentMade = 'No';

          // Validate required fields
          requiredFields.forEach(field => {
            if (!lead[field]) {
              rowErrors.push('Missing required field: ' + field);
            }
          });

          // VALIDATE BUSINESS UNIT
          if (lead.businessUnit) {
            const normalizedUnit = lead.businessUnit.trim();
            if (VALID_BUSINESS_UNITS.indexOf(normalizedUnit) === -1) {
              rowErrors.push('Invalid Business Unit "' + normalizedUnit + '"');
            } else {
              if (normalizedUnit.toLowerCase() === 'abbondanza vending') {
                lead.businessUnit = 'Abbondanza Vending';
              } else if (normalizedUnit.toLowerCase() === 'quantum solutions') {
                lead.businessUnit = 'Quantum Solutions';
              }
            }
          }

          // VALIDATE STATUS
          if (lead.status) {
            const normalizedStatus = lead.status.trim();
            if (VALID_STATUSES.indexOf(normalizedStatus) === -1) {
              rowErrors.push('Invalid Status "' + normalizedStatus + '"');
            }
          }

          // VALIDATE APPOINTMENT MADE
          if (lead.appointmentMade) {
            const normalizedAppt = lead.appointmentMade.trim();
            if (VALID_APPOINTMENT.indexOf(normalizedAppt) === -1) {
              rowErrors.push('Invalid Appointment Made "' + normalizedAppt + '"');
            }
          }

          // VALIDATE STATE
          if (lead.customerState) {
            const normalizedState = lead.customerState.trim().toUpperCase();
            if (normalizedState.length !== 2) {
              rowErrors.push('Invalid State format "' + lead.customerState + '"');
            } else if (VALID_STATES.indexOf(normalizedState) === -1) {
              rowErrors.push('Invalid State "' + normalizedState + '"');
            } else {
              lead.customerState = normalizedState;
            }
          }

          // VALIDATE ZIP CODE
          if (lead.customerZip) {
            const zipValue = String(lead.customerZip).replace(/\D/g, '');
            if (zipValue.length > 0 && zipValue.length <= 5) {
              lead.customerZip = zipValue.padStart(5, '0');
            } else if (zipValue.length > 5) {
              rowErrors.push('Invalid Zip Code "' + lead.customerZip + '"');
            }
          }

          // VALIDATE REP EMAIL
          if (lead.repEmail) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(lead.repEmail.trim())) {
              rowErrors.push('Invalid Rep Email "' + lead.repEmail + '"');
            }
          }

          // VALIDATE EMAIL ADDRESS
          if (lead.emailAddress) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(lead.emailAddress.trim())) {
              rowErrors.push('Invalid Email Address "' + lead.emailAddress + '"');
            }
          }

          // VALIDATE PHONE FORMATS
          if (lead.repPhone) {
            const phoneDigits = lead.repPhone.replace(/\D/g, '');
            if (phoneDigits.length < 10) {
              rowErrors.push('Invalid Rep Phone "' + lead.repPhone + '"');
            }
          }

          if (lead.phoneNumber) {
            const phoneDigits = lead.phoneNumber.replace(/\D/g, '');
            if (phoneDigits.length > 0 && phoneDigits.length < 10) {
              rowErrors.push('Invalid Phone Number "' + lead.phoneNumber + '"');
            }
          }

          // Store lead with row info
          lead._rowNumber = index + 2;
          lead._originalData = JSON.parse(JSON.stringify(lead));

          if (rowErrors.length > 0) {
            lead._errors = rowErrors;
            importErrorLeads.push(lead);
          } else {
            importValidLeads.push(lead);
          }
        });

        // If NO errors, import all immediately
        if (importErrorLeads.length === 0) {
          await performImport(importValidLeads);
          closeImportModal();
          return;
        }

        // If errors found, show fix modal
        showFixErrorsModal();

      } catch (error) {
        console.error('Import error:', error);
        showToast('Error during import: ' + error.message, 'error');
      } finally {
        importBtn.disabled = false;
        importBtn.textContent = originalText;
      }
    }



function showFixErrorsModal() {
      // Update summary
      document.getElementById('errorSummary').textContent = 
        'Found ' + importValidLeads.length + ' valid rows and ' + importErrorLeads.length + ' rows with errors';
      document.getElementById('validCount').textContent = importValidLeads.length;

      // Build error rows HTML
      const container = document.getElementById('errorRowsContainer');
      container.innerHTML = '';

      importErrorLeads.forEach((lead, index) => {
        const errorRowDiv = document.createElement('div');
        errorRowDiv.className = 'error-row';
        errorRowDiv.id = 'error-row-' + index;
        
        const errorsListHTML = '<ul>' + lead._errors.map(e => '<li>' + e + '</li>').join('') + '</ul>';
        
        errorRowDiv.innerHTML = `
        <div class="error-row-header">
          <div class="error-row-title">Row ${lead._rowNumber}: ${lead.companyName || 'Unknown Company'}</div>
          <span class="error-badge" id="badge-${index}">${lead._errors.length} Error${lead._errors.length !== 1 ? 's' : ''}</span>
        </div>
        ${lead._isDuplicate ? `
          <div style="background:#fef3c7;padding:12px;border-radius:6px;margin-bottom:15px;border-left:4px solid #f59e0b;">
            <strong style="color:#92400e;">${SVG_ICONS.warning} POSSIBLE DUPLICATE - LEAD ID MISSING</strong>
            <p style="color:#78350f;font-size:14px;margin:8px 0 12px 0;">
              Lead ID is missing, but this company matches: <strong>${lead._existingLead.companyName}</strong> (Added: ${formatDate(lead._existingLead.dateAdded)})<br>
              <em>Did you accidentally delete the Lead ID from an export file?</em>
            </p>
            <div style="display:flex;gap:10px;flex-wrap:wrap;">
              <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                <input type="radio" name="duplicate-${index}" value="skip" checked onchange="setDuplicateAction(${index}, 'skip')">
                <span style="color:#78350f;font-size:14px;">Skip (Keep Existing)</span>
              </label>
              <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                <input type="radio" name="duplicate-${index}" value="update" onchange="setDuplicateAction(${index}, 'update')">
                <span style="color:#78350f;font-size:14px;">Update Existing Lead</span>
              </label>
              <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                <input type="radio" name="duplicate-${index}" value="new" onchange="setDuplicateAction(${index}, 'new')">
                <span style="color:#78350f;font-size:14px;">Add as New (Create Duplicate)</span>
              </label>
            </div>
          </div>
        ` : ''}
        <div class="error-list" id="error-list-${index}" ${lead._isDuplicate && lead._duplicateAction === 'skip' ? 'style="display:none;"' : ''}>
          ${errorsListHTML}
        </div>
          <div class="error-row-fields">
            <div class="error-field-group">
              <label>Business Unit *</label>
              <select id="bu-${index}" onchange="validateErrorRow(${index})">
                <option value="">Select...</option>
                <option value="Abbondanza Vending" ${lead.businessUnit === 'Abbondanza Vending' ? 'selected' : ''}>Abbondanza Vending</option>
                <option value="Quantum Solutions" ${lead.businessUnit === 'Quantum Solutions' ? 'selected' : ''}>Quantum Solutions</option>
              </select>
            </div>
            <div class="error-field-group">
              <label>Company Name *</label>
              <input type="text" id="company-${index}" value="${lead.companyName || ''}" onchange="validateErrorRow(${index})" />
            </div>
            <div class="error-field-group">
              <label>Contact Name</label>
              <input type="text" id="contact-${index}" value="${lead.contactName || ''}" onchange="validateErrorRow(${index})" />
            </div>
            <div class="error-field-group">
              <label>Phone Number</label>
              <input type="tel" id="phone-${index}" value="${lead.phoneNumber || ''}" onchange="validateErrorRow(${index})" />
            </div>
            <div class="error-field-group">
              <label>Email Address</label>
              <input type="email" id="email-${index}" value="${lead.emailAddress || ''}" onchange="validateErrorRow(${index})" />
            </div>
            <div class="error-field-group">
              <label>Rep Name *</label>
              <input type="text" id="repName-${index}" value="${lead.repName || ''}" onchange="validateErrorRow(${index})" />
            </div>
            <div class="error-field-group">
              <label>Rep Phone *</label>
              <input type="tel" id="repPhone-${index}" value="${lead.repPhone || ''}" onchange="validateErrorRow(${index})" />
            </div>
            <div class="error-field-group">
              <label>Rep Email *</label>
              <input type="email" id="repEmail-${index}" value="${lead.repEmail || ''}" onchange="validateErrorRow(${index})" />
            </div>
            <div class="error-field-group">
              <label>Customer Address</label>
              <input type="text" id="address-${index}" value="${lead.customerAddress || ''}" onchange="validateErrorRow(${index})" />
            </div>
            <div class="error-field-group">
              <label>Customer State</label>
              <select id="state-${index}" onchange="validateErrorRow(${index})">
                <option value="">Select...</option>
                <option value="AL" ${lead.customerState === 'AL' ? 'selected' : ''}>AL</option>
                <option value="AK" ${lead.customerState === 'AK' ? 'selected' : ''}>AK</option>
                <option value="AZ" ${lead.customerState === 'AZ' ? 'selected' : ''}>AZ</option>
                <option value="AR" ${lead.customerState === 'AR' ? 'selected' : ''}>AR</option>
                <option value="CA" ${lead.customerState === 'CA' ? 'selected' : ''}>CA</option>
                <option value="CO" ${lead.customerState === 'CO' ? 'selected' : ''}>CO</option>
                <option value="CT" ${lead.customerState === 'CT' ? 'selected' : ''}>CT</option>
                <option value="DE" ${lead.customerState === 'DE' ? 'selected' : ''}>DE</option>
                <option value="FL" ${lead.customerState === 'FL' ? 'selected' : ''}>FL</option>
                <option value="GA" ${lead.customerState === 'GA' ? 'selected' : ''}>GA</option>
                <option value="HI" ${lead.customerState === 'HI' ? 'selected' : ''}>HI</option>
                <option value="ID" ${lead.customerState === 'ID' ? 'selected' : ''}>ID</option>
                <option value="IL" ${lead.customerState === 'IL' ? 'selected' : ''}>IL</option>
                <option value="IN" ${lead.customerState === 'IN' ? 'selected' : ''}>IN</option>
                <option value="IA" ${lead.customerState === 'IA' ? 'selected' : ''}>IA</option>
                <option value="KS" ${lead.customerState === 'KS' ? 'selected' : ''}>KS</option>
                <option value="KY" ${lead.customerState === 'KY' ? 'selected' : ''}>KY</option>
                <option value="LA" ${lead.customerState === 'LA' ? 'selected' : ''}>LA</option>
                <option value="ME" ${lead.customerState === 'ME' ? 'selected' : ''}>ME</option>
                <option value="MD" ${lead.customerState === 'MD' ? 'selected' : ''}>MD</option>
                <option value="MA" ${lead.customerState === 'MA' ? 'selected' : ''}>MA</option>
                <option value="MI" ${lead.customerState === 'MI' ? 'selected' : ''}>MI</option>
                <option value="MN" ${lead.customerState === 'MN' ? 'selected' : ''}>MN</option>
                <option value="MS" ${lead.customerState === 'MS' ? 'selected' : ''}>MS</option>
                <option value="MO" ${lead.customerState === 'MO' ? 'selected' : ''}>MO</option>
                <option value="MT" ${lead.customerState === 'MT' ? 'selected' : ''}>MT</option>
                <option value="NE" ${lead.customerState === 'NE' ? 'selected' : ''}>NE</option>
                <option value="NV" ${lead.customerState === 'NV' ? 'selected' : ''}>NV</option>
                <option value="NH" ${lead.customerState === 'NH' ? 'selected' : ''}>NH</option>
                <option value="NJ" ${lead.customerState === 'NJ' ? 'selected' : ''}>NJ</option>
                <option value="NM" ${lead.customerState === 'NM' ? 'selected' : ''}>NM</option>
                <option value="NY" ${lead.customerState === 'NY' ? 'selected' : ''}>NY</option>
                <option value="NC" ${lead.customerState === 'NC' ? 'selected' : ''}>NC</option>
                <option value="ND" ${lead.customerState === 'ND' ? 'selected' : ''}>ND</option>
                <option value="OH" ${lead.customerState === 'OH' ? 'selected' : ''}>OH</option>
                <option value="OK" ${lead.customerState === 'OK' ? 'selected' : ''}>OK</option>
                <option value="OR" ${lead.customerState === 'OR' ? 'selected' : ''}>OR</option>
                <option value="PA" ${lead.customerState === 'PA' ? 'selected' : ''}>PA</option>
                <option value="RI" ${lead.customerState === 'RI' ? 'selected' : ''}>RI</option>
                <option value="SC" ${lead.customerState === 'SC' ? 'selected' : ''}>SC</option>
                <option value="SD" ${lead.customerState === 'SD' ? 'selected' : ''}>SD</option>
                <option value="TN" ${lead.customerState === 'TN' ? 'selected' : ''}>TN</option>
                <option value="TX" ${lead.customerState === 'TX' ? 'selected' : ''}>TX</option>
                <option value="UT" ${lead.customerState === 'UT' ? 'selected' : ''}>UT</option>
                <option value="VT" ${lead.customerState === 'VT' ? 'selected' : ''}>VT</option>
                <option value="VA" ${lead.customerState === 'VA' ? 'selected' : ''}>VA</option>
                <option value="WA" ${lead.customerState === 'WA' ? 'selected' : ''}>WA</option>
                <option value="WV" ${lead.customerState === 'WV' ? 'selected' : ''}>WV</option>
                <option value="WI" ${lead.customerState === 'WI' ? 'selected' : ''}>WI</option>
                <option value="WY" ${lead.customerState === 'WY' ? 'selected' : ''}>WY</option>
              </select>
            </div>
            <div class="error-field-group">
              <label>Customer Zip</label>
              <input type="text" id="zip-${index}" value="${lead.customerZip || ''}" maxlength="5" onchange="validateErrorRow(${index})" />
            </div>
            <div class="error-field-group">
              <label>Status</label>
              <select id="status-${index}" onchange="validateErrorRow(${index})">
                <option value="Active" ${lead.status === 'Active' ? 'selected' : ''}>Active</option>
                <option value="Follow Up Later" ${lead.status === 'Follow Up Later' ? 'selected' : ''}>Follow Up Later</option>
                <option value="Not Qualified" ${lead.status === 'Not Qualified' ? 'selected' : ''}>Not Qualified</option>
                <option value="Dead" ${lead.status === 'Dead' ? 'selected' : ''}>Dead</option>
              </select>
            </div>
            <div class="error-field-group">
              <label>Appointment Made</label>
              <select id="appt-${index}" onchange="validateErrorRow(${index})">
                <option value="Yes" ${lead.appointmentMade === 'Yes' ? 'selected' : ''}>Yes</option>
                <option value="No" ${lead.appointmentMade === 'No' ? 'selected' : ''}>No</option>
              </select>
            </div>
          </div>
        `;
        
        container.appendChild(errorRowDiv);
      });

      // Close import modal and show fix errors modal
      document.getElementById('importModal').style.display = 'none';
      document.getElementById('fixErrorsModal').style.display = 'block';
    }






function setDuplicateAction(index, action) {
      const lead = importErrorLeads[index];
      lead._duplicateAction = action;
      
      const errorList = document.getElementById('error-list-' + index);
      const badge = document.getElementById('badge-' + index);
      const errorRow = document.getElementById('error-row-' + index);
      
      if (action === 'skip') {
        // Hide error list and mark as resolved
        errorList.style.display = 'none';
        errorRow.classList.add('fixed');
        badge.classList.add('fixed');
        badge.textContent = 'Will Skip ?';
        lead._errors = []; // Clear errors since we're skipping
      } else {
        // Show error list for validation
        errorList.style.display = 'block';
        errorRow.classList.remove('fixed');
        badge.classList.remove('fixed');
        
        if (action === 'update') {
          badge.textContent = 'Will Update';
        } else if (action === 'new') {
          badge.textContent = 'Will Import';
        }
        
        // Re-validate if updating or importing as new
        validateErrorRow(index);
      }
      
      checkAllErrorsFixed();
    }


    

function cancelErrorFix() {
      showConfirm(
        'Cancel Import?',
        'No data will be imported. Are you sure?',
        function() {
          document.getElementById('fixErrorsModal').style.display = 'none';
          closeImportModal();
          importValidLeads = [];
          importErrorLeads = [];
        }
      );
    }


function showConfirm(title, message, onConfirm) {
      document.getElementById('confirmTitle').textContent = title;
      document.getElementById('confirmMessage').textContent = message;
      confirmCallback = onConfirm;
      document.getElementById('confirmModal').style.display = 'block';
    }

    function closeConfirmModal(confirmed) {
      document.getElementById('confirmModal').style.display = 'none';
      if (confirmed && confirmCallback) {
        confirmCallback();
      }
      confirmCallback = null;
    }



    

function validateErrorRow(index) {
      const lead = importErrorLeads[index];
      const errors = [];

      // Get current values from form
      const businessUnit = document.getElementById('bu-' + index).value;
      const companyName = document.getElementById('company-' + index).value.trim();
      const repName = document.getElementById('repName-' + index).value.trim();
      const repPhone = document.getElementById('repPhone-' + index).value.trim();
      const repEmail = document.getElementById('repEmail-' + index).value.trim();
      const customerState = document.getElementById('state-' + index).value;
      const customerZip = document.getElementById('zip-' + index).value.trim();
      const emailAddress = document.getElementById('email-' + index).value.trim();
      const phoneNumber = document.getElementById('phone-' + index).value.trim();

      // Validate required fields
      if (!businessUnit) errors.push('Missing Business Unit');
      if (!companyName) errors.push('Missing Company Name');
      if (!repName) errors.push('Missing Rep Name');
      if (!repPhone) errors.push('Missing Rep Phone');
      if (!repEmail) errors.push('Missing Rep Email');

      // Validate formats
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (repEmail && !emailRegex.test(repEmail)) {
        errors.push('Invalid Rep Email format');
      }
      if (emailAddress && !emailRegex.test(emailAddress)) {
        errors.push('Invalid Email Address format');
      }

      if (repPhone) {
        const phoneDigits = repPhone.replace(/\D/g, '');
        if (phoneDigits.length < 10) {
          errors.push('Rep Phone must have at least 10 digits');
        }
      }

      if (phoneNumber) {
        const phoneDigits = phoneNumber.replace(/\D/g, '');
        if (phoneDigits.length > 0 && phoneDigits.length < 10) {
          errors.push('Phone Number must have at least 10 digits');
        }
      }

      if (customerZip) {
        const zipDigits = customerZip.replace(/\D/g, '');
        if (zipDigits.length > 5) {
          errors.push('Zip Code must be 5 digits or less');
        }
      }

      // Update lead data
      lead.businessUnit = businessUnit;
      lead.companyName = companyName;
      lead.contactName = document.getElementById('contact-' + index).value.trim();
      lead.phoneNumber = phoneNumber;
      lead.emailAddress = emailAddress;
      lead.repName = repName;
      lead.repPhone = repPhone;
      lead.repEmail = repEmail;
      lead.customerAddress = document.getElementById('address-' + index).value.trim();
      lead.customerState = customerState;
      lead.customerZip = customerZip;
      lead.status = document.getElementById('status-' + index).value;
      lead.appointmentMade = document.getElementById('appt-' + index).value;
      lead._errors = errors;

      // Update UI
      const errorRow = document.getElementById('error-row-' + index);
      const badge = document.getElementById('badge-' + index);
      const errorList = document.getElementById('error-list-' + index);

      if (errors.length === 0) {
        errorRow.classList.add('fixed');
        badge.classList.add('fixed');
        badge.textContent = 'Fixed ?';
        errorList.style.display = 'none';
      } else {
        errorRow.classList.remove('fixed');
        badge.classList.remove('fixed');
        badge.textContent = errors.length + ' Error' + (errors.length !== 1 ? 's' : '');
        errorList.innerHTML = '<ul>' + errors.map(e => '<li>' + e + '</li>').join('') + '</ul>';
        errorList.style.display = 'block';
      }

      // Check if all errors are fixed
      checkAllErrorsFixed();
    }

    function checkAllErrorsFixed() {
      const allFixed = importErrorLeads.every(lead => lead._errors.length === 0);
      document.getElementById('completeImportBtn').disabled = !allFixed;
    }

function importValidRowsOnly() {
      showConfirm(
        'Import Valid Rows Only?',
        'Import ' + importValidLeads.length + ' valid rows? Rows with errors will be skipped.',
        function() {
          performImport(importValidLeads);
        }
      );
    }

    function completeImportWithFixes() {
      const allLeadsToImport = importValidLeads.concat(importErrorLeads);
      showConfirm(
        'Complete Import?',
        'Import all ' + allLeadsToImport.length + ' rows (valid + fixed)?',
        function() {
          performImport(allLeadsToImport);
        }
      );
    }

    async function performImport(leadsArray) {
      let successCount = 0;
      let failCount = 0;

      // Create a visible importing indicator
      const importingDiv = document.createElement('div');
      importingDiv.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#1e3a8a;color:white;padding:30px 50px;border-radius:12px;z-index:10000;font-size:18px;font-weight:600;box-shadow:0 10px 40px rgba(0,0,0,0.3);';
      importingDiv.innerHTML = 'Importing <span id="importProgress">0</span>/' + leadsArray.length + ' leads...';
      document.body.appendChild(importingDiv);

      for (let i = 0; i < leadsArray.length; i++) {
        try {
          const leadData = Object.assign({}, leadsArray[i]);
          const isUpdate = leadData._isUpdate;
          const existingLeadId = leadData._existingLeadId;
          const isDuplicate = leadData._isDuplicate;
          const duplicateAction = leadData._duplicateAction;
          const existingLead = leadData._existingLead;
          
          // Clean up internal flags
          delete leadData._rowNumber;
          delete leadData._errors;
          delete leadData._originalData;
          delete leadData._isUpdate;
          delete leadData._existingLeadId;
          delete leadData._isDuplicate;
          delete leadData._duplicateAction;
          delete leadData._existingLead;

          // Handle duplicates (missing Lead ID but company exists)
          if (isDuplicate) {
            if (duplicateAction === 'skip') {
              // Skip this lead, keep existing
              successCount++;
              document.getElementById('importProgress').textContent = i + 1;
              continue;
            } else if (duplicateAction === 'update') {
              // Update the existing lead
              const response = await fetch(WEB_APP_URL + '?action=updateLead&leadId=' + encodeURIComponent(safeLeadId(existingLead)), {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
                body: JSON.stringify({ action: 'updateLead', leadId: safeLeadId(existingLead), updates: leadData })
              });

              const result = await response.json();
              if (result.status === 'success') {
                successCount++;
              } else {
                failCount++;
                console.error('Failed to update lead ' + (i + 1) + ':', result.message);
              }
              
              document.getElementById('importProgress').textContent = i + 1;
              continue;
            }
            // If action is 'new', fall through to add as new lead
          }

          // Handle Lead ID-based updates (has Lead ID and exists in database)
          if (isUpdate && existingLeadId) {
            const response = await fetch(WEB_APP_URL + '?action=updateLead&leadId=' + encodeURIComponent(existingLeadId), {
              method: 'POST',
              headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
              body: JSON.stringify({ action: 'updateLead', leadId: existingLeadId, updates: leadData })
            });

            const result = await response.json();
            if (result.status === 'success') {
              successCount++;
            } else {
              failCount++;
              console.error('Failed to update lead ' + (i + 1) + ':', result.message);
            }
          } else {
            // Add as new lead (will auto-generate Lead ID)
            const response = await fetch(WEB_APP_URL + '?action=addLead', {
              method: 'POST',
              headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
              body: JSON.stringify({ action: 'addLead', lead: leadData })
            });

            const result = await response.json();
            if (result.status === 'success') {
              successCount++;
            } else {
              failCount++;
              console.error('Failed to import lead ' + (i + 1) + ':', result.message);
            }
          }
        } catch (error) {
          failCount++;
          console.error('Error importing lead ' + (i + 1) + ':', error);
        }

        // Update progress
        document.getElementById('importProgress').textContent = i + 1;
      }

      // Remove importing indicator
      document.body.removeChild(importingDiv);

      // Show success/failure message
      if (successCount > 0) {
        showToast('Successfully imported ' + successCount + ' lead' + (successCount !== 1 ? 's' : '') + (failCount > 0 ? ' (' + failCount + ' failed)' : ''), 'success');
        await loadLeads();
      } else {
        showToast('Failed to import any leads', 'error');
      }

      // Clean up
      importValidLeads = [];
      importErrorLeads = [];
      
      // IMPORTANT: Close the fix errors modal and reset import modal
      document.getElementById('fixErrorsModal').style.display = 'none';
      document.getElementById('importModal').style.display = 'none';
      document.getElementById('excelFileInput').value = '';
      document.getElementById('filePreview').style.display = 'none';
      document.getElementById('importBtn').disabled = true;
    }


    
    
    

    // Export current leads to Excel
function exportLeadsToExcel() {
      if (!allLeads || allLeads.length === 0) {
        showToast('No leads to export. Please add some leads first.', 'error');
        return;
      }

      // Headers - WITH LEAD ID
      const exportData = [
        [
          'Lead ID', 'Business Unit', 'Company Name', 'Contact Name', 'Phone Number', 'Email Address',
          'Rep Name', 'Rep Phone', 'Rep Email', 'Customer Address', 'Customer State', 'Customer Zip',
          'Status', 'Follow Up Date', 'Appointment Made', 'Appointment Date', 'Notes'
        ]
      ];

      // Data rows - WITH LEAD ID
      allLeads.forEach(lead => {
        exportData.push([
          lead.leadId || '',
          lead.businessUnit || '',
          lead.companyName || '',
          lead.contactName || '',
          lead.phoneNumber || '',
          lead.emailAddress || '',
          lead.repName || '',
          lead.repPhone || '',
          lead.repEmail || '',
          lead.customerAddress || '',
          lead.customerState || '',
          lead.customerZip || '',
          lead.status || '',
          lead.followUp || '',
          lead.appointmentMade || '',
          lead.appointmentDate || '',
          lead.notes || ''
        ]);
      });

      // Create workbook and worksheet
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(exportData);
      
      // Set column widths
      ws['!cols'] = [
        {wch: 25}, {wch: 18}, {wch: 25}, {wch: 18}, {wch: 15}, {wch: 25},
        {wch: 18}, {wch: 15}, {wch: 25}, {wch: 25}, {wch: 12}, {wch: 12},
        {wch: 12}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 30}
      ];

      // Create Instructions sheet
      const instructionsData = [
        ['LEAD EXPORT - INSTRUCTIONS FOR RE-IMPORTING'],
        [''],
        ['REQUIRED FIELDS (must have values):'],
        ['- Lead ID (DO NOT CHANGE - used to match existing leads)'],
        ['- Business Unit'],
        ['- Company Name'],
        ['- Rep Name'],
        ['- Rep Phone'],
        ['- Rep Email'],
        [''],
        ['IMPORTANT: Lead ID Column'],
        ['- The Lead ID column is used to identify existing leads'],
        ['- When you re-import this file, leads will be UPDATED (not duplicated)'],
        ['- DO NOT modify or delete the Lead ID column'],
        ['- Leave Lead ID blank ONLY if adding a brand new lead'],
        [''],
        ['VALID VALUES - Business Unit:'],
        ['- Abbondanza Vending'],
        ['- Quantum Solutions'],
        [''],
        ['VALID VALUES - Customer State (use 2-letter abbreviations):'],
        ['AL, AK, AZ, AR, CA, CO, CT, DE, FL, GA, HI, ID, IL, IN, IA, KS, KY, LA, ME, MD,'],
        ['MA, MI, MN, MS, MO, MT, NE, NV, NH, NJ, NM, NY, NC, ND, OH, OK, OR, PA, RI, SC,'],
        ['SD, TN, TX, UT, VT, VA, WA, WV, WI, WY'],
        [''],
        ['VALID VALUES - Status:'],
        ['- Active'],
        ['- Follow Up Later'],
        ['- Not Qualified'],
        ['- Dead'],
        [''],
        ['VALID VALUES - Appointment Made:'],
        ['- Yes'],
        ['- No'],
        [''],
        ['FORMAT REQUIREMENTS:'],
        ['- Customer Zip: 5 digits (will auto-add leading zeros if needed)'],
        ['- Rep Email: must be valid email format (name@domain.com)'],
        ['- Email Address: must be valid email format (name@domain.com)'],
        ['- Follow Up Date: format as MM/DD/YYYY or YYYY-MM-DD'],
        ['- Appointment Date: format as MM/DD/YYYY or YYYY-MM-DD'],
        [''],
        ['IMPORTANT: Do NOT add or remove columns. Keep the exact same structure.'],
        [''],
        ['NOTE: After editing, import the file using the "Import Excel File" button.'],
        ['Leads with existing Lead IDs will be UPDATED. Rows without Lead ID will be added as NEW leads.']
      ];
      
      const wsInstructions = XLSX.utils.aoa_to_sheet(instructionsData);
      wsInstructions['!cols'] = [{wch: 80}];

      // Add sheets to workbook
      XLSX.utils.book_append_sheet(wb, ws, 'Leads Export');
      XLSX.utils.book_append_sheet(wb, wsInstructions, 'Instructions');
      
      const date = new Date().toISOString().split('T')[0];
      const filename = 'Leads_Export_' + date + '.xlsx';
      XLSX.writeFile(wb, filename);
      
      showToast('Exported ' + allLeads.length + ' leads to ' + filename, 'success');
    }



    
    function showToast(msg, type='success'){
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.className = 'toast ' + type;
      el.style.position = 'fixed';
      el.style.bottom = '20px';
      el.style.right  = '20px';
      el.style.background = type === 'success'
        ? 'linear-gradient(135deg,#48bb78 0%,#38a169 100%)'
        : 'linear-gradient(135deg,#e53e3e 0%,#c53030 100%)';
      el.style.color = '#fff';
      el.style.padding = '16px 24px';
      el.style.borderRadius = '8px';
      el.style.boxShadow = '0 4px 12px rgba(0,0,0,.2)';
      el.style.display = 'block';
      setTimeout(() => { el.style.display = 'none'; }, 3000);
    }

    // ============ INLINE DATE EDITING ============

    function inlineDateEdit(el, leadId, field) {
      // Don't open if already editing
      if (el.querySelector('input')) return;

      var currentText = el.textContent.trim();
      var currentVal = '';
      
      // Parse existing date to YYYY-MM-DD for the input
      if (currentText && currentText !== '+ Add Date') {
        var parts = currentText.split('/');
        if (parts.length === 3) {
          currentVal = parts[2] + '-' + parts[0].padStart(2,'0') + '-' + parts[1].padStart(2,'0');
        }
      }

      var input = document.createElement('input');
      input.type = 'date';
      input.className = 'date-inline-input';
      input.value = currentVal;

      el.innerHTML = '';
      el.style.borderBottom = 'none';
      el.appendChild(input);
      input.focus();

      var saved = false;

      function saveDate() {
        if (saved) return;
        saved = true;

        var newVal = input.value;

        if (!newVal) {
          // Cleared the date
          el.innerHTML = '<span class="date-clickable empty" onclick="inlineDateEdit(this,\'' + leadId + '\',\'' + field + '\')">+ Add Date</span>';
          el.style.borderBottom = '';
          el.className = '';
          sendInlineDateUpdate(leadId, field, '');
          return;
        }

        // Format for display MM/DD/YYYY
        var d = new Date(newVal + 'T00:00:00');
        var display = ('0' + (d.getMonth()+1)).slice(-2) + '/' + ('0' + d.getDate()).slice(-2) + '/' + d.getFullYear();
        
        el.innerHTML = display;
        el.className = 'date-clickable';
        el.style.borderBottom = '';
        el.onclick = function(){ inlineDateEdit(el, leadId, field); };

        sendInlineDateUpdate(leadId, field, newVal);
      }

      input.addEventListener('change', saveDate);
      input.addEventListener('blur', function() {
        setTimeout(saveDate, 150);
      });
      input.addEventListener('keydown', function(ev) {
        if (ev.key === 'Escape') {
          saved = true;
          if (currentText && currentText !== '+ Add Date') {
            el.innerHTML = currentText;
            el.className = 'date-clickable';
          } else {
            el.innerHTML = '+ Add Date';
            el.className = 'date-clickable empty';
          }
          el.style.borderBottom = '';
          el.onclick = function(){ inlineDateEdit(el, leadId, field); };
        }
        if (ev.key === 'Enter') saveDate();
      });
    }

    async function sendInlineDateUpdate(leadId, field, value) {
      try {
        var updates = {};
        updates[field] = value;

        var res = await fetch(WEB_APP_URL + '?action=updateLead&leadId=' + encodeURIComponent(String(leadId)), {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
          body: JSON.stringify({ action: 'updateLead', leadId: String(leadId), updates: updates })
        });

        var data = await res.json();
        if (data.status !== 'success') throw new Error(data.message || 'Update failed');
        showToast(field === 'followUp' ? 'Follow-up date updated' : 'Appointment date updated', 'success');
      } catch (err) {
        console.error('Inline date update error:', err);
        showToast('Error updating date: ' + err.message, 'error');
      }
    }

    // ============ SETTINGS / EMAIL REMINDER FUNCTIONS ============

    function openSettingsModal() {
      document.getElementById('settingsModal').style.display = 'block';
      loadEmailSettings();
    }

    function closeSettingsModal() {
      document.getElementById('settingsModal').style.display = 'none';
    }

    function toggleEmailSettings() {
      var enabled = document.getElementById('emailEnabled').checked;
      document.getElementById('emailOptionsSection').style.display = enabled ? 'block' : 'none';
    }

    async function loadEmailSettings() {
      var statusText = document.getElementById('emailStatusText');
      var statusDot = document.getElementById('emailStatusDot');
      statusText.textContent = 'Loading settings...';

      try {
        var res = await fetch(WEB_APP_URL + '?action=getEmailSettings');
        var data = await res.json();
        if (data.status !== 'success') throw new Error(data.message || 'Failed to load settings');

        var settings = data.settings || {};
        document.getElementById('emailEnabled').checked = settings.enabled === true;
        document.getElementById('emailFrequency').value = settings.frequency || 'daily';
        document.getElementById('includeOverdue').checked = settings.includeOverdue !== false;
        document.getElementById('lookAheadDays').value = String(settings.lookAheadDays || 1);

        toggleEmailSettings();

        if (settings.enabled) {
          statusDot.className = 'status-dot active';
          var freqLabel = {daily:'Daily at 7:00 AM', weekly_mon:'Weekly on Mondays', weekly_fri:'Weekly on Fridays'};
          statusText.textContent = 'Active ? ' + (freqLabel[settings.frequency] || 'Daily at 7:00 AM');
          if (settings.lastSent) {
            statusText.textContent += ' ? Last sent: ' + new Date(settings.lastSent).toLocaleDateString();
          }
        } else {
          statusDot.className = 'status-dot inactive';
          statusText.textContent = 'Email reminders are currently off';
        }
      } catch (err) {
        console.error('loadEmailSettings error:', err);
        statusDot.className = 'status-dot inactive';
        statusText.textContent = 'Could not load settings';
      }
    }

    async function saveEmailSettings() {
      var saveBtn = document.getElementById('saveSettingsBtn');
      var originalHTML = saveBtn.innerHTML;
      saveBtn.disabled = true;
      saveBtn.innerHTML = 'Saving...';

      var settings = {
        enabled: document.getElementById('emailEnabled').checked,
        frequency: document.getElementById('emailFrequency').value,
        includeOverdue: document.getElementById('includeOverdue').checked,
        lookAheadDays: parseInt(document.getElementById('lookAheadDays').value, 10)
      };

      try {
        var res = await fetch(WEB_APP_URL + '?action=saveEmailSettings', {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
          body: JSON.stringify({ action: 'saveEmailSettings', settings: settings })
        });

        var data = await res.json();
        if (data.status !== 'success') throw new Error(data.message || 'Save failed');

        showToast('Email settings saved', 'success');
        loadEmailSettings();
      } catch (err) {
        console.error('saveEmailSettings error:', err);
        showToast('Error saving settings: ' + err.message, 'error');
      } finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalHTML;
      }
    }

    async function sendTestReminder() {
      try {
        var res = await fetch(WEB_APP_URL + '?action=sendTestReminder');
        var data = await res.json();
        if (data.status !== 'success') throw new Error(data.message || 'Test failed');
        showToast('Test reminder sent ? check rep inboxes', 'success');
      } catch (err) {
        showToast('Error sending test: ' + err.message, 'error');
      }
    }

    // Global function exports
    window.openAddLeadModal = openAddLeadModal;
    window.editLead = editLead;
    window.archiveLead = archiveLead;
    window.toggleAppointmentDate = toggleAppointmentDate;
    window.filterLeads = filterLeads;
    window.attemptCloseModal = attemptCloseModal;
    window.goToDashboard = () => { window.location.href = 'index.html'; };
    
    // New function exports
    window.toggleQuantumFields = toggleQuantumFields;
    window.generateProposal = generateProposal;
    window.closeProposalModal = closeProposalModal;
    window.updateAbboPricing = updateAbboPricing;
    window.updateQuantumPricing = updateQuantumPricing;
    window.submitAbbondanzaProposal = submitAbbondanzaProposal;
    window.submitQuantumProposal = submitQuantumProposal;
    window.downloadLeadTemplate = downloadLeadTemplate;
    window.openImportModal = openImportModal;
    window.closeImportModal = closeImportModal;
    window.handleFileSelect = handleFileSelect;
    window.importLeads = importLeads;
    window.exportLeadsToExcel = exportLeadsToExcel;
    window.openDeleteModal = openDeleteModal;
    window.closeDeleteModal = closeDeleteModal;
    window.validateDeleteConfirmation = validateDeleteConfirmation;
    window.confirmDeleteLead = confirmDeleteLead;
    window.openSettingsModal = openSettingsModal;
    window.closeSettingsModal = closeSettingsModal;
    window.toggleEmailSettings = toggleEmailSettings;
    window.saveEmailSettings = saveEmailSettings;
    window.sendTestReminder = sendTestReminder;
    window.inlineDateEdit = inlineDateEdit;
  </script>
</body>
</html>








