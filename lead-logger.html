<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lead Logger - Abbondanza Sales</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;
      background:#1e3a8a;min-height:100vh;padding:20px
    }
    .container{max-width:95%;margin:0 auto;background:rgba(255,255,255,.95);border-radius:20px;padding:30px;box-shadow:0 20px 40px rgba(0,0,0,.1)}
    h1{color:#2d3748;margin-bottom:30px;text-align:center;font-size:2.5em}
    .controls{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;flex-wrap:wrap;gap:15px}
    .btn{padding:12px 24px;background:#1e3a8a;color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600;transition:.3s;text-decoration:none;display:inline-block}
    .btn:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(30,58,138,.4);background:#1e40af}
    .btn-secondary{background:linear-gradient(135deg,#48bb78 0%,#38a169 100%)}
    .filters{display:flex;gap:15px;align-items:center;flex-wrap:wrap}
    select,input[type="search"]{padding:10px 15px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;background:#fff;transition:border-color .3s}
    select:focus,input[type="search"]:focus{outline:none;border-color:#667eea}
    .status-badge{padding:6px 12px;border-radius:20px;font-size:12px;font-weight:600;text-align:center;display:inline-block}
    .status-active{background:#d4f1d4;color:#2d5a2d}
    .status-followup{background:#fff3cd;color:#856404}
    .status-notqualified{background:#f8d7da;color:#721c24}
    .status-dead{background:#e2e8f0;color:#718096}
    .table-container{overflow-x:auto;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.1)}
    table{width:100%;border-collapse:collapse;background:#fff}
    th{background:#1e3a8a;color:#fff;padding:15px;text-align:left;font-weight:600;position:sticky;top:0;z-index:10;white-space:nowrap}
    td{padding:15px;border-bottom:1px solid #e2e8f0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:250px}
    /* Notes column wraps */
    td:nth-child(11){
      max-width:300px;white-space:normal;word-wrap:break-word;overflow:visible;text-overflow:initial;vertical-align:top;line-height:1.4;padding:12px 15px
    }
    tr:hover{background:#f7fafc}
    .appointment-yes{color:#48bb78;font-weight:600}
    .appointment-no{color:#e53e3e}
    .empty-state{text-align:center;padding:60px 20px;color:#718096}
    .empty-state h3{font-size:1.5em;margin-bottom:10px;color:#4a5568}
    .loading{text-align:center;padding:40px;color:#718096}
    .spinner{display:inline-block;width:40px;height:40px;border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

    .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,.5);animation:fadeIn .3s ease}
    .modal-content{background:#fff;margin:5% auto;padding:30px;border-radius:12px;width:90%;max-width:600px;box-shadow:0 20px 40px rgba(0,0,0,.2);animation:slideIn .3s ease}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes slideIn{from{transform:translateY(-50px);opacity:0}to{transform:translateY(0);opacity:1}}
    .close{color:#aaa;float:right;font-size:28px;font-weight:700;cursor:pointer;transition:color .3s}
    .close:hover{color:#000}
    .form-group{margin-bottom:20px}
    .form-group label{display:block;margin-bottom:5px;color:#4a5568;font-weight:600}
    .form-group input,.form-group select,.form-group textarea{width:100%;padding:10px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;transition:border-color .3s}
    .form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:#667eea}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:15px}
    .form-actions{display:flex;gap:10px;margin-top:25px;justify-content:flex-end}
    .btn-cancel{background:linear-gradient(135deg,#a0aec0 0%,#718096 100%)}
    .action-buttons{display:flex;gap:8px}
    .btn-small{padding:6px 12px;font-size:12px;border-radius:6px}
    .btn-edit{background:#2563eb}
    .btn-edit:hover{background:#1d4ed8}
    .btn-archive{background:linear-gradient(135deg,#ed8936 0%,#dd6b20 100%)}
    .toast{position:fixed;bottom:20px;right:20px;background:#2d3748;color:#fff;padding:16px 24px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.2);display:none;animation:slideInRight .3s ease}
    .toast.success{background:linear-gradient(135deg,#48bb78 0%,#38a169 100%)}
    .toast.error{background:linear-gradient(135deg,#e53e3e 0%,#c53030 100%)}
    @keyframes slideInRight{from{transform:translateX(100%)}to{transform:translateX(0)}}

    /* Keep the lead modal inside the viewport and make it scrollable */
    #leadModal .modal-content{max-height:90vh;display:flex;flex-direction:column;overflow-y:auto}
    /* Keep the Save/Cancel bar visible while scrolling */
    #leadModal .form-actions{position:sticky;bottom:0;background:#fff;padding-top:12px;margin-top:12px;border-top:1px solid #e2e8f0;z-index:1}
  </style>
</head>
<body>
  <div class="container">
    <h1>Lead Database</h1>

    <div class="controls">
      <div style="display:flex;gap:10px">
        <button class="btn" onclick="goToDashboard()" style="background:linear-gradient(135deg,#6b7280 0%,#4b5563 100%)">‚Üê Back to Dashboard</button>
        <button class="btn btn-secondary" onclick="openAddLeadModal()">+ Add New Lead</button>
      </div>

      <div class="filters">
        <select id="repFilter" onchange="filterLeads()">
          <option value="">All Reps</option>
        </select>

        <!-- NEW: Brand filter -->
        <select id="brandFilter" onchange="filterLeads()">
          <option value="">All Companies</option>
          <option value="Abbondanza Vending">Abbondanza Vending</option>
          <option value="Quantum Solutions">Quantum Solutions</option>
        </select>

        <select id="statusFilter" onchange="filterLeads()">
          <option value="">All Status</option>
          <option value="Active">Active</option>
          <option value="Follow Up Later">Follow Up Later</option>
          <option value="Not Qualified">Not Qualified</option>
          <option value="Dead">Dead (Archived)</option>
        </select>

        <input type="search" id="searchInput" placeholder="Search leads..." onkeyup="filterLeads()">
      </div>
    </div>

    <div class="table-container">
      <div id="loadingState" class="loading">
        <div class="spinner"></div>
        <p>Loading leads...</p>
      </div>

      <table id="leadsTable" style="display:none">
        <thead>
          <tr>
            <th>Date Added</th>
            <th>Company Name</th>
            <th>Contact Name</th>
            <th>Phone Number</th>
            <th>Email Address</th>
            <th>Rep Name</th>
            <th>Status</th>
            <th>Follow Up</th>
            <th>Appt Made</th>
            <th>Appt Date</th>
            <th>Notes</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="leadsTableBody"></tbody>
      </table>

      <div id="emptyState" class="empty-state" style="display:none">
        <h3>No leads found</h3>
        <p>Add your first lead using the form above.</p>
      </div>
    </div>
  </div>

  <!-- Add/Edit Lead Modal -->
  <div id="leadModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h2 id="modalTitle">Add New Lead</h2>

      <form id="leadForm" onsubmit="handleSubmit(event)">
        <div class="form-group">
          <label for="companyName">Company Name *</label>
          <!-- NEW: autocomplete from existing leads -->
          <input type="text" id="companyName" name="companyName" list="companyNameOptions" required>
          <datalist id="companyNameOptions"></datalist>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="contactName">Contact Name</label>
            <input type="text" id="contactName" name="contactName">
          </div>

          <div class="form-group">
            <label for="phoneNumber">Phone Number</label>
            <input type="tel" id="phoneNumber" name="phoneNumber" placeholder="123-456-7890" maxlength="12">
          </div>
        </div>

        <div class="form-group">
          <label for="emailAddress">Email Address</label>
          <input type="email" id="emailAddress" name="emailAddress">
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="repName">Rep Name *</label>
            <input type="text" id="repName" name="repName" required>
          </div>

          <div class="form-group">
            <label for="status">Status</label>
            <select id="status" name="status">
              <option value="Active">Active</option>
              <option value="Follow Up Later">Follow Up Later</option>
              <option value="Not Qualified">Not Qualified</option>
              <option value="Dead">Dead (Archived)</option>
            </select>
          </div>
        </div>

        <!-- NEW: Company (brand) -->
        <div class="form-group">
          <label for="brand">Company</label>
          <select id="brand" name="brand" required>
            <option value="Abbondanza Vending">Abbondanza Vending</option>
            <option value="Quantum Solutions">Quantum Solutions</option>
          </select>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="followUp">Follow Up Date</label>
            <input type="date" id="followUp" name="followUp">
          </div>

          <div class="form-group">
            <label for="appointmentMade">Appointment Made?</label>
            <select id="appointmentMade" name="appointmentMade" onchange="toggleAppointmentDate()">
              <option value="No">No</option>
              <option value="Yes">Yes</option>
            </select>
          </div>
        </div>

        <div class="form-group" id="appointmentDateGroup" style="display:none">
          <label for="appointmentDate">Appointment Date</label>
          <input type="date" id="appointmentDate" name="appointmentDate">
        </div>

        <div class="form-group">
          <label for="notes">Notes</label>
          <textarea id="notes" name="notes" rows="3"></textarea>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-cancel" onclick="closeModal()">Cancel</button>
          <button type="submit" class="btn">Save Lead</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <script>
    // === Config ===
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzajzjde529Dvv0UhkzY9_WaAQRkm3TSGqjN_VkzQ9L_OpQHUJuHypmSb92pTZufJsa/exec';

    let allLeads = [];
    let currentEditId = null;

    // Init
    window.addEventListener('DOMContentLoaded', function () {
      loadLeads();
      setupPhoneFormatting();
    });

    // Phone formatting
    function setupPhoneFormatting() {
      const phoneInput = document.getElementById('phoneNumber');
      phoneInput.addEventListener('input', function (e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length >= 6) value = value.slice(0,3) + '-' + value.slice(3,6) + '-' + value.slice(6,10);
        else if (value.length >= 3) value = value.slice(0,3) + '-' + value.slice(3);
        e.target.value = value;
      });
      phoneInput.addEventListener('keypress', function (e) {
        const char = String.fromCharCode(e.which);
        if (!char.match(/[0-9-]/)) e.preventDefault();
      });
    }

    // Load leads
    async function loadLeads() {
      try {
        const resp = await fetch(WEB_APP_URL + '?action=getLeads');
        const data = await resp.json();

        if (data.status === 'success') {
          allLeads = (data.leads || []).filter(l => l.status !== 'Dead');
          displayLeads(allLeads);
          updateRepFilter();
          updateCompanyNameDatalist(); // NEW
          updateBrandFilter();         // NEW (optional dynamic)
        } else {
          throw new Error(data.message || 'Failed to load leads');
        }
      } catch (err) {
        console.error('Error loading leads:', err);
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('emptyState').style.display = 'block';
        showToast('Error loading leads. Please refresh the page.','error');
      }
    }

    // Populate company name datalist from existing leads
    function updateCompanyNameDatalist() {
      const dl = document.getElementById('companyNameOptions');
      if (!dl) return;
      const names = [...new Set(allLeads.map(l => l.companyName).filter(Boolean))].sort();
      dl.innerHTML = names.map(n => `<option value="${n}"></option>`).join('');
    }

    // Dynamic brand filter (optional; keeps the two defaults and adds any found)
    function updateBrandFilter() {
      const el = document.getElementById('brandFilter');
      if (!el) return;
      const brands = new Set(['Abbondanza Vending','Quantum Solutions']);
      allLeads.forEach(l => { if (l.brand) brands.add(l.brand); });
      const current = el.value;
      el.innerHTML = `<option value="">All Companies</option>` +
        [...brands].sort().map(b => `<option value="${b}">${b}</option>`).join('');
      if ([...brands,''].includes(current)) el.value = current;
    }

    // Display
    function displayLeads(leads) {
      const tbody = document.getElementById('leadsTableBody');
      const table = document.getElementById('leadsTable');
      const loading = document.getElementById('loadingState');
      const empty = document.getElementById('emptyState');

      tbody.innerHTML = '';
      loading.style.display = 'none';

      if (leads.length === 0) {
        table.style.display = 'none';
        empty.style.display = 'block';
        return;
      }
      table.style.display = 'table';
      empty.style.display = 'none';

      leads.forEach(lead => tbody.appendChild(createLeadRow(lead)));
    }

    // Row
    function createLeadRow(lead) {
      const row = document.createElement('tr');
      const leadId = parseInt(lead.id || lead.iD || lead.ID);

      const dateAdded = formatDate(lead.dateAdded);
      const followUp = formatDate(lead.followUp);
      const appointmentDate = formatDate(lead.appointmentDate);
      const statusClass = getStatusClass(lead.status);
      const appointmentClass = lead.appointmentMade === 'Yes' ? 'appointment-yes' : 'appointment-no';
      const notes = lead.notes || '';

      const cells = [
        dateAdded,
        `<strong>${lead.companyName || ''}</strong>`,
        lead.contactName || '',
        lead.phoneNumber || '',
        lead.emailAddress || '',
        lead.repName || '',
        `<span class="status-badge ${statusClass}">${lead.status || 'Active'}</span>`,
        followUp,
        `<span class="${appointmentClass}">${lead.appointmentMade || 'No'}</span>`,
        appointmentDate,
        notes,
        `<div class="action-buttons">
           <button class="btn btn-small btn-edit" onclick="editLead(${leadId})">Edit</button>
           <button class="btn btn-small btn-archive" onclick="archiveLead(${leadId})">Archive</button>
         </div>`
      ];

      cells.forEach(html => {
        const td = document.createElement('td');
        td.innerHTML = html;
        row.appendChild(td);
      });

      return row;
    }

    // Helpers
    function getStatusClass(status) {
      const map = { 'Active':'status-active','Follow Up Later':'status-followup','Not Qualified':'status-notqualified','Dead':'status-dead' };
      return map[status] || 'status-active';
    }

    function formatDate(s) {
      if (!s) return '';
      try {
        const d = new Date(s);
        if (isNaN(d.getTime())) return '';
        const m = String(d.getMonth()+1).padStart(2,'0');
        const day = String(d.getDate()).padStart(2,'0');
        const y = d.getFullYear();
        return `${m}/${day}/${y}`;
      } catch { return ''; }
    }

    // Filters
    function filterLeads() {
      const repFilter = document.getElementById('repFilter').value.toLowerCase();
      const statusFilter = document.getElementById('statusFilter').value;
      const brandFilter = document.getElementById('brandFilter').value;  // NEW
      const searchFilter = document.getElementById('searchInput').value.toLowerCase();

      const filtered = allLeads.filter(lead => {
        const matchRep = !repFilter || (lead.repName && lead.repName.toLowerCase().includes(repFilter));
        const matchStatus = !statusFilter || lead.status === statusFilter;
        const matchBrand = !brandFilter || lead.brand === brandFilter;       // NEW
        const matchSearch = !searchFilter ||
          (lead.companyName && lead.companyName.toLowerCase().includes(searchFilter)) ||
          (lead.contactName && lead.contactName.toLowerCase().includes(searchFilter)) ||
          (lead.phoneNumber && lead.phoneNumber.includes(searchFilter)) ||
          (lead.emailAddress && lead.emailAddress.toLowerCase().includes(searchFilter));
        return matchRep && matchStatus && matchBrand && matchSearch;
      });

      displayLeads(filtered);
    }

    function updateRepFilter() {
      const repFilter = document.getElementById('repFilter');
      const reps = [...new Set(allLeads.map(l => l.repName).filter(Boolean))].sort();
      repFilter.innerHTML = '<option value="">All Reps</option>';
      reps.forEach(rep => {
        const opt = document.createElement('option');
        opt.value = rep;
        opt.textContent = rep;
        repFilter.appendChild(opt);
      });
    }

    // Modal controls
    function openAddLeadModal() {
      currentEditId = null;
      document.getElementById('modalTitle').textContent = 'Add New Lead';
      document.getElementById('leadForm').reset();
      document.getElementById('status').value = 'Active';
      document.getElementById('appointmentMade').value = 'No';
      document.getElementById('brand').value = 'Abbondanza Vending'; // default brand
      toggleAppointmentDate();
      document.getElementById('leadModal').style.display = 'block';
    }

    function editLead(leadId) {
      leadId = parseInt(leadId);
      const lead = allLeads.find(l => parseInt(l.id || l.iD || l.ID) === leadId);
      if (!lead) return;

      currentEditId = leadId;
      document.getElementById('modalTitle').textContent = 'Edit Lead';

      document.getElementById('companyName').value = lead.companyName || '';
      document.getElementById('contactName').value = lead.contactName || '';
      document.getElementById('phoneNumber').value = lead.phoneNumber || '';
      document.getElementById('emailAddress').value = lead.emailAddress || '';
      document.getElementById('repName').value = lead.repName || '';
      document.getElementById('status').value = lead.status || 'Active';
      document.getElementById('brand').value = lead.brand || 'Abbondanza Vending'; // NEW
      document.getElementById('appointmentMade').value = lead.appointmentMade || 'No';
      document.getElementById('notes').value = lead.notes || '';

      if (lead.followUp) {
        const d = new Date(lead.followUp);
        if (!isNaN(d)) document.getElementById('followUp').value = d.toISOString().split('T')[0];
      }
      if (lead.appointmentDate) {
        const d2 = new Date(lead.appointmentDate);
        if (!isNaN(d2)) document.getElementById('appointmentDate').value = d2.toISOString().split('T')[0];
      }

      toggleAppointmentDate();
      document.getElementById('leadModal').style.display = 'block';
    }

    function closeModal() {
      document.getElementById('leadModal').style.display = 'none';
      document.getElementById('leadForm').reset();
      currentEditId = null;
    }

    function toggleAppointmentDate() {
      const v = document.getElementById('appointmentMade').value;
      document.getElementById('appointmentDateGroup').style.display = v === 'Yes' ? 'block' : 'none';
    }

    // Submit
    async function handleSubmit(e) {
      e.preventDefault();

      const formData = new FormData(e.target);
      const leadData = Object.fromEntries(formData.entries());

      try {
        let response, body;

        if (currentEditId) {
          body = { action:'updateLead', leadId: currentEditId, updates: leadData };
          response = await fetch(WEB_APP_URL, { method:'POST', body: JSON.stringify(body) });
        } else {
          body = { action:'addLead', lead: leadData };
          response = await fetch(WEB_APP_URL, { method:'POST', body: JSON.stringify(body) });
        }

        const result = await response.json();
        if (result.status === 'success') {
          showToast(currentEditId ? 'Lead updated successfully!' : 'Lead added successfully!','success');
          closeModal();
          await loadLeads();
        } else {
          throw new Error(result.message || 'Failed to save lead');
        }
      } catch (err) {
        console.error('Error saving lead:', err);
        showToast('Error saving lead: ' + err.message,'error');
      }
    }

    // Archive
    function archiveLead(leadId) {
      if (!confirm('Are you sure you want to archive this lead?')) return;
      leadId = parseInt(leadId);

      fetch(WEB_APP_URL, {
        method:'POST',
        body: JSON.stringify({ action:'archiveLead', leadId })
      })
      .then(r => r.json())
      .then(res => {
        if (res.status === 'success') {
          showToast('Lead archived successfully!','success');
          loadLeads();
        } else {
          throw new Error(res.message || 'Failed to archive lead');
        }
      })
      .catch(err => {
        console.error('Error archiving lead:', err);
        showToast('Error archiving lead: ' + err.message,'error');
      });
    }

    // Toast
    function showToast(msg, type='success') {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.className = 'toast ' + type;
      t.style.display = 'block';
      setTimeout(() => { t.style.display = 'none'; }, 3000);
    }

    // Close modal on outside click
    window.onclick = function (e) {
      const m = document.getElementById('leadModal');
      if (e.target === m) closeModal();
    }

    // Expose
    window.editLead = editLead;
    window.archiveLead = archiveLead;
    window.openAddLeadModal = openAddLeadModal;
    window.closeModal = closeModal;
    window.toggleAppointmentDate = toggleAppointmentDate;
    window.handleSubmit = handleSubmit;
    window.filterLeads = filterLeads;

    window.goToDashboard = function () {
      window.location.href = 'index.html';
    }
  </script>
</body>
</html>
