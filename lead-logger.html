<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" href="favicon.svg" type="image/svg+xml">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lead Logger - Abbondanza Sales</title>
  <!-- Add SheetJS for Excel functionality -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;background:#f5f5f5;min-height:100vh;padding:20px}
    .container{max-width:98%;margin:0 auto;background:rgba(255,255,255,.98);border-radius:20px;padding:30px;box-shadow:0 2px 8px rgba(0,0,0,.08);border:1px solid #e5e7eb}
    h1{color:#2d3748;margin-bottom:30px;text-align:center;font-size:2.2rem}
    .page-header{background:linear-gradient(135deg,#263238,#37474f);color:#fff;padding:18px 24px;border-radius:20px 20px 0 0;margin:-30px -30px 24px -30px;text-align:center}
    .page-header h1{color:#fff;font-size:1.8rem;margin:0}

    /* STICKY CONTROLS - Stay at top when scrolling */
    .controls{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;flex-wrap:wrap;gap:15px;position:sticky;top:0;z-index:100;background:rgba(255,255,255,.98);padding:15px 0;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
    
    .btn{padding:12px 24px;background:#263238;color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600;transition:.2s;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
    .btn:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(38,50,56,.35);background:#37474f}
    .btn-secondary{background:linear-gradient(135deg,#48bb78 0%,#38a169 100%)}
    .btn svg{width:16px;height:16px;flex-shrink:0}
    .filters{display:flex;gap:15px;align-items:center;flex-wrap:wrap}
    select,input[type="search"]{padding:10px 15px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;background:#fff;transition:border-color .2s}
    select:focus,input[type="search"]:focus{outline:none;border-color:#10b981}

    /* IMPROVED TABLE WITH SCROLLING AND CENTERED TEXT */
    .table-container{overflow:auto;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.1);max-height:70vh;position:relative}
    table{width:100%;border-collapse:collapse;background:#fff;min-width:1000px}
    th{background:#263238;color:#fff;padding:10px 8px;text-align:center;font-weight:600;font-size:12px;position:sticky;top:0;z-index:10;white-space:nowrap;border-bottom:2px solid #1a2526;box-shadow:0 2px 4px rgba(0,0,0,.15)}
    td{padding:10px 6px;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:180px;border-bottom:none;vertical-align:middle;font-size:13px}
    /* Allow wrapping only on company name */
    td:nth-child(2){white-space:normal;word-wrap:break-word;max-width:150px}
    tbody tr{border-bottom:1px solid #e2e8f0}
    tbody tr:last-child{border-bottom:none}
    tr:hover{background:#f7fafc}
    td:nth-child(2){white-space:normal;word-break:break-word;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;max-width:260px}
    
    /* Notes column with hover tooltip functionality */
    td:nth-child(8){
      white-space:normal;
      word-break:break-word;
      overflow:hidden;
      display:-webkit-box;
      -webkit-line-clamp:3;
      -webkit-box-orient:vertical;
      max-width:420px;
      vertical-align:top;
      line-height:1.4;
      padding:12px 15px;
      position:relative;
      cursor:pointer;
    }

    /* Tooltip styles for notes hover */
    .notes-tooltip {
      position: absolute;
      background: #2d3748;
      color: white;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.4;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
      z-index: 1000;
      max-width: 400px;
      word-wrap: break-word;
      white-space: normal;
      opacity: 0;
      transform: translateY(-10px);
      transition: opacity 0.2s, transform 0.2s;
      pointer-events: none;
    }
    
    .notes-tooltip.show {
      opacity: 1;
      transform: translateY(0);
    }
    
    .notes-tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 20px;
      border: 8px solid transparent;
      border-top-color: #2d3748;
    }

    .status-badge{padding:6px 12px;border-radius:20px;font-size:12px;font-weight:600;display:inline-block}
    .status-active{background:#d4f1d4;color:#2d5a2d}
    .status-signedup{background:#dbeafe;color:#1e40af}
    .status-dead{background:#fee2e2;color:#dc2626}
    .appointment-yes{color:#48bb78;font-weight:600}
    .appointment-no{color:#e53e3e}

    /* Clickable Appt Made toggle */
    .appt-toggle{cursor:pointer;padding:3px 10px;border-radius:12px;font-size:13px;font-weight:600;display:inline-block;transition:.2s;user-select:none}
    .appt-toggle.yes{background:#d1fae5;color:#059669;border:1px solid #a7f3d0}
    .appt-toggle.no{background:#fee2e2;color:#e53e3e;border:1px solid #fecaca}
    .appt-toggle:hover{transform:scale(1.05);box-shadow:0 2px 6px rgba(0,0,0,.1)}

    /* Clickable status badge */
    .status-badge{cursor:pointer;position:relative;transition:.15s}
    .status-badge:hover{transform:scale(1.05);box-shadow:0 2px 6px rgba(0,0,0,.15)}
    .status-dropdown{position:fixed;background:white;border:1px solid #e2e8f0;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,.15);z-index:999;overflow:hidden;min-width:150px}
    .status-dropdown-item{padding:8px 14px;font-size:12px;font-weight:600;cursor:pointer;text-align:center;transition:.1s;white-space:nowrap}
    .status-dropdown-item:hover{background:#f1f5f9}
    .status-dropdown-item.active-opt{color:#48bb78;background:#f0fff4}
    .status-dropdown-item.signedup-opt{color:#2563eb;background:#eff6ff}
    .status-dropdown-item.dead-opt{color:#e53e3e;background:#fff5f5}

    /* Sortable table headers */
    th.sortable{cursor:pointer;user-select:none;padding-right:22px!important;transition:background .15s}
    th.sortable:hover{background:#37474f}
    th.sortable::after{content:'';position:absolute;right:8px;top:50%;transform:translateY(-50%);border-left:4px solid transparent;border-right:4px solid transparent;border-top:5px solid rgba(255,255,255,.4);margin-top:3px}
    th.sortable::before{content:'';position:absolute;right:8px;top:50%;transform:translateY(-50%);border-left:4px solid transparent;border-right:4px solid transparent;border-bottom:5px solid rgba(255,255,255,.4);margin-top:-5px}
    th.sortable.asc::before{border-bottom-color:#fff}
    th.sortable.asc::after{border-top-color:rgba(255,255,255,.3)}
    th.sortable.desc::after{border-top-color:#fff}
    th.sortable.desc::before{border-bottom-color:rgba(255,255,255,.3)}
    .empty-state{text-align:center;padding:60px 20px;color:#718096}
    .empty-state h3{font-size:1.25rem;margin-bottom:10px;color:#4a5568}
    .loading{text-align:center;padding:40px;color:#718096}
    .spinner{display:inline-block;width:40px;height:40px;border:4px solid #f3f3f3;border-top:4px solid #10b981;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

    /* --- MODAL: static backdrop, no accidental close --- */
    .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.5);animation:fadeIn .2s ease}
    .modal-content{background:#fff;margin:3% auto;padding:30px;border-radius:12px;width:92%;max-width:760px;box-shadow:0 20px 40px rgba(0,0,0,.2);animation:slideIn .2s ease;max-height:90vh;overflow-y:auto}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes slideIn{from{transform:translateY(-40px);opacity:0}to{transform:translateY(0);opacity:1}}
    .close{color:#aaa;float:right;font-size:28px;font-weight:700;cursor:pointer}
    .close:hover{color:#000}
    
    .section-header{font-size:1.3em;font-weight:600;color:#2d3748;margin:25px 0 15px 0;padding-bottom:8px;border-bottom:2px solid #e2e8f0}
    .form-group{margin-bottom:16px}
    .form-group label{display:block;margin-bottom:6px;color:#4a5568;font-weight:600}
    .form-group input,.form-group select,.form-group textarea{width:100%;padding:10px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;transition:border-color .2s}
    .form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:#10b981}
    .form-group small{display:block;margin-top:5px;color:#718096;font-size:0.9em}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:15px}
    .form-actions{display:flex;gap:10px;margin-top:18px;justify-content:flex-end}
    .btn-cancel{background:linear-gradient(135deg,#a0aec0 0%,#718096 100%)}
    .action-buttons{display:grid;grid-template-columns:1fr 1fr;gap:4px;min-width:130px}
    .btn-small{padding:4px 6px;font-size:11px;border-radius:4px;white-space:nowrap;text-align:center}
    #leadModal .modal-content{max-height:90vh;display:flex;flex-direction:column;overflow-y:auto}
    #leadModal .form-actions{position:sticky;bottom:0;background:#fff;padding-top:12px;margin-top:12px;border-top:1px solid #e2e8f0;z-index:1}

    /* Import Modal Styles */
    #importModal .modal-content{max-width:800px}

    .contacts-clickable{cursor:pointer;border-bottom:1px dashed #cbd5e0;padding-bottom:1px;transition:color .15s}
    .contacts-clickable:hover{color:#2563eb;border-bottom-color:#2563eb}
    .contacts-popover{position:fixed;z-index:1001;background:#fff;border-radius:12px;box-shadow:0 12px 40px rgba(0,0,0,.25);border:1px solid #e2e8f0;min-width:480px;max-width:560px;animation:slideIn .15s ease}
    .contacts-popover-hdr{background:#263238;color:#fff;padding:10px 14px;border-radius:12px 12px 0 0;display:flex;align-items:center;justify-content:space-between}
    .contacts-popover-body{padding:12px 14px;max-height:300px;overflow-y:auto}
    .contacts-popover-footer{padding:10px 14px;background:#f8fafc;border-top:1px solid #e2e8f0;border-radius:0 0 12px 12px;display:flex;justify-content:space-between}
    .cp-row{display:flex;align-items:center;gap:5px;padding:5px 0;border-bottom:1px solid #f1f5f9}
    .cp-row:last-child{border-bottom:none}
    .cp-row input{padding:6px 8px;border:1px solid #e2e8f0;border-radius:5px;font-size:12px}
    .cp-row .cp-name{flex:1;min-width:0}
    .cp-row .cp-email{flex:1.2;min-width:0}
    .cp-row .cp-pos{flex:0.7;min-width:0}
    .cp-row .cp-del{width:24px;height:24px;border:1px solid #fecaca;border-radius:5px;background:#fff;color:#ef4444;font-size:13px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0}
    .cp-row .cp-del:hover{background:#fef2f2}
    .file-preview{background:#f7fafc;padding:15px;border-radius:8px;margin:15px 0}
    .file-preview table{font-size:12px;border-collapse:collapse}
    .file-preview th{background:#263238;color:white;padding:8px;text-align:left;border:1px solid #ccc}
    .file-preview td{border:1px solid #ccc;padding:8px}
    
    /* Proposal Modal Styles */
    .pricing-info{background:#f0f8ff;padding:15px;border-radius:8px;margin:15px 0;border:2px solid #b3d9ff}
    .pricing-info h3{margin:0 0 10px 0;color:#2c5aa0;font-size:1.2em}
    .pricing-display{font-size:16px;color:#2c5aa0;font-weight:bold}

    /* DELETE CONFIRMATION MODAL */
    .delete-modal .modal-content{max-width:500px;text-align:center}
    .delete-modal h2{color:#e53e3e;margin-bottom:20px}
    .delete-modal .company-name{background:#f8d7da;padding:10px;border-radius:8px;margin:15px 0;font-weight:bold;color:#721c24}
    .delete-modal input{text-align:center;font-size:16px;font-weight:bold;margin:15px 0}
    .btn-danger{background:linear-gradient(135deg,#e53e3e 0%,#c53030 100%)}
    .btn-danger:hover{background:linear-gradient(135deg,#c53030 0%,#9b2c2c 100%)}

    /* Inline SVG icon styling */
    .icon-inline{display:inline-flex;align-items:center;justify-content:center;vertical-align:middle}
    .icon-inline svg{width:16px;height:16px;stroke:currentColor;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;fill:none}
    .icon-warning svg{width:18px;height:18px;stroke:#856404;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;fill:none}
    .icon-success svg{width:18px;height:18px;stroke:#38a169;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;fill:none}
    .icon-error svg{width:18px;height:18px;stroke:#e53e3e;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;fill:none}

/* Error Fixing Modal Styles */
    .error-row {
      background: #fff;
      border: 2px solid #e53e3e;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
    }

    .error-row.fixed {
      border-color: #48bb78;
      background: #f0fff4;
    }

    .error-row-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #e2e8f0;
    }

    .error-row-title {
      font-weight: 600;
      color: #2d3748;
    }

    .error-badge {
      background: #e53e3e;
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .error-badge.fixed {
      background: #48bb78;
    }

    .error-list {
      background: #fff5f5;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 15px;
    }

    .error-list ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .error-list li {
      color: #e53e3e;
      padding: 4px 0;
      font-size: 14px;
    }

    .error-list li:before {
      content: "? ";
      font-weight: bold;
    }

    .error-row-fields {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
    }

    .error-field-group {
      display: flex;
      flex-direction: column;
    }

    .error-field-group label {
      font-size: 12px;
      font-weight: 600;
      color: #4a5568;
      margin-bottom: 5px;
    }

    .error-field-group input,
    .error-field-group select {
      padding: 8px;
      border: 1px solid #cbd5e0;
      border-radius: 4px;
      font-size: 14px;
    }

    .error-field-group input.error,
    .error-field-group select.error {
      border-color: #e53e3e;
    }

    #fixErrorsModal .modal-content {
      max-width: 900px;
      max-height: 90vh;
      overflow-y: auto;
    }

    /* Settings Button */
    .btn-settings{background:linear-gradient(135deg,#4a5568 0%,#2d3748 100%);padding:12px 14px;border-radius:50%;width:46px;height:46px;display:inline-flex;align-items:center;justify-content:center}
    .btn-settings svg{width:20px;height:20px}
    .btn-settings:hover{transform:translateY(-2px) rotate(45deg)}

    /* Settings Modal */
    #settingsModal .modal-content{max-width:540px}
    .settings-section{background:#f7fafc;border:1px solid #e2e8f0;border-radius:10px;padding:20px;margin:20px 0}
    .settings-section h3{margin:0 0 16px 0;color:#2d3748;font-size:1.1em;display:flex;align-items:center;gap:8px}
    .setting-row{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid #e2e8f0}
    .setting-row:last-child{border-bottom:none}
    .setting-label{font-weight:600;color:#4a5568;font-size:14px}
    .setting-desc{font-size:12px;color:#718096;margin-top:4px}

    /* Toggle Switch */
    .toggle-switch{position:relative;width:52px;height:28px;flex-shrink:0}
    .toggle-switch input{opacity:0;width:0;height:0}
    .toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#cbd5e0;border-radius:28px;transition:.3s}
    .toggle-slider:before{content:'';position:absolute;height:22px;width:22px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:.3s;box-shadow:0 1px 3px rgba(0,0,0,.2)}
    .toggle-switch input:checked+.toggle-slider{background:#48bb78}
    .toggle-switch input:checked+.toggle-slider:before{transform:translateX(24px)}

    /* Status indicator */
    .status-dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px}
    .status-dot.active{background:#48bb78}
    .status-dot.inactive{background:#cbd5e0}
    .email-status{display:flex;align-items:center;font-size:13px;color:#718096;margin-top:12px;padding:10px;background:#fff;border-radius:6px;border:1px solid #e2e8f0}

    /* Clickable inline date cells */
    .date-clickable{cursor:pointer;color:#10b981;border-bottom:1px dashed #10b981;padding:2px 4px;border-radius:4px;transition:.2s;display:inline-block;min-width:80px;text-align:center}
    .date-clickable:hover{background:#ecfdf5;color:#059669}
    .date-clickable.empty{color:#a0aec0;border-bottom:1px dashed #cbd5e0;font-style:italic;font-size:13px}
    .date-clickable.empty:hover{background:#f7fafc;color:#718096}
    .date-inline-input{width:140px;padding:4px 8px;border:2px solid #10b981;border-radius:6px;font-size:13px;text-align:center}
    .date-inline-input:focus{outline:none;box-shadow:0 0 0 3px rgba(16,185,129,.2)}

    /* Clickable inline notes */
    .notes-clickable{cursor:pointer;color:#4a5568;border-radius:4px;padding:2px 4px;transition:.2s;display:block;max-width:200px;overflow:hidden;text-overflow:ellipsis}
    .notes-clickable:hover{background:#ecfdf5;color:#059669}
    .notes-clickable.empty{color:#a0aec0;font-style:italic;font-size:13px}
    .notes-clickable.empty:hover{background:#f7fafc;color:#718096}
    .notes-edit-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.3);z-index:999;display:flex;justify-content:center;align-items:center}
    .notes-edit-card{background:white;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,.2);width:90vw;max-width:960px;overflow:hidden;animation:notesFadeIn .15s ease}
    @keyframes notesFadeIn{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}
    .notes-edit-header{background:#263238;color:white;padding:18px 24px;display:flex;justify-content:space-between;align-items:center}
    .notes-edit-header h3{margin:0;font-size:18px;font-weight:600}
    .notes-edit-header .notes-company{opacity:.8;font-size:13px;margin-top:2px}
    .notes-edit-body{padding:20px 24px}
    .notes-edit-body textarea{width:100%;min-height:350px;padding:16px;border:2px solid #e2e8f0;border-radius:8px;font-size:16px;font-family:inherit;resize:vertical;box-sizing:border-box;line-height:1.6}
    .notes-edit-body textarea:focus{outline:none;border-color:#10b981;box-shadow:0 0 0 3px rgba(16,185,129,.15)}
    .notes-edit-footer{padding:14px 24px;background:#f7fafc;display:flex;justify-content:flex-end;gap:10px;border-top:1px solid #e2e8f0}
    .notes-edit-footer button{padding:10px 24px;border:none;border-radius:6px;font-size:15px;font-weight:600;cursor:pointer;transition:.15s}
    .notes-edit-footer .notes-save{background:#10b981;color:white}
    .notes-edit-footer .notes-save:hover{background:#059669}
    .notes-edit-footer .notes-cancel{background:#e2e8f0;color:#4a5568}
    .notes-edit-footer .notes-cancel:hover{background:#cbd5e0}

    /* Duplicate Check Modal */
    .dup-match{background:#fef2f2;border:2px solid #fecaca;border-radius:10px;padding:14px;margin-bottom:10px}
    .dup-match-header{display:flex;align-items:center;gap:8px;margin-bottom:8px}
    .dup-match-badge{background:#ef4444;color:#fff;font-size:11px;font-weight:700;padding:3px 8px;border-radius:6px}
    .dup-match-score{font-size:11px;color:#64748b;margin-left:auto}
    .dup-match-company{font-weight:700;font-size:15px;color:#1e293b}
    .dup-match-details{display:flex;flex-wrap:wrap;gap:6px;font-size:12px;color:#64748b;margin-top:6px}
    .dup-match-details span{background:#f1f5f9;padding:2px 8px;border-radius:4px}

    /* ==================== MOBILE RESPONSIVE ==================== */
    @media (max-width: 768px) {
      body{padding:8px}
      .container{padding:12px;border-radius:12px}
      .page-header{margin:-12px -12px 16px -12px;padding:14px 16px;border-radius:12px 12px 0 0}
      .page-header h1{font-size:1.3rem}
      h1{font-size:1.4rem;margin-bottom:16px}

      /* Controls stack vertically */
      .controls{flex-direction:column;align-items:stretch;gap:10px;padding:10px 0;position:relative;top:auto}
      .controls > div{display:flex;flex-wrap:wrap;gap:6px}
      .btn{padding:10px 14px;font-size:12px;gap:5px;flex:1 1 calc(50% - 6px);justify-content:center;min-width:0}
      .btn svg{width:14px;height:14px}
      .btn-settings{flex:0 0 auto;width:42px;padding:10px}
      .filters{flex-direction:column;gap:8px;width:100%}
      .filters select,.filters input[type="search"]{width:100%;font-size:13px;padding:10px 12px}

      /* Table horizontal scroll */
      .table-container{border-radius:8px;max-height:none}
      table{min-width:700px;font-size:12px}
      th{padding:8px 4px;font-size:10px}
      td{padding:8px 4px;font-size:11px;max-width:120px}
      td:nth-child(2){max-width:120px}
      td:nth-child(8){max-width:100px}
      .action-buttons{gap:3px!important}
      .btn-small{padding:6px 8px!important;font-size:10px!important;min-width:70px!important}

      /* Modal full-screen on mobile */
      .modal-content{width:96%;margin:2% auto;padding:16px;border-radius:10px;max-height:94vh}
      #leadModal .modal-content{max-height:94vh}
      .section-header{font-size:1.1em;margin:18px 0 10px 0}
      .form-row{grid-template-columns:1fr;gap:10px}
      .form-group input,.form-group select,.form-group textarea{font-size:14px;padding:10px}
      .form-actions{flex-direction:row;gap:8px}
      .form-actions .btn{flex:1;padding:12px;font-size:14px;justify-content:center}

      /* Contact rows */
      .cp-row{flex-wrap:wrap;gap:4px}
      .cp-row input{min-width:0;font-size:12px;padding:8px}
      .contacts-popover{min-width:auto;max-width:95vw;width:95vw}

      /* Team modal */
      #teamModal > div{max-width:95vw!important;width:95vw!important}

      /* Notes edit */
      .notes-edit-card{width:95vw!important;max-width:95vw!important}

      /* Lead contact rows in modal */
      .lead-contact-row{flex-wrap:wrap!important;gap:4px!important}
      .lead-contact-row input{min-width:0!important;flex:1 1 100%!important}
    }

    @media (max-width: 480px) {
      body{padding:4px}
      .container{padding:8px;border-radius:8px}
      .page-header{margin:-8px -8px 12px -8px;padding:12px}
      .page-header h1{font-size:1.1rem}
      .btn{padding:9px 10px;font-size:11px;flex:1 1 calc(50% - 4px)}
      table{min-width:600px}
      th{font-size:9px;padding:6px 3px}
      td{font-size:10px;padding:6px 3px}
      .modal-content{width:98%;margin:1% auto;padding:12px}
      .form-group label{font-size:13px}
      .form-actions .btn{padding:12px 8px;font-size:13px}

      /* Stacked action buttons on tiny screens */
      .action-buttons{grid-template-columns:1fr!important;gap:3px!important;min-width:80px!important}
      .btn-small{min-width:0!important;width:100%!important}
    }

    
  </style>
</head>
<body>
  <div class="container">
    <div class="page-header">
      <h1>Lead Database</h1>
    </div>

    <div class="controls">
      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <button class="btn" onclick="goToDashboard()" style="background:linear-gradient(135deg,#6b7280 0%,#4b5563 100%)"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg> Back to Dashboard</button>
        <button class="btn btn-secondary" onclick="openAddLeadModal()"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg> Add New Lead</button>
        <button class="btn" onclick="window.location.href='lead-logger-follow-up-actions.html'" style="background:linear-gradient(135deg,#14b8a6 0%,#0d9488 100%)"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg> Follow Up Actions</button>
        <button class="btn" onclick="openTeamMembersModal()" style="background:linear-gradient(135deg,#f59e0b 0%,#d97706 100%)"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg> Team Members</button>
        <button class="btn" onclick="downloadLeadTemplate()" style="background:linear-gradient(135deg,#059669 0%,#047857 100%)"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg> Download Excel Template</button>
        <button class="btn" onclick="openImportModal()" style="background:linear-gradient(135deg,#7c3aed 0%,#6d28d9 100%)"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 16 12 12 8 16"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"/></svg> Import Excel File</button>
        <button class="btn" onclick="exportLeadsToExcel()" style="background:linear-gradient(135deg,#dc2626 0%,#b91c1c 100%)"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg> Export Current Leads</button>
        <button class="btn btn-settings" onclick="openSettingsModal()" title="Settings"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></button>
      </div>

      <div class="filters">
        <select id="repFilter" onchange="filterLeads()"><option value="">All Reps</option></select>
        <select id="statusFilter" onchange="filterLeads()">
          <option value="">All Status</option>
          <option value="Active" selected>Active</option>
          <option value="Signed Up">Signed Up</option>
          <option value="Dead">Dead</option>
        </select>
        <input type="search" id="searchInput" placeholder="Search leads, city, state, zip..." onkeyup="filterLeads()"/>
      </div>
    </div>

    <div class="table-container">
      <div id="loadingState" class="loading">
        <div class="spinner"></div>
        <p>Loading leads...</p>
      </div>

      <table id="leadsTable" style="display:none;">
        <thead>
          <tr>
            <th class="sortable" data-sort="dateAdded" style="min-width:75px">Date</th>
            <th class="sortable" data-sort="companyName">Company</th>
            <th class="sortable" data-sort="contactName">Contact</th>
            <th>Phone</th>
            <th>Email</th>
            <th class="sortable" data-sort="repName">Rep</th>
            <th class="sortable" data-sort="status">Status</th>
            <th>Notes</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="leadsTableBody"></tbody>
      </table>

      <div id="emptyState" class="empty-state" style="display:none;">
        <h3>No leads found</h3>
        <p>Add your first lead using the form above.</p>
      </div>
    </div>
  </div>

 <!-- Duplicate Check Search Modal -->
  <div id="dupCheckModal" class="modal" aria-hidden="true" style="z-index:1100">
    <div class="modal-content" style="max-width:540px">
      <span class="close" onclick="closeDupCheck()">&times;</span>
      <h2 style="margin-bottom:4px">Add New Lead</h2>
      <p style="color:#64748b;font-size:14px;margin-bottom:16px">Enter the company name to check for duplicates first</p>
      <div class="form-group" style="margin-bottom:12px">
        <label for="dupSearchInput">Company Name *</label>
        <input type="text" id="dupSearchInput" placeholder="Start typing company name..." autocomplete="off" style="font-size:16px;padding:14px"/>
      </div>
      <div id="dupResults" style="display:none;margin-bottom:16px">
        <!-- Populated by JS -->
      </div>
      <div id="dupNoMatch" style="display:none;background:#ecfdf5;border:2px solid #10b981;border-radius:10px;padding:14px;margin-bottom:16px;text-align:center">
        <span style="color:#059669;font-weight:700;font-size:15px">No duplicates found</span>
      </div>
      <div style="display:flex;gap:10px">
        <button type="button" class="btn btn-secondary" onclick="closeDupCheck()" style="flex:1">Cancel</button>
        <button type="button" class="btn btn-primary" id="dupProceedBtn" onclick="proceedFromDupCheck()" disabled style="flex:2">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Continue to Add Lead
        </button>
      </div>
    </div>
  </div>

 <!-- Add/Edit Lead Modal -->
  <div id="leadModal" class="modal" aria-hidden="true">
    <div class="modal-content" id="leadModalContent">
      <span class="close" onclick="attemptCloseModal()">&times;</span>
      <h2 id="modalTitle">Add New Lead</h2>

      <form id="leadForm" onsubmit="return false;">
        <!-- Business Unit removed ? field left optional in backend -->
        <input type="hidden" id="businessUnit" name="businessUnit" value=""/>

        <div class="form-group">
          <label for="companyName">Company Name *</label>
          <input type="text" id="companyName" name="companyName" list="companySuggestions" required />
          <datalist id="companySuggestions"></datalist>
        </div>

        <div class="form-group">
          <label for="customerAddress">Company Address</label>
          <input type="text" id="customerAddress" name="customerAddress" placeholder="123 Main Street, City"/>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="customerState">Company State</label>
            <select id="customerState" name="customerState">
              <option value="">Select...</option>
              <option value="AL">Alabama</option>
              <option value="AK">Alaska</option>
              <option value="AZ">Arizona</option>
              <option value="AR">Arkansas</option>
              <option value="CA">California</option>
              <option value="CO">Colorado</option>
              <option value="CT">Connecticut</option>
              <option value="DE">Delaware</option>
              <option value="FL">Florida</option>
              <option value="GA">Georgia</option>
              <option value="HI">Hawaii</option>
              <option value="ID">Idaho</option>
              <option value="IL">Illinois</option>
              <option value="IN">Indiana</option>
              <option value="IA">Iowa</option>
              <option value="KS">Kansas</option>
              <option value="KY">Kentucky</option>
              <option value="LA">Louisiana</option>
              <option value="ME">Maine</option>
              <option value="MD">Maryland</option>
              <option value="MA">Massachusetts</option>
              <option value="MI">Michigan</option>
              <option value="MN">Minnesota</option>
              <option value="MS">Mississippi</option>
              <option value="MO">Missouri</option>
              <option value="MT">Montana</option>
              <option value="NE">Nebraska</option>
              <option value="NV">Nevada</option>
              <option value="NH">New Hampshire</option>
              <option value="NJ">New Jersey</option>
              <option value="NM">New Mexico</option>
              <option value="NY">New York</option>
              <option value="NC">North Carolina</option>
              <option value="ND">North Dakota</option>
              <option value="OH">Ohio</option>
              <option value="OK">Oklahoma</option>
              <option value="OR">Oregon</option>
              <option value="PA">Pennsylvania</option>
              <option value="RI">Rhode Island</option>
              <option value="SC">South Carolina</option>
              <option value="SD">South Dakota</option>
              <option value="TN">Tennessee</option>
              <option value="TX">Texas</option>
              <option value="UT">Utah</option>
              <option value="VT">Vermont</option>
              <option value="VA">Virginia</option>
              <option value="WA">Washington</option>
              <option value="WV">West Virginia</option>
              <option value="WI">Wisconsin</option>
              <option value="WY">Wyoming</option>
            </select>
          </div>
          <div class="form-group">
            <label for="customerZip">Company Zip</label>
            <input type="text" id="customerZip" name="customerZip" pattern="[0-9]{5}" maxlength="5" placeholder="12345" inputmode="numeric"/>
          </div>
        </div>

        <div class="form-group">
          <label for="phoneNumber">Company Phone Number</label>
          <input type="tel" id="phoneNumber" name="phoneNumber" placeholder="123-456-7890" maxlength="12"/>
        </div>

        <div class="section-header" style="display:flex;align-items:center;justify-content:space-between">
          <span>Contacts</span>
          <button type="button" onclick="addLeadContact()" style="padding:4px 12px;border:1px solid #10b981;border-radius:6px;background:#ecfdf5;color:#059669;font-size:12px;font-weight:600;cursor:pointer">+ Add Contact</button>
        </div>
        <div id="leadContactsList"></div>
        <!-- Hidden fields for form submission backward compat -->
        <input type="hidden" id="contactName" name="contactName"/>
        <input type="hidden" id="emailAddress" name="emailAddress"/>

        <div class="section-header">Sales Representative</div>
        <div class="form-group">
            <label for="repSelect">Select Sales Rep *</label>
            <select id="repSelect" name="repSelect" required onchange="onRepSelected()">
              <option value="">Select a rep...</option>
            </select>
        </div>
        <!-- Status hidden ? defaults to Active on new leads -->
        <input type="hidden" id="status" name="status" value="Active"/>
        <!-- Hidden fields populated by rep dropdown -->
        <input type="hidden" id="repName" name="repName"/>
        <input type="hidden" id="repPhone" name="repPhone"/>
        <input type="hidden" id="repEmail" name="repEmail"/>

        <!-- Follow Up / Appointment fields removed ? managed via Follow Up Actions page -->

        <div class="form-group">
          <label for="notes">Notes</label>
          <textarea id="notes" name="notes" rows="4"></textarea>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-cancel" onclick="attemptCloseModal()">Cancel</button>
          <button type="button" id="saveBtn" class="btn">Save Lead</button>
        </div>
      </form>
    </div>
  </div>
  <!-- Excel Import Modal -->
  <div id="importModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <span class="close" onclick="closeImportModal()">&times;</span>
      <h2>Import Leads from Excel</h2>
      
      <div style="background:#f0f8ff;padding:20px;border-radius:8px;margin:20px 0;border:1px solid #b3d9ff;">
        <h3 style="color:#2c5aa0;margin-bottom:10px;">Instructions:</h3>
        <ol style="color:#4a5568;line-height:1.6;">
          <li>Download the Excel template using the "Download Excel Template" button</li>
          <li>Fill in your leads data (one lead per row)</li>
          <li>Save the file and select it below</li>
          <li>Click "Import Leads" to upload</li>
        </ol>
        <p style="color:#e53e3e;margin-top:10px;font-weight:600;">
          <span class="icon-inline"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#e53e3e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></span> Required fields: Business Unit, Company Name, Rep Name, Rep Phone, Rep Email
        </p>
      </div>

      <div class="form-group">
        <label for="excelFileInput">Select Excel File (.xlsx)</label>
        <input type="file" id="excelFileInput" accept=".xlsx,.xls" onchange="handleFileSelect(event)"/>
        <small>Supported formats: .xlsx, .xls</small>
      </div>

      <div id="filePreview" style="display:none;margin:20px 0;">
        <h3>File Preview:</h3>
        <div id="previewContent" class="file-preview" style="max-height:200px;overflow-y:auto;">
          <!-- Preview content will be inserted here -->
        </div>
        <p id="previewSummary" style="color:#4a5568;margin-top:10px;"></p>
      </div>

      <div class="form-actions">
        <button type="button" class="btn btn-cancel" onclick="closeImportModal()">Cancel</button>
        <button type="button" id="importBtn" class="btn" onclick="importLeads()" disabled>Import Leads</button>
      </div>
    </div>
  </div>

  <!-- Fix Import Errors Modal -->
  <div id="fixErrorsModal" class="modal" aria-hidden="true" style="display:none;">
    <div class="modal-content" style="max-width:900px;max-height:90vh;overflow-y:auto;">
      <span class="close" onclick="cancelErrorFix()">&times;</span>
      <h2>Fix Import Errors</h2>
      
      <div style="background:#fff3cd;padding:15px;border-radius:8px;margin:20px 0;border:1px solid #ffc107;">
        <p style="color:#856404;font-weight:600;margin-bottom:10px;">
          <span class="icon-inline"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#856404" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></span> <span id="errorSummary">Found validation errors in your import file</span>
        </p>
        <p style="color:#856404;font-size:14px;">
          Fix the errors below, or import only the valid rows and fix the rest later.
        </p>
      </div>

      <div id="errorRowsContainer" style="margin:20px 0;">
        <!-- Error rows will be dynamically inserted here -->
      </div>

      <div class="form-actions" style="display:flex;gap:10px;justify-content:space-between;">
        <button type="button" class="btn btn-cancel" onclick="cancelErrorFix()">Cancel Import</button>
        <div style="display:flex;gap:10px;">
          <button type="button" class="btn" style="background:#ffc107;color:#000;" onclick="importValidRowsOnly()">
            Import <span id="validCount">0</span> Valid Rows Only
          </button>
          <button type="button" id="completeImportBtn" class="btn" onclick="completeImportWithFixes()" disabled>
            Complete Import (All Rows)
          </button>
        </div>
      </div>
    </div>
  </div>


  


<!-- Confirmation Modal -->
  <div id="confirmModal" class="modal" aria-hidden="true" style="display:none;">
    <div class="modal-content" style="max-width:500px;text-align:center;">
      <h2 id="confirmTitle">Confirm Action</h2>
      <p id="confirmMessage" style="color:#4a5568;margin:20px 0;font-size:16px;"></p>
      <div class="form-actions" style="justify-content:center;gap:15px;">
        <button type="button" class="btn btn-cancel" onclick="closeConfirmModal(false)">Cancel</button>
        <button type="button" class="btn" id="confirmBtn" onclick="closeConfirmModal(true)">Confirm</button>
      </div>
    </div>
  </div>




  

  <!-- Delete Confirmation Modal -->
  <div id="deleteModal" class="modal delete-modal" aria-hidden="true">
    <div class="modal-content">
      <span class="close" onclick="closeDeleteModal()">&times;</span>
      <h2>Delete Lead Permanently</h2>
      <p style="color:#4a5568;margin-bottom:15px;">This action cannot be undone. The lead will be permanently deleted from the database.</p>
      
      <div class="company-name" id="deleteCompanyName">
        Company Name Will Show Here
      </div>
      
      <p style="margin:20px 0;font-weight:600;color:#721c24;">Type "yes" to confirm deletion:</p>
      
      <div class="form-group">
        <input type="text" id="deleteConfirmInput" placeholder="Type 'yes' to confirm" onkeyup="validateDeleteConfirmation()" style="border-color:#e53e3e"/>
      </div>

      <div class="form-actions">
        <button type="button" class="btn btn-cancel" onclick="closeDeleteModal()">Cancel</button>
        <button type="button" id="confirmDeleteBtn" class="btn btn-danger" onclick="confirmDeleteLead()" disabled>Delete Lead Permanently</button>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="modal" aria-hidden="true" style="display:none;">
    <div class="modal-content">
      <span class="close" onclick="closeSettingsModal()">&times;</span>
      <h2 style="display:flex;align-items:center;gap:10px;">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#2d3748" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
        Settings
      </h2>

      <div class="settings-section">
        <h3>
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#2d3748" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
          Follow-Up Email Reminders
        </h3>
        
        <div class="setting-row">
          <div>
            <div class="setting-label">Enable Email Reminders</div>
            <div class="setting-desc">Send follow-up reminder emails to reps</div>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="emailEnabled" onchange="toggleEmailSettings()">
            <span class="toggle-slider"></span>
          </label>
        </div>

        <div id="emailOptionsSection" style="display:none;">
          <div class="setting-row">
            <div>
              <div class="setting-label">Frequency</div>
              <div class="setting-desc">How often reminders are sent</div>
            </div>
            <select id="emailFrequency" style="width:160px;">
              <option value="daily">Daily (7:00 AM)</option>
              <option value="weekly_mon">Weekly (Monday)</option>
              <option value="weekly_fri">Weekly (Friday)</option>
            </select>
          </div>

          <div class="setting-row">
            <div>
              <div class="setting-label">Include Overdue</div>
              <div class="setting-desc">Also include leads with past-due follow-ups</div>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="includeOverdue" checked>
              <span class="toggle-slider"></span>
            </label>
          </div>

          <div class="setting-row">
            <div>
              <div class="setting-label">Look-Ahead Days</div>
              <div class="setting-desc">Include follow-ups within this many days</div>
            </div>
            <select id="lookAheadDays" style="width:160px;">
              <option value="0">Today only</option>
              <option value="1" selected>1 day ahead</option>
              <option value="3">3 days ahead</option>
              <option value="7">7 days ahead</option>
            </select>
          </div>
        </div>

        <div class="email-status" id="emailStatusDisplay">
          <span class="status-dot inactive" id="emailStatusDot"></span>
          <span id="emailStatusText">Loading status...</span>
        </div>
      </div>

      <div class="form-actions">
        <button type="button" class="btn btn-cancel" onclick="closeSettingsModal()">Cancel</button>
        <button type="button" class="btn" id="saveSettingsBtn" onclick="saveEmailSettings()">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
          Save Settings
        </button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // ====== SVG ICON HELPERS ======
    var SVG_ICONS = {
      warning: '<span class="icon-inline"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></span>',
      checkCircle: '<span class="icon-inline"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg></span>',
      xCircle: '<span class="icon-inline"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg></span>'
    };

    // ====== CONFIG ======
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbw1uRg1v6Cjqp9g2J-Q3CMsUzj1KbBfuiKnLgsYjhQe1n2x9bMSShB5eCw7mhA9-StC/exec';

    function esc(s) { var d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }

    let allLeads = [];
    let currentEditId = null;
    let knownCompanies = [];
    let currentLeadForProposal = null;
    let currentLeadToDelete = null;
    let notesTooltip = null;
    // Import error fixing state
    let importValidLeads = [];
    let importErrorLeads = [];
    // Confirmation modal callback
    let confirmCallback = null;
    let importFileData = null;

    // Track unsaved edits in the modal
    let formInitialSnapshot = '';
    let formDirty = false;

    function safeLeadId(obj){
      const id = obj?.id ?? obj?.ID ?? obj?.Id ?? obj?.iD ?? obj?.leadId ?? '';
      return String(id).trim();
    }

    window.addEventListener('DOMContentLoaded', () => {
      document.getElementById('saveBtn').addEventListener('click', onSaveClick);

      // static backdrop
      const modal = document.getElementById('leadModal');
      modal.addEventListener('click', (e) => { if (e.target === modal) e.stopPropagation(); });

      loadLeads();
      loadCompanyLists();
      setupPhoneFormatting();
      setupRepPhoneFormatting();
      setupNotesTooltip();
      initSortableHeaders();
      prefetchTeamMembers();
    });

    // Manual refresh: user can reload page to get latest data

    function setupPhoneFormatting(){
      const phoneInput = document.getElementById('phoneNumber');
      phoneInput.addEventListener('input', (e) => {
        let v = e.target.value.replace(/\D/g,'');
        if (v.length >= 6) v = v.slice(0,3)+'-'+v.slice(3,6)+'-'+v.slice(6,10);
        else if (v.length >= 3) v = v.slice(0,3)+'-'+v.slice(3);
        e.target.value = v;
      });
      phoneInput.addEventListener('keypress', (e) => {
        const ch = String.fromCharCode(e.which);
        if (!/[0-9-]/.test(ch)) e.preventDefault();
      });
    }

    function setupRepPhoneFormatting() {
      const repPhoneInput = document.getElementById('repPhone');
      repPhoneInput.addEventListener('input', (e) => {
        let v = e.target.value.replace(/\D/g,'');
        if (v.length >= 6) v = v.slice(0,3)+'-'+v.slice(3,6)+'-'+v.slice(6,10);
        else if (v.length >= 3) v = v.slice(0,3)+'-'+v.slice(3);
        e.target.value = v;
      });
      repPhoneInput.addEventListener('keypress', (e) => {
        const ch = String.fromCharCode(e.which);
        if (!/[0-9-]/.test(ch)) e.preventDefault();
      });
    }

    function setupNotesTooltip() {
      // Create tooltip element
      notesTooltip = document.createElement('div');
      notesTooltip.className = 'notes-tooltip';
      document.body.appendChild(notesTooltip);
    }

    function showNotesTooltip(element, fullText) {
      if (!fullText || fullText.trim() === '') return;
      
      const rect = element.getBoundingClientRect();
      notesTooltip.textContent = fullText;
      notesTooltip.style.left = (rect.left + window.scrollX) + 'px';
      notesTooltip.style.top = (rect.top + window.scrollY - notesTooltip.offsetHeight - 10) + 'px';
      notesTooltip.classList.add('show');
    }

    function hideNotesTooltip() {
      notesTooltip.classList.remove('show');
    }

    // FIXED: Show/hide Quantum fields based on business unit selection
    function toggleQuantumFields() {
      // No-op: Business Unit field removed from modal
    }

    async function loadLeads(){
      try{
        // Instant load from cache
        var cached = sessionStorage.getItem('cachedLeads');
        if (cached) {
          try {
            allLeads = JSON.parse(cached);
            updateRepFilter();
            filterLeads();
          } catch(e) {}
        }
        
        if (!cached) {
          document.getElementById('loadingState').style.display='block';
          document.getElementById('leadsTable').style.display='none';
          document.getElementById('emptyState').style.display='none';
        }

        const res = await fetch(WEB_APP_URL + '?action=getLeads');
        const data = await res.json();
        if (data.status !== 'success') throw new Error(data.message || 'Failed to load leads');

        allLeads = data.leads || [];
        
        // Cache for instant load on next visit
        try { sessionStorage.setItem('cachedLeads', JSON.stringify(allLeads)); } catch(e) {}
        
        updateRepFilter();
        filterLeads(); // ? render using current dropdowns (default = Active)
      }catch(err){
        console.error('loadLeads error:', err);
        document.getElementById('loadingState').style.display='none';
        document.getElementById('emptyState').style.display='block';
        showToast('Error loading leads. ' + err.message, 'error');
      }
    }

    async function loadCompanyLists(){
      try{
        const res = await fetch(WEB_APP_URL + '?action=getCompanies');
        const data = await res.json();
        if (data.status !== 'success') throw new Error('API returned non-success status');

        knownCompanies = Array.isArray(data.companies) ? data.companies : [];
        const dl = document.getElementById('companySuggestions');
        dl.innerHTML = '';
        knownCompanies.forEach(name => {
          const opt = document.createElement('option'); opt.value = name; dl.appendChild(opt);
        });

        // FIXED: Normalize business units to prevent duplicates
        const normalizeUnit = function(unit) {
          if (!unit) return '';
          const normalized = unit.trim();
          // Fix common variations
          if (normalized.toLowerCase() === 'abbondanza vending') return 'Abbondanza Vending';
          if (normalized.toLowerCase() === 'quantum solutions') return 'Quantum Solutions';
          return normalized;
        };

        const unitsFromApi = Array.isArray(data.businessUnits) ? data.businessUnits.map(normalizeUnit) : [];
        const unitsFromLeads = [...new Set((allLeads||[]).map(l => normalizeUnit(l.businessUnit)).filter(Boolean))];
        const defaultUnits = ['Abbondanza Vending', 'Quantum Solutions'];
        const allUnits = [...new Set([...defaultUnits, ...unitsFromApi, ...unitsFromLeads])];
        const units = allUnits.sort();

        const sel = document.getElementById('companyFilter');
        if (sel) {
          sel.innerHTML = '<option value="">All Business Units</option>';
          units.forEach(u => {
            const o = document.createElement('option'); o.value = u; o.textContent = u; sel.appendChild(o);
          });
        }

        const bu = document.getElementById('businessUnit');
        const current = bu.value;
        bu.innerHTML = '<option value="">Select...</option>' + units.map(u => '<option value="' + u + '">' + u + '</option>').join('');
        if (current) bu.value = current;
      }catch(e){
        console.warn('getCompanies failed, using defaults:', e);
        const fallback = ['Abbondanza Vending','Quantum Solutions'];

        const sel = document.getElementById('companyFilter');
        if (sel) {
          sel.innerHTML = '<option value="">All Business Units</option>' + fallback.map(u=>'<option value="' + u + '">' + u + '</option>').join('');
        }

        const bu = document.getElementById('businessUnit');
        const current = bu.value;
        bu.innerHTML = '<option value="">Select...</option>' + fallback.map(u => '<option value="' + u + '">' + u + '</option>').join('');
        if (current) bu.value = current;
      }
    }

    function displayLeads(leads){
      const tbody = document.getElementById('leadsTableBody');
      const table = document.getElementById('leadsTable');
      const loading = document.getElementById('loadingState');
      const empty = document.getElementById('emptyState');

      tbody.innerHTML = '';
      loading.style.display = 'none';

      if (!leads.length){
        table.style.display = 'none';
        empty.style.display = 'block';
        return;
      }
      table.style.display = 'table';
      empty.style.display = 'none';

      leads.forEach(lead => tbody.appendChild(createLeadRow(lead)));
    }

    function createLeadRow(lead){
      const row = document.createElement('tr');
      const leadId = safeLeadId(lead);

      const dateAdded = formatDate(lead.dateAdded);
      const followUp = formatDate(lead.followUp);
      const appointmentDate = formatDate(lead.appointmentDate);
      const statusClass = getStatusClass(lead.status);
      const notes = (lead.notes != null) ? String(lead.notes) : '';

      // Build contact cell - clickable to edit
      var contactCell = '';
      if (lead.contacts && lead.contacts.length > 0) {
        contactCell = lead.contacts.map(function(c) {
          var parts = [];
          if (c.name) parts.push(c.name);
          if (c.position) parts.push('<span style="color:#6b7280;font-size:11px">(' + c.position + ')</span>');
          return parts.join(' ') || '';
        }).filter(Boolean).join('<br/>');
      }
      if (!contactCell) contactCell = lead.contactName || '';
      contactCell = '<span class="contacts-clickable" onclick="openInlineContacts(event,\'' + leadId + '\')">' + (contactCell || '<span style="color:#94a3b8;font-style:italic">+ Add Contact</span>') + '</span>';

      // Build email cell - clickable to edit
      var emailCell = '';
      if (lead.contacts && lead.contacts.length > 0) {
        emailCell = lead.contacts.map(function(c) { return c.email || ''; }).filter(Boolean).join('<br/>');
      }
      if (!emailCell) emailCell = lead.emailAddress || '';
      emailCell = '<span class="contacts-clickable" onclick="openInlineContacts(event,\'' + leadId + '\')">' + (emailCell || '<span style="color:#94a3b8;font-style:italic">+ Add</span>') + '</span>';


      const cells = [
        dateAdded,
        `<strong>${lead.companyName || ''}</strong>`,
        contactCell,
        lead.phoneNumber || '',
        emailCell,
        lead.repName || '',
        `<span class="status-badge ${statusClass}" onclick="openStatusPicker(event,this,'${leadId}')">${lead.status || 'Active'}</span>`,
        notes
          ? `<span class="notes-clickable" onclick="inlineNotesEdit(this,'${leadId}')">${notesPreview(notes)}</span>`
          : `<span class="notes-clickable empty" onclick="inlineNotesEdit(this,'${leadId}')">+ Add Note</span>`,
        `<div class="action-buttons" style="display:flex;flex-wrap:wrap;gap:4px;justify-content:center">
           <button class="btn btn-small" style="background:linear-gradient(135deg,#dc2626,#ef4444);padding:7px 14px;font-size:11px;min-width:90px;justify-content:center" onclick="sendRepAlertFromDB('${leadId}')"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-1px;margin-right:2px"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>Alert Rep</button>
           <button class="btn btn-small" style="background:linear-gradient(135deg,#10b981,#059669);padding:7px 14px;font-size:11px;min-width:90px;justify-content:center" onclick="editLead('${leadId}')">Edit</button>
           <button class="btn btn-small" style="background:linear-gradient(135deg,#f59e0b,#d97706);padding:7px 14px;font-size:11px;min-width:90px;justify-content:center" onclick="archiveLead(this,'${leadId}')">Archive</button>
           <button class="btn btn-small" style="background:linear-gradient(135deg,#ef4444,#dc2626);padding:7px 14px;font-size:11px;min-width:90px;justify-content:center" onclick="openDeleteModal('${leadId}')">Delete</button>
         </div>`
      ];

      cells.forEach((html, index) => { 
        const td = document.createElement('td'); 
        td.innerHTML = html; 
        
        // Add hover tooltip for notes column (index 7) - show full notes on hover
        if (index === 7 && notes.trim() !== '') {
          td.setAttribute('data-full-notes', notes);
          td.addEventListener('mouseenter', (e) => showNotesTooltip(e.target, notes));
          td.addEventListener('mouseleave', hideNotesTooltip);
        }
        
        row.appendChild(td); 
      });
      return row;
    }

    function getStatusClass(status){
      const map = {'Active':'status-active','Signed Up':'status-signedup','Dead':'status-dead'};
      return map[status] || 'status-active';
    }

    function formatDate(s){
      if (!s) return '';
      const d = new Date(s);
      if (isNaN(d)) return '';
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      const y = d.getFullYear();
      return `${m}/${day}/${y}`;
    }

    function filterLeads(){
      const rep = document.getElementById('repFilter').value.toLowerCase();
      const status = document.getElementById('statusFilter').value;
      const q = document.getElementById('searchInput').value.toLowerCase();

      const filtered = (allLeads || []).filter(l => {
        const matchRep = !rep || ((l.repName||'').toLowerCase().includes(rep));
        const matchStatus = !status || (l.status === status);
        const matchSearch = !q ||
          (l.companyName && l.companyName.toLowerCase().includes(q)) ||
          (l.contactName && l.contactName.toLowerCase().includes(q)) ||
          (l.phoneNumber && String(l.phoneNumber).toLowerCase().includes(q)) ||
          (l.emailAddress && l.emailAddress.toLowerCase().includes(q)) ||
          (l.customerAddress && l.customerAddress.toLowerCase().includes(q)) ||
          (l.customerState && String(l.customerState).toLowerCase().includes(q)) ||
          (l.customerZip && String(l.customerZip).toLowerCase().includes(q)) ||
          (l.notes && String(l.notes).toLowerCase().includes(q)) ||
          (l.contacts && l.contacts.some(function(c) {
            return (c.name && c.name.toLowerCase().includes(q)) ||
                   (c.email && c.email.toLowerCase().includes(q)) ||
                   (c.position && c.position.toLowerCase().includes(q));
          }));
        return matchRep && matchStatus && matchSearch;
      });

      displayLeads(sortLeads(filtered));
    }

    function updateRepFilter(){
      const sel = document.getElementById('repFilter');
      const reps = [...new Set((allLeads || []).map(l => l.repName).filter(Boolean))].sort();
      sel.innerHTML = '<option value="">All Reps</option>';
      reps.forEach(r => { const o = document.createElement('option'); o.value = r; o.textContent = r; sel.appendChild(o); });
    }

    // ========== MULTI-CONTACT MANAGEMENT ==========
    var leadContacts = [];

    function renderLeadContacts() {
      var el = document.getElementById('leadContactsList');
      if (!el) return;
      if (leadContacts.length === 0) {
        el.innerHTML = '<div style="padding:10px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:6px;text-align:center;color:#94a3b8;font-size:13px">No contacts added. Click "+ Add Contact" above.</div>';
        return;
      }
      var h = '<div style="display:flex;gap:4px;padding:0 0 4px;font-size:11px;color:#94a3b8;font-weight:600"><span style="flex:1">Name</span><span style="flex:1.2">Email</span><span style="flex:0.7">Position / Title</span><span style="width:28px"></span></div>';
      for (var i = 0; i < leadContacts.length; i++) {
        var c = leadContacts[i];
        h += '<div style="display:flex;align-items:center;gap:6px;padding:6px 0;border-bottom:1px solid #f1f5f9">';
        h += '<input type="text" value="' + String(c.name||'').replace(/"/g,'&quot;') + '" placeholder="Contact name" oninput="leadContacts[' + i + '].name=this.value" style="flex:1;padding:8px 10px;border:1px solid #e2e8f0;border-radius:6px;font-size:13px"/>';
        h += '<input type="email" value="' + String(c.email||'').replace(/"/g,'&quot;') + '" placeholder="email@company.com" oninput="leadContacts[' + i + '].email=this.value" style="flex:1.2;padding:8px 10px;border:1px solid #e2e8f0;border-radius:6px;font-size:13px"/>';
        h += '<input type="text" value="' + String(c.position||'').replace(/"/g,'&quot;') + '" placeholder="e.g. Owner, GM" oninput="leadContacts[' + i + '].position=this.value" style="flex:0.7;padding:8px 10px;border:1px solid #e2e8f0;border-radius:6px;font-size:13px"/>';
        h += '<button type="button" onclick="removeLeadContact(' + i + ')" style="width:28px;height:28px;border:1px solid #fecaca;border-radius:6px;background:#fff;color:#ef4444;font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0" title="Remove">&times;</button>';
        h += '</div>';
      }
      el.innerHTML = h;
    }

    function addLeadContact() {
      leadContacts.push({name:'', email:'', position:''});
      renderLeadContacts();
      // Focus the new name field
      setTimeout(function(){ var inputs = document.querySelectorAll('#leadContactsList input[type="text"]'); if(inputs.length) inputs[inputs.length-3].focus(); }, 50);
    }

    function removeLeadContact(idx) {
      leadContacts.splice(idx, 1);
      renderLeadContacts();
    }

    function syncContactsToHiddenFields() {
      // Set hidden fields for backward compat with FormData
      var primary = leadContacts.length > 0 ? leadContacts[0] : {name:'', email:''};
      document.getElementById('contactName').value = primary.name || '';
      document.getElementById('emailAddress').value = primary.email || '';
    }

    // ==================== DUPLICATE CHECK ====================
    let dupCheckTimer = null;

    function openAddLeadModal(){
      // Show dup check modal first (not the lead form)
      document.getElementById('dupSearchInput').value = '';
      document.getElementById('dupResults').style.display = 'none';
      document.getElementById('dupResults').innerHTML = '';
      document.getElementById('dupNoMatch').style.display = 'none';
      document.getElementById('dupProceedBtn').disabled = true;
      document.getElementById('dupCheckModal').style.display = 'block';
      setTimeout(function(){ document.getElementById('dupSearchInput').focus(); }, 100);

      // Live search as user types
      var input = document.getElementById('dupSearchInput');
      input.oninput = function() {
        clearTimeout(dupCheckTimer);
        var q = input.value.trim();
        if (q.length < 2) {
          document.getElementById('dupResults').style.display = 'none';
          document.getElementById('dupNoMatch').style.display = 'none';
          document.getElementById('dupProceedBtn').disabled = true;
          return;
        }
        dupCheckTimer = setTimeout(function(){ runDupCheck(q); }, 250);
      };
    }

    function closeDupCheck(){
      document.getElementById('dupCheckModal').style.display = 'none';
    }

    function runDupCheck(query) {
      var matches = fuzzyMatchLeads(query, allLeads || [], 5);
      var resultsDiv = document.getElementById('dupResults');
      var noMatchDiv = document.getElementById('dupNoMatch');
      var proceedBtn = document.getElementById('dupProceedBtn');

      if (matches.length > 0) {
        var h = '<div style="font-weight:700;color:#dc2626;font-size:13px;margin-bottom:8px">Potential Duplicates Found:</div>';
        for (var i = 0; i < matches.length; i++) {
          var m = matches[i];
          var lead = m.lead;
          h += '<div class="dup-match">';
          h += '  <div class="dup-match-header">';
          h += '    <span class="dup-match-badge">MATCH</span>';
          h += '    <span class="dup-match-company">' + esc(lead.companyName || '') + '</span>';
          h += '    <span class="dup-match-score">' + m.score + '% match</span>';
          h += '  </div>';
          h += '  <div class="dup-match-details">';
          if (lead.contactName) h += '<span>' + esc(lead.contactName) + '</span>';
          if (lead.phoneNumber) h += '<span>' + esc(lead.phoneNumber) + '</span>';
          if (lead.repName) h += '<span>' + esc(lead.repName) + '</span>';
          if (lead.status) h += '<span>' + esc(lead.status) + '</span>';
          if (lead.dateAdded) h += '<span>Added: ' + esc(String(lead.dateAdded).substring(0,10)) + '</span>';
          h += '  </div>';
          h += '</div>';
        }
        h += '<div style="background:#fffbeb;border:2px solid #fbbf24;border-radius:10px;padding:12px;text-align:center">';
        h += '<span style="font-weight:700;color:#92400e;font-size:14px">Potential duplicate ? do you still want to proceed?</span>';
        h += '</div>';
        resultsDiv.innerHTML = h;
        resultsDiv.style.display = 'block';
        noMatchDiv.style.display = 'none';
        proceedBtn.disabled = false;
        proceedBtn.textContent = 'Yes, Add Anyway';
        proceedBtn.style.background = 'linear-gradient(135deg,#f59e0b,#d97706)';
      } else {
        resultsDiv.style.display = 'none';
        noMatchDiv.style.display = 'block';
        proceedBtn.disabled = false;
        proceedBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg> Continue to Add Lead';
        proceedBtn.style.background = '';
      }
    }

    function fuzzyMatchLeads(query, leads, maxResults) {
      var q = normalizeStr(query);
      if (!q) return [];
      var scored = [];

      for (var i = 0; i < leads.length; i++) {
        var name = leads[i].companyName || '';
        var n = normalizeStr(name);
        if (!n) continue;

        var score = 0;

        // Exact match
        if (n === q) { score = 100; }
        // Starts with
        else if (n.indexOf(q) === 0) { score = 90; }
        // Contains
        else if (n.indexOf(q) > 0) { score = 75; }
        // Query starts with the lead name (user typed more)
        else if (q.indexOf(n) === 0) { score = 70; }
        // Word-level match
        else {
          var qWords = q.split(/\s+/);
          var nWords = n.split(/\s+/);
          var wordHits = 0;
          for (var w = 0; w < qWords.length; w++) {
            for (var nw = 0; nw < nWords.length; nw++) {
              if (nWords[nw].indexOf(qWords[w]) >= 0 || qWords[w].indexOf(nWords[nw]) >= 0) {
                wordHits++;
                break;
              }
            }
          }
          if (wordHits > 0) {
            score = Math.round(50 + (wordHits / Math.max(qWords.length, nWords.length)) * 30);
          }
        }

        // Levenshtein boost for close matches
        if (score === 0) {
          var dist = levenshtein(q, n);
          var maxLen = Math.max(q.length, n.length);
          var sim = Math.round((1 - dist / maxLen) * 100);
          if (sim >= 60) score = sim;
        }

        if (score >= 55) {
          scored.push({ lead: leads[i], score: score });
        }
      }

      // Sort by score descending
      scored.sort(function(a, b) { return b.score - a.score; });
      return scored.slice(0, maxResults);
    }

    function normalizeStr(s) {
      return String(s || '').toLowerCase().replace(/[^a-z0-9\s]/g, '').replace(/\s+/g, ' ').trim();
    }

    function levenshtein(a, b) {
      if (a.length === 0) return b.length;
      if (b.length === 0) return a.length;
      var matrix = [];
      for (var i = 0; i <= b.length; i++) matrix[i] = [i];
      for (var j = 0; j <= a.length; j++) matrix[0][j] = j;
      for (var i = 1; i <= b.length; i++) {
        for (var j = 1; j <= a.length; j++) {
          if (b.charAt(i - 1) === a.charAt(j - 1)) {
            matrix[i][j] = matrix[i - 1][j - 1];
          } else {
            matrix[i][j] = Math.min(matrix[i - 1][j - 1] + 1, matrix[i][j - 1] + 1, matrix[i - 1][j] + 1);
          }
        }
      }
      return matrix[b.length][a.length];
    }

    async function proceedFromDupCheck() {
      var companyName = document.getElementById('dupSearchInput').value.trim();
      closeDupCheck();
      await openAddLeadForm(companyName);
    }

    async function openAddLeadForm(prefillCompany){
      currentEditId = null;
      document.getElementById('modalTitle').textContent = 'Add New Lead';
      document.getElementById('leadForm').reset();
      document.getElementById('status').value = 'Active';
      
      // Clear all fields explicitly to prevent cache contamination
      document.getElementById('companyName').value = prefillCompany || '';
      document.getElementById('contactName').value = '';
      document.getElementById('phoneNumber').value = '';
      document.getElementById('emailAddress').value = '';
      document.getElementById('repName').value = '';
      document.getElementById('repPhone').value = '';
      document.getElementById('repEmail').value = '';
      document.getElementById('customerAddress').value = '';
      document.getElementById('customerState').value = '';
      document.getElementById('customerZip').value = '';
      document.getElementById('notes').value = '';
      document.getElementById('businessUnit').value = '';
      
      // Populate rep dropdown from pre-fetched team members
      await populateRepDropdown('');
      
      // Initialize contacts with one empty row
      leadContacts = [{name:'', email:'', position:''}];
      renderLeadContacts();
      
      // Reset save button state
      const saveBtn = document.getElementById('saveBtn');
      saveBtn.disabled = false;
      saveBtn.textContent = 'Save Lead';
      
      document.getElementById('leadModal').style.display = 'block';
      markFormPristineAndWatch();
    }

    async function editLead(leadId){
      try {
      const lead = (allLeads || []).find(l => safeLeadId(l) === String(leadId));
      if (!lead) { showToast('Lead not found: ID=' + leadId, 'error'); return; }

      currentEditId = safeLeadId(lead);
      document.getElementById('modalTitle').textContent = 'Edit Lead';

      document.getElementById('businessUnit').value = lead.businessUnit || '';
      document.getElementById('companyName').value = lead.companyName || '';
      document.getElementById('phoneNumber').value = lead.phoneNumber || '';
      document.getElementById('status').value = lead.status || 'Active';
      document.getElementById('notes').value = lead.notes || '';

      // Load contacts
      if (lead.contacts && lead.contacts.length > 0) {
        leadContacts = lead.contacts.map(function(c) { return {name:c.name||'', email:c.email||'', position:c.position||''}; });
      } else if (lead.contactName || lead.emailAddress) {
        leadContacts = [{name:lead.contactName||'', email:lead.emailAddress||'', position:''}];
      } else {
        leadContacts = [{name:'', email:'', position:''}];
      }
      renderLeadContacts();
      // Set hidden fields for backward compat
      document.getElementById('contactName').value = lead.contactName || '';
      document.getElementById('emailAddress').value = lead.emailAddress || '';

      // Populate rep dropdown and pre-select matching rep
      await populateRepDropdown(lead.repName || '');
      // Set hidden fields from lead data (in case rep not in dropdown)
      document.getElementById('repName').value = lead.repName || '';
      document.getElementById('repPhone').value = lead.repPhone || '';
      document.getElementById('repEmail').value = lead.repEmail || '';

      document.getElementById('customerAddress').value = lead.customerAddress || '';
      document.getElementById('customerState').value = lead.customerState || '';
      // FIXED: Only pad zip code if it exists and has a value
      const zipCode = lead.customerZip || '';
      if (zipCode && zipCode.toString().trim() !== '') {
        document.getElementById('customerZip').value = String(zipCode).padStart(5, '0');
      } else {
        document.getElementById('customerZip').value = '';
      }

      // Reset save button state
      const saveBtn = document.getElementById('saveBtn');
      saveBtn.disabled = false;
      saveBtn.textContent = 'Save Lead';

      document.getElementById('leadModal').style.display = 'block';
      markFormPristineAndWatch();
      } catch(e) { showToast('Error opening edit: ' + e.message, 'error'); }
    }

    function attemptCloseModal(){
      if (formDirty){
        const ok = confirm('Discard your changes?');
        if (!ok) return;
      }
      closeModal();
    }

    function closeModal(){
      document.getElementById('leadModal').style.display = 'none';
      document.getElementById('leadForm').reset();
      currentEditId = null;
      formDirty = false;
      formInitialSnapshot = '';
      removeFormWatchers();
    }

    function toggleAppointmentDate(){
      // No-op: Appointment fields removed from modal
    }

    // Track pristine/dirty state
    function snapshotForm(){
      const formEl = document.getElementById('leadForm');
      const form = new FormData(formEl);
      const lead = Object.fromEntries(form.entries());
      if (lead.customerZip) {
        lead.customerZip = String(lead.customerZip).padStart(5, '0');
      }
      return JSON.stringify(lead);
    }
    function markFormPristineAndWatch(){
      formInitialSnapshot = snapshotForm();
      formDirty = false;
      removeFormWatchers();
      // Re-attach phone formatting (removeFormWatchers clones elements, stripping listeners)
      setupPhoneFormatting();
      const formEl = document.getElementById('leadForm');
      const markDirty = () => { formDirty = (snapshotForm() !== formInitialSnapshot); };
      formEl.querySelectorAll('input,select,textarea').forEach(el => {
        el.addEventListener('input', markDirty);
        el.addEventListener('change', markDirty);
        el._dirtyHandlersAttached = true;
      });
    }
    function removeFormWatchers(){
      const formEl = document.getElementById('leadForm');
      if (!formEl) return;
      formEl.querySelectorAll('input,select,textarea').forEach(el => {
        if (el._dirtyHandlersAttached){
          const clone = el.cloneNode(true);
          el.parentNode.replaceChild(clone, el);
        }
      });
    }

    async function onSaveClick(e){
      e.preventDefault();
      const formEl = document.getElementById('leadForm');
      if (!formEl.checkValidity()){ formEl.reportValidity(); return; }

      // Sync contacts to hidden fields before FormData
      syncContactsToHiddenFields();

      const form = new FormData(formEl);
      const lead = Object.fromEntries(form.entries());

      // Add contacts array (filter out empty rows)
      var validContacts = leadContacts.filter(function(c) { return (c.name && c.name.trim()) || (c.email && c.email.trim()); });
      lead.contacts = validContacts;

      const saveBtn = document.getElementById('saveBtn');
      const originalText = saveBtn.textContent;
      saveBtn.disabled = true; saveBtn.textContent = 'Saving...';

      try{
        const isUpdate = !!currentEditId;
        const action = isUpdate ? 'updateLead' : 'addLead';
        const url = WEB_APP_URL + '?action=' + encodeURIComponent(action)
          + (isUpdate ? ('&leadId=' + encodeURIComponent(String(currentEditId))) : '');

        const payload = isUpdate
          ? { action:'updateLead', leadId:String(currentEditId), updates:lead }
          : { action:'addLead',   lead:lead };

        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
          body: JSON.stringify(payload)
        });

        if (!res.ok) throw new Error(`Network ${res.status}`);
        const out = await res.json();
        if (out.status !== 'success') throw new Error(out.message || 'Save failed');

        showToast(isUpdate ? 'Lead updated' : 'Lead added', 'success');
        
        // Direct sync contacts to FollowUpActions (don't rely on backend sync)
        if (validContacts && isUpdate) {
          var companyName = lead.companyName || '';
          fetch(WEB_APP_URL, {
            method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'},
            body: JSON.stringify({action:'syncContactsToFU', leadId:String(currentEditId), company:companyName, contacts:validContacts})
          }).catch(function(e){ console.log('FU sync error:', e); });
        }
        
        // For NEW leads: show "Alert this rep?" popup
        var savedLeadId = isUpdate ? String(currentEditId) : (out.leadId || '');
        var savedRepName = lead.repName || '';
        var savedRepEmail = lead.repEmail || '';
        var savedCompany = lead.companyName || '';
        var savedPhone = lead.phoneNumber || '';
        var savedContact = (validContacts && validContacts.length > 0) ? (validContacts[0].name || '') : '';
        var savedNotes = lead.notes || '';
        
        formDirty = false;
        closeModal();
        
        // INSTANT UI: Build optimistic lead object and inject immediately
        var optimisticLead = {
          id: savedLeadId || ('temp-' + Date.now()),
          leadId: savedLeadId || '',
          dateAdded: isUpdate ? (lead.dateAdded || new Date().toISOString()) : new Date().toISOString(),
          companyName: lead.companyName || '',
          contactName: (validContacts && validContacts.length > 0) ? (validContacts[0].name || '') : '',
          emailAddress: (validContacts && validContacts.length > 0) ? (validContacts[0].email || '') : '',
          contacts: validContacts || [],
          phoneNumber: lead.phoneNumber || '',
          repName: lead.repName || '',
          repPhone: lead.repPhone || '',
          repEmail: lead.repEmail || '',
          status: lead.status || 'Active',
          notes: lead.notes || '',
          businessUnit: lead.businessUnit || '',
          customerAddress: lead.customerAddress || '',
          customerState: lead.customerState || '',
          customerZip: lead.customerZip || '',
          followUp: '',
          appointmentMade: 'No',
          appointmentDate: ''
        };

        if (isUpdate) {
          // Replace existing lead in allLeads
          var idx = allLeads.findIndex(function(l) { return safeLeadId(l) === String(currentEditId); });
          if (idx !== -1) {
            // Preserve server fields not in form
            optimisticLead.dateAdded = allLeads[idx].dateAdded || optimisticLead.dateAdded;
            optimisticLead.id = allLeads[idx].id;
            optimisticLead.leadId = allLeads[idx].leadId;
            allLeads[idx] = optimisticLead;
          }
        } else {
          // Insert new lead at top
          allLeads.unshift(optimisticLead);
        }
        // Re-render table instantly
        try { sessionStorage.setItem('cachedLeads', JSON.stringify(allLeads)); } catch(e) {}
        updateRepFilter();
        filterLeads();
        
        // Show alert popup IMMEDIATELY for new leads
        if (!isUpdate && savedRepEmail) {
          showAlertRepPopup(savedLeadId, savedRepName, savedRepEmail, savedCompany, savedPhone, savedContact, savedNotes);
        }
        
        // Background sync from server (no await ? non-blocking)
        loadLeads().catch(function(e){ console.log('Background refresh:', e); });
      }catch(err){
        console.error('save error:', err);
        showToast('Error saving lead: ' + err.message, 'error');
      }finally{
        saveBtn.disabled = false; saveBtn.textContent = originalText;
      }
    }

    async function archiveLead(btnEl, leadId){
      const id = String(leadId || '').trim();
      if (!id){ showToast('Could not determine lead ID ? refresh and try again.', 'error'); return; }
      if (!confirm('Archive this lead?')) return;

      const prevHtml = btnEl.innerHTML;
      btnEl.disabled = true; btnEl.innerHTML = 'Archiving?';

      try{
        const url = WEB_APP_URL + '?action=archiveLead&leadId=' + encodeURIComponent(id);
        const payload = { action:'archiveLead', leadId:id };

        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
          body: JSON.stringify(payload)
        });

        if (!res.ok) throw new Error(`Network ${res.status}`);
        const out = await res.json();
        if (out.status !== 'success') throw new Error(out.message || 'Archive failed');

        showToast('Lead archived', 'success');
        // INSTANT UI: Remove from allLeads and re-render
        allLeads = allLeads.filter(function(l) { return safeLeadId(l) !== id; });
        try { sessionStorage.setItem('cachedLeads', JSON.stringify(allLeads)); } catch(e) {}
        updateRepFilter();
        filterLeads();
        // Background sync
        loadLeads().catch(function(e){ console.log('Background refresh:', e); });
      }catch(err){
        console.error(err);
        showToast('Error archiving lead: ' + err.message, 'error');
      }finally{
        btnEl.disabled = false; btnEl.innerHTML = prevHtml;
      }
    }

    // ============ DELETE LEAD FUNCTIONS ============

    function openDeleteModal(leadId) {
      const lead = allLeads.find(l => safeLeadId(l) === String(leadId));
      if (!lead) {
        showToast('Lead not found. Please refresh the page and try again.', 'error');
        return;
      }

      currentLeadToDelete = lead;
      document.getElementById('deleteCompanyName').textContent = lead.companyName;
      document.getElementById('deleteConfirmInput').value = '';
      document.getElementById('confirmDeleteBtn').disabled = true;
      document.getElementById('deleteModal').style.display = 'block';
    }

    function closeDeleteModal() {
      document.getElementById('deleteModal').style.display = 'none';
      currentLeadToDelete = null;
    }

    function validateDeleteConfirmation() {
      const input = document.getElementById('deleteConfirmInput').value.toLowerCase().trim();
      const confirmBtn = document.getElementById('confirmDeleteBtn');
      
      if (input === 'yes') {
        confirmBtn.disabled = false;
      } else {
        confirmBtn.disabled = true;
      }
    }

    async function confirmDeleteLead() {
      if (!currentLeadToDelete) {
        showToast('No lead selected for deletion.', 'error');
        return;
      }

      const leadId = safeLeadId(currentLeadToDelete);
      const confirmBtn = document.getElementById('confirmDeleteBtn');
      const originalText = confirmBtn.textContent;
      
      confirmBtn.disabled = true;
      confirmBtn.textContent = 'Deleting...';

      try {
        const url = WEB_APP_URL + '?action=deleteLead&leadId=' + encodeURIComponent(leadId);
        const payload = { action: 'deleteLead', leadId: leadId };

        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
          body: JSON.stringify(payload)
        });

        if (!res.ok) throw new Error(`Network ${res.status}`);
        const out = await res.json();
        if (out.status !== 'success') throw new Error(out.message || 'Delete failed');

        showToast('Lead "' + currentLeadToDelete.companyName + '" deleted permanently', 'success');
        closeDeleteModal();
        // INSTANT UI: Remove from allLeads and re-render
        allLeads = allLeads.filter(function(l) { return safeLeadId(l) !== leadId; });
        try { sessionStorage.setItem('cachedLeads', JSON.stringify(allLeads)); } catch(e) {}
        updateRepFilter();
        filterLeads();
        // Background sync
        loadLeads().catch(function(e){ console.log('Background refresh:', e); });
        
      } catch (err) {
        console.error('Delete error:', err);
        showToast('Error deleting lead: ' + err.message, 'error');
      } finally {
        confirmBtn.disabled = false;
        confirmBtn.textContent = originalText;
      }
    }

    // ============ PROPOSAL GENERATION FUNCTIONS ============

    // Generate Proposal - Navigate to Proposal Generator with Lead Data
    function generateProposal(leadId) {
      var lead = allLeads.find(function(l) { return safeLeadId(l) === String(leadId); });
      if (!lead) {
        showToast('Lead not found. Please refresh the page and try again.', 'error');
        return;
      }
      
      // Validate required fields
      if (!lead.repPhone || !lead.repEmail) {
        showToast('Missing sales rep contact information. Please edit the lead and add rep phone and email.', 'error');
        return;
      }
      
      // Build URL parameters from lead data
      var params = new URLSearchParams();
      
      if (lead.companyName) params.append('companyName', lead.companyName);
      if (lead.contactName) params.append('contactName', lead.contactName);
      if (lead.customerAddress) params.append('customerAddress', lead.customerAddress);
      if (lead.customerZip) params.append('customerZip', lead.customerZip);
      if (lead.repName) params.append('preparedBy', lead.repName);
      if (lead.repPhone) params.append('preparedByPhone', lead.repPhone);
      if (lead.repEmail) params.append('preparedByEmail', lead.repEmail);
      
      // Determine which proposal generator to open based on business unit
      var targetPage = '';
      if (lead.businessUnit === 'Quantum Solutions') {
        // Validate Quantum-specific required fields
        if (!lead.customerAddress || !lead.customerZip) {
          showToast('Missing customer address information required for Quantum Solutions. Please edit the lead first.', 'error');
          return;
        }
        targetPage = 'quantum.html';
      } else if (lead.businessUnit === 'Abbondanza Vending') {
        targetPage = 'index.html';
      } else {
        showToast('Invalid business unit: ' + lead.businessUnit, 'error');
        return;
      }
      
      // Navigate to the proposal generator page with pre-filled data
      window.location.href = targetPage + '?' + params.toString();
    }

  

 
    function getCurrentLead() {
      return currentLeadForProposal;
    }

  

    // ============ EXCEL IMPORT/EXPORT FUNCTIONS ============

    // Excel Template Download
 function downloadLeadTemplate() {
      // Headers - WITH LEAD ID
      const headers = [
        'Lead ID', 'Business Unit', 'Company Name', 'Contact Name', 'Phone Number', 'Email Address',
        'Rep Name', 'Rep Phone', 'Rep Email', 'Customer Address', 'Customer State', 'Customer Zip',
        'Status', 'Follow Up Date', 'Appointment Made', 'Appointment Date', 'Notes'
      ];
      
      // Sample data row - with clear instruction for Lead ID
      const sampleData = [
        'LEAVE BLANK', // Clear instruction for Lead ID
        'Abbondanza Vending',
        'Sample Company LLC',
        'John Smith',
        '555-123-4567',
        'john.smith@example.com',
        'Julie Garley',
        '806-316-5195',
        'julie.g@abbondanzavending.com',
        '123 Main Street',
        'NH',
        '03101',
        'Active',
        '2025-12-31',
        'No',
        '',
        'Sample notes here'
      ];
      
      const templateData = [headers, sampleData];
      
      // Create workbook and worksheet
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(templateData);
      
      // Set column widths
      const colWidths = [
        {wch: 25}, // Lead ID
        {wch: 18}, // Business Unit
        {wch: 25}, // Company Name
        {wch: 18}, // Contact Name
        {wch: 15}, // Phone Number
        {wch: 25}, // Email Address
        {wch: 18}, // Rep Name
        {wch: 15}, // Rep Phone
        {wch: 25}, // Rep Email
        {wch: 25}, // Customer Address
        {wch: 12}, // Customer State
        {wch: 12}, // Customer Zip
        {wch: 12}, // Status
        {wch: 15}, // Follow Up Date
        {wch: 15}, // Appointment Made
        {wch: 15}, // Appointment Date
        {wch: 30}  // Notes
      ];
      ws['!cols'] = colWidths;

      // Create Instructions sheet with prominent Lead ID warning
      const instructionsData = [
        ['LEAD IMPORT TEMPLATE - INSTRUCTIONS'],
        [''],
        ['IMPORTANT: LEAD ID COLUMN'],
        [''],
        ['FOR NEW LEADS:'],
        ['- DELETE the "LEAVE BLANK" text and leave the Lead ID cell EMPTY'],
        ['- The system will automatically generate a unique Lead ID when you import'],
        ['- DO NOT type anything in the Lead ID column for new leads'],
        [''],
        ['FOR UPDATING EXISTING LEADS:'],
        ['- Only use exports from the system (they have Lead IDs filled in)'],
        ['- Do NOT manually type Lead IDs'],
        [''],
        ['==============================================================='],
        [''],
        ['REQUIRED FIELDS (must have values):'],
        ['- Business Unit'],
        ['- Company Name'],
        ['- Rep Name'],
        ['- Rep Phone'],
        ['- Rep Email'],
        [''],
        ['VALID VALUES - Business Unit:'],
        ['- Abbondanza Vending'],
        ['- Quantum Solutions'],
        [''],
        ['VALID VALUES - Customer State (use 2-letter abbreviations):'],
        ['AL, AK, AZ, AR, CA, CO, CT, DE, FL, GA, HI, ID, IL, IN, IA, KS, KY, LA, ME, MD,'],
        ['MA, MI, MN, MS, MO, MT, NE, NV, NH, NJ, NM, NY, NC, ND, OH, OK, OR, PA, RI, SC,'],
        ['SD, TN, TX, UT, VT, VA, WA, WV, WI, WY'],
        [''],
        ['VALID VALUES - Status:'],
        ['- Active'],
        ['- Signed Up'],
        ['- Dead'],
        [''],
        ['VALID VALUES - Appointment Made:'],
        ['- Yes'],
        ['- No'],
        [''],
        ['FORMAT REQUIREMENTS:'],
        ['- Customer Zip: 5 digits (will auto-add leading zeros if needed)'],
        ['- Rep Email: must be valid email format (name@domain.com)'],
        ['- Email Address: must be valid email format (name@domain.com)'],
        ['- Follow Up Date: format as MM/DD/YYYY or YYYY-MM-DD'],
        ['- Appointment Date: format as MM/DD/YYYY or YYYY-MM-DD'],
        [''],
        ['NOTE: After filling out the Lead Template sheet, import the file using'],
        ['the "Import Excel File" button. Any validation errors will be shown'],
        ['and you can fix them before completing the import.']
      ];
      
      const wsInstructions = XLSX.utils.aoa_to_sheet(instructionsData);
      wsInstructions['!cols'] = [{wch: 80}];

      // Add sheets to workbook
      XLSX.utils.book_append_sheet(wb, ws, 'Lead Template');
      XLSX.utils.book_append_sheet(wb, wsInstructions, 'Instructions');
      
      // Generate filename with current date
      const date = new Date().toISOString().split('T')[0];
      const filename = 'Lead_Import_Template_' + date + '.xlsx';
      
      // Download the file
      XLSX.writeFile(wb, filename);
      
      showToast('Template downloaded successfully', 'success');
    }






    
    // Import Modal Management
    function openImportModal() {
      document.getElementById('importModal').style.display = 'block';
      // Reset the modal state
      document.getElementById('excelFileInput').value = '';
      document.getElementById('filePreview').style.display = 'none';
      document.getElementById('importBtn').disabled = true;
    }

    function closeImportModal() {
      document.getElementById('importModal').style.display = 'none';
      // Clear any stored file data
      window.importFileData = null;
    }

    // File Selection and Preview
    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) {
        document.getElementById('filePreview').style.display = 'none';
        document.getElementById('importBtn').disabled = true;
        return;
      }

      // Check file type
      const allowedTypes = [
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', // .xlsx
        'application/vnd.ms-excel' // .xls
      ];
      
      if (!allowedTypes.includes(file.type)) {
        showToast('Please select a valid Excel file (.xlsx or .xls)', 'error');
        event.target.value = '';
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
          
          // Store the data for import
          window.importFileData = jsonData;
          
          // Show preview
          showFilePreview(jsonData);
          
        } catch (error) {
          console.error('Error reading Excel file:', error);
          showToast('Error reading Excel file. Please make sure it\'s a valid Excel file.', 'error');
          event.target.value = '';
        }
      };
      
      reader.readAsArrayBuffer(file);
    }

    function showFilePreview(data) {
      if (!data || data.length < 2) {
        showToast('Excel file appears to be empty or invalid.', 'error');
        return;
      }

      const headers = data[0];
      const rows = data.slice(1).filter(row => row.some(cell => cell && String(cell).trim() !== ''));
      
      // Create preview HTML
      let previewHTML = '<table style="width:100%;border-collapse:collapse;font-size:12px;">';
      
      // Headers
      previewHTML += '<tr style="background:#263238;color:white;">';
      headers.forEach(header => {
        previewHTML += `<th style="border:1px solid #ccc;padding:8px;text-align:left;">${header || ''}</th>`;
      });
      previewHTML += '</tr>';
      
      // Show first 5 rows as preview
      const previewRows = rows.slice(0, 5);
      previewRows.forEach(row => {
        previewHTML += '<tr>';
        headers.forEach((_, index) => {
          const cellValue = row[index] || '';
          previewHTML += `<td style="border:1px solid #ccc;padding:8px;">${String(cellValue).substring(0, 30)}${String(cellValue).length > 30 ? '...' : ''}</td>`;
        });
        previewHTML += '</tr>';
      });
      
      previewHTML += '</table>';
      
      document.getElementById('previewContent').innerHTML = previewHTML;
      document.getElementById('previewSummary').textContent = 
        `Found ${rows.length} lead${rows.length !== 1 ? 's' : ''} to import` + 
        (rows.length > 5 ? ` (showing first 5 rows)` : '');
      
      document.getElementById('filePreview').style.display = 'block';
      document.getElementById('importBtn').disabled = false;
    }

   async function importLeads() {
      if (!window.importFileData) {
        showToast('No file data found. Please select a file first.', 'error');
        return;
      }

      const importBtn = document.getElementById('importBtn');
      const originalText = importBtn.textContent;
      importBtn.disabled = true;
      importBtn.textContent = 'Validating...';

      try {
        const data = window.importFileData;
        const headers = data[0];
        const rows = data.slice(1).filter(row => row.some(cell => cell && String(cell).trim() !== ''));

        // Map headers to expected field names - WITH LEAD ID
        const fieldMapping = {
          'Lead ID': 'leadId',
          'Business Unit': 'businessUnit',
          'Company Name': 'companyName',
          'Contact Name': 'contactName',
          'Phone Number': 'phoneNumber',
          'Email Address': 'emailAddress',
          'Rep Name': 'repName',
          'Rep Phone': 'repPhone',
          'Rep Email': 'repEmail',
          'Customer Address': 'customerAddress',
          'Customer State': 'customerState',
          'Customer Zip': 'customerZip',
          'Status': 'status',
          'Follow Up Date': 'followUp',
          'Appointment Made': 'appointmentMade',
          'Appointment Date': 'appointmentDate',
          'Notes': 'notes'
        };

        // Valid values for validation
        const VALID_BUSINESS_UNITS = ['Abbondanza Vending', 'Quantum Solutions'];
        const VALID_STATUSES = ['Active', 'Signed Up', 'Dead'];
        const VALID_APPOINTMENT = ['Yes', 'No'];
        const VALID_STATES = [
          'AL', 'AK', 'AZ', 'AR', 'CA', 'CO', 'CT', 'DE', 'FL', 'GA',
          'HI', 'ID', 'IL', 'IN', 'IA', 'KS', 'KY', 'LA', 'ME', 'MD',
          'MA', 'MI', 'MN', 'MS', 'MO', 'MT', 'NE', 'NV', 'NH', 'NJ',
          'NM', 'NY', 'NC', 'ND', 'OH', 'OK', 'OR', 'PA', 'RI', 'SC',
          'SD', 'TN', 'TX', 'UT', 'VT', 'VA', 'WA', 'WV', 'WI', 'WY'
        ];

        importValidLeads = [];
        importErrorLeads = [];

        rows.forEach((row, index) => {
          const lead = {};
          let rowErrors = [];
          const requiredFields = ['businessUnit', 'companyName', 'repName', 'repPhone', 'repEmail'];

          // Map each cell to the corresponding field
          headers.forEach((header, cellIndex) => {
            const fieldName = fieldMapping[header];
            if (fieldName && row[cellIndex] !== undefined && row[cellIndex] !== null) {
              const cellValue = String(row[cellIndex]).trim();
              if (cellValue.toLowerCase() === 'none' || cellValue === '') {
                return;
              }
              lead[fieldName] = cellValue;
            }
          });

          // GUARDRAIL 1: Remove "LEAVE BLANK" text from Lead ID
          if (lead.leadId) {
            const leadIdValue = lead.leadId.trim().toUpperCase();
            if (leadIdValue === 'LEAVE BLANK' || leadIdValue === 'LEAVEBLANK') {
              delete lead.leadId; // Remove it so it's treated as blank
            }
          }

          // Check if this is an update (has Lead ID) or new lead (no Lead ID)
          if (lead.leadId) {
            // HAS LEAD ID - Check if it exists in database
            const existingLead = allLeads.find(dbLead => dbLead.leadId === lead.leadId);
            if (existingLead) {
              lead._isUpdate = true;
              lead._existingLeadId = existingLead.id; // Store the numeric ID for updating
            } else {
              // Lead ID provided but doesn't exist in database
              rowErrors.push('Lead ID "' + lead.leadId + '" not found in database');
            }
          } else {
            // GUARDRAIL 2: NO LEAD ID - Check if this company already exists (possible accidental deletion)
            const existingLead = allLeads.find(dbLead => 
              dbLead.companyName && lead.companyName &&
              dbLead.companyName.toLowerCase().trim() === lead.companyName.toLowerCase().trim() &&
              ((dbLead.contactName && lead.contactName && 
                dbLead.contactName.toLowerCase().trim() === lead.contactName.toLowerCase().trim()) ||
               (!dbLead.contactName && !lead.contactName))
            );
            
            if (existingLead) {
              // DUPLICATE DETECTED - Lead ID missing but company exists
              lead._isDuplicate = true;
              lead._existingLead = existingLead;
              lead._duplicateAction = 'skip';
              lead._isUpdate = false;
              rowErrors.push('POSSIBLE DUPLICATE: Lead ID missing but company "' + lead.companyName + '" exists in database (Added: ' + formatDate(existingLead.dateAdded) + ')');
            } else {
              // Truly new lead
              lead._isUpdate = false;
            }
          }

          // Set defaults
          if (!lead.status) lead.status = 'Active';
          if (!lead.appointmentMade) lead.appointmentMade = 'No';

          // Validate required fields
          requiredFields.forEach(field => {
            if (!lead[field]) {
              rowErrors.push('Missing required field: ' + field);
            }
          });

          // VALIDATE BUSINESS UNIT
          if (lead.businessUnit) {
            const normalizedUnit = lead.businessUnit.trim();
            if (VALID_BUSINESS_UNITS.indexOf(normalizedUnit) === -1) {
              rowErrors.push('Invalid Business Unit "' + normalizedUnit + '"');
            } else {
              if (normalizedUnit.toLowerCase() === 'abbondanza vending') {
                lead.businessUnit = 'Abbondanza Vending';
              } else if (normalizedUnit.toLowerCase() === 'quantum solutions') {
                lead.businessUnit = 'Quantum Solutions';
              }
            }
          }

          // VALIDATE STATUS
          if (lead.status) {
            const normalizedStatus = lead.status.trim();
            if (VALID_STATUSES.indexOf(normalizedStatus) === -1) {
              rowErrors.push('Invalid Status "' + normalizedStatus + '"');
            }
          }

          // VALIDATE APPOINTMENT MADE
          if (lead.appointmentMade) {
            const normalizedAppt = lead.appointmentMade.trim();
            if (VALID_APPOINTMENT.indexOf(normalizedAppt) === -1) {
              rowErrors.push('Invalid Appointment Made "' + normalizedAppt + '"');
            }
          }

          // VALIDATE STATE
          if (lead.customerState) {
            const normalizedState = lead.customerState.trim().toUpperCase();
            if (normalizedState.length !== 2) {
              rowErrors.push('Invalid State format "' + lead.customerState + '"');
            } else if (VALID_STATES.indexOf(normalizedState) === -1) {
              rowErrors.push('Invalid State "' + normalizedState + '"');
            } else {
              lead.customerState = normalizedState;
            }
          }

          // VALIDATE ZIP CODE
          if (lead.customerZip) {
            const zipValue = String(lead.customerZip).replace(/\D/g, '');
            if (zipValue.length > 0 && zipValue.length <= 5) {
              lead.customerZip = zipValue.padStart(5, '0');
            } else if (zipValue.length > 5) {
              rowErrors.push('Invalid Zip Code "' + lead.customerZip + '"');
            }
          }

          // VALIDATE REP EMAIL
          if (lead.repEmail) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(lead.repEmail.trim())) {
              rowErrors.push('Invalid Rep Email "' + lead.repEmail + '"');
            }
          }

          // VALIDATE EMAIL ADDRESS
          if (lead.emailAddress) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(lead.emailAddress.trim())) {
              rowErrors.push('Invalid Email Address "' + lead.emailAddress + '"');
            }
          }

          // VALIDATE PHONE FORMATS
          if (lead.repPhone) {
            const phoneDigits = lead.repPhone.replace(/\D/g, '');
            if (phoneDigits.length < 10) {
              rowErrors.push('Invalid Rep Phone "' + lead.repPhone + '"');
            }
          }

          if (lead.phoneNumber) {
            const phoneDigits = lead.phoneNumber.replace(/\D/g, '');
            if (phoneDigits.length > 0 && phoneDigits.length < 10) {
              rowErrors.push('Invalid Phone Number "' + lead.phoneNumber + '"');
            }
          }

          // Store lead with row info
          lead._rowNumber = index + 2;
          lead._originalData = JSON.parse(JSON.stringify(lead));

          if (rowErrors.length > 0) {
            lead._errors = rowErrors;
            importErrorLeads.push(lead);
          } else {
            importValidLeads.push(lead);
          }
        });

        // If NO errors, import all immediately
        if (importErrorLeads.length === 0) {
          await performImport(importValidLeads);
          closeImportModal();
          return;
        }

        // If errors found, show fix modal
        showFixErrorsModal();

      } catch (error) {
        console.error('Import error:', error);
        showToast('Error during import: ' + error.message, 'error');
      } finally {
        importBtn.disabled = false;
        importBtn.textContent = originalText;
      }
    }



function showFixErrorsModal() {
      // Update summary
      document.getElementById('errorSummary').textContent = 
        'Found ' + importValidLeads.length + ' valid rows and ' + importErrorLeads.length + ' rows with errors';
      document.getElementById('validCount').textContent = importValidLeads.length;

      // Build error rows HTML
      const container = document.getElementById('errorRowsContainer');
      container.innerHTML = '';

      importErrorLeads.forEach((lead, index) => {
        const errorRowDiv = document.createElement('div');
        errorRowDiv.className = 'error-row';
        errorRowDiv.id = 'error-row-' + index;
        
        const errorsListHTML = '<ul>' + lead._errors.map(e => '<li>' + e + '</li>').join('') + '</ul>';
        
        errorRowDiv.innerHTML = `
        <div class="error-row-header">
          <div class="error-row-title">Row ${lead._rowNumber}: ${lead.companyName || 'Unknown Company'}</div>
          <span class="error-badge" id="badge-${index}">${lead._errors.length} Error${lead._errors.length !== 1 ? 's' : ''}</span>
        </div>
        ${lead._isDuplicate ? `
          <div style="background:#fef3c7;padding:12px;border-radius:6px;margin-bottom:15px;border-left:4px solid #f59e0b;">
            <strong style="color:#92400e;">${SVG_ICONS.warning} POSSIBLE DUPLICATE - LEAD ID MISSING</strong>
            <p style="color:#78350f;font-size:14px;margin:8px 0 12px 0;">
              Lead ID is missing, but this company matches: <strong>${lead._existingLead.companyName}</strong> (Added: ${formatDate(lead._existingLead.dateAdded)})<br>
              <em>Did you accidentally delete the Lead ID from an export file?</em>
            </p>
            <div style="display:flex;gap:10px;flex-wrap:wrap;">
              <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                <input type="radio" name="duplicate-${index}" value="skip" checked onchange="setDuplicateAction(${index}, 'skip')">
                <span style="color:#78350f;font-size:14px;">Skip (Keep Existing)</span>
              </label>
              <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                <input type="radio" name="duplicate-${index}" value="update" onchange="setDuplicateAction(${index}, 'update')">
                <span style="color:#78350f;font-size:14px;">Update Existing Lead</span>
              </label>
              <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                <input type="radio" name="duplicate-${index}" value="new" onchange="setDuplicateAction(${index}, 'new')">
                <span style="color:#78350f;font-size:14px;">Add as New (Create Duplicate)</span>
              </label>
            </div>
          </div>
        ` : ''}
        <div class="error-list" id="error-list-${index}" ${lead._isDuplicate && lead._duplicateAction === 'skip' ? 'style="display:none;"' : ''}>
          ${errorsListHTML}
        </div>
          <div class="error-row-fields">
            <div class="error-field-group">
              <label>Business Unit *</label>
              <select id="bu-${index}" onchange="validateErrorRow(${index})">
                <option value="">Select...</option>
                <option value="Abbondanza Vending" ${lead.businessUnit === 'Abbondanza Vending' ? 'selected' : ''}>Abbondanza Vending</option>
                <option value="Quantum Solutions" ${lead.businessUnit === 'Quantum Solutions' ? 'selected' : ''}>Quantum Solutions</option>
              </select>
            </div>
            <div class="error-field-group">
              <label>Company Name *</label>
              <input type="text" id="company-${index}" value="${lead.companyName || ''}" onchange="validateErrorRow(${index})" />
            </div>
            <div class="error-field-group">
              <label>Contact Name</label>
              <input type="text" id="contact-${index}" value="${lead.contactName || ''}" onchange="validateErrorRow(${index})" />
            </div>
            <div class="error-field-group">
              <label>Phone Number</label>
              <input type="tel" id="phone-${index}" value="${lead.phoneNumber || ''}" onchange="validateErrorRow(${index})" />
            </div>
            <div class="error-field-group">
              <label>Email Address</label>
              <input type="email" id="email-${index}" value="${lead.emailAddress || ''}" onchange="validateErrorRow(${index})" />
            </div>
            <div class="error-field-group">
              <label>Rep Name *</label>
              <input type="text" id="repName-${index}" value="${lead.repName || ''}" onchange="validateErrorRow(${index})" />
            </div>
            <div class="error-field-group">
              <label>Rep Phone *</label>
              <input type="tel" id="repPhone-${index}" value="${lead.repPhone || ''}" onchange="validateErrorRow(${index})" />
            </div>
            <div class="error-field-group">
              <label>Rep Email *</label>
              <input type="email" id="repEmail-${index}" value="${lead.repEmail || ''}" onchange="validateErrorRow(${index})" />
            </div>
            <div class="error-field-group">
              <label>Customer Address</label>
              <input type="text" id="address-${index}" value="${lead.customerAddress || ''}" onchange="validateErrorRow(${index})" />
            </div>
            <div class="error-field-group">
              <label>Customer State</label>
              <select id="state-${index}" onchange="validateErrorRow(${index})">
                <option value="">Select...</option>
                <option value="AL" ${lead.customerState === 'AL' ? 'selected' : ''}>AL</option>
                <option value="AK" ${lead.customerState === 'AK' ? 'selected' : ''}>AK</option>
                <option value="AZ" ${lead.customerState === 'AZ' ? 'selected' : ''}>AZ</option>
                <option value="AR" ${lead.customerState === 'AR' ? 'selected' : ''}>AR</option>
                <option value="CA" ${lead.customerState === 'CA' ? 'selected' : ''}>CA</option>
                <option value="CO" ${lead.customerState === 'CO' ? 'selected' : ''}>CO</option>
                <option value="CT" ${lead.customerState === 'CT' ? 'selected' : ''}>CT</option>
                <option value="DE" ${lead.customerState === 'DE' ? 'selected' : ''}>DE</option>
                <option value="FL" ${lead.customerState === 'FL' ? 'selected' : ''}>FL</option>
                <option value="GA" ${lead.customerState === 'GA' ? 'selected' : ''}>GA</option>
                <option value="HI" ${lead.customerState === 'HI' ? 'selected' : ''}>HI</option>
                <option value="ID" ${lead.customerState === 'ID' ? 'selected' : ''}>ID</option>
                <option value="IL" ${lead.customerState === 'IL' ? 'selected' : ''}>IL</option>
                <option value="IN" ${lead.customerState === 'IN' ? 'selected' : ''}>IN</option>
                <option value="IA" ${lead.customerState === 'IA' ? 'selected' : ''}>IA</option>
                <option value="KS" ${lead.customerState === 'KS' ? 'selected' : ''}>KS</option>
                <option value="KY" ${lead.customerState === 'KY' ? 'selected' : ''}>KY</option>
                <option value="LA" ${lead.customerState === 'LA' ? 'selected' : ''}>LA</option>
                <option value="ME" ${lead.customerState === 'ME' ? 'selected' : ''}>ME</option>
                <option value="MD" ${lead.customerState === 'MD' ? 'selected' : ''}>MD</option>
                <option value="MA" ${lead.customerState === 'MA' ? 'selected' : ''}>MA</option>
                <option value="MI" ${lead.customerState === 'MI' ? 'selected' : ''}>MI</option>
                <option value="MN" ${lead.customerState === 'MN' ? 'selected' : ''}>MN</option>
                <option value="MS" ${lead.customerState === 'MS' ? 'selected' : ''}>MS</option>
                <option value="MO" ${lead.customerState === 'MO' ? 'selected' : ''}>MO</option>
                <option value="MT" ${lead.customerState === 'MT' ? 'selected' : ''}>MT</option>
                <option value="NE" ${lead.customerState === 'NE' ? 'selected' : ''}>NE</option>
                <option value="NV" ${lead.customerState === 'NV' ? 'selected' : ''}>NV</option>
                <option value="NH" ${lead.customerState === 'NH' ? 'selected' : ''}>NH</option>
                <option value="NJ" ${lead.customerState === 'NJ' ? 'selected' : ''}>NJ</option>
                <option value="NM" ${lead.customerState === 'NM' ? 'selected' : ''}>NM</option>
                <option value="NY" ${lead.customerState === 'NY' ? 'selected' : ''}>NY</option>
                <option value="NC" ${lead.customerState === 'NC' ? 'selected' : ''}>NC</option>
                <option value="ND" ${lead.customerState === 'ND' ? 'selected' : ''}>ND</option>
                <option value="OH" ${lead.customerState === 'OH' ? 'selected' : ''}>OH</option>
                <option value="OK" ${lead.customerState === 'OK' ? 'selected' : ''}>OK</option>
                <option value="OR" ${lead.customerState === 'OR' ? 'selected' : ''}>OR</option>
                <option value="PA" ${lead.customerState === 'PA' ? 'selected' : ''}>PA</option>
                <option value="RI" ${lead.customerState === 'RI' ? 'selected' : ''}>RI</option>
                <option value="SC" ${lead.customerState === 'SC' ? 'selected' : ''}>SC</option>
                <option value="SD" ${lead.customerState === 'SD' ? 'selected' : ''}>SD</option>
                <option value="TN" ${lead.customerState === 'TN' ? 'selected' : ''}>TN</option>
                <option value="TX" ${lead.customerState === 'TX' ? 'selected' : ''}>TX</option>
                <option value="UT" ${lead.customerState === 'UT' ? 'selected' : ''}>UT</option>
                <option value="VT" ${lead.customerState === 'VT' ? 'selected' : ''}>VT</option>
                <option value="VA" ${lead.customerState === 'VA' ? 'selected' : ''}>VA</option>
                <option value="WA" ${lead.customerState === 'WA' ? 'selected' : ''}>WA</option>
                <option value="WV" ${lead.customerState === 'WV' ? 'selected' : ''}>WV</option>
                <option value="WI" ${lead.customerState === 'WI' ? 'selected' : ''}>WI</option>
                <option value="WY" ${lead.customerState === 'WY' ? 'selected' : ''}>WY</option>
              </select>
            </div>
            <div class="error-field-group">
              <label>Customer Zip</label>
              <input type="text" id="zip-${index}" value="${lead.customerZip || ''}" maxlength="5" onchange="validateErrorRow(${index})" />
            </div>
            <div class="error-field-group">
              <label>Status</label>
              <select id="status-${index}" onchange="validateErrorRow(${index})">
                <option value="Active" ${lead.status === 'Active' ? 'selected' : ''}>Active</option>
                <option value="Signed Up" ${lead.status === 'Signed Up' ? 'selected' : ''}>Signed Up</option>
                <option value="Dead" ${lead.status === 'Dead' ? 'selected' : ''}>Dead</option>
              </select>
            </div>
            <div class="error-field-group">
              <label>Appointment Made</label>
              <select id="appt-${index}" onchange="validateErrorRow(${index})">
                <option value="Yes" ${lead.appointmentMade === 'Yes' ? 'selected' : ''}>Yes</option>
                <option value="No" ${lead.appointmentMade === 'No' ? 'selected' : ''}>No</option>
              </select>
            </div>
          </div>
        `;
        
        container.appendChild(errorRowDiv);
      });

      // Close import modal and show fix errors modal
      document.getElementById('importModal').style.display = 'none';
      document.getElementById('fixErrorsModal').style.display = 'block';
    }






function setDuplicateAction(index, action) {
      const lead = importErrorLeads[index];
      lead._duplicateAction = action;
      
      const errorList = document.getElementById('error-list-' + index);
      const badge = document.getElementById('badge-' + index);
      const errorRow = document.getElementById('error-row-' + index);
      
      if (action === 'skip') {
        // Hide error list and mark as resolved
        errorList.style.display = 'none';
        errorRow.classList.add('fixed');
        badge.classList.add('fixed');
        badge.textContent = 'Will Skip ?';
        lead._errors = []; // Clear errors since we're skipping
      } else {
        // Show error list for validation
        errorList.style.display = 'block';
        errorRow.classList.remove('fixed');
        badge.classList.remove('fixed');
        
        if (action === 'update') {
          badge.textContent = 'Will Update';
        } else if (action === 'new') {
          badge.textContent = 'Will Import';
        }
        
        // Re-validate if updating or importing as new
        validateErrorRow(index);
      }
      
      checkAllErrorsFixed();
    }


    

function cancelErrorFix() {
      showConfirm(
        'Cancel Import?',
        'No data will be imported. Are you sure?',
        function() {
          document.getElementById('fixErrorsModal').style.display = 'none';
          closeImportModal();
          importValidLeads = [];
          importErrorLeads = [];
        }
      );
    }


function showConfirm(title, message, onConfirm) {
      document.getElementById('confirmTitle').textContent = title;
      document.getElementById('confirmMessage').textContent = message;
      confirmCallback = onConfirm;
      document.getElementById('confirmModal').style.display = 'block';
    }

    function closeConfirmModal(confirmed) {
      document.getElementById('confirmModal').style.display = 'none';
      if (confirmed && confirmCallback) {
        confirmCallback();
      }
      confirmCallback = null;
    }



    

function validateErrorRow(index) {
      const lead = importErrorLeads[index];
      const errors = [];

      // Get current values from form
      const businessUnit = document.getElementById('bu-' + index).value;
      const companyName = document.getElementById('company-' + index).value.trim();
      const repName = document.getElementById('repName-' + index).value.trim();
      const repPhone = document.getElementById('repPhone-' + index).value.trim();
      const repEmail = document.getElementById('repEmail-' + index).value.trim();
      const customerState = document.getElementById('state-' + index).value;
      const customerZip = document.getElementById('zip-' + index).value.trim();
      const emailAddress = document.getElementById('email-' + index).value.trim();
      const phoneNumber = document.getElementById('phone-' + index).value.trim();

      // Validate required fields
      if (!businessUnit) errors.push('Missing Business Unit');
      if (!companyName) errors.push('Missing Company Name');
      if (!repName) errors.push('Missing Rep Name');
      if (!repPhone) errors.push('Missing Rep Phone');
      if (!repEmail) errors.push('Missing Rep Email');

      // Validate formats
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (repEmail && !emailRegex.test(repEmail)) {
        errors.push('Invalid Rep Email format');
      }
      if (emailAddress && !emailRegex.test(emailAddress)) {
        errors.push('Invalid Email Address format');
      }

      if (repPhone) {
        const phoneDigits = repPhone.replace(/\D/g, '');
        if (phoneDigits.length < 10) {
          errors.push('Rep Phone must have at least 10 digits');
        }
      }

      if (phoneNumber) {
        const phoneDigits = phoneNumber.replace(/\D/g, '');
        if (phoneDigits.length > 0 && phoneDigits.length < 10) {
          errors.push('Phone Number must have at least 10 digits');
        }
      }

      if (customerZip) {
        const zipDigits = customerZip.replace(/\D/g, '');
        if (zipDigits.length > 5) {
          errors.push('Zip Code must be 5 digits or less');
        }
      }

      // Update lead data
      lead.businessUnit = businessUnit;
      lead.companyName = companyName;
      lead.contactName = document.getElementById('contact-' + index).value.trim();
      lead.phoneNumber = phoneNumber;
      lead.emailAddress = emailAddress;
      lead.repName = repName;
      lead.repPhone = repPhone;
      lead.repEmail = repEmail;
      lead.customerAddress = document.getElementById('address-' + index).value.trim();
      lead.customerState = customerState;
      lead.customerZip = customerZip;
      lead.status = document.getElementById('status-' + index).value;
      lead.appointmentMade = document.getElementById('appt-' + index).value;
      lead._errors = errors;

      // Update UI
      const errorRow = document.getElementById('error-row-' + index);
      const badge = document.getElementById('badge-' + index);
      const errorList = document.getElementById('error-list-' + index);

      if (errors.length === 0) {
        errorRow.classList.add('fixed');
        badge.classList.add('fixed');
        badge.textContent = 'Fixed ?';
        errorList.style.display = 'none';
      } else {
        errorRow.classList.remove('fixed');
        badge.classList.remove('fixed');
        badge.textContent = errors.length + ' Error' + (errors.length !== 1 ? 's' : '');
        errorList.innerHTML = '<ul>' + errors.map(e => '<li>' + e + '</li>').join('') + '</ul>';
        errorList.style.display = 'block';
      }

      // Check if all errors are fixed
      checkAllErrorsFixed();
    }

    function checkAllErrorsFixed() {
      const allFixed = importErrorLeads.every(lead => lead._errors.length === 0);
      document.getElementById('completeImportBtn').disabled = !allFixed;
    }

function importValidRowsOnly() {
      showConfirm(
        'Import Valid Rows Only?',
        'Import ' + importValidLeads.length + ' valid rows? Rows with errors will be skipped.',
        function() {
          performImport(importValidLeads);
        }
      );
    }

    function completeImportWithFixes() {
      const allLeadsToImport = importValidLeads.concat(importErrorLeads);
      showConfirm(
        'Complete Import?',
        'Import all ' + allLeadsToImport.length + ' rows (valid + fixed)?',
        function() {
          performImport(allLeadsToImport);
        }
      );
    }

    async function performImport(leadsArray) {
      let successCount = 0;
      let failCount = 0;

      // Create a visible importing indicator
      const importingDiv = document.createElement('div');
      importingDiv.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#263238;color:white;padding:30px 50px;border-radius:12px;z-index:10000;font-size:18px;font-weight:600;box-shadow:0 10px 40px rgba(0,0,0,0.3);';
      importingDiv.innerHTML = 'Importing <span id="importProgress">0</span>/' + leadsArray.length + ' leads...';
      document.body.appendChild(importingDiv);

      for (let i = 0; i < leadsArray.length; i++) {
        try {
          const leadData = Object.assign({}, leadsArray[i]);
          const isUpdate = leadData._isUpdate;
          const existingLeadId = leadData._existingLeadId;
          const isDuplicate = leadData._isDuplicate;
          const duplicateAction = leadData._duplicateAction;
          const existingLead = leadData._existingLead;
          
          // Clean up internal flags
          delete leadData._rowNumber;
          delete leadData._errors;
          delete leadData._originalData;
          delete leadData._isUpdate;
          delete leadData._existingLeadId;
          delete leadData._isDuplicate;
          delete leadData._duplicateAction;
          delete leadData._existingLead;

          // Handle duplicates (missing Lead ID but company exists)
          if (isDuplicate) {
            if (duplicateAction === 'skip') {
              // Skip this lead, keep existing
              successCount++;
              document.getElementById('importProgress').textContent = i + 1;
              continue;
            } else if (duplicateAction === 'update') {
              // Update the existing lead
              const response = await fetch(WEB_APP_URL + '?action=updateLead&leadId=' + encodeURIComponent(safeLeadId(existingLead)), {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
                body: JSON.stringify({ action: 'updateLead', leadId: safeLeadId(existingLead), updates: leadData })
              });

              const result = await response.json();
              if (result.status === 'success') {
                successCount++;
              } else {
                failCount++;
                console.error('Failed to update lead ' + (i + 1) + ':', result.message);
              }
              
              document.getElementById('importProgress').textContent = i + 1;
              continue;
            }
            // If action is 'new', fall through to add as new lead
          }

          // Handle Lead ID-based updates (has Lead ID and exists in database)
          if (isUpdate && existingLeadId) {
            const response = await fetch(WEB_APP_URL + '?action=updateLead&leadId=' + encodeURIComponent(existingLeadId), {
              method: 'POST',
              headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
              body: JSON.stringify({ action: 'updateLead', leadId: existingLeadId, updates: leadData })
            });

            const result = await response.json();
            if (result.status === 'success') {
              successCount++;
            } else {
              failCount++;
              console.error('Failed to update lead ' + (i + 1) + ':', result.message);
            }
          } else {
            // Add as new lead (will auto-generate Lead ID)
            const response = await fetch(WEB_APP_URL + '?action=addLead', {
              method: 'POST',
              headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
              body: JSON.stringify({ action: 'addLead', lead: leadData })
            });

            const result = await response.json();
            if (result.status === 'success') {
              successCount++;
            } else {
              failCount++;
              console.error('Failed to import lead ' + (i + 1) + ':', result.message);
            }
          }
        } catch (error) {
          failCount++;
          console.error('Error importing lead ' + (i + 1) + ':', error);
        }

        // Update progress
        document.getElementById('importProgress').textContent = i + 1;
      }

      // Remove importing indicator
      document.body.removeChild(importingDiv);

      // Show success/failure message
      if (successCount > 0) {
        showToast('Successfully imported ' + successCount + ' lead' + (successCount !== 1 ? 's' : '') + (failCount > 0 ? ' (' + failCount + ' failed)' : ''), 'success');
        await loadLeads();
      } else {
        showToast('Failed to import any leads', 'error');
      }

      // Clean up
      importValidLeads = [];
      importErrorLeads = [];
      
      // IMPORTANT: Close the fix errors modal and reset import modal
      document.getElementById('fixErrorsModal').style.display = 'none';
      document.getElementById('importModal').style.display = 'none';
      document.getElementById('excelFileInput').value = '';
      document.getElementById('filePreview').style.display = 'none';
      document.getElementById('importBtn').disabled = true;
    }


    
    
    

    // Export current leads to Excel
function exportLeadsToExcel() {
      if (!allLeads || allLeads.length === 0) {
        showToast('No leads to export. Please add some leads first.', 'error');
        return;
      }

      // Headers - WITH LEAD ID
      const exportData = [
        [
          'Lead ID', 'Business Unit', 'Company Name', 'Contact Name', 'Phone Number', 'Email Address',
          'Rep Name', 'Rep Phone', 'Rep Email', 'Customer Address', 'Customer State', 'Customer Zip',
          'Status', 'Follow Up Date', 'Appointment Made', 'Appointment Date', 'Notes'
        ]
      ];

      // Data rows - WITH LEAD ID
      allLeads.forEach(lead => {
        exportData.push([
          lead.leadId || '',
          lead.businessUnit || '',
          lead.companyName || '',
          lead.contactName || '',
          lead.phoneNumber || '',
          lead.emailAddress || '',
          lead.repName || '',
          lead.repPhone || '',
          lead.repEmail || '',
          lead.customerAddress || '',
          lead.customerState || '',
          lead.customerZip || '',
          lead.status || '',
          lead.followUp || '',
          lead.appointmentMade || '',
          lead.appointmentDate || '',
          lead.notes || ''
        ]);
      });

      // Create workbook and worksheet
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(exportData);
      
      // Set column widths
      ws['!cols'] = [
        {wch: 25}, {wch: 18}, {wch: 25}, {wch: 18}, {wch: 15}, {wch: 25},
        {wch: 18}, {wch: 15}, {wch: 25}, {wch: 25}, {wch: 12}, {wch: 12},
        {wch: 12}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 30}
      ];

      // Create Instructions sheet
      const instructionsData = [
        ['LEAD EXPORT - INSTRUCTIONS FOR RE-IMPORTING'],
        [''],
        ['REQUIRED FIELDS (must have values):'],
        ['- Lead ID (DO NOT CHANGE - used to match existing leads)'],
        ['- Business Unit'],
        ['- Company Name'],
        ['- Rep Name'],
        ['- Rep Phone'],
        ['- Rep Email'],
        [''],
        ['IMPORTANT: Lead ID Column'],
        ['- The Lead ID column is used to identify existing leads'],
        ['- When you re-import this file, leads will be UPDATED (not duplicated)'],
        ['- DO NOT modify or delete the Lead ID column'],
        ['- Leave Lead ID blank ONLY if adding a brand new lead'],
        [''],
        ['VALID VALUES - Business Unit:'],
        ['- Abbondanza Vending'],
        ['- Quantum Solutions'],
        [''],
        ['VALID VALUES - Customer State (use 2-letter abbreviations):'],
        ['AL, AK, AZ, AR, CA, CO, CT, DE, FL, GA, HI, ID, IL, IN, IA, KS, KY, LA, ME, MD,'],
        ['MA, MI, MN, MS, MO, MT, NE, NV, NH, NJ, NM, NY, NC, ND, OH, OK, OR, PA, RI, SC,'],
        ['SD, TN, TX, UT, VT, VA, WA, WV, WI, WY'],
        [''],
        ['VALID VALUES - Status:'],
        ['- Active'],
        ['- Signed Up'],
        ['- Dead'],
        [''],
        ['VALID VALUES - Appointment Made:'],
        ['- Yes'],
        ['- No'],
        [''],
        ['FORMAT REQUIREMENTS:'],
        ['- Customer Zip: 5 digits (will auto-add leading zeros if needed)'],
        ['- Rep Email: must be valid email format (name@domain.com)'],
        ['- Email Address: must be valid email format (name@domain.com)'],
        ['- Follow Up Date: format as MM/DD/YYYY or YYYY-MM-DD'],
        ['- Appointment Date: format as MM/DD/YYYY or YYYY-MM-DD'],
        [''],
        ['IMPORTANT: Do NOT add or remove columns. Keep the exact same structure.'],
        [''],
        ['NOTE: After editing, import the file using the "Import Excel File" button.'],
        ['Leads with existing Lead IDs will be UPDATED. Rows without Lead ID will be added as NEW leads.']
      ];
      
      const wsInstructions = XLSX.utils.aoa_to_sheet(instructionsData);
      wsInstructions['!cols'] = [{wch: 80}];

      // Add sheets to workbook
      XLSX.utils.book_append_sheet(wb, ws, 'Leads Export');
      XLSX.utils.book_append_sheet(wb, wsInstructions, 'Instructions');
      
      const date = new Date().toISOString().split('T')[0];
      const filename = 'Leads_Export_' + date + '.xlsx';
      XLSX.writeFile(wb, filename);
      
      showToast('Exported ' + allLeads.length + ' leads to ' + filename, 'success');
    }



    
    function showToast(msg, type='success'){
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.className = 'toast ' + type;
      el.style.position = 'fixed';
      el.style.bottom = '20px';
      el.style.right  = '20px';
      el.style.background = type === 'success'
        ? 'linear-gradient(135deg,#48bb78 0%,#38a169 100%)'
        : 'linear-gradient(135deg,#e53e3e 0%,#c53030 100%)';
      el.style.color = '#fff';
      el.style.padding = '16px 24px';
      el.style.borderRadius = '8px';
      el.style.boxShadow = '0 4px 12px rgba(0,0,0,.2)';
      el.style.display = 'block';
      setTimeout(() => { el.style.display = 'none'; }, 3000);
    }

    // ============ INLINE STATUS PICKER ============

    function openStatusPicker(evt, el, leadId) {
      evt.stopPropagation();
      closeStatusPicker();

      var currentStatus = el.textContent.trim();
      var statuses = [
        { value: 'Active', label: 'Active', cls: 'active-opt' },
        { value: 'Signed Up', label: 'Signed Up', cls: 'signedup-opt' },
        { value: 'Dead', label: 'Dead', cls: 'dead-opt' }
      ];

      var dd = document.createElement('div');
      dd.className = 'status-dropdown';
      dd.id = 'statusPickerDD';

      statuses.forEach(function(s) {
        var item = document.createElement('div');
        item.className = 'status-dropdown-item ' + s.cls;
        item.textContent = s.label;
        if (s.value === currentStatus) item.style.fontWeight = '800';
        item.addEventListener('click', function(e) {
          e.stopPropagation();
          closeStatusPicker();
          if (s.value === currentStatus) return;

          if (s.value === 'Signed Up') {
            // Show archive confirmation popup
            var overlay = document.createElement('div');
            overlay.id = 'archiveConfirmOverlay';
            overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:9999';
            overlay.innerHTML = '<div style="background:#fff;border-radius:14px;max-width:400px;width:90%;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.3)">' +
              '<div style="background:linear-gradient(135deg,#059669,#10b981);color:#fff;padding:18px 24px"><h3 style="margin:0;font-size:17px">Signed Up!</h3></div>' +
              '<div style="padding:20px 24px;text-align:center">' +
                '<p style="font-size:14px;color:#1e293b;margin-bottom:16px">Archive this lead?</p>' +
                '<p style="font-size:12px;color:#64748b">This will mark the lead as <strong>Signed Up</strong> and move it to the archive.</p>' +
              '</div>' +
              '<div style="padding:14px 24px;background:#f8fafc;display:flex;justify-content:center;gap:8px;border-top:1px solid #e2e8f0">' +
                '<button onclick="document.getElementById(\'archiveConfirmOverlay\').remove()" style="padding:9px 20px;background:#e2e8f0;color:#4a5568;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:13px">Cancel</button>' +
                '<button onclick="confirmSignedUpArchive(\'' + leadId + '\')" style="padding:9px 20px;background:linear-gradient(135deg,#059669,#10b981);color:#fff;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:13px">Yes, Archive</button>' +
              '</div></div>';
            document.body.appendChild(overlay);
            return;
          }

          // Instant UI update
          el.textContent = s.value;
          el.className = 'status-badge ' + getStatusClass(s.value);
          var lead = (allLeads || []).find(function(l) { return safeLeadId(l) === String(leadId); });
          if (lead) lead.status = s.value;
          sendInlineStatusUpdate(leadId, s.value);
        });
        dd.appendChild(item);
      });

      var rect = el.getBoundingClientRect();
      dd.style.top = (rect.bottom + 4) + 'px';
      dd.style.left = (rect.left + rect.width / 2 - 75) + 'px';
      document.body.appendChild(dd);

      setTimeout(function() {
        document.addEventListener('click', closeStatusPicker, { once: true });
      }, 10);
    }

    async function confirmSignedUpArchive(leadId) {
      document.getElementById('archiveConfirmOverlay').remove();
      try {
        var res = await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
          body: JSON.stringify({ action: 'updateLead', leadId: String(leadId), updates: { status: 'Signed Up' } })
        });
        await res.json();
        // Now archive it
        var res2 = await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
          body: JSON.stringify({ action: 'archiveLead', leadId: String(leadId) })
        });
        await res2.json();
        showToast('Lead signed up and archived!', 'success');
        loadLeads();
      } catch(e) {
        showToast('Error: ' + e.message, 'error');
      }
    }
    window.confirmSignedUpArchive = confirmSignedUpArchive;

    function closeStatusPicker() {
      var existing = document.getElementById('statusPickerDD');
      if (existing) existing.remove();
    }

    async function sendInlineStatusUpdate(leadId, value) {
      try {
        var res = await fetch(WEB_APP_URL + '?action=updateLead&leadId=' + encodeURIComponent(String(leadId)), {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
          body: JSON.stringify({ action: 'updateLead', leadId: String(leadId), updates: { status: value } })
        });
        var data = await res.json();
        if (data.status !== 'success') throw new Error(data.message || 'Update failed');
      } catch (err) {
        showToast('Error updating status: ' + err.message, 'error');
      }
    }

    // ============ INLINE DATE EDITING ============

    // ============ SORTING STATE ============
    var currentSortField = 'dateAdded';
    var currentSortDir = 'desc'; // 'asc' or 'desc' ? default newest first

    function initSortableHeaders() {
      document.querySelectorAll('th.sortable').forEach(function(th) {
        th.addEventListener('click', function() {
          var field = this.getAttribute('data-sort');
          if (currentSortField === field) {
            // Cycle: asc -> desc -> none
            if (currentSortDir === 'asc') currentSortDir = 'desc';
            else if (currentSortDir === 'desc') { currentSortDir = null; currentSortField = null; }
            else currentSortDir = 'asc';
          } else {
            currentSortField = field;
            currentSortDir = 'asc';
          }
          // Update header classes
          document.querySelectorAll('th.sortable').forEach(function(h) { h.classList.remove('asc','desc'); });
          if (currentSortDir) this.classList.add(currentSortDir);
          filterLeads();
        });
        // Set initial sort indicator
        if (th.getAttribute('data-sort') === currentSortField && currentSortDir) {
          th.classList.add(currentSortDir);
        }
      });
    }

    function sortLeads(leads) {
      if (!currentSortField || !currentSortDir) return leads;
      var field = currentSortField;
      var dir = currentSortDir === 'asc' ? 1 : -1;

      return leads.slice().sort(function(a, b) {
        var av = a[field] || '';
        var bv = b[field] || '';

        // Date fields: sort by actual date, empties last
        if (field === 'dateAdded' || field === 'followUp' || field === 'appointmentDate') {
          var da = av ? new Date(av).getTime() : null;
          var db = bv ? new Date(bv).getTime() : null;
          if (da === null && db === null) return 0;
          if (da === null) return 1;  // empties always last
          if (db === null) return -1;
          return (da - db) * dir;
        }

        // Appt Made: Yes before No (or reverse)
        if (field === 'appointmentMade') {
          var ya = (String(av).toLowerCase() === 'yes') ? 1 : 0;
          var yb = (String(bv).toLowerCase() === 'yes') ? 1 : 0;
          return (ya - yb) * dir;
        }

        // String fields
        av = String(av).toLowerCase();
        bv = String(bv).toLowerCase();
        if (av < bv) return -1 * dir;
        if (av > bv) return 1 * dir;
        return 0;
      });
    }

    // ============ APPT MADE TOGGLE ============

    async function toggleApptMade(el, leadId, newVal) {
      // Instant UI update
      el.textContent = newVal;
      el.className = 'appt-toggle ' + (newVal === 'Yes' ? 'yes' : 'no');
      el.setAttribute('onclick', "toggleApptMade(this,'" + leadId + "','" + (newVal === 'Yes' ? 'No' : 'Yes') + "')");

      // Update local data immediately
      var lead = (allLeads || []).find(function(l) { return safeLeadId(l) === String(leadId); });
      if (lead) lead.appointmentMade = newVal;

      // Save in background
      try {
        var res = await fetch(WEB_APP_URL + '?action=updateLead&leadId=' + encodeURIComponent(String(leadId)), {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
          body: JSON.stringify({ action: 'updateLead', leadId: String(leadId), updates: { appointmentMade: newVal } })
        });
        var data = await res.json();
        if (data.status !== 'success') throw new Error(data.message || 'Update failed');
      } catch (err) {
        // Revert on failure
        var oldVal = (newVal === 'Yes') ? 'No' : 'Yes';
        el.textContent = oldVal;
        el.className = 'appt-toggle ' + (oldVal === 'Yes' ? 'yes' : 'no');
        el.setAttribute('onclick', "toggleApptMade(this,'" + leadId + "','" + newVal + "')");
        if (lead) lead.appointmentMade = oldVal;
        showToast('Error: ' + err.message, 'error');
      }
    }

    // ============ INLINE DATE FUNCTIONS ============

    function inlineDateEdit(el, leadId, field) {
      // Don't open if already editing
      if (el.querySelector('input')) return;

      var currentText = el.textContent.trim();
      var currentVal = '';
      
      // Parse existing date to YYYY-MM-DD for the input
      if (currentText && currentText !== '+ Add Date') {
        var parts = currentText.split('/');
        if (parts.length === 3) {
          currentVal = parts[2] + '-' + parts[0].padStart(2,'0') + '-' + parts[1].padStart(2,'0');
        }
      }

      var input = document.createElement('input');
      input.type = 'date';
      input.className = 'date-inline-input';
      input.value = currentVal;

      el.innerHTML = '';
      el.style.borderBottom = 'none';
      el.appendChild(input);
      input.focus();

      var saved = false;

      function saveDate() {
        if (saved) return;
        saved = true;

        var newVal = input.value;

        if (!newVal) {
          // Cleared the date
          el.innerHTML = '<span class="date-clickable empty" onclick="inlineDateEdit(this,\'' + leadId + '\',\'' + field + '\')">+ Add Date</span>';
          el.style.borderBottom = '';
          el.className = '';
          sendInlineDateUpdate(leadId, field, '');
          return;
        }

        // Format for display MM/DD/YYYY
        var d = new Date(newVal + 'T00:00:00');
        var display = ('0' + (d.getMonth()+1)).slice(-2) + '/' + ('0' + d.getDate()).slice(-2) + '/' + d.getFullYear();
        
        el.innerHTML = display;
        el.className = 'date-clickable';
        el.style.borderBottom = '';
        el.onclick = function(){ inlineDateEdit(el, leadId, field); };

        sendInlineDateUpdate(leadId, field, newVal);
      }

      input.addEventListener('change', saveDate);
      input.addEventListener('blur', function() {
        setTimeout(saveDate, 150);
      });
      input.addEventListener('keydown', function(ev) {
        if (ev.key === 'Escape') {
          saved = true;
          if (currentText && currentText !== '+ Add Date') {
            el.innerHTML = currentText;
            el.className = 'date-clickable';
          } else {
            el.innerHTML = '+ Add Date';
            el.className = 'date-clickable empty';
          }
          el.style.borderBottom = '';
          el.onclick = function(){ inlineDateEdit(el, leadId, field); };
        }
        if (ev.key === 'Enter') saveDate();
      });
    }

    async function sendInlineDateUpdate(leadId, field, value) {
      try {
        var updates = {};
        updates[field] = value;

        var res = await fetch(WEB_APP_URL + '?action=updateLead&leadId=' + encodeURIComponent(String(leadId)), {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
          body: JSON.stringify({ action: 'updateLead', leadId: String(leadId), updates: updates })
        });

        var data = await res.json();
        if (data.status !== 'success') throw new Error(data.message || 'Update failed');
        showToast(field === 'followUp' ? 'Follow-up date updated' : 'Appointment date updated', 'success');
      } catch (err) {
        console.error('Inline date update error:', err);
        showToast('Error updating date: ' + err.message, 'error');
      }
    }

    // ============ INLINE CONTACTS EDITING ============
    var _inlineContacts = [];
    var _inlineContactLeadId = null;

    function openInlineContacts(evt, leadId) {
      evt.stopPropagation();
      closeInlineContacts();
      var lead = (allLeads || []).find(function(l) { return safeLeadId(l) === String(leadId); });
      if (!lead) return;
      _inlineContactLeadId = leadId;

      if (lead.contacts && lead.contacts.length > 0) {
        _inlineContacts = lead.contacts.map(function(c) { return {name:c.name||'', email:c.email||'', position:c.position||''}; });
      } else if (lead.contactName || lead.emailAddress) {
        _inlineContacts = [{name:lead.contactName||'', email:lead.emailAddress||'', position:''}];
      } else {
        _inlineContacts = [{name:'', email:'', position:''}];
      }

      var pop = document.createElement('div');
      pop.className = 'contacts-popover';
      pop.id = 'contactsPopover';

      var h = '<div class="contacts-popover-hdr"><span style="font-weight:600;font-size:13px">' + (lead.companyName||'') + ' ? Contacts</span><button onclick="closeInlineContacts()" style="background:none;border:none;color:#fff;font-size:18px;cursor:pointer">&times;</button></div>';
      h += '<div class="contacts-popover-body" id="cpBody">';
      h += '<div style="display:flex;gap:4px;padding:0 0 4px;font-size:10px;color:#94a3b8;font-weight:600"><span style="flex:1">Name</span><span style="flex:1.2">Email</span><span style="flex:0.7">Position</span><span style="width:24px"></span></div>';
      h += '<div id="cpRows"></div>';
      h += '</div>';
      h += '<div class="contacts-popover-footer"><button onclick="addInlineContact()" style="padding:4px 10px;border:1px solid #10b981;border-radius:5px;background:#ecfdf5;color:#059669;font-size:11px;font-weight:600;cursor:pointer">+ Add Contact</button><div style="display:flex;gap:6px"><button onclick="closeInlineContacts()" style="padding:5px 12px;border:1px solid #cbd5e0;border-radius:5px;background:#fff;color:#4a5568;font-size:12px;font-weight:600;cursor:pointer">Cancel</button><button onclick="saveInlineContacts()" style="padding:5px 14px;border:none;border-radius:5px;background:#263238;color:#fff;font-size:12px;font-weight:600;cursor:pointer">Save</button></div></div>';

      pop.innerHTML = h;

      // Position near click
      var rect = evt.target.getBoundingClientRect();
      pop.style.top = Math.min(rect.bottom + 4, window.innerHeight - 350) + 'px';
      pop.style.left = Math.max(8, Math.min(rect.left - 100, window.innerWidth - 520)) + 'px';

      document.body.appendChild(pop);
      renderInlineContactRows();

      // Close on outside click
      setTimeout(function() {
        document.addEventListener('click', _cpOutsideClick);
      }, 50);
    }

    function _cpOutsideClick(e) {
      var pop = document.getElementById('contactsPopover');
      if (pop && !pop.contains(e.target)) closeInlineContacts();
    }

    function closeInlineContacts() {
      var pop = document.getElementById('contactsPopover');
      if (pop) pop.remove();
      document.removeEventListener('click', _cpOutsideClick);
      _inlineContactLeadId = null;
    }

    function renderInlineContactRows() {
      var el = document.getElementById('cpRows');
      if (!el) return;
      var h = '';
      for (var i = 0; i < _inlineContacts.length; i++) {
        var c = _inlineContacts[i];
        h += '<div class="cp-row">';
        h += '<input class="cp-name" type="text" value="' + String(c.name||'').replace(/"/g,'&quot;') + '" placeholder="Name" oninput="_inlineContacts[' + i + '].name=this.value"/>';
        h += '<input class="cp-email" type="email" value="' + String(c.email||'').replace(/"/g,'&quot;') + '" placeholder="email@co.com" oninput="_inlineContacts[' + i + '].email=this.value"/>';
        h += '<input class="cp-pos" type="text" value="' + String(c.position||'').replace(/"/g,'&quot;') + '" placeholder="Position" oninput="_inlineContacts[' + i + '].position=this.value"/>';
        h += '<button class="cp-del" onclick="removeInlineContact(' + i + ')" title="Remove">&times;</button>';
        h += '</div>';
      }
      el.innerHTML = h;
    }

    function addInlineContact() {
      _inlineContacts.push({name:'', email:'', position:''});
      renderInlineContactRows();
    }

    function removeInlineContact(idx) {
      _inlineContacts.splice(idx, 1);
      if (_inlineContacts.length === 0) _inlineContacts.push({name:'', email:'', position:''});
      renderInlineContactRows();
    }

    async function saveInlineContacts() {
      var leadId = _inlineContactLeadId;
      if (!leadId) return;
      var valid = _inlineContacts.filter(function(c) { return (c.name && c.name.trim()) || (c.email && c.email.trim()); });
      var primary = valid.length > 0 ? valid[0] : {name:'', email:'', position:''};

      // Update local data
      var lead = (allLeads || []).find(function(l) { return safeLeadId(l) === String(leadId); });
      if (lead) {
        lead.contacts = valid;
        lead.contactName = primary.name;
        lead.emailAddress = primary.email;
      }

      closeInlineContacts();
      filterLeads(); // re-render table

      // Save to backend
      try {
        await fetch(WEB_APP_URL, {
          method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'},
          body: JSON.stringify({action:'updateLead', leadId:leadId, updates:{
            contactName: primary.name, emailAddress: primary.email, contacts: valid
          }})
        });
        // Direct sync to FollowUpActions
        var companyName = lead ? (lead.companyName || '') : '';
        fetch(WEB_APP_URL, {
          method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'},
          body: JSON.stringify({action:'syncContactsToFU', leadId:leadId, company:companyName, contacts:valid})
        }).catch(function(){});
        try { sessionStorage.setItem('cachedLeads', JSON.stringify(allLeads)); } catch(e) {}
      } catch(e) {
        showToast('Error saving contacts', 'error');
      }
    }

    // ============ INLINE NOTES EDITING ============

    function inlineNotesEdit(el, leadId) {
      var lead = (allLeads || []).find(function(l) { return safeLeadId(l) === String(leadId); });
      var currentNotes = lead ? String(lead.notes || '') : '';
      var companyName = lead ? (lead.companyName || '') : '';
      hideNotesTooltip();

      // Parse existing notes into entries
      var entries = parseNoteEntries(currentNotes);

      // Create overlay
      var overlay = document.createElement('div');
      overlay.className = 'notes-edit-overlay';

      var card = document.createElement('div');
      card.className = 'notes-edit-card';

      // Header
      var header = document.createElement('div');
      header.className = 'notes-edit-header';
      header.innerHTML = '<div><h3>Notes</h3><div class="notes-company">' + esc(companyName) + '</div></div>';

      // Body
      var body = document.createElement('div');
      body.className = 'notes-edit-body';
      body.style.padding = '0';

      // New entry input area
      var inputArea = document.createElement('div');
      inputArea.style.cssText = 'padding:16px 24px;border-bottom:2px solid #e2e8f0;background:#f8fafc';
      inputArea.innerHTML = '<label style="display:block;font-size:12px;font-weight:700;color:#4a5568;margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px">Add New Note</label>';
      var newInput = document.createElement('textarea');
      newInput.placeholder = 'Type a new note...';
      newInput.style.cssText = 'width:100%;min-height:80px;padding:12px;border:2px solid #e2e8f0;border-radius:8px;font-size:15px;font-family:inherit;resize:vertical;box-sizing:border-box;line-height:1.5';
      inputArea.appendChild(newInput);

      var addBtnRow = document.createElement('div');
      addBtnRow.style.cssText = 'display:flex;justify-content:flex-end;margin-top:8px';
      var addBtn = document.createElement('button');
      addBtn.type = 'button';
      addBtn.textContent = '+ Add Note';
      addBtn.style.cssText = 'background:#10b981;color:#fff;border:none;padding:8px 18px;border-radius:6px;font-size:13px;font-weight:700;cursor:pointer';
      addBtnRow.appendChild(addBtn);
      inputArea.appendChild(addBtnRow);
      body.appendChild(inputArea);

      // Entries list
      var listWrap = document.createElement('div');
      listWrap.style.cssText = 'padding:16px 24px;max-height:350px;overflow-y:auto';
      var listEl = document.createElement('div');
      listEl.id = '_notesEntries';

      function renderEntries() {
        if (entries.length === 0) {
          listEl.innerHTML = '<div style="text-align:center;color:#94a3b8;padding:24px;font-size:14px;font-style:italic">No notes yet</div>';
          return;
        }
        listEl.innerHTML = '';
        for (var i = 0; i < entries.length; i++) {
          (function(idx) {
            var e = entries[idx];
            var card = document.createElement('div');
            card.style.cssText = 'padding:12px;background:' + (idx % 2 === 0 ? '#fff' : '#f8fafc') + ';border-radius:8px;margin-bottom:8px;border:1px solid #e2e8f0';

            if (e.date) {
              var dateDiv = document.createElement('div');
              dateDiv.style.cssText = 'font-size:11px;color:#64748b;margin-bottom:4px;font-weight:600';
              dateDiv.textContent = e.date;
              card.appendChild(dateDiv);
            }

            var textDiv = document.createElement('div');
            textDiv.textContent = e.text;
            textDiv.style.cssText = 'font-size:14px;color:#1e293b;line-height:1.5;white-space:pre-wrap;cursor:text;padding:4px;border-radius:4px;min-height:20px';
            textDiv.contentEditable = 'true';
            textDiv.spellcheck = true;
            textDiv.addEventListener('focus', function() {
              textDiv.style.background = '#fffbeb';
              textDiv.style.outline = '2px solid #fbbf24';
            });
            textDiv.addEventListener('blur', function() {
              textDiv.style.background = '';
              textDiv.style.outline = '';
              entries[idx].text = textDiv.textContent.trim();
            });
            card.appendChild(textDiv);

            var btnRow = document.createElement('div');
            btnRow.style.cssText = 'text-align:right;margin-top:6px';
            var delBtn = document.createElement('button');
            delBtn.type = 'button';
            delBtn.textContent = 'Remove';
            delBtn.style.cssText = 'background:none;border:none;color:#ef4444;font-size:11px;font-weight:600;cursor:pointer;padding:2px 6px';
            delBtn.addEventListener('click', function() {
              entries.splice(idx, 1);
              renderEntries();
            });
            btnRow.appendChild(delBtn);
            card.appendChild(btnRow);

            listEl.appendChild(card);
          })(i);
        }
      }
      renderEntries();
      listWrap.appendChild(listEl);
      body.appendChild(listWrap);

      // Footer
      var footer = document.createElement('div');
      footer.className = 'notes-edit-footer';

      var cancelBtn = document.createElement('button');
      cancelBtn.className = 'notes-cancel';
      cancelBtn.textContent = 'Cancel';

      var saveBtn = document.createElement('button');
      saveBtn.className = 'notes-save';
      saveBtn.textContent = 'Save Notes';

      footer.appendChild(cancelBtn);
      footer.appendChild(saveBtn);

      card.appendChild(header);
      card.appendChild(body);
      card.appendChild(footer);
      overlay.appendChild(card);
      document.body.appendChild(overlay);

      newInput.focus();

      // Add note button
      addBtn.addEventListener('click', function() {
        var text = newInput.value.trim();
        if (!text) { newInput.focus(); return; }
        var now = new Date();
        var dateStr = formatNoteDate(now);
        entries.unshift({ date: dateStr, text: text });
        newInput.value = '';
        renderEntries();
        newInput.focus();
      });

      // Enter key in new note input (Shift+Enter for newline, Enter to add)
      newInput.addEventListener('keydown', function(ev) {
        if (ev.key === 'Enter' && !ev.shiftKey) {
          ev.preventDefault();
          addBtn.click();
        }
      });

      function closeOverlay() {
        overlay.remove();
      }

      function updateCell(text) {
        if (text && text.trim()) {
          // Show the newest note text (without timestamp) in the cell
          var firstEntry = parseNoteEntries(text)[0];
          var preview = firstEntry ? firstEntry.text : text;
          el.innerHTML = preview.length > 50 ? esc(preview.substring(0, 50)) + '...' : esc(preview);
          el.className = 'notes-clickable';
        } else {
          el.innerHTML = '+ Add Note';
          el.className = 'notes-clickable empty';
        }
        el.onclick = function() { inlineNotesEdit(el, leadId); };
      }

      saveBtn.addEventListener('click', function() {
        // Flush any unsaved text in the input
        var pending = newInput.value.trim();
        if (pending) {
          entries.unshift({ date: formatNoteDate(new Date()), text: pending });
        }
        var serialized = serializeNoteEntries(entries);
        // Instant close + update
        closeOverlay();
        updateCell(serialized);
        if (lead) lead.notes = serialized;
        // Update cached allLeads + sessionStorage
        try { sessionStorage.setItem('cachedLeads', JSON.stringify(allLeads)); } catch(e) {}
        // Background sync
        sendInlineNotesUpdate(leadId, serialized);
      });

      cancelBtn.addEventListener('click', closeOverlay);

      // Notes modal only closes via Save or Cancel buttons
    }

    function formatNoteDate(d) {
      var m = d.getMonth() + 1;
      var day = d.getDate();
      var yr = d.getFullYear();
      var hr = d.getHours();
      var min = d.getMinutes();
      var ampm = hr >= 12 ? 'PM' : 'AM';
      hr = hr % 12 || 12;
      return String(m).padStart(2,'0') + '/' + String(day).padStart(2,'0') + '/' + yr + ' ' + hr + ':' + String(min).padStart(2,'0') + ' ' + ampm;
    }

    function parseNoteEntries(raw) {
      if (raw === null || raw === undefined) return [];
      raw = String(raw);
      if (!raw.trim()) return [];
      var lines = raw.split('\n---\n');
      var entries = [];
      for (var i = 0; i < lines.length; i++) {
        var line = lines[i].trim();
        if (!line) continue;
        // Check for [MM/DD/YYYY H:MM AM/PM] prefix
        var match = line.match(/^\[([^\]]+)\]\s*([\s\S]*)$/);
        if (match) {
          entries.push({ date: match[1], text: match[2].trim() });
        } else {
          // Legacy plain text note (no timestamp)
          entries.push({ date: '', text: line });
        }
      }
      return entries;
    }

    function serializeNoteEntries(entries) {
      var parts = [];
      for (var i = 0; i < entries.length; i++) {
        var e = entries[i];
        if (e.date) {
          parts.push('[' + e.date + '] ' + e.text);
        } else {
          parts.push(e.text);
        }
      }
      return parts.join('\n---\n');
    }

    function notesPreview(raw) {
      if (raw === null || raw === undefined) return '';
      raw = String(raw);
      var entries = parseNoteEntries(raw);
      if (!entries.length) return esc(raw.length > 50 ? raw.substring(0,50) + '...' : raw);
      var text = entries[0].text || '';
      return esc(text.length > 50 ? text.substring(0,50) + '...' : text);
    }

    async function sendInlineNotesUpdate(leadId, value) {
      try {
        var res = await fetch(WEB_APP_URL + '?action=updateLead&leadId=' + encodeURIComponent(String(leadId)), {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
          body: JSON.stringify({ action: 'updateLead', leadId: String(leadId), updates: { notes: value } })
        });
        var data = await res.json();
        if (data.status !== 'success') throw new Error(data.message || 'Update failed');
      } catch (err) {
        showToast('Error saving notes: ' + err.message, 'error');
      }
    }

    // ============ SETTINGS / EMAIL REMINDER FUNCTIONS ============

    function openSettingsModal() {
      document.getElementById('settingsModal').style.display = 'block';
      loadEmailSettings();
    }

    function closeSettingsModal() {
      document.getElementById('settingsModal').style.display = 'none';
    }

    function toggleEmailSettings() {
      var enabled = document.getElementById('emailEnabled').checked;
      document.getElementById('emailOptionsSection').style.display = enabled ? 'block' : 'none';
    }

    async function loadEmailSettings() {
      var statusText = document.getElementById('emailStatusText');
      var statusDot = document.getElementById('emailStatusDot');
      statusText.textContent = 'Loading settings...';

      try {
        var res = await fetch(WEB_APP_URL + '?action=getEmailSettings');
        var data = await res.json();
        if (data.status !== 'success') throw new Error(data.message || 'Failed to load settings');

        var settings = data.settings || {};
        document.getElementById('emailEnabled').checked = settings.enabled === true;
        document.getElementById('emailFrequency').value = settings.frequency || 'daily';
        document.getElementById('includeOverdue').checked = settings.includeOverdue !== false;
        document.getElementById('lookAheadDays').value = String(settings.lookAheadDays || 1);

        toggleEmailSettings();

        if (settings.enabled) {
          statusDot.className = 'status-dot active';
          var freqLabel = {daily:'Daily at 7:00 AM', weekly_mon:'Weekly on Mondays', weekly_fri:'Weekly on Fridays'};
          statusText.textContent = 'Active ? ' + (freqLabel[settings.frequency] || 'Daily at 7:00 AM');
          if (settings.lastSent) {
            statusText.textContent += ' ? Last sent: ' + new Date(settings.lastSent).toLocaleDateString();
          }
        } else {
          statusDot.className = 'status-dot inactive';
          statusText.textContent = 'Email reminders are currently off';
        }
      } catch (err) {
        console.error('loadEmailSettings error:', err);
        statusDot.className = 'status-dot inactive';
        statusText.textContent = 'Could not load settings';
      }
    }

    async function saveEmailSettings() {
      var saveBtn = document.getElementById('saveSettingsBtn');
      var originalHTML = saveBtn.innerHTML;
      saveBtn.disabled = true;
      saveBtn.innerHTML = 'Saving...';

      var settings = {
        enabled: document.getElementById('emailEnabled').checked,
        frequency: document.getElementById('emailFrequency').value,
        includeOverdue: document.getElementById('includeOverdue').checked,
        lookAheadDays: parseInt(document.getElementById('lookAheadDays').value, 10)
      };

      try {
        var res = await fetch(WEB_APP_URL + '?action=saveEmailSettings', {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
          body: JSON.stringify({ action: 'saveEmailSettings', settings: settings })
        });

        var data = await res.json();
        if (data.status !== 'success') throw new Error(data.message || 'Save failed');

        showToast('Email settings saved', 'success');
        loadEmailSettings();
      } catch (err) {
        console.error('saveEmailSettings error:', err);
        showToast('Error saving settings: ' + err.message, 'error');
      } finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalHTML;
      }
    }

    async function sendTestReminder() {
      try {
        var res = await fetch(WEB_APP_URL + '?action=sendTestReminder');
        var data = await res.json();
        if (data.status !== 'success') throw new Error(data.message || 'Test failed');
        showToast('Test reminder sent ? check rep inboxes', 'success');
      } catch (err) {
        showToast('Error sending test: ' + err.message, 'error');
      }
    }

    // Global function exports
    window.openAddLeadModal = openAddLeadModal;
    window.editLead = editLead;
    window.archiveLead = archiveLead;
    window.toggleAppointmentDate = toggleAppointmentDate;
    window.filterLeads = filterLeads;
    window.attemptCloseModal = attemptCloseModal;
    window.goToDashboard = () => { window.location.href = 'index.html'; };
    
    // New function exports
    window.toggleQuantumFields = toggleQuantumFields;
    window.generateProposal = generateProposal;
    window.closeProposalModal = closeProposalModal;
    window.updateAbboPricing = updateAbboPricing;
    window.updateQuantumPricing = updateQuantumPricing;
    window.submitAbbondanzaProposal = submitAbbondanzaProposal;
    window.submitQuantumProposal = submitQuantumProposal;
    window.downloadLeadTemplate = downloadLeadTemplate;
    window.openImportModal = openImportModal;
    window.closeImportModal = closeImportModal;
    window.handleFileSelect = handleFileSelect;
    window.importLeads = importLeads;
    window.exportLeadsToExcel = exportLeadsToExcel;
    window.openDeleteModal = openDeleteModal;
    window.closeDeleteModal = closeDeleteModal;
    window.validateDeleteConfirmation = validateDeleteConfirmation;
    window.confirmDeleteLead = confirmDeleteLead;
    window.openSettingsModal = openSettingsModal;
    window.closeSettingsModal = closeSettingsModal;
    window.toggleEmailSettings = toggleEmailSettings;
    // ==================== TEAM MEMBERS ====================
    var teamMembers = [];

    async function prefetchTeamMembers() {
      try {
        var resp = await fetch(WEB_APP_URL + '?action=getTeamMembers');
        var data = await resp.json();
        teamMembers = (data.status === 'success' && data.members) ? data.members : [];
      } catch(e) { teamMembers = []; }
    }

    async function openTeamMembersModal() {
      var existing = document.getElementById('teamModal');
      if (existing) existing.remove();

      // Always fetch fresh
      try {
        var resp = await fetch(WEB_APP_URL + '?action=getTeamMembers');
        var data = await resp.json();
        teamMembers = (data.status === 'success' && data.members) ? data.members : [];
      } catch(e) {}

      var overlay = document.createElement('div');
      overlay.id = 'teamModal';
      overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:9999';
      overlay.innerHTML = '<div style="background:#fff;border-radius:14px;max-width:640px;width:95%;max-height:85vh;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.3)">' +
        '<div style="background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff;padding:18px 24px;display:flex;justify-content:space-between;align-items:center"><h3 style="margin:0;font-size:17px">Team Members</h3><button onclick="document.getElementById(\'teamModal\').remove()" style="background:none;border:none;color:#fff;font-size:20px;cursor:pointer">&times;</button></div>' +
        '<div style="padding:20px 24px;overflow-y:auto;max-height:60vh">' +
          '<div style="display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap">' +
            '<input id="tmName" placeholder="Name" style="flex:1;min-width:100px;padding:8px 10px;border:1px solid #cbd5e0;border-radius:6px;font-size:12px"/>' +
            '<input id="tmEmail" placeholder="Email" style="flex:1.2;min-width:140px;padding:8px 10px;border:1px solid #cbd5e0;border-radius:6px;font-size:12px"/>' +
            '<input id="tmPosition" placeholder="Position" style="flex:0.8;min-width:90px;padding:8px 10px;border:1px solid #cbd5e0;border-radius:6px;font-size:12px"/>' +
            '<input id="tmPhone" placeholder="Phone" style="flex:0.8;min-width:90px;padding:8px 10px;border:1px solid #cbd5e0;border-radius:6px;font-size:12px"/>' +
            '<button onclick="addTeamMember()" style="padding:8px 14px;background:linear-gradient(135deg,#10b981,#059669);color:#fff;border:none;border-radius:6px;font-weight:600;font-size:12px;cursor:pointer;white-space:nowrap">+ Add</button>' +
          '</div>' +
          '<div id="teamList"></div>' +
        '</div>' +
        '<div style="padding:12px 24px;background:#f8fafc;border-top:1px solid #e2e8f0;text-align:right"><button onclick="document.getElementById(\'teamModal\').remove()" style="padding:9px 20px;background:#e2e8f0;color:#4a5568;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:13px">Close</button></div>' +
        '</div>';
      document.body.appendChild(overlay);
      renderTeamList();
    }

    function renderTeamList() {
      var el = document.getElementById('teamList');
      if (!el) return;
      if (teamMembers.length === 0) { el.innerHTML = '<div style="text-align:center;padding:20px;color:#94a3b8;font-size:13px">No team members yet. Add one above.</div>'; return; }
      var h = '';
      var colors = ['#6366f1','#059669','#f59e0b','#dc2626','#8b5cf6','#14b8a6'];
      for (var i = 0; i < teamMembers.length; i++) {
        var m = teamMembers[i];
        var initials = (m.name || '??').split(' ').map(function(w){return w[0]||'';}).join('').toUpperCase().substring(0,2);
        var bg = colors[i % colors.length];
        h += '<div id="tmItem-' + i + '" style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:#f8fafc;border-radius:8px;margin-bottom:6px;border:1px solid #e2e8f0">';
        h += '<div style="width:32px;height:32px;border-radius:50%;background:' + bg + ';color:#fff;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0">' + initials + '</div>';
        h += '<div style="flex:1;min-width:0"><div style="font-weight:600;font-size:13px;color:#1e293b">' + esc(m.name) + '</div>';
        h += '<div style="font-size:11px;color:#64748b">' + esc(m.email || '(no email)') + (m.position ? ' | ' + esc(m.position) : '') + (m.phone ? ' | ' + esc(m.phone) : '') + '</div></div>';
        h += '<button onclick="editTeamMember(' + i + ')" style="padding:4px 10px;border-radius:4px;border:1px solid #bfdbfe;background:#fff;color:#2563eb;font-size:11px;cursor:pointer;font-weight:600;flex-shrink:0">Edit</button>';
        h += '<button onclick="removeTeamMember(\'' + (m.id || '') + '\',' + i + ')" style="padding:4px 10px;border-radius:4px;border:1px solid #fecaca;background:#fff;color:#ef4444;font-size:11px;cursor:pointer;font-weight:600;flex-shrink:0">Remove</button>';
        h += '</div>';
      }
      el.innerHTML = h;
    }

    async function addTeamMember() {
      var name = document.getElementById('tmName').value.trim();
      var email = document.getElementById('tmEmail').value.trim();
      var position = document.getElementById('tmPosition').value.trim();
      var phone = document.getElementById('tmPhone').value.trim();
      if (!name) { showToast('Name is required', 'error'); return; }
      if (!email) { showToast('Email is required', 'error'); return; }
      try {
        var resp = await fetch(WEB_APP_URL, {method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'},
          body: JSON.stringify({action:'addTeamMember', member:{name:name, email:email, position:position, phone:phone}})});
        var data = await resp.json();
        if (data.status === 'success') {
          teamMembers.push({id:data.id, name:name, email:email, position:position, phone:phone});
          renderTeamList();
          document.getElementById('tmName').value = '';
          document.getElementById('tmEmail').value = '';
          document.getElementById('tmPosition').value = '';
          document.getElementById('tmPhone').value = '';
          showToast(name + ' added', 'success');
        } else { showToast(data.message, 'error'); }
      } catch(e) { showToast('Error: ' + e.message, 'error'); }
    }

    async function removeTeamMember(memberId, index) {
      if (!confirm('Remove this team member?')) return;
      if (memberId) {
        try {
          await fetch(WEB_APP_URL, {method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'},
            body: JSON.stringify({action:'removeTeamMember', memberId:memberId})});
        } catch(e) {}
      }
      teamMembers.splice(index, 1);
      renderTeamList();
      showToast('Removed', 'success');
    }

    function editTeamMember(index) {
      var m = teamMembers[index];
      var item = document.getElementById('tmItem-' + index);
      if (!item) return;
      item.innerHTML = '<div style="display:flex;gap:6px;flex:1;flex-wrap:wrap;align-items:center">' +
        '<input id="tmEd-name-' + index + '" value="' + esc(m.name) + '" style="flex:1;min-width:80px;padding:5px 8px;border:1px solid #cbd5e0;border-radius:4px;font-size:12px"/>' +
        '<input id="tmEd-email-' + index + '" value="' + esc(m.email) + '" style="flex:1.2;min-width:120px;padding:5px 8px;border:1px solid #cbd5e0;border-radius:4px;font-size:12px"/>' +
        '<input id="tmEd-pos-' + index + '" value="' + esc(m.position || '') + '" placeholder="Position" style="flex:0.7;min-width:70px;padding:5px 8px;border:1px solid #cbd5e0;border-radius:4px;font-size:12px"/>' +
        '<input id="tmEd-phone-' + index + '" value="' + esc(m.phone || '') + '" placeholder="Phone" style="flex:0.7;min-width:70px;padding:5px 8px;border:1px solid #cbd5e0;border-radius:4px;font-size:12px"/>' +
        '</div><div style="display:flex;gap:4px;margin-left:8px">' +
        '<button onclick="saveEditTeamMember(' + index + ')" style="padding:4px 10px;border-radius:4px;border:1px solid #a7f3d0;background:#fff;color:#059669;font-size:11px;cursor:pointer;font-weight:600">Save</button>' +
        '<button onclick="renderTeamList()" style="padding:4px 10px;border-radius:4px;border:1px solid #cbd5e0;background:#fff;color:#4a5568;font-size:11px;cursor:pointer;font-weight:600">Cancel</button></div>';
    }

    async function saveEditTeamMember(index) {
      var m = teamMembers[index];
      var name = document.getElementById('tmEd-name-' + index).value.trim();
      var email = document.getElementById('tmEd-email-' + index).value.trim();
      var position = document.getElementById('tmEd-pos-' + index).value.trim();
      var phone = document.getElementById('tmEd-phone-' + index).value.trim();
      if (!name || !email) { showToast('Name and email required', 'error'); return; }
      m.name = name; m.email = email; m.position = position; m.phone = phone;
      if (m.id) {
        try {
          await fetch(WEB_APP_URL, {method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'},
            body: JSON.stringify({action:'updateTeamMember', member:m})});
        } catch(e) {}
      }
      renderTeamList();
      showToast('Updated', 'success');
    }

    // ==================== REP DROPDOWN + POST-SAVE ALERT ====================
    async function populateRepDropdown(preselect) {
      var sel = document.getElementById('repSelect');
      if (!sel) return;
      // Force-fetch if teamMembers not loaded yet
      if (!teamMembers || teamMembers.length === 0) {
        try {
          var resp = await fetch(WEB_APP_URL + '?action=getTeamMembers');
          var data = await resp.json();
          teamMembers = (data.status === 'success' && data.members) ? data.members : [];
        } catch(e) { teamMembers = []; }
      }
      sel.innerHTML = '<option value="">Select a rep...</option>';
      var members = teamMembers || [];
      for (var i = 0; i < members.length; i++) {
        var m = members[i];
        var opt = document.createElement('option');
        opt.value = i;
        opt.textContent = m.name + (m.position ? ' - ' + m.position : '') + (m.email ? ' (' + m.email + ')' : '');
        opt.setAttribute('data-name', m.name || '');
        opt.setAttribute('data-email', m.email || '');
        opt.setAttribute('data-phone', m.phone || '');
        // Pre-select by name match
        if (preselect && m.name && m.name.trim().toLowerCase() === String(preselect).trim().toLowerCase()) {
          opt.selected = true;
        }
        sel.appendChild(opt);
      }
      // If preselected, fire the hidden field sync
      if (sel.value) onRepSelected();
    }

    function onRepSelected() {
      var sel = document.getElementById('repSelect');
      var opt = sel.options[sel.selectedIndex];
      if (!opt || !opt.value) {
        document.getElementById('repName').value = '';
        document.getElementById('repPhone').value = '';
        document.getElementById('repEmail').value = '';
        return;
      }
      document.getElementById('repName').value = opt.getAttribute('data-name') || '';
      document.getElementById('repPhone').value = opt.getAttribute('data-phone') || '';
      document.getElementById('repEmail').value = opt.getAttribute('data-email') || '';
    }

    function showAlertRepPopup(leadId, repName, repEmail, company, phone, contact, notes) {
      var existing = document.getElementById('postSaveAlertOverlay');
      if (existing) existing.remove();
      var overlay = document.createElement('div');
      overlay.id = 'postSaveAlertOverlay';
      overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:9999';
      overlay.innerHTML = '<div style="background:#fff;border-radius:14px;max-width:460px;width:95%;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.3)">' +
        '<div style="background:linear-gradient(135deg,#263238,#37474f);color:#fff;padding:18px 24px"><h3 style="margin:0;font-size:17px;display:flex;align-items:center;gap:8px"><svg viewBox="0 0 24 24" style="width:20px;height:20px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>Alert Sales Rep?</h3><p style="margin:4px 0 0;opacity:.8;font-size:13px">Lead saved successfully</p></div>' +
        '<div style="padding:20px 24px">' +
          '<div style="padding:14px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;margin-bottom:16px">' +
            '<div style="font-size:11px;color:#94a3b8;font-weight:600;text-transform:uppercase;margin-bottom:8px">New Lead Details</div>' +
            '<div style="font-size:14px;font-weight:700;color:#1e293b;margin-bottom:4px">' + esc(company) + '</div>' +
            (contact ? '<div style="font-size:13px;color:#4a5568">Contact: ' + esc(contact) + '</div>' : '') +
            (phone ? '<div style="font-size:13px;color:#4a5568">Phone: ' + esc(phone) + '</div>' : '') +
          '</div>' +
          '<div style="padding:12px;background:#ecfdf5;border:1px solid #a7f3d0;border-radius:8px;font-size:13px;color:#065f46;line-height:1.6">' +
            '<div style="font-weight:700;margin-bottom:6px">Send alert to ' + esc(repName) + '?</div>' +
            '<div style="font-size:12px;color:#4a5568">' +
              '<div>&#8226; Email alert sent to <strong>' + esc(repEmail) + '</strong></div>' +
              '<div>&#8226; Auto-assign <strong>Call</strong> action in Follow Up Actions</div>' +
            '</div>' +
          '</div>' +
        '</div>' +
        '<div style="padding:14px 24px;background:#f8fafc;display:flex;justify-content:flex-end;gap:8px;border-top:1px solid #e2e8f0">' +
          '<button onclick="document.getElementById(\'postSaveAlertOverlay\').remove()" style="padding:9px 20px;background:#e2e8f0;color:#4a5568;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:14px">No Thanks</button>' +
          '<button id="postSaveAlertBtn" style="padding:9px 20px;background:linear-gradient(135deg,#059669,#047857);color:#fff;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:14px">Yes, Alert Rep</button>' +
        '</div></div>';
      document.body.appendChild(overlay);

      document.getElementById('postSaveAlertBtn').addEventListener('click', async function() {
        // Close overlay instantly
        var ov = document.getElementById('postSaveAlertOverlay');
        if (ov) ov.remove();
        showToast('Sending alert to ' + repName + '...', 'success');

        // Find matching FU action ID
        var actionId = '';
        try {
          var fuResp = await fetch(WEB_APP_URL + '?action=getFollowUpActions');
          var fuData = await fuResp.json();
          if (fuData.status === 'success' && fuData.actions) {
            var match = fuData.actions.find(function(a) {
              return String(a.leadId) === String(leadId) || String(a.company).trim().toLowerCase() === String(company).trim().toLowerCase();
            });
            if (match) actionId = match.id;
          }
        } catch(e) {}

        try {
          var resp = await fetch(WEB_APP_URL, {method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'},
            body: JSON.stringify({
              action:'sendRepAlert',
              repName: repName,
              repEmail: repEmail,
              company: company,
              phone: phone,
              contact: contact,
              notes: notes,
              actionId: actionId
            })});
          var data = await resp.json();
          if (data.status === 'success') {
            showToast('Alert sent to ' + repName + '!', 'success');
          } else {
            showToast('Error: ' + data.message, 'error');
          }
        } catch(e) {
          showToast('Error: ' + e.message, 'error');
        }
      });
    }

    // ==================== SEND REP ALERT (from Lead DB) ====================
    async function sendRepAlertFromDB(leadId) {
      var lead = allLeads.find(function(l) { return safeLeadId(l) === String(leadId); });
      if (!lead) { showToast('Lead not found', 'error'); return; }

      var members = teamMembers;
      if (members.length === 0) {
        try {
          var resp = await fetch(WEB_APP_URL + '?action=getTeamMembers');
          var data = await resp.json();
          members = (data.status === 'success' && data.members) ? data.members : [];
          teamMembers = members;
        } catch(e) {}
      }
      if (members.length === 0) { showToast('No team members. Add team members first.', 'error'); return; }

      var opts = '';
      for (var i = 0; i < members.length; i++) {
        opts += '<option value="' + i + '">' + esc(members[i].name) + ' - ' + esc(members[i].position || 'No position') + ' (' + esc(members[i].email) + ')</option>';
      }

      var overlay = document.createElement('div');
      overlay.id = 'alertOverlay';
      overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:9999';
      overlay.innerHTML = '<div style="background:#fff;border-radius:14px;max-width:460px;width:95%;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.3)">' +
        '<div style="background:linear-gradient(135deg,#dc2626,#ef4444);color:#fff;padding:18px 24px"><h3 style="margin:0;font-size:17px">Send Rep Alert</h3><p style="margin:4px 0 0;opacity:.8;font-size:12px">' + esc(lead.companyName || '') + '</p></div>' +
        '<div style="padding:20px 24px">' +
          '<div style="margin-bottom:16px"><label style="font-size:12px;font-weight:700;color:#1e293b;display:block;margin-bottom:6px">Select Sales Rep</label>' +
          '<select id="alertRepSelect" style="width:100%;padding:10px 12px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px">' + opts + '</select></div>' +
          '<div style="padding:12px;background:#fef2f2;border:1px solid #fecaca;border-radius:8px;font-size:12px;color:#4a5568;line-height:1.6">' +
            '<div style="font-weight:700;color:#dc2626;margin-bottom:6px">This will:</div>' +
            '<div>&bull; Send email alert to the selected rep</div>' +
            '<div>&bull; Auto-assign <strong>Call</strong> action in Follow Up Actions</div>' +
            '<div>&bull; Set action date to <strong>today</strong></div>' +
            '<div>&bull; Assign rep as the <strong>Who</strong></div>' +
          '</div>' +
        '</div>' +
        '<div style="padding:14px 24px;background:#f8fafc;display:flex;justify-content:flex-end;gap:8px;border-top:1px solid #e2e8f0">' +
          '<button onclick="document.getElementById(\'alertOverlay\').remove()" style="padding:9px 20px;background:#e2e8f0;color:#4a5568;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:13px">Cancel</button>' +
          '<button id="alertSendBtn" onclick="confirmRepAlertFromDB(\'' + leadId + '\')" style="padding:9px 20px;background:linear-gradient(135deg,#dc2626,#ef4444);color:#fff;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:13px">Send Alert</button>' +
        '</div></div>';
      document.body.appendChild(overlay);
      window._alertMembersDB = members;
    }

    async function confirmRepAlertFromDB(leadId) {
      var lead = allLeads.find(function(l) { return safeLeadId(l) === String(leadId); });
      if (!lead) return;
      var sel = document.getElementById('alertRepSelect');
      var idx = parseInt(sel.value);
      var member = window._alertMembersDB[idx];
      if (!member || !member.email) { showToast('No valid email for selected rep', 'error'); return; }

      // Close overlay instantly
      var ov = document.getElementById('alertOverlay');
      if (ov) ov.remove();
      showToast('Sending alert to ' + member.name + '...', 'success');

      // Fire in background
      try {
        var actionId = '';
        try {
          var fuResp = await fetch(WEB_APP_URL + '?action=getFollowUpActions');
          var fuData = await fuResp.json();
          if (fuData.status === 'success' && fuData.actions) {
            var match = fuData.actions.find(function(a) {
              return String(a.leadId) === String(lead.id) || String(a.leadId) === String(leadId);
            });
            if (match) actionId = match.id;
          }
        } catch(e) {}

        var resp = await fetch(WEB_APP_URL, {method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'},
          body: JSON.stringify({
            action:'sendRepAlert',
            repName: member.name,
            repEmail: member.email,
            company: lead.companyName || '',
            phone: lead.phone || '',
            contact: lead.contactName || '',
            notes: lead.notes || '',
            actionId: actionId
          })});
        var data = await resp.json();
        if (data.status === 'success') {
          showToast('Alert sent to ' + member.name + '!', 'success');
        } else {
          showToast('Error: ' + data.message, 'error');
        }
      } catch(e) {
        showToast('Error: ' + e.message, 'error');
      }
    }

    window.prefetchTeamMembers = prefetchTeamMembers;
    window.openTeamMembersModal = openTeamMembersModal;
    window.addTeamMember = addTeamMember;
    window.removeTeamMember = removeTeamMember;
    window.editTeamMember = editTeamMember;
    window.saveEditTeamMember = saveEditTeamMember;
    window.sendRepAlertFromDB = sendRepAlertFromDB;
    window.confirmRepAlertFromDB = confirmRepAlertFromDB;
    window.saveEmailSettings = saveEmailSettings;
    window.sendTestReminder = sendTestReminder;
    window.inlineDateEdit = inlineDateEdit;
    window.toggleApptMade = toggleApptMade;
    window.inlineNotesEdit = inlineNotesEdit;
    window.openStatusPicker = openStatusPicker;
    window.populateRepDropdown = populateRepDropdown;
    window.onRepSelected = onRepSelected;
    window.showAlertRepPopup = showAlertRepPopup;
  </script>
</body>
</html>








