<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quantum Solutions Sales Force</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Condensed:wght@400;600;700&display=swap" rel="stylesheet"/>

  <!-- Shared auth (login/register/reset) -->
  <script defer src="password.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #1e3a8a;
      min-height: 100vh;
      padding: 20px;
      color: #333;
      font-size: 18px;
    }

    /* Company Switcher */
    .company-switcher {
      display: flex;
      justify-content: center;
      gap: 20px;
      padding: 20px;
      position: sticky;
      top: 0;
      z-index: 1000;
      background: #000000;
      margin: -20px -20px 30px -20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    }

    .company-btn {
      padding: 12px 25px;
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.2);
      color: white;
      font-size: 18px;
      font-weight: 600;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 12px;
      backdrop-filter: blur(10px);
      text-decoration: none;
    }

    .company-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .company-btn.active {
      background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
      border-color: transparent;
      box-shadow: 0 10px 30px rgba(59, 130, 246, 0.5),
                  0 0 60px rgba(59, 130, 246, 0.3);
      animation: glow 2s ease-in-out infinite alternate;
    }

    @keyframes glow {
      from { box-shadow: 0 10px 30px rgba(59, 130, 246, 0.5), 0 0 60px rgba(59, 130, 246, 0.3); }
      to   { box-shadow: 0 10px 40px rgba(59, 130, 246, 0.7), 0 0 80px rgba(59, 130, 246, 0.5); }
    }

    .company-logo { height: 35px; width: auto; filter: brightness(0) invert(1); transition: all 0.3s ease; }
    .abbondanza-logo { height: 40px; }
    .company-btn:hover .company-logo { transform: scale(1.05); }

    .dashboard-container { max-width: 1400px; margin: 0 auto; animation: fadeIn 0.8s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    .header { text-align: center; margin-bottom: 35px; color: white; position: relative; }
    .header h1 {
      font-size: 3.2em; font-weight: 700; margin-bottom: 10px; color: white;
      font-family: 'IBM Plex Sans Condensed', 'Arial Narrow', sans-serif;
      letter-spacing: 2px; text-transform: uppercase;
      text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.5);
      animation: titleGlow 3s ease-in-out infinite alternate;
    }
    @keyframes titleGlow { from { filter: brightness(1); } to { filter: brightness(1.3); } }
    .header p { font-size: 1.3em; opacity: 0.9; }

    /* Quantum Grid - Vertical Stack */
    .quantum-grid { display: grid; grid-template-columns: 1fr; gap: 20px; max-width: 800px; margin: 0 auto; }

    .card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px; padding: 20px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.25);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative; overflow: hidden;
    }
    .card::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px;
      background: linear-gradient(90deg, #1e3a8a 0%, #1e40af 100%);
      transform: scaleX(0); transform-origin: left; transition: transform 0.3s ease;
    }
    .card:hover::before { transform: scaleX(1); }
    .card:hover { transform: translateY(-3px); box-shadow: 0 15px 45px rgba(0, 0, 0, 0.35); }
    .card h2 { font-size: 1.5em; margin-bottom: 10px; color: #2d3748; }
    .card p  { color: #718096; margin-bottom: 18px; line-height: 1.5; font-size: 1.1em; }

    .btn {
      display: inline-block; padding: 12px 26px; background: #1e3a8a; color: white;
      text-decoration: none; border-radius: 25px; font-weight: 600; transition: all 0.3s ease;
      position: relative; overflow: hidden; border: none; cursor: pointer; font-size: 1.05em;
    }
    .btn::after {
      content: ''; position: absolute; top: 50%; left: 50%; width: 0; height: 0;
      border-radius: 50%; background: rgba(255, 255, 255, 0.3);
      transform: translate(-50%, -50%); transition: width 0.6s, height 0.6s;
    }
    .btn:hover::after { width: 300px; height: 300px; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(30, 58, 138, 0.4); background: #1e40af; }

    /* Modal Styles */
    .modal-overlay {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.7); z-index: 10000; backdrop-filter: blur(5px);
    }
    .modal {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: white; border-radius: 20px; padding: 25px 35px; max-width: 900px; width: 95%;
      max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); z-index: 10001;
    }
    .modal h3 { margin-bottom: 15px; color: #2d3748; text-align: center; font-size: 1.4em; }

    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 5px; color: #4a5568; font-weight: 600; font-size: 1.05em; }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 1.05em; transition: border-color 0.3s ease;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #1e3a8a; }
    .form-group small { display: block; margin-top: 5px; color: #718096; font-size: 0.95em; }

    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }

    .pricing-summary { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 20px; border-radius: 15px; margin: 20px 0; border: 2px solid #1e3a8a; }
    .pricing-summary h4 { margin: 0 0 15px 0; color: #2d3748; font-size: 1.3em; text-align: center; }

    .modal-buttons { display: flex; gap: 15px; margin-top: 25px; }
    .btn-primary { background: #1e3a8a; flex: 2; }
    .btn-primary:hover { background: #1e40af; }
    .btn-secondary { background: #64748b; flex: 1; }
    .btn-secondary:hover { background: #475569; }

    .close-btn { background: #e53e3e; color: white; border: none; padding: 10px 22px; border-radius: 20px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; font-size: 1.05em; }
    .close-btn:hover { background: #c53030; transform: scale(1.05); }

    .success-popup { background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); border: 2px solid #28a745; color: #155724; padding: 20px; border-radius: 15px; text-align: center; font-size: 1.05em; }
    .error-popup   { background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%); border: 2px solid #dc3545; color: #721c24; padding: 20px; border-radius: 15px; text-align: center; font-size: 1.05em; }

    .loading-spinner {
      display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #1e3a8a;
      border-radius: 50%; animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Archive functionality styling */
    .filter-container {
      display: flex;
      gap: 15px;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .archive-filter {
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 16px;
      background: white;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 180px;
    }

    .archive-filter:focus {
      outline: none;
      border-color: #1e3a8a;
    }

    .refresh-btn {
      background: #10b981 !important;
      font-size: 14px !important;
      padding: 12px 20px !important;
      min-width: 100px !important;
      color: white !important;
      font-weight: 600;
    }

    .refresh-btn:hover {
      background: #059669 !important;
    }

    .archive-btn {
      background: #f59e0b !important;
      color: white !important;
      font-size: 14px !important;
      padding: 12px 24px !important;
      min-width: 90px !important;
      font-weight: 600;
    }

    .archive-btn:hover {
      background: #d97706 !important;
    }

    .archived-item {
      opacity: 0.7;
      background: #f8fafc !important;
    }

    .archived-badge {
      background: #f59e0b;
      color: white;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 12px;
      font-weight: 600;
      margin-left: 10px;
    }

    /* Search input styling */
    #quantumProposalSearch {
      padding: 10px 40px 10px 14px !important;
      font-size: 14px !important;
      border: 1px solid #e2e8f0 !important;
      border-radius: 6px !important;
      transition: all 0.3s ease !important;
    }

    #quantumProposalSearch:focus {
      outline: none !important;
      border-color: #1e3a8a !important;
      box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1) !important;
    }

    #clearQuantumSearchBtn {
      position: absolute !important;
      right: 8px !important;
      top: 50% !important;
      transform: translateY(-50%) !important;
      background: #e2e8f0 !important;
      border: none !important;
      border-radius: 50% !important;
      width: 24px !important;
      height: 24px !important;
      cursor: pointer !important;
      display: none !important;
      font-size: 14px !important;
      color: #64748b !important;
      transition: all 0.3s ease !important;
    }

    #clearQuantumSearchBtn:hover {
      background: #cbd5e1 !important;
      color: #374151 !important;
    }
  </style>
</head>

<body>
  <!-- Company Switcher -->
  <div class="company-switcher">
    <a href="index.html" class="company-btn">
      <img src="images/abbondanza-logo.png" alt="Abbondanza" class="company-logo abbondanza-logo">
      <span>Abbondanza Vending LLC</span>
    </a>
    <button class="company-btn active" type="button">
      <img src="images/quantum-logo-transparent.png" alt="Quantum Solutions" class="company-logo">
      <span>Quantum Solutions</span>
    </button>
  </div>

  <div class="dashboard-container">
    <div class="header">
      <h1>Quantum Solutions Dashboard</h1>
      <p>Smart Food Fridge Solutions for Modern Businesses</p>
    </div>

    <!-- Quantum Solutions - 5 Cards Vertical Stack -->
    <div class="quantum-grid">
      <div class="card">
        <h2>How We Stack Up</h2>
        <p>Marketing materials and competitive analysis showing Quantum Solutions advantages over traditional vending.</p>
        <button onclick="openQuantumAboutUs()" class="btn" type="button">View Materials</button>
      </div>

      <div class="card">
        <h2>Proposal Management</h2>
        <p>Create and access Smart Food Fridge proposals with comprehensive pricing analysis and searchable library.</p>
        <div style="display:flex;gap:15px;margin-top:18px;">
          <button onclick="openQuantumProposalGenerator()" class="btn" style="flex:1;" type="button">Generate Proposal</button>
          <button onclick="openQuantumProposalViewer()" class="btn" style="flex:1;" type="button">View Library</button>
        </div>
      </div>

      <div class="card">
        <h2>Master Service Agreement</h2>
        <p>Print to sign comprehensive service agreements for enterprise clients and partnerships.</p>
        <button onclick="openQuantumMasterAgreement()" class="btn" type="button">View Agreement</button>
      </div>

      <div class="card">
        <h2>ROI Calculator</h2>
        <p>Interactive calculator to demonstrate cost savings and return on investment for potential clients.</p>
        <button onclick="openQuantumROICalculator()" class="btn" type="button">Open Calculator</button>
      </div>

      <div class="card">
        <h2>Lead Logger</h2>
        <p>Track and manage sales leads with company-specific categorization and comprehensive follow-up system.</p>
        <button onclick="openQuantumLeadLogger()" class="btn" type="button">Open Lead Logger</button>
      </div>
    </div>
  </div>

  <!-- Quantum Proposal Generator Modal -->
  <div id="quantumProposalModal" class="modal-overlay">
    <div class="modal">
      <h3>Generate Smart Food Fridge Proposal</h3>

      <div class="form-row">
        <div class="form-group">
          <label for="quantumCompanyName">Company Name *</label>
          <input type="text" id="quantumCompanyName" name="quantumCompanyName" required>
        </div>
        <div class="form-group">
          <label for="quantumContactName">Contact Name (Optional)</label>
          <input type="text" id="quantumContactName" name="quantumContactName" placeholder="Leave blank if unknown">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="customerAddress">Customer Address *</label>
          <input type="text" id="customerAddress" name="customerAddress" placeholder="City, State" required>
        </div>
        <div class="form-group">
          <label for="customerZip">Customer Zip Code *</label>
          <input type="text" id="customerZip" name="customerZip" pattern="[0-9]{5}" maxlength="5" placeholder="12345" required onchange="updateQuantumPricingSummary()">
          <small>Used for freight calculation</small>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="quantumPreparedBy">Your Name *</label>
          <input type="text" id="quantumPreparedBy" name="quantumPreparedBy" required>
        </div>
        <div class="form-group">
          <label for="quantumPreparedByPhone">Your Phone *</label>
          <input type="tel" id="quantumPreparedByPhone" name="quantumPreparedByPhone" required>
        </div>
      </div>

      <div class="form-group">
        <label for="quantumPreparedByEmail">Your Email *</label>
        <input type="email" id="quantumPreparedByEmail" name="quantumPreparedByEmail" required>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="customerType">Customer Type *</label>
          <select id="customerType" name="customerType" required onchange="updateCustomerType()">
            <option value="new" selected>New Customer (includes scanner)</option>
            <option value="existing">Existing Customer (has scanner)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="quantumFridgeCount">Number of Fridges *</label>
          <input type="number" id="quantumFridgeCount" name="quantumFridgeCount" min="1" value="1" required onchange="updateQuantumPricingSummary()">
        </div>
      </div>

      <div class="form-group">
        <label for="scannerCount">RFID Scanners Needed</label>
        <select id="scannerCount" name="scannerCount" onchange="updateQuantumPricingSummary()">
          <option value="0">0 scanners</option>
          <option value="1" selected>1 scanner</option>
          <option value="2">2 scanners</option>
          <option value="3">3 scanners</option>
          <option value="4">4 scanners</option>
          <option value="5">5 scanners</option>
          <option value="6">6 scanners</option>
          <option value="7">7 scanners</option>
          <option value="8">8 scanners</option>
          <option value="9">9 scanners</option>
          <option value="10">10 scanners</option>
          <option value="11">11 scanners</option>
          <option value="12">12 scanners</option>
          <option value="13">13 scanners</option>
          <option value="14">14 scanners</option>
          <option value="15">15 scanners</option>
        </select>
        <small>New customers typically need 1 scanner per location. Additional scanners for backup or multiple sites.</small>
      </div>

      <div class="form-group">
        <label for="rfidRolls">RFID Tag Rolls (1,000 tags per roll)</label>
        <input type="number" id="rfidRolls" name="rfidRolls" min="0" max="50" value="5" onchange="updateQuantumPricingSummary()">
        <small>Recommended starting quantity: 5 rolls. $0.18 per tag ($180 per roll).</small>
      </div>

      <div class="pricing-summary">
        <h4>Proposal Summary</h4>
        <div id="quantumPricingSummary"></div>
      </div>

      <div class="modal-buttons">
        <button class="btn btn-secondary" onclick="closeQuantumModal('quantumProposalModal')" style="flex:1;background:#64748b;" type="button">Cancel</button>
        <button class="btn btn-primary" id="generateQuantumBtn" type="button" onclick="generateQuantumProposal()">Generate Proposal PDF</button>
      </div>
    </div>
  </div>

  <!-- App script: expose handlers on window so inline on* can find them -->
  <script>
    // Global variables for archive functionality
    window.allQuantumProposals = null;
    window.currentArchiveFilter = 'active';

    // Expose everything used by inline HTML attributes:
    window.openQuantumAboutUs = function openQuantumAboutUs() {
      const existingOverlay = document.querySelector('.modal-overlay');
      if (existingOverlay) existingOverlay.remove();

      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.style.display = 'block';

      const modal = document.createElement('div');
      modal.className = 'modal';

      const materials = [
        { title: 'Restaurant Industry Trends Report', id: '1MejzxfsJ7VHR9OzwYuO7iEWUdDPrcLzO', description: 'Current market trends and insights for the restaurant industry', type: 'pdf' },
        { title: 'Maximizing Revenue Per Square Foot in Food Service Operations', id: '1hTRsDlrx0MRzmdVrqrOyfqg5-Gj-6RQC', description: 'Strategies to optimize space utilization and increase profitability', type: 'pdf' },
        { title: 'Fresh Food Fridge Spec Sheet', id: '1RO1IXd032eCKM4z4gr09QSouIyGXA8R74PSXj5afIas', description: 'Technical specifications and features of our Smart Food Fridge', type: 'slides' },
        { title: 'Food Fridge Executive Overview', id: '1YFa7vPZC89YE4OM5wW5LTGwF5WD3lZAE', description: 'High-level overview and business benefits for decision makers', type: 'pdf' },
        { title: 'Commercial Real Estate Premium Food Amenities', id: '1eUfU0i5WD9KEg46biTguBCyQef_OxBi0', description: 'How premium food amenities enhance commercial property value', type: 'pdf' },
        { title: 'Smart RFID Refrigerated Fresh Food Fridge Technical Deep Dive and FAQ', id: '1zmo7_EccscAMQ-10q5yFF9k9vFdXHe3c', description: 'Comprehensive technical documentation and frequently asked questions', type: 'pdf' },
        { title: 'Food Fridge Presentation Slide Deck With Proposal Example', id: '19hC90aDJgAQCiNOPACjzhxEdFoE2iaUMpfirP3kAgzs', description: 'Robust presentation with how to use videos and proposal', type: 'slides' }
      ];

      const cards = materials.map(m => {
        let viewUrl, downloadUrl;
        if (m.type === 'slides') { viewUrl = `https://docs.google.com/presentation/d/${m.id}/preview`; downloadUrl = `https://docs.google.com/presentation/d/${m.id}/export/pdf`; }
        else if (m.type === 'docs') { viewUrl = `https://docs.google.com/document/d/${m.id}/preview`; downloadUrl = `https://docs.google.com/document/d/${m.id}/export?format=pdf`; }
        else if (m.type === 'sheets') { viewUrl = `https://docs.google.com/spreadsheets/d/${m.id}/preview`; downloadUrl = `https://docs.google.com/spreadsheets/d/${m.id}/export?format=pdf`; }
        else { viewUrl = `https://drive.google.com/file/d/${m.id}/view`; downloadUrl = `https://drive.google.com/uc?export=download&id=${m.id}`; }
        return (
          '<div style="background:#f8fafc;padding:25px;border-radius:15px;border:2px solid #e2e8f0;transition:all .3s ease;">' +
            '<div style="margin-bottom:20px;">' +
              `<h4 style="margin:0 0 10px 0;color:#1e3a8a;font-size:1.2em;font-weight:600;">${m.title}</h4>` +
              `<p style="margin:0;color:#64748b;font-size:.95em;line-height:1.5;">${m.description}</p>` +
            '</div>' +
            '<div style="display:flex;gap:15px;flex-wrap:wrap;">' +
              `<button class="btn btn-primary" onclick="window.open('${viewUrl}','_blank')" style="padding:12px 24px;font-size:.9em;min-width:120px;font-weight:600;">üëÅÔ∏è View PDF</button>` +
              `<button class="btn btn-secondary" onclick="window.open('${downloadUrl}','_blank')" style="padding:12px 24px;font-size:.9em;min-width:120px;font-weight:600;">üì• Download</button>` +
            '</div>' +
          '</div>'
        );
      }).join('');

      modal.innerHTML =
        '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;padding-bottom:15px;border-bottom:2px solid #e2e8f0;">' +
          '<h3 style="margin:0;color:#2d3748;font-size:1.8em;">How We Stack Up - Marketing Materials</h3>' +
          '<button class="close-btn" onclick="closeModal()">‚úï</button>' +
        '</div>' +
        `<div style="display:grid;gap:20px;">${cards}</div>`;

      overlay.appendChild(modal);
      document.body.appendChild(overlay);
    };

    window.closeModal = function closeModal() {
      const overlay = document.querySelector('.modal-overlay');
      if (overlay) overlay.remove();
    };

    window.openQuantumProposalGenerator = function openQuantumProposalGenerator() {
      const existingModal = document.getElementById('quantumProposalModal');
      if (existingModal) existingModal.style.display = 'none';
      setTimeout(() => {
        const modal = document.getElementById('quantumProposalModal');
        if (modal) {
          modal.style.display = 'block';
          updateQuantumPricingSummary();
          const generateBtn = document.getElementById('generateQuantumBtn');
          if (generateBtn) {
            const newBtn = generateBtn.cloneNode(true);
            generateBtn.parentNode.replaceChild(newBtn, generateBtn);
            newBtn.addEventListener('click', generateQuantumProposal);
          }
        }
      }, 100);
    };

    window.closeQuantumModal = function closeQuantumModal(id) {
      const m = document.getElementById(id);
      if (m) m.style.display = 'none';
    };

    window.updateCustomerType = function updateCustomerType() {
      const customerType = document.getElementById('customerType').value;
      const scannerCount = document.getElementById('scannerCount');
      scannerCount.value = (customerType === 'new') ? 1 : 0;
      updateQuantumPricingSummary();
    };

    function calculateFreight() {
      const fridgeCount = parseInt(document.getElementById('quantumFridgeCount').value) || 1;
      const customerZip = document.getElementById('customerZip').value;

      let baseFreight;
      if (fridgeCount === 1) baseFreight = 895;
      else if (fridgeCount === 2) baseFreight = 1400;
      else if (fridgeCount === 3) baseFreight = 1800;
      else baseFreight = fridgeCount * 550;

      let distanceMultiplier = 1.0;
      if (customerZip) {
        const zipCode = parseInt(customerZip);
        if (zipCode >= 20000 && zipCode <= 39999) distanceMultiplier = 1.2;
        else if (zipCode >= 40000) distanceMultiplier = 1.5;
      }
      return Math.round(baseFreight * distanceMultiplier);
    }

    window.updateQuantumPricingSummary = function updateQuantumPricingSummary() {
      const fridgeCount = parseInt(document.getElementById('quantumFridgeCount').value) || 1;
      const scannerCount = parseInt(document.getElementById('scannerCount').value) || 0;
      const rfidRolls = parseInt(document.getElementById('rfidRolls').value) || 0;
      const vinylWrap = false;
      const goldSupport = false;

      const fridgePrice = 7500;
      const scannerPrice = 455;
      const rfidRollPrice = 180;
      const wrapPrice = fridgeCount === 1 ? 645 : (fridgeCount * 547.50);
      const freight = calculateFreight();

      const fridgeTotal = fridgeCount * fridgePrice;
      const scannerTotal = scannerCount * scannerPrice;
      const rfidTotal = rfidRolls * rfidRollPrice;
      const wrapTotal = vinylWrap ? wrapPrice : 0;

      const oneTimeTotal = fridgeTotal + scannerTotal + rfidTotal + wrapTotal + freight;

      const monthlyLicense = fridgeCount * 175;
      const monthlyLTE = fridgeCount * 25;
      const monthlyGold = goldSupport ? (fridgeCount * 39) : 0;
      const monthlyTotal = monthlyLicense + monthlyLTE + monthlyGold;

      let html = `
        <div style="margin-bottom:15px;">
          <h4 style="color:#1e3a8a;margin-bottom:10px;">One-Time Costs</h4>
          <div>Food Fridges (${fridgeCount}): $${fridgeTotal.toLocaleString()}</div>`;
      if (scannerCount > 0) html += `<div>RFID Scanners (${scannerCount}): $${scannerTotal.toLocaleString()}</div>`;
      if (rfidRolls > 0) html += `<div>RFID Tags (${rfidRolls} rolls): $${rfidTotal.toLocaleString()}</div>`;
      if (vinylWrap) html += `<div>Vinyl Wrap: $${wrapTotal.toLocaleString()}</div>`;
      html += `
          <div>Freight: $${freight.toLocaleString()}</div>
          <div style="font-weight:bold;color:#1e3a8a;margin-top:10px;padding-top:10px;border-top:1px solid #e2e8f0;">
            One-Time Total: $${oneTimeTotal.toLocaleString()}
          </div>
        </div>
        <div>
          <h4 style="color:#1e3a8a;margin-bottom:10px;">Monthly Recurring</h4>
          <div>License Fees: $${monthlyLicense.toLocaleString()}/month</div>
          <div>LTE Service: $${monthlyLTE.toLocaleString()}/month</div>`;
      if (goldSupport) html += `<div>Gold Support: $${monthlyGold.toLocaleString()}/month</div>`;
      html += `
          <div style="font-weight:bold;color:#1e3a8a;margin-top:10px;padding-top:10px;border-top:1px solid #e2e8f0;">
            Monthly Total: $${monthlyTotal.toLocaleString()}/month
          </div>
        </div>`;
      document.getElementById('quantumPricingSummary').innerHTML = html;
    };

    window.generateQuantumProposal = async function generateQuantumProposal(event) {
      if (event) { event.preventDefault(); event.stopPropagation(); }
      const submitBtn = document.getElementById('generateQuantumBtn');
      const originalText = submitBtn.innerHTML;
      if (submitBtn.disabled) return;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="loading-spinner"></span> Generating...';

      try {
        const formData = {
          companyName: document.getElementById('quantumCompanyName').value,
          contactName: document.getElementById('quantumContactName').value || '',
          customerAddress: document.getElementById('customerAddress').value,
          customerZip: document.getElementById('customerZip').value,
          preparedBy: document.getElementById('quantumPreparedBy').value,
          preparedByPhone: document.getElementById('quantumPreparedByPhone').value,
          preparedByEmail: document.getElementById('quantumPreparedByEmail').value,
          customerType: document.getElementById('customerType').value,
          fridgeCount: document.getElementById('quantumFridgeCount').value,
          scannerCount: document.getElementById('scannerCount').value,
          rfidRolls: document.getElementById('rfidRolls').value || '0',
          vinylWrap: 'No',
          goldSupport: 'No'
        };
        if (!formData.companyName || !formData.preparedBy || !formData.preparedByPhone || !formData.preparedByEmail) {
          throw new Error('Please fill in all required fields.');
        }

        const QUANTUM_PROPOSAL_URL = 'https://script.google.com/macros/s/AKfycbxo7BkKNseerdgo0fBmIHkRcWF7XPt8EeuqRN_9hVgoqKVA1AxudQeStsdu_kyM7ADXHA/exec';
        const params = new URLSearchParams();
        Object.keys(formData).forEach(key => params.append(key, formData[key]));

        const response = await fetch(`${QUANTUM_PROPOSAL_URL}?${params.toString()}`);
        const result = await response.json();

        if (result.status === 'success') {
          closeQuantumModal('quantumProposalModal');
          showQuantumPopup(`
            <div class="success-popup">
              <h3>‚úÖ Proposal Generated Successfully!</h3>
              <p>Your Smart Food Fridge proposal has been created and saved to Library.</p>
              <p><strong>Company:</strong> ${formData.companyName}</p>
              <p><strong>Configuration:</strong> ${formData.fridgeCount} fridges, ${formData.scannerCount} scanners</p>
              <p><strong>Total Cost:</strong> $${result.data.pricing.oneTimeTotal.toLocaleString()} one-time + $${result.data.pricing.monthlyTotal}/month</p>
              <div style="margin-top:20px;display:flex;gap:10px;justify-content:center;">
                <button class="btn btn-primary" onclick="window.open('${result.pdfUrl}', '_blank')" style="padding:12px 24px;">üìÑ View PDF</button>
                <button class="btn btn-secondary" onclick="window.open('${result.pdfUrl.replace('/view?', '/export?format=pdf&')}', '_blank')" style="padding:12px 24px;">üì• Download</button>
              </div>
            </div>
          `, 'success');
        } else {
          throw new Error(result.message || 'Failed to generate proposal');
        }
      } catch (error) {
        showQuantumPopup(`
          <div class="error-popup">
            <h3>‚ùå Error Generating Proposal</h3>
            <p>${error.message}</p>
            <p>Please try again or contact support if the problem persists.</p>
          </div>
        `, 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
      }
    };

    window.showQuantumPopup = function showQuantumPopup(content, type) {
      const popup = document.createElement('div');
      popup.className = 'modal-overlay';
      popup.innerHTML = `
        <div class="modal" style="max-width:600px;">
          ${content}
          <div style="margin-top:20px;text-align:center;">
            <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Close</button>
          </div>
        </div>`;
      popup.style.display = 'block';
      document.body.appendChild(popup);
      if (type === 'success') setTimeout(() => { if (popup.parentNode) popup.remove(); }, 15000);
    };

    window.openQuantumMasterAgreement = function openQuantumMasterAgreement() {
      const existingOverlay = document.querySelector('.modal-overlay');
      if (existingOverlay) existingOverlay.remove();
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.style.display = 'block';

      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.maxWidth = '1200px';
      modal.style.height = '90vh';
      modal.style.display = 'flex';
      modal.style.flexDirection = 'column';

      const docId = '1ChcyX_PUlX48AhzAkNtsDWduamgQHomYSYM9LVwd3FA';
      const pdfUrl = `https://docs.google.com/document/d/${docId}/export?format=pdf`;
      const viewerUrl = `https://docs.google.com/document/d/${docId}/preview`;

      modal.innerHTML = `
        <div style="padding:20px;background:#f7fafc;border-radius:20px 20px 0 0;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #e2e8f0;">
          <h3 style="margin:0;color:#2d3748;font-size:1.3em;">Master Services Agreement (Food Fridge)</h3>
          <div style="display:flex;gap:10px;align-items:center;">
            <button class="btn btn-secondary" onclick="window.open('${pdfUrl}','_blank')" style="padding:10px 20px;">üì• Download PDF</button>
            <button class="close-btn" onclick="closeModal()">‚úï</button>
          </div>
        </div>
        <div style="flex:1;padding:20px;overflow:hidden;">
          <iframe src="${viewerUrl}" width="100%" height="100%" style="border:none;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1);" allowfullscreen></iframe>
        </div>`;
      overlay.appendChild(modal);
      document.body.appendChild(overlay);
    };

    window.openQuantumROICalculator = function openQuantumROICalculator() {
      const existing = document.querySelector('.modal-overlay.roi-overlay');
      if (existing) existing.remove();

      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay roi-overlay';
      overlay.style.display = 'block';

      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.maxWidth = '1200px';
      modal.style.height = '90vh';
      modal.style.display = 'flex';
      modal.style.flexDirection = 'column';

      // Cache-bust the ROI iframe to avoid stale code
      const src = 'roi-calculator.html?v=' + Date.now();
      modal.innerHTML = `
        <div style="padding:14px 16px;background:#f7fafc;border-radius:20px 20px 0 0;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #e2e8f0;">
          <h3 style="margin:0;color:#1e3a8a;font-size:1.2em;">ROI Calculator</h3>
          <button class="close-btn" onclick="document.querySelector('.roi-overlay').remove()">‚úï</button>
        </div>
        <div style="flex:1;padding:12px;overflow:hidden;">
          <iframe src="${src}" width="100%" height="100%" style="border:none;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.08);" allowfullscreen></iframe>
        </div>`;
      overlay.appendChild(modal);
      document.body.appendChild(overlay);
    };

    window.openQuantumLeadLogger = function openQuantumLeadLogger() {
      window.location.href = 'lead-logger.html';
    };

    window.openQuantumProposalViewer = function openQuantumProposalViewer() {
      const existingOverlay = document.querySelector('.proposal-viewer-overlay');
      if (existingOverlay) existingOverlay.remove();

      window.allQuantumProposals = null;
      window.currentArchiveFilter = 'active';

      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay proposal-viewer-overlay';
      overlay.style.display = 'block';

      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.maxWidth = '1200px';
      modal.style.width = '95%';
      modal.style.height = '85vh';

      modal.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:15px;border-bottom:1px solid #e2e8f0;">
          <h3 style="margin:0;color:#1e3a8a;font-size:1.5em;font-weight:600;">Proposal Library</h3>
          <button class="close-btn" onclick="closeQuantumProposalViewer()">Close</button>
        </div>
        
        <div class="filter-container">
          <select id="quantumArchiveFilter" class="archive-filter" onchange="changeQuantumArchiveFilter()">
            <option value="active">Active Proposals</option>
            <option value="archived">Archived Proposals</option>
            <option value="all">All Proposals</option>
          </select>
          
          <button class="btn refresh-btn" onclick="refreshQuantumProposals()">üîÑ Refresh</button>
          
          <div style="position:relative;flex:1;">
            <input type="text" id="quantumProposalSearch" placeholder="Search by company name..."
                   style="width:100%;"
                   onkeyup="filterQuantumProposals()"
                   onfocus="this.style.borderColor='#1e3a8a'"
                   onblur="this.style.borderColor='#e2e8f0'">
            <button id="clearQuantumSearchBtn" onclick="document.getElementById('quantumProposalSearch').value=''; this.style.display='none'; filterQuantumProposals();">√ó</button>
          </div>
        </div>
        
        <div id="quantumProposalsList" style="display:grid;gap:12px;max-height:60vh;overflow-y:auto;padding-right:4px;">
          <div style="text-align:center;padding:40px;">
            <div class="loading-spinner"></div>
            <p style="margin-top:15px;color:#64748b;font-size:14px;">Loading proposals from library...</p>
          </div>
        </div>`;
      overlay.appendChild(modal);
      document.body.appendChild(overlay);
      
      setTimeout(() => { loadQuantumProposalsFromDrive(); }, 100);
    };

    window.closeQuantumProposalViewer = function closeQuantumProposalViewer() {
      const overlay = document.querySelector('.proposal-viewer-overlay');
      if (overlay) overlay.remove();
    };

    // Archive filter functions
    window.changeQuantumArchiveFilter = function changeQuantumArchiveFilter() {
      const filter = document.getElementById('quantumArchiveFilter');
      window.currentArchiveFilter = filter.value;
      filterQuantumProposals();
    };

    // Refresh function
    window.refreshQuantumProposals = function refreshQuantumProposals() {
      window.allQuantumProposals = null;
      loadQuantumProposalsFromDrive();
    };

    // Archive toggle function with proper styling and error handling
    window.toggleQuantumProposalArchive = async function toggleQuantumProposalArchive(proposalId, currentStatus, event) {
      const newStatus = currentStatus === 'archived' ? 'active' : 'archived';
      const proposal = window.allQuantumProposals ? window.allQuantumProposals.find(p => p.id === proposalId) : null;
      const companyName = proposal ? proposal.companyName : '';
      
      // Show loading state with spinner
      const button = event.target;
      const originalText = button.innerHTML;
      button.disabled = true;
      button.innerHTML = '<span class="loading-spinner"></span>';
      
      try {
        // Make API call to update archive status
        const callbackName = 'archiveCallback_' + Date.now();
        const promise = new Promise((resolve, reject) => {
          window[callbackName] = (data) => { delete window[callbackName]; resolve(data); };
          setTimeout(() => { delete window[callbackName]; reject(new Error('Request timeout')); }, 10000);
        });

        const script = document.createElement('script');
        const params = new URLSearchParams({
          action: 'updateArchiveStatus',
          fileId: proposalId,
          status: newStatus,
          companyName: companyName,
          callback: callbackName
        });
        script.src = `https://script.google.com/macros/s/AKfycbxo7BkKNseerdgo0fBmIHkRcWF7XPt8EeuqRN_9hVgoqKVA1AxudQeStsdu_kyM7ADXHA/exec?${params.toString()}`;

        script.onerror = () => {
          delete window[callbackName];
          throw new Error('Failed to connect to archive service');
        };

        document.body.appendChild(script);
        const result = await promise;
        document.body.removeChild(script);

        if (result.status === 'success') {
          // Update the proposal in our local data
          if (window.allQuantumProposals && proposal) {
            proposal.status = newStatus;
            proposal.archivedDate = result.data.archivedDate;
          }
          
          // Refresh the display
          filterQuantumProposals();
          
          // Show success message
          showQuantumPopup(`
            <div class="success-popup">
              <h3>${newStatus === 'archived' ? 'Proposal Archived' : 'Proposal Restored'}</h3>
              <p>The proposal has been ${newStatus === 'archived' ? 'archived' : 'restored'} successfully!</p>
            </div>
          `, 'success');
        } else {
          throw new Error(result.message || 'Failed to update archive status');
        }
      } catch (error) {
        console.error('Archive toggle error:', error);
        showQuantumPopup(`
          <div class="error-popup">
            <h3>Archive Update Failed</h3>
            <p>Unable to ${newStatus === 'archived' ? 'archive' : 'restore'} the proposal: ${error.message}</p>
            <p>Please try again or contact support if the problem persists.</p>
          </div>
        `, 'error');
      } finally {
        // Restore button state
        button.disabled = false;
        button.innerHTML = originalText;
      }
    };

    window.loadQuantumProposalsFromDrive = async function loadQuantumProposalsFromDrive() {
      try {
        const callbackName = 'quantumProposalsCallback_' + Date.now();
        const promise = new Promise((resolve, reject) => {
          window[callbackName] = (data) => { delete window[callbackName]; resolve(data); };
          setTimeout(() => { delete window[callbackName]; reject(new Error('Request timeout')); }, 20000);
        });

        const script = document.createElement('script');
        const url = `https://script.google.com/macros/s/AKfycbxo7BkKNseerdgo0fBmIHkRcWF7XPt8EeuqRN_9hVgoqKVA1AxudQeStsdu_kyM7ADXHA/exec?action=getProposals&callback=${callbackName}`;
        script.src = url;

        script.onerror = () => {
          delete window[callbackName];
          const proposalsList = document.getElementById('quantumProposalsList');
          if (proposalsList) {
            proposalsList.innerHTML = `
              <div style="text-align:center;padding:40px;">
                <p style="color:#e53e3e;margin-bottom:20px;font-size:18px;">Unable to load proposals.</p>
                <button class="btn btn-primary" onclick="openQuantumProposalViewer()">Try Again</button>
              </div>`;
          }
        };

        document.body.appendChild(script);
        const data = await promise;
        document.body.removeChild(script);

        if (data.status === 'success') {
          const sortedProposals = (data.proposals || []).sort((a, b) => new Date(b.modifiedTime) - new Date(a.modifiedTime));
          
          // Add status field if not present (for backward compatibility)
          sortedProposals.forEach(proposal => {
            if (!proposal.status) {
              proposal.status = 'active';
            }
          });
          
          window.allQuantumProposals = sortedProposals;
          filterQuantumProposals();
        } else {
          throw new Error(data.message || 'Failed to load proposals');
        }
      } catch (error) {
        const proposalsList = document.getElementById('quantumProposalsList');
        if (proposalsList) {
          proposalsList.innerHTML = `
            <div style="text-align:center;padding:40px;">
              <p style="color:#e53e3e;margin-bottom:20px;font-size:18px;">Unable to load proposals.</p>
              <p style="color:#718096;margin-bottom:20px;">Error: ${error.message}</p>
              <button class="btn btn-primary" onclick="openQuantumProposalViewer()">Try Again</button>
            </div>`;
        }
      }
    }

    // Display function with proper Abbondanza-style styling
    function displayQuantumProposals(proposals) {
      const proposalsList = document.getElementById('quantumProposalsList');
      if (!proposalsList) return;
      
      if (proposals.length === 0) {
        const filterText = window.currentArchiveFilter === 'active' ? 'active' : 
                          window.currentArchiveFilter === 'archived' ? 'archived' : '';
        proposalsList.innerHTML = `<div style="text-align:center;padding:40px;color:#64748b;"><p>No ${filterText} proposals found in the library.</p></div>`;
        return;
      }
      
      proposalsList.innerHTML = proposals.map(proposal => {
        const isArchived = proposal.status === 'archived';
        const archiveButtonText = isArchived ? 'Restore' : 'Archive';
        const archivedBadge = isArchived ? '<span class="archived-badge">Archived</span>' : '';
        
        return `
          <div style="background: ${isArchived ? '#f8fafc' : 'white'}; padding: 25px; border-radius: 15px; border: 2px solid #e2e8f0; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.05); ${isArchived ? 'opacity: 0.7;' : ''}"
               onmouseover="this.style.borderColor='#1e3a8a'; this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.1)'"
               onmouseout="this.style.borderColor='#e2e8f0'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.05)'">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
              <div style="flex: 1; min-width: 200px;">
                <h4 style="margin: 0 0 8px 0; color: #2d3748; font-size: 18px; font-weight: 600;">${proposal.companyName}${archivedBadge}</h4>
                <p style="margin: 0; color: #718096; font-size: 14px; line-height: 1.4;">
                  Modified: ${proposal.modifiedTime ? new Date(proposal.modifiedTime).toLocaleDateString() : 'Unknown'}
                  ${isArchived && proposal.archivedDate ? `<br>Archived: ${new Date(proposal.archivedDate).toLocaleDateString()}` : ''}
                </p>
              </div>
              <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="viewQuantumProposalPDF('${proposal.id}', '${proposal.companyName}')" style="padding: 12px 24px; font-size: 14px; font-weight: 600; min-width: 90px;">View</button>
                <button class="btn btn-secondary" onclick="window.open('https://drive.google.com/uc?export=download&id=${proposal.id}', '_blank')" style="padding: 12px 24px; font-size: 14px; font-weight: 600; min-width: 100px;">Download</button>
                <button class="btn archive-btn" onclick="toggleQuantumProposalArchive('${proposal.id}', '${proposal.status || 'active'}', event)" style="padding: 12px 24px; font-size: 14px; font-weight: 600; min-width: 90px;">${archiveButtonText}</button>
              </div>
            </div>
          </div>`;
      }).join('');
    }

    window.filterQuantumProposals = function filterQuantumProposals() {
      const searchInput = document.getElementById('quantumProposalSearch');
      const term = (searchInput.value || '').toLowerCase();
      const proposalsList = document.getElementById('quantumProposalsList');
      const clearBtn = document.getElementById('clearQuantumSearchBtn');
      clearBtn.style.display = term.length > 0 ? 'block' : 'none';

      if (!window.allQuantumProposals || window.allQuantumProposals.length === 0) return;

      // Filter by archive status first
      let filteredByStatus = window.allQuantumProposals;
      if (window.currentArchiveFilter === 'active') {
        filteredByStatus = window.allQuantumProposals.filter(p => p.status !== 'archived');
      } else if (window.currentArchiveFilter === 'archived') {
        filteredByStatus = window.allQuantumProposals.filter(p => p.status === 'archived');
      }
      // 'all' shows everything, so no additional filtering needed

      // Then filter by search term
      let finalFiltered = filteredByStatus;
      if (term) {
        finalFiltered = filteredByStatus.filter(p =>
          p.companyName.toLowerCase().includes(term) || p.name.toLowerCase().includes(term)
        );
      }

      if (finalFiltered.length === 0 && term) {
        proposalsList.innerHTML = `
          <div style="text-align:center;padding:40px;color:#64748b;">
            <p style="font-size:18px;">No proposals found matching "<strong>${term}</strong>"</p>
            <p style="margin-top:10px;">Try searching for a different company name or adjusting the filter.</p>
          </div>`;
      } else {
        displayQuantumProposals(finalFiltered);
      }
    };

    window.viewQuantumProposalPDF = function viewQuantumProposalPDF(fileId, companyName) {
      closeQuantumProposalViewer();

      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.style.display = 'block';

      const pdfModal = document.createElement('div');
      pdfModal.className = 'modal';
      pdfModal.style.maxWidth = '1200px';
      pdfModal.style.height = '90vh';
      pdfModal.style.display = 'flex';
      pdfModal.style.flexDirection = 'column';

      const viewerUrl = `https://drive.google.com/file/d/${fileId}/preview?usp=embed`;

      pdfModal.innerHTML = `
        <div style="padding:20px;background:#f7fafc;border-radius:20px 20px 0 0;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #e2e8f0;">
          <h3 style="margin:0;color:#2d3748;font-size:1.3em;">Proposal for ${companyName}</h3>
          <div style="display:flex;gap:10px;align-items:center;">
            <button class="btn btn-primary" onclick="closeModal(); setTimeout(openQuantumProposalViewer, 200);" style="padding:10px 20px;">Back to Library</button>
            <button class="btn btn-secondary" onclick="window.open('https://drive.google.com/uc?export=download&id=${fileId}', '_blank')" style="padding:10px 20px;">Download</button>
          </div>
        </div>
        <div style="flex:1;padding:20px;overflow:hidden;">
          <iframe src="${viewerUrl}" width="100%" height="100%" style="border:none;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1);" allowfullscreen></iframe>
        </div>`;
      overlay.appendChild(pdfModal);
      document.body.appendChild(overlay);
    };

    // Close any generic overlay when clicking the backdrop
    document.addEventListener('click', function (event) {
      if (event.target.classList && event.target.classList.contains('modal-overlay')) {
        closeModal();
      }
    });
  </script>

  <!-- Reusable Username + Logout pill (shared across pages) -->
  <script defer src="userbar.js?v=1"></script>
  <script>
    // Ensure init runs after the deferred file has executed
    document.addEventListener('DOMContentLoaded', function () {
      if (window.UserBar && typeof UserBar.init === 'function') {
        UserBar.init({ redirectOnLogout: 'index.html', hideForGuests: true });
      } else {
        // Fallback if the file was slow: try again on window.load
        window.addEventListener('load', function () {
          if (window.UserBar && typeof UserBar.init === 'function') {
            UserBar.init({ redirectOnLogout: 'index.html', hideForGuests: true });
          }
        });
      }
    });
  </script>
</body>
</html>
