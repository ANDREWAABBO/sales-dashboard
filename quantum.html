<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quantum Solutions Sales Force</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Condensed:wght@400;600;700&display=swap" rel="stylesheet"/>
  
  <!-- Shared auth (login/register/reset) -->
  <script defer src="password.js"></script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
  
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #1e3a8a;
      min-height: 100vh;
      padding: 20px;
      color: #333;
      font-size: 18px;
    }
  
    /* Company Switcher */
    .company-switcher {
      display: flex;
      justify-content: center;
      gap: 20px;
      padding: 20px;
      position: sticky;
      top: 0;
      z-index: 1000;
      background: #000000;
      margin: -20px -20px 30px -20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    }
  
    .company-btn {
      padding: 12px 25px;
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.2);
      color: white;
      font-size: 18px;
      font-weight: 600;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 12px;
      backdrop-filter: blur(10px);
      text-decoration: none;
    }
  
    .company-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }
  
    .company-btn.active {
      background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
      border-color: transparent;
      box-shadow: 0 10px 30px rgba(59, 130, 246, 0.5),
                  0 0 60px rgba(59, 130, 246, 0.3);
      animation: glow 2s ease-in-out infinite alternate;
    }
  
    @keyframes glow {
      from { box-shadow: 0 10px 30px rgba(59, 130, 246, 0.5), 0 0 60px rgba(59, 130, 246, 0.3); }
      to   { box-shadow: 0 10px 40px rgba(59, 130, 246, 0.7), 0 0 80px rgba(59, 130, 246, 0.5); }
    }
  
    .company-logo { height: 35px; width: auto; filter: brightness(0) invert(1); transition: all 0.3s ease; }
    .abbondanza-logo { height: 40px; }
    .company-btn:hover .company-logo { transform: scale(1.05); }
  
    .dashboard-container { max-width: 1400px; margin: 0 auto; animation: fadeIn 0.8s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
  
    .header { text-align: center; margin-bottom: 35px; color: white; position: relative; }
    .header h1 {
      font-size: 3.2em; font-weight: 700; margin-bottom: 10px; color: white;
      font-family: 'IBM Plex Sans Condensed', 'Arial Narrow', sans-serif;
      letter-spacing: 2px; text-transform: uppercase;
      text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.5);
      animation: titleGlow 3s ease-in-out infinite alternate;
    }
    @keyframes titleGlow { from { filter: brightness(1); } to { filter: brightness(1.3); } }
    .header p { font-size: 1.3em; opacity: 0.9; }
  
    /* Quantum Grid - Vertical Stack */
    .quantum-grid { display: grid; grid-template-columns: 1fr; gap: 20px; max-width: 800px; margin: 0 auto; }
  
    .card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px; padding: 20px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.25);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative; overflow: hidden;
    }
    .card::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px;
      background: linear-gradient(90deg, #1e3a8a 0%, #1e40af 100%);
      transform: scaleX(0); transform-origin: left; transition: transform 0.3s ease;
    }
    .card:hover::before { transform: scaleX(1); }
    .card:hover { transform: translateY(-3px); box-shadow: 0 15px 45px rgba(0, 0, 0, 0.35); }
    .card h2 { font-size: 1.5em; margin-bottom: 10px; color: #2d3748; }
    .card p  { color: #718096; margin-bottom: 18px; line-height: 1.5; font-size: 1.1em; }
  
    .btn {
      display: inline-block; padding: 12px 26px; background: #1e3a8a; color: white;
      text-decoration: none; border-radius: 25px; font-weight: 600; transition: all 0.3s ease;
      position: relative; overflow: hidden; border: none; cursor: pointer; font-size: 1.05em;
    }
    .btn::after {
      content: ''; position: absolute; top: 50%; left: 50%; width: 0; height: 0;
      border-radius: 50%; background: rgba(255, 255, 255, 0.3);
      transform: translate(-50%, -50%); transition: width 0.6s, height 0.6s;
    }
    .btn:hover::after { width: 300px; height: 300px; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(30, 58, 138, 0.4); background: #1e40af; }
  
    /* Modal Styles */
    .modal-overlay {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.7); z-index: 10000; backdrop-filter: blur(5px);
    }
    .modal {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: white; border-radius: 20px; padding: 25px 35px; max-width: 900px; width: 95%;
      max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); z-index: 10001;
    }
    
    /* PDF Modal Styles */
    .pdf-modal {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: white; border-radius: 20px; width: 90%; height: 90%;
      max-width: 1200px; max-height: 90vh; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      z-index: 10001; display: flex; flex-direction: column;
    }
    .pdf-header {
      padding: 20px; background: #f7fafc; border-radius: 20px 20px 0 0;
      display: flex; justify-content: space-between; align-items: center;
      border-bottom: 1px solid #e2e8f0;
    }
    .pdf-header h3 { margin: 0; color: #2d3748; font-size: 1.3em; }
    .pdf-viewer { flex: 1; padding: 20px; overflow: hidden; }
    .pdf-viewer iframe {
      width: 100%; height: 100%; border: none; border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
  
    /* PROPOSAL MODAL - Different ID to prevent outside click close */
    #quantumProposalModal .modal-overlay {
      pointer-events: auto;
    }
  
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 5px; color: #4a5568; font-weight: 600; font-size: 1.05em; }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 1.05em; transition: border-color 0.3s ease;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #1e3a8a; }
    .form-group small { display: block; margin-top: 5px; color: #718096; font-size: 0.95em; }
  
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
  
    .pricing-summary { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 20px; border-radius: 15px; margin: 20px 0; border: 2px solid #1e3a8a; }
    .pricing-summary h4 { margin: 0 0 15px 0; color: #2d3748; font-size: 1.3em; text-align: center; }
  
    .modal-buttons { display: flex; gap: 15px; margin-top: 25px; }
    .btn-primary { background: #1e3a8a; flex: 2; }
    .btn-primary:hover { background: #1e40af; }
    .btn-secondary { background: #64748b; flex: 1; }
    .btn-secondary:hover { background: #475569; }
  
    .close-btn { background: #e53e3e; color: white; border: none; padding: 10px 22px; border-radius: 20px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; font-size: 1.05em; }
    .close-btn:hover { background: #c53030; transform: scale(1.05); }
  
    .success-popup { background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); border: 2px solid #28a745; color: #155724; padding: 20px; border-radius: 15px; text-align: center; font-size: 1.05em; }
    .error-popup   { background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%); border: 2px solid #dc3545; color: #721c24; padding: 20px; border-radius: 15px; text-align: center; font-size: 1.05em; }
  
    .loading-spinner {
      display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #1e3a8a;
      border-radius: 50%; animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Video Library Styles */
    .video-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .video-card {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .video-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    }

    .video-thumbnail {
  width: 100%;
  height: 180px;
  object-fit: cover;
  background: #e2e8f0;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #64748b;
  font-size: 48px;
}

    .video-info {
      padding: 15px;
    }

    .video-title {
      font-size: 16px;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 8px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .video-meta {
      font-size: 13px;
      color: #718096;
    }

    .video-actions {
      padding: 0 15px 15px;
      display: flex;
      gap: 8px;
    }

    .video-action-btn {
      flex: 1;
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .video-action-btn.primary {
      background: #1e3a8a;
      color: white;
    }

    .video-action-btn.primary:hover {
      background: #1e40af;
    }

    .video-action-btn.secondary {
      background: #e2e8f0;
      color: #4a5568;
    }

    .video-action-btn.secondary:hover {
      background: #cbd5e0;
    }

    .video-action-btn.danger {
      background: #fee;
      color: #c53030;
    }

    .video-action-btn.danger:hover {
      background: #fdd;
    }

    .video-player-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #000;
      border-radius: 12px;
      width: 90%;
      max-width: 1200px;
      max-height: 90vh;
      z-index: 10001;
      overflow: hidden;
    }

    .video-player-header {
      background: #1a1a1a;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: white;
    }

    .video-player-content {
      width: 100%;
      height: calc(90vh - 60px);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .video-player-content video {
      max-width: 100%;
      max-height: 100%;
    }

    .search-box {
      position: relative;
      margin-bottom: 20px;
    }

    .search-box input {
      width: 100%;
      padding: 12px 40px 12px 15px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 16px;
      transition: border-color 0.3s ease;
    }

    .search-box input:focus {
      outline: none;
      border-color: #1e3a8a;
    }

    .search-icon {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #718096;
    }

    .toggle-hidden-btn {
      padding: 10px 20px;
      background: #64748b;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 20px;
    }

    .toggle-hidden-btn:hover {
      background: #475569;
    }

    .toggle-hidden-btn.active {
      background: #1e3a8a;
    }

.category-tab {
  padding: 10px 20px;
  background: #e2e8f0;
  color: #4a5568;
  border: 2px solid transparent;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 14px;
}

.category-tab:hover {
  background: #cbd5e0;
}

.category-tab.active {
  background: #1e3a8a;
  color: white;
  border-color: #1e3a8a;
}


.category-dropdown {
  width: 200px;
  padding: 12px 15px;
  border: 2px solid #e2e8f0;
  border-radius: 10px;
  font-size: 16px;
  font-weight: 600;
  background: white;
  color: #4a5568;
  cursor: pointer;
  transition: border-color 0.3s ease;
}

.category-dropdown:focus {
  outline: none;
  border-color: #1e3a8a;
}

    
  </style>
</head>
  
<body>
  <!-- Company Switcher -->
  <div class="company-switcher">
    <a href="index.html" class="company-btn">
      <img src="images/abbondanza-logo.png" alt="Abbondanza" class="company-logo abbondanza-logo">
      <span>Abbondanza Vending LLC</span>
    </a>
    <button class="company-btn active" type="button">
      <img src="images/quantum-logo-transparent.png" alt="Quantum Solutions" class="company-logo">
      <span>Quantum Solutions</span>
    </button>
  </div>
  <div class="dashboard-container">
    <div class="header">
      <h1>Quantum Solutions Dashboard</h1>
      <p>Smart Food Fridge Solutions for Modern Businesses</p>
    </div>
  
    <!-- Quantum Solutions - 6 Cards Vertical Stack -->
    <div class="quantum-grid">
      <div class="card">
        <h2>How We Stack Up</h2>
        <p>Marketing materials and competitive analysis showing Quantum Solutions advantages over traditional vending.</p>
        <button onclick="openQuantumAboutUs()" class="btn" type="button">View Materials</button>
      </div>

      <!-- NEW: Video Library Card -->
      <div class="card">
        <h2>Video Library</h2>
        <p>Access training videos, product demos, and client presentations. Manage and organize video content.</p>
        <button onclick="openVideoLibrary()" class="btn" type="button">Open Video Library</button>
      </div>
  
      <div class="card">
        <h2>Proposal Management</h2>
        <p>Create and access Smart Food Fridge proposals with comprehensive pricing analysis and searchable library.</p>
        <div style="display:flex;gap:15px;margin-top:18px;">
          <button onclick="openQuantumProposalGenerator()" class="btn" style="flex:1;" type="button">Generate Proposal</button>
          <button onclick="openQuantumProposalViewer()" class="btn" style="flex:1;" type="button">View Library</button>
        </div>
      </div>

      <!-- Onboarding New Client Card -->
      <div class="card">
        <h2>Onboarding New Client</h2>
        <p>Complete new customer account setup forms and master service agreements for enterprise partnerships.</p>
        <div style="display:flex;gap:15px;margin-top:18px;">
          <button onclick="downloadNewCustomerForm()" class="btn" style="flex:1;" type="button">New Customer Account Form</button>
          <button onclick="openQuantumMasterAgreement()" class="btn" style="flex:1;" type="button">Master Services Agreement</button>
        </div>
      </div>
  
<div class="card">
  <h2>ROI Calculator</h2>
  <p>Interactive calculator to demonstrate cost savings and return on investment for potential clients.</p>
  <div style="display:flex;gap:15px;margin-top:18px;">
    <button onclick="openQuantumROICalculator()" class="btn" style="flex:1;" type="button">Open Calculator</button>
    <button onclick="openGuestUsageModal()" class="btn" style="flex:1;" type="button">View Guest Usage</button>
  </div>
</div>
  
      <div class="card">
        <h2>Lead Logger</h2>
        <p>Track and manage sales leads with company-specific categorization and comprehensive follow-up system.</p>
        <button onclick="openQuantumLeadLogger()" class="btn" type="button">Open Lead Logger</button>
      </div>
    </div>
  </div>


  <!-- Guest Usage Modal -->
<div id="guestUsageModal" class="modal-overlay">
  <div class="modal" style="max-width:900px;" onclick="event.stopPropagation()">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;padding-bottom:15px;border-bottom:2px solid #e2e8f0;">
      <h3 style="margin:0;color:#2d3748;font-size:1.8em;">ROI Calculator Guest Usage</h3>
      <button class="close-btn" onclick="closeGuestUsageModal()">‚úï</button>
    </div>
    <div style="display:flex;gap:15px;margin-bottom:20px;flex-wrap:wrap;align-items:center;">
      <select id="guestUsageFilter" class="archive-filter" style="min-width:180px;" onchange="filterGuestUsage()">
        <option value="active">Active Links</option>
        <option value="expired">Expired Links</option>
        <option value="revoked">Revoked Links</option>
        <option value="all">All Links</option>
      </select>
      <button class="btn refresh-btn" onclick="loadGuestUsage()" style="background:#10b981;padding:10px 20px;">üîÑ Refresh</button>
    </div>
    <div id="guestUsageList" style="display:grid;gap:15px;max-height:60vh;overflow-y:auto;">
      <div style="text-align:center;padding:40px;">
        <div class="loading-spinner"></div>
        <p style="margin-top:20px;color:#718096;">Loading guest usage data...</p>
      </div>
    </div>
  </div>
</div>

  
  <!-- Quantum Proposal Generator Modal -->
  <div id="quantumProposalModal" class="modal-overlay">
    <div class="modal" onclick="event.stopPropagation()">
      <h3>Generate Smart Food Fridge Proposal</h3>
  
      <div class="form-row">
        <div class="form-group">
          <label for="quantumCompanyName">Company Name *</label>
          <input type="text" id="quantumCompanyName" name="quantumCompanyName" required>
        </div>
        <div class="form-group">
          <label for="quantumContactName">Contact Name (Optional)</label>
          <input type="text" id="quantumContactName" name="quantumContactName" placeholder="Leave blank if unknown">
        </div>
      </div>
  
      <div class="form-row">
        <div class="form-group">
          <label for="customerAddress">Customer Address *</label>
          <input type="text" id="customerAddress" name="customerAddress" placeholder="City, State" required>
        </div>
        <div class="form-group">
          <label for="customerZip">Customer Zip Code *</label>
          <input type="text" id="customerZip" name="customerZip" pattern="[0-9]{5}" maxlength="5" placeholder="12345" required onchange="updateQuantumPricingSummary()">
          <small>Used for freight calculation</small>
        </div>
      </div>
  
      <div class="form-row">
        <div class="form-group">
          <label for="quantumPreparedBy">Your Name *</label>
          <input type="text" id="quantumPreparedBy" name="quantumPreparedBy" required>
        </div>
        <div class="form-group">
          <label for="quantumPreparedByPhone">Your Phone *</label>
          <input type="tel" id="quantumPreparedByPhone" name="quantumPreparedByPhone" required>
        </div>
      </div>
  
      <div class="form-group">
        <label for="quantumPreparedByEmail">Your Email *</label>
        <input type="email" id="quantumPreparedByEmail" name="quantumPreparedByEmail" required>
      </div>
  
      <div class="form-row">
        <div class="form-group">
          <label for="customerType">Customer Type *</label>
          <select id="customerType" name="customerType" required onchange="updateCustomerType()">
            <option value="new" selected>New Customer (includes scanner)</option>
            <option value="existing">Existing Customer (has scanner)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="quantumFridgeCount">Number of Fridges *</label>
          <input type="number" id="quantumFridgeCount" name="quantumFridgeCount" min="1" value="1" required onchange="updateQuantumPricingSummary()">
        </div>
      </div>
  
      <div class="form-group">
        <label for="scannerCount">RFID Scanners Needed *</label>
        <select id="scannerCount" name="scannerCount" required onchange="updateQuantumPricingSummary()">
          <option value="0">0 scanners</option>
          <option value="1" selected>1 scanner</option>
          <option value="2">2 scanners</option>
          <option value="3">3 scanners</option>
          <option value="4">4 scanners</option>
          <option value="5">5 scanners</option>
          <option value="6">6 scanners</option>
          <option value="7">7 scanners</option>
          <option value="8">8 scanners</option>
          <option value="9">9 scanners</option>
          <option value="10">10 scanners</option>
          <option value="11">11 scanners</option>
          <option value="12">12 scanners</option>
          <option value="13">13 scanners</option>
          <option value="14">14 scanners</option>
          <option value="15">15 scanners</option>
        </select>
        <small>New customers typically need 1 scanner per location. Additional scanners for backup or multiple sites.</small>
      </div>
  
      <div class="form-row">
        <div class="form-group">
          <label for="rfidRolls">RFID Tag Rolls (1,000 tags per roll) *</label>
          <input type="number" id="rfidRolls" name="rfidRolls" min="0" max="50" value="5" required onchange="updateQuantumPricingSummary()">
          <small>Recommended starting quantity: 5 rolls. $0.18 per tag ($180 per roll).</small>
        </div>
        <div class="form-group">
          <label for="shippingPerUnit">Shipping Cost Per Fridge *</label>
          <input type="number" id="shippingPerUnit" name="shippingPerUnit" min="0" step="0.01" value="600" required onchange="updateQuantumPricingSummary()">
          <small>Enter shipping cost per fridge (e.g., $600). Total shipping = cost per fridge √ó number of fridges.</small>
        </div>
      </div>
  
      <div class="form-row">
        <div class="form-group">
          <label for="shippingMethod">Shipping Method *</label>
          <select id="shippingMethod" name="shippingMethod" required>
            <option value="">Loading shipping methods...</option>
          </select>
          <small>Select the shipping method for detailed terms and conditions.</small>
        </div>
        <div class="form-group">
          <label for="countryOfOrigin">Country of Origin *</label>
          <select id="countryOfOrigin" name="countryOfOrigin" required>
            <option value="">Loading countries...</option>
          </select>
          <small>Select country of origin for specific shipping notices and requirements.</small>
        </div>
      </div>
  
      <div class="pricing-summary">
        <h4>Proposal Summary</h4>
        <div id="quantumPricingSummary"></div>
      </div>
  
      <div class="modal-buttons">
        <button class="btn btn-secondary" onclick="closeQuantumModal('quantumProposalModal')" style="flex:1;background:#64748b;" type="button">Cancel</button>
        <button class="btn btn-primary" id="generateQuantumBtn" type="button" onclick="generateQuantumProposal()">Generate Proposal PDF</button>
      </div>
    </div>
  </div>
  <!-- App script: expose handlers on window so inline on* can find them -->
  <script>
    // Video Library Configuration
    const VIDEO_LIBRARY_URL = 'https://script.google.com/macros/s/AKfycbxFS2mSdcK0SSF4qFPRKF_jUVqnVkSBW4btCLCbVyy_3MWo4SR4cJ-CNURGf4xRPk3a/exec';


    // ROI Calculator Guest Usage
const ROI_CALCULATOR_URL = 'https://script.google.com/macros/s/AKfycbyliQpOEuz0QMKWMtHW7Cjlhqf2qEmLNTXI4TDY8THVPbKXzyqkIJ5dbIsHtb8JegHc_Q/exec';
window.allGuestTokens = [];

window.openGuestUsageModal = function openGuestUsageModal() {
  const modal = document.getElementById('guestUsageModal');
  if (modal) {
    modal.style.display = 'block';
    loadGuestUsage();
  }
};

window.closeGuestUsageModal = function closeGuestUsageModal() {
  const modal = document.getElementById('guestUsageModal');
  if (modal) modal.style.display = 'none';
};

window.loadGuestUsage = function loadGuestUsage() {
  const listContainer = document.getElementById('guestUsageList');
  if (listContainer) {
    listContainer.innerHTML = 
      '<div style="text-align:center;padding:40px;">' +
        '<div class="loading-spinner"></div>' +
        '<p style="margin-top:20px;color:#718096;">Loading guest usage data...</p>' +
      '</div>';
  }

  fetch(ROI_CALCULATOR_URL + '?action=listTokens&onlyActive=false&maxRows=50')
    .then(function(response) { return response.json(); })
    .then(function(data) {
      if (data.status === 'success') {
        window.allGuestTokens = data.data.tokens || [];
        filterGuestUsage();
      } else {
        throw new Error(data.message || 'Failed to load tokens');
      }
    })
    .catch(function(error) {
      if (listContainer) {
        listContainer.innerHTML = 
          '<div style="text-align:center;padding:40px;">' +
            '<p style="color:#e53e3e;margin-bottom:20px;font-size:18px;">Unable to load guest usage data</p>' +
            '<p style="color:#718096;margin-bottom:20px;">Error: ' + error.message + '</p>' +
            '<button class="btn btn-primary" onclick="loadGuestUsage()">Try Again</button>' +
          '</div>';
      }
    });
};

window.filterGuestUsage = function filterGuestUsage() {
  const filter = document.getElementById('guestUsageFilter').value;
  const now = new Date();
  
  let filtered = window.allGuestTokens.filter(function(token) {
    const isExpired = token.expiresAt && new Date(token.expiresAt) < now;
    const isRevoked = !token.active;
    const isActive = token.active && !isExpired;
    
    if (filter === 'active') return isActive;
    if (filter === 'expired') return isExpired && token.active;
    if (filter === 'revoked') return isRevoked;
    return true;
  });
  
  displayGuestUsage(filtered);
};

window.displayGuestUsage = function displayGuestUsage(tokens) {
  const listContainer = document.getElementById('guestUsageList');
  if (!listContainer) return;
  
  if (tokens.length === 0) {
    listContainer.innerHTML = 
      '<div style="text-align:center;padding:40px;color:#718096;">' +
        '<p style="font-size:18px;">No links found matching this filter.</p>' +
      '</div>';
    return;
  }
  
  const now = new Date();
  
  listContainer.innerHTML = tokens.map(function(token) {
    const isExpired = token.expiresAt && new Date(token.expiresAt) < now;
    const isRevoked = !token.active;
    const isActive = token.active && !isExpired;
    
    let statusBadge, statusColor;
    if (isRevoked) {
      statusBadge = 'Revoked';
      statusColor = 'background:#fee2e2;color:#b91c1c;';
    } else if (isExpired) {
      statusBadge = 'Expired';
      statusColor = 'background:#fef3c7;color:#92400e;';
    } else {
      statusBadge = 'Active';
      statusColor = 'background:#d1fae5;color:#065f46;';
    }
    
    const daysRemaining = isActive && token.expiresAt 
      ? Math.ceil((new Date(token.expiresAt) - now) / (1000 * 60 * 60 * 24))
      : 0;
    
    const expiresText = isActive 
      ? daysRemaining + ' day' + (daysRemaining !== 1 ? 's' : '') + ' remaining'
      : (token.expiresAt ? new Date(token.expiresAt).toLocaleDateString() : 'N/A');
    
    const revokeButton = isActive 
      ? '<button class="btn" onclick="revokeGuestToken(\'' + token.token + '\', \'' + (token.clientName || 'Guest').replace(/'/g, "\\'") + '\')" style="padding:10px 20px;background:#e53e3e;font-size:14px;">Revoke</button>'
      : '';
    
    return (
      '<div style="background:white;padding:20px;border-radius:12px;border:2px solid #e2e8f0;transition:all .3s ease;">' +
        '<div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:15px;">' +
          '<div style="flex:1;min-width:200px;">' +
            '<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">' +
              '<h4 style="margin:0;color:#2d3748;font-size:16px;">' + (token.clientName || '(No client name)') + '</h4>' +
              '<span style="' + statusColor + 'padding:4px 10px;border-radius:12px;font-size:12px;font-weight:600;">' + statusBadge + '</span>' +
            '</div>' +
            '<div style="color:#718096;font-size:13px;line-height:1.6;">' +
              '<div>Created: ' + (token.createdDate ? new Date(token.createdDate).toLocaleDateString() : 'N/A') + ' by ' + (token.createdBy || 'Unknown') + '</div>' +
              '<div>Expires: ' + expiresText + '</div>' +
              '<div>Last Accessed: ' + (token.lastAccessed ? new Date(token.lastAccessed).toLocaleString() : 'Never') + '</div>' +
              '<div>Access Count: ' + (token.accessCount || 0) + '</div>' +
            '</div>' +
          '</div>' +
          '<div style="display:flex;gap:10px;align-items:center;">' +
            '<button class="btn btn-secondary" onclick="copyGuestLink(\'' + token.shareUrl + '\')" style="padding:10px 20px;font-size:14px;">üìã Copy Link</button>' +
            revokeButton +
          '</div>' +
        '</div>' +
      '</div>'
    );
  }).join('');
};

window.copyGuestLink = function copyGuestLink(url) {
  navigator.clipboard.writeText(url).then(function() {
    showQuantumPopup('<div class="success-popup"><p>‚úÖ Link copied to clipboard!</p></div>', 'success');
  }).catch(function() {
    showQuantumPopup('<div class="error-popup"><p>‚ùå Failed to copy link</p></div>', 'error');
  });
};

window.revokeGuestToken = function revokeGuestToken(token, clientName) {
  const confirmOverlay = document.createElement('div');
  confirmOverlay.className = 'modal-overlay';
  confirmOverlay.style.display = 'block';
  confirmOverlay.style.zIndex = '20000';

  confirmOverlay.innerHTML = 
    '<div class="modal" style="max-width:500px;" onclick="event.stopPropagation()">' +
      '<h3 style="margin-bottom:20px;color:#2d3748;">Revoke Guest Link?</h3>' +
      '<p style="color:#4a5568;margin-bottom:10px;line-height:1.6;">Are you sure you want to revoke access for:</p>' +
      '<p style="color:#1e3a8a;font-weight:600;margin-bottom:20px;font-size:1.1em;">' + clientName + '</p>' +
      '<p style="color:#718096;margin-bottom:25px;font-size:0.95em;">This will immediately block access to the ROI calculator for this link.</p>' +
      '<div style="display:flex;gap:15px;margin-top:25px;">' +
        '<button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()" style="flex:1;">Cancel</button>' +
        '<button class="btn" onclick="confirmRevokeToken(\'' + token + '\'); this.closest(\'.modal-overlay\').remove();" style="flex:1;background:#e53e3e;">üö´ Revoke Access</button>' +
      '</div>' +
    '</div>';
  
  document.body.appendChild(confirmOverlay);
};

window.confirmRevokeToken = function confirmRevokeToken(token) {
  const listContainer = document.getElementById('guestUsageList');
  if (listContainer) {
    listContainer.innerHTML = 
      '<div style="text-align:center;padding:40px;">' +
        '<div class="loading-spinner"></div>' +
        '<p style="margin-top:20px;color:#718096;">Revoking access...</p>' +
      '</div>';
  }

  fetch(ROI_CALCULATOR_URL + '?action=deactivateToken&token=' + encodeURIComponent(token))
    .then(function(response) { return response.json(); })
    .then(function(data) {
      if (data.status === 'success') {
        showQuantumPopup('<div class="success-popup"><h3>‚úÖ Access Revoked</h3><p>The guest link has been deactivated.</p></div>', 'success');
        loadGuestUsage();
      } else {
        throw new Error(data.message || 'Failed to revoke token');
      }
    })
    .catch(function(error) {
      showQuantumPopup('<div class="error-popup"><h3>‚ùå Revoke Failed</h3><p>' + error.message + '</p></div>', 'error');
      loadGuestUsage();
    });
};


/* ====== URL Parameter Pre-fill (Lead Logger Integration) ====== */
    (function() {
      function initPrefill() {
        var urlParams = new URLSearchParams(window.location.search);
        
        // Check if we have URL parameters (coming from lead logger)
        if (urlParams.toString()) {
          console.log('URL Parameters detected:', urlParams.toString());
          
          // Store parameters in variables BEFORE clearing URL
          var leadData = {
            companyName: urlParams.get('companyName'),
            contactName: urlParams.get('contactName'),
            customerAddress: urlParams.get('customerAddress'),
            customerZip: urlParams.get('customerZip'),
            preparedBy: urlParams.get('preparedBy'),
            preparedByPhone: urlParams.get('preparedByPhone'),
            preparedByEmail: urlParams.get('preparedByEmail')
          };
          
          console.log('Stored lead data:', leadData);
          
          // Clear URL parameters immediately
          window.history.replaceState({}, document.title, window.location.pathname);
          
          // Step 1: Open proposal form directly (skip warning initially)
          if (typeof proceedToProposalGenerator === 'function') {
            console.log('Opening proposal form directly...');
            proceedToProposalGenerator();
            
            // Step 2: Wait for form to appear, then pre-fill
            setTimeout(function() {
              console.log('Attempting to fill form fields...');
              
              var companyField = document.getElementById('quantumCompanyName');
              if (companyField && leadData.companyName) {
                companyField.value = leadData.companyName;
                console.log('Set company name:', leadData.companyName);
              }
              
              var contactNameField = document.getElementById('quantumContactName');
              if (contactNameField && leadData.contactName) {
                contactNameField.value = leadData.contactName;
                console.log('Set contact name:', leadData.contactName);
              }
              
              var addressField = document.getElementById('customerAddress');
              if (addressField && leadData.customerAddress) {
                addressField.value = leadData.customerAddress;
                console.log('Set address:', leadData.customerAddress);
              }
              
              var zipField = document.getElementById('customerZip');
              if (zipField && leadData.customerZip) {
                zipField.value = leadData.customerZip;
                console.log('Set zip:', leadData.customerZip);
              }
              
              var preparedByField = document.getElementById('quantumPreparedBy');
              if (preparedByField && leadData.preparedBy) {
                preparedByField.value = leadData.preparedBy;
                console.log('Set prepared by:', leadData.preparedBy);
              }
              
              var phoneField = document.getElementById('quantumPreparedByPhone');
              if (phoneField && leadData.preparedByPhone) {
                phoneField.value = leadData.preparedByPhone;
                console.log('Set phone:', leadData.preparedByPhone);
              }
              
              var emailField = document.getElementById('quantumPreparedByEmail');
              if (emailField && leadData.preparedByEmail) {
                emailField.value = leadData.preparedByEmail;
                console.log('Set email:', leadData.preparedByEmail);
              }
              
              console.log('Form fill complete!');
              
              // Step 3: NOW show the warning modal AFTER form is filled
              setTimeout(function() {
                if (typeof openQuantumProposalGenerator === 'function') {
                  console.log('Now showing warning modal...');
                  openQuantumProposalGenerator();
                }
              }, 500);
            }, 500);
          }
        }
      }
      
      // Run immediately if page already loaded, otherwise wait for DOMContentLoaded
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initPrefill);
      } else {
        initPrefill();
      }
    })();
    

    // NEW: View Quantum Material in PDF Modal - DEFINE FIRST
    window.viewQuantumMaterialPDF = function viewQuantumMaterialPDF(fileId, title, fileType) {
      const materialsOverlay = document.querySelector('.modal-overlay');
      if (materialsOverlay) materialsOverlay.remove();
      
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.style.display = 'block';
  
      const pdfModal = document.createElement('div');
      pdfModal.className = 'pdf-modal';
      
      let viewerUrl, downloadUrl;
      if (fileType === 'slides') {
        viewerUrl = 'https://docs.google.com/presentation/d/' + fileId + '/preview';
        downloadUrl = 'https://docs.google.com/presentation/d/' + fileId + '/export/pdf';
      } else if (fileType === 'sheets') {
        const pdfExportUrl = 'https://docs.google.com/spreadsheets/d/' + fileId + '/export?format=pdf&portrait=true&fitw=true&gridlines=true';
        viewerUrl = 'https://docs.google.com/viewer?url=' + encodeURIComponent(pdfExportUrl) + '&embedded=true';
        downloadUrl = pdfExportUrl;
      } else if (fileType === 'docs') {
        viewerUrl = 'https://docs.google.com/document/d/' + fileId + '/preview';
        downloadUrl = 'https://docs.google.com/document/d/' + fileId + '/export?format=pdf';
      } else if (fileType === 'pdf') {
        viewerUrl = 'https://drive.google.com/file/d/' + fileId + '/preview';
        downloadUrl = 'https://drive.google.com/uc?export=download&id=' + fileId;
      } else {
        viewerUrl = 'https://drive.google.com/file/d/' + fileId + '/preview';
        downloadUrl = 'https://drive.google.com/uc?export=download&id=' + fileId;
      }
  
      pdfModal.innerHTML = 
        '<div class="pdf-header">' +
          '<h3>' + title + '</h3>' +
          '<div style="display:flex;gap:10px;align-items:center;">' +
            '<button class="btn btn-primary" onclick="closePDFViewer(); setTimeout(openQuantumAboutUs, 200);" style="padding:10px 20px;">‚Üê Back to Materials</button>' +
            '<button class="btn btn-secondary" onclick="window.open(\'' + downloadUrl + '\',\'_blank\')" style="padding:10px 20px;">üì• Download</button>' +
            '<button class="close-btn" onclick="closePDFViewer()">‚úï</button>' +
          '</div>' +
        '</div>' +
        '<div class="pdf-viewer">' +
          '<iframe src="' + viewerUrl + '" width="100%" height="100%" allowfullscreen></iframe>' +
        '</div>';
      
      overlay.appendChild(pdfModal);
      document.body.appendChild(overlay);
    };

    function downloadNewCustomerForm() {
      const existingOverlay = document.querySelector('.modal-overlay');
      if (existingOverlay) existingOverlay.remove();
      
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.style.display = 'block';
  
      const modal = document.createElement('div');
      modal.className = 'pdf-modal';
  
      const docId = '1LGvkY0K9_ZlQwaCfWRbLUFDXefQUfBKeytXmz3X8-Kc';
      const pdfUrl = 'https://docs.google.com/document/d/' + docId + '/export?format=pdf';
      const viewerUrl = 'https://docs.google.com/document/d/' + docId + '/preview';
  
      modal.innerHTML = 
        '<div class="pdf-header">' +
          '<h3>New Customer Account Setup Form</h3>' +
          '<div style="display:flex;gap:10px;align-items:center;">' +
            '<button class="btn btn-secondary" onclick="window.open(\'' + pdfUrl + '\',\'_blank\')" style="padding:10px 20px;">üì• Download PDF</button>' +
            '<button class="close-btn" onclick="closePDFViewer()">‚úï</button>' +
          '</div>' +
        '</div>' +
        '<div class="pdf-viewer">' +
          '<iframe src="' + viewerUrl + '" width="100%" height="100%" allowfullscreen></iframe>' +
        '</div>';
      
      overlay.appendChild(modal);
      document.body.appendChild(overlay);
    }
    window.downloadNewCustomerForm = downloadNewCustomerForm;

    window.openQuantumAboutUs = function openQuantumAboutUs() {
      const existingOverlay = document.querySelector('.modal-overlay');
      if (existingOverlay) existingOverlay.remove();
  
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.style.display = 'block';
  
      const modal = document.createElement('div');
      modal.className = 'modal';
  
      const materials = [
        { title: 'Restaurant Industry Trends Report', id: '1MejzxfsJ7VHR9OzwYuO7iEWUdDPrcLzO', description: 'Current market trends and insights for the restaurant industry', type: 'pdf' },
        { title: 'Maximizing Revenue Per Square Foot in Food Service Operations', id: '1hTRsDlrx0MRzmdVrqrOyfqg5-Gj-6RQC', description: 'Strategies to optimize space utilization and increase profitability', type: 'pdf' },
        { title: 'Fresh Food Fridge Spec Sheet', id: '1RO1IXd032eCKM4z4gr09QSouIyGXA8R74PSXj5afIas', description: 'Technical specifications and features of our Smart Food Fridge', type: 'slides' },
        { title: 'Food Fridge Executive Overview', id: '1YFa7vPZC89YE4OM5wW5LTGwF5WD3lZAE', description: 'High-level overview and business benefits for decision makers', type: 'pdf' },
        { title: 'Commercial Real Estate Premium Food Amenities', id: '1eUfU0i5WD9KEg46biTguBCyQef_OxBi0', description: 'How premium food amenities enhance commercial property value', type: 'pdf' },
        { title: 'Smart RFID Refrigerated Fresh Food Fridge Technical Deep Dive and FAQ', id: '1zmo7_EccscAMQ-10q5yFF9k9vFdXHe3c', description: 'Comprehensive technical documentation and frequently asked questions', type: 'pdf' },
        { title: 'Food Fridge Presentation Slide Deck With Proposal Example', id: '19hC90aDJgAQCiNOPACjzhxEdFoE2iaUMpfirP3kAgzs', description: 'Robust presentation with how to use videos and proposal', type: 'slides' }
      ];
  
      const cards = materials.map(function(m) {
        var downloadUrl;
        if (m.type === 'slides') { 
          downloadUrl = 'https://docs.google.com/presentation/d/' + m.id + '/export/pdf'; 
        }
        else if (m.type === 'docs') { 
          downloadUrl = 'https://docs.google.com/document/d/' + m.id + '/export?format=pdf'; 
        }
        else if (m.type === 'sheets') { 
          downloadUrl = 'https://docs.google.com/spreadsheets/d/' + m.id + '/export?format=pdf'; 
        }
        else { 
          downloadUrl = 'https://drive.google.com/uc?export=download&id=' + m.id; 
        }
        return (
          '<div style="background:#f8fafc;padding:25px;border-radius:15px;border:2px solid #e2e8f0;transition:all .3s ease;">' +
            '<div style="margin-bottom:20px;">' +
              '<h4 style="margin:0 0 10px 0;color:#1e3a8a;font-size:1.2em;font-weight:600;">' + m.title + '</h4>' +
              '<p style="margin:0;color:#64748b;font-size:.95em;line-height:1.5;">' + m.description + '</p>' +
            '</div>' +
            '<div style="display:flex;gap:15px;flex-wrap:wrap;">' +
              '<button class="btn btn-primary" onclick="viewQuantumMaterialPDF(\'' + m.id + '\', \'' + m.title.replace(/'/g, "\\'") + '\', \'' + m.type + '\')" style="padding:12px 24px;font-size:.9em;min-width:120px;font-weight:600;">üëÅÔ∏è View PDF</button>' +
              '<button class="btn btn-secondary" onclick="window.open(\'' + downloadUrl + '\',\'_blank\')" style="padding:12px 24px;font-size:.9em;min-width:120px;font-weight:600;">üì• Download</button>' +
            '</div>' +
          '</div>'
        );
      }).join('');
  
      modal.innerHTML =
        '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;padding-bottom:15px;border-bottom:2px solid #e2e8f0;">' +
          '<h3 style="margin:0;color:#2d3748;font-size:1.8em;">How We Stack Up - Marketing Materials</h3>' +
          '<button class="close-btn" onclick="closeModal()">‚úï</button>' +
        '</div>' +
        '<div style="display:grid;gap:20px;">' + cards + '</div>';
  
      overlay.appendChild(modal);
      document.body.appendChild(overlay);
    };
  
    window.closeModal = function closeModal() {
      const overlay = document.querySelector('.modal-overlay');
      if (overlay) overlay.remove();
    };
    
    window.closePDFViewer = function closePDFViewer() {
      document.querySelectorAll('.modal-overlay').forEach(ov => {
        if (ov && ov.querySelector('.pdf-modal')) ov.remove();
      });
    };
    // NEW: Video Library Functions
    window.openVideoLibrary = function openVideoLibrary() {
  const existingOverlay = document.querySelector('.video-library-overlay');
  if (existingOverlay) existingOverlay.remove();

  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay video-library-overlay';
  overlay.style.display = 'block';

  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.style.maxWidth = '1200px';

  modal.innerHTML = 
    '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;padding-bottom:15px;border-bottom:2px solid #e2e8f0;">' +
      '<h3 id="videoLibraryTitle" style="margin:0;color:#2d3748;font-size:1.8em;">Video Library</h3>' +
      '<button class="close-btn" onclick="closeVideoLibrary()">‚úï</button>' +
    '</div>' +
    '<div class="search-box">' +
      '<input type="text" id="videoSearch" placeholder="Search videos..." oninput="filterVideos()">' +
      '<span class="search-icon">üîç</span>' +
    '</div>' +
    '<div id="categoryTabs" style="display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap;"></div>' +
    '<button id="toggleHiddenBtn" class="toggle-hidden-btn" onclick="toggleHiddenVideos()">üì¶ Show Hidden Videos</button>' +
    '<div id="videoLibraryContent" style="min-height:300px;">' +
      '<div style="text-align:center;padding:40px;">' +
        '<div class="loading-spinner"></div>' +
        '<p style="margin-top:20px;color:#718096;">Loading videos...</p>' +
      '</div>' +
    '</div>';

  overlay.appendChild(modal);
  document.body.appendChild(overlay);

  window.allVideos = [];
  window.allCategories = [];
  window.selectedCategory = 'All';
  window.showHiddenVideos = false;
  loadVideos();
};

    window.closeVideoLibrary = function closeVideoLibrary() {
      const overlay = document.querySelector('.video-library-overlay');
      if (overlay) overlay.remove();
    };

   function loadVideos() {
  fetch(VIDEO_LIBRARY_URL + '?action=getVideos')
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        window.allVideos = data.videos;
        window.allCategories = data.categories || [];
        renderCategoryTabs();
        displayVideos(data.videos);
      } else {
        throw new Error(data.message || 'Failed to load videos');
      }
    })
    .catch(error => {
      const content = document.getElementById('videoLibraryContent');
      if (content) {
        content.innerHTML = 
          '<div style="text-align:center;padding:40px;">' +
            '<p style="color:#e53e3e;margin-bottom:20px;font-size:18px;">Unable to load videos</p>' +
            '<p style="color:#718096;margin-bottom:20px;">Error: ' + error.message + '</p>' +
            '<button class="btn btn-primary" onclick="loadVideos()">Try Again</button>' +
          '</div>';
      }
    });
}

    function renderCategoryTabs() {
  const tabsContainer = document.getElementById('categoryTabs');
  if (!tabsContainer) return;

  let options = '<option value="All"' + (window.selectedCategory === 'All' ? ' selected' : '') + '>All Videos</option>';
  
  window.allCategories.forEach(function(category) {
    const selected = window.selectedCategory === category ? ' selected' : '';
    options += '<option value="' + category + '"' + selected + '>' + category + '</option>';
  });

  tabsContainer.innerHTML = '<select class="category-dropdown" onchange="selectCategory(this.value)">' + options + '</select>';
}


    window.selectCategory = function selectCategory(category) {
  window.selectedCategory = category;
  renderCategoryTabs();
  filterVideos();
};

    function displayVideos(videos) {
  const content = document.getElementById('videoLibraryContent');
  if (!content) return;

  const filtered = videos.filter(v => {
    if (window.showHiddenVideos) {
      return v.status === 'hidden';
    } else {
      return v.status === 'active';
    }
  });

  if (filtered.length === 0) {
    const emptyMessage = window.showHiddenVideos 
      ? 'No hidden videos found.' 
      : 'No active videos found.';
    content.innerHTML = 
      '<div style="text-align:center;padding:40px;color:#718096;">' +
        '<p style="font-size:18px;">' + emptyMessage + '</p>' +
      '</div>';
    return;
  }

  const videoCards = filtered.map(video => {
    const isHidden = video.status === 'hidden';
    const actionButton = isHidden
      ? '<button class="video-action-btn primary" onclick="unhideVideo(\'' + video.id + '\', \'' + video.name.replace(/'/g, "\\'") + '\')">üëÅÔ∏è Show</button>'
      : '<button class="video-action-btn danger" onclick="hideVideo(\'' + video.id + '\', \'' + video.name.replace(/'/g, "\\'") + '\')">üö´ Hide</button>';

    const categoryBadge = video.category && video.category !== 'Hidden' 
      ? '<div style="background:#dbeafe;color:#1e3a8a;padding:4px 8px;border-radius:4px;font-size:11px;font-weight:600;margin-top:8px;display:inline-block;">' + video.category + '</div>'
      : '';

    return (
      '<div class="video-card" data-video-name="' + video.name.toLowerCase() + '">' +
        '<div class="video-thumbnail">' +
          '<img src="' + video.thumbnailUrl + '" alt="' + video.name + '" style="width:100%;height:100%;object-fit:cover;" onerror="this.style.display=\'none\'; this.parentElement.innerHTML=\'üé¨\'; this.parentElement.style.display=\'flex\'; this.parentElement.style.alignItems=\'center\'; this.parentElement.style.justifyContent=\'center\'; this.parentElement.style.fontSize=\'48px\'; this.parentElement.style.color=\'#64748b\';">' +
        '</div>' +
        '<div class="video-info">' +
          '<div class="video-title" title="' + video.name + '">' + video.name + '</div>' +
          '<div class="video-meta">' + formatFileSize(video.size) + '</div>' +
          categoryBadge +
        '</div>' +
        '<div class="video-actions">' +
          '<button class="video-action-btn primary" onclick="playVideo(\'' + video.id + '\', \'' + video.name.replace(/'/g, "\\'") + '\')">‚ñ∂Ô∏è Play</button>' +
          actionButton +
        '</div>' +
      '</div>'
    );
  }).join('');

  content.innerHTML = '<div class="video-grid">' + videoCards + '</div>';
}

    window.toggleHiddenVideos = function toggleHiddenVideos() {
      window.showHiddenVideos = !window.showHiddenVideos;
      
      const toggleBtn = document.getElementById('toggleHiddenBtn');
      const title = document.getElementById('videoLibraryTitle');
      
      if (window.showHiddenVideos) {
        toggleBtn.textContent = 'üìã Show Active Videos';
        toggleBtn.classList.add('active');
        title.textContent = 'Hidden Videos';
      } else {
        toggleBtn.textContent = 'üì¶ Show Hidden Videos';
        toggleBtn.classList.remove('active');
        title.textContent = 'Video Library';
      }
      
      filterVideos();
    };

    window.filterVideos = function filterVideos() {
  const searchInput = document.getElementById('videoSearch');
  const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
  
  if (!window.allVideos) return;
  
  let filtered = window.allVideos.filter(v => {
    // Filter by hidden/active status
    if (window.showHiddenVideos) {
      if (v.status !== 'hidden') return false;
    } else {
      if (v.status !== 'active') return false;
    }
    
    // Filter by category
    if (window.selectedCategory !== 'All' && v.category !== window.selectedCategory) {
      return false;
    }
    
    // Filter by search term
    if (searchTerm && !v.name.toLowerCase().includes(searchTerm)) {
      return false;
    }
    
    return true;
  });
  
  displayVideos(filtered);
};

    window.playVideo = function playVideo(fileId, fileName) {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay video-player-overlay';
      overlay.style.display = 'block';
      overlay.style.zIndex = '20000';

      const playerModal = document.createElement('div');
      playerModal.className = 'video-player-modal';

      const videoUrl = 'https://drive.google.com/file/d/' + fileId + '/preview';

      playerModal.innerHTML = 
        '<div class="video-player-header">' +
          '<h3 style="margin:0;font-size:1.2em;">' + fileName + '</h3>' +
          '<div style="display:flex;gap:10px;">' +
            '<button class="btn btn-secondary" onclick="window.open(\'https://drive.google.com/uc?export=download&id=' + fileId + '\', \'_blank\')" style="padding:8px 16px;">üì• Download</button>' +
            '<button class="close-btn" onclick="closeVideoPlayer()">‚úï</button>' +
          '</div>' +
        '</div>' +
        '<div class="video-player-content">' +
          '<iframe src="' + videoUrl + '" width="100%" height="100%" frameborder="0" allowfullscreen allow="autoplay"></iframe>' +
        '</div>';

      overlay.appendChild(playerModal);
      document.body.appendChild(overlay);
    };

    window.closeVideoPlayer = function closeVideoPlayer() {
      const overlay = document.querySelector('.video-player-overlay');
      if (overlay) overlay.remove();
    };

    window.hideVideo = function hideVideo(fileId, fileName) {
  // Create custom confirmation modal
  const confirmOverlay = document.createElement('div');
  confirmOverlay.className = 'modal-overlay';
  confirmOverlay.style.display = 'block';
  confirmOverlay.style.zIndex = '30000';

  confirmOverlay.innerHTML = 
    '<div class="modal" style="max-width:500px;">' +
      '<h3 style="margin-bottom:20px;color:#2d3748;">Hide Video?</h3>' +
      '<p style="color:#4a5568;margin-bottom:10px;line-height:1.6;">Are you sure you want to hide:</p>' +
      '<p style="color:#1e3a8a;font-weight:600;margin-bottom:20px;font-size:1.1em;">' + fileName + '</p>' +
      '<p style="color:#718096;margin-bottom:25px;font-size:0.95em;">This will move it to the Hidden folder.</p>' +
      '<div style="display:flex;gap:15px;margin-top:25px;">' +
        '<button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()" style="flex:1;">Cancel</button>' +
        '<button class="btn" onclick="confirmHideVideo(\'' + fileId + '\', \'' + fileName.replace(/'/g, "\\'") + '\'); this.closest(\'.modal-overlay\').remove();" style="flex:1;background:#e53e3e;">üö´ Hide Video</button>' +
      '</div>' +
    '</div>';
  
  document.body.appendChild(confirmOverlay);
};

function confirmHideVideo(fileId, fileName) {
  const content = document.getElementById('videoLibraryContent');
  if (content) {
    content.innerHTML = 
      '<div style="text-align:center;padding:40px;">' +
        '<div class="loading-spinner"></div>' +
        '<p style="margin-top:20px;color:#718096;">Hiding video...</p>' +
      '</div>';
  }

  fetch(VIDEO_LIBRARY_URL + '?action=hideVideo&fileId=' + encodeURIComponent(fileId) + '&fileName=' + encodeURIComponent(fileName))
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        loadVideos();
        showVideoPopup('‚úÖ Video hidden successfully', 'success');
      } else {
        throw new Error(data.message || 'Failed to hide video');
      }
    })
    .catch(error => {
      showVideoPopup('‚ùå Error: ' + error.message, 'error');
      loadVideos();
    });
}


    window.unhideVideo = function unhideVideo(fileId, fileName) {
  // Create custom confirmation modal with category dropdown
  const confirmOverlay = document.createElement('div');
  confirmOverlay.className = 'modal-overlay';
  confirmOverlay.style.display = 'block';
  confirmOverlay.style.zIndex = '30000';

  // Build category options
  let categoryOptions = '';
  window.allCategories.forEach(function(category) {
    categoryOptions += '<option value="' + category + '">' + category + '</option>';
  });

  confirmOverlay.innerHTML = 
    '<div class="modal" style="max-width:500px;">' +
      '<h3 style="margin-bottom:20px;color:#2d3748;">Restore Video?</h3>' +
      '<p style="color:#4a5568;margin-bottom:10px;line-height:1.6;">Restore to which category:</p>' +
      '<p style="color:#1e3a8a;font-weight:600;margin-bottom:20px;font-size:1.1em;">' + fileName + '</p>' +
      '<div style="margin-bottom:25px;">' +
        '<label style="display:block;margin-bottom:8px;color:#4a5568;font-weight:600;">Select Category:</label>' +
        '<select id="restoreCategory" class="category-dropdown" style="width:100%;">' +
          categoryOptions +
        '</select>' +
      '</div>' +
      '<div style="display:flex;gap:15px;margin-top:25px;">' +
        '<button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()" style="flex:1;">Cancel</button>' +
        '<button class="btn" onclick="confirmUnhideVideo(\'' + fileId + '\', \'' + fileName.replace(/'/g, "\\'") + '\'); this.closest(\'.modal-overlay\').remove();" style="flex:1;background:#10b981;">üëÅÔ∏è Restore Video</button>' +
      '</div>' +
    '</div>';
  
  document.body.appendChild(confirmOverlay);
};


function confirmUnhideVideo(fileId, fileName) {
  const categorySelect = document.getElementById('restoreCategory');
  const targetCategory = categorySelect ? categorySelect.value : '';

  const content = document.getElementById('videoLibraryContent');
  if (content) {
    content.innerHTML = 
      '<div style="text-align:center;padding:40px;">' +
        '<div class="loading-spinner"></div>' +
        '<p style="margin-top:20px;color:#718096;">Restoring video...</p>' +
      '</div>';
  }

  fetch(VIDEO_LIBRARY_URL + '?action=unhideVideo&fileId=' + encodeURIComponent(fileId) + '&fileName=' + encodeURIComponent(fileName) + '&targetCategory=' + encodeURIComponent(targetCategory))
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        loadVideos();
        showVideoPopup('‚úÖ Video restored to ' + targetCategory, 'success');
      } else {
        throw new Error(data.message || 'Failed to restore video');
      }
    })
    .catch(error => {
      showVideoPopup('‚ùå Error: ' + error.message, 'error');
      loadVideos();
    });
}

    function showVideoPopup(message, type) {
      const popup = document.createElement('div');
      popup.className = 'modal-overlay';
      popup.style.zIndex = '30000';
      popup.innerHTML = 
        '<div class="modal" style="max-width:400px;">' +
          '<div class="' + (type === 'success' ? 'success-popup' : 'error-popup') + '">' +
            '<p style="margin:0;font-size:16px;">' + message + '</p>' +
          '</div>' +
          '<div style="margin-top:20px;text-align:center;">' +
            '<button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Close</button>' +
          '</div>' +
        '</div>';
      popup.style.display = 'block';
      document.body.appendChild(popup);

      if (type === 'success') {
        setTimeout(() => {
          if (popup.parentNode) popup.remove();
        }, 3000);
      }
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }
    window.openQuantumProposalGenerator = function openQuantumProposalGenerator() {
      const warningOverlay = document.createElement('div');
      warningOverlay.className = 'modal-overlay';
      warningOverlay.style.display = 'block';
      warningOverlay.style.zIndex = '10000';

      warningOverlay.innerHTML = 
        '<div class="modal" style="max-width:700px;" onclick="event.stopPropagation()">' +
          '<div style="text-align:center;margin-bottom:25px;">' +
            '<div style="display:inline-block;width:80px;height:80px;background:#ef4444;border-radius:50%;display:flex;align-items:center;justify-content:center;margin-bottom:15px;">' +
              '<span style="color:white;font-size:48px;font-weight:bold;">‚õî</span>' +
            '</div>' +
            '<h3 style="margin:0;color:#dc2626;font-size:2em;font-weight:700;">STOP</h3>' +
            '<p style="color:#991b1b;font-size:1.2em;font-weight:600;margin-top:10px;">Before a proposal is made</p>' +
          '</div>' +
          '<div style="background:#fef2f2;border:2px solid #fecaca;border-radius:12px;padding:25px;margin-bottom:25px;">' +
            '<div style="margin-bottom:25px;">' +
              '<h4 style="color:#dc2626;margin:0 0 12px 0;font-size:1.15em;display:flex;align-items:center;gap:10px;">' +
                '<span style="background:#dc2626;color:white;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:bold;">1</span>' +
                'Did we contact Ken Piers (pronounced PIE-reese) @ REDYREF for a shipping quote?' +
              '</h4>' +
              '<div style="background:white;border:1px solid #fecaca;border-radius:8px;padding:15px;margin-top:15px;">' +
                '<p style="color:#7f1d1d;font-weight:600;margin:0 0 10px 0;font-size:1.05em;">üìù Notes on Shipping:</p>' +
                '<ul style="margin:0;padding-left:20px;color:#991b1b;line-height:1.7;">' +
                  '<li style="margin-bottom:10px;"><strong>Customer carrier option:</strong> Customer can choose their own carrier but must sign a damage waiver. Our shipping is covered with insurance. Claims are processed quickly (typically 30 days) when using our carrier. If client uses their own carrier, damage claims could take up to 1 year to resolve, if at all.</li>' +
                  '<li><strong>Quote flexibility:</strong> Shipping quote may change up or down the day it is shipped. Example: if item ships 10 weeks from order date, shipping might change and the difference will be invoiced or credited by REDYREF.</li>' +
                '</ul>' +
              '</div>' +
            '</div>' +
            '<div>' +
              '<h4 style="color:#dc2626;margin:0 0 12px 0;font-size:1.15em;display:flex;align-items:center;gap:10px;">' +
                '<span style="background:#dc2626;color:white;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:bold;">2</span>' +
                'Is the client financing?' +
              '</h4>' +
              '<div style="background:white;border:1px solid #fecaca;border-radius:8px;padding:15px;">' +
                '<p style="margin:0;color:#991b1b;line-height:1.7;"><strong>If NO:</strong> We need a <strong style="color:#dc2626;">50% deposit</strong> on the order with signature</p>' +
              '</div>' +
            '</div>' +
          '</div>' +
          '<div style="display:flex;gap:15px;margin-top:25px;">' +
            '<button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()" style="flex:1;font-size:1.05em;padding:14px;">‚ùå Cancel</button>' +
            '<button class="btn btn-primary" onclick="proceedToProposalGenerator()" style="flex:1;font-size:1.05em;padding:14px;background:#dc2626;border:none;">‚úÖ I Understand - Continue</button>' +
          '</div>' +
        '</div>';
      
      document.body.appendChild(warningOverlay);
    };
    
  window.proceedToProposalGenerator = function proceedToProposalGenerator() {
  console.log('proceedToProposalGenerator called!');
  
  const allOverlays = document.querySelectorAll('.modal-overlay');
  console.log('Found overlays:', allOverlays.length);
  
  allOverlays.forEach(function(overlay) {
    if (overlay.id !== 'quantumProposalModal') {
      console.log('Removing overlay:', overlay);
      overlay.remove();
    }
  });
  
  setTimeout(function() {
    const modalOverlay = document.getElementById('quantumProposalModal');
    console.log('Modal overlay element:', modalOverlay);
    if (modalOverlay) {
      modalOverlay.style.display = 'block';
      console.log('Set display to block');
      updateQuantumPricingSummary();
      loadDropdownOptions();
    } else {
      console.log('ERROR: Could not find quantumProposalModal');
    }
  }, 200);
};
  
    function loadDropdownOptions() {
      const shippingMethodSelect = document.getElementById('shippingMethod');
      const countrySelect = document.getElementById('countryOfOrigin');
      shippingMethodSelect.innerHTML = '<option value="">Loading shipping methods...</option>';
      countrySelect.innerHTML = '<option value="">Loading countries...</option>';
      try {
        const callbackName = 'dropdownCallback_' + Date.now();
        const promise = new Promise(function(resolve, reject) {
          window[callbackName] = function(data) { 
            delete window[callbackName]; 
            resolve(data); 
          };
          setTimeout(function() { 
            delete window[callbackName]; 
            reject(new Error('Request timeout')); 
          }, 10000);
        });
  
        const script = document.createElement('script');
        const QUANTUM_PROPOSAL_URL = 'https://script.google.com/macros/s/AKfycbxo7BkKNseerdgo0fBmIHkRcWF7XPt8EeuqRN_9hVgoqKVA1AxudQeStsdu_kyM7ADXHA/exec';
        const url = QUANTUM_PROPOSAL_URL + '?action=getDropdownOptions&callback=' + callbackName;
        script.src = url;
        script.onerror = function() {
          delete window[callbackName];
          populateDropdownsWithDefaults();
        };
  
        document.body.appendChild(script);
        promise.then(function(data) {
          document.body.removeChild(script);
          if (data.status === 'success') {
            populateDropdowns(data.shippingMethods, data.countries);
          } else {
            console.warn('Failed to load dropdown options:', data.message);
            populateDropdownsWithDefaults();
          }
        }).catch(function(error) {
          console.warn('Error loading dropdown options:', error.message);
          populateDropdownsWithDefaults();
        });
      } catch (error) {
        console.warn('Error setting up dropdown loading:', error.message);
        populateDropdownsWithDefaults();
      }
    }
  
    function populateDropdowns(shippingMethods, countries) {
      const shippingMethodSelect = document.getElementById('shippingMethod');
      const countrySelect = document.getElementById('countryOfOrigin');
      shippingMethodSelect.innerHTML = '<option value="">Select shipping method...</option>';
      countrySelect.innerHTML = '<option value="">Select country...</option>';
      if (shippingMethods && shippingMethods.length > 0) {
        shippingMethods.forEach(function(method) {
          const option = document.createElement('option');
          option.value = method;
          option.textContent = method;
          shippingMethodSelect.appendChild(option);
        });
        const standardLTL = shippingMethods.find(function(method) {
          return method === 'Standard LTL';
        });
        shippingMethodSelect.value = standardLTL || shippingMethods[0];
      }
      if (countries && countries.length > 0) {
        countries.forEach(function(country) {
          const option = document.createElement('option');
          option.value = country;
          option.textContent = country;
          countrySelect.appendChild(option);
        });
        const canadaCA = countries.find(function(country) {
          return country === 'Canada CA';
        });
        countrySelect.value = canadaCA || countries[0];
      }
      console.log('Dropdown options loaded successfully');
    }
  
    function populateDropdownsWithDefaults() {
      const defaultShippingMethods = ['Standard LTL', 'White Glove Standard LTL'];
      const defaultCountries = ['Canada CA', 'United States'];
      populateDropdowns(defaultShippingMethods, defaultCountries);
      console.log('Using default dropdown options');
    }
  
    window.closeQuantumModal = function closeQuantumModal(id) {
      const m = document.getElementById(id);
      if (m) m.style.display = 'none';
    };
  
    window.updateCustomerType = function updateCustomerType() {
      const customerType = document.getElementById('customerType').value;
      const scannerCount = document.getElementById('scannerCount');
      scannerCount.value = (customerType === 'new') ? 1 : 0;
      updateQuantumPricingSummary();
    };
  
    function calculateFreight() {
      const fridgeCount = parseInt(document.getElementById('quantumFridgeCount').value) || 1;
      const customerZip = document.getElementById('customerZip').value;
  
      var baseFreight;
      if (fridgeCount === 1) baseFreight = 895;
      else if (fridgeCount === 2) baseFreight = 1400;
      else if (fridgeCount === 3) baseFreight = 1800;
      else baseFreight = fridgeCount * 550;
  
      var distanceMultiplier = 1.0;
      if (customerZip) {
        const zipCode = parseInt(customerZip);
        if (zipCode >= 20000 && zipCode <= 39999) distanceMultiplier = 1.2;
        else if (zipCode >= 40000) distanceMultiplier = 1.5;
      }
      return Math.round(baseFreight * distanceMultiplier);
    }
  
    window.updateQuantumPricingSummary = function updateQuantumPricingSummary() {
      const fridgeCount = parseInt(document.getElementById('quantumFridgeCount').value) || 1;
      const scannerCount = parseInt(document.getElementById('scannerCount').value) || 0;
      const rfidRolls = parseInt(document.getElementById('rfidRolls').value) || 0;
      const shippingPerUnit = parseFloat(document.getElementById('shippingPerUnit').value) || 0;
      const vinylWrap = false;
      const goldSupport = false;
  
      const fridgePrice = 7500;
      const scannerPrice = 455;
      const rfidRollPrice = 180;
      const wrapPrice = fridgeCount === 1 ? 645 : (fridgeCount * 547.50);
      const shipping = shippingPerUnit * fridgeCount;
  
      const fridgeTotal = fridgeCount * fridgePrice;
      const scannerTotal = scannerCount * scannerPrice;
      const rfidTotal = rfidRolls * rfidRollPrice;
      const wrapTotal = vinylWrap ? wrapPrice : 0;
  
      const oneTimeTotal = fridgeTotal + scannerTotal + rfidTotal + wrapTotal + shipping;
  
      const monthlyLicense = fridgeCount * 175;
      const monthlyLTE = fridgeCount * 25;
      const monthlyGold = goldSupport ? (fridgeCount * 39) : 0;
      const monthlyTotal = monthlyLicense + monthlyLTE + monthlyGold;
  
      var html = '<div style="margin-bottom:15px;">' +
        '<h4 style="color:#1e3a8a;margin-bottom:10px;">One-Time Costs</h4>' +
        '<div>Food Fridges (' + fridgeCount + '): $' + fridgeTotal.toLocaleString() + '</div>';
      if (scannerCount > 0) html += '<div>RFID Scanners (' + scannerCount + '): $' + scannerTotal.toLocaleString() + '</div>';
      if (rfidRolls > 0) html += '<div>RFID Tags (' + rfidRolls + ' rolls): $' + rfidTotal.toLocaleString() + '</div>';
      if (vinylWrap) html += '<div>Vinyl Wrap: $' + wrapTotal.toLocaleString() + '</div>';
      html += '<div>Shipping (' + fridgeCount + ' √ó $' + shippingPerUnit + '): $' + shipping.toLocaleString() + '</div>' +
        '<div style="font-weight:bold;color:#1e3a8a;margin-top:10px;padding-top:10px;border-top:1px solid #e2e8f0;">' +
          'One-Time Total: $' + oneTimeTotal.toLocaleString() +
        '</div>' +
        '</div>' +
        '<div>' +
          '<h4 style="color:#1e3a8a;margin-bottom:10px;">Monthly Recurring</h4>' +
          '<div>License Fees: $' + monthlyLicense.toLocaleString() + '/month</div>' +
          '<div>LTE Service: $' + monthlyLTE.toLocaleString() + '/month</div>';
      if (goldSupport) html += '<div>Gold Support: $' + monthlyGold.toLocaleString() + '/month</div>';
      html += '<div style="font-weight:bold;color:#1e3a8a;margin-top:10px;padding-top:10px;border-top:1px solid #e2e8f0;">' +
          'Monthly Total: $' + monthlyTotal.toLocaleString() + '/month' +
        '</div>' +
        '</div>';
      document.getElementById('quantumPricingSummary').innerHTML = html;
    };
  
    window.generateQuantumProposal = function generateQuantumProposal(event) {
      if (event) { event.preventDefault(); event.stopPropagation(); }
      const submitBtn = document.getElementById('generateQuantumBtn');
      const originalText = submitBtn.innerHTML;
      if (submitBtn.disabled) return;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="loading-spinner"></span> Generating...';
  
      try {
        const formData = {
          companyName: document.getElementById('quantumCompanyName').value,
          contactName: document.getElementById('quantumContactName').value || '',
          customerAddress: document.getElementById('customerAddress').value,
          customerZip: document.getElementById('customerZip').value,
          preparedBy: document.getElementById('quantumPreparedBy').value,
          preparedByPhone: document.getElementById('quantumPreparedByPhone').value,
          preparedByEmail: document.getElementById('quantumPreparedByEmail').value,
          customerType: document.getElementById('customerType').value,
          fridgeCount: document.getElementById('quantumFridgeCount').value,
          scannerCount: document.getElementById('scannerCount').value,
          rfidRolls: document.getElementById('rfidRolls').value || '0',
          shippingPerUnit: document.getElementById('shippingPerUnit').value || '0',
          shippingMethod: document.getElementById('shippingMethod').value,
          countryOfOrigin: document.getElementById('countryOfOrigin').value,
          vinylWrap: 'No',
          goldSupport: 'No'
        };
        if (!formData.companyName || !formData.preparedBy || !formData.preparedByPhone || !formData.preparedByEmail) {
          throw new Error('Please fill in all required fields.');
        }
  
        const QUANTUM_PROPOSAL_URL = 'https://script.google.com/macros/s/AKfycbxo7BkKNseerdgo0fBmIHkRcWF7XPt8EeuqRN_9hVgoqKVA1AxudQeStsdu_kyM7ADXHA/exec';
        const params = new URLSearchParams();
        Object.keys(formData).forEach(function(key) {
          params.append(key, formData[key]);
        });
  
        fetch(QUANTUM_PROPOSAL_URL + '?' + params.toString())
        .then(function(response) { return response.json(); })
        .then(function(result) {
          if (result.status === 'success') {
            closeQuantumModal('quantumProposalModal');
            showQuantumPopup(
              '<div class="success-popup">' +
                '<h3>‚úÖ Proposal Generated Successfully</h3>' +
                '<p>Your Smart Food Fridge proposal has been created and saved to Library.</p>' +
                '<p><strong>Company:</strong> ' + formData.companyName + '</p>' +
                '<p><strong>Configuration:</strong> ' + formData.fridgeCount + ' fridges, ' + formData.scannerCount + ' scanners</p>' +
                '<p><strong>Total Cost:</strong> $' + result.data.pricing.oneTimeTotal.toLocaleString() + ' one-time + $' + result.data.pricing.monthlyTotal + '/month</p>' +
                '<div style="margin-top:20px;display:flex;gap:10px;justify-content:center;">' +
                  '<button class="btn btn-primary" onclick="window.open(\'' + result.pdfUrl + '\', \'_blank\')" style="padding:12px 24px;">üìÑ View PDF</button>' +
                  '<button class="btn btn-secondary" onclick="window.open(\'' + result.pdfUrl.replace('/view?', '/export?format=pdf&') + '\', \'_blank\')" style="padding:12px 24px;">üì• Download</button>' +
                '</div>' +
              '</div>',
              'success'
            );
          } else {
            throw new Error(result.message || 'Failed to generate proposal');
          }
        })
        .catch(function(error) {
          showQuantumPopup(
            '<div class="error-popup">' +
              '<h3>‚ùå Error Generating Proposal</h3>' +
              '<p>' + error.message + '</p>' +
              '<p>Please try again or contact support if the problem persists.</p>' +
            '</div>',
            'error'
          );
        })
        .finally(function() {
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
        });
      } catch (error) {
        showQuantumPopup(
          '<div class="error-popup">' +
            '<h3>‚ùå Error Generating Proposal</h3>' +
            '<p>' + error.message + '</p>' +
            '<p>Please try again or contact support if the problem persists.</p>' +
          '</div>',
          'error'
        );
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
      }
    };
  
    window.showQuantumPopup = function showQuantumPopup(content, type) {
      const popup = document.createElement('div');
      popup.className = 'modal-overlay';
      popup.innerHTML = 
        '<div class="modal" style="max-width:600px;">' +
          content +
          '<div style="margin-top:20px;text-align:center;">' +
            '<button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Close</button>' +
          '</div>' +
        '</div>';
      popup.style.display = 'block';
      document.body.appendChild(popup);
      if (type === 'success') {
        setTimeout(function() { 
          if (popup.parentNode) popup.remove(); 
        }, 15000);
      }
    };
  
    window.openQuantumMasterAgreement = function openQuantumMasterAgreement() {
      const existingOverlay = document.querySelector('.modal-overlay');
      if (existingOverlay) existingOverlay.remove();
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.style.display = 'block';
  
      const modal = document.createElement('div');
      modal.className = 'pdf-modal';
  
      const docId = '1ChcyX_PUlX48AhzAkNtsDWduamgQHomYSYM9LVwd3FA';
      const pdfUrl = 'https://docs.google.com/document/d/' + docId + '/export?format=pdf';
      const viewerUrl = 'https://docs.google.com/document/d/' + docId + '/preview';
  
      modal.innerHTML = 
        '<div class="pdf-header">' +
          '<h3>Master Services Agreement (Food Fridge)</h3>' +
          '<div style="display:flex;gap:10px;align-items:center;">' +
            '<button class="btn btn-secondary" onclick="window.open(\'' + pdfUrl + '\',\'_blank\')" style="padding:10px 20px;">üì• Download PDF</button>' +
            '<button class="close-btn" onclick="closePDFViewer()">‚úï</button>' +
          '</div>' +
        '</div>' +
        '<div class="pdf-viewer">' +
          '<iframe src="' + viewerUrl + '" width="100%" height="100%" allowfullscreen></iframe>' +
        '</div>';
      overlay.appendChild(modal);
      document.body.appendChild(overlay);
    };
  
    window.openQuantumROICalculator = function openQuantumROICalculator() {
      const existing = document.querySelector('.modal-overlay.roi-overlay');
      if (existing) existing.remove();
  
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay roi-overlay';
      overlay.style.display = 'block';
  
      const modal = document.createElement('div');
      modal.className = 'pdf-modal';
  
      const src = 'roi-calculator.html?v=' + Date.now();
      modal.innerHTML = 
        '<div class="pdf-header">' +
          '<h3>ROI Calculator</h3>' +
          '<button class="close-btn" onclick="document.querySelector(\'.roi-overlay\').remove()">‚úï</button>' +
        '</div>' +
        '<div class="pdf-viewer">' +
          '<iframe src="' + src + '" width="100%" height="100%" allowfullscreen></iframe>' +
        '</div>';
      overlay.appendChild(modal);
      document.body.appendChild(overlay);
    };
  
    window.openQuantumLeadLogger = function openQuantumLeadLogger() {
      window.location.href = 'lead-logger.html';
    };
  
    window.openQuantumProposalViewer = function openQuantumProposalViewer() {
      const existingOverlay = document.querySelector('.proposal-viewer-overlay');
      if (existingOverlay) existingOverlay.remove();
  
      window.allQuantumProposals = null;
      window.showArchivedProposals = false;
  
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay proposal-viewer-overlay';
      overlay.style.display = 'block';
  
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.maxWidth = '1000px';
  
      modal.innerHTML = 
        '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;padding-bottom:15px;border-bottom:2px solid #e2e8f0;">' +
          '<h3 id="libraryTitle" style="margin:0;color:#2d3748;font-size:1.8em;">Quantum Proposal Library</h3>' +
          '<button class="close-btn" onclick="closeQuantumProposalViewer()">‚úï</button>' +
        '</div>' +
        '<div style="margin-bottom:20px;display:flex;gap:10px;">' +
          '<div style="flex:1;position:relative;">' +
            '<input type="text" id="quantumProposalSearch" placeholder="Search by company name..." style="width:100%;padding:15px 45px 15px 15px;font-size:16px;border:2px solid #e2e8f0;border-radius:10px;transition:all .3s ease;" onkeyup="filterQuantumProposals()" onfocus="this.style.borderColor=\'#1e3a8a\'" onblur="this.style.borderColor=\'#e2e8f0\'">' +
            '<button id="clearQuantumSearchBtn" onclick="document.getElementById(\'quantumProposalSearch\').value=\'\'; this.style.display=\'none\'; filterQuantumProposals();" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);background:#e2e8f0;border:none;border-radius:50%;width:30px;height:30px;cursor:pointer;display:none;transition:all .3s ease;font-size:18px;color:#4a5568;">√ó</button>' +
          '</div>' +
          '<button id="toggleArchiveBtn" class="btn" onclick="toggleArchiveView()" style="padding:15px 25px;white-space:nowrap;background:#64748b;">üì¶ Show Archive</button>' +
        '</div>' +
        '<div id="quantumProposalsList" style="display:grid;gap:15px;max-height:60vh;overflow-y:auto;">' +
          '<div style="text-align:center;padding:40px;">' +
            '<div class="loading-spinner"></div>' +
            '<p style="margin-top:20px;color:#718096;">Loading proposals from library...</p>' +
          '</div>' +
        '</div>';
      overlay.appendChild(modal);
      document.body.appendChild(overlay);
      setTimeout(function() { loadQuantumProposalsFromDrive(); }, 100);
    };

    window.toggleArchiveView = function toggleArchiveView() {
      window.showArchivedProposals = !window.showArchivedProposals;
      
      const toggleBtn = document.getElementById('toggleArchiveBtn');
      const libraryTitle = document.getElementById('libraryTitle');
      
      if (window.showArchivedProposals) {
        toggleBtn.textContent = 'üìã Show Active';
        toggleBtn.style.background = '#1e3a8a';
        libraryTitle.textContent = 'Archived Proposals';
      } else {
        toggleBtn.textContent = 'üì¶ Show Archive';
        toggleBtn.style.background = '#64748b';
        libraryTitle.textContent = 'Quantum Proposal Library';
      }
      
      filterQuantumProposals();
    };
  
    window.closeQuantumProposalViewer = function closeQuantumProposalViewer() {
      const overlay = document.querySelector('.proposal-viewer-overlay');
      if (overlay) overlay.remove();
    };
  
    function loadQuantumProposalsFromDrive() {
      try {
        const callbackName = 'quantumProposalsCallback_' + Date.now();
        const promise = new Promise(function(resolve, reject) {
          window[callbackName] = function(data) { delete window[callbackName]; resolve(data); };
          setTimeout(function() { delete window[callbackName]; reject(new Error('Request timeout')); }, 20000);
        });
  
        const script = document.createElement('script');
        const url = 'https://script.google.com/macros/s/AKfycbxo7BkKNseerdgo0fBmIHkRcWF7XPt8EeuqRN_9hVgoqKVA1AxudQeStsdu_kyM7ADXHA/exec?action=getProposals&callback=' + callbackName;
        script.src = url;
  
        script.onerror = function() {
          delete window[callbackName];
          const proposalsList = document.getElementById('quantumProposalsList');
          if (proposalsList) {
            proposalsList.innerHTML = 
              '<div style="text-align:center;padding:40px;">' +
                '<p style="color:#e53e3e;margin-bottom:20px;font-size:18px;">Unable to load proposals.</p>' +
                '<button class="btn btn-primary" onclick="openQuantumProposalViewer()">Try Again</button>' +
              '</div>';
          }
        };
  
        document.body.appendChild(script);
        promise.then(function(data) {
          document.body.removeChild(script);
          if (data.status === 'success') {
            const sortedProposals = (data.proposals || []).sort(function(a, b) { 
              return new Date(b.modifiedTime) - new Date(a.modifiedTime); 
            });
            window.allQuantumProposals = sortedProposals;
            displayQuantumProposals(sortedProposals);
          } else {
            throw new Error(data.message || 'Failed to load proposals');
          }
        }).catch(function(error) {
          const proposalsList = document.getElementById('quantumProposalsList');
          if (proposalsList) {
            proposalsList.innerHTML = 
              '<div style="text-align:center;padding:40px;">' +
                '<p style="color:#e53e3e;margin-bottom:20px;font-size:18px;">Unable to load proposals.</p>' +
                '<p style="color:#718096;margin-bottom:20px;">Error: ' + error.message + '</p>' +
                '<button class="btn btn-primary" onclick="openQuantumProposalViewer()">Try Again</button>' +
              '</div>';
          }
        });
      } catch (error) {
        const proposalsList = document.getElementById('quantumProposalsList');
        if (proposalsList) {
          proposalsList.innerHTML = 
            '<div style="text-align:center;padding:40px;">' +
              '<p style="color:#e53e3e;margin-bottom:20px;font-size:18px;">Unable to load proposals.</p>' +
              '<p style="color:#718096;margin-bottom:20px;">Error: ' + error.message + '</p>' +
              '<button class="btn btn-primary" onclick="openQuantumProposalViewer()">Try Again</button>' +
            '</div>';
        }
      }
    }
  
    function displayQuantumProposals(proposals) {
      const proposalsList = document.getElementById('quantumProposalsList');
      if (!proposalsList) return;
      
      const filtered = proposals.filter(function(p) {
        if (window.showArchivedProposals) {
          return p.status === 'archived';
        } else {
          return p.status !== 'archived';
        }
      });
      
      if (filtered.length === 0) {
        const emptyMessage = window.showArchivedProposals 
          ? 'No archived proposals found.' 
          : 'No active proposals found in the library.';
        proposalsList.innerHTML = '<div style="text-align:center;padding:40px;color:#718096;"><p>' + emptyMessage + '</p></div>';
        return;
      }
      
      proposalsList.innerHTML = filtered.map(function(proposal) {
        const isArchived = proposal.status === 'archived';
        const archiveButtonHtml = isArchived 
          ? '<button class="btn" onclick="unarchiveQuantumProposal(\'' + proposal.id + '\', \'' + proposal.companyName.replace(/'/g, "\\'") + '\')" style="padding:14px 28px;font-size:16px;font-weight:600;min-width:120px;background:#10b981;">‚ôªÔ∏è Restore</button>'
          : '<button class="btn" onclick="archiveQuantumProposal(\'' + proposal.id + '\', \'' + proposal.companyName.replace(/'/g, "\\'") + '\')" style="padding:14px 28px;font-size:16px;font-weight:600;min-width:120px;background:#f59e0b;">üì¶ Archive</button>';
        
        return (
          '<div class="proposal-item" style="background:white;padding:25px;border-radius:15px;border:2px solid #e2e8f0;transition:all .3s ease;box-shadow:0 2px 8px rgba(0,0,0,0.05);" onmouseover="this.style.borderColor=\'#1e3a8a\'; this.style.transform=\'translateY(-3px)\'; this.style.boxShadow=\'0 8px 20px rgba(0,0,0,0.1)\'" onmouseout="this.style.borderColor=\'#e2e8f0\'; this.style.transform=\'translateY(0)\'; this.style.boxShadow=\'0 2px 8px rgba(0,0,0,0.05)\'">' +
            '<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:15px;">' +
              '<div style="flex:1;min-width:200px;">' +
                '<h4 style="margin:0 0 8px 0;color:#2d3748;font-size:18px;">' + proposal.companyName + '</h4>' +
                '<p style="margin:0;color:#718096;font-size:14px;">' +
                  proposal.name + '<br>' +
                  'Modified: ' + (proposal.modifiedTime ? new Date(proposal.modifiedTime).toLocaleDateString() : 'Unknown') +
                  (isArchived && proposal.archivedDate ? '<br>Archived: ' + new Date(proposal.archivedDate).toLocaleDateString() : '') +
                '</p>' +
              '</div>' +
              '<div style="display:flex;gap:12px;flex-wrap:wrap;">' +
                '<button class="btn btn-primary" onclick="viewQuantumProposalPDF(\'' + proposal.id + '\', \'' + proposal.companyName + '\')" style="padding:14px 28px;font-size:16px;font-weight:600;min-width:120px;">üìÑ View</button>' +
                '<button class="btn btn-secondary" onclick="window.open(\'https://drive.google.com/uc?export=download&id=' + proposal.id + '\', \'_blank\')" style="padding:14px 28px;font-size:16px;font-weight:600;min-width:120px;">üì• Download</button>' +
                archiveButtonHtml +
              '</div>' +
            '</div>' +
          '</div>'
        );
      }).join('');
    }

    window.unarchiveQuantumProposal = function unarchiveQuantumProposal(fileId, companyName) {
      const confirmOverlay = document.createElement('div');
      confirmOverlay.className = 'modal-overlay';
      confirmOverlay.style.display = 'block';
      confirmOverlay.style.zIndex = '20000';

      confirmOverlay.innerHTML = 
        '<div class="modal" style="max-width:500px;" onclick="event.stopPropagation()">' +
          '<h3 style="margin-bottom:20px;color:#2d3748;">Restore Proposal?</h3>' +
          '<p style="color:#4a5568;margin-bottom:10px;line-height:1.6;">Are you sure you want to restore the proposal for:</p>' +
          '<p style="color:#1e3a8a;font-weight:600;margin-bottom:20px;font-size:1.1em;">' + companyName + '</p>' +
          '<p style="color:#718096;margin-bottom:25px;font-size:0.95em;">This will move it back to the active proposals library.</p>' +
          '<div style="display:flex;gap:15px;margin-top:25px;">' +
            '<button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()" style="flex:1;">Cancel</button>' +
            '<button class="btn" onclick="confirmUnarchiveQuantumProposal(\'' + fileId + '\', \'' + companyName.replace(/'/g, "\\'") + '\'); this.closest(\'.modal-overlay\').remove();" style="flex:1;background:#10b981;">‚ôªÔ∏è Restore</button>' +
          '</div>' +
        '</div>';
      
      document.body.appendChild(confirmOverlay);
    };

    window.confirmUnarchiveQuantumProposal = function confirmUnarchiveQuantumProposal(fileId, companyName) {
      const proposalsList = document.getElementById('quantumProposalsList');
      if (proposalsList) {
        proposalsList.innerHTML = 
          '<div style="text-align:center;padding:40px;">' +
            '<div class="loading-spinner"></div>' +
            '<p style="margin-top:20px;color:#718096;">Restoring proposal...</p>' +
          '</div>';
      }

      try {
        const callbackName = 'unarchiveCallback_' + Date.now();
        const promise = new Promise(function(resolve, reject) {
          window[callbackName] = function(data) { 
            delete window[callbackName]; 
            resolve(data); 
          };
          setTimeout(function() { 
            delete window[callbackName]; 
            reject(new Error('Request timeout')); 
          }, 20000);
        });

        const script = document.createElement('script');
        const QUANTUM_PROPOSAL_URL = 'https://script.google.com/macros/s/AKfycbxo7BkKNseerdgo0fBmIHkRcWF7XPt8EeuqRN_9hVgoqKVA1AxudQeStsdu_kyM7ADXHA/exec';
        const url = QUANTUM_PROPOSAL_URL + '?action=updateArchiveStatus&fileId=' + encodeURIComponent(fileId) + '&status=active&companyName=' + encodeURIComponent(companyName) + '&callback=' + callbackName;
        script.src = url;

        script.onerror = function() {
          delete window[callbackName];
          showQuantumPopup(
            '<div class="error-popup">' +
              '<h3>‚ùå Restore Failed</h3>' +
              '<p>Unable to restore the proposal. Please try again.</p>' +
            '</div>',
            'error'
          );
          loadQuantumProposalsFromDrive();
        };

        document.body.appendChild(script);
        promise.then(function(data) {
          document.body.removeChild(script);
          if (data.status === 'success') {
            showQuantumPopup(
              '<div class="success-popup">' +
                '<h3>‚úÖ Proposal Restored</h3>' +
                '<p>The proposal for <strong>' + companyName + '</strong> has been restored to active proposals.</p>' +
              '</div>',
              'success'
            );
            loadQuantumProposalsFromDrive();
          } else {
            throw new Error(data.message || 'Failed to restore proposal');
          }
        }).catch(function(error) {
          showQuantumPopup(
            '<div class="error-popup">' +
              '<h3>‚ùå Restore Failed</h3>' +
              '<p>' + error.message + '</p>' +
            '</div>',
            'error'
          );
          loadQuantumProposalsFromDrive();
        });
      } catch (error) {
        showQuantumPopup(
          '<div class="error-popup">' +
            '<h3>‚ùå Restore Failed</h3>' +
            '<p>' + error.message + '</p>' +
          '</div>',
          'error'
        );
        loadQuantumProposalsFromDrive();
      }
    };

    window.archiveQuantumProposal = function archiveQuantumProposal(fileId, companyName) {
      const confirmOverlay = document.createElement('div');
      confirmOverlay.className = 'modal-overlay';
      confirmOverlay.style.display = 'block';
      confirmOverlay.style.zIndex = '20000';

      confirmOverlay.innerHTML = 
        '<div class="modal" style="max-width:500px;" onclick="event.stopPropagation()">' +
          '<h3 style="margin-bottom:20px;color:#2d3748;">Archive Proposal?</h3>' +
          '<p style="color:#4a5568;margin-bottom:10px;line-height:1.6;">Are you sure you want to archive the proposal for:</p>' +
          '<p style="color:#1e3a8a;font-weight:600;margin-bottom:20px;font-size:1.1em;">' + companyName + '</p>' +
          '<p style="color:#718096;margin-bottom:25px;font-size:0.95em;">This will move it to the Archived Proposals folder.</p>' +
          '<div style="display:flex;gap:15px;margin-top:25px;">' +
            '<button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()" style="flex:1;">Cancel</button>' +
            '<button class="btn" onclick="confirmArchiveQuantumProposal(\'' + fileId + '\', \'' + companyName.replace(/'/g, "\\'") + '\'); this.closest(\'.modal-overlay\').remove();" style="flex:1;background:#f59e0b;">üì¶ Archive</button>' +
          '</div>' +
        '</div>';
      
      document.body.appendChild(confirmOverlay);
    };

    window.confirmArchiveQuantumProposal = function confirmArchiveQuantumProposal(fileId, companyName) {
      const proposalsList = document.getElementById('quantumProposalsList');
      if (proposalsList) {
        proposalsList.innerHTML = 
          '<div style="text-align:center;padding:40px;">' +
            '<div class="loading-spinner"></div>' +
            '<p style="margin-top:20px;color:#718096;">Archiving proposal...</p>' +
          '</div>';
      }

      try {
        const callbackName = 'archiveCallback_' + Date.now();
        const promise = new Promise(function(resolve, reject) {
          window[callbackName] = function(data) { 
            delete window[callbackName]; 
            resolve(data); 
          };
          setTimeout(function() { 
            delete window[callbackName]; 
            reject(new Error('Request timeout')); 
          }, 20000);
        });

        const script = document.createElement('script');
        const QUANTUM_PROPOSAL_URL = 'https://script.google.com/macros/s/AKfycbxo7BkKNseerdgo0fBmIHkRcWF7XPt8EeuqRN_9hVgoqKVA1AxudQeStsdu_kyM7ADXHA/exec';
        const url = QUANTUM_PROPOSAL_URL + '?action=updateArchiveStatus&fileId=' + encodeURIComponent(fileId) + '&status=archived&companyName=' + encodeURIComponent(companyName) + '&callback=' + callbackName;
        script.src = url;

        script.onerror = function() {
          delete window[callbackName];
          showQuantumPopup(
            '<div class="error-popup">' +
              '<h3>‚ùå Archive Failed</h3>' +
              '<p>Unable to archive the proposal. Please try again.</p>' +
            '</div>',
            'error'
          );
          loadQuantumProposalsFromDrive();
        };

        document.body.appendChild(script);
        promise.then(function(data) {
          document.body.removeChild(script);
          if (data.status === 'success') {
            showQuantumPopup(
              '<div class="success-popup">' +
                '<h3>‚úÖ Proposal Archived</h3>' +
                '<p>The proposal for <strong>' + companyName + '</strong> has been archived.</p>' +
              '</div>',
              'success'
            );
            loadQuantumProposalsFromDrive();
          } else {
            throw new Error(data.message || 'Failed to archive proposal');
          }
        }).catch(function(error) {
          showQuantumPopup(
            '<div class="error-popup">' +
              '<h3>‚ùå Archive Failed</h3>' +
              '<p>' + error.message + '</p>' +
            '</div>',
            'error'
          );
          loadQuantumProposalsFromDrive();
        });
      } catch (error) {
        showQuantumPopup(
          '<div class="error-popup">' +
            '<h3>‚ùå Archive Failed</h3>' +
            '<p>' + error.message + '</p>' +
          '</div>',
          'error'
        );
        loadQuantumProposalsFromDrive();
      }
    };
  
    window.filterQuantumProposals = function filterQuantumProposals() {
      const searchInput = document.getElementById('quantumProposalSearch');
      const term = (searchInput.value || '').toLowerCase();
      const proposalsList = document.getElementById('quantumProposalsList');
      const clearBtn = document.getElementById('clearQuantumSearchBtn');
      clearBtn.style.display = term.length > 0 ? 'block' : 'none';
  
      if (!window.allQuantumProposals || window.allQuantumProposals.length === 0) return;
      
      let proposals = window.allQuantumProposals.filter(function(p) {
        if (window.showArchivedProposals) {
          return p.status === 'archived';
        } else {
          return p.status !== 'archived';
        }
      });
      
      if (term) {
        proposals = proposals.filter(function(p) {
          return p.companyName.toLowerCase().includes(term) || p.name.toLowerCase().includes(term);
        });
      }
      
      if (proposals.length === 0) {
        const emptyMessage = term 
          ? 'No proposals found matching "<strong>' + term + '</strong>"'
          : (window.showArchivedProposals ? 'No archived proposals found.' : 'No active proposals found.');
        proposalsList.innerHTML = 
          '<div style="text-align:center;padding:40px;color:#718096;">' +
            '<p style="font-size:18px;">' + emptyMessage + '</p>' +
            (term ? '<p style="margin-top:10px;">Try searching for a different company name.</p>' : '') +
          '</div>';
      } else {
        displayQuantumProposals(proposals);
      }
    };
  
    window.viewQuantumProposalPDF = function viewQuantumProposalPDF(fileId, companyName) {
      closeQuantumProposalViewer();
  
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay pdf-viewer-overlay';
      overlay.style.display = 'block';
  
      const pdfModal = document.createElement('div');
      pdfModal.className = 'pdf-modal';
  
      const viewerUrl = 'https://drive.google.com/file/d/' + fileId + '/preview?usp=embed';
      
      const proposal = window.allQuantumProposals ? window.allQuantumProposals.find(function(p) { return p.id === fileId; }) : null;
      const isArchived = proposal && proposal.status === 'archived';
      
      const archiveButton = isArchived
        ? '<button class="btn" onclick="unarchiveFromViewer(\'' + fileId + '\', \'' + companyName.replace(/'/g, "\\'") + '\')" style="padding:10px 20px;background:#10b981;">‚ôªÔ∏è Restore</button>'
        : '<button class="btn" onclick="archiveFromViewer(\'' + fileId + '\', \'' + companyName.replace(/'/g, "\\'") + '\')" style="padding:10px 20px;background:#f59e0b;">üì¶ Archive</button>';
  
      pdfModal.innerHTML = 
        '<div class="pdf-header">' +
          '<h3>Proposal for ' + companyName + '</h3>' +
          '<div style="display:flex;gap:10px;align-items:center;">' +
            '<button class="btn btn-primary" onclick="closePDFViewer(); setTimeout(openQuantumProposalViewer, 200);" style="padding:10px 20px;">‚Üê Back to Library</button>' +
            '<button class="btn btn-secondary" onclick="window.open(\'https://drive.google.com/uc?export=download&id=' + fileId + '\', \'_blank\')" style="padding:10px 20px;">üì• Download</button>' +
            archiveButton +
          '</div>' +
        '</div>' +
        '<div class="pdf-viewer">' +
          '<iframe src="' + viewerUrl + '" width="100%" height="100%" allowfullscreen></iframe>' +
        '</div>';
      overlay.appendChild(pdfModal);
      document.body.appendChild(overlay);
    };
    
    window.archiveFromViewer = function archiveFromViewer(fileId, companyName) {
      const pdfOverlay = document.querySelector('.pdf-viewer-overlay');
      if (pdfOverlay) pdfOverlay.remove();
      
      setTimeout(function() {
        openQuantumProposalViewer();
        
        setTimeout(function() {
          archiveQuantumProposal(fileId, companyName);
        }, 500);
      }, 200);
    };
    
    window.unarchiveFromViewer = function unarchiveFromViewer(fileId, companyName) {
      const pdfOverlay = document.querySelector('.pdf-viewer-overlay');
      if (pdfOverlay) pdfOverlay.remove();
      
      setTimeout(function() {
        openQuantumProposalViewer();
        
        setTimeout(function() {
          if (!window.showArchivedProposals) {
            toggleArchiveView();
          }
          setTimeout(function() {
            unarchiveQuantumProposal(fileId, companyName);
          }, 300);
        }, 500);
      }, 200);
    };
  
    document.addEventListener('click', function (event) {
      if (event.target.classList && event.target.classList.contains('modal-overlay')) {
        if (event.target.id !== 'quantumProposalModal') {
          closeModal();
        }
      }
    });
  </script>
  
  <!-- Reusable Username + Logout pill (shared across pages) -->
  <script defer src="userbar.js?v=1"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      if (window.UserBar && typeof window.UserBar.init === 'function') {
        window.UserBar.init({ redirectOnLogout: 'index.html', hideForGuests: true });
      } else {
        window.addEventListener('load', function () {
          if (window.UserBar && typeof window.UserBar.init === 'function') {
            window.UserBar.init({ redirectOnLogout: 'index.html', hideForGuests: true });
          }
        });
      }
    });
  </script>
</body>
</html>
