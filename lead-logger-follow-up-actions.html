<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='6' fill='%23263238'/%3E%3Cpath d='M8 22V12l5 4 5-8v14' stroke='%2310b981' stroke-width='2.5' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3Ccircle cx='24' cy='10' r='3' fill='%23f59e0b'/%3E%3C/svg%3E"/>
  <title>Follow Up Actions - Abbondanza Sales</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f5f5f5;min-height:100vh;padding:20px}
    .container{max-width:98%;margin:0 auto;background:rgba(255,255,255,.98);border-radius:20px;padding:30px;box-shadow:0 2px 8px rgba(0,0,0,.08);border:1px solid #e5e7eb}

    /* Title header */
    .title-bar{background:linear-gradient(135deg,#263238,#37474f);color:#fff;padding:18px 24px;border-radius:20px 20px 0 0;text-align:center;margin:-30px -30px 24px -30px}
    .title-bar h1{color:#fff;font-size:1.8rem;margin:0}

    /* Button row */
    .btn-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:15px}

    /* Filter row */
    .filter-row{display:flex;gap:15px;flex-wrap:wrap;align-items:center;margin-bottom:20px}
    .filter-row select{padding:10px 15px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;background:#fff;color:#2d3748;cursor:pointer;transition:border-color .2s}
    .filter-row select:focus{outline:none;border-color:#10b981}
    .filter-row input[type="search"]{padding:10px 15px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;background:#fff;color:#2d3748;width:240px;transition:border-color .2s}
    .filter-row input[type="search"]:focus{outline:none;border-color:#10b981}

    .tbtn{padding:12px 24px;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-size:14px;display:inline-flex;align-items:center;gap:8px;color:#fff;transition:.15s}
    .tbtn:hover{transform:translateY(-1px);filter:brightness(1.1)}
    .tbtn svg{width:16px;height:16px;stroke:currentColor;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;fill:none}
    .tbtn-teal{background:linear-gradient(135deg,#14b8a6,#0d9488)}
    .tbtn-orange{background:linear-gradient(135deg,#f59e0b,#d97706)}
    .tbtn-purple{background:linear-gradient(135deg,#7c3aed,#6d28d9)}
    .tbtn-blue{background:linear-gradient(135deg,#10b981,#059669)}
    .tbtn-green{background:linear-gradient(135deg,#059669,#047857)}
    .tbtn-gray{background:linear-gradient(135deg,#6b7280,#4b5563)}
    .tbtn-red{background:linear-gradient(135deg,#ef4444,#dc2626)}

    /* Batch bar */
    .batch-inline{display:none;align-items:center;gap:8px;margin-left:auto;padding:4px 12px;background:linear-gradient(135deg,#263238,#37474f);border-radius:8px;white-space:nowrap}
    .batch-inline.show{display:inline-flex}
    .email-history{margin-bottom:14px;border:1px solid #e2e8f0;border-radius:8px;overflow:hidden}
    .email-history-hdr{padding:8px 12px;background:#f8fafc;border-bottom:1px solid #e2e8f0;font-size:12px;font-weight:700;color:#475569;display:flex;align-items:center;gap:6px}
    .email-history-item{display:flex;align-items:center;gap:10px;padding:8px 12px;border-bottom:1px solid #f1f5f9;font-size:12px}
    .email-history-item:last-child{border-bottom:none}
    .email-history-date{font-weight:600;color:#1e293b;min-width:80px;flex-shrink:0}
    .email-history-tmpl{color:#2563eb;font-weight:500;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .email-history-to{color:#64748b;font-size:11px;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .email-history-empty{padding:12px;text-align:center;color:#94a3b8;font-size:12px;font-style:italic}
    .log-list{max-height:60vh;overflow-y:auto;padding:0 20px}
    .log-entry{display:flex;gap:10px;padding:10px 0;border-bottom:1px solid #f1f5f9;font-size:12px}
    .log-entry:last-child{border-bottom:none}
    .log-ts{min-width:130px;flex-shrink:0;font-size:11px;color:#64748b;font-weight:500}
    .log-msg{flex:1;color:#1e293b;line-height:1.4}
    .log-msg .log-field{font-weight:600;color:#0369a1}
    .log-msg .log-old{color:#ef4444;text-decoration:line-through;font-size:11px}
    .log-msg .log-new{color:#059669;font-weight:600}
    .log-empty{padding:40px 20px;text-align:center;color:#94a3b8;font-size:14px}
    .batch-count{background:rgba(255,255,255,.2);padding:3px 12px;border-radius:12px;font-size:13px}
    .batch-btn{padding:7px 18px;background:#fff;color:#263238;border:none;border-radius:6px;font-weight:700;font-size:13px;cursor:pointer;display:inline-flex;align-items:center;gap:5px}
    .batch-btn:hover{background:#eff6ff}
    .batch-btn svg{width:14px;height:14px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
    .batch-btn.send{background:linear-gradient(135deg,#059669,#047857);color:#fff}
    @keyframes glowGreen{0%{box-shadow:0 0 4px rgba(5,150,105,.3)}50%{box-shadow:0 0 16px rgba(5,150,105,.8),0 0 30px rgba(5,150,105,.4)}100%{box-shadow:0 0 4px rgba(5,150,105,.3)}}
    .batch-btn.send.glow{animation:glowGreen 2s ease-in-out infinite}
    .batch-clear{background:none;border:none;color:rgba(255,255,255,.7);cursor:pointer;font-size:13px;margin-left:auto}

    /* Table wrapper */
    .table-container{overflow:auto;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.1);max-height:70vh;position:relative}
    table{width:100%;border-collapse:collapse;background:#fff;min-width:1600px}
    th{background:#263238;color:#fff;padding:10px 8px;text-align:center;font-weight:600;font-size:12px;position:sticky;top:0;z-index:10;white-space:nowrap;border-bottom:2px solid #1a2526;box-shadow:0 2px 4px rgba(0,0,0,.15)}
    th .sub{font-size:10px;opacity:.6;font-weight:400;display:block;text-transform:none;letter-spacing:0}
    td{padding:12px 8px;text-align:center;font-size:13px;color:#2d3748;border-bottom:1px solid #e2e8f0;vertical-align:middle}
    td:nth-child(2){white-space:normal;word-break:break-word;max-width:200px}
    tbody tr{border-bottom:1px solid #e2e8f0}
    tbody tr:last-child{border-bottom:none}
    tbody tr:hover td{background:#f7fafc}
    .row-dead td{background:#fef2f2!important}
    .row-unlabeled td{background:#fffbeb!important}
    .pill-needs{background:#fef3c7;color:#92400e;border:1px dashed #d97706;cursor:pointer;font-size:13px;width:auto;padding:6px 14px}
    .pill-needs:hover{background:#fde68a;transform:scale(1.05)}
    @keyframes pulse-needs{0%,100%{opacity:1}50%{opacity:.7}}

    /* Label picker popover */
    .label-picker-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:9999;display:flex;align-items:center;justify-content:center}
    .label-picker{background:#fff;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,.3);min-width:300px;max-width:400px;overflow:hidden}
    .lp-header{background:linear-gradient(135deg,#263238,#37474f);color:#fff;padding:14px 18px;display:flex;justify-content:space-between;align-items:center}
    .lp-header strong{font-size:14px}
    .lp-company{font-size:12px;opacity:.8}
    .lp-body{padding:16px 18px;display:flex;flex-direction:column;gap:8px}
    .lp-chip{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:8px;cursor:pointer;transition:.15s;border:1px solid #e2e8f0;background:#f8fafc}
    .lp-chip:hover{background:#f0f9ff;border-color:#93c5fd}
    .lp-chip input[type=checkbox]{width:16px;height:16px;accent-color:#10b981;cursor:pointer}
    .lp-chip .pill{margin:0;cursor:pointer;width:auto;padding:6px 14px}
    .lp-footer{padding:12px 18px;background:#f8fafc;display:flex;justify-content:space-between;align-items:center;gap:8px;border-top:1px solid #e2e8f0}

    /* Checkbox */
    .row-cb{width:16px;height:16px;cursor:pointer;accent-color:#10b981}

    /* Action pills */
    .pill{padding:6px 14px;border-radius:10px;font-size:13px;font-weight:600;display:inline-block;margin:2px;text-align:center;cursor:pointer;white-space:nowrap}
    .pill-grid{transition:.15s;text-align:center;line-height:2}
    .pill-grid:hover{transform:scale(1.03)}
    .pill-grid:hover .pill{opacity:.8}
    td.td-action{padding:6px 4px}
    .p-email{background:#dbeafe;color:#1e40af}
    .p-call{background:#fef3c7;color:#92400e}
    .p-fu{background:#d1fae5;color:#065f46}
    .p-appt{background:#fce7f3;color:#9d174d}
    .p-prop{background:#e0f2fe;color:#0369a1}

    /* Stacked label rows */
    .label-stack{display:flex;flex-direction:column;gap:2px;align-items:center}
    .label-row{display:flex;align-items:center;gap:4px;justify-content:center;white-space:nowrap}
    .lr-tag{padding:4px 4px;border-radius:6px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.3px;width:48px;text-align:center;flex-shrink:0;display:inline-block}
    .t-email{background:#dbeafe;color:#1e40af}
    .t-call{background:#fef3c7;color:#92400e}
    .t-fu{background:#d1fae5;color:#065f46}
    .t-appt{background:#fce7f3;color:#9d174d}
    .t-prop{background:#e0f2fe;color:#0369a1}
    .lr-val{font-size:13px;font-weight:600;color:#1e293b;cursor:pointer}
    .lr-date{font-size:13px;color:#10b981;cursor:pointer;border-bottom:1px dashed #10b981}
    .lr-dim{font-size:12px;color:#a0aec0;cursor:pointer}

    /* Attempt counter */
    .att{display:inline-flex;align-items:center;gap:1px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:4px;padding:1px 3px}
    .att-n{font-weight:700;font-size:14px;color:#263238;min-width:18px;text-align:center}
    .att-b{width:20px;height:20px;border-radius:3px;border:1px solid #cbd5e0;background:#fff;cursor:pointer;font-size:12px;font-weight:700;color:#64748b;display:flex;align-items:center;justify-content:center}
    .att-b:hover{background:#10b981;color:#fff;border-color:#10b981}
    .att-dead{border-color:#fecaca;background:#fef2f2}
    .att-dead .att-n{color:#ef4444}

    /* Editable phone */
    .phone-link{color:#10b981;cursor:pointer;border-bottom:1px dashed #10b981;font-size:13px}
    .phone-link:hover{background:#ecfdf5}

    /* Notes */
    .notes-snip{max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;cursor:pointer;color:#4a5568;display:inline-block;font-size:13px}
    .notes-snip.empty{color:#a0aec0;font-style:italic}

    /* Alert button */
    .alert-btn{padding:7px 14px;border-radius:6px;border:none;background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff;font-size:12px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:4px;min-width:130px;justify-content:center}
    .alert-btn svg{width:14px;height:14px;stroke:currentColor;fill:none;stroke-width:2}
    .alert-btn:hover{transform:scale(1.05)}

    /* Small action buttons */
    .btn-sm{padding:7px 14px;font-size:12px;border-radius:6px;border:none;color:#fff;cursor:pointer;font-weight:600;display:inline-flex;align-items:center;gap:4px;min-width:130px;justify-content:center}
    .btn-sm svg{width:14px;height:14px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}

    /* Toast */
    .toast{position:fixed;top:20px;right:20px;padding:14px 24px;border-radius:10px;color:#fff;font-weight:600;font-size:14px;z-index:9999;animation:toastIn .3s ease;box-shadow:0 8px 24px rgba(0,0,0,.2);display:flex;align-items:center;gap:8px}
    .toast svg{width:18px;height:18px;stroke:currentColor;fill:none;stroke-width:2}
    .toast-success{background:linear-gradient(135deg,#059669,#047857)}
    .toast-error{background:linear-gradient(135deg,#ef4444,#dc2626)}
    @keyframes toastIn{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}

    /* Loading */
    .loading{text-align:center;padding:60px;color:#64748b}
    .spinner{display:inline-block;width:36px;height:36px;border:3px solid #e2e8f0;border-top:3px solid #10b981;border-radius:50%;animation:spin .8s linear infinite}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .empty-state{text-align:center;padding:60px 20px;color:#64748b}
    .empty-state h3{font-size:1.1rem;margin-bottom:8px;color:#4a5568}

    /* Modal */
    .modal-overlay{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.5);justify-content:center;align-items:center}
    .modal-overlay.show{display:flex}
    .modal-card{background:#fff;border-radius:14px;max-width:500px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,.3);overflow:hidden;animation:modalIn .2s ease}
    @keyframes modalIn{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}
    .modal-hdr{background:linear-gradient(135deg,#263238,#37474f);color:#fff;padding:18px 24px}
    .modal-hdr h3{margin:0;font-size:17px;display:flex;align-items:center;gap:8px}
    .modal-hdr h3 svg{width:18px;height:18px;stroke:currentColor;fill:none;stroke-width:2}
    .modal-hdr p{margin:4px 0 0;opacity:.8;font-size:13px}
    .modal-body{padding:20px 24px;color:#2d3748;max-height:60vh;overflow-y:auto}
    .modal-footer{padding:14px 24px;background:#f8fafc;display:flex;justify-content:flex-end;gap:8px;border-top:1px solid #e2e8f0}
    .modal-footer button{padding:9px 20px;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:14px}
    .modal-footer .btn-cancel{background:#e2e8f0;color:#4a5568}
    .modal-footer .btn-save{background:#10b981;color:#fff}
    .modal-footer .btn-danger{background:#ef4444;color:#fff}

    /* Inline edit input */
    .inline-input{padding:4px 8px;border:2px solid #10b981;border-radius:6px;font-size:13px;text-align:center;width:110px}
    .inline-input:focus{outline:none;box-shadow:0 0 0 3px rgba(16,185,129,.2)}

    /* Notes edit overlay */
    .notes-edit-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.4);z-index:999;display:flex;justify-content:center;align-items:center}
    .notes-edit-card{background:#fff;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,.2);width:90vw;max-width:700px;overflow:hidden}
    .notes-edit-header{background:#263238;color:#fff;padding:16px 24px;display:flex;justify-content:space-between;align-items:center}
    .notes-edit-header h3{margin:0;font-size:16px}
    .notes-edit-body{padding:20px 24px}
    .notes-edit-body textarea{width:100%;min-height:200px;padding:14px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;font-family:inherit;resize:vertical;line-height:1.5}
    .notes-edit-body textarea:focus{outline:none;border-color:#10b981;box-shadow:0 0 0 3px rgba(16,185,129,.15)}
    .notes-edit-footer{padding:12px 24px;background:#f8fafc;display:flex;justify-content:flex-end;gap:10px;border-top:1px solid #e2e8f0}
    .notes-edit-footer button{padding:9px 20px;border:none;border-radius:6px;font-size:14px;font-weight:600;cursor:pointer}

    /* ====== LABEL SETTINGS MODAL ====== */
    .ls-add-row{display:flex;justify-content:flex-end;margin-bottom:14px}
    .ls-item{display:flex;align-items:center;gap:10px;padding:10px 12px;background:#f8fafc;border-radius:8px;margin-bottom:6px;border:1px solid #e2e8f0;transition:.15s}
    .ls-item:hover{border-color:#cbd5e0}
    .ls-pill{padding:6px 14px;border-radius:10px;font-size:13px;font-weight:700;min-width:90px;text-align:center;flex-shrink:0}
    .ls-tags{flex:1;display:flex;flex-wrap:wrap;gap:4px;min-height:22px}
    .ls-tag{padding:3px 10px;border-radius:4px;font-size:12px;font-weight:600}
    .ls-tag-date{background:#d1fae5;color:#065f46}
    .ls-tag-email-rem{background:#fef3c7;color:#92400e}
    .ls-tag-popup{background:#fee2e2;color:#dc2626}
    .ls-tag-nodate{background:#e2e8f0;color:#64748b}
    .ls-tag-norem{background:#e2e8f0;color:#64748b}
    .ls-edit-btn{padding:5px 12px;border-radius:4px;border:1px solid #cbd5e0;background:#fff;font-size:13px;cursor:pointer;color:#10b981;font-weight:600;display:inline-flex;align-items:center;gap:4px;transition:.15s;flex-shrink:0}
    .ls-edit-btn svg{width:12px;height:12px;stroke:currentColor;fill:none;stroke-width:2}
    .ls-edit-btn:hover{background:#ecfdf5;border-color:#10b981}
    .ls-panel{background:#fff;border:1px solid #e2e8f0;border-radius:10px;padding:16px;margin-bottom:10px;display:none;animation:modalIn .15s ease}
    .ls-panel.open{display:block}
    .ls-panel h4{color:#1e293b;margin-bottom:14px;font-size:14px;display:flex;align-items:center;gap:6px}
    .ls-field{margin-bottom:14px}
    .ls-field label{display:block;font-size:13px;font-weight:600;color:#4a5568;margin-bottom:4px}
    .ls-field input[type="text"],.ls-field input[type="number"]{width:100%;max-width:260px;padding:8px 10px;border:1px solid #cbd5e0;border-radius:6px;font-size:14px}
    .ls-field input:focus{outline:none;border-color:#10b981;box-shadow:0 0 0 3px rgba(16,185,129,.15)}
    .ls-toggle-row{display:flex;align-items:center;gap:10px;margin-bottom:10px}
    .ls-toggle{width:38px;height:22px;border-radius:22px;background:#cbd5e0;position:relative;cursor:pointer;transition:.2s;flex-shrink:0}
    .ls-toggle.on{background:#10b981}
    .ls-toggle::after{content:'';position:absolute;width:18px;height:18px;border-radius:50%;background:#fff;top:2px;left:2px;transition:.2s;box-shadow:0 1px 2px rgba(0,0,0,.2)}
    .ls-toggle.on::after{left:18px}
    .ls-toggle-label{font-size:14px;color:#2d3748;font-weight:500}
    .ls-indent{margin-left:48px;margin-top:-4px;margin-bottom:12px}
    .ls-indent label{display:block;font-size:13px;font-weight:600;color:#4a5568;margin-bottom:3px}
    .ls-indent input{padding:6px 8px;border:1px solid #cbd5e0;border-radius:5px;font-size:13px;width:80px}
    .ls-indent input:focus{outline:none;border-color:#10b981}
    .ls-delete-row{display:flex;justify-content:flex-end;margin-top:10px;padding-top:10px;border-top:1px solid #f1f5f9}
    .ls-delete-btn{padding:5px 12px;border-radius:5px;border:1px solid #fecaca;background:#fff;font-size:13px;cursor:pointer;color:#ef4444;font-weight:600;display:inline-flex;align-items:center;gap:4px;transition:.15s}
    .ls-delete-btn svg{width:12px;height:12px;stroke:currentColor;fill:none;stroke-width:2}
    .ls-delete-btn:hover{background:#fef2f2;border-color:#ef4444}

    /* Center loading modal */
    .loading-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.4);z-index:9999;display:flex;justify-content:center;align-items:center}
    .loading-modal-card{background:#fff;padding:30px 50px;border-radius:12px;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,.3)}
    .loading-modal-card .spinner{margin-bottom:10px}
    .loading-modal-card p{color:#4a5568;font-size:14px;font-weight:600}

    /* ====== TEAM MEMBERS MODAL ====== */
    .tm-add-row{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap}
    .tm-add-row input{flex:1;min-width:120px;padding:8px 10px;border:1px solid #cbd5e0;border-radius:6px;font-size:14px}
    .tm-add-row input:focus{outline:none;border-color:#10b981;box-shadow:0 0 0 3px rgba(16,185,129,.15)}
    .tm-item{display:flex;align-items:center;gap:10px;padding:10px 12px;background:#f8fafc;border-radius:8px;margin-bottom:6px;border:1px solid #e2e8f0;transition:.15s}
    .tm-item:hover{border-color:#cbd5e0}
    .tm-avatar{width:32px;height:32px;border-radius:50%;color:#fff;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0}
    .tm-info{flex:1;min-width:0}
    .tm-name{font-weight:600;font-size:14px;color:#1e293b}
    .tm-email{font-size:13px;color:#64748b;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .tm-remove{padding:4px 10px;border-radius:4px;border:1px solid #fecaca;background:#fff;font-size:13px;cursor:pointer;color:#ef4444;font-weight:600;display:inline-flex;align-items:center;gap:4px;transition:.15s;flex-shrink:0}
    .tm-remove svg{width:12px;height:12px;stroke:currentColor;fill:none;stroke-width:2}
    .tm-remove:hover{background:#fef2f2;border-color:#ef4444}
    .tm-empty{text-align:center;padding:24px;color:#94a3b8;font-size:13px}

    /* ====== ATTEMPT SETTINGS MODAL ====== */
    .as-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0}
    .as-label{font-weight:600;font-size:14px;color:#1e293b}
    .as-desc{font-size:13px;color:#64748b;margin-top:2px}
    .as-input{width:68px;text-align:center;font-size:18px;font-weight:700;padding:8px;border:2px solid #e2e8f0;border-radius:8px;color:#263238}
    .as-input:focus{outline:none;border-color:#10b981;box-shadow:0 0 0 3px rgba(16,185,129,.15)}
    .as-explainer{margin-top:18px;padding:14px;background:#fef2f2;border-radius:8px;border:1px solid #fecaca}
    .as-explainer-title{font-weight:700;color:#dc2626;margin-bottom:8px;font-size:14px}
    .as-flow{display:flex;align-items:center;gap:8px;font-size:13px;color:#4a5568;flex-wrap:wrap}

    /* ====== EMAIL TEMPLATES MODAL ====== */
    .et-toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;gap:8px}
    .et-list{margin-bottom:0}
    .et-item{display:flex;align-items:center;gap:10px;padding:12px;background:#f8fafc;border-radius:8px;margin-bottom:6px;border:1px solid #e2e8f0;cursor:pointer;transition:.15s}
    .et-item:hover{border-color:#10b981;background:#ecfdf5}
    .et-item.active{border-color:#10b981;background:#ecfdf5;box-shadow:0 0 0 2px rgba(16,185,129,.2)}
    .et-icon{width:36px;height:36px;border-radius:8px;background:linear-gradient(135deg,#10b981,#059669);color:#fff;display:flex;align-items:center;justify-content:center;flex-shrink:0}
    .et-icon svg{width:18px;height:18px;stroke:currentColor;fill:none;stroke-width:2}
    .et-info{flex:1;min-width:0}
    .et-name{font-weight:600;font-size:14px;color:#1e293b}
    .et-subject{font-size:13px;color:#64748b;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .et-actions{display:flex;gap:4px;flex-shrink:0}
    .et-btn{padding:5px 10px;border-radius:4px;border:1px solid #cbd5e0;background:#fff;font-size:12px;cursor:pointer;font-weight:600;display:inline-flex;align-items:center;gap:3px;transition:.15s}
    .et-btn svg{width:11px;height:11px;stroke:currentColor;fill:none;stroke-width:2}
    .et-btn.edit{color:#10b981;border-color:#a7f3d0}
    .et-btn.edit:hover{background:#ecfdf5}
    .et-btn.del{color:#ef4444;border-color:#fecaca}
    .et-btn.del:hover{background:#fef2f2}
    .et-empty{text-align:center;padding:30px;color:#94a3b8;font-size:13px}
    .et-form{background:#fff;border:1px solid #e2e8f0;border-radius:10px;padding:16px;margin-bottom:10px}
    .et-form h4{color:#1e293b;margin-bottom:14px;font-size:14px;display:flex;align-items:center;gap:6px}
    .et-field{margin-bottom:12px}
    .et-field label{display:block;font-size:11px;font-weight:600;color:#4a5568;margin-bottom:4px}
    .et-field input,.et-field textarea{width:100%;padding:8px 10px;border:1px solid #cbd5e0;border-radius:6px;font-size:13px;font-family:inherit}
    .et-field input:focus,.et-field textarea:focus{outline:none;border-color:#10b981;box-shadow:0 0 0 3px rgba(16,185,129,.15)}
    .et-field textarea{min-height:120px;resize:vertical;line-height:1.5}
    .et-placeholders{background:#f0fdf4;border:1px solid #bbf7d0;border-radius:6px;padding:10px 12px;margin-top:8px}
    .et-placeholders-title{font-size:11px;font-weight:700;color:#065f46;margin-bottom:6px}
    .et-placeholder-tag{display:inline-block;padding:2px 8px;background:#d1fae5;color:#065f46;border-radius:4px;font-size:10px;font-weight:600;margin:2px;cursor:pointer;transition:.1s}
    .et-placeholder-tag:hover{background:#a7f3d0}
    .et-form-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px;padding-top:12px;border-top:1px solid #f1f5f9}

    /* ==================== MOBILE RESPONSIVE ==================== */
    @media (max-width: 768px) {
      body{padding:8px}
      .container{padding:12px;border-radius:12px}
      .title-bar{margin:-12px -12px 16px -12px;padding:14px 16px;border-radius:12px 12px 0 0}
      .title-bar h1{font-size:1.3rem}

      /* Buttons stack */
      .btn-row{gap:6px}
      .tbtn{padding:10px 14px;font-size:12px;gap:5px;flex:1 1 calc(50% - 6px);justify-content:center;min-width:0}
      .tbtn svg{width:14px;height:14px}

      /* Filters stack */
      .filter-row{flex-direction:column;gap:8px}
      .filter-row select,.filter-row input[type="search"]{width:100%;font-size:13px;padding:10px 12px}

      /* Batch inline wrap */
      .batch-inline{gap:6px;padding:4px 8px;font-size:11px}
      .batch-btn{padding:6px 12px;font-size:12px}

      /* Table smaller */
      .table-container{border-radius:8px;max-height:none}
      table{min-width:900px}
      th{padding:8px 4px;font-size:10px}
      td{padding:8px 4px;font-size:11px}
      td:nth-child(2){max-width:120px}
      .pill{padding:4px 10px;font-size:11px}
      .lr-tag{font-size:9px;width:40px;padding:3px 3px}
      .lr-val{font-size:11px}
      .lr-date{font-size:11px}
      .lr-dim{font-size:10px}
      .att-n{font-size:12px}
      .att-b{width:18px;height:18px;font-size:10px}
      .notes-snip{max-width:70px;font-size:11px}
      .alert-btn{padding:5px 10px;font-size:10px;min-width:100px}
      .btn-sm{padding:5px 10px;font-size:10px;min-width:100px}
      .phone-link{font-size:11px}

      /* Modals full-width */
      .modal-card{width:95%!important;max-width:95vw!important}
      .modal-hdr{padding:14px 16px}
      .modal-hdr h3{font-size:15px}
      .modal-body{padding:14px 16px;max-height:65vh}
      .modal-footer{padding:10px 16px}
      .modal-footer button{padding:8px 16px;font-size:13px}

      /* Label picker */
      .label-picker{min-width:auto;max-width:95vw;width:95vw}
      .lp-body{padding:12px}
      .lp-chip{padding:6px 10px}

      /* Notes edit */
      .notes-edit-card{width:95vw!important;max-width:95vw!important}
      .notes-edit-body textarea{min-height:150px;font-size:14px}

      /* Label settings */
      .ls-item{flex-wrap:wrap;gap:6px;padding:8px}
      .ls-pill{min-width:70px;font-size:11px;padding:4px 10px}
      .ls-tags{gap:3px}
      .ls-tag{font-size:10px;padding:2px 6px}
      .ls-edit-btn{font-size:11px;padding:4px 8px}
      .ls-field input[type="text"],.ls-field input[type="number"]{max-width:100%}
      .ls-indent{margin-left:0}

      /* Team members */
      .tm-add-row{flex-direction:column}
      .tm-add-row input{min-width:0}
      .tm-item{flex-wrap:wrap;gap:6px}
      .tm-email{font-size:11px}

      /* Email templates */
      .et-item{flex-wrap:wrap;gap:6px;padding:10px}
      .et-info{min-width:calc(100% - 50px)}
      .et-actions{width:100%;justify-content:flex-end}
      .et-field textarea{min-height:100px}

      /* Attempt settings */
      .as-row{flex-direction:column;align-items:flex-start;gap:8px}

      /* Toast */
      .toast{top:10px;right:10px;left:10px;font-size:13px;padding:10px 16px}
    }

    @media (max-width: 480px) {
      body{padding:4px}
      .container{padding:8px;border-radius:8px}
      .title-bar{margin:-8px -8px 12px -8px;padding:12px}
      .title-bar h1{font-size:1.1rem}
      .tbtn{padding:9px 10px;font-size:11px;flex:1 1 calc(50% - 4px)}
      table{min-width:750px}
      th{font-size:9px;padding:6px 3px}
      td{font-size:10px;padding:6px 3px}
      .pill{font-size:10px;padding:3px 8px}
      .alert-btn{min-width:80px;font-size:9px;padding:4px 8px}
      .btn-sm{min-width:80px;font-size:9px;padding:4px 8px}
      .modal-card{width:98%!important}
    }

    /* ==================== MOBILE RESPONSIVE ==================== */
    @media (max-width: 768px) {
      body{padding:8px}
      .container{padding:12px;border-radius:12px}
      .title-bar{margin:-12px -12px 16px -12px;padding:14px 16px;border-radius:12px 12px 0 0}
      .title-bar h1{font-size:1.3rem}
      .btn-row{gap:6px}
      .tbtn{padding:10px 14px;font-size:12px;gap:5px;flex:1 1 calc(50% - 6px);justify-content:center;min-width:0}
      .tbtn svg{width:14px;height:14px}
      .filter-row{flex-direction:column;gap:8px}
      .filter-row select,.filter-row input[type="search"]{width:100%;font-size:13px;padding:10px 12px}
      .batch-inline{gap:4px;padding:4px 6px;font-size:10px;flex-wrap:wrap;margin-left:0;margin-top:4px}
      .batch-btn{padding:6px 12px;font-size:12px}
      .table-container{border-radius:8px;max-height:none}
      table{min-width:900px}
      th{padding:8px 4px;font-size:10px}
      td{padding:8px 4px;font-size:11px}
      .alert-btn{padding:6px 10px;font-size:10px;min-width:100px}
      .btn-sm{padding:6px 10px;font-size:10px;min-width:100px}
      .att-n{font-size:12px}
      .notes-snip{max-width:80px;font-size:11px}
      .modal-card{width:96%!important;max-width:96vw!important}
      .modal-body{padding:14px}
      .notes-edit-card{width:95vw!important;max-width:95vw!important}
      .label-picker{min-width:auto;max-width:95vw;width:90vw}
      .ls-item{flex-wrap:wrap;gap:6px}
      .ls-pill{min-width:auto;font-size:11px;padding:4px 10px}
      .ls-field input[type="text"],.ls-field input[type="number"]{max-width:100%}
      .tm-add-row{flex-wrap:wrap}
      .tm-add-row input{min-width:0;flex:1 1 100%}
      .tm-item{flex-wrap:wrap;gap:6px}
      .tm-info{min-width:0}
      .et-item{flex-wrap:wrap;gap:6px}
      .et-info{min-width:0}
    }
    @media (max-width: 480px) {
      body{padding:4px}
      .container{padding:8px;border-radius:8px}
      .title-bar{margin:-8px -8px 12px -8px;padding:12px}
      .title-bar h1{font-size:1.1rem}
      .tbtn{padding:8px 10px;font-size:11px;flex:1 1 calc(50% - 4px)}
      table{min-width:700px}
      th{font-size:9px;padding:6px 3px}
      td{font-size:10px;padding:6px 3px}
      .modal-card{width:98%!important;max-width:98vw!important}
      .modal-body{padding:10px}
    }
    .proposal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);z-index:1100;display:flex;flex-direction:column}
    .proposal-bar{background:#1e293b;padding:10px 20px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
    .proposal-bar-title{color:#fff;font-size:15px;font-weight:700}
    .proposal-bar-close{background:#ef4444;color:#fff;border:none;padding:8px 20px;border-radius:6px;font-size:13px;font-weight:700;cursor:pointer}
    .proposal-bar-close:hover{background:#dc2626}
    .proposal-bar-open{background:#2563eb;color:#fff;border:none;padding:8px 16px;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;margin-left:8px}
    .proposal-bar-open:hover{background:#1d4ed8}
    .proposal-frame{flex:1;border:none;width:100%;background:#fff}
  </style>
</head>
<body>
  <div class="container">
    <!-- TITLE HEADER -->
    <div class="title-bar">
      <h1>Follow Up Actions</h1>
    </div>

    <!-- BUTTON ROW -->
    <div class="btn-row">
      <button class="tbtn tbtn-gray" onclick="goToLeadDB()">
        <svg viewBox="0 0 24 24"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
        Back to Leads
      </button>
      <button class="tbtn tbtn-teal" onclick="openLabelsModal()">
        <svg viewBox="0 0 24 24"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
        Action Labels
      </button>
      <button class="tbtn tbtn-orange" onclick="openTeamModal()">
        <svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
        Team Members
      </button>
      <button class="tbtn tbtn-purple" onclick="openAttemptsModal()">
        <svg viewBox="0 0 24 24"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>
        Lead Attempts
        <svg viewBox="0 0 24 24" style="width:12px;height:12px;margin-left:-2px"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06A1.65 1.65 0 0 0 15 19.4a1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
      </button>
      <button class="tbtn tbtn-blue" onclick="openTemplatesModal()">
        <svg viewBox="0 0 24 24"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
        Email Templates
      </button>
    </div>

    <!-- FILTER ROW -->
    <div class="filter-row">
      <select id="actionFilter" onchange="filterTable()">
        <option value="">All Actions</option>
        <option value="Email">Email</option>
        <option value="Call">Call</option>
        <option value="Follow Up">Follow Up</option>
        <option value="Appt Made">Appt Made</option>
        <option value="Proposal Sent">Proposal Sent</option>
        <option value="Unlabeled">Unlabeled</option>
      </select>
      <input type="search" id="searchInput" placeholder="Search leads, company, notes..." oninput="filterTable()"/>
      <span style="font-size:11px;color:#94a3b8;font-style:italic;white-space:nowrap">* Right-click to remove Date or Rep</span>
      <!-- INLINE SEND EMAILS -->
      <div class="batch-inline" id="sendEmailsBar">
        <span class="batch-count" id="queuedCount" style="font-size:12px;font-weight:600;color:#059669;white-space:nowrap">0 emails ready</span>
        <button class="batch-btn send glow" onclick="openSendReview()" style="padding:6px 14px;font-size:12px">
          <svg viewBox="0 0 24 24" style="width:14px;height:14px"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
          <span id="sendEmailsBtnText">Send Emails</span>
        </button>
        <button class="batch-clear" onclick="clearAllQueued()" style="font-size:10px;padding:4px 8px">&#10005; Clear</button>
      </div>
    </div>

    <!-- TABLE -->
    <div class="table-container" id="tableContainer">
      <div id="loadingState" class="loading">
        <div class="spinner"></div>
        <p style="margin-top:12px">Loading follow up actions...</p>
      </div>

      <table id="fuTable" style="display:none">
        <thead><tr>
            <th style="width:6%">Date Added<span class="sub">from Lead DB</span></th>
            <th style="width:9%">Company</th>
            <th style="width:5%">Pop.<span class="sub">population</span></th>
            <th style="width:9%">Action</th>
            <th style="width:8%">Action Date</th>
            <th style="width:7%">Who</th>
            <th style="width:7%">Attempt</th>
            <th style="width:7%">Last Contact<span class="sub">attempt date auto populated</span></th>
            <th style="width:6%">Phone<span class="sub">synced to Lead DB</span></th>
            <th style="width:7%">Notes<span class="sub">synced to Lead DB</span></th>
            <th style="width:6%">Email</th>
            <th style="width:6%">Proposal</th>
            <th style="width:7%">Rep Alert</th>
            <th style="width:3%">Log</th>
          </tr></thead>
          <tbody id="fuTableBody"></tbody>
        </table>

      <div id="emptyState" class="empty-state" style="display:none">
        <h3>No follow up actions yet</h3>
        <p>Actions will appear here when leads are created or actions are added.</p>
      </div>
    </div>
  </div>

  <!-- TOAST CONTAINER -->
  <div id="toastContainer"></div>

  <!-- LABEL SETTINGS MODAL -->
  <div class="modal-overlay" id="labelsModal">
    <div class="modal-card" style="max-width:620px;width:94%">
      <div class="modal-hdr">
        <h3>
          <svg viewBox="0 0 24 24"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
          Label Settings
        </h3>
        <p>Each label is independent &mdash; configure dates &amp; reminders per label</p>
      </div>
      <div class="modal-body" id="labelsModalBody" style="max-height:65vh">
        <!-- Rendered by JS -->
        <div class="loading" style="padding:30px"><div class="spinner"></div><p style="margin-top:8px">Loading labels...</p></div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeLabelsModal()">Cancel</button>
        <button class="btn-save" id="saveLabelsBtn" onclick="saveLabelsToBackend()">
          Save Labels
        </button>
      </div>
    </div>
  </div>

  <!-- TEAM MEMBERS MODAL -->
  <div class="modal-overlay" id="teamModal">
    <div class="modal-card" style="max-width:620px;width:94%">
      <div class="modal-hdr">
        <h3>
          <svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
          Team Members
        </h3>
        <p>For WHO dropdown + Alert emails</p>
      </div>
      <div class="modal-body" id="teamModalBody" style="max-height:65vh">
        <div class="loading" style="padding:30px"><div class="spinner"></div><p style="margin-top:8px">Loading team...</p></div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeTeamModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- ATTEMPT SETTINGS MODAL -->
  <div class="modal-overlay" id="attemptsModal">
    <div class="modal-card" style="max-width:460px;width:90%">
      <div class="modal-hdr">
        <h3>
          <svg viewBox="0 0 24 24"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>
          Lead Connect Attempt Settings
        </h3>
        <p>Per-label max &mdash; Dead syncs to Lead DB</p>
      </div>
      <div class="modal-body" id="attemptsModalBody">
        <div class="as-row">
          <div>
            <div class="as-label">Max Attempts Before a Lead is Dead</div>
            <div class="as-desc">Any label counter hits this &rarr; Lead marked Dead</div>
          </div>
          <input type="number" class="as-input" id="maxAttemptsInput" min="1" max="20" value="5"/>
        </div>
        <div class="as-explainer">
          <div class="as-explainer-title">
            <svg viewBox="0 0 24 24" style="width:14px;height:14px;stroke:currentColor;fill:none;stroke-width:2;vertical-align:-2px;margin-right:3px"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
            What happens:
          </div>
          <div class="as-flow">
            <div class="att att-dead" style="display:inline-flex"><span class="att-n" style="color:#ef4444" id="asPreviewNum">5</span><span style="font-size:8px;color:#ef4444;font-weight:700">MAX</span></div>
            <span>&rarr;</span>
            <span style="color:#ef4444;font-weight:700">Row RED</span>
            <span>&rarr;</span>
            <span style="background:#fee2e2;color:#dc2626;padding:2px 8px;border-radius:10px;font-size:10px;font-weight:600">Dead</span>
            <span>&rarr;</span>
            <span style="font-weight:600">Syncs to Lead DB</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeAttemptsModal()">Cancel</button>
        <button class="btn-save" id="saveAttemptsBtn" onclick="saveAttemptsToBackend()">Save</button>
      </div>
    </div>
  </div>

  <!-- EMAIL TEMPLATES MODAL -->
  <div class="modal-overlay" id="templatesModal">
    <div class="modal-card" style="max-width:700px;width:94%">
      <div class="modal-hdr">
        <h3>
          <svg viewBox="0 0 24 24"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
          Email Templates
        </h3>
        <p>Create and manage email templates for follow-up outreach</p>
      </div>
      <div class="modal-body" id="templatesModalBody" style="max-height:65vh">
        <div class="loading" style="padding:30px"><div class="spinner"></div><p style="margin-top:8px">Loading templates...</p></div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeTemplatesModal()">Close</button>
      </div>
    </div>
  </div>

  <script>
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbw1uRg1v6Cjqp9g2J-Q3CMsUzj1KbBfuiKnLgsYjhQe1n2x9bMSShB5eCw7mhA9-StC/exec';

    let allActions = [];
    var queuedEmails = {}; // {actionId: {to, subject, body, company, templateName}}
    let maxAttempts = 5;

    // ?? Label ? CSS class map ??
    const LABEL_CSS = {
      'Email':         {pill:'p-email', tag:'t-email'},
      'Call':          {pill:'p-call',  tag:'t-call'},
      'Follow Up':     {pill:'p-fu',   tag:'t-fu'},
      'Appt Made':     {pill:'p-appt', tag:'t-appt'},
      'Proposal Sent': {pill:'p-prop', tag:'t-prop'}
    };
    const LABEL_SHORT_MAP = {'Email':'EM','Call':'CALL','Follow Up':'FU','Appt Made':'APPT','Proposal Sent':'PROP'};
    function labelShort(name) {
      if (LABEL_SHORT_MAP[name]) return LABEL_SHORT_MAP[name];
      // Auto-abbreviate: take first letters of each word, max 4 chars
      var words = name.trim().split(/\s+/);
      if (words.length === 1) return words[0].substring(0,4).toUpperCase();
      return words.map(function(w){return w[0]}).join('').substring(0,4).toUpperCase();
    }

    // Color presets for label customization
    var COLOR_PRESETS = [
      {bg:'#dbeafe', text:'#1e40af', name:'Blue'},
      {bg:'#fef3c7', text:'#92400e', name:'Amber'},
      {bg:'#d1fae5', text:'#065f46', name:'Green'},
      {bg:'#fce7f3', text:'#9d174d', name:'Pink'},
      {bg:'#e0f2fe', text:'#0369a1', name:'Sky'},
      {bg:'#e0e7ff', text:'#3730a3', name:'Indigo'},
      {bg:'#ede9fe', text:'#5b21b6', name:'Violet'},
      {bg:'#fee2e2', text:'#991b1b', name:'Red'},
      {bg:'#f1f5f9', text:'#475569', name:'Slate'},
      {bg:'#ccfbf1', text:'#0f766e', name:'Teal'},
      {bg:'#fef9c3', text:'#854d0e', name:'Yellow'},
      {bg:'#ffedd5', text:'#9a3412', name:'Orange'}
    ];

    function getLabelColors(labelName) {
      var labels = availableLabels.length > 0 ? availableLabels : DEFAULT_LABELS;
      for (var i = 0; i < labels.length; i++) {
        if (labels[i].name === labelName) {
          return { bg: labels[i].color || '#e2e8f0', text: labels[i].textColor || '#4a5568' };
        }
      }
      return { bg: '#e2e8f0', text: '#4a5568' };
    }

    // ?? Default label configs ??
    const DEFAULT_LABELS = [
      {name:'Email',         requiresDate:false, emailReminder:false, emailDaysBefore:0,  loginPopup:false, loginDaysAfter:0, trackAttempts:true, color:'#dbeafe', textColor:'#1e40af'},
      {name:'Call',          requiresDate:false, emailReminder:false, emailDaysBefore:0,  loginPopup:false, loginDaysAfter:0, trackAttempts:true, color:'#fef3c7', textColor:'#92400e'},
      {name:'Follow Up',     requiresDate:true,  emailReminder:true,  emailDaysBefore:1,  loginPopup:false, loginDaysAfter:0, trackAttempts:false, color:'#d1fae5', textColor:'#065f46'},
      {name:'Appt Made',     requiresDate:true,  emailReminder:true,  emailDaysBefore:2,  loginPopup:false, loginDaysAfter:0, trackAttempts:false, color:'#fce7f3', textColor:'#9d174d'},
      {name:'Proposal Sent', requiresDate:true,  emailReminder:true,  emailDaysBefore:1,  loginPopup:true,  loginDaysAfter:3, trackAttempts:false, color:'#e0f2fe', textColor:'#0369a1'}
    ];

    // Working copy for the modal
    let labelsConfig = [];
    let labelsExpandedIndex = -1;
    let availableLabels = [];

    // ?????????? INIT ??????????
    window.addEventListener('DOMContentLoaded', function() {
      // Load labels from cache first so initial render has them
      var cachedLabels = sessionStorage.getItem('cachedLabels');
      if (cachedLabels) {
        try { availableLabels = JSON.parse(cachedLabels); } catch(e) {}
      }
      var cachedMax = sessionStorage.getItem('cachedMaxAttempts');
      if (cachedMax) {
        try { maxAttempts = parseInt(cachedMax) || 5; } catch(e) {}
      }
      loadActions();
      loadMaxAttempts();
      loadAvailableLabels();
      loadTeamFromBackend();
      loadTemplatesFromBackend();
      // Version check
      fetch(WEB_APP_URL + '?action=version').then(function(r){return r.json()}).then(function(d){
        if(d.version !== 'v18-activity-log') showToast('WARNING: Code.gs not updated! Deploy v18 to Apps Script','error');
      }).catch(function(){});
    });

    // Manual refresh: user can reload page to get latest data

    async function loadAvailableLabels() {
      // Instant load from cache
      var cached = sessionStorage.getItem('cachedLabels');
      var cachedParsed = null;
      if (cached) {
        try { cachedParsed = JSON.parse(cached); availableLabels = cachedParsed; } catch(e) {}
      }
      try {
        var res = await fetch(WEB_APP_URL + '?action=getLabels');
        var data = await res.json();
        if (data.status === 'success' && data.labels) {
          // Merge: preserve client-only fields (trackAttempts, order) from cache if server doesn't include them
          var serverLabels = data.labels;
          if (cachedParsed && cachedParsed.length > 0) {
            for (var i = 0; i < serverLabels.length; i++) {
              var match = cachedParsed.find(function(c) { return c.name === serverLabels[i].name; });
              if (match) {
                if (serverLabels[i].trackAttempts === undefined && match.trackAttempts !== undefined) {
                  serverLabels[i].trackAttempts = match.trackAttempts;
                }
              }
            }
          }
          availableLabels = serverLabels;
        } else {
          if (!cachedParsed) availableLabels = JSON.parse(JSON.stringify(DEFAULT_LABELS));
        }
      } catch(e) {
        if (!cachedParsed) availableLabels = JSON.parse(JSON.stringify(DEFAULT_LABELS));
      }
      try { sessionStorage.setItem('cachedLabels', JSON.stringify(availableLabels)); } catch(e) {}
    }

    // ?????????? DATA LOADING ??????????
    async function loadActions() {
      try {
        // Instant load from cache
        var cached = sessionStorage.getItem('cachedActions');
        if (cached) {
          try {
            allActions = JSON.parse(cached);
            renderTable();
          } catch(e) {}
        }
        
        var res = await fetch(WEB_APP_URL + '?action=getFollowUpActions');
        var data = await res.json();
        if (data.status !== 'success') throw new Error(data.message);
        allActions = data.actions || [];
        
        // Cache for instant load on next visit
        try { sessionStorage.setItem('cachedActions', JSON.stringify(allActions)); } catch(e) {}
        
        renderTable();
      } catch(e) {
        showToast('Error loading actions: ' + e.message, 'error');
        document.getElementById('loadingState').innerHTML = '<p style="color:#ef4444">Failed to load. Check connection.</p>';
      }
    }

    async function loadMaxAttempts() {
      var cached = sessionStorage.getItem('cachedMaxAttempts');
      if (cached) { try { maxAttempts = parseInt(cached) || 5; } catch(e) {} }
      try {
        var res = await fetch(WEB_APP_URL + '?action=getMaxAttempts');
        var data = await res.json();
        if (data.status === 'success') {
          maxAttempts = data.maxAttempts || 5;
          try { sessionStorage.setItem('cachedMaxAttempts', String(maxAttempts)); } catch(e) {}
        }
      } catch(e) { /* use default */ }
    }

    // ?????????? RENDER TABLE ??????????
    // Get the most recent relevant date for sorting (dateAdded, action dates, or lastModified)
    function getMostRecentDate(a) {
      var dates = [];
      // Date added from Lead DB
      if (a.dateAdded) {
        var d = new Date(a.dateAdded);
        if (!isNaN(d.getTime())) dates.push(d.getTime());
      }
      // Action dates (future appointments, follow-ups)
      if (a.actionDates) {
        var ad = a.actionDates;
        for (var key in ad) {
          if (ad[key]) {
            var d2 = new Date(ad[key]);
            if (!isNaN(d2.getTime())) dates.push(d2.getTime());
          }
        }
      }
      // Last modified
      if (a.lastModified) {
        var d3 = new Date(a.lastModified);
        if (!isNaN(d3.getTime())) dates.push(d3.getTime());
      }
      return dates.length > 0 ? Math.max.apply(null, dates) : 0;
    }

    function renderTable() {
      var filtered = getFilteredActions();
      document.getElementById('loadingState').style.display = 'none';

      // Keep cache in sync with any local changes
      try { sessionStorage.setItem('cachedActions', JSON.stringify(allActions)); } catch(e) {}

      if (filtered.length === 0) {
        document.getElementById('fuTable').style.display = 'none';
        document.getElementById('emptyState').style.display = 'block';
        return;
      }
      document.getElementById('fuTable').style.display = 'table';
      document.getElementById('emptyState').style.display = 'none';

      // Default sort: newest relevant date at top
      filtered.sort(function(a, b) {
        var da = getMostRecentDate(a);
        var db = getMostRecentDate(b);
        // Dead leads go to bottom
        if (a.status === 'Dead' && b.status !== 'Dead') return 1;
        if (a.status !== 'Dead' && b.status === 'Dead') return -1;
        return db - da; // newest first
      });

      var tbody = document.getElementById('fuTableBody');
      var html = '';

      for (var i = 0; i < filtered.length; i++) {
        var a = filtered[i];
        var isDead = a.status === 'Dead';
        var labels = a.actions || [];
        var isUnlabeled = labels.length === 0 && !isDead;

        html += '<tr class="' + (isDead ? 'row-dead' : (isUnlabeled ? 'row-unlabeled' : '')) + '" data-id="' + a.id + '">';

        // Date Added
        var dateAddedStr = '';
        if (a.dateAdded) {
          var d = new Date(a.dateAdded);
          if (!isNaN(d.getTime())) {
            dateAddedStr = String(d.getMonth()+1).padStart(2,'0') + '/' + String(d.getDate()).padStart(2,'0') + '/' + d.getFullYear();
          } else {
            dateAddedStr = String(a.dateAdded);
          }
        }
        html += '<td style="font-size:11px;color:' + (isDead ? '#ef4444' : '#4a5568') + '">' + esc(dateAddedStr) + '</td>';

        // Company
        html += '<td><strong' + (isDead ? ' style="color:#ef4444"' : '') + '>' + (isDead ? '<svg viewBox="0 0 24 24" style="width:10px;height:10px;stroke:#ef4444;fill:#ef4444;display:inline;vertical-align:middle;margin-right:3px"><circle cx="12" cy="12" r="10"/></svg>' : '') + esc(a.company) + '</strong></td>';

        // Population
        var popDisplay = a.population || '';
        html += '<td style="font-size:11px;color:' + (isDead ? '#ef4444' : '#4a5568') + '">' + (isDead
          ? esc(popDisplay)
          : '<span class="phone-link" onclick="editPopulation(\'' + a.id + '\')">' + esc(popDisplay || 'Add') + '</span>') + '</td>';

        // Action pills
        html += '<td class="td-action">' + renderPills(labels, a.id) + '</td>';

        if (isUnlabeled) {
          // Unlabeled rows: show dashes for label-dependent columns
          html += '<td><span style="color:#d97706;font-size:12px;font-style:italic">Assign label first</span></td>'; // Action Date
          html += '<td><span style="color:#a0aec0">&mdash;</span></td>'; // Who
          html += '<td><span style="color:#a0aec0">&mdash;</span></td>'; // Attempt
          html += '<td><span style="color:#a0aec0">&mdash;</span></td>'; // Last Date
        } else {
          // Action Date
          html += '<td>' + renderActionDates(a, labels) + '</td>';
          // Who
          html += '<td>' + renderWho(a, labels) + '</td>';
          // Attempt
          html += '<td>' + renderAttempts(a, labels, isDead) + '</td>';
          // Last Date
          html += '<td>' + renderLastDates(a, labels, isDead) + '</td>';
        }

        // Phone
        html += '<td>' + (isDead
          ? '<span>' + esc(a.phone) + '</span>'
          : '<span class="phone-link" onclick="editPhone(\'' + a.id + '\')">' + esc(a.phone || 'Add') + '</span>') + '</td>';

        // Notes
        var noteDisplay = a.notes ? notesPreview(a.notes) : '+ Add Note';
        var noteClass = a.notes ? 'notes-snip' : 'notes-snip empty';
        if (isDead) noteClass += '" style="color:#ef4444';
        html += '<td><span class="' + noteClass + '" onclick="editNotes(\'' + a.id + '\')">' + noteDisplay + '</span></td>';

        // Email - compose or show queued status
        var emailCell = '';
        if (isDead) {
          emailCell = '<span style="color:#cbd5e0">&mdash;</span>';
        } else if (queuedEmails[a.id]) {
          var qr = queuedEmails[a.id].recipients || [];
          var rcCount = qr.length;
          emailCell = '<div style="display:flex;flex-direction:column;align-items:center;gap:2px">';
          emailCell += '<span style="display:inline-flex;align-items:center;gap:3px;color:#059669;font-size:11px;font-weight:600;cursor:pointer" onclick="openComposeEmail(\'' + a.id + '\')"><svg viewBox="0 0 24 24" style="width:14px;height:14px;stroke:#059669;fill:none;stroke-width:3"><polyline points="20 6 9 17 4 12"/></svg>' + rcCount + ' Ready</span>';
          emailCell += '<span style="font-size:9px;color:#ef4444;cursor:pointer;text-decoration:underline" onclick="removeQueued(\'' + a.id + '\')">remove</span>';
          emailCell += '</div>';
        } else {
          emailCell = '<button class="btn-sm" style="background:linear-gradient(135deg,#10b981,#059669)" onclick="openComposeEmail(\'' + a.id + '\')"><svg viewBox="0 0 24 24"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg> Email</button>';
        }
        html += '<td>' + emailCell + '</td>';

        // Proposal
        html += '<td>' + (isDead ? '<span style="color:#cbd5e0">&mdash;</span>' : '<button class="btn-sm" style="background:linear-gradient(135deg,#059669,#047857)" onclick="openProposal(\'' + a.leadId + '\',\'' + esc(a.company).replace(/'/g, "\\'") + '\')"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg> Create Proposal</button>') + '</td>';

        // Alert
        html += '<td>' + (isDead
          ? '<span style="font-size:12px;color:#ef4444;font-weight:700">DEAD</span>'
          : '<button class="alert-btn" onclick="sendAlert(\'' + a.id + '\')"><svg viewBox="0 0 24 24"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg> Send Rep Alert</button>') + '</td>';

        // History log
        var histCount = getActivityLog(a.id).length;
        html += '<td><button class="btn-sm" style="background:#475569;font-size:9px;padding:3px 6px" onclick="openHistoryModal(\'' + a.id + '\')"><svg viewBox="0 0 24 24" style="width:11px;height:11px"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>' + (histCount > 0 ? ' ' + histCount : '') + '</button></td>';

        html += '</tr>';
      }
      tbody.innerHTML = html;
      updateSendBar();
    }    // ?? Pill renderer ??
    function renderPills(labels, actionId) {
      if (labels.length === 0) return '<span class="pill pill-needs" onclick="assignLabel(\'' + actionId + '\')">+ Assign Label</span>';
      var h = '<div class="pill-grid" onclick="assignLabel(\'' + actionId + '\')" style="cursor:pointer" title="Click to change labels">';
      for (var i = 0; i < labels.length; i++) {
        var lc = getLabelColors(labels[i]);
        h += '<span class="pill" style="background:' + lc.bg + ';color:' + lc.text + '">' + esc(labels[i]) + '</span>';
      }
      return h + '</div>';
    }

    // ?? Stacked fields for multi-label ??
    function renderActionDates(a, labels) {
      if (labels.length <= 1) {
        var d = (a.actionDates || {})[labels[0]] || '';
        return d ? '<span class="lr-date" onclick="editActionDate(\'' + a.id + '\',\'' + labels[0] + '\')" oncontextmenu="return clearActionDate(event,\'' + a.id + '\',\'' + labels[0] + '\')">' + esc(d) + '</span>' : '<span class="lr-date" style="color:#a0aec0;border-bottom:1px dashed #cbd5e0" onclick="editActionDate(\'' + a.id + '\',\'' + labels[0] + '\')">' + '+ Add Date' + '</span>';
      }
      var h = '<div class="label-stack">';
      for (var i = 0; i < labels.length; i++) {
        var lc = getLabelColors(labels[i]);
        var short = labelShort(labels[i]);
        var dt = (a.actionDates || {})[labels[i]] || '';
        h += '<div class="label-row"><span class="lr-tag" style="background:' + lc.bg + ';color:' + lc.text + '">' + short + '</span>';
        h += dt ? '<span class="lr-date" onclick="editActionDate(\'' + a.id + '\',\'' + labels[i] + '\')" oncontextmenu="return clearActionDate(event,\'' + a.id + '\',\'' + labels[i] + '\')">' + esc(dt) + '</span>' : '<span class="lr-date" style="color:#a0aec0;border-bottom:1px dashed #cbd5e0" onclick="editActionDate(\'' + a.id + '\',\'' + labels[i] + '\')">' + '+ Date' + '</span>';
        h += '</div>';
      }
      return h + '</div>';
    }

    function renderWho(a, labels) {
      if (labels.length <= 1) {
        var w = (a.who || {})[labels[0]] || '';
        return w ? '<strong style="cursor:pointer" onclick="editWho(\'' + a.id + '\',\'' + labels[0] + '\')" oncontextmenu="return clearWho(event,\'' + a.id + '\',\'' + labels[0] + '\')">' + esc(w) + '</strong>' : '<span class="lr-date" style="color:#a0aec0;border-bottom:1px dashed #cbd5e0" onclick="editWho(\'' + a.id + '\',\'' + labels[0] + '\')">' + '+ Assign' + '</span>';
      }
      var h = '<div class="label-stack">';
      for (var i = 0; i < labels.length; i++) {
        var lc = getLabelColors(labels[i]);
        var short = labelShort(labels[i]);
        var wv = (a.who || {})[labels[i]] || '';
        h += '<div class="label-row"><span class="lr-tag" style="background:' + lc.bg + ';color:' + lc.text + '">' + short + '</span><span class="lr-val" style="cursor:pointer" onclick="editWho(\'' + a.id + '\',\'' + labels[i] + '\')"' + (wv ? ' oncontextmenu="return clearWho(event,\'' + a.id + '\',\'' + labels[i] + '\')"' : '') + '>' + (wv ? esc(wv) : '<span style="color:#a0aec0">+ Assign</span>') + '</span></div>';
      }
      return h + '</div>';
    }

    function labelTracksAttempts(labelName) {
      var labels = availableLabels.length > 0 ? availableLabels : DEFAULT_LABELS;
      for (var i = 0; i < labels.length; i++) {
        if (labels[i].name === labelName) return labels[i].trackAttempts !== false;
      }
      return true; // default to tracking
    }

    function renderAttempts(a, labels, isDead) {
      if (labels.length <= 1) {
        if (!labelTracksAttempts(labels[0])) return '<span style="color:#a0aec0">&mdash;</span>';
        var n = (a.attempts || {})[labels[0]] || 0;
        if (isDead) return '<div class="att att-dead"><span class="att-n">' + n + '</span><span style="font-size:8px;color:#ef4444;font-weight:700">MAX</span></div>';
        return '<div class="att"><button class="att-b" onclick="changeAttempt(\'' + a.id + '\',\'' + labels[0] + '\',-1)">&minus;</button><span class="att-n">' + n + '</span><button class="att-b" onclick="changeAttempt(\'' + a.id + '\',\'' + labels[0] + '\',1)">+</button></div>';
      }
      var h = '<div class="label-stack">';
      for (var i = 0; i < labels.length; i++) {
        var lc = getLabelColors(labels[i]);
        var short = labelShort(labels[i]);
        h += '<div class="label-row"><span class="lr-tag" style="background:' + lc.bg + ';color:' + lc.text + '">' + short + '</span>';
        if (!labelTracksAttempts(labels[i])) {
          h += '<span class="lr-dim">&mdash;</span>';
        } else {
          var n2 = (a.attempts || {})[labels[i]] || 0;
          if (isDead) {
            h += '<div class="att att-dead"><span class="att-n">' + n2 + '</span><span style="font-size:8px;color:#ef4444;font-weight:700">MAX</span></div>';
          } else {
            h += '<div class="att"><button class="att-b" onclick="changeAttempt(\'' + a.id + '\',\'' + labels[i] + '\',-1)">&minus;</button><span class="att-n">' + n2 + '</span><button class="att-b" onclick="changeAttempt(\'' + a.id + '\',\'' + labels[i] + '\',1)">+</button></div>';
          }
        }
        h += '</div>';
      }
      return h + '</div>';
    }

    function renderLastDates(a, labels, isDead) {
      if (labels.length <= 1) {
        if (!labelTracksAttempts(labels[0])) return '<span style="color:#a0aec0">&mdash;</span>';
        var ld = (a.lastDates || {})[labels[0]] || '';
        if (!ld) return isDead ? '<span style="color:#ef4444">&mdash;</span>' : '<span style="color:#a0aec0">&mdash;</span>';
        return isDead ? '<span style="color:#ef4444">' + esc(ld) + '</span>' : esc(ld);
      }
      var h = '<div class="label-stack">';
      for (var i = 0; i < labels.length; i++) {
        var lc = getLabelColors(labels[i]);
        var short = labelShort(labels[i]);
        var ldv = (a.lastDates || {})[labels[i]] || '';
        if (!labelTracksAttempts(labels[i])) {
          h += '<div class="label-row"><span class="lr-tag" style="background:' + lc.bg + ';color:' + lc.text + '">' + short + '</span><span class="lr-dim">&mdash;</span></div>';
        } else {
          h += '<div class="label-row"><span class="lr-tag" style="background:' + lc.bg + ';color:' + lc.text + '">' + short + '</span><span class="lr-dim">' + (ldv ? esc(ldv) : '&mdash;') + '</span></div>';
        }
      }
      return h + '</div>';
    }

    // ?????????? FILTERING ??????????
    function getFilteredActions() {
      var search = (document.getElementById('searchInput').value || '').toLowerCase();
      var actionFilter = document.getElementById('actionFilter').value;
      return allActions.filter(function(a) {
        if (actionFilter === 'Unlabeled') {
          if ((a.actions || []).length > 0) return false;
        } else if (actionFilter && !(a.actions || []).includes(actionFilter)) return false;
        if (search) {
          var haystack = (a.company + ' ' + a.phone + ' ' + a.notes + ' ' + JSON.stringify(a.who)).toLowerCase();
          if (haystack.indexOf(search) === -1) return false;
        }
        return true;
      });
    }

    function filterTable() { renderTable(); }

    // ========== EMAIL QUEUE MANAGEMENT ==========
    function updateSendBar() {
      var bar = document.getElementById('sendEmailsBar');
      var keys = Object.keys(queuedEmails);
      var totalEmails = 0;
      keys.forEach(function(id) {
        var q = queuedEmails[id];
        totalEmails += (q.recipients ? q.recipients.length : 1);
      });
      if (keys.length > 0) {
        bar.classList.add('show');
        document.getElementById('queuedCount').textContent = totalEmails + ' email' + (totalEmails !== 1 ? 's' : '') + ' ready';
        document.getElementById('sendEmailsBtnText').textContent = 'Send Emails (' + totalEmails + ')';
      } else {
        bar.classList.remove('show');
      }
    }

    function removeQueued(actionId) {
      delete queuedEmails[actionId];
      renderTable();
      updateSendBar();
    }

    function clearAllQueued() {
      queuedEmails = {};
      renderTable();
      updateSendBar();
    }

    var _composeActionId = null;
    var _composeContacts = []; // working copy of contacts for current compose

    // Email send history - stored per actionId
    function getEmailHistory(actionId) {
      try {
        var all = JSON.parse(localStorage.getItem('emailSendHistory') || '{}');
        return all[actionId] || [];
      } catch(e) { return []; }
    }

    function addEmailHistory(actionId, entry) {
      try {
        var all = JSON.parse(localStorage.getItem('emailSendHistory') || '{}');
        if (!all[actionId]) all[actionId] = [];
        all[actionId].unshift(entry); // newest first
        if (all[actionId].length > 50) all[actionId] = all[actionId].slice(0, 50);
        localStorage.setItem('emailSendHistory', JSON.stringify(all));
      } catch(e) {}
    }

    function buildEmailHistoryHTML(actionId) {
      var history = getEmailHistory(actionId);
      var h = '<div class="email-history">';
      h += '<div class="email-history-hdr"><svg viewBox="0 0 24 24" style="width:14px;height:14px;stroke:#475569;fill:none;stroke-width:2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg> Email History</div>';
      if (history.length === 0) {
        h += '<div class="email-history-empty">No emails sent yet</div>';
      } else {
        for (var i = 0; i < history.length; i++) {
          var entry = history[i];
          h += '<div class="email-history-item">';
          h += '<span class="email-history-date">' + esc(entry.date || '') + '</span>';
          h += '<span class="email-history-tmpl">' + esc(entry.template || 'Custom Email') + '</span>';
          h += '<span class="email-history-to">' + esc(entry.to || '') + '</span>';
          h += '</div>';
        }
      }
      h += '</div>';
      return h;
    }

    // ========== ACTIVITY LOG ==========
    var _activityLogCache = {}; // in-memory cache of counts per actionId

    function getActivityLog(actionId) {
      // Returns cached entries or empty - used for count display only
      return _activityLogCache[actionId] || [];
    }

    function logActivity(actionId, msg) {
      // Optimistic: increment local cache count
      if (!_activityLogCache[actionId]) _activityLogCache[actionId] = [];
      var now = new Date();
      var ts = String(now.getMonth()+1).padStart(2,'0') + '/' + String(now.getDate()).padStart(2,'0') + '/' + now.getFullYear() + ' ' + String(now.getHours()).padStart(2,'0') + ':' + String(now.getMinutes()).padStart(2,'0') + ':' + String(now.getSeconds()).padStart(2,'0');
      _activityLogCache[actionId].unshift({ts: ts, msg: msg});

      // Find company name for this action
      var a = allActions.find(function(x) { return x.id === actionId; });
      var company = a ? a.company : '';

      // Fire-and-forget POST to backend
      fetch(WEB_APP_URL, {
        method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'},
        body: JSON.stringify({action:'addActivityLog', actionId: actionId, company: company, entry: {ts: ts, msg: msg}})
      }).catch(function(e) { console.log('Activity log error:', e); });
    }

    function openHistoryModal(actionId) {
      var a = allActions.find(function(x) { return x.id === actionId; });
      var company = a ? a.company : 'Unknown';

      // Show loading modal immediately
      var overlay = document.createElement('div');
      overlay.className = 'modal-overlay show';
      overlay.id = 'historyOverlay';
      overlay.innerHTML = '<div class="modal-card" style="max-width:700px"><div class="modal-hdr" style="background:linear-gradient(135deg,#334155,#475569)"><h3><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg> Activity Log</h3><p>' + esc(company) + '</p></div><div class="modal-body" style="padding:40px;text-align:center"><div class="spinner"></div><p style="margin-top:12px;color:#64748b">Loading activity log...</p></div></div>';
      document.body.appendChild(overlay);

      // Fetch from backend
      fetch(WEB_APP_URL, {
        method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'},
        body: JSON.stringify({action:'getActivityLog', actionId: actionId})
      }).then(function(r) { return r.json(); }).then(function(data) {
        var log = (data.status === 'success' && data.entries) ? data.entries : [];
        // Update cache
        _activityLogCache[actionId] = log;

        var el = document.getElementById('historyOverlay');
        if (!el) return;

        var h = '<div class="modal-card" style="max-width:700px">';
        h += '<div class="modal-hdr" style="background:linear-gradient(135deg,#334155,#475569)"><h3><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg> Activity Log</h3><p>' + esc(company) + ' - ' + log.length + ' entries</p></div>';

        if (log.length === 0) {
          h += '<div class="log-empty"><svg viewBox="0 0 24 24" style="width:40px;height:40px;stroke:#cbd5e0;fill:none;stroke-width:1.5;display:block;margin:0 auto 12px"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>No activity recorded yet.<br><span style="font-size:12px;color:#94a3b8">Changes will appear here automatically.</span></div>';
        } else {
          h += '<div class="log-list">';
          for (var i = 0; i < log.length; i++) {
            h += '<div class="log-entry"><span class="log-ts">' + esc(log[i].ts) + '</span><span class="log-msg">' + log[i].msg + '</span></div>';
          }
          h += '</div>';
        }

        h += '<div class="modal-footer" style="justify-content:space-between">';
        if (log.length > 0) {
          h += '<button class="btn-cancel" style="color:#ef4444;border:1px solid #fecaca" onclick="clearActivityLog(\'' + actionId + '\')">Clear Log</button>';
        } else {
          h += '<span></span>';
        }
        h += '<button class="btn-cancel" onclick="this.closest(\'.modal-overlay\').remove()">Close</button>';
        h += '</div></div>';

        el.innerHTML = h;
        renderTable(); // update count badge
      }).catch(function(e) {
        var el = document.getElementById('historyOverlay');
        if (el) el.innerHTML = '<div class="modal-card" style="max-width:400px"><div class="modal-hdr" style="background:#ef4444"><h3>Error</h3></div><div class="modal-body"><p>Failed to load activity log: ' + esc(e.message) + '</p></div><div class="modal-footer"><button class="btn-cancel" onclick="this.closest(\'.modal-overlay\').remove()">Close</button></div></div>';
      });
    }

    function clearActivityLog(actionId) {
      fetch(WEB_APP_URL, {
        method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'},
        body: JSON.stringify({action:'clearActivityLog', actionId: actionId})
      }).then(function(r) { return r.json(); }).then(function(data) {
        if (data.status === 'success') {
          delete _activityLogCache[actionId];
          showToast('Activity log cleared', 'success');
        } else {
          showToast('Error: ' + (data.message || 'unknown'), 'error');
        }
      }).catch(function(e) { showToast('Error: ' + e.message, 'error'); });
      var overlay = document.getElementById('historyOverlay');
      if (overlay) overlay.remove();
      renderTable();
    }

    function openComposeEmail(actionId) {
      var a = allActions.find(function(x) { return x.id === actionId; });
      if (!a || a.status === 'Dead') return;
      _composeActionId = actionId;

      var existing = queuedEmails[actionId] || {};
      var existingSubject = existing.subject || '';
      var existingBody = existing.body || '';

      // Contacts will be fetched from Lead DB - start empty
      _composeContacts = [];
      if (existing.recipients && existing.recipients.length > 0) {
        _composeContacts = existing.recipients.map(function(r) { return {name:r.name||'', email:r.email||'', position:r.position||'', selected:true}; });
      }

      // Build template dropdown
      var templateOpts = '<option value="">-- Write custom email --</option>';
      for (var i = 0; i < emailTemplates.length; i++) {
        templateOpts += '<option value="' + i + '">' + esc(emailTemplates[i].name) + '</option>';
      }

      var overlay = document.createElement('div');
      overlay.className = 'modal-overlay show';
      overlay.id = 'composeOverlay';

      var h = '<div class="modal-card" style="max-width:580px">';
      h += '<div class="modal-hdr"><h3><svg viewBox="0 0 24 24"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg> Compose Email</h3><p>' + esc(a.company) + '</p></div>';
      h += '<div class="modal-body" style="max-height:70vh;overflow-y:auto">';

      // Email send history
      h += buildEmailHistoryHTML(actionId);

      // Recipients section - read-only, pulled from Lead DB
      h += '<div style="margin-bottom:16px"><label style="font-size:12px;font-weight:700;color:#1e293b;display:flex;align-items:center;justify-content:space-between;margin-bottom:8px"><span>Recipients <span style="font-weight:400;color:#94a3b8;font-size:10px">(from Lead Database)</span></span></label>';
      h += '<div id="composeContactsList" style="min-height:40px"><div style="padding:12px;text-align:center;color:#94a3b8;font-size:12px">Loading contacts from Lead Database...</div></div>';
      h += '<div id="compNoContacts" style="padding:14px;background:#fffbeb;border:1px solid #fde68a;border-radius:6px;font-size:12px;color:#92400e;text-align:center;display:none"><svg viewBox="0 0 24 24" style="width:14px;height:14px;stroke:#f59e0b;fill:none;stroke-width:2;vertical-align:-2px;margin-right:4px"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>No contacts found in Lead Database.<br><a href="lead-logger.html" target="_blank" style="color:#2563eb;font-weight:600;text-decoration:underline;margin-top:6px;display:inline-block">Open Lead Database to add contacts ?</a></div>';
      h += '</div>';

      // Template dropdown
      h += '<div class="et-field" style="margin-bottom:12px"><label style="font-size:12px;font-weight:600;color:#4a5568;display:block;margin-bottom:4px">Use Template <span style="font-weight:400;color:#94a3b8">(auto-fills subject & body)</span></label>';
      h += '<select id="compTemplate" onchange="window._applyTemplate(this)" style="width:100%;padding:9px 12px;border:1px solid #cbd5e0;border-radius:6px;font-size:13px">' + templateOpts + '</select></div>';

      // Subject
      h += '<div class="et-field" style="margin-bottom:12px"><label style="font-size:12px;font-weight:600;color:#4a5568;display:block;margin-bottom:4px">Subject <span style="font-weight:400;color:#94a3b8">(override template subject)</span></label>';
      h += '<input type="text" id="compSubject" value="' + esc(existingSubject) + '" placeholder="Auto-filled from template or type custom..." style="width:100%;padding:9px 12px;border:1px solid #cbd5e0;border-radius:6px;font-size:13px"/></div>';

      // Body
      h += '<div class="et-field" style="margin-bottom:12px"><label style="font-size:12px;font-weight:600;color:#4a5568;display:block;margin-bottom:4px">Body</label>';
      h += '<textarea id="compBody" placeholder="Select a template above or type your email..." style="width:100%;min-height:130px;padding:10px 12px;border:1px solid #cbd5e0;border-radius:6px;font-size:13px;resize:vertical;line-height:1.5">' + esc(existingBody) + '</textarea></div>';

      // Placeholder hints
      h += '<div style="background:#eff6ff;border:1px solid #bfdbfe;border-radius:6px;padding:8px 12px;font-size:11px;color:#1e40af;line-height:1.4">Placeholders: <strong>{Company}</strong>, <strong>{Contact}</strong>, <strong>{Phone}</strong>, <strong>{Rep}</strong>, <strong>{Date}</strong> auto-fill when sent.</div>';

      h += '</div>';
      h += '<div class="modal-footer"><button class="btn-cancel" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn-save" onclick="saveComposeEmail()">Save</button></div>';
      h += '</div>';

      overlay.innerHTML = h;
      document.body.appendChild(overlay);

      // Fetch contacts from Lead DB (single source of truth)
      if (_composeContacts.length > 0) {
        // Already have recipients from queued email
        renderComposeContacts();
      } else {
        fetchContactsFromLeadDB(a.leadId, a.company);
      }
    }

    function fetchContactsFromLeadDB(leadId, company) {
      var url = WEB_APP_URL + '?action=getLeadContacts&leadId=' + encodeURIComponent(leadId || '') + '&company=' + encodeURIComponent(company || '');
      fetch(url).then(function(r) { return r.json(); }).then(function(data) {
        if (data.status === 'success' && data.contacts && data.contacts.length > 0) {
          _composeContacts = data.contacts.map(function(c) {
            return {name:String(c.name||''), email:String(c.email||''), position:String(c.position||''), selected:true};
          });
        } else {
          _composeContacts = [];
        }
        renderComposeContacts();
      }).catch(function() {
        _composeContacts = [];
        renderComposeContacts();
      });
    }

    // Global template apply ? works from both inline onchange and direct call
    window._applyTemplate = function(sel) {
      try {
        var val = sel ? sel.value : '';
        if (val === '') return;
        var idx = parseInt(val);
        var t = emailTemplates[idx];
        if (!t) {
          showToast('Template not found at index ' + idx, 'error');
          return;
        }
        var subField = document.getElementById('compSubject');
        var bodyField = document.getElementById('compBody');
        if (!subField || !bodyField) {
          showToast('Subject or Body field not found in DOM', 'error');
          return;
        }
        var a = allActions.find(function(x) { return x.id === _composeActionId; }) || {};
        subField.value = fillPlaceholders(t.subject || '', a);
        bodyField.value = fillPlaceholders(t.body || '', a);
        if (!t.subject && !t.body) {
          showToast('Template "' + t.name + '" has empty subject and body', 'error');
        }
      } catch(e) {
        showToast('Template error: ' + e.message, 'error');
      }
    };

    function renderComposeContacts() {
      var el = document.getElementById('composeContactsList');
      if (!el) return;
      var noEl = document.getElementById('compNoContacts');
      if (noEl) noEl.style.display = _composeContacts.length === 0 ? 'block' : 'none';

      var h = '';
      for (var i = 0; i < _composeContacts.length; i++) {
        var c = _composeContacts[i];
        h += '<div style="display:flex;align-items:center;gap:8px;padding:8px 10px;background:' + (c.selected ? '#ecfdf5' : '#f8fafc') + ';border:1px solid ' + (c.selected ? '#a7f3d0' : '#e2e8f0') + ';border-radius:6px;margin-bottom:6px">';
        h += '<input type="checkbox" ' + (c.selected ? 'checked' : '') + ' onchange="_composeContacts[' + i + '].selected=this.checked;renderComposeContacts()" style="cursor:pointer;accent-color:#10b981;flex-shrink:0"/>';
        h += '<span style="flex:1;font-size:12px;font-weight:600;color:#1e293b">' + esc(c.name || '(no name)') + '</span>';
        h += '<span style="flex:1.3;font-size:12px;color:#2563eb">' + esc(c.email || '(no email)') + '</span>';
        h += '<span style="flex:0.8;font-size:11px;color:#64748b">' + esc(c.position || '') + '</span>';
        h += '</div>';
      }
      el.innerHTML = h;
    }


    function saveComposeEmail() {
      var subject = document.getElementById('compSubject').value.trim();
      var body = document.getElementById('compBody').value.trim();
      var actionId = _composeActionId;
      var a = allActions.find(function(x) { return x.id === actionId; });

      // Track which template was selected
      var templateName = 'Custom Email';
      var templateSel = document.getElementById('compTemplate');
      if (templateSel && templateSel.value !== '') {
        var idx = parseInt(templateSel.value);
        if (emailTemplates[idx]) templateName = emailTemplates[idx].name;
      }

      // Queue email if there's content
      if (subject || body) {
        var selected = _composeContacts.filter(function(c) { return c.selected && String(c.email||'').trim(); });
        if (selected.length === 0) { showToast('No contacts with email selected', 'error'); return; }
        queuedEmails[actionId] = {
          recipients: selected.map(function(c) { return {name:String(c.name||'').trim(), email:String(c.email||'').trim(), position:String(c.position||'').trim()}; }),
          subject: subject,
          body: body,
          company: a ? a.company : '',
          templateName: templateName
        };
      }

      var overlay = document.getElementById('composeOverlay');
      if (overlay) overlay.remove();
      _composeActionId = null;
      renderTable();
      updateSendBar();
    }

    function openSendReview() {
      var keys = Object.keys(queuedEmails);
      if (keys.length === 0) return;

      // Count total individual emails
      var totalEmails = 0;
      keys.forEach(function(id) {
        var q = queuedEmails[id];
        totalEmails += (q.recipients ? q.recipients.length : 1);
      });

      var h = '<div class="modal-card" style="max-width:620px"><div class="modal-hdr" style="background:linear-gradient(135deg,#059669,#047857)"><h3><svg viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg> Review & Send Emails</h3><p>' + totalEmails + ' email' + (totalEmails !== 1 ? 's' : '') + ' to ' + keys.length + ' compan' + (keys.length !== 1 ? 'ies' : 'y') + '</p></div><div class="modal-body" style="max-height:400px;overflow-y:auto">';

      for (var i = 0; i < keys.length; i++) {
        var id = keys[i];
        var q = queuedEmails[id];
        var recipients = q.recipients || [{email: q.to || '', name:'', position:''}];

        h += '<div style="padding:12px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;margin-bottom:8px" id="review-' + id + '">';
        h += '<div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">';
        h += '<div style="flex-shrink:0;width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,#10b981,#059669);color:#fff;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700">' + (i+1) + '</div>';
        h += '<div style="flex:1;min-width:0"><div style="font-weight:600;font-size:13px;color:#1e293b">' + esc(q.company) + '</div>';
        h += '<div style="font-size:11px;color:#64748b;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">Subject: ' + esc(q.subject || '(no subject)') + '</div></div>';
        h += '<button style="padding:4px 10px;border:1px solid #cbd5e0;border-radius:4px;background:#fff;color:#2563eb;font-size:11px;font-weight:600;cursor:pointer" onclick="editQueuedFromReview(\'' + id + '\')">Edit</button>';
        h += '<button style="padding:4px 8px;border:1px solid #fecaca;border-radius:4px;background:#fff;color:#ef4444;font-size:11px;font-weight:600;cursor:pointer" onclick="removeQueuedFromReview(\'' + id + '\')">&times;</button>';
        h += '</div>';

        // Show each recipient
        for (var r = 0; r < recipients.length; r++) {
          var recip = recipients[r];
          h += '<div style="display:flex;align-items:center;gap:6px;padding:4px 8px 4px 42px;font-size:12px">';
          h += '<svg viewBox="0 0 24 24" style="width:12px;height:12px;stroke:#10b981;fill:none;stroke-width:2;flex-shrink:0"><polyline points="20 6 9 17 4 12"/></svg>';
          h += '<span style="color:#2563eb">' + esc(recip.email) + '</span>';
          if (recip.name) h += '<span style="color:#64748b"> - ' + esc(recip.name) + '</span>';
          if (recip.position) h += '<span style="color:#94a3b8;font-size:11px"> (' + esc(recip.position) + ')</span>';
          h += '</div>';
        }
        h += '</div>';
      }

      h += '</div><div class="modal-footer"><button class="btn-cancel" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn-save" id="reviewSendBtn" onclick="executeQueuedSend()" style="padding:10px 24px;font-size:14px;background:linear-gradient(135deg,#10b981,#059669)"><svg viewBox="0 0 24 24" style="width:16px;height:16px;stroke:#fff;fill:none;stroke-width:2;vertical-align:-3px;margin-right:4px"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>Send ' + totalEmails + ' Email' + (totalEmails !== 1 ? 's' : '') + '</button></div></div>';

      var overlay = document.createElement('div');
      overlay.className = 'modal-overlay show';
      overlay.id = 'reviewOverlay';
      overlay.innerHTML = h;
      document.body.appendChild(overlay);
    }

    function removeQueuedFromReview(actionId) {
      delete queuedEmails[actionId];
      var el = document.getElementById('review-' + actionId);
      if (el) el.remove();
      var keys = Object.keys(queuedEmails);
      if (keys.length === 0) {
        var overlay = document.getElementById('reviewOverlay');
        if (overlay) overlay.remove();
      }
      updateSendBar();
      renderTable();
    }

    function editQueuedFromReview(actionId) {
      var overlay = document.getElementById('reviewOverlay');
      if (overlay) overlay.remove();
      openComposeEmail(actionId);
    }

    async function executeQueuedSend() {
      var keys = Object.keys(queuedEmails);
      if (keys.length === 0) return;
      var btn = document.getElementById('reviewSendBtn');
      if (btn) { btn.disabled = true; btn.textContent = 'Sending...'; }

      var sent = 0;
      var failed = 0;
      var totalSends = 0;
      keys.forEach(function(id) { var q = queuedEmails[id]; totalSends += (q.recipients ? q.recipients.length : 1); });

      var sendNum = 0;
      var actionsToUpdate = []; // track which actions need Email date/attempt updates
      for (var i = 0; i < keys.length; i++) {
        var id = keys[i];
        var q = queuedEmails[id];
        var a = allActions.find(function(x) { return x.id === id; });
        var filledSubject = a ? fillPlaceholders(q.subject || '', a) : q.subject;
        var filledBody = a ? fillPlaceholders(q.body || '', a) : q.body;
        var recipients = q.recipients || [{email: q.to || ''}];
        var actionFailed = false;

        for (var r = 0; r < recipients.length; r++) {
          sendNum++;
          if (btn) btn.textContent = 'Sending ' + sendNum + '/' + totalSends + '...';
          try {
            var res = await fetch(WEB_APP_URL, {
              method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'},
              body: JSON.stringify({
                action:'sendFollowUpEmail',
                to: recipients[r].email,
                subject: filledSubject,
                body: filledBody,
                actionId: id,
                templateId: ''
              })
            });
            var data = await res.json();
            if (data.status === 'success') {
              sent++;
              // Log to email history
              var dateStr = new Date().toLocaleDateString('en-US', {month:'2-digit', day:'2-digit', year:'numeric'});
              addEmailHistory(id, {
                date: dateStr,
                template: q.templateName || 'Custom Email',
                to: recipients[r].email,
                subject: q.subject || ''
              });
            } else { failed++; actionFailed = true; }
          } catch(e) { failed++; actionFailed = true; }
        }
        if (!actionFailed) {
          delete queuedEmails[id];
          // Log activity
          var recipNames = (q.recipients || []).map(function(rc) { return rc.email; }).join(', ');
          logActivity(id, 'Email sent to <span class="log-new">' + esc(recipNames) + '</span> | Template: ' + esc(q.templateName || 'Custom'));
          // Track this action for Email date/attempt update
          if (a) actionsToUpdate.push({id: id, action: a});
        }
      }

      var overlay = document.getElementById('reviewOverlay');
      if (overlay) overlay.remove();

      // Update Email action date + attempt count for each successfully sent company
      var emailUpdated = 0;
      var todayStr = new Date().toLocaleDateString('en-US', {month:'2-digit', day:'2-digit', year:'numeric'});
      var todayISO = new Date().toISOString().split('T')[0];
      for (var u = 0; u < actionsToUpdate.length; u++) {
        var act = actionsToUpdate[u];
        var actionLabels = act.action.actions || [];
        // Check if "Email" is one of the assigned labels
        var hasEmail = actionLabels.some(function(lb) { return lb.toLowerCase() === 'email'; });
        if (hasEmail) {
          var emailLabel = actionLabels.find(function(lb) { return lb.toLowerCase() === 'email'; });
          // Increment attempt count
          var curAttempts = (act.action.attempts && act.action.attempts[emailLabel]) ? parseInt(act.action.attempts[emailLabel]) || 0 : 0;
          var newAttempts = curAttempts + 1;
          // Update action date to today
          var updates = {};
          var attObj = Object.assign({}, act.action.attempts || {});
          attObj[emailLabel] = newAttempts;
          updates.attempts = attObj;
          var dateObj = Object.assign({}, act.action.actionDates || {});
          dateObj[emailLabel] = todayISO;
          updates.actionDates = dateObj;
          var ldObj = Object.assign({}, act.action.lastDates || {});
          ldObj[emailLabel] = todayStr;
          updates.lastDates = ldObj;

          // Optimistic UI update
          if (act.action.attempts) act.action.attempts[emailLabel] = newAttempts;
          if (act.action.actionDates) act.action.actionDates[emailLabel] = todayISO;
          if (act.action.lastDates) act.action.lastDates[emailLabel] = todayStr;

          // Save to server
          try {
            fetch(WEB_APP_URL, {
              method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'},
              body: JSON.stringify({action:'updateFollowUpAction', actionId: act.id, updates: updates})
            }).catch(function(e) { console.log('Email action update error:', e); });
            emailUpdated++;
          } catch(e) {}
        }
      }

      if (failed === 0) {
        var msg = sent + ' email' + (sent !== 1 ? 's' : '') + ' sent!';
        if (emailUpdated > 0) {
          msg += ' Action dates updated and email attempt count increased by 1.';
        }
        showToast(msg, 'success');
      } else {
        showToast(sent + ' sent, ' + failed + ' failed', 'error');
      }
      updateSendBar();
      renderTable();
    }


    // ?????????? ASSIGN LABEL (instant save on click) ??????????
    var _labelPickerActionId = null;
    var _labelPickerReorderMode = false;

    function assignLabel(actionId) {
      var existing = document.getElementById('labelPicker');
      if (existing) existing.remove();

      var action = allActions.find(function(a) { return a.id === actionId; });
      if (!action) return;
      _labelPickerActionId = actionId;
      _labelPickerReorderMode = false;

      renderLabelPicker();
    }

    function renderLabelPicker() {
      var existing = document.getElementById('labelPicker');
      if (existing) existing.remove();

      var action = allActions.find(function(a) { return a.id === _labelPickerActionId; });
      if (!action) return;

      var labels = availableLabels.length > 0 ? availableLabels : DEFAULT_LABELS;
      var currentLabels = action.actions || [];

      var pop = document.createElement('div');
      pop.id = 'labelPicker';
      pop.className = 'label-picker-overlay';

      var h = '<div class="label-picker">';
      h += '<div class="lp-header"><strong>' + (_labelPickerReorderMode ? 'Organize Labels' : 'Action Labels') + '</strong><span class="lp-company">' + esc(action.company) + '</span></div>';

      if (_labelPickerReorderMode) {
        // Reorder + Color mode
        h += '<div class="lp-body" style="gap:6px">';
        for (var i = 0; i < labels.length; i++) {
          var lb = labels[i];
          var pillStyle = 'background:' + (lb.color || '#e2e8f0') + ';color:' + (lb.textColor || '#4a5568');
          h += '<div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:10px 12px">';
          // Top row: number, pill, arrows
          h += '<div style="display:flex;align-items:center;gap:8px">';
          h += '<span style="font-size:12px;color:#94a3b8;font-weight:700;min-width:18px;text-align:center">' + (i + 1) + '</span>';
          h += '<span class="pill" style="margin:0;flex:1;' + pillStyle + '">' + esc(lb.name) + '</span>';
          h += '<div style="display:flex;gap:3px">';
          if (i > 0) {
            h += '<button onclick="reorderLabelInPicker(' + i + ',-1)" style="border:1px solid #cbd5e0;background:#fff;border-radius:4px;cursor:pointer;padding:4px 8px;display:flex;align-items:center;justify-content:center" title="Move up"><svg viewBox="0 0 24 24" style="width:14px;height:14px;stroke:#475569;fill:none;stroke-width:2.5"><polyline points="18 15 12 9 6 15"/></svg></button>';
          } else {
            h += '<span style="width:30px"></span>';
          }
          if (i < labels.length - 1) {
            h += '<button onclick="reorderLabelInPicker(' + i + ',1)" style="border:1px solid #cbd5e0;background:#fff;border-radius:4px;cursor:pointer;padding:4px 8px;display:flex;align-items:center;justify-content:center" title="Move down"><svg viewBox="0 0 24 24" style="width:14px;height:14px;stroke:#475569;fill:none;stroke-width:2.5"><polyline points="6 9 12 15 18 9"/></svg></button>';
          } else {
            h += '<span style="width:30px"></span>';
          }
          h += '</div></div>';
          // Color swatches row
          h += '<div style="display:flex;gap:4px;margin-top:8px;margin-left:26px;flex-wrap:wrap">';
          for (var c = 0; c < COLOR_PRESETS.length; c++) {
            var cp = COLOR_PRESETS[c];
            var isActive = (lb.color === cp.bg && lb.textColor === cp.text);
            h += '<button onclick="setPickerLabelColor(' + i + ',' + c + ')" style="width:22px;height:22px;border-radius:50%;border:2px solid ' + (isActive ? '#1e293b' : '#e2e8f0') + ';background:' + cp.bg + ';cursor:pointer;transition:.15s;display:flex;align-items:center;justify-content:center' + (isActive ? ';box-shadow:0 0 0 2px ' + cp.text : '') + '" title="' + esc(cp.name) + '">';
            if (isActive) h += '<svg viewBox="0 0 24 24" style="width:12px;height:12px;stroke:' + cp.text + ';fill:none;stroke-width:3"><polyline points="20 6 9 17 4 12"/></svg>';
            h += '</button>';
          }
          h += '</div>';
          h += '</div>';
        }
        h += '</div>';
        h += '<div class="lp-footer"><span class="lp-status" id="lpStatus" style="font-size:11px;color:#64748b"></span>';
        h += '<button class="tbtn" style="padding:6px 14px;font-size:12px;background:#10b981" onclick="saveReorderAndReturn()">Done</button>';
        h += '</div>';
      } else {
        // Normal label selection mode
        h += '<div class="lp-body">';
        for (var i = 0; i < labels.length; i++) {
          var lb = labels[i];
          var lc = {bg: lb.color || '#e2e8f0', text: lb.textColor || '#4a5568'};
          var isChecked = currentLabels.indexOf(lb.name) !== -1 ? ' checked' : '';
          h += '<label class="lp-chip"><input type="checkbox" value="' + esc(lb.name) + '"' + isChecked + ' onchange="toggleLabelInstant(this)"/> <span class="pill" style="background:' + lc.bg + ';color:' + lc.text + '">' + esc(lb.name) + '</span></label>';
        }
        h += '</div>';
        h += '<div class="lp-footer">';
        h += '<button onclick="enterReorderMode()" style="border:1px solid #cbd5e0;background:#fff;border-radius:5px;cursor:pointer;padding:5px 10px;display:flex;align-items:center;gap:5px;font-size:11px;font-weight:600;color:#475569" title="Reorder labels"><svg viewBox="0 0 24 24" style="width:14px;height:14px;stroke:#475569;fill:none;stroke-width:2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06A1.65 1.65 0 0 0 15 19.4a1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>Reorder</button>';
        h += '<div style="display:flex;align-items:center;gap:8px"><span class="lp-status" id="lpStatus" style="font-size:11px;color:#64748b"></span>';
        h += '<button class="tbtn" style="padding:6px 14px;font-size:12px;background:#64748b" onclick="closeLabelPicker()">Done</button></div>';
        h += '</div>';
      }
      h += '</div>';

      pop.innerHTML = h;
      pop.addEventListener('click', function(e) { if (e.target === pop) closeLabelPicker(); });
      document.body.appendChild(pop);
    }

    function enterReorderMode() {
      _labelPickerReorderMode = true;
      renderLabelPicker();
    }

    function reorderLabelInPicker(index, direction) {
      var labels = availableLabels.length > 0 ? availableLabels : DEFAULT_LABELS;
      var newIndex = index + direction;
      if (newIndex < 0 || newIndex >= labels.length) return;
      var temp = labels[index];
      labels[index] = labels[newIndex];
      labels[newIndex] = temp;
      availableLabels = labels;
      renderLabelPicker();
    }

    function setPickerLabelColor(index, presetIndex) {
      var labels = availableLabels.length > 0 ? availableLabels : DEFAULT_LABELS;
      if (index < 0 || index >= labels.length) return;
      var cp = COLOR_PRESETS[presetIndex];
      if (!cp) return;
      labels[index].color = cp.bg;
      labels[index].textColor = cp.text;
      availableLabels = labels;
      renderLabelPicker();
    }

    function saveReorderAndReturn() {
      // Save new order to cache + server
      try { sessionStorage.setItem('cachedLabels', JSON.stringify(availableLabels)); } catch(e) {}
      fetch(WEB_APP_URL, {
        method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'},
        body: JSON.stringify({ action:'saveLabels', labels: availableLabels })
      }).then(function(r){return r.json()}).then(function(data){
        if (data.status !== 'success') showToast('Reorder sync warning', 'error');
      }).catch(function(){});

      _labelPickerReorderMode = false;
      renderLabelPicker();
      renderTable();
      showToast('Labels updated', 'success');
    }

    function closeLabelPicker() {
      var el = document.getElementById('labelPicker');
      if (el) el.remove();
      _labelPickerActionId = null;
      _labelPickerReorderMode = false;
    }

    async function toggleLabelInstant(checkbox) {
      var actionId = _labelPickerActionId;
      if (!actionId) return;

      // Gather currently checked labels
      var checks = document.querySelectorAll('#labelPicker .lp-chip input');
      var selected = [];
      checks.forEach(function(c) { if (c.checked) selected.push(c.value); });

      var status = document.getElementById('lpStatus');
      if (status) { status.textContent = 'Saving...'; status.style.color = '#d97706'; }

      // Build data ? preserve existing, init new, allow empty
      var action = allActions.find(function(x) { return x.id === actionId; });
      var oldWho = action ? (action.who || {}) : {};
      var oldAttempts = action ? (action.attempts || {}) : {};
      var oldLastDates = action ? (action.lastDates || {}) : {};
      var oldActionDates = action ? (action.actionDates || {}) : {};

      var who = {}, attempts = {}, lastDates = {}, actionDates = {};
      selected.forEach(function(l) {
        who[l] = oldWho[l] || '';
        attempts[l] = oldAttempts[l] || 0;
        lastDates[l] = oldLastDates[l] || '';
        actionDates[l] = oldActionDates[l] || '';
      });

      // Optimistic UI update
      if (action) {
        var oldLabels = action.actions || [];
        var addedLabels = selected.filter(function(l) { return oldLabels.indexOf(l) === -1; });
        var removedLabels = oldLabels.filter(function(l) { return selected.indexOf(l) === -1; });
        addedLabels.forEach(function(l) { logActivity(actionId, 'Action added: <span class="log-new">' + esc(l) + '</span>'); });
        removedLabels.forEach(function(l) { logActivity(actionId, 'Action removed: <span class="log-old">' + esc(l) + '</span>'); });

        action.actions = selected;
        action.who = who;
        action.attempts = attempts;
        action.lastDates = lastDates;
        action.actionDates = actionDates;
      }
      renderTable();

      // Background save
      try {
        var res = await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: {'Content-Type':'text/plain;charset=UTF-8'},
          body: JSON.stringify({
            action: 'updateFollowUpAction',
            actionId: actionId,
            updates: {
              actions: selected,
              who: who,
              attempts: attempts,
              lastDates: lastDates,
              actionDates: actionDates
            }
          })
        });
        var data = await res.json();
        if (data.status !== 'success') throw new Error(data.message);
        if (status) { status.textContent = 'Saved'; status.style.color = '#059669'; }
      } catch(e) {
        showToast('Error: ' + e.message, 'error');
        if (status) { status.textContent = 'Error!'; status.style.color = '#ef4444'; }
      }
    }

    // ?????????? ATTEMPT CHANGE ??????????
    async function changeAttempt(actionId, label, delta) {
      // Instant UI update first
      var a = allActions.find(function(x) { return x.id === actionId; });
      if (!a) return;
      
      var oldAttempts = JSON.parse(JSON.stringify(a.attempts || {}));
      var oldVal = (a.attempts || {})[label] || 0;
      var newVal = Math.max(0, oldVal + delta);
      if (!a.attempts) a.attempts = {};
      a.attempts[label] = newVal;
      logActivity(actionId, '<span class="log-field">' + esc(label) + '</span> attempt: <span class="log-old">' + oldVal + '</span> &rarr; <span class="log-new">' + newVal + '</span>');

      // Auto-stamp last date on increment
      if (delta > 0) {
        if (!a.lastDates) a.lastDates = {};
        var today = new Date();
        var mm = String(today.getMonth()+1).padStart(2,'0');
        var dd = String(today.getDate()).padStart(2,'0');
        a.lastDates[label] = mm + '/' + dd + '/' + today.getFullYear();
      }

      renderTable(); // Instant re-render

      // Background save
      try {
        var res = await fetch(WEB_APP_URL, {
          method:'POST',
          headers:{'Content-Type':'text/plain;charset=UTF-8'},
          body: JSON.stringify({action:'updateAttempt', actionId:actionId, label:label, delta:delta})
        });
        var data = await res.json();
        if (data.status !== 'success') throw new Error(data.message);

        // Sync only the specific label from server response to avoid race conditions
        if (data.attempts) {
          if (!a.attempts) a.attempts = {};
          a.attempts[label] = data.attempts[label] !== undefined ? data.attempts[label] : a.attempts[label];
        }
        if (data.lastDates) {
          if (!a.lastDates) a.lastDates = {};
          a.lastDates[label] = data.lastDates[label] !== undefined ? data.lastDates[label] : a.lastDates[label];
        }
        if (data.isDead) {
          a.status = 'Dead';
          renderTable();
          showToast('Lead marked as DEAD - max attempts reached', 'error');
        }
      } catch(e) {
        // Revert on failure
        a.attempts = oldAttempts;
        renderTable();
        showToast('Error: ' + e.message, 'error');
      }
    }

    // ?????????? INLINE EDITS ??????????
    function editPhone(actionId) {
      var a = allActions.find(function(x) { return x.id === actionId; });
      if (!a) return;
      var td = document.querySelector('tr[data-id="' + actionId + '"] td:nth-child(9)');
      var current = a.phone || '';
      td.innerHTML = '<input class="inline-input" type="text" value="' + esc(current) + '" onblur="savePhone(\'' + actionId + '\',this)" onkeydown="if(event.key===\'Enter\')this.blur()"/>';
      td.querySelector('input').focus();
    }

    async function savePhone(actionId, input) {
      var val = input.value.trim();
      var a = allActions.find(function(x) { return x.id === actionId; });
      var oldPhone = a ? a.phone : '';
      if (a) a.phone = val;
      if (val !== oldPhone) logActivity(actionId, '<span class="log-field">Phone</span> changed: <span class="log-old">' + esc(oldPhone || 'empty') + '</span> &rarr; <span class="log-new">' + esc(val || 'empty') + '</span>');
      renderTable();

      try {
        var res = await fetch(WEB_APP_URL, {
          method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'},
          body: JSON.stringify({action:'updateFollowUpAction', actionId:actionId, updates:{phone:val}})
        });
        var data = await res.json();
        if (data.status !== 'success') throw new Error(data.message);
      } catch(e) {
        if (a) a.phone = oldPhone;
        renderTable();
        showToast('Error saving phone: ' + e.message, 'error');
      }
    }

    function editPopulation(actionId) {
      var a = allActions.find(function(x) { return x.id === actionId; });
      if (!a) return;
      var td = document.querySelector('tr[data-id="' + actionId + '"] td:nth-child(3)');
      var current = a.population || '';
      td.innerHTML = '<input class="inline-input" type="text" value="' + esc(current) + '" placeholder="e.g. 400-600" style="width:80px" onblur="savePopulation(\'' + actionId + '\',this)" onkeydown="if(event.key===\'Enter\')this.blur()"/>';
      td.querySelector('input').focus();
    }

    async function savePopulation(actionId, input) {
      var val = input.value.trim().replace(/[^0-9\-\+]/g, '');
      var a = allActions.find(function(x) { return x.id === actionId; });
      var oldPop = a ? a.population : '';
      if (a) a.population = val;
      renderTable();

      if (!a || !a.leadId) { showToast('No Lead ID - cannot sync population', 'error'); return; }

      try {
        var res = await fetch(WEB_APP_URL, {
          method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'},
          body: JSON.stringify({action:'updateLead', leadId:a.leadId, updates:{population:val}})
        });
        var data = await res.json();
        if (data.status !== 'success') throw new Error(data.message);
      } catch(e) {
        if (a) a.population = oldPop;
        renderTable();
        showToast('Error saving population: ' + e.message, 'error');
      }
    }

    function clearWho(event, actionId, label) {
      event.preventDefault();
      var a = allActions.find(function(x) { return x.id === actionId; });
      if (!a || a.status === 'Dead') return false;
      var currentWho = (a.who || {})[label] || '';
      if (!currentWho) return false;

      var oldWho = JSON.parse(JSON.stringify(a.who || {}));
      logActivity(actionId, '<span class="log-field">' + esc(label) + '</span> who removed: <span class="log-old">' + esc(currentWho) + '</span>');
      delete a.who[label];
      renderTable();

      fetch(WEB_APP_URL, {
        method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'},
        body: JSON.stringify({action:'updateFollowUpAction', actionId:actionId, updates:{who:a.who}})
      }).then(function(r){return r.json()}).then(function(data){
        if (data.status !== 'success') throw new Error(data.message);
      }).catch(function(e){
        a.who = oldWho;
        renderTable();
        showToast('Error: ' + e.message, 'error');
      });
      return false;
    }

    function clearActionDate(event, actionId, label) {
      event.preventDefault();
      var a = allActions.find(function(x) { return x.id === actionId; });
      if (!a || a.status === 'Dead') return false;
      var currentDate = (a.actionDates || {})[label] || '';
      if (!currentDate) return false;

      var oldDates = JSON.parse(JSON.stringify(a.actionDates || {}));
      logActivity(actionId, '<span class="log-field">' + esc(label) + '</span> date removed: <span class="log-old">' + esc(currentDate) + '</span>');
      delete a.actionDates[label];
      renderTable();

      fetch(WEB_APP_URL, {
        method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'},
        body: JSON.stringify({action:'updateFollowUpAction', actionId:actionId, updates:{actionDates:a.actionDates}})
      }).then(function(r){return r.json()}).then(function(data){
        if (data.status !== 'success') throw new Error(data.message);
      }).catch(function(e){
        a.actionDates = oldDates;
        renderTable();
        showToast('Error: ' + e.message, 'error');
      });
      return false;
    }

    function getFormattedDate(offset) {
      var d = new Date();
      d.setDate(d.getDate() + offset);
      return String(d.getMonth()+1).padStart(2,'0') + '/' + String(d.getDate()).padStart(2,'0') + '/' + d.getFullYear();
    }

    function quickSetDate(actionId, label, offset) {
      var formatted = getFormattedDate(offset);
      var a = allActions.find(function(x) { return x.id === actionId; });
      if (!a) return;
      var oldDates = JSON.parse(JSON.stringify(a.actionDates || {}));
      if (!a.actionDates) a.actionDates = {};
      var oldDateVal = oldDates[label] || '';
      a.actionDates[label] = formatted;
      logActivity(actionId, '<span class="log-field">' + esc(label) + '</span> date: ' + (oldDateVal ? '<span class="log-old">' + esc(oldDateVal) + '</span> &rarr; ' : '') + '<span class="log-new">' + esc(formatted) + '</span>');
      var overlay = document.querySelector('.modal-overlay.show');
      if (overlay) overlay.remove();
      renderTable();

      fetch(WEB_APP_URL, {
        method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'},
        body: JSON.stringify({action:'updateFollowUpAction', actionId:actionId, updates:{actionDates:a.actionDates}})
      }).then(function(r){return r.json()}).then(function(data){
        if (data.status !== 'success') throw new Error(data.message);
      }).catch(function(e){
        a.actionDates = oldDates;
        renderTable();
        showToast('Error: ' + e.message, 'error');
      });
    }

    function showFullDatePicker(actionId, label) {
      var a = allActions.find(function(x) { return x.id === actionId; });
      if (!a) return;
      var current = (a.actionDates || {})[label] || '';
      var inputVal = '';
      if (current) {
        var parts = current.split('/');
        if (parts.length === 3) inputVal = (parts[2].length === 2 ? '20' + parts[2] : parts[2]) + '-' + parts[0].padStart(2,'0') + '-' + parts[1].padStart(2,'0');
        else inputVal = current;
      }
      var container = document.getElementById('dateQuickBody');
      container.innerHTML = '<input type="date" id="dateEditInput" value="' + inputVal + '" style="width:100%;padding:10px;border:2px solid #e2e8f0;border-radius:8px;font-size:16px"/><div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px"><button class="btn-cancel" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn-save" onclick="saveActionDate(\'' + actionId + '\',\'' + label + '\',this)">Save</button></div>';
    }

    function editActionDate(actionId, label) {
      var a = allActions.find(function(x) { return x.id === actionId; });
      if (!a || a.status === 'Dead') return;

      var todayStr = getFormattedDate(0);
      var yesterdayStr = getFormattedDate(-1);

      var overlay = document.createElement('div');
      overlay.className = 'modal-overlay show';
      overlay.innerHTML = '<div class="modal-card" style="max-width:360px"><div class="modal-hdr"><h3><svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg> Set Date</h3><p>' + esc(label) + ' - ' + esc(a.company) + '</p></div><div class="modal-body" id="dateQuickBody"><button onclick="quickSetDate(\'' + actionId + '\',\'' + label + '\',0)" style="width:100%;padding:12px;margin-bottom:8px;border:2px solid #e2e8f0;border-radius:8px;background:#ecfdf5;color:#065f46;font-size:14px;font-weight:600;cursor:pointer;text-align:left;display:flex;justify-content:space-between;align-items:center"><span>Today</span><span style="color:#10b981;font-size:13px">' + todayStr + '</span></button><button onclick="quickSetDate(\'' + actionId + '\',\'' + label + '\',-1)" style="width:100%;padding:12px;margin-bottom:8px;border:2px solid #e2e8f0;border-radius:8px;background:#f8fafc;color:#1e293b;font-size:14px;font-weight:600;cursor:pointer;text-align:left;display:flex;justify-content:space-between;align-items:center"><span>Yesterday</span><span style="color:#64748b;font-size:13px">' + yesterdayStr + '</span></button><button onclick="showFullDatePicker(\'' + actionId + '\',\'' + label + '\')" style="width:100%;padding:12px;border:2px solid #e2e8f0;border-radius:8px;background:#fff;color:#2563eb;font-size:14px;font-weight:600;cursor:pointer;text-align:left;display:flex;align-items:center;gap:8px"><svg viewBox="0 0 24 24" style="width:16px;height:16px;stroke:currentColor;fill:none;stroke-width:2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg> Select a Date...</button></div><div class="modal-footer"><button class="btn-cancel" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button></div></div>';
      document.body.appendChild(overlay);
    }

    async function saveActionDate(actionId, label, btn) {
      var val = document.getElementById('dateEditInput').value;
      if (!val) { btn.closest('.modal-overlay').remove(); return; }
      var d = new Date(val + 'T00:00:00');
      var formatted = String(d.getMonth()+1).padStart(2,'0') + '/' + String(d.getDate()).padStart(2,'0') + '/' + d.getFullYear();

      var a = allActions.find(function(x) { return x.id === actionId; });
      if (!a) return;
      var oldDates = JSON.parse(JSON.stringify(a.actionDates || {}));
      var oldDateVal = oldDates[label] || '';
      if (!a.actionDates) a.actionDates = {};
      a.actionDates[label] = formatted;
      logActivity(actionId, '<span class="log-field">' + esc(label) + '</span> date: ' + (oldDateVal ? '<span class="log-old">' + esc(oldDateVal) + '</span> &rarr; ' : '') + '<span class="log-new">' + esc(formatted) + '</span>');
      btn.closest('.modal-overlay').remove();
      renderTable();

      try {
        var res = await fetch(WEB_APP_URL, {
          method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'},
          body: JSON.stringify({action:'updateFollowUpAction', actionId:actionId, updates:{actionDates:a.actionDates}})
        });
        var data = await res.json();
        if (data.status !== 'success') throw new Error(data.message);
      } catch(e) {
        a.actionDates = oldDates;
        renderTable();
        showToast('Error: ' + e.message, 'error');
      }
    }

    function editWho(actionId, label) {
      var a = allActions.find(function(x) { return x.id === actionId; });
      if (!a || a.status === 'Dead') return;
      var current = (a.who || {})[label] || '';

      // Ensure team is loaded
      var members = teamMembers.length > 0 ? teamMembers : DEFAULT_TEAM;
      var options = '<option value="">- Select Team Member -</option>';
      for (var i = 0; i < members.length; i++) {
        var sel = (members[i].name === current) ? ' selected' : '';
        options += '<option value="' + esc(members[i].name) + '"' + sel + '>' + esc(members[i].name) + '</option>';
      }

      var overlay = document.createElement('div');
      overlay.className = 'modal-overlay show';
      overlay.innerHTML = '<div class="modal-card" style="max-width:360px"><div class="modal-hdr"><h3><svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg> Assigned to Who?</h3><p>' + esc(label) + ' - ' + esc(a.company) + '</p></div><div class="modal-body"><select id="whoEditSelect" style="width:100%;padding:10px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px">' + options + '</select></div><div class="modal-footer"><button class="btn-cancel" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn-save" onclick="saveWho(\'' + actionId + '\',\'' + label + '\',this)">Save</button></div></div>';
      document.body.appendChild(overlay);
    }

    async function saveWho(actionId, label, btn) {
      var val = document.getElementById('whoEditSelect').value;
      var a = allActions.find(function(x) { return x.id === actionId; });
      if (!a) return;
      var oldWho = JSON.parse(JSON.stringify(a.who || {}));
      var oldWhoVal = oldWho[label] || '';
      if (!a.who) a.who = {};
      a.who[label] = val;
      if (val !== oldWhoVal) logActivity(actionId, '<span class="log-field">' + esc(label) + '</span> who: ' + (oldWhoVal ? '<span class="log-old">' + esc(oldWhoVal) + '</span> &rarr; ' : '') + '<span class="log-new">' + esc(val || 'unassigned') + '</span>');
      btn.closest('.modal-overlay').remove();
      renderTable();

      try {
        var res = await fetch(WEB_APP_URL, {
          method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'},
          body: JSON.stringify({action:'updateFollowUpAction', actionId:actionId, updates:{who:a.who}})
        });
        var data = await res.json();
        if (data.status !== 'success') throw new Error(data.message);
      } catch(e) {
        a.who = oldWho;
        renderTable();
        showToast('Error: ' + e.message, 'error');
      }
    }

    function editNotes(actionId) {
      var a = allActions.find(function(x) { return x.id === actionId; });
      if (!a) return;
      var currentNotes = String(a.notes || '');
      var entries = parseNoteEntries(currentNotes);

      var overlay = document.createElement('div');
      overlay.className = 'notes-edit-overlay';

      var card = document.createElement('div');
      card.className = 'notes-edit-card';

      // Header
      var header = document.createElement('div');
      header.className = 'notes-edit-header';
      header.innerHTML = '<div><h3>Notes</h3><div style="opacity:.8;font-size:13px;margin-top:2px">' + esc(a.company) + '</div></div>';

      // Body
      var body = document.createElement('div');
      body.className = 'notes-edit-body';
      body.style.padding = '0';

      // New entry input area
      var inputArea = document.createElement('div');
      inputArea.style.cssText = 'padding:16px 24px;border-bottom:2px solid #e2e8f0;background:#f8fafc';
      inputArea.innerHTML = '<label style="display:block;font-size:12px;font-weight:700;color:#4a5568;margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px">Add New Note</label>';
      var newInput = document.createElement('textarea');
      newInput.placeholder = 'Type a new note...';
      newInput.style.cssText = 'width:100%;min-height:80px;padding:12px;border:2px solid #e2e8f0;border-radius:8px;font-size:15px;font-family:inherit;resize:vertical;box-sizing:border-box;line-height:1.5';
      inputArea.appendChild(newInput);

      var addBtnRow = document.createElement('div');
      addBtnRow.style.cssText = 'display:flex;justify-content:flex-end;margin-top:8px';
      var addBtn = document.createElement('button');
      addBtn.type = 'button';
      addBtn.textContent = '+ Add Note';
      addBtn.style.cssText = 'background:#10b981;color:#fff;border:none;padding:8px 18px;border-radius:6px;font-size:13px;font-weight:700;cursor:pointer';
      addBtnRow.appendChild(addBtn);
      inputArea.appendChild(addBtnRow);
      body.appendChild(inputArea);

      // Entries list
      var listWrap = document.createElement('div');
      listWrap.style.cssText = 'padding:16px 24px;max-height:350px;overflow-y:auto';
      var listEl = document.createElement('div');

      function renderEntries() {
        if (entries.length === 0) {
          listEl.innerHTML = '<div style="text-align:center;color:#94a3b8;padding:24px;font-size:14px;font-style:italic">No notes yet</div>';
          return;
        }
        listEl.innerHTML = '';
        for (var i = 0; i < entries.length; i++) {
          (function(idx) {
            var e = entries[idx];
            var eCard = document.createElement('div');
            eCard.style.cssText = 'padding:12px;background:' + (idx % 2 === 0 ? '#fff' : '#f8fafc') + ';border-radius:8px;margin-bottom:8px;border:1px solid #e2e8f0';

            if (e.date) {
              var dateDiv = document.createElement('div');
              dateDiv.style.cssText = 'font-size:11px;color:#64748b;margin-bottom:4px;font-weight:600';
              dateDiv.textContent = e.date;
              eCard.appendChild(dateDiv);
            }

            var textDiv = document.createElement('div');
            textDiv.textContent = e.text;
            textDiv.style.cssText = 'font-size:14px;color:#1e293b;line-height:1.5;white-space:pre-wrap;cursor:text;padding:4px;border-radius:4px;min-height:20px';
            textDiv.contentEditable = 'true';
            textDiv.spellcheck = true;
            textDiv.addEventListener('focus', function() {
              textDiv.style.background = '#fffbeb';
              textDiv.style.outline = '2px solid #fbbf24';
            });
            textDiv.addEventListener('blur', function() {
              textDiv.style.background = '';
              textDiv.style.outline = '';
              entries[idx].text = textDiv.textContent.trim();
            });
            eCard.appendChild(textDiv);

            var btnRow = document.createElement('div');
            btnRow.style.cssText = 'text-align:right;margin-top:6px';
            var delBtn = document.createElement('button');
            delBtn.type = 'button';
            delBtn.textContent = 'Remove';
            delBtn.style.cssText = 'background:none;border:none;color:#ef4444;font-size:11px;font-weight:600;cursor:pointer;padding:2px 6px';
            delBtn.addEventListener('click', function() {
              entries.splice(idx, 1);
              renderEntries();
            });
            btnRow.appendChild(delBtn);
            eCard.appendChild(btnRow);

            listEl.appendChild(eCard);
          })(i);
        }
      }
      renderEntries();
      listWrap.appendChild(listEl);
      body.appendChild(listWrap);

      // Footer
      var footer = document.createElement('div');
      footer.className = 'notes-edit-footer';

      var cancelBtn = document.createElement('button');
      cancelBtn.style.cssText = 'background:#e2e8f0;color:#4a5568';
      cancelBtn.textContent = 'Cancel';

      var saveBtn = document.createElement('button');
      saveBtn.style.cssText = 'background:#10b981;color:#fff';
      saveBtn.textContent = 'Save Notes';

      footer.appendChild(cancelBtn);
      footer.appendChild(saveBtn);

      card.appendChild(header);
      card.appendChild(body);
      card.appendChild(footer);
      overlay.appendChild(card);
      document.body.appendChild(overlay);

      newInput.focus();

      // Add note button
      addBtn.addEventListener('click', function() {
        var text = newInput.value.trim();
        if (!text) { newInput.focus(); return; }
        var now = new Date();
        var dateStr = formatNoteDate(now);
        entries.unshift({ date: dateStr, text: text });
        newInput.value = '';
        renderEntries();
        newInput.focus();
      });

      // Enter to add, Shift+Enter for newline
      newInput.addEventListener('keydown', function(ev) {
        if (ev.key === 'Enter' && !ev.shiftKey) {
          ev.preventDefault();
          addBtn.click();
        }
      });

      // Save - instant close, background sync
      saveBtn.addEventListener('click', function() {
        var pending = newInput.value.trim();
        if (pending) {
          entries.unshift({ date: formatNoteDate(new Date()), text: pending });
        }
        var serialized = serializeNoteEntries(entries);
        overlay.remove();
        if (a) {
          if (serialized !== String(a.notes || '')) logActivity(actionId, 'Notes updated');
          a.notes = serialized;
        }
        renderTable();
        showToast('Notes saved', 'success');
        // Background sync
        fetch(WEB_APP_URL, {
          method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'},
          body: JSON.stringify({action:'updateFollowUpAction', actionId:actionId, updates:{notes:serialized}})
        }).then(function(r) { return r.json(); }).then(function(d) {
          if (d.status !== 'success') showToast('Server sync warning: ' + d.message, 'error');
        }).catch(function(e) { showToast('Notes saved locally - server sync failed', 'error'); });
      });

      // Cancel
      cancelBtn.addEventListener('click', function() { overlay.remove(); });

      // No close on overlay click or escape - only Save/Cancel
    }

    function formatNoteDate(d) {
      var m = d.getMonth() + 1;
      var day = d.getDate();
      var yr = d.getFullYear();
      var hr = d.getHours();
      var min = d.getMinutes();
      var ampm = hr >= 12 ? 'PM' : 'AM';
      hr = hr % 12 || 12;
      return String(m).padStart(2,'0') + '/' + String(day).padStart(2,'0') + '/' + yr + ' ' + hr + ':' + String(min).padStart(2,'0') + ' ' + ampm;
    }

    function parseNoteEntries(raw) {
      if (raw === null || raw === undefined) return [];
      raw = String(raw);
      if (!raw.trim()) return [];
      var lines = raw.split('\n---\n');
      var entries = [];
      for (var i = 0; i < lines.length; i++) {
        var line = lines[i].trim();
        if (!line) continue;
        var match = line.match(/^\[([^\]]+)\]\s*([\s\S]*)$/);
        if (match) {
          entries.push({ date: match[1], text: match[2].trim() });
        } else {
          entries.push({ date: '', text: line });
        }
      }
      return entries;
    }

    function serializeNoteEntries(entries) {
      var parts = [];
      for (var i = 0; i < entries.length; i++) {
        var e = entries[i];
        if (e.date) {
          parts.push('[' + e.date + '] ' + e.text);
        } else {
          parts.push(e.text);
        }
      }
      return parts.join('\n---\n');
    }

    function notesPreview(raw) {
      if (raw === null || raw === undefined) return '';
      raw = String(raw);
      var entries = parseNoteEntries(raw);
      if (!entries.length) return raw.length > 40 ? esc(raw.substring(0,40)) + '...' : esc(raw);
      var text = entries[0].text || '';
      return text.length > 40 ? esc(text.substring(0,40)) + '...' : esc(text);
    }

    // ?????????? ALERT ??????????
    async function sendAlert(actionId) {
      var a = allActions.find(function(x) { return x.id === actionId; });
      if (!a) return;

      var members = teamMembers;
      if (members.length === 0) {
        // Try one fetch if cache empty
        try {
          var resp = await fetch(WEB_APP_URL + '?action=getTeamMembers');
          var data = await resp.json();
          members = (data.status === 'success' && data.members) ? data.members : [];
          teamMembers = members;
        } catch(e) {}
      }
      if (members.length === 0) { showToast('No team members found. Add team members first.', 'error'); return; }

      var opts = '';
      for (var i = 0; i < members.length; i++) {
        opts += '<option value="' + i + '">' + esc(members[i].name) + ' - ' + esc(members[i].position || 'No position') + ' (' + esc(members[i].email) + ')</option>';
      }

        var overlay = document.createElement('div');
        overlay.className = 'modal-overlay show';
        overlay.id = 'alertOverlay';
        overlay.innerHTML = '<div class="modal-card" style="max-width:460px">' +
          '<div class="modal-hdr" style="background:linear-gradient(135deg,#dc2626,#ef4444)"><h3><svg viewBox="0 0 24 24"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg> Send Rep Alert</h3><p>' + esc(a.company) + '</p></div>' +
          '<div class="modal-body">' +
            '<div style="margin-bottom:16px"><label style="font-size:12px;font-weight:700;color:#1e293b;display:block;margin-bottom:6px">Select Sales Rep</label>' +
            '<select id="alertRepSelect" style="width:100%;padding:10px 12px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px">' + opts + '</select></div>' +
            '<div style="padding:12px;background:#fef2f2;border:1px solid #fecaca;border-radius:8px;font-size:12px;color:#4a5568;line-height:1.6">' +
              '<div style="font-weight:700;color:#dc2626;margin-bottom:6px">This will:</div>' +
              '<div>&bull; Send email alert to the selected rep</div>' +
              '<div>&bull; Auto-assign <strong>Call</strong> action to this lead</div>' +
              '<div>&bull; Set action date to <strong>today</strong></div>' +
              '<div>&bull; Assign rep as the <strong>Who</strong></div>' +
            '</div>' +
          '</div>' +
          '<div class="modal-footer"><button class="btn-cancel" onclick="document.getElementById(\'alertOverlay\').remove()">Cancel</button>' +
          '<button class="btn-save" style="background:linear-gradient(135deg,#dc2626,#ef4444)" onclick="confirmSendAlert(\'' + actionId + '\')">Send Alert</button></div></div>';
        document.body.appendChild(overlay);
        window._alertMembers = members;
    }

    async function confirmSendAlert(actionId) {
      var a = allActions.find(function(x) { return x.id === actionId; });
      if (!a) return;
      var sel = document.getElementById('alertRepSelect');
      var idx = parseInt(sel.value);
      var member = window._alertMembers[idx];
      if (!member) return;
      if (!member.email) { showToast('Selected rep has no email address', 'error'); return; }

      var btn = sel.closest('.modal-card').querySelector('.btn-save');
      btn.textContent = 'Sending...';
      btn.disabled = true;

      try {
        var resp = await fetch(WEB_APP_URL, {
          method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'},
          body: JSON.stringify({
            action:'sendRepAlert',
            repName: member.name,
            repEmail: member.email,
            company: a.company,
            phone: a.phone || '',
            contact: a.contact || '',
            notes: a.notes || '',
            actionId: actionId
          })
        });
        var data = await resp.json();
        if (data.status === 'success') {
          logActivity(actionId, 'Rep Alert sent to <span class="log-new">' + esc(member.name) + '</span> (' + esc(member.email) + ')');
          showToast('Alert sent to ' + member.name + '!', 'success');
          document.getElementById('alertOverlay').remove();
          loadActions(); // Refresh to show updated Call/Date/Who
        } else {
          showToast('Error: ' + data.message, 'error');
          btn.textContent = 'Send Alert';
          btn.disabled = false;
        }
      } catch(e) {
        showToast('Error: ' + e.message, 'error');
        btn.textContent = 'Send Alert';
        btn.disabled = false;
      }
    }

    // ?????????? NAV / PLACEHOLDER STUBS ??????????
    function goToLeadDB() { window.location.href = 'lead-logger.html'; }
    function openProposal(leadId, company) {
      if (!leadId) {
        showToast('No Lead ID found for ' + (company || 'this company') + '. Open Lead Database first.', 'error');
        return;
      }
      showToast('Loading lead data...', 'success');
      fetch(WEB_APP_URL + '?action=getLeads').then(function(r) { return r.json(); }).then(function(data) {
        if (data.status !== 'success') { showToast('Error loading leads', 'error'); return; }
        var lead = data.leads.find(function(l) { return String(l.id) === String(leadId); });
        if (!lead) { showToast('Lead not found in database', 'error'); return; }

        var params = new URLSearchParams();
        if (lead.companyName) params.append('companyName', lead.companyName);
        if (lead.contactName) params.append('contactName', lead.contactName);
        if (lead.customerAddress) params.append('customerAddress', lead.customerAddress);
        if (lead.customerZip) params.append('customerZip', lead.customerZip);
        if (lead.repName) params.append('preparedBy', lead.repName);
        if (lead.repPhone) params.append('preparedByPhone', lead.repPhone);
        if (lead.repEmail) params.append('preparedByEmail', lead.repEmail);

        var targetPage = '';
        if (lead.businessUnit === 'Quantum Solutions') {
          if (!lead.customerAddress || !lead.customerZip) {
            showToast('Missing customer address/zip required for Quantum Solutions. Edit the lead first.', 'error');
            return;
          }
          targetPage = 'quantum.html';
        } else if (lead.businessUnit === 'Abbondanza Vending') {
          targetPage = 'index.html';
        } else {
          showToast('Business unit not set for this lead. Edit in Lead Database.', 'error');
          return;
        }

        var proposalUrl = targetPage + '?' + params.toString();

        // Open in iframe modal
        var existing = document.getElementById('proposalOverlay');
        if (existing) existing.remove();

        var overlay = document.createElement('div');
        overlay.className = 'proposal-overlay';
        overlay.id = 'proposalOverlay';

        var bar = document.createElement('div');
        bar.className = 'proposal-bar';
        bar.innerHTML = '<span class="proposal-bar-title">Proposal - ' + esc(lead.companyName || company) + '</span>' +
          '<div style="display:flex;align-items:center;gap:8px">' +
            '<button class="proposal-bar-open" onclick="window.open(document.getElementById(\'proposalFrame\').src,\'_blank\')">Open in New Tab</button>' +
            '<button class="proposal-bar-close" onclick="document.getElementById(\'proposalOverlay\').remove()">Close Proposal</button>' +
          '</div>';

        var frame = document.createElement('iframe');
        frame.className = 'proposal-frame';
        frame.id = 'proposalFrame';
        frame.src = proposalUrl;

        overlay.appendChild(bar);
        overlay.appendChild(frame);
        document.body.appendChild(overlay);
      }).catch(function(e) { showToast('Error: ' + e.message, 'error'); });
    }
    async function openTeamModal() {
      // Always fetch fresh
      try {
        var res = await fetch(WEB_APP_URL + '?action=getTeamMembers');
        var data = await res.json();
        if (data.status === 'success' && data.members && data.members.length > 0) {
          teamMembers = JSON.parse(JSON.stringify(data.members));
        }
      } catch(e) {}
      document.getElementById('teamModal').classList.add('show');
      renderTeamModal();
    }

    function closeTeamModal() {
      document.getElementById('teamModal').classList.remove('show');
    }

    // Working copy for the modal
    var teamMembers = [];
    var DEFAULT_TEAM = [
      {name:'Julie Garley',    email:'julie.g@abbondanzavending.com'},
      {name:'Andrew Torres',   email:'andrew.t@abbondanzavending.com'},
      {name:'Sam Mitchell',    email:'sam.m@abbondanzavending.com'}
    ];

    // Avatar color palette
    var AVATAR_COLORS = [
      'linear-gradient(135deg,#6366f1,#8b5cf6)',
      'linear-gradient(135deg,#059669,#10b981)',
      'linear-gradient(135deg,#f59e0b,#d97706)',
      'linear-gradient(135deg,#ef4444,#dc2626)',
      'linear-gradient(135deg,#3b82f6,#2563eb)',
      'linear-gradient(135deg,#ec4899,#db2777)',
      'linear-gradient(135deg,#14b8a6,#0d9488)',
      'linear-gradient(135deg,#f97316,#ea580c)'
    ];

    function getInitials(name) {
      if (!name) return '?';
      var parts = name.trim().split(/\s+/);
      if (parts.length >= 2) return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
      return parts[0].substring(0, 2).toUpperCase();
    }

    async function loadTeamFromBackend() {
      try {
        var res = await fetch(WEB_APP_URL + '?action=getTeamMembers');
        var data = await res.json();
        if (data.status === 'success' && data.members && data.members.length > 0) {
          teamMembers = JSON.parse(JSON.stringify(data.members));
        } else {
          teamMembers = JSON.parse(JSON.stringify(DEFAULT_TEAM));
        }
      } catch(e) {
        teamMembers = JSON.parse(JSON.stringify(DEFAULT_TEAM));
      }
      renderTeamModal();
    }

    function renderTeamModal() {
      var body = document.getElementById('teamModalBody');
      var h = '';

      // Add form
      h += '<div class="tm-add-row" style="flex-wrap:wrap">';
      h += '  <input type="text" id="tmNewName" placeholder="Name" />';
      h += '  <input type="email" id="tmNewEmail" placeholder="Email" style="flex:1.2;min-width:150px" />';
      h += '  <input type="text" id="tmNewPosition" placeholder="Position" style="flex:0.8;min-width:90px;padding:8px 10px;border:1px solid #cbd5e0;border-radius:6px;font-size:12px" />';
      h += '  <input type="text" id="tmNewPhone" placeholder="Phone" style="flex:0.7;min-width:90px;padding:8px 10px;border:1px solid #cbd5e0;border-radius:6px;font-size:12px" />';
      h += '  <button class="tbtn tbtn-green" onclick="addTeamMember()" style="font-size:12px;padding:8px 14px;flex-shrink:0"><svg viewBox="0 0 24 24" style="width:14px;height:14px"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg> Add</button>';
      h += '</div>';

      if (teamMembers.length === 0) {
        h += '<div class="tm-empty"><svg viewBox="0 0 24 24" style="width:32px;height:32px;stroke:#cbd5e0;fill:none;stroke-width:1.5;margin-bottom:8px;display:block;margin-left:auto;margin-right:auto"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>No team members yet. Add someone above.</div>';
      } else {
        for (var i = 0; i < teamMembers.length; i++) {
          var m = teamMembers[i];
          var color = AVATAR_COLORS[i % AVATAR_COLORS.length];
          h += '<div class="tm-item" id="tm-item-' + i + '">';
          h += '  <div class="tm-avatar" style="background:' + color + '">' + getInitials(m.name) + '</div>';
          h += '  <div class="tm-info"><div class="tm-name">' + esc(m.name) + '</div><div class="tm-email">' + esc(m.email) + (m.position ? ' | ' + esc(m.position) : '') + (m.phone ? ' | ' + esc(m.phone) : '') + '</div></div>';
          h += '  <button class="tm-remove" style="color:#2563eb;border-color:#bfdbfe" onclick="editTeamMember(' + i + ')"><svg viewBox="0 0 24 24" style="width:12px;height:12px;stroke:currentColor;fill:none;stroke-width:2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg> Edit</button>';
          h += '  <button class="tm-remove" onclick="removeTeamMember(' + i + ')"><svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg> Remove</button>';
          h += '</div>';
        }
      }

      body.innerHTML = h;
    }

    async function addTeamMember() {
      var nameInput = document.getElementById('tmNewName');
      var emailInput = document.getElementById('tmNewEmail');
      var posInput = document.getElementById('tmNewPosition');
      var phoneInput = document.getElementById('tmNewPhone');
      var name = nameInput.value.trim();
      var email = emailInput.value.trim();
      var position = posInput ? posInput.value.trim() : '';
      var phone = phoneInput ? phoneInput.value.trim() : '';

      if (!name) { showToast('Please enter a name', 'error'); nameInput.focus(); return; }
      if (!email || email.indexOf('@') === -1) { showToast('Please enter a valid email', 'error'); emailInput.focus(); return; }

      for (var i = 0; i < teamMembers.length; i++) {
        if (teamMembers[i].email.toLowerCase() === email.toLowerCase()) {
          showToast('A team member with that email already exists', 'error');
          return;
        }
      }

      try {
        var resp = await fetch(WEB_APP_URL, {method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'},
          body: JSON.stringify({action:'addTeamMember', member:{name:name, email:email, position:position, phone:phone}})});
        var data = await resp.json();
        if (data.status === 'success') {
          teamMembers.push({id:data.id, name:name, email:email, position:position, phone:phone});
          renderTeamModal();
          showToast(name + ' added', 'success');
        } else { showToast(data.message, 'error'); }
      } catch(e) { showToast('Error: ' + e.message, 'error'); }
    }

    function removeTeamMember(index) {
      var name = teamMembers[index].name;
      var item = document.getElementById('tm-item-' + index);
      if (item) {
        item.style.background = '#fef2f2';
        item.style.borderColor = '#fecaca';
        item.innerHTML = '<span style="color:#ef4444;font-weight:600;font-size:12px">Remove "' + esc(name) + '"?</span><div style="display:flex;gap:6px;margin-left:auto"><button class="tm-remove" style="color:#4a5568;border-color:#cbd5e0" onclick="renderTeamModal()">Cancel</button><button class="tm-remove" onclick="confirmRemoveTeamMember(' + index + ')"><svg viewBox="0 0 24 24" style="width:12px;height:12px;stroke:currentColor;fill:none;stroke-width:2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg> Confirm</button></div>';
      }
    }

    async function confirmRemoveTeamMember(index) {
      var m = teamMembers[index];
      if (m && m.id) {
        try {
          await fetch(WEB_APP_URL, {method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'},
            body: JSON.stringify({action:'removeTeamMember', memberId:m.id})});
        } catch(e) {}
      }
      teamMembers.splice(index, 1);
      renderTeamModal();
      showToast('Removed', 'success');
    }

    function editTeamMember(index) {
      var m = teamMembers[index];
      var item = document.getElementById('tm-item-' + index);
      if (!item) return;
      item.innerHTML = '<div style="display:flex;gap:6px;flex:1;flex-wrap:wrap;align-items:center">' +
        '<input id="tmEdit-name-' + index + '" value="' + esc(m.name) + '" style="flex:1;min-width:80px;padding:5px 8px;border:1px solid #cbd5e0;border-radius:4px;font-size:12px"/>' +
        '<input id="tmEdit-email-' + index + '" value="' + esc(m.email) + '" style="flex:1.2;min-width:120px;padding:5px 8px;border:1px solid #cbd5e0;border-radius:4px;font-size:12px"/>' +
        '<input id="tmEdit-pos-' + index + '" value="' + esc(m.position || '') + '" placeholder="Position" style="flex:0.7;min-width:70px;padding:5px 8px;border:1px solid #cbd5e0;border-radius:4px;font-size:12px"/>' +
        '<input id="tmEdit-phone-' + index + '" value="' + esc(m.phone || '') + '" placeholder="Phone" style="flex:0.7;min-width:70px;padding:5px 8px;border:1px solid #cbd5e0;border-radius:4px;font-size:12px"/>' +
        '</div><div style="display:flex;gap:4px;margin-left:8px">' +
        '<button class="tm-remove" style="color:#059669;border-color:#a7f3d0" onclick="saveEditTeamMember(' + index + ')">Save</button>' +
        '<button class="tm-remove" style="color:#4a5568;border-color:#cbd5e0" onclick="renderTeamModal()">Cancel</button></div>';
    }

    async function saveEditTeamMember(index) {
      var m = teamMembers[index];
      var name = document.getElementById('tmEdit-name-' + index).value.trim();
      var email = document.getElementById('tmEdit-email-' + index).value.trim();
      var position = document.getElementById('tmEdit-pos-' + index).value.trim();
      var phone = document.getElementById('tmEdit-phone-' + index).value.trim();
      if (!name || !email) { showToast('Name and email required', 'error'); return; }
      m.name = name; m.email = email; m.position = position; m.phone = phone;
      if (m.id) {
        try {
          await fetch(WEB_APP_URL, {method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'},
            body: JSON.stringify({action:'updateTeamMember', member:m})});
        } catch(e) {}
      }
      renderTeamModal();
      showToast('Updated', 'success');
    }

    async function saveTeamToBackend() {
      var btn = document.getElementById('saveTeamBtn');
      btn.disabled = true;
      btn.textContent = 'Saving...';

      try {
        var res = await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
          body: JSON.stringify({ action: 'saveTeamMembers', members: teamMembers })
        });
        var data = await res.json();
        if (data.status !== 'success') throw new Error(data.message || 'Save failed');
        showToast('Team members saved', 'success');
        closeTeamModal();
      } catch(e) {
        showToast('Error saving team: ' + e.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Save Team';
      }
    }
    function openAttemptsModal() {
      document.getElementById('attemptsModal').classList.add('show');
      // Load current value
      document.getElementById('maxAttemptsInput').value = maxAttempts;
      document.getElementById('asPreviewNum').textContent = maxAttempts;
      // Live-update preview when input changes
      document.getElementById('maxAttemptsInput').oninput = function() {
        var v = parseInt(this.value) || 5;
        document.getElementById('asPreviewNum').textContent = v;
      };
    }

    function closeAttemptsModal() {
      document.getElementById('attemptsModal').classList.remove('show');
    }

    async function saveAttemptsToBackend() {
      var val = parseInt(document.getElementById('maxAttemptsInput').value);
      if (!val || val < 1 || val > 20) {
        showToast('Enter a number between 1 and 20', 'error');
        return;
      }
      var btn = document.getElementById('saveAttemptsBtn');
      btn.disabled = true;
      btn.textContent = 'Saving...';

      try {
        var res = await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
          body: JSON.stringify({ action: 'saveMaxAttempts', maxAttempts: val })
        });
        var data = await res.json();
        if (data.status !== 'success') throw new Error(data.message || 'Save failed');
        maxAttempts = val;
        showToast('Max attempts set to ' + val, 'success');
        closeAttemptsModal();
      } catch(e) {
        showToast('Error saving: ' + e.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Save';
      }
    }
    // ??????????????????????????????????????????????
    //  EMAIL TEMPLATES ? FULL IMPLEMENTATION
    // ??????????????????????????????????????????????

    var emailTemplates = [];
    var etEditingId = null; // null = list view, 'new' = adding, or template ID = editing
    var etPreviewTemplateId = null; // template being previewed for sending

    var etSendingActionId = null; // Track which action we're sending to

    function openTemplatesModal(singleId) {
      etEditingId = null;
      etSendingActionId = null;
      etPreviewTemplateId = null;
      document.getElementById('templatesModal').classList.add('show');
      renderTemplatesModal();
      // Background refresh
      loadTemplatesFromBackend();
    }

    function closeTemplatesModal() {
      document.getElementById('templatesModal').classList.remove('show');
      etEditingId = null;
      etSendingActionId = null;
      etPreviewTemplateId = null;
    }

    async function loadTemplatesFromBackend() {
      // Instant load from cache first
      try {
        var cached = localStorage.getItem('emailTemplatesCache');
        if (cached) { emailTemplates = JSON.parse(cached); }
      } catch(e) {}
      // Then refresh from backend in background
      try {
        var res = await fetch(WEB_APP_URL + '?action=getEmailTemplates');
        var data = await res.json();
        if (data.status === 'success') {
          emailTemplates = data.templates || [];
          try { localStorage.setItem('emailTemplatesCache', JSON.stringify(emailTemplates)); } catch(e) {}
        }
      } catch(e) {
        // Keep cache on error
      }
      // Only re-render if not in edit mode
      if (etEditingId === null) {
        renderTemplatesModal();
      }
    }

    function renderTemplatesModal() {
      var body = document.getElementById('templatesModalBody');
      if (!body) return;

      // If editing/adding, show form
      if (etEditingId !== null) {
        renderTemplateForm(body);
        return;
      }

      // If previewing a template for send
      if (etSendingActionId && etPreviewTemplateId) {
        renderSendPreview(body);
        return;
      }

      // List view
      var h = '';

      // Show recipient banner when sending
      if (etSendingActionId) {
        var action = allActions.find(function(x) { return x.id === etSendingActionId; });
        if (action) {
          var recipientEmail = action.email || '';
          var recipientName = action.contact || action.company || '';
          h += '<div style="padding:12px 16px;background:#ecfdf5;border:1px solid #a7f3d0;border-radius:8px;margin-bottom:12px;display:flex;align-items:center;gap:10px">';
          h += '<svg viewBox="0 0 24 24" style="width:18px;height:18px;stroke:#059669;fill:none;stroke-width:2;flex-shrink:0"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>';
          h += '<div><div style="font-weight:600;font-size:13px;color:#065f46">Sending to: ' + esc(recipientName) + '</div>';
          h += '<div style="font-size:12px;color:#047857">' + (recipientEmail ? esc(recipientEmail) : '<span style="color:#ef4444">No email on file</span>') + '</div></div></div>';
        }
      }

      h += '<div class="et-toolbar">';
      h += '  <span style="font-size:13px;color:#64748b;font-weight:500">' + emailTemplates.length + ' template' + (emailTemplates.length !== 1 ? 's' : '') + '</span>';
      h += '  <button class="tbtn tbtn-green" onclick="startNewTemplate()" style="font-size:12px;padding:8px 16px"><svg viewBox="0 0 24 24" style="width:14px;height:14px"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg> New Template</button>';
      h += '</div>';

      if (emailTemplates.length === 0) {
        h += '<div class="et-empty"><svg viewBox="0 0 24 24" style="width:36px;height:36px;stroke:#cbd5e0;fill:none;stroke-width:1.5;margin-bottom:8px;display:block;margin-left:auto;margin-right:auto"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>No email templates yet.<br>Create one to start sending follow-up emails.</div>';
      } else {
        h += '<div class="et-list">';
        for (var i = 0; i < emailTemplates.length; i++) {
          var t = emailTemplates[i];
          h += '<div class="et-item" id="et-item-' + i + '">';
          h += '  <div class="et-icon"><svg viewBox="0 0 24 24"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></div>';
          h += '  <div class="et-info"><div class="et-name">' + esc(t.name) + '</div><div class="et-subject">' + esc(t.subject || 'No subject') + '</div></div>';
          h += '  <div class="et-actions">';
          if (etSendingActionId) {
            h += '    <button class="et-btn" style="color:#059669;border-color:#a7f3d0;background:#ecfdf5" onclick="previewTemplate(\'' + t.id + '\')"><svg viewBox="0 0 24 24" style="width:11px;height:11px;stroke:currentColor;fill:none;stroke-width:2"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg> Use</button>';
          }
          h += '    <button class="et-btn edit" onclick="startEditTemplate(\'' + t.id + '\')"><svg viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg> Edit</button>';
          h += '    <button class="et-btn del" onclick="deleteTemplate(\'' + t.id + '\',' + i + ')"><svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg> Delete</button>';
          h += '  </div>';
          h += '</div>';
        }
        h += '</div>';
      }

      body.innerHTML = h;
    }

    function startNewTemplate() {
      etEditingId = 'new';
      renderTemplatesModal();
    }

    function startEditTemplate(id) {
      etEditingId = id;
      renderTemplatesModal();
    }

    function renderTemplateForm(body) {
      var isNew = (etEditingId === 'new');
      var t = isNew ? {name:'', subject:'', body:''} : emailTemplates.find(function(x) { return x.id === etEditingId; });
      if (!t) { etEditingId = null; renderTemplatesModal(); return; }

      var h = '';
      h += '<div class="et-form">';
      h += '  <h4><svg viewBox="0 0 24 24" style="width:16px;height:16px;stroke:#1e293b;fill:none;stroke-width:2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg> ' + (isNew ? 'New Template' : 'Edit Template') + '</h4>';

      h += '  <div class="et-field"><label>Template Name</label><input type="text" id="etName" value="' + esc(t.name) + '" placeholder="e.g. Initial Outreach"/></div>';
      h += '  <div class="et-field"><label>Email Subject</label><input type="text" id="etSubject" value="' + esc(t.subject) + '" placeholder="e.g. Following up on our conversation"/></div>';
      h += '  <div class="et-field"><label>Email Body</label><textarea id="etBody" placeholder="Type your email body here. Use placeholders like {Company} to auto-fill data.">' + esc(t.body) + '</textarea></div>';

      h += '  <div class="et-placeholders">';
      h += '    <div class="et-placeholders-title">Available Placeholders (click to insert):</div>';
      var placeholders = ['{Company}','{Contact}','{Email}','{Phone}','{Rep}','{Date}'];
      for (var i = 0; i < placeholders.length; i++) {
        h += '<span class="et-placeholder-tag" onclick="insertPlaceholder(\'' + placeholders[i] + '\')">' + placeholders[i] + '</span>';
      }
      h += '  </div>';

      h += '  <div class="et-form-actions">';
      h += '    <button class="btn-cancel" onclick="cancelTemplateEdit()" style="padding:7px 16px;font-size:12px">Cancel</button>';
      h += '    <button class="btn-save" id="etSaveBtn" onclick="saveTemplate()" style="padding:7px 16px;font-size:12px">' + (isNew ? 'Create Template' : 'Save Changes') + '</button>';
      h += '  </div>';
      h += '</div>';

      body.innerHTML = h;
    }

    function insertPlaceholder(tag) {
      var textarea = document.getElementById('etBody');
      if (!textarea) return;
      var start = textarea.selectionStart;
      var end = textarea.selectionEnd;
      var text = textarea.value;
      textarea.value = text.substring(0, start) + tag + text.substring(end);
      textarea.selectionStart = textarea.selectionEnd = start + tag.length;
      textarea.focus();
    }

    function cancelTemplateEdit() {
      etEditingId = null;
      renderTemplatesModal();
    }

    async function saveTemplate() {
      var name = document.getElementById('etName').value.trim();
      var subject = document.getElementById('etSubject').value.trim();
      var bodyText = document.getElementById('etBody').value.trim();

      if (!name) { showToast('Template name is required', 'error'); return; }
      if (!subject) { showToast('Subject line is required', 'error'); return; }
      if (!bodyText) { showToast('Email body is required', 'error'); return; }

      var isNew = (etEditingId === 'new');
      var payload;

      if (isNew) {
        var tempId = 'temp_' + Date.now();
        emailTemplates.push({id: tempId, name: name, subject: subject, body: bodyText});
        payload = { action: 'addEmailTemplate', template: { name: name, subject: subject, body: bodyText } };
      } else {
        var t = emailTemplates.find(function(x) { return x.id === etEditingId; });
        if (t) { t.name = name; t.subject = subject; t.body = bodyText; }
        payload = { action: 'updateEmailTemplate', templateId: etEditingId, updates: { name: name, subject: subject, body: bodyText } };
      }

      etEditingId = null;
      renderTemplatesModal();

      try {
        var res = await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
          body: JSON.stringify(payload)
        });
        var data = await res.json();
        if (data.status !== 'success') throw new Error(data.message || 'Save failed');
        // Sync real IDs from backend
        loadTemplatesFromBackend();
      } catch(e) {
        showToast('Error saving: ' + e.message, 'error');
        loadTemplatesFromBackend();
      }
    }

    function deleteTemplate(id, index) {
      var item = document.getElementById('et-item-' + index);
      var name = emailTemplates[index].name;
      if (item) {
        item.style.background = '#fef2f2';
        item.style.borderColor = '#fecaca';
        item.innerHTML = '<span style="color:#ef4444;font-weight:600;font-size:12px">Delete "' + esc(name) + '"?</span><div style="display:flex;gap:6px;margin-left:auto"><button class="et-btn" style="color:#4a5568;border-color:#cbd5e0" onclick="renderTemplatesModal()">Cancel</button><button class="et-btn del" onclick="confirmDeleteTemplate(\'' + id + '\')"><svg viewBox="0 0 24 24" style="width:11px;height:11px;stroke:currentColor;fill:none;stroke-width:2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg> Confirm</button></div>';
      }
    }

    async function confirmDeleteTemplate(id) {
      emailTemplates = emailTemplates.filter(function(t) { return t.id !== id; });
      renderTemplatesModal();

      try {
        var res = await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
          body: JSON.stringify({ action: 'deleteEmailTemplate', templateId: id })
        });
        var data = await res.json();
        if (data.status !== 'success') throw new Error(data.message || 'Delete failed');
      } catch(e) {
        showToast('Error: ' + e.message, 'error');
        loadTemplatesFromBackend();
      }
    }

    // ?? Preview template before sending ??
    function previewTemplate(templateId) {
      etPreviewTemplateId = templateId;
      renderTemplatesModal();
    }

    function fillPlaceholders(text, action) {
      if (!text && text !== 0) return '';
      text = String(text);
      var a = action || {};
      var today = new Date();
      var mm = String(today.getMonth()+1).padStart(2,'0');
      var dd = String(today.getDate()).padStart(2,'0');
      var yyyy = today.getFullYear();
      return text
        .replace(/\{Company\}/gi, a.company || '')
        .replace(/\{Contact\}/gi, a.contact || '')
        .replace(/\{Email\}/gi, a.email || '')
        .replace(/\{Phone\}/gi, a.phone || '')
        .replace(/\{Rep\}/gi, Object.values(a.who || {})[0] || '')
        .replace(/\{Date\}/gi, mm + '/' + dd + '/' + yyyy);
    }

    function renderSendPreview(body) {
      var template = emailTemplates.find(function(t) { return t.id === etPreviewTemplateId; });
      var action = allActions.find(function(a) { return a.id === etSendingActionId; });
      if (!template || !action) { etPreviewTemplateId = null; renderTemplatesModal(); return; }

      var filledSubject = fillPlaceholders(template.subject || '', action);
      var filledBody = fillPlaceholders(template.body || '', action);
      var recipientEmail = action.email || '';
      var recipientName = action.contact || action.company || '';

      var h = '';
      h += '<div style="margin-bottom:16px">';
      h += '<button class="tbtn" style="padding:5px 12px;font-size:11px;background:#64748b" onclick="etPreviewTemplateId=null;renderTemplatesModal()">\u2190 Back to Templates</button>';
      h += '</div>';

      // Recipient info
      h += '<div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:14px;margin-bottom:14px">';
      h += '<div style="display:flex;gap:12px;align-items:start;flex-wrap:wrap">';
      h += '<div style="flex:1;min-width:200px"><div style="font-size:11px;color:#64748b;font-weight:600;margin-bottom:2px">TO</div>';
      h += '<div style="font-size:13px;font-weight:600;color:#1e293b">' + esc(recipientName) + '</div>';
      h += '<div style="font-size:12px;color:#2563eb">' + (recipientEmail ? esc(recipientEmail) : '<span style="color:#ef4444;font-weight:600">No email on file &mdash; add email in Lead Database first</span>') + '</div></div>';
      h += '<div style="flex:1;min-width:200px"><div style="font-size:11px;color:#64748b;font-weight:600;margin-bottom:2px">SUBJECT</div>';
      h += '<div style="font-size:13px;color:#1e293b">' + esc(filledSubject) + '</div></div>';
      h += '</div></div>';

      // Body preview
      h += '<div style="background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:16px;margin-bottom:14px;min-height:120px">';
      h += '<div style="font-size:11px;color:#64748b;font-weight:600;margin-bottom:8px">BODY PREVIEW</div>';
      h += '<div style="font-size:13px;color:#2d3748;line-height:1.6;white-space:pre-wrap">' + esc(filledBody) + '</div>';
      h += '</div>';

      // Send button
      h += '<div style="display:flex;justify-content:flex-end;gap:8px">';
      h += '<button class="btn-cancel" onclick="etPreviewTemplateId=null;renderTemplatesModal()" style="padding:8px 16px;font-size:12px">Cancel</button>';
      if (recipientEmail) {
        h += '<button class="btn-save" id="sendEmailBtn" onclick="sendTemplateEmail()" style="padding:8px 20px;font-size:13px;background:linear-gradient(135deg,#10b981,#059669)"><svg viewBox="0 0 24 24" style="width:14px;height:14px;stroke:#fff;fill:none;stroke-width:2;vertical-align:-2px;margin-right:4px"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>Send Email</button>';
      } else {
        h += '<button disabled style="padding:8px 20px;font-size:13px;background:#cbd5e0;color:#fff;border:none;border-radius:6px;cursor:not-allowed">No Email Address</button>';
      }
      h += '</div>';

      body.innerHTML = h;
    }

    async function sendTemplateEmail() {
      var template = emailTemplates.find(function(t) { return t.id === etPreviewTemplateId; });
      var action = allActions.find(function(a) { return a.id === etSendingActionId; });
      if (!template || !action || !action.email) return;

      var btn = document.getElementById('sendEmailBtn');
      if (btn) { btn.disabled = true; btn.textContent = 'Sending...'; }

      var filledSubject = fillPlaceholders(template.subject || '', action);
      var filledBody = fillPlaceholders(template.body || '', action);

      try {
        var res = await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
          body: JSON.stringify({
            action: 'sendFollowUpEmail',
            to: action.email,
            subject: filledSubject,
            body: filledBody,
            actionId: action.id,
            templateId: template.id
          })
        });
        var data = await res.json();
        if (data.status !== 'success') throw new Error(data.message || 'Send failed');
        showToast('Email sent to ' + action.email, 'success');
        closeTemplatesModal();
      } catch(e) {
        showToast('Error sending email: ' + e.message, 'error');
        if (btn) { btn.disabled = false; btn.innerHTML = '<svg viewBox="0 0 24 24" style="width:14px;height:14px;stroke:#fff;fill:none;stroke-width:2;vertical-align:-2px;margin-right:4px"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>Send Email'; }
      }
    }


    // ??????????????????????????????????????????????
    //  LABEL SETTINGS MODAL ? FULL IMPLEMENTATION
    // ??????????????????????????????????????????????

    function openLabelsModal() {
      // Instant: use already-loaded availableLabels (cached from page init)
      if (availableLabels && availableLabels.length > 0) {
        labelsConfig = JSON.parse(JSON.stringify(availableLabels));
      } else {
        labelsConfig = JSON.parse(JSON.stringify(DEFAULT_LABELS));
      }
      document.getElementById('labelsModal').classList.add('show');
      renderLabelsModal();
      // Silent background refresh ? if server has newer data, update
      loadLabelsFromBackend(true);
    }

    function closeLabelsModal() {
      document.getElementById('labelsModal').classList.remove('show');
    }

    async function loadLabelsFromBackend(silent) {
      try {
        var res = await fetch(WEB_APP_URL + '?action=getLabels');
        var data = await res.json();
        if (data.status === 'success' && data.labels && data.labels.length > 0) {
          // Merge: preserve trackAttempts from current availableLabels if server doesn't include it
          var serverLabels = data.labels;
          if (availableLabels && availableLabels.length > 0) {
            for (var i = 0; i < serverLabels.length; i++) {
              var match = availableLabels.find(function(c) { return c.name === serverLabels[i].name; });
              if (match && serverLabels[i].trackAttempts === undefined && match.trackAttempts !== undefined) {
                serverLabels[i].trackAttempts = match.trackAttempts;
              }
            }
          }
          availableLabels = serverLabels;
          try { sessionStorage.setItem('cachedLabels', JSON.stringify(availableLabels)); } catch(e) {}
          // Only re-render if modal is open and this is the silent background refresh
          // AND user hasn't made edits yet (labelsConfig matches what we had)
          if (!silent) {
            labelsConfig = JSON.parse(JSON.stringify(serverLabels));
            renderLabelsModal();
          }
        }
      } catch(e) {
        // Silent fail - we already have cached data showing
      }
    }

    function renderLabelsModal() {
      var body = document.getElementById('labelsModalBody');
      var h = '';

      // Add label button
      h += '<div class="ls-add-row"><button class="tbtn tbtn-green" onclick="addNewLabel()" style="font-size:12px;padding:8px 16px"><svg viewBox="0 0 24 24" style="width:14px;height:14px"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg> Add Label</button></div>';

      for (var i = 0; i < labelsConfig.length; i++) {
        var lb = labelsConfig[i];
        var pillCss = getLabelPillStyle(lb);

        // Label item header row
        h += '<div class="ls-item" id="ls-item-' + i + '" style="margin-bottom:0;border-radius:8px 8px 0 0;border-bottom:1px dashed #e2e8f0">';
        h += '  <span class="ls-pill" style="' + pillCss + '">' + esc(lb.name) + '</span>';
        // Summary tags inline
        var tags = '';
        if (lb.requiresDate) {
          tags += '<span class="ls-tag ls-tag-date">Date</span>';
        }
        if (lb.emailReminder) {
          tags += '<span class="ls-tag ls-tag-email-rem">' + lb.emailDaysBefore + 'd before</span>';
        }
        if (lb.loginPopup) {
          tags += '<span class="ls-tag ls-tag-popup">' + lb.loginDaysAfter + 'd after</span>';
        }
        if (lb.trackAttempts === false) {
          tags += '<span class="ls-tag" style="background:#f1f5f9;color:#64748b">No Counter</span>';
        }
        h += '  <div class="ls-tags">' + tags + '</div>';
        h += '</div>';

        // Always-visible edit panel (no accordion)
        h += '<div class="ls-panel open" id="ls-panel-' + i + '" style="border-top:none;border-radius:0 0 8px 8px;margin-bottom:12px">';

        // Label Name
        h += '  <div class="ls-field"><label>Label Name</label><input type="text" value="' + esc(lb.name) + '" onchange="updateLabelField(' + i + ',\'name\',this.value)"/></div>';

        // Label Color
        h += '  <div class="ls-field"><label>Label Color</label>';
        h += '  <div style="display:flex;gap:5px;flex-wrap:wrap;margin-top:4px">';
        for (var c = 0; c < COLOR_PRESETS.length; c++) {
          var cp = COLOR_PRESETS[c];
          var isActive = (lb.color === cp.bg && lb.textColor === cp.text);
          h += '<button onclick="setLabelColor(' + i + ',' + c + ')" style="width:26px;height:26px;border-radius:50%;border:2px solid ' + (isActive ? '#1e293b' : '#e2e8f0') + ';background:' + cp.bg + ';cursor:pointer;transition:.15s;display:flex;align-items:center;justify-content:center' + (isActive ? ';box-shadow:0 0 0 2px ' + cp.text : '') + '" title="' + esc(cp.name) + '">';
          if (isActive) h += '<svg viewBox="0 0 24 24" style="width:14px;height:14px;stroke:' + cp.text + ';fill:none;stroke-width:3"><polyline points="20 6 9 17 4 12"/></svg>';
          h += '</button>';
        }
        h += '  </div></div>';

        // Requires Date toggle
        h += '  <div class="ls-toggle-row"><div class="ls-toggle' + (lb.requiresDate ? ' on' : '') + '" onclick="toggleLabelBool(' + i + ',\'requiresDate\',this)"></div><span class="ls-toggle-label">Requires Date</span></div>';

        // Track Attempts toggle
        h += '  <div class="ls-toggle-row"><div class="ls-toggle' + (lb.trackAttempts !== false ? ' on' : '') + '" onclick="toggleLabelBool(' + i + ',\'trackAttempts\',this)"></div><span class="ls-toggle-label">Track Attempts</span></div>';

        // Email Reminder toggle
        h += '  <div class="ls-toggle-row"><div class="ls-toggle' + (lb.emailReminder ? ' on' : '') + '" onclick="toggleLabelBool(' + i + ',\'emailReminder\',this)"></div><span class="ls-toggle-label">Email Reminder</span></div>';

        // Days BEFORE
        h += '  <div class="ls-indent" id="ls-emaildays-' + i + '" style="' + (lb.emailReminder ? '' : 'display:none') + '"><label>Days BEFORE date</label><input type="number" min="0" max="30" value="' + (lb.emailDaysBefore || 0) + '" onchange="updateLabelField(' + i + ',\'emailDaysBefore\',parseInt(this.value)||0)"/></div>';

        // Login Popup toggle
        h += '  <div class="ls-toggle-row"><div class="ls-toggle' + (lb.loginPopup ? ' on' : '') + '" onclick="toggleLabelBool(' + i + ',\'loginPopup\',this)"></div><span class="ls-toggle-label">Follow-Up Reminder (login popup)</span></div>';

        // Days AFTER
        h += '  <div class="ls-indent" id="ls-popupdays-' + i + '" style="' + (lb.loginPopup ? '' : 'display:none') + '"><label>Days AFTER date to force follow-up</label><input type="number" min="0" max="30" value="' + (lb.loginDaysAfter || 0) + '" onchange="updateLabelField(' + i + ',\'loginDaysAfter\',parseInt(this.value)||0)"/></div>';

        // Delete label
        h += '  <div class="ls-delete-row"><button class="ls-delete-btn" onclick="deleteLabel(' + i + ')"><svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg> Delete Label</button></div>';

        h += '</div>';
      }

      body.innerHTML = h;
    }

    function getLabelPillStyle(lb) {
      return 'background:' + (lb.color || '#e2e8f0') + ';color:' + (lb.textColor || '#4a5568');
    }

    function toggleLabelPanel(index) {
      // No-op ? all panels always open now
    }

    function updateLabelField(index, field, value) {
      if (index >= 0 && index < labelsConfig.length) {
        labelsConfig[index][field] = value;
        if (field === 'name') renderLabelsModal();
      }
    }

    function setLabelColor(index, presetIndex) {
      if (index < 0 || index >= labelsConfig.length) return;
      var cp = COLOR_PRESETS[presetIndex];
      if (!cp) return;
      labelsConfig[index].color = cp.bg;
      labelsConfig[index].textColor = cp.text;
      renderLabelsModal();
    }

    function toggleLabelBool(index, field, el) {
      if (index >= 0 && index < labelsConfig.length) {
        labelsConfig[index][field] = !labelsConfig[index][field];
        el.classList.toggle('on');

        if (field === 'emailReminder') {
          var indent = document.getElementById('ls-emaildays-' + index);
          if (indent) indent.style.display = labelsConfig[index][field] ? '' : 'none';
        }
        if (field === 'loginPopup') {
          var indent = document.getElementById('ls-popupdays-' + index);
          if (indent) indent.style.display = labelsConfig[index][field] ? '' : 'none';
        }
      }
    }

    function addNewLabel() {
      labelsConfig.push({
        name: 'New Label',
        requiresDate: false,
        emailReminder: false,
        emailDaysBefore: 0,
        loginPopup: false,
        loginDaysAfter: 0,
        trackAttempts: true,
        color: '#e2e8f0',
        textColor: '#4a5568'
      });
      renderLabelsModal();
      var body = document.getElementById('labelsModalBody');
      body.scrollTop = body.scrollHeight;
    }

    function moveLabelUp(index) {
      if (index <= 0) return;
      var temp = labelsConfig[index];
      labelsConfig[index] = labelsConfig[index - 1];
      labelsConfig[index - 1] = temp;
      renderLabelsModal();
    }

    function moveLabelDown(index) {
      if (index >= labelsConfig.length - 1) return;
      var temp = labelsConfig[index];
      labelsConfig[index] = labelsConfig[index + 1];
      labelsConfig[index + 1] = temp;
      renderLabelsModal();
    }

    function deleteLabel(index) {
      if (labelsConfig.length <= 1) {
        showToast('Cannot delete the last label', 'error');
        return;
      }
      var name = labelsConfig[index].name;
      var panel = document.getElementById('ls-panel-' + index);
      var item = document.getElementById('ls-item-' + index);
      if (panel) panel.remove();
      if (item) {
        item.style.background = '#fef2f2';
        item.style.borderColor = '#fecaca';
        item.innerHTML = '<span style="color:#ef4444;font-weight:600;font-size:12px">Delete "' + esc(name) + '"?</span><div style="display:flex;gap:6px;margin-left:auto"><button class="ls-edit-btn" style="color:#4a5568;border-color:#cbd5e0" onclick="renderLabelsModal()">Cancel</button><button class="ls-edit-btn" style="color:#ef4444;border-color:#fecaca;background:#fef2f2" onclick="confirmDeleteLabel(' + index + ')"><svg viewBox="0 0 24 24" style="width:12px;height:12px;stroke:currentColor;fill:none;stroke-width:2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg> Confirm</button></div>';
      }
    }

    function confirmDeleteLabel(index) {
      labelsConfig.splice(index, 1);
      renderLabelsModal();
    }

    async function saveLabelsToBackend() {
      // Validate: no empty names, no duplicates
      for (var i = 0; i < labelsConfig.length; i++) {
        if (!labelsConfig[i].name || !labelsConfig[i].name.trim()) {
          showToast('Label at position ' + (i + 1) + ' has no name', 'error');
          return;
        }
      }
      var names = labelsConfig.map(function(l) { return l.name.trim().toLowerCase(); });
      var unique = new Set(names);
      if (unique.size !== names.length) {
        showToast('Duplicate label names - each must be unique', 'error');
        return;
      }

      // INSTANT: update local cache, close modal, toast immediately
      availableLabels = JSON.parse(JSON.stringify(labelsConfig));
      try { sessionStorage.setItem('cachedLabels', JSON.stringify(availableLabels)); } catch(e) {}
      closeLabelsModal();
      showToast('Label settings saved', 'success');
      renderTable(); // Re-render table so trackAttempts changes take effect immediately

      // Background sync to server
      fetch(WEB_APP_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
        body: JSON.stringify({ action: 'saveLabels', labels: availableLabels })
      }).then(function(res) { return res.json(); }).then(function(data) {
        if (data.status !== 'success') showToast('Server sync warning: ' + (data.message || 'retry'), 'error');
      }).catch(function(e) {
        showToast('Labels saved locally - server sync failed, will retry', 'error');
      });
    }

    // ?????????? UTILS ??????????
    function esc(s) {
      if (!s) return '';
      var d = document.createElement('div');
      d.textContent = String(s);
      return d.innerHTML;
    }

    function showToast(msg, type) {
      var c = document.getElementById('toastContainer');
      var icon = type === 'success'
        ? '<svg viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>'
        : '<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>';
      var t = document.createElement('div');
      t.className = 'toast toast-' + (type || 'success');
      t.innerHTML = icon + esc(msg);
      c.appendChild(t);
      setTimeout(function() { t.style.opacity = '0'; t.style.transform = 'translateY(-20px)'; setTimeout(function() { t.remove(); }, 300); }, 3000);
    }
  </script>
</body>
</html>







