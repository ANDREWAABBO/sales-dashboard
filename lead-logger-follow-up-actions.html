<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='6' fill='%23263238'/%3E%3Cpath d='M8 22V12l5 4 5-8v14' stroke='%2310b981' stroke-width='2.5' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3Ccircle cx='24' cy='10' r='3' fill='%23f59e0b'/%3E%3C/svg%3E"/>
  <title>Follow Up Actions - Abbondanza Sales</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f5f5f5;min-height:100vh;padding:20px}
    .container{max-width:98%;margin:0 auto;background:rgba(255,255,255,.98);border-radius:20px;padding:30px;box-shadow:0 2px 8px rgba(0,0,0,.08);border:1px solid #e5e7eb}

    /* Title header */
    .title-bar{background:linear-gradient(135deg,#263238,#37474f);color:#fff;padding:18px 24px;border-radius:20px 20px 0 0;text-align:center;margin:-30px -30px 24px -30px}
    .title-bar h1{color:#fff;font-size:1.8rem;margin:0}

    /* Button row */
    .btn-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:15px}

    /* Filter row */
    .filter-row{display:flex;gap:15px;flex-wrap:wrap;align-items:center;margin-bottom:20px}
    .filter-row select{padding:10px 15px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;background:#fff;color:#2d3748;cursor:pointer;transition:border-color .2s}
    .filter-row select:focus{outline:none;border-color:#10b981}
    .filter-row input[type="search"]{padding:10px 15px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;background:#fff;color:#2d3748;width:240px;transition:border-color .2s}
    .filter-row input[type="search"]:focus{outline:none;border-color:#10b981}

    .tbtn{padding:12px 24px;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px;display:inline-flex;align-items:center;gap:8px;color:#fff;transition:.15s}
    .tbtn:hover{transform:translateY(-1px);filter:brightness(1.1)}
    .tbtn svg{width:16px;height:16px;stroke:currentColor;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;fill:none}
    .tbtn-teal{background:linear-gradient(135deg,#14b8a6,#0d9488)}
    .tbtn-orange{background:linear-gradient(135deg,#f59e0b,#d97706)}
    .tbtn-purple{background:linear-gradient(135deg,#7c3aed,#6d28d9)}
    .tbtn-blue{background:linear-gradient(135deg,#10b981,#059669)}
    .tbtn-green{background:linear-gradient(135deg,#059669,#047857)}
    .tbtn-gray{background:linear-gradient(135deg,#6b7280,#4b5563)}
    .tbtn-red{background:linear-gradient(135deg,#ef4444,#dc2626)}

    /* Batch bar */
    .batch-bar{display:none;align-items:center;gap:12px;padding:10px 24px;background:linear-gradient(135deg,#263238,#37474f);color:#fff;font-size:14px;font-weight:600}
    .batch-bar.show{display:flex}
    .batch-count{background:rgba(255,255,255,.2);padding:3px 12px;border-radius:12px;font-size:13px}
    .batch-btn{padding:7px 18px;background:#fff;color:#263238;border:none;border-radius:6px;font-weight:700;font-size:13px;cursor:pointer;display:inline-flex;align-items:center;gap:5px}
    .batch-btn:hover{background:#eff6ff}
    .batch-btn svg{width:14px;height:14px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
    .batch-btn.send{background:linear-gradient(135deg,#059669,#047857);color:#fff}
    @keyframes glowGreen{0%{box-shadow:0 0 4px rgba(5,150,105,.3)}50%{box-shadow:0 0 16px rgba(5,150,105,.8),0 0 30px rgba(5,150,105,.4)}100%{box-shadow:0 0 4px rgba(5,150,105,.3)}}
    .batch-btn.send.glow{animation:glowGreen 2s ease-in-out infinite}
    .batch-clear{background:none;border:none;color:rgba(255,255,255,.7);cursor:pointer;font-size:13px;margin-left:auto}

    /* Table wrapper */
    .table-container{overflow:auto;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.1);max-height:70vh;position:relative}
    table{width:100%;border-collapse:collapse;background:#fff;min-width:1600px}
    th{background:#263238;color:#fff;padding:10px 8px;text-align:center;font-weight:600;font-size:12px;position:sticky;top:0;z-index:10;white-space:nowrap;border-bottom:2px solid #1a2526;box-shadow:0 2px 4px rgba(0,0,0,.15)}
    th .sub{font-size:10px;opacity:.6;font-weight:400;display:block;text-transform:none;letter-spacing:0}
    td{padding:12px 8px;text-align:center;font-size:13px;color:#2d3748;border-bottom:1px solid #e2e8f0;vertical-align:middle}
    td:nth-child(2){white-space:normal;word-break:break-word;max-width:200px}
    tbody tr{border-bottom:1px solid #e2e8f0}
    tbody tr:last-child{border-bottom:none}
    tbody tr:hover td{background:#f7fafc}
    .row-dead td{background:#fef2f2!important}
    .row-unlabeled td{background:#fffbeb!important}
    .pill-needs{background:#fef3c7;color:#92400e;border:1px dashed #d97706;cursor:pointer;font-size:13px;width:auto;padding:6px 14px}
    .pill-needs:hover{background:#fde68a;transform:scale(1.05)}
    @keyframes pulse-needs{0%,100%{opacity:1}50%{opacity:.7}}

    /* Label picker popover */
    .label-picker-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:9999;display:flex;align-items:center;justify-content:center}
    .label-picker{background:#fff;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,.3);min-width:300px;max-width:400px;overflow:hidden}
    .lp-header{background:linear-gradient(135deg,#263238,#37474f);color:#fff;padding:14px 18px;display:flex;justify-content:space-between;align-items:center}
    .lp-header strong{font-size:14px}
    .lp-company{font-size:12px;opacity:.8}
    .lp-body{padding:16px 18px;display:flex;flex-direction:column;gap:8px}
    .lp-chip{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:8px;cursor:pointer;transition:.15s;border:1px solid #e2e8f0;background:#f8fafc}
    .lp-chip:hover{background:#f0f9ff;border-color:#93c5fd}
    .lp-chip input[type=checkbox]{width:16px;height:16px;accent-color:#10b981;cursor:pointer}
    .lp-chip .pill{margin:0;cursor:pointer;width:auto;padding:6px 14px}
    .lp-footer{padding:12px 18px;background:#f8fafc;display:flex;justify-content:space-between;align-items:center;gap:8px;border-top:1px solid #e2e8f0}

    /* Checkbox */
    .row-cb{width:16px;height:16px;cursor:pointer;accent-color:#10b981}

    /* Action pills */
    .pill{padding:6px 14px;border-radius:10px;font-size:13px;font-weight:600;display:inline-block;margin:2px;text-align:center;cursor:pointer;white-space:nowrap}
    .pill-grid{transition:.15s;text-align:center;line-height:2}
    .pill-grid:hover{transform:scale(1.03)}
    .pill-grid:hover .pill{opacity:.8}
    td.td-action{padding:6px 4px}
    .p-email{background:#dbeafe;color:#1e40af}
    .p-call{background:#fef3c7;color:#92400e}
    .p-fu{background:#d1fae5;color:#065f46}
    .p-appt{background:#fce7f3;color:#9d174d}
    .p-prop{background:#e0f2fe;color:#0369a1}

    /* Stacked label rows */
    .label-stack{display:flex;flex-direction:column;gap:2px;align-items:center}
    .label-row{display:flex;align-items:center;gap:4px;justify-content:center;white-space:nowrap}
    .lr-tag{padding:4px 4px;border-radius:6px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.3px;width:48px;text-align:center;flex-shrink:0;display:inline-block}
    .t-email{background:#dbeafe;color:#1e40af}
    .t-call{background:#fef3c7;color:#92400e}
    .t-fu{background:#d1fae5;color:#065f46}
    .t-appt{background:#fce7f3;color:#9d174d}
    .t-prop{background:#e0f2fe;color:#0369a1}
    .lr-val{font-size:13px;font-weight:600;color:#1e293b;cursor:pointer}
    .lr-date{font-size:13px;color:#10b981;cursor:pointer;border-bottom:1px dashed #10b981}
    .lr-dim{font-size:12px;color:#a0aec0;cursor:pointer}

    /* Attempt counter */
    .att{display:inline-flex;align-items:center;gap:1px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:4px;padding:1px 3px}
    .att-n{font-weight:700;font-size:14px;color:#263238;min-width:18px;text-align:center}
    .att-b{width:20px;height:20px;border-radius:3px;border:1px solid #cbd5e0;background:#fff;cursor:pointer;font-size:12px;font-weight:700;color:#64748b;display:flex;align-items:center;justify-content:center}
    .att-b:hover{background:#10b981;color:#fff;border-color:#10b981}
    .att-dead{border-color:#fecaca;background:#fef2f2}
    .att-dead .att-n{color:#ef4444}

    /* Editable phone */
    .phone-link{color:#10b981;cursor:pointer;border-bottom:1px dashed #10b981;font-size:13px}
    .phone-link:hover{background:#ecfdf5}

    /* Notes */
    .notes-snip{max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;cursor:pointer;color:#4a5568;display:inline-block;font-size:13px}
    .notes-snip.empty{color:#a0aec0;font-style:italic}

    /* Alert button */
    .alert-btn{padding:7px 14px;border-radius:6px;border:none;background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff;font-size:12px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:4px}
    .alert-btn svg{width:14px;height:14px;stroke:currentColor;fill:none;stroke-width:2}
    .alert-btn:hover{transform:scale(1.05)}

    /* Small action buttons */
    .btn-sm{padding:7px 14px;font-size:12px;border-radius:6px;border:none;color:#fff;cursor:pointer;font-weight:600;display:inline-flex;align-items:center;gap:4px}
    .btn-sm svg{width:14px;height:14px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}

    /* Toast */
    .toast{position:fixed;top:20px;right:20px;padding:14px 24px;border-radius:10px;color:#fff;font-weight:600;font-size:14px;z-index:9999;animation:toastIn .3s ease;box-shadow:0 8px 24px rgba(0,0,0,.2);display:flex;align-items:center;gap:8px}
    .toast svg{width:18px;height:18px;stroke:currentColor;fill:none;stroke-width:2}
    .toast-success{background:linear-gradient(135deg,#059669,#047857)}
    .toast-error{background:linear-gradient(135deg,#ef4444,#dc2626)}
    @keyframes toastIn{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}

    /* Loading */
    .loading{text-align:center;padding:60px;color:#64748b}
    .spinner{display:inline-block;width:36px;height:36px;border:3px solid #e2e8f0;border-top:3px solid #10b981;border-radius:50%;animation:spin .8s linear infinite}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .empty-state{text-align:center;padding:60px 20px;color:#64748b}
    .empty-state h3{font-size:1.1rem;margin-bottom:8px;color:#4a5568}

    /* Modal */
    .modal-overlay{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.5);justify-content:center;align-items:center}
    .modal-overlay.show{display:flex}
    .modal-card{background:#fff;border-radius:14px;max-width:500px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,.3);overflow:hidden;animation:modalIn .2s ease}
    @keyframes modalIn{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}
    .modal-hdr{background:linear-gradient(135deg,#263238,#37474f);color:#fff;padding:18px 24px}
    .modal-hdr h3{margin:0;font-size:17px;display:flex;align-items:center;gap:8px}
    .modal-hdr h3 svg{width:18px;height:18px;stroke:currentColor;fill:none;stroke-width:2}
    .modal-hdr p{margin:4px 0 0;opacity:.8;font-size:13px}
    .modal-body{padding:20px 24px;color:#2d3748;max-height:60vh;overflow-y:auto}
    .modal-footer{padding:14px 24px;background:#f8fafc;display:flex;justify-content:flex-end;gap:8px;border-top:1px solid #e2e8f0}
    .modal-footer button{padding:9px 20px;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:14px}
    .modal-footer .btn-cancel{background:#e2e8f0;color:#4a5568}
    .modal-footer .btn-save{background:#10b981;color:#fff}
    .modal-footer .btn-danger{background:#ef4444;color:#fff}

    /* Inline edit input */
    .inline-input{padding:4px 8px;border:2px solid #10b981;border-radius:6px;font-size:13px;text-align:center;width:110px}
    .inline-input:focus{outline:none;box-shadow:0 0 0 3px rgba(16,185,129,.2)}

    /* Notes edit overlay */
    .notes-edit-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.4);z-index:999;display:flex;justify-content:center;align-items:center}
    .notes-edit-card{background:#fff;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,.2);width:90vw;max-width:700px;overflow:hidden}
    .notes-edit-header{background:#263238;color:#fff;padding:16px 24px;display:flex;justify-content:space-between;align-items:center}
    .notes-edit-header h3{margin:0;font-size:16px}
    .notes-edit-body{padding:20px 24px}
    .notes-edit-body textarea{width:100%;min-height:200px;padding:14px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;font-family:inherit;resize:vertical;line-height:1.5}
    .notes-edit-body textarea:focus{outline:none;border-color:#10b981;box-shadow:0 0 0 3px rgba(16,185,129,.15)}
    .notes-edit-footer{padding:12px 24px;background:#f8fafc;display:flex;justify-content:flex-end;gap:10px;border-top:1px solid #e2e8f0}
    .notes-edit-footer button{padding:9px 20px;border:none;border-radius:6px;font-size:14px;font-weight:600;cursor:pointer}

    /* ====== LABEL SETTINGS MODAL ====== */
    .ls-add-row{display:flex;justify-content:flex-end;margin-bottom:14px}
    .ls-item{display:flex;align-items:center;gap:10px;padding:10px 12px;background:#f8fafc;border-radius:8px;margin-bottom:6px;border:1px solid #e2e8f0;transition:.15s}
    .ls-item:hover{border-color:#cbd5e0}
    .ls-pill{padding:6px 14px;border-radius:10px;font-size:13px;font-weight:700;min-width:90px;text-align:center;flex-shrink:0}
    .ls-tags{flex:1;display:flex;flex-wrap:wrap;gap:4px;min-height:22px}
    .ls-tag{padding:3px 10px;border-radius:4px;font-size:12px;font-weight:600}
    .ls-tag-date{background:#d1fae5;color:#065f46}
    .ls-tag-email-rem{background:#fef3c7;color:#92400e}
    .ls-tag-popup{background:#fee2e2;color:#dc2626}
    .ls-tag-nodate{background:#e2e8f0;color:#64748b}
    .ls-tag-norem{background:#e2e8f0;color:#64748b}
    .ls-edit-btn{padding:5px 12px;border-radius:4px;border:1px solid #cbd5e0;background:#fff;font-size:13px;cursor:pointer;color:#10b981;font-weight:600;display:inline-flex;align-items:center;gap:4px;transition:.15s;flex-shrink:0}
    .ls-edit-btn svg{width:12px;height:12px;stroke:currentColor;fill:none;stroke-width:2}
    .ls-edit-btn:hover{background:#ecfdf5;border-color:#10b981}
    .ls-panel{background:#fff;border:1px solid #e2e8f0;border-radius:10px;padding:16px;margin-bottom:10px;display:none;animation:modalIn .15s ease}
    .ls-panel.open{display:block}
    .ls-panel h4{color:#1e293b;margin-bottom:14px;font-size:14px;display:flex;align-items:center;gap:6px}
    .ls-field{margin-bottom:14px}
    .ls-field label{display:block;font-size:13px;font-weight:600;color:#4a5568;margin-bottom:4px}
    .ls-field input[type="text"],.ls-field input[type="number"]{width:100%;max-width:260px;padding:8px 10px;border:1px solid #cbd5e0;border-radius:6px;font-size:14px}
    .ls-field input:focus{outline:none;border-color:#10b981;box-shadow:0 0 0 3px rgba(16,185,129,.15)}
    .ls-toggle-row{display:flex;align-items:center;gap:10px;margin-bottom:10px}
    .ls-toggle{width:38px;height:22px;border-radius:22px;background:#cbd5e0;position:relative;cursor:pointer;transition:.2s;flex-shrink:0}
    .ls-toggle.on{background:#10b981}
    .ls-toggle::after{content:'';position:absolute;width:18px;height:18px;border-radius:50%;background:#fff;top:2px;left:2px;transition:.2s;box-shadow:0 1px 2px rgba(0,0,0,.2)}
    .ls-toggle.on::after{left:18px}
    .ls-toggle-label{font-size:14px;color:#2d3748;font-weight:500}
    .ls-indent{margin-left:48px;margin-top:-4px;margin-bottom:12px}
    .ls-indent label{display:block;font-size:13px;font-weight:600;color:#4a5568;margin-bottom:3px}
    .ls-indent input{padding:6px 8px;border:1px solid #cbd5e0;border-radius:5px;font-size:13px;width:80px}
    .ls-indent input:focus{outline:none;border-color:#10b981}
    .ls-delete-row{display:flex;justify-content:flex-end;margin-top:10px;padding-top:10px;border-top:1px solid #f1f5f9}
    .ls-delete-btn{padding:5px 12px;border-radius:5px;border:1px solid #fecaca;background:#fff;font-size:13px;cursor:pointer;color:#ef4444;font-weight:600;display:inline-flex;align-items:center;gap:4px;transition:.15s}
    .ls-delete-btn svg{width:12px;height:12px;stroke:currentColor;fill:none;stroke-width:2}
    .ls-delete-btn:hover{background:#fef2f2;border-color:#ef4444}

    /* Center loading modal */
    .loading-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.4);z-index:9999;display:flex;justify-content:center;align-items:center}
    .loading-modal-card{background:#fff;padding:30px 50px;border-radius:12px;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,.3)}
    .loading-modal-card .spinner{margin-bottom:10px}
    .loading-modal-card p{color:#4a5568;font-size:14px;font-weight:600}

    /* ====== TEAM MEMBERS MODAL ====== */
    .tm-add-row{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap}
    .tm-add-row input{flex:1;min-width:120px;padding:8px 10px;border:1px solid #cbd5e0;border-radius:6px;font-size:14px}
    .tm-add-row input:focus{outline:none;border-color:#10b981;box-shadow:0 0 0 3px rgba(16,185,129,.15)}
    .tm-item{display:flex;align-items:center;gap:10px;padding:10px 12px;background:#f8fafc;border-radius:8px;margin-bottom:6px;border:1px solid #e2e8f0;transition:.15s}
    .tm-item:hover{border-color:#cbd5e0}
    .tm-avatar{width:32px;height:32px;border-radius:50%;color:#fff;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0}
    .tm-info{flex:1;min-width:0}
    .tm-name{font-weight:600;font-size:14px;color:#1e293b}
    .tm-email{font-size:13px;color:#64748b;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .tm-remove{padding:4px 10px;border-radius:4px;border:1px solid #fecaca;background:#fff;font-size:13px;cursor:pointer;color:#ef4444;font-weight:600;display:inline-flex;align-items:center;gap:4px;transition:.15s;flex-shrink:0}
    .tm-remove svg{width:12px;height:12px;stroke:currentColor;fill:none;stroke-width:2}
    .tm-remove:hover{background:#fef2f2;border-color:#ef4444}
    .tm-empty{text-align:center;padding:24px;color:#94a3b8;font-size:13px}

    /* ====== ATTEMPT SETTINGS MODAL ====== */
    .as-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0}
    .as-label{font-weight:600;font-size:14px;color:#1e293b}
    .as-desc{font-size:13px;color:#64748b;margin-top:2px}
    .as-input{width:68px;text-align:center;font-size:18px;font-weight:700;padding:8px;border:2px solid #e2e8f0;border-radius:8px;color:#263238}
    .as-input:focus{outline:none;border-color:#10b981;box-shadow:0 0 0 3px rgba(16,185,129,.15)}
    .as-explainer{margin-top:18px;padding:14px;background:#fef2f2;border-radius:8px;border:1px solid #fecaca}
    .as-explainer-title{font-weight:700;color:#dc2626;margin-bottom:8px;font-size:14px}
    .as-flow{display:flex;align-items:center;gap:8px;font-size:13px;color:#4a5568;flex-wrap:wrap}

    /* ====== EMAIL TEMPLATES MODAL ====== */
    .et-toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;gap:8px}
    .et-list{margin-bottom:0}
    .et-item{display:flex;align-items:center;gap:10px;padding:12px;background:#f8fafc;border-radius:8px;margin-bottom:6px;border:1px solid #e2e8f0;cursor:pointer;transition:.15s}
    .et-item:hover{border-color:#10b981;background:#ecfdf5}
    .et-item.active{border-color:#10b981;background:#ecfdf5;box-shadow:0 0 0 2px rgba(16,185,129,.2)}
    .et-icon{width:36px;height:36px;border-radius:8px;background:linear-gradient(135deg,#10b981,#059669);color:#fff;display:flex;align-items:center;justify-content:center;flex-shrink:0}
    .et-icon svg{width:18px;height:18px;stroke:currentColor;fill:none;stroke-width:2}
    .et-info{flex:1;min-width:0}
    .et-name{font-weight:600;font-size:14px;color:#1e293b}
    .et-subject{font-size:13px;color:#64748b;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .et-actions{display:flex;gap:4px;flex-shrink:0}
    .et-btn{padding:5px 10px;border-radius:4px;border:1px solid #cbd5e0;background:#fff;font-size:12px;cursor:pointer;font-weight:600;display:inline-flex;align-items:center;gap:3px;transition:.15s}
    .et-btn svg{width:11px;height:11px;stroke:currentColor;fill:none;stroke-width:2}
    .et-btn.edit{color:#10b981;border-color:#a7f3d0}
    .et-btn.edit:hover{background:#ecfdf5}
    .et-btn.del{color:#ef4444;border-color:#fecaca}
    .et-btn.del:hover{background:#fef2f2}
    .et-empty{text-align:center;padding:30px;color:#94a3b8;font-size:13px}
    .et-form{background:#fff;border:1px solid #e2e8f0;border-radius:10px;padding:16px;margin-bottom:10px}
    .et-form h4{color:#1e293b;margin-bottom:14px;font-size:14px;display:flex;align-items:center;gap:6px}
    .et-field{margin-bottom:12px}
    .et-field label{display:block;font-size:11px;font-weight:600;color:#4a5568;margin-bottom:4px}
    .et-field input,.et-field textarea{width:100%;padding:8px 10px;border:1px solid #cbd5e0;border-radius:6px;font-size:13px;font-family:inherit}
    .et-field input:focus,.et-field textarea:focus{outline:none;border-color:#10b981;box-shadow:0 0 0 3px rgba(16,185,129,.15)}
    .et-field textarea{min-height:120px;resize:vertical;line-height:1.5}
    .et-placeholders{background:#f0fdf4;border:1px solid #bbf7d0;border-radius:6px;padding:10px 12px;margin-top:8px}
    .et-placeholders-title{font-size:11px;font-weight:700;color:#065f46;margin-bottom:6px}
    .et-placeholder-tag{display:inline-block;padding:2px 8px;background:#d1fae5;color:#065f46;border-radius:4px;font-size:10px;font-weight:600;margin:2px;cursor:pointer;transition:.1s}
    .et-placeholder-tag:hover{background:#a7f3d0}
    .et-form-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px;padding-top:12px;border-top:1px solid #f1f5f9}
  </style>
</head>
<body>
  <div class="container">
    <!-- TITLE HEADER -->
    <div class="title-bar">
      <h1>Follow Up Actions</h1>
    </div>

    <!-- BUTTON ROW -->
    <div class="btn-row">
      <button class="tbtn tbtn-gray" onclick="goToLeadDB()">
        <svg viewBox="0 0 24 24"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
        Back to Leads
      </button>
      <button class="tbtn tbtn-teal" onclick="openLabelsModal()">
        <svg viewBox="0 0 24 24"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
        Action Labels
      </button>
      <button class="tbtn tbtn-orange" onclick="openTeamModal()">
        <svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
        Team Members
      </button>
      <button class="tbtn tbtn-purple" onclick="openAttemptsModal()">
        <svg viewBox="0 0 24 24"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>
        Lead Attempts
        <svg viewBox="0 0 24 24" style="width:12px;height:12px;margin-left:-2px"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06A1.65 1.65 0 0 0 15 19.4a1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
      </button>
      <button class="tbtn tbtn-blue" onclick="openTemplatesModal()">
        <svg viewBox="0 0 24 24"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
        Email Templates
      </button>
    </div>

    <!-- FILTER ROW -->
    <div class="filter-row">
      <select id="actionFilter" onchange="filterTable()">
        <option value="">All Actions</option>
        <option value="Email">Email</option>
        <option value="Call">Call</option>
        <option value="Follow Up">Follow Up</option>
        <option value="Appt Made">Appt Made</option>
        <option value="Proposal Sent">Proposal Sent</option>
        <option value="Unlabeled">Unlabeled</option>
      </select>
      <input type="search" id="searchInput" placeholder="Search leads, company, notes..." oninput="filterTable()"/>
      <span style="font-size:11px;color:#94a3b8;font-style:italic;white-space:nowrap">* Right-click to remove Date or Rep</span>
    </div>

    <!-- SEND EMAILS BAR -->
    <div class="batch-bar" id="sendEmailsBar">
      <svg viewBox="0 0 24 24" style="width:18px;height:18px;stroke:#fff;fill:none;stroke-width:2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
      <span class="batch-count" id="queuedCount">0 emails ready</span>
      <button class="batch-btn send glow" onclick="openSendReview()">
        <svg viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
        <span id="sendEmailsBtnText">Send Emails</span>
      </button>
      <button class="batch-clear" onclick="clearAllQueued()">&#10005; Clear All</button>
    </div>

    <!-- TABLE -->
    <div class="table-container" id="tableContainer">
      <div id="loadingState" class="loading">
        <div class="spinner"></div>
        <p style="margin-top:12px">Loading follow up actions...</p>
      </div>

      <table id="fuTable" style="display:none">
        <thead><tr>
            <th style="width:10%">Company</th>
            <th style="width:10%">Action</th>
            <th style="width:8%">Action Date</th>
            <th style="width:8%">Who</th>
            <th style="width:9%">Attempt</th>
            <th style="width:8%">Last Contact<span class="sub">attempt date auto populated</span></th>
            <th style="width:7%">Phone<span class="sub">synced to Lead DB</span></th>
            <th style="width:7%">Notes<span class="sub">synced to Lead DB</span></th>
            <th style="width:7%">Email</th>
            <th style="width:7%">Proposal</th>
            <th style="width:7%">Alert</th>
          </tr></thead>
          <tbody id="fuTableBody"></tbody>
        </table>

      <div id="emptyState" class="empty-state" style="display:none">
        <h3>No follow up actions yet</h3>
        <p>Actions will appear here when leads are created or actions are added.</p>
      </div>
    </div>
  </div>

  <!-- TOAST CONTAINER -->
  <div id="toastContainer"></div>

  <!-- LABEL SETTINGS MODAL -->
  <div class="modal-overlay" id="labelsModal">
    <div class="modal-card" style="max-width:620px;width:94%">
      <div class="modal-hdr">
        <h3>
          <svg viewBox="0 0 24 24"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
          Label Settings
        </h3>
        <p>Each label is independent &mdash; configure dates &amp; reminders per label</p>
      </div>
      <div class="modal-body" id="labelsModalBody" style="max-height:65vh">
        <!-- Rendered by JS -->
        <div class="loading" style="padding:30px"><div class="spinner"></div><p style="margin-top:8px">Loading labels...</p></div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeLabelsModal()">Cancel</button>
        <button class="btn-save" id="saveLabelsBtn" onclick="saveLabelsToBackend()">
          Save Labels
        </button>
      </div>
    </div>
  </div>

  <!-- TEAM MEMBERS MODAL -->
  <div class="modal-overlay" id="teamModal">
    <div class="modal-card" style="max-width:620px;width:94%">
      <div class="modal-hdr">
        <h3>
          <svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
          Team Members
        </h3>
        <p>For WHO dropdown + Alert emails</p>
      </div>
      <div class="modal-body" id="teamModalBody" style="max-height:65vh">
        <div class="loading" style="padding:30px"><div class="spinner"></div><p style="margin-top:8px">Loading team...</p></div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeTeamModal()">Close</button>
        <button class="btn-save" id="saveTeamBtn" onclick="saveTeamToBackend()">
          Save Team
        </button>
      </div>
    </div>
  </div>

  <!-- ATTEMPT SETTINGS MODAL -->
  <div class="modal-overlay" id="attemptsModal">
    <div class="modal-card" style="max-width:460px;width:90%">
      <div class="modal-hdr">
        <h3>
          <svg viewBox="0 0 24 24"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>
          Lead Connect Attempt Settings
        </h3>
        <p>Per-label max &mdash; Dead syncs to Lead DB</p>
      </div>
      <div class="modal-body" id="attemptsModalBody">
        <div class="as-row">
          <div>
            <div class="as-label">Max Attempts Before a Lead is Dead</div>
            <div class="as-desc">Any label counter hits this &rarr; Lead marked Dead</div>
          </div>
          <input type="number" class="as-input" id="maxAttemptsInput" min="1" max="20" value="5"/>
        </div>
        <div class="as-explainer">
          <div class="as-explainer-title">
            <svg viewBox="0 0 24 24" style="width:14px;height:14px;stroke:currentColor;fill:none;stroke-width:2;vertical-align:-2px;margin-right:3px"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
            What happens:
          </div>
          <div class="as-flow">
            <div class="att att-dead" style="display:inline-flex"><span class="att-n" style="color:#ef4444" id="asPreviewNum">5</span><span style="font-size:8px;color:#ef4444;font-weight:700">MAX</span></div>
            <span>&rarr;</span>
            <span style="color:#ef4444;font-weight:700">Row RED</span>
            <span>&rarr;</span>
            <span style="background:#fee2e2;color:#dc2626;padding:2px 8px;border-radius:10px;font-size:10px;font-weight:600">Dead</span>
            <span>&rarr;</span>
            <span style="font-weight:600">Syncs to Lead DB</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeAttemptsModal()">Cancel</button>
        <button class="btn-save" id="saveAttemptsBtn" onclick="saveAttemptsToBackend()">Save</button>
      </div>
    </div>
  </div>

  <!-- EMAIL TEMPLATES MODAL -->
  <div class="modal-overlay" id="templatesModal">
    <div class="modal-card" style="max-width:700px;width:94%">
      <div class="modal-hdr">
        <h3>
          <svg viewBox="0 0 24 24"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
          Email Templates
        </h3>
        <p>Create and manage email templates for follow-up outreach</p>
      </div>
      <div class="modal-body" id="templatesModalBody" style="max-height:65vh">
        <div class="loading" style="padding:30px"><div class="spinner"></div><p style="margin-top:8px">Loading templates...</p></div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeTemplatesModal()">Close</button>
      </div>
    </div>
  </div>

  <script>
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbw1uRg1v6Cjqp9g2J-Q3CMsUzj1KbBfuiKnLgsYjhQe1n2x9bMSShB5eCw7mhA9-StC/exec';

    let allActions = [];
    var queuedEmails = {}; // {actionId: {to, subject, body, company, templateName}}
    let maxAttempts = 5;

    // ?? Label ? CSS class map ??
    const LABEL_CSS = {
      'Email':         {pill:'p-email', tag:'t-email'},
      'Call':          {pill:'p-call',  tag:'t-call'},
      'Follow Up':     {pill:'p-fu',   tag:'t-fu'},
      'Appt Made':     {pill:'p-appt', tag:'t-appt'},
      'Proposal Sent': {pill:'p-prop', tag:'t-prop'}
    };
    const LABEL_SHORT_MAP = {'Email':'EM','Call':'CALL','Follow Up':'FU','Appt Made':'APPT','Proposal Sent':'PROP'};
    function labelShort(name) {
      if (LABEL_SHORT_MAP[name]) return LABEL_SHORT_MAP[name];
      // Auto-abbreviate: take first letters of each word, max 4 chars
      var words = name.trim().split(/\s+/);
      if (words.length === 1) return words[0].substring(0,4).toUpperCase();
      return words.map(function(w){return w[0]}).join('').substring(0,4).toUpperCase();
    }

    // ?? Default label configs ??
    const DEFAULT_LABELS = [
      {name:'Email',         requiresDate:false, emailReminder:false, emailDaysBefore:0,  loginPopup:false, loginDaysAfter:0, trackAttempts:true, color:'#dbeafe', textColor:'#1e40af'},
      {name:'Call',          requiresDate:false, emailReminder:false, emailDaysBefore:0,  loginPopup:false, loginDaysAfter:0, trackAttempts:true, color:'#fef3c7', textColor:'#92400e'},
      {name:'Follow Up',     requiresDate:true,  emailReminder:true,  emailDaysBefore:1,  loginPopup:false, loginDaysAfter:0, trackAttempts:false, color:'#d1fae5', textColor:'#065f46'},
      {name:'Appt Made',     requiresDate:true,  emailReminder:true,  emailDaysBefore:2,  loginPopup:false, loginDaysAfter:0, trackAttempts:false, color:'#fce7f3', textColor:'#9d174d'},
      {name:'Proposal Sent', requiresDate:true,  emailReminder:true,  emailDaysBefore:1,  loginPopup:true,  loginDaysAfter:3, trackAttempts:false, color:'#e0f2fe', textColor:'#0369a1'}
    ];

    // Working copy for the modal
    let labelsConfig = [];
    let labelsExpandedIndex = -1;
    let availableLabels = [];

    // ?????????? INIT ??????????
    window.addEventListener('DOMContentLoaded', function() {
      loadActions();
      loadMaxAttempts();
      loadAvailableLabels();
      loadTeamFromBackend();
      loadTemplatesFromBackend();
    });

    async function loadAvailableLabels() {
      try {
        var res = await fetch(WEB_APP_URL + '?action=getLabels');
        var data = await res.json();
        if (data.status === 'success' && data.labels) {
          availableLabels = data.labels;
        } else {
          availableLabels = JSON.parse(JSON.stringify(DEFAULT_LABELS));
        }
      } catch(e) {
        availableLabels = JSON.parse(JSON.stringify(DEFAULT_LABELS));
      }
    }

    // ?????????? DATA LOADING ??????????
    async function loadActions() {
      try {
        // Instant load from cache
        var cached = sessionStorage.getItem('cachedActions');
        if (cached) {
          try {
            allActions = JSON.parse(cached);
            renderTable();
          } catch(e) {}
        }
        
        var res = await fetch(WEB_APP_URL + '?action=getFollowUpActions');
        var data = await res.json();
        if (data.status !== 'success') throw new Error(data.message);
        allActions = data.actions || [];
        
        // Cache for instant load on next visit
        try { sessionStorage.setItem('cachedActions', JSON.stringify(allActions)); } catch(e) {}
        
        renderTable();
      } catch(e) {
        showToast('Error loading actions: ' + e.message, 'error');
        document.getElementById('loadingState').innerHTML = '<p style="color:#ef4444">Failed to load. Check connection.</p>';
      }
    }

    async function loadMaxAttempts() {
      try {
        var res = await fetch(WEB_APP_URL + '?action=getMaxAttempts');
        var data = await res.json();
        if (data.status === 'success') maxAttempts = data.maxAttempts || 5;
      } catch(e) { /* use default */ }
    }

    // ?????????? RENDER TABLE ??????????
    function renderTable() {
      var filtered = getFilteredActions();
      document.getElementById('loadingState').style.display = 'none';

      if (filtered.length === 0) {
        document.getElementById('fuTable').style.display = 'none';
        document.getElementById('emptyState').style.display = 'block';
        return;
      }
      document.getElementById('fuTable').style.display = 'table';
      document.getElementById('emptyState').style.display = 'none';

      var tbody = document.getElementById('fuTableBody');
      var html = '';

      for (var i = 0; i < filtered.length; i++) {
        var a = filtered[i];
        var isDead = a.status === 'Dead';
        var labels = a.actions || [];
        var isUnlabeled = labels.length === 0 && !isDead;

        html += '<tr class="' + (isDead ? 'row-dead' : (isUnlabeled ? 'row-unlabeled' : '')) + '" data-id="' + a.id + '">';

        // Company
        html += '<td><strong' + (isDead ? ' style="color:#ef4444"' : '') + '>' + (isDead ? '<svg viewBox="0 0 24 24" style="width:10px;height:10px;stroke:#ef4444;fill:#ef4444;display:inline;vertical-align:middle;margin-right:3px"><circle cx="12" cy="12" r="10"/></svg>' : '') + esc(a.company) + '</strong></td>';

        // Action pills
        html += '<td class="td-action">' + renderPills(labels, a.id) + '</td>';

        if (isUnlabeled) {
          // Unlabeled rows: show dashes for label-dependent columns
          html += '<td><span style="color:#d97706;font-size:12px;font-style:italic">Assign label first</span></td>'; // Action Date
          html += '<td><span style="color:#a0aec0">&mdash;</span></td>'; // Who
          html += '<td><span style="color:#a0aec0">&mdash;</span></td>'; // Attempt
          html += '<td><span style="color:#a0aec0">&mdash;</span></td>'; // Last Date
        } else {
          // Action Date
          html += '<td>' + renderActionDates(a, labels) + '</td>';
          // Who
          html += '<td>' + renderWho(a, labels) + '</td>';
          // Attempt
          html += '<td>' + renderAttempts(a, labels, isDead) + '</td>';
          // Last Date
          html += '<td>' + renderLastDates(a, labels, isDead) + '</td>';
        }

        // Phone
        html += '<td>' + (isDead
          ? '<span>' + esc(a.phone) + '</span>'
          : '<span class="phone-link" onclick="editPhone(\'' + a.id + '\')">' + esc(a.phone || 'Add') + '</span>') + '</td>';

        // Notes
        var noteDisplay = a.notes ? esc(a.notes) : '+ Add Note';
        var noteClass = a.notes ? 'notes-snip' : 'notes-snip empty';
        if (isDead) noteClass += '" style="color:#ef4444';
        html += '<td><span class="' + noteClass + '" onclick="editNotes(\'' + a.id + '\')">' + noteDisplay + '</span></td>';

        // Email - compose or show queued status
        var emailCell = '';
        if (isDead) {
          emailCell = '<span style="color:#cbd5e0">&mdash;</span>';
        } else if (queuedEmails[a.id]) {
          var qr = queuedEmails[a.id].recipients || [];
          var rcCount = qr.length;
          emailCell = '<div style="display:flex;flex-direction:column;align-items:center;gap:2px">';
          emailCell += '<span style="display:inline-flex;align-items:center;gap:3px;color:#059669;font-size:11px;font-weight:600;cursor:pointer" onclick="openComposeEmail(\'' + a.id + '\')"><svg viewBox="0 0 24 24" style="width:14px;height:14px;stroke:#059669;fill:none;stroke-width:3"><polyline points="20 6 9 17 4 12"/></svg>' + rcCount + ' Ready</span>';
          emailCell += '<span style="font-size:9px;color:#ef4444;cursor:pointer;text-decoration:underline" onclick="removeQueued(\'' + a.id + '\')">remove</span>';
          emailCell += '</div>';
        } else {
          emailCell = '<button class="btn-sm" style="background:linear-gradient(135deg,#10b981,#059669)" onclick="openComposeEmail(\'' + a.id + '\')"><svg viewBox="0 0 24 24"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg> Email</button>';
        }
        html += '<td>' + emailCell + '</td>';

        // Proposal
        html += '<td>' + (isDead ? '<span style="color:#cbd5e0">&mdash;</span>' : '<button class="btn-sm" style="background:linear-gradient(135deg,#059669,#047857)" onclick="openProposal(\'' + a.leadId + '\')"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg> Prop</button>') + '</td>';

        // Alert
        html += '<td>' + (isDead
          ? '<span style="font-size:12px;color:#ef4444;font-weight:700">DEAD</span>'
          : '<button class="alert-btn" onclick="sendAlert(\'' + a.id + '\')"><svg viewBox="0 0 24 24"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg> Alert</button>') + '</td>';

        html += '</tr>';
      }
      tbody.innerHTML = html;
      updateSendBar();
    }    // ?? Pill renderer ??
    function renderPills(labels, actionId) {
      if (labels.length === 0) return '<span class="pill pill-needs" onclick="assignLabel(\'' + actionId + '\')">+ Assign Label</span>';
      var h = '<div class="pill-grid" onclick="assignLabel(\'' + actionId + '\')" style="cursor:pointer" title="Click to change labels">';
      for (var i = 0; i < labels.length; i++) {
        var css = LABEL_CSS[labels[i]] || {pill:'p-email'};
        h += '<span class="pill ' + css.pill + '">' + esc(labels[i]) + '</span>';
      }
      return h + '</div>';
    }

    // ?? Stacked fields for multi-label ??
    function renderActionDates(a, labels) {
      if (labels.length <= 1) {
        var d = (a.actionDates || {})[labels[0]] || '';
        return d ? '<span class="lr-date" onclick="editActionDate(\'' + a.id + '\',\'' + labels[0] + '\')" oncontextmenu="return clearActionDate(event,\'' + a.id + '\',\'' + labels[0] + '\')">' + esc(d) + '</span>' : '<span class="lr-date" style="color:#a0aec0;border-bottom:1px dashed #cbd5e0" onclick="editActionDate(\'' + a.id + '\',\'' + labels[0] + '\')">' + '+ Add Date' + '</span>';
      }
      var h = '<div class="label-stack">';
      for (var i = 0; i < labels.length; i++) {
        var tag = LABEL_CSS[labels[i]] || {tag:'t-email'};
        var short = labelShort(labels[i]);
        var dt = (a.actionDates || {})[labels[i]] || '';
        h += '<div class="label-row"><span class="lr-tag ' + tag.tag + '">' + short + '</span>';
        h += dt ? '<span class="lr-date" onclick="editActionDate(\'' + a.id + '\',\'' + labels[i] + '\')" oncontextmenu="return clearActionDate(event,\'' + a.id + '\',\'' + labels[i] + '\')">' + esc(dt) + '</span>' : '<span class="lr-date" style="color:#a0aec0;border-bottom:1px dashed #cbd5e0" onclick="editActionDate(\'' + a.id + '\',\'' + labels[i] + '\')">' + '+ Date' + '</span>';
        h += '</div>';
      }
      return h + '</div>';
    }

    function renderWho(a, labels) {
      if (labels.length <= 1) {
        var w = (a.who || {})[labels[0]] || '';
        return w ? '<strong style="cursor:pointer" onclick="editWho(\'' + a.id + '\',\'' + labels[0] + '\')" oncontextmenu="return clearWho(event,\'' + a.id + '\',\'' + labels[0] + '\')">' + esc(w) + '</strong>' : '<span class="lr-date" style="color:#a0aec0;border-bottom:1px dashed #cbd5e0" onclick="editWho(\'' + a.id + '\',\'' + labels[0] + '\')">' + '+ Assign' + '</span>';
      }
      var h = '<div class="label-stack">';
      for (var i = 0; i < labels.length; i++) {
        var tag = LABEL_CSS[labels[i]] || {tag:'t-email'};
        var short = labelShort(labels[i]);
        var wv = (a.who || {})[labels[i]] || '';
        h += '<div class="label-row"><span class="lr-tag ' + tag.tag + '">' + short + '</span><span class="lr-val" style="cursor:pointer" onclick="editWho(\'' + a.id + '\',\'' + labels[i] + '\')"' + (wv ? ' oncontextmenu="return clearWho(event,\'' + a.id + '\',\'' + labels[i] + '\')"' : '') + '>' + (wv ? esc(wv) : '<span style="color:#a0aec0">+ Assign</span>') + '</span></div>';
      }
      return h + '</div>';
    }

    function labelTracksAttempts(labelName) {
      var labels = availableLabels.length > 0 ? availableLabels : DEFAULT_LABELS;
      for (var i = 0; i < labels.length; i++) {
        if (labels[i].name === labelName) return labels[i].trackAttempts !== false;
      }
      return true; // default to tracking
    }

    function renderAttempts(a, labels, isDead) {
      if (labels.length <= 1) {
        if (!labelTracksAttempts(labels[0])) return '<span style="color:#a0aec0">&mdash;</span>';
        var n = (a.attempts || {})[labels[0]] || 0;
        if (isDead) return '<div class="att att-dead"><span class="att-n">' + n + '</span><span style="font-size:8px;color:#ef4444;font-weight:700">MAX</span></div>';
        return '<div class="att"><button class="att-b" onclick="changeAttempt(\'' + a.id + '\',\'' + labels[0] + '\',-1)">&minus;</button><span class="att-n">' + n + '</span><button class="att-b" onclick="changeAttempt(\'' + a.id + '\',\'' + labels[0] + '\',1)">+</button></div>';
      }
      var h = '<div class="label-stack">';
      for (var i = 0; i < labels.length; i++) {
        var tag = LABEL_CSS[labels[i]] || {tag:'t-email'};
        var short = labelShort(labels[i]);
        h += '<div class="label-row"><span class="lr-tag ' + tag.tag + '">' + short + '</span>';
        if (!labelTracksAttempts(labels[i])) {
          h += '<span class="lr-dim">&mdash;</span>';
        } else {
          var n2 = (a.attempts || {})[labels[i]] || 0;
          if (isDead) {
            h += '<div class="att att-dead"><span class="att-n">' + n2 + '</span><span style="font-size:8px;color:#ef4444;font-weight:700">MAX</span></div>';
          } else {
            h += '<div class="att"><button class="att-b" onclick="changeAttempt(\'' + a.id + '\',\'' + labels[i] + '\',-1)">&minus;</button><span class="att-n">' + n2 + '</span><button class="att-b" onclick="changeAttempt(\'' + a.id + '\',\'' + labels[i] + '\',1)">+</button></div>';
          }
        }
        h += '</div>';
      }
      return h + '</div>';
    }

    function renderLastDates(a, labels, isDead) {
      if (labels.length <= 1) {
        if (!labelTracksAttempts(labels[0])) return '<span style="color:#a0aec0">&mdash;</span>';
        var ld = (a.lastDates || {})[labels[0]] || '';
        if (!ld) return isDead ? '<span style="color:#ef4444">&mdash;</span>' : '<span style="color:#a0aec0">&mdash;</span>';
        return isDead ? '<span style="color:#ef4444">' + esc(ld) + '</span>' : esc(ld);
      }
      var h = '<div class="label-stack">';
      for (var i = 0; i < labels.length; i++) {
        var tag = LABEL_CSS[labels[i]] || {tag:'t-email'};
        var short = labelShort(labels[i]);
        var ldv = (a.lastDates || {})[labels[i]] || '';
        if (!labelTracksAttempts(labels[i])) {
          h += '<div class="label-row"><span class="lr-tag ' + tag.tag + '">' + short + '</span><span class="lr-dim">&mdash;</span></div>';
        } else {
          h += '<div class="label-row"><span class="lr-tag ' + tag.tag + '">' + short + '</span><span class="lr-dim">' + (ldv ? esc(ldv) : '&mdash;') + '</span></div>';
        }
      }
      return h + '</div>';
    }

    // ?????????? FILTERING ??????????
    function getFilteredActions() {
      var search = (document.getElementById('searchInput').value || '').toLowerCase();
      var actionFilter = document.getElementById('actionFilter').value;
      return allActions.filter(function(a) {
        if (actionFilter === 'Unlabeled') {
          if ((a.actions || []).length > 0) return false;
        } else if (actionFilter && !(a.actions || []).includes(actionFilter)) return false;
        if (search) {
          var haystack = (a.company + ' ' + a.phone + ' ' + a.notes + ' ' + JSON.stringify(a.who)).toLowerCase();
          if (haystack.indexOf(search) === -1) return false;
        }
        return true;
      });
    }

    function filterTable() { renderTable(); }

    // ========== EMAIL QUEUE MANAGEMENT ==========
    function updateSendBar() {
      var bar = document.getElementById('sendEmailsBar');
      var keys = Object.keys(queuedEmails);
      var totalEmails = 0;
      keys.forEach(function(id) {
        var q = queuedEmails[id];
        totalEmails += (q.recipients ? q.recipients.length : 1);
      });
      if (keys.length > 0) {
        bar.classList.add('show');
        document.getElementById('queuedCount').textContent = totalEmails + ' email' + (totalEmails !== 1 ? 's' : '') + ' ready';
        document.getElementById('sendEmailsBtnText').textContent = 'Send Emails (' + totalEmails + ')';
      } else {
        bar.classList.remove('show');
      }
    }

    function removeQueued(actionId) {
      delete queuedEmails[actionId];
      renderTable();
      updateSendBar();
    }

    function clearAllQueued() {
      queuedEmails = {};
      renderTable();
      updateSendBar();
    }

    var _composeActionId = null;
    var _composeContacts = []; // working copy of contacts for current compose

    function openComposeEmail(actionId) {
      var a = allActions.find(function(x) { return x.id === actionId; });
      if (!a || a.status === 'Dead') return;
      _composeActionId = actionId;

      var existing = queuedEmails[actionId] || {};
      var existingSubject = existing.subject || '';
      var existingBody = existing.body || '';

      // Build contacts list from action data or existing queue
      if (existing.recipients && existing.recipients.length > 0) {
        _composeContacts = existing.recipients.map(function(r) { return {name:r.name||'', email:r.email||'', position:r.position||'', selected:true}; });
      } else if (a.contacts && a.contacts.length > 0) {
        _composeContacts = a.contacts.map(function(c) { return {name:c.name||'', email:c.email||'', position:c.position||'', selected:true}; });
      } else if (a.email) {
        _composeContacts = [{name:a.contact||'', email:a.email, position:'', selected:true}];
      } else {
        _composeContacts = [];
      }

      // Build template dropdown
      var templateOpts = '<option value="">-- Write custom email --</option>';
      for (var i = 0; i < emailTemplates.length; i++) {
        templateOpts += '<option value="' + i + '">' + esc(emailTemplates[i].name) + '</option>';
      }

      var overlay = document.createElement('div');
      overlay.className = 'modal-overlay show';
      overlay.id = 'composeOverlay';

      var h = '<div class="modal-card" style="max-width:580px">';
      h += '<div class="modal-hdr"><h3><svg viewBox="0 0 24 24"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg> Compose Email</h3><p>' + esc(a.company) + '</p></div>';
      h += '<div class="modal-body" style="max-height:70vh;overflow-y:auto">';

      // Recipients section
      h += '<div style="margin-bottom:16px"><label style="font-size:12px;font-weight:700;color:#1e293b;display:flex;align-items:center;justify-content:space-between;margin-bottom:8px"><span>Recipients</span><button type="button" onclick="addComposeContact()" style="padding:3px 10px;border:1px solid #10b981;border-radius:5px;background:#ecfdf5;color:#059669;font-size:11px;font-weight:600;cursor:pointer">+ Add Contact</button></label>';
      h += '<div style="display:flex;gap:4px;padding:0 4px 4px 26px;font-size:10px;color:#94a3b8;font-weight:600"><span style="flex:1">Name</span><span style="flex:1.3">Email</span><span style="flex:0.8">Position</span><span style="width:22px"></span></div>';
      h += '<div id="composeContactsList"></div>';
      h += '<div id="compNoContacts" style="padding:12px;background:#fffbeb;border:1px solid #fde68a;border-radius:6px;font-size:12px;color:#92400e;text-align:center;display:none"><svg viewBox="0 0 24 24" style="width:14px;height:14px;stroke:#f59e0b;fill:none;stroke-width:2;vertical-align:-2px;margin-right:4px"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>No contacts found. Add a contact to send an email.</div>';
      h += '</div>';

      // Template dropdown
      h += '<div class="et-field" style="margin-bottom:12px"><label style="font-size:12px;font-weight:600;color:#4a5568;display:block;margin-bottom:4px">Use Template <span style="font-weight:400;color:#94a3b8">(auto-fills subject & body)</span></label>';
      h += '<select id="compTemplate" onchange="window._applyTemplate(this)" style="width:100%;padding:9px 12px;border:1px solid #cbd5e0;border-radius:6px;font-size:13px">' + templateOpts + '</select></div>';

      // Subject
      h += '<div class="et-field" style="margin-bottom:12px"><label style="font-size:12px;font-weight:600;color:#4a5568;display:block;margin-bottom:4px">Subject <span style="font-weight:400;color:#94a3b8">(override template subject)</span></label>';
      h += '<input type="text" id="compSubject" value="' + esc(existingSubject) + '" placeholder="Auto-filled from template or type custom..." style="width:100%;padding:9px 12px;border:1px solid #cbd5e0;border-radius:6px;font-size:13px"/></div>';

      // Body
      h += '<div class="et-field" style="margin-bottom:12px"><label style="font-size:12px;font-weight:600;color:#4a5568;display:block;margin-bottom:4px">Body</label>';
      h += '<textarea id="compBody" placeholder="Select a template above or type your email..." style="width:100%;min-height:130px;padding:10px 12px;border:1px solid #cbd5e0;border-radius:6px;font-size:13px;resize:vertical;line-height:1.5">' + esc(existingBody) + '</textarea></div>';

      // Placeholder hints
      h += '<div style="background:#eff6ff;border:1px solid #bfdbfe;border-radius:6px;padding:8px 12px;font-size:11px;color:#1e40af;line-height:1.4">Placeholders: <strong>{Company}</strong>, <strong>{Contact}</strong>, <strong>{Phone}</strong>, <strong>{Rep}</strong>, <strong>{Date}</strong> auto-fill when sent.</div>';

      h += '</div>';
      h += '<div class="modal-footer"><span style="font-size:11px;color:#64748b;margin-right:auto">? Contacts sync to Lead Database</span><button class="btn-cancel" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn-save" onclick="saveComposeEmail()">Save & Sync</button></div>';
      h += '</div>';

      overlay.innerHTML = h;
      document.body.appendChild(overlay);
      renderComposeContacts();
    }

    // Global template apply ? works from both inline onchange and direct call
    window._applyTemplate = function(sel) {
      try {
        var val = sel ? sel.value : '';
        if (val === '') return;
        var idx = parseInt(val);
        var t = emailTemplates[idx];
        if (!t) {
          showToast('Template not found at index ' + idx, 'error');
          return;
        }
        var subField = document.getElementById('compSubject');
        var bodyField = document.getElementById('compBody');
        if (!subField || !bodyField) {
          showToast('Subject or Body field not found in DOM', 'error');
          return;
        }
        var a = allActions.find(function(x) { return x.id === _composeActionId; }) || {};
        subField.value = fillPlaceholders(t.subject || '', a);
        bodyField.value = fillPlaceholders(t.body || '', a);
        if (!t.subject && !t.body) {
          showToast('Template "' + t.name + '" has empty subject and body', 'error');
        }
      } catch(e) {
        showToast('Template error: ' + e.message, 'error');
      }
    };

    function renderComposeContacts() {
      var el = document.getElementById('composeContactsList');
      if (!el) return;
      var noEl = document.getElementById('compNoContacts');
      if (noEl) noEl.style.display = _composeContacts.length === 0 ? 'block' : 'none';

      var h = '';
      for (var i = 0; i < _composeContacts.length; i++) {
        var c = _composeContacts[i];
        h += '<div style="display:flex;align-items:center;gap:6px;padding:8px 10px;background:' + (c.selected ? '#ecfdf5' : '#f8fafc') + ';border:1px solid ' + (c.selected ? '#a7f3d0' : '#e2e8f0') + ';border-radius:6px;margin-bottom:6px">';
        h += '<input type="checkbox" ' + (c.selected ? 'checked' : '') + ' onchange="_composeContacts[' + i + '].selected=this.checked;renderComposeContacts()" style="cursor:pointer;accent-color:#10b981;flex-shrink:0"/>';
        h += '<input type="text" value="' + esc(c.name) + '" placeholder="Name" oninput="_composeContacts[' + i + '].name=this.value" style="flex:1;min-width:0;padding:5px 8px;border:1px solid #cbd5e0;border-radius:4px;font-size:12px"/>';
        h += '<input type="email" value="' + esc(c.email) + '" placeholder="Email" oninput="_composeContacts[' + i + '].email=this.value" style="flex:1.3;min-width:0;padding:5px 8px;border:1px solid #cbd5e0;border-radius:4px;font-size:12px"/>';
        h += '<input type="text" value="' + esc(c.position) + '" placeholder="Position" oninput="_composeContacts[' + i + '].position=this.value" style="flex:0.8;min-width:0;padding:5px 8px;border:1px solid #cbd5e0;border-radius:4px;font-size:12px"/>';
        h += '<button onclick="removeComposeContact(' + i + ')" style="flex-shrink:0;width:22px;height:22px;border:1px solid #fecaca;border-radius:4px;background:#fff;color:#ef4444;font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center" title="Remove">&times;</button>';
        h += '</div>';
      }
      el.innerHTML = h;
    }

    function addComposeContact() {
      _composeContacts.push({name:'', email:'', position:'', selected:true});
      renderComposeContacts();
    }

    function removeComposeContact(idx) {
      _composeContacts.splice(idx, 1);
      renderComposeContacts();
    }

    function saveComposeEmail() {
      var subject = document.getElementById('compSubject').value.trim();
      var body = document.getElementById('compBody').value.trim();

      var selected = _composeContacts.filter(function(c) { return c.selected && c.email.trim(); });

      var actionId = _composeActionId;
      var a = allActions.find(function(x) { return x.id === actionId; });

      // Save ALL contacts back to action data (even if empty ? allows clearing)
      var allContacts = _composeContacts.filter(function(c) { return c.email.trim() || c.name.trim(); }).map(function(c) {
        return {name:c.name.trim(), email:c.email.trim(), position:c.position.trim()};
      });

      if (a) {
        a.contacts = allContacts;
        a.email = allContacts.length > 0 ? allContacts[0].email : '';
        a.contact = allContacts.length > 0 ? allContacts[0].name : '';
        fetch(WEB_APP_URL, {
          method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'},
          body: JSON.stringify({action:'updateFollowUpAction', actionId:actionId, updates:{contacts:allContacts}})
        }).then(function() {
          showToast('Contacts synced to Lead Database', 'success');
        }).catch(function(){});
      }

      // Only queue email if there's content AND recipients
      if (subject || body) {
        if (selected.length === 0) { showToast('Add at least one contact with an email to send', 'error'); return; }
        queuedEmails[actionId] = {
          recipients: selected.map(function(c) { return {name:c.name.trim(), email:c.email.trim(), position:c.position.trim()}; }),
          subject: subject,
          body: body,
          company: a ? a.company : ''
        };
      }

      var overlay = document.getElementById('composeOverlay');
      if (overlay) overlay.remove();
      _composeActionId = null;
      renderTable();
      updateSendBar();
    }

    function openSendReview() {
      var keys = Object.keys(queuedEmails);
      if (keys.length === 0) return;

      // Count total individual emails
      var totalEmails = 0;
      keys.forEach(function(id) {
        var q = queuedEmails[id];
        totalEmails += (q.recipients ? q.recipients.length : 1);
      });

      var h = '<div class="modal-card" style="max-width:620px"><div class="modal-hdr" style="background:linear-gradient(135deg,#059669,#047857)"><h3><svg viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg> Review & Send Emails</h3><p>' + totalEmails + ' email' + (totalEmails !== 1 ? 's' : '') + ' to ' + keys.length + ' compan' + (keys.length !== 1 ? 'ies' : 'y') + '</p></div><div class="modal-body" style="max-height:400px;overflow-y:auto">';

      for (var i = 0; i < keys.length; i++) {
        var id = keys[i];
        var q = queuedEmails[id];
        var recipients = q.recipients || [{email: q.to || '', name:'', position:''}];

        h += '<div style="padding:12px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;margin-bottom:8px" id="review-' + id + '">';
        h += '<div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">';
        h += '<div style="flex-shrink:0;width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,#10b981,#059669);color:#fff;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700">' + (i+1) + '</div>';
        h += '<div style="flex:1;min-width:0"><div style="font-weight:600;font-size:13px;color:#1e293b">' + esc(q.company) + '</div>';
        h += '<div style="font-size:11px;color:#64748b;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">Subject: ' + esc(q.subject || '(no subject)') + '</div></div>';
        h += '<button style="padding:4px 10px;border:1px solid #cbd5e0;border-radius:4px;background:#fff;color:#2563eb;font-size:11px;font-weight:600;cursor:pointer" onclick="editQueuedFromReview(\'' + id + '\')">Edit</button>';
        h += '<button style="padding:4px 8px;border:1px solid #fecaca;border-radius:4px;background:#fff;color:#ef4444;font-size:11px;font-weight:600;cursor:pointer" onclick="removeQueuedFromReview(\'' + id + '\')">&times;</button>';
        h += '</div>';

        // Show each recipient
        for (var r = 0; r < recipients.length; r++) {
          var recip = recipients[r];
          h += '<div style="display:flex;align-items:center;gap:6px;padding:4px 8px 4px 42px;font-size:12px">';
          h += '<svg viewBox="0 0 24 24" style="width:12px;height:12px;stroke:#10b981;fill:none;stroke-width:2;flex-shrink:0"><polyline points="20 6 9 17 4 12"/></svg>';
          h += '<span style="color:#2563eb">' + esc(recip.email) + '</span>';
          if (recip.name) h += '<span style="color:#64748b"> - ' + esc(recip.name) + '</span>';
          if (recip.position) h += '<span style="color:#94a3b8;font-size:11px"> (' + esc(recip.position) + ')</span>';
          h += '</div>';
        }
        h += '</div>';
      }

      h += '</div><div class="modal-footer"><button class="btn-cancel" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn-save" id="reviewSendBtn" onclick="executeQueuedSend()" style="padding:10px 24px;font-size:14px;background:linear-gradient(135deg,#10b981,#059669)"><svg viewBox="0 0 24 24" style="width:16px;height:16px;stroke:#fff;fill:none;stroke-width:2;vertical-align:-3px;margin-right:4px"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>Send ' + totalEmails + ' Email' + (totalEmails !== 1 ? 's' : '') + '</button></div></div>';

      var overlay = document.createElement('div');
      overlay.className = 'modal-overlay show';
      overlay.id = 'reviewOverlay';
      overlay.innerHTML = h;
      document.body.appendChild(overlay);
    }

    function removeQueuedFromReview(actionId) {
      delete queuedEmails[actionId];
      var el = document.getElementById('review-' + actionId);
      if (el) el.remove();
      var keys = Object.keys(queuedEmails);
      if (keys.length === 0) {
        var overlay = document.getElementById('reviewOverlay');
        if (overlay) overlay.remove();
      }
      updateSendBar();
      renderTable();
    }

    function editQueuedFromReview(actionId) {
      var overlay = document.getElementById('reviewOverlay');
      if (overlay) overlay.remove();
      openComposeEmail(actionId);
    }

    async function executeQueuedSend() {
      var keys = Object.keys(queuedEmails);
      if (keys.length === 0) return;
      var btn = document.getElementById('reviewSendBtn');
      if (btn) { btn.disabled = true; btn.textContent = 'Sending...'; }

      var sent = 0;
      var failed = 0;
      var totalSends = 0;
      keys.forEach(function(id) { var q = queuedEmails[id]; totalSends += (q.recipients ? q.recipients.length : 1); });

      var sendNum = 0;
      for (var i = 0; i < keys.length; i++) {
        var id = keys[i];
        var q = queuedEmails[id];
        var a = allActions.find(function(x) { return x.id === id; });
        var filledSubject = a ? fillPlaceholders(q.subject || '', a) : q.subject;
        var filledBody = a ? fillPlaceholders(q.body || '', a) : q.body;
        var recipients = q.recipients || [{email: q.to || ''}];
        var actionFailed = false;

        for (var r = 0; r < recipients.length; r++) {
          sendNum++;
          if (btn) btn.textContent = 'Sending ' + sendNum + '/' + totalSends + '...';
          try {
            var res = await fetch(WEB_APP_URL, {
              method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'},
              body: JSON.stringify({
                action:'sendFollowUpEmail',
                to: recipients[r].email,
                subject: filledSubject,
                body: filledBody,
                actionId: id,
                templateId: ''
              })
            });
            var data = await res.json();
            if (data.status === 'success') { sent++; } else { failed++; actionFailed = true; }
          } catch(e) { failed++; actionFailed = true; }
        }
        if (!actionFailed) delete queuedEmails[id];
      }

      var overlay = document.getElementById('reviewOverlay');
      if (overlay) overlay.remove();

      if (failed === 0) {
        showToast(sent + ' email' + (sent !== 1 ? 's' : '') + ' sent!', 'success');
      } else {
        showToast(sent + ' sent, ' + failed + ' failed', 'error');
      }
      updateSendBar();
      renderTable();
    }


    // ?????????? ASSIGN LABEL (instant save on click) ??????????
    var _labelPickerActionId = null;

    function assignLabel(actionId) {
      var existing = document.getElementById('labelPicker');
      if (existing) existing.remove();

      var action = allActions.find(function(a) { return a.id === actionId; });
      if (!action) return;
      _labelPickerActionId = actionId;

      var labels = availableLabels.length > 0 ? availableLabels : DEFAULT_LABELS;
      var currentLabels = action.actions || [];

      var pop = document.createElement('div');
      pop.id = 'labelPicker';
      pop.className = 'label-picker-overlay';

      var h = '<div class="label-picker">';
      h += '<div class="lp-header"><strong>Action Labels</strong><span class="lp-company">' + esc(action.company) + '</span></div>';
      h += '<div class="lp-body">';
      for (var i = 0; i < labels.length; i++) {
        var lb = labels[i];
        var css = LABEL_CSS[lb.name] || {pill:'p-email'};
        var isChecked = currentLabels.indexOf(lb.name) !== -1 ? ' checked' : '';
        h += '<label class="lp-chip"><input type="checkbox" value="' + esc(lb.name) + '"' + isChecked + ' onchange="toggleLabelInstant(this)"/> <span class="pill ' + css.pill + '">' + esc(lb.name) + '</span></label>';
      }
      h += '</div>';
      h += '<div class="lp-footer"><span class="lp-status" id="lpStatus" style="font-size:11px;color:#64748b"></span>';
      h += '<button class="tbtn" style="padding:6px 14px;font-size:12px;background:#64748b" onclick="closeLabelPicker()">Done</button>';
      h += '</div></div>';

      pop.innerHTML = h;
      pop.addEventListener('click', function(e) { if (e.target === pop) closeLabelPicker(); });
      document.body.appendChild(pop);
    }

    function closeLabelPicker() {
      var el = document.getElementById('labelPicker');
      if (el) el.remove();
      _labelPickerActionId = null;
    }

    async function toggleLabelInstant(checkbox) {
      var actionId = _labelPickerActionId;
      if (!actionId) return;

      // Gather currently checked labels
      var checks = document.querySelectorAll('#labelPicker .lp-chip input');
      var selected = [];
      checks.forEach(function(c) { if (c.checked) selected.push(c.value); });

      var status = document.getElementById('lpStatus');
      if (status) { status.textContent = 'Saving...'; status.style.color = '#d97706'; }

      // Build data ? preserve existing, init new, allow empty
      var action = allActions.find(function(x) { return x.id === actionId; });
      var oldWho = action ? (action.who || {}) : {};
      var oldAttempts = action ? (action.attempts || {}) : {};
      var oldLastDates = action ? (action.lastDates || {}) : {};
      var oldActionDates = action ? (action.actionDates || {}) : {};

      var who = {}, attempts = {}, lastDates = {}, actionDates = {};
      selected.forEach(function(l) {
        who[l] = oldWho[l] || '';
        attempts[l] = oldAttempts[l] || 0;
        lastDates[l] = oldLastDates[l] || '';
        actionDates[l] = oldActionDates[l] || '';
      });

      // Optimistic UI update
      if (action) {
        action.actions = selected;
        action.who = who;
        action.attempts = attempts;
        action.lastDates = lastDates;
        action.actionDates = actionDates;
      }
      renderTable();

      // Background save
      try {
        var res = await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: {'Content-Type':'text/plain;charset=UTF-8'},
          body: JSON.stringify({
            action: 'updateFollowUpAction',
            actionId: actionId,
            updates: {
              actions: selected,
              who: who,
              attempts: attempts,
              lastDates: lastDates,
              actionDates: actionDates
            }
          })
        });
        var data = await res.json();
        if (data.status !== 'success') throw new Error(data.message);
        if (status) { status.textContent = 'Saved'; status.style.color = '#059669'; }
      } catch(e) {
        showToast('Error: ' + e.message, 'error');
        if (status) { status.textContent = 'Error!'; status.style.color = '#ef4444'; }
      }
    }

    // ?????????? ATTEMPT CHANGE ??????????
    async function changeAttempt(actionId, label, delta) {
      // Instant UI update first
      var a = allActions.find(function(x) { return x.id === actionId; });
      if (!a) return;
      
      var oldAttempts = JSON.parse(JSON.stringify(a.attempts || {}));
      var oldVal = (a.attempts || {})[label] || 0;
      var newVal = Math.max(0, oldVal + delta);
      if (!a.attempts) a.attempts = {};
      a.attempts[label] = newVal;

      // Auto-stamp last date on increment
      if (delta > 0) {
        if (!a.lastDates) a.lastDates = {};
        var today = new Date();
        var mm = String(today.getMonth()+1).padStart(2,'0');
        var dd = String(today.getDate()).padStart(2,'0');
        a.lastDates[label] = mm + '/' + dd + '/' + today.getFullYear();
      }

      renderTable(); // Instant re-render

      // Background save
      try {
        var res = await fetch(WEB_APP_URL, {
          method:'POST',
          headers:{'Content-Type':'text/plain;charset=UTF-8'},
          body: JSON.stringify({action:'updateAttempt', actionId:actionId, label:label, delta:delta})
        });
        var data = await res.json();
        if (data.status !== 'success') throw new Error(data.message);

        // Sync only the specific label from server response to avoid race conditions
        if (data.attempts) {
          if (!a.attempts) a.attempts = {};
          a.attempts[label] = data.attempts[label] !== undefined ? data.attempts[label] : a.attempts[label];
        }
        if (data.lastDates) {
          if (!a.lastDates) a.lastDates = {};
          a.lastDates[label] = data.lastDates[label] !== undefined ? data.lastDates[label] : a.lastDates[label];
        }
        if (data.isDead) {
          a.status = 'Dead';
          renderTable();
          showToast('Lead marked as DEAD - max attempts reached', 'error');
        }
      } catch(e) {
        // Revert on failure
        a.attempts = oldAttempts;
        renderTable();
        showToast('Error: ' + e.message, 'error');
      }
    }

    // ?????????? INLINE EDITS ??????????
    function editPhone(actionId) {
      var a = allActions.find(function(x) { return x.id === actionId; });
      if (!a) return;
      var td = document.querySelector('tr[data-id="' + actionId + '"] td:nth-child(7)');
      var current = a.phone || '';
      td.innerHTML = '<input class="inline-input" type="text" value="' + esc(current) + '" onblur="savePhone(\'' + actionId + '\',this)" onkeydown="if(event.key===\'Enter\')this.blur()"/>';
      td.querySelector('input').focus();
    }

    async function savePhone(actionId, input) {
      var val = input.value.trim();
      var a = allActions.find(function(x) { return x.id === actionId; });
      var oldPhone = a ? a.phone : '';
      if (a) a.phone = val;
      renderTable();

      try {
        var res = await fetch(WEB_APP_URL, {
          method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'},
          body: JSON.stringify({action:'updateFollowUpAction', actionId:actionId, updates:{phone:val}})
        });
        var data = await res.json();
        if (data.status !== 'success') throw new Error(data.message);
      } catch(e) {
        if (a) a.phone = oldPhone;
        renderTable();
        showToast('Error saving phone: ' + e.message, 'error');
      }
    }

    function clearWho(event, actionId, label) {
      event.preventDefault();
      var a = allActions.find(function(x) { return x.id === actionId; });
      if (!a || a.status === 'Dead') return false;
      var currentWho = (a.who || {})[label] || '';
      if (!currentWho) return false;

      var oldWho = JSON.parse(JSON.stringify(a.who || {}));
      delete a.who[label];
      renderTable();

      fetch(WEB_APP_URL, {
        method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'},
        body: JSON.stringify({action:'updateFollowUpAction', actionId:actionId, updates:{who:a.who}})
      }).then(function(r){return r.json()}).then(function(data){
        if (data.status !== 'success') throw new Error(data.message);
      }).catch(function(e){
        a.who = oldWho;
        renderTable();
        showToast('Error: ' + e.message, 'error');
      });
      return false;
    }

    function clearActionDate(event, actionId, label) {
      event.preventDefault();
      var a = allActions.find(function(x) { return x.id === actionId; });
      if (!a || a.status === 'Dead') return false;
      var currentDate = (a.actionDates || {})[label] || '';
      if (!currentDate) return false;

      var oldDates = JSON.parse(JSON.stringify(a.actionDates || {}));
      delete a.actionDates[label];
      renderTable();

      fetch(WEB_APP_URL, {
        method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'},
        body: JSON.stringify({action:'updateFollowUpAction', actionId:actionId, updates:{actionDates:a.actionDates}})
      }).then(function(r){return r.json()}).then(function(data){
        if (data.status !== 'success') throw new Error(data.message);
      }).catch(function(e){
        a.actionDates = oldDates;
        renderTable();
        showToast('Error: ' + e.message, 'error');
      });
      return false;
    }

    function getFormattedDate(offset) {
      var d = new Date();
      d.setDate(d.getDate() + offset);
      return String(d.getMonth()+1).padStart(2,'0') + '/' + String(d.getDate()).padStart(2,'0') + '/' + d.getFullYear();
    }

    function quickSetDate(actionId, label, offset) {
      var formatted = getFormattedDate(offset);
      var a = allActions.find(function(x) { return x.id === actionId; });
      if (!a) return;
      var oldDates = JSON.parse(JSON.stringify(a.actionDates || {}));
      if (!a.actionDates) a.actionDates = {};
      a.actionDates[label] = formatted;
      var overlay = document.querySelector('.modal-overlay.show');
      if (overlay) overlay.remove();
      renderTable();

      fetch(WEB_APP_URL, {
        method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'},
        body: JSON.stringify({action:'updateFollowUpAction', actionId:actionId, updates:{actionDates:a.actionDates}})
      }).then(function(r){return r.json()}).then(function(data){
        if (data.status !== 'success') throw new Error(data.message);
      }).catch(function(e){
        a.actionDates = oldDates;
        renderTable();
        showToast('Error: ' + e.message, 'error');
      });
    }

    function showFullDatePicker(actionId, label) {
      var a = allActions.find(function(x) { return x.id === actionId; });
      if (!a) return;
      var current = (a.actionDates || {})[label] || '';
      var inputVal = '';
      if (current) {
        var parts = current.split('/');
        if (parts.length === 3) inputVal = (parts[2].length === 2 ? '20' + parts[2] : parts[2]) + '-' + parts[0].padStart(2,'0') + '-' + parts[1].padStart(2,'0');
        else inputVal = current;
      }
      var container = document.getElementById('dateQuickBody');
      container.innerHTML = '<input type="date" id="dateEditInput" value="' + inputVal + '" style="width:100%;padding:10px;border:2px solid #e2e8f0;border-radius:8px;font-size:16px"/><div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px"><button class="btn-cancel" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn-save" onclick="saveActionDate(\'' + actionId + '\',\'' + label + '\',this)">Save</button></div>';
    }

    function editActionDate(actionId, label) {
      var a = allActions.find(function(x) { return x.id === actionId; });
      if (!a || a.status === 'Dead') return;

      var todayStr = getFormattedDate(0);
      var yesterdayStr = getFormattedDate(-1);

      var overlay = document.createElement('div');
      overlay.className = 'modal-overlay show';
      overlay.innerHTML = '<div class="modal-card" style="max-width:360px"><div class="modal-hdr"><h3><svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg> Set Date</h3><p>' + esc(label) + ' - ' + esc(a.company) + '</p></div><div class="modal-body" id="dateQuickBody"><button onclick="quickSetDate(\'' + actionId + '\',\'' + label + '\',0)" style="width:100%;padding:12px;margin-bottom:8px;border:2px solid #e2e8f0;border-radius:8px;background:#ecfdf5;color:#065f46;font-size:14px;font-weight:600;cursor:pointer;text-align:left;display:flex;justify-content:space-between;align-items:center"><span>Today</span><span style="color:#10b981;font-size:13px">' + todayStr + '</span></button><button onclick="quickSetDate(\'' + actionId + '\',\'' + label + '\',-1)" style="width:100%;padding:12px;margin-bottom:8px;border:2px solid #e2e8f0;border-radius:8px;background:#f8fafc;color:#1e293b;font-size:14px;font-weight:600;cursor:pointer;text-align:left;display:flex;justify-content:space-between;align-items:center"><span>Yesterday</span><span style="color:#64748b;font-size:13px">' + yesterdayStr + '</span></button><button onclick="showFullDatePicker(\'' + actionId + '\',\'' + label + '\')" style="width:100%;padding:12px;border:2px solid #e2e8f0;border-radius:8px;background:#fff;color:#2563eb;font-size:14px;font-weight:600;cursor:pointer;text-align:left;display:flex;align-items:center;gap:8px"><svg viewBox="0 0 24 24" style="width:16px;height:16px;stroke:currentColor;fill:none;stroke-width:2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg> Select a Date...</button></div><div class="modal-footer"><button class="btn-cancel" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button></div></div>';
      document.body.appendChild(overlay);
    }

    async function saveActionDate(actionId, label, btn) {
      var val = document.getElementById('dateEditInput').value;
      if (!val) { btn.closest('.modal-overlay').remove(); return; }
      var d = new Date(val + 'T00:00:00');
      var formatted = String(d.getMonth()+1).padStart(2,'0') + '/' + String(d.getDate()).padStart(2,'0') + '/' + d.getFullYear();

      var a = allActions.find(function(x) { return x.id === actionId; });
      if (!a) return;
      var oldDates = JSON.parse(JSON.stringify(a.actionDates || {}));
      if (!a.actionDates) a.actionDates = {};
      a.actionDates[label] = formatted;
      btn.closest('.modal-overlay').remove();
      renderTable();

      try {
        var res = await fetch(WEB_APP_URL, {
          method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'},
          body: JSON.stringify({action:'updateFollowUpAction', actionId:actionId, updates:{actionDates:a.actionDates}})
        });
        var data = await res.json();
        if (data.status !== 'success') throw new Error(data.message);
      } catch(e) {
        a.actionDates = oldDates;
        renderTable();
        showToast('Error: ' + e.message, 'error');
      }
    }

    function editWho(actionId, label) {
      var a = allActions.find(function(x) { return x.id === actionId; });
      if (!a || a.status === 'Dead') return;
      var current = (a.who || {})[label] || '';

      // Ensure team is loaded
      var members = teamMembers.length > 0 ? teamMembers : DEFAULT_TEAM;
      var options = '<option value="">- Select Team Member -</option>';
      for (var i = 0; i < members.length; i++) {
        var sel = (members[i].name === current) ? ' selected' : '';
        options += '<option value="' + esc(members[i].name) + '"' + sel + '>' + esc(members[i].name) + '</option>';
      }

      var overlay = document.createElement('div');
      overlay.className = 'modal-overlay show';
      overlay.innerHTML = '<div class="modal-card" style="max-width:360px"><div class="modal-hdr"><h3><svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg> Assigned to Who?</h3><p>' + esc(label) + ' - ' + esc(a.company) + '</p></div><div class="modal-body"><select id="whoEditSelect" style="width:100%;padding:10px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px">' + options + '</select></div><div class="modal-footer"><button class="btn-cancel" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn-save" onclick="saveWho(\'' + actionId + '\',\'' + label + '\',this)">Save</button></div></div>';
      document.body.appendChild(overlay);
    }

    async function saveWho(actionId, label, btn) {
      var val = document.getElementById('whoEditSelect').value;
      var a = allActions.find(function(x) { return x.id === actionId; });
      if (!a) return;
      var oldWho = JSON.parse(JSON.stringify(a.who || {}));
      if (!a.who) a.who = {};
      a.who[label] = val;
      btn.closest('.modal-overlay').remove();
      renderTable();

      try {
        var res = await fetch(WEB_APP_URL, {
          method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'},
          body: JSON.stringify({action:'updateFollowUpAction', actionId:actionId, updates:{who:a.who}})
        });
        var data = await res.json();
        if (data.status !== 'success') throw new Error(data.message);
      } catch(e) {
        a.who = oldWho;
        renderTable();
        showToast('Error: ' + e.message, 'error');
      }
    }

    function editNotes(actionId) {
      var a = allActions.find(function(x) { return x.id === actionId; });
      if (!a) return;
      var overlay = document.createElement('div');
      overlay.className = 'notes-edit-overlay';
      overlay.innerHTML = '<div class="notes-edit-card"><div class="notes-edit-header"><div><h3>' + esc(a.company) + '</h3></div><button onclick="this.closest(\'.notes-edit-overlay\').remove()" style="background:none;border:none;color:#fff;font-size:20px;cursor:pointer">&#10005;</button></div><div class="notes-edit-body"><textarea id="notesEditArea">' + esc(a.notes || '') + '</textarea></div><div class="notes-edit-footer"><button onclick="this.closest(\'.notes-edit-overlay\').remove()" style="background:#e2e8f0;color:#4a5568">Cancel</button><button onclick="saveNotes(\'' + actionId + '\')" style="background:#10b981;color:#fff">Save Notes</button></div></div>';
      document.body.appendChild(overlay);
      document.getElementById('notesEditArea').focus();
    }

    async function saveNotes(actionId) {
      var val = document.getElementById('notesEditArea').value.trim();
      try {
        var res = await fetch(WEB_APP_URL, {
          method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'},
          body: JSON.stringify({action:'updateFollowUpAction', actionId:actionId, updates:{notes:val}})
        });
        var data = await res.json();
        if (data.status !== 'success') throw new Error(data.message);
        var a = allActions.find(function(x) { return x.id === actionId; });
        if (a) a.notes = val;
        renderTable();
        showToast('Notes saved', 'success');
      } catch(e) { showToast('Error: ' + e.message, 'error'); }
      var overlay = document.querySelector('.notes-edit-overlay');
      if (overlay) overlay.remove();
    }

    // ?????????? ALERT ??????????
    async function sendAlert(actionId) {
      var a = allActions.find(function(x) { return x.id === actionId; });
      if (!a) return;
      showToast('Alert sent for ' + a.company, 'success');
    }

    // ?????????? NAV / PLACEHOLDER STUBS ??????????
    function goToLeadDB() { window.location.href = 'lead-logger.html'; }
    function openProposal(leadId) { showToast('Proposal generator opening...', 'success'); }
    function openTeamModal() {
      document.getElementById('teamModal').classList.add('show');
      document.getElementById('teamModalBody').innerHTML = '<div class="loading" style="padding:30px"><div class="spinner"></div><p style="margin-top:8px">Loading team...</p></div>';
      loadTeamFromBackend();
    }

    function closeTeamModal() {
      document.getElementById('teamModal').classList.remove('show');
    }

    // Working copy for the modal
    var teamMembers = [];
    var DEFAULT_TEAM = [
      {name:'Julie Garley',    email:'julie.g@abbondanzavending.com'},
      {name:'Andrew Torres',   email:'andrew.t@abbondanzavending.com'},
      {name:'Sam Mitchell',    email:'sam.m@abbondanzavending.com'}
    ];

    // Avatar color palette
    var AVATAR_COLORS = [
      'linear-gradient(135deg,#6366f1,#8b5cf6)',
      'linear-gradient(135deg,#059669,#10b981)',
      'linear-gradient(135deg,#f59e0b,#d97706)',
      'linear-gradient(135deg,#ef4444,#dc2626)',
      'linear-gradient(135deg,#3b82f6,#2563eb)',
      'linear-gradient(135deg,#ec4899,#db2777)',
      'linear-gradient(135deg,#14b8a6,#0d9488)',
      'linear-gradient(135deg,#f97316,#ea580c)'
    ];

    function getInitials(name) {
      if (!name) return '?';
      var parts = name.trim().split(/\s+/);
      if (parts.length >= 2) return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
      return parts[0].substring(0, 2).toUpperCase();
    }

    async function loadTeamFromBackend() {
      try {
        var res = await fetch(WEB_APP_URL + '?action=getTeamMembers');
        var data = await res.json();
        if (data.status === 'success' && data.members && data.members.length > 0) {
          teamMembers = JSON.parse(JSON.stringify(data.members));
        } else {
          teamMembers = JSON.parse(JSON.stringify(DEFAULT_TEAM));
        }
      } catch(e) {
        teamMembers = JSON.parse(JSON.stringify(DEFAULT_TEAM));
      }
      renderTeamModal();
    }

    function renderTeamModal() {
      var body = document.getElementById('teamModalBody');
      var h = '';

      // Add form
      h += '<div class="tm-add-row">';
      h += '  <input type="text" id="tmNewName" placeholder="Name" />';
      h += '  <input type="email" id="tmNewEmail" placeholder="Email" style="flex:1.5;min-width:180px" />';
      h += '  <button class="tbtn tbtn-green" onclick="addTeamMember()" style="font-size:12px;padding:8px 14px;flex-shrink:0"><svg viewBox="0 0 24 24" style="width:14px;height:14px"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg> Add</button>';
      h += '</div>';

      if (teamMembers.length === 0) {
        h += '<div class="tm-empty"><svg viewBox="0 0 24 24" style="width:32px;height:32px;stroke:#cbd5e0;fill:none;stroke-width:1.5;margin-bottom:8px;display:block;margin-left:auto;margin-right:auto"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>No team members yet. Add someone above.</div>';
      } else {
        for (var i = 0; i < teamMembers.length; i++) {
          var m = teamMembers[i];
          var color = AVATAR_COLORS[i % AVATAR_COLORS.length];
          h += '<div class="tm-item" id="tm-item-' + i + '">';
          h += '  <div class="tm-avatar" style="background:' + color + '">' + getInitials(m.name) + '</div>';
          h += '  <div class="tm-info"><div class="tm-name">' + esc(m.name) + '</div><div class="tm-email">' + esc(m.email) + '</div></div>';
          h += '  <button class="tm-remove" onclick="removeTeamMember(' + i + ')"><svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg> Remove</button>';
          h += '</div>';
        }
      }

      body.innerHTML = h;
    }

    function addTeamMember() {
      var nameInput = document.getElementById('tmNewName');
      var emailInput = document.getElementById('tmNewEmail');
      var name = nameInput.value.trim();
      var email = emailInput.value.trim();

      if (!name) { showToast('Please enter a name', 'error'); nameInput.focus(); return; }
      if (!email || email.indexOf('@') === -1) { showToast('Please enter a valid email', 'error'); emailInput.focus(); return; }

      // Check for duplicates
      for (var i = 0; i < teamMembers.length; i++) {
        if (teamMembers[i].email.toLowerCase() === email.toLowerCase()) {
          showToast('A team member with that email already exists', 'error');
          return;
        }
      }

      teamMembers.push({name: name, email: email});
      renderTeamModal();
      showToast(name + ' added to team', 'success');
    }

    function removeTeamMember(index) {
      var name = teamMembers[index].name;
      var item = document.getElementById('tm-item-' + index);
      if (item) {
        item.style.background = '#fef2f2';
        item.style.borderColor = '#fecaca';
        item.innerHTML = '<span style="color:#ef4444;font-weight:600;font-size:12px">Remove "' + esc(name) + '"?</span><div style="display:flex;gap:6px;margin-left:auto"><button class="tm-remove" style="color:#4a5568;border-color:#cbd5e0" onclick="renderTeamModal()">Cancel</button><button class="tm-remove" onclick="confirmRemoveTeamMember(' + index + ')"><svg viewBox="0 0 24 24" style="width:12px;height:12px;stroke:currentColor;fill:none;stroke-width:2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg> Confirm</button></div>';
      }
    }

    function confirmRemoveTeamMember(index) {
      teamMembers.splice(index, 1);
      renderTeamModal();
    }

    async function saveTeamToBackend() {
      var btn = document.getElementById('saveTeamBtn');
      btn.disabled = true;
      btn.textContent = 'Saving...';

      try {
        var res = await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
          body: JSON.stringify({ action: 'saveTeamMembers', members: teamMembers })
        });
        var data = await res.json();
        if (data.status !== 'success') throw new Error(data.message || 'Save failed');
        showToast('Team members saved', 'success');
        closeTeamModal();
      } catch(e) {
        showToast('Error saving team: ' + e.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Save Team';
      }
    }
    function openAttemptsModal() {
      document.getElementById('attemptsModal').classList.add('show');
      // Load current value
      document.getElementById('maxAttemptsInput').value = maxAttempts;
      document.getElementById('asPreviewNum').textContent = maxAttempts;
      // Live-update preview when input changes
      document.getElementById('maxAttemptsInput').oninput = function() {
        var v = parseInt(this.value) || 5;
        document.getElementById('asPreviewNum').textContent = v;
      };
    }

    function closeAttemptsModal() {
      document.getElementById('attemptsModal').classList.remove('show');
    }

    async function saveAttemptsToBackend() {
      var val = parseInt(document.getElementById('maxAttemptsInput').value);
      if (!val || val < 1 || val > 20) {
        showToast('Enter a number between 1 and 20', 'error');
        return;
      }
      var btn = document.getElementById('saveAttemptsBtn');
      btn.disabled = true;
      btn.textContent = 'Saving...';

      try {
        var res = await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
          body: JSON.stringify({ action: 'saveMaxAttempts', maxAttempts: val })
        });
        var data = await res.json();
        if (data.status !== 'success') throw new Error(data.message || 'Save failed');
        maxAttempts = val;
        showToast('Max attempts set to ' + val, 'success');
        closeAttemptsModal();
      } catch(e) {
        showToast('Error saving: ' + e.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Save';
      }
    }
    // ??????????????????????????????????????????????
    //  EMAIL TEMPLATES ? FULL IMPLEMENTATION
    // ??????????????????????????????????????????????

    var emailTemplates = [];
    var etEditingId = null; // null = list view, 'new' = adding, or template ID = editing
    var etPreviewTemplateId = null; // template being previewed for sending

    var etSendingActionId = null; // Track which action we're sending to

    function openTemplatesModal(singleId) {
      etEditingId = null;
      etSendingActionId = null;
      etPreviewTemplateId = null;
      document.getElementById('templatesModal').classList.add('show');
      renderTemplatesModal();
      // Background refresh
      loadTemplatesFromBackend();
    }

    function closeTemplatesModal() {
      document.getElementById('templatesModal').classList.remove('show');
      etEditingId = null;
      etSendingActionId = null;
      etPreviewTemplateId = null;
    }

    async function loadTemplatesFromBackend() {
      // Instant load from cache first
      try {
        var cached = localStorage.getItem('emailTemplatesCache');
        if (cached) { emailTemplates = JSON.parse(cached); }
      } catch(e) {}
      // Then refresh from backend in background
      try {
        var res = await fetch(WEB_APP_URL + '?action=getEmailTemplates');
        var data = await res.json();
        if (data.status === 'success') {
          emailTemplates = data.templates || [];
          try { localStorage.setItem('emailTemplatesCache', JSON.stringify(emailTemplates)); } catch(e) {}
        }
      } catch(e) {
        // Keep cache on error
      }
      // Only re-render if not in edit mode
      if (etEditingId === null) {
        renderTemplatesModal();
      }
    }

    function renderTemplatesModal() {
      var body = document.getElementById('templatesModalBody');
      if (!body) return;

      // If editing/adding, show form
      if (etEditingId !== null) {
        renderTemplateForm(body);
        return;
      }

      // If previewing a template for send
      if (etSendingActionId && etPreviewTemplateId) {
        renderSendPreview(body);
        return;
      }

      // List view
      var h = '';

      // Show recipient banner when sending
      if (etSendingActionId) {
        var action = allActions.find(function(x) { return x.id === etSendingActionId; });
        if (action) {
          var recipientEmail = action.email || '';
          var recipientName = action.contact || action.company || '';
          h += '<div style="padding:12px 16px;background:#ecfdf5;border:1px solid #a7f3d0;border-radius:8px;margin-bottom:12px;display:flex;align-items:center;gap:10px">';
          h += '<svg viewBox="0 0 24 24" style="width:18px;height:18px;stroke:#059669;fill:none;stroke-width:2;flex-shrink:0"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>';
          h += '<div><div style="font-weight:600;font-size:13px;color:#065f46">Sending to: ' + esc(recipientName) + '</div>';
          h += '<div style="font-size:12px;color:#047857">' + (recipientEmail ? esc(recipientEmail) : '<span style="color:#ef4444">No email on file</span>') + '</div></div></div>';
        }
      }

      h += '<div class="et-toolbar">';
      h += '  <span style="font-size:13px;color:#64748b;font-weight:500">' + emailTemplates.length + ' template' + (emailTemplates.length !== 1 ? 's' : '') + '</span>';
      h += '  <button class="tbtn tbtn-green" onclick="startNewTemplate()" style="font-size:12px;padding:8px 16px"><svg viewBox="0 0 24 24" style="width:14px;height:14px"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg> New Template</button>';
      h += '</div>';

      if (emailTemplates.length === 0) {
        h += '<div class="et-empty"><svg viewBox="0 0 24 24" style="width:36px;height:36px;stroke:#cbd5e0;fill:none;stroke-width:1.5;margin-bottom:8px;display:block;margin-left:auto;margin-right:auto"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>No email templates yet.<br>Create one to start sending follow-up emails.</div>';
      } else {
        h += '<div class="et-list">';
        for (var i = 0; i < emailTemplates.length; i++) {
          var t = emailTemplates[i];
          h += '<div class="et-item" id="et-item-' + i + '">';
          h += '  <div class="et-icon"><svg viewBox="0 0 24 24"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></div>';
          h += '  <div class="et-info"><div class="et-name">' + esc(t.name) + '</div><div class="et-subject">' + esc(t.subject || 'No subject') + '</div></div>';
          h += '  <div class="et-actions">';
          if (etSendingActionId) {
            h += '    <button class="et-btn" style="color:#059669;border-color:#a7f3d0;background:#ecfdf5" onclick="previewTemplate(\'' + t.id + '\')"><svg viewBox="0 0 24 24" style="width:11px;height:11px;stroke:currentColor;fill:none;stroke-width:2"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg> Use</button>';
          }
          h += '    <button class="et-btn edit" onclick="startEditTemplate(\'' + t.id + '\')"><svg viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg> Edit</button>';
          h += '    <button class="et-btn del" onclick="deleteTemplate(\'' + t.id + '\',' + i + ')"><svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg> Delete</button>';
          h += '  </div>';
          h += '</div>';
        }
        h += '</div>';
      }

      body.innerHTML = h;
    }

    function startNewTemplate() {
      etEditingId = 'new';
      renderTemplatesModal();
    }

    function startEditTemplate(id) {
      etEditingId = id;
      renderTemplatesModal();
    }

    function renderTemplateForm(body) {
      var isNew = (etEditingId === 'new');
      var t = isNew ? {name:'', subject:'', body:''} : emailTemplates.find(function(x) { return x.id === etEditingId; });
      if (!t) { etEditingId = null; renderTemplatesModal(); return; }

      var h = '';
      h += '<div class="et-form">';
      h += '  <h4><svg viewBox="0 0 24 24" style="width:16px;height:16px;stroke:#1e293b;fill:none;stroke-width:2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg> ' + (isNew ? 'New Template' : 'Edit Template') + '</h4>';

      h += '  <div class="et-field"><label>Template Name</label><input type="text" id="etName" value="' + esc(t.name) + '" placeholder="e.g. Initial Outreach"/></div>';
      h += '  <div class="et-field"><label>Email Subject</label><input type="text" id="etSubject" value="' + esc(t.subject) + '" placeholder="e.g. Following up on our conversation"/></div>';
      h += '  <div class="et-field"><label>Email Body</label><textarea id="etBody" placeholder="Type your email body here. Use placeholders like {Company} to auto-fill data.">' + esc(t.body) + '</textarea></div>';

      h += '  <div class="et-placeholders">';
      h += '    <div class="et-placeholders-title">Available Placeholders (click to insert):</div>';
      var placeholders = ['{Company}','{Contact}','{Email}','{Phone}','{Rep}','{Date}'];
      for (var i = 0; i < placeholders.length; i++) {
        h += '<span class="et-placeholder-tag" onclick="insertPlaceholder(\'' + placeholders[i] + '\')">' + placeholders[i] + '</span>';
      }
      h += '  </div>';

      h += '  <div class="et-form-actions">';
      h += '    <button class="btn-cancel" onclick="cancelTemplateEdit()" style="padding:7px 16px;font-size:12px">Cancel</button>';
      h += '    <button class="btn-save" id="etSaveBtn" onclick="saveTemplate()" style="padding:7px 16px;font-size:12px">' + (isNew ? 'Create Template' : 'Save Changes') + '</button>';
      h += '  </div>';
      h += '</div>';

      body.innerHTML = h;
    }

    function insertPlaceholder(tag) {
      var textarea = document.getElementById('etBody');
      if (!textarea) return;
      var start = textarea.selectionStart;
      var end = textarea.selectionEnd;
      var text = textarea.value;
      textarea.value = text.substring(0, start) + tag + text.substring(end);
      textarea.selectionStart = textarea.selectionEnd = start + tag.length;
      textarea.focus();
    }

    function cancelTemplateEdit() {
      etEditingId = null;
      renderTemplatesModal();
    }

    async function saveTemplate() {
      var name = document.getElementById('etName').value.trim();
      var subject = document.getElementById('etSubject').value.trim();
      var bodyText = document.getElementById('etBody').value.trim();

      if (!name) { showToast('Template name is required', 'error'); return; }
      if (!subject) { showToast('Subject line is required', 'error'); return; }
      if (!bodyText) { showToast('Email body is required', 'error'); return; }

      var isNew = (etEditingId === 'new');
      var payload;

      if (isNew) {
        var tempId = 'temp_' + Date.now();
        emailTemplates.push({id: tempId, name: name, subject: subject, body: bodyText});
        payload = { action: 'addEmailTemplate', template: { name: name, subject: subject, body: bodyText } };
      } else {
        var t = emailTemplates.find(function(x) { return x.id === etEditingId; });
        if (t) { t.name = name; t.subject = subject; t.body = bodyText; }
        payload = { action: 'updateEmailTemplate', templateId: etEditingId, updates: { name: name, subject: subject, body: bodyText } };
      }

      etEditingId = null;
      renderTemplatesModal();

      try {
        var res = await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
          body: JSON.stringify(payload)
        });
        var data = await res.json();
        if (data.status !== 'success') throw new Error(data.message || 'Save failed');
        // Sync real IDs from backend
        loadTemplatesFromBackend();
      } catch(e) {
        showToast('Error saving: ' + e.message, 'error');
        loadTemplatesFromBackend();
      }
    }

    function deleteTemplate(id, index) {
      var item = document.getElementById('et-item-' + index);
      var name = emailTemplates[index].name;
      if (item) {
        item.style.background = '#fef2f2';
        item.style.borderColor = '#fecaca';
        item.innerHTML = '<span style="color:#ef4444;font-weight:600;font-size:12px">Delete "' + esc(name) + '"?</span><div style="display:flex;gap:6px;margin-left:auto"><button class="et-btn" style="color:#4a5568;border-color:#cbd5e0" onclick="renderTemplatesModal()">Cancel</button><button class="et-btn del" onclick="confirmDeleteTemplate(\'' + id + '\')"><svg viewBox="0 0 24 24" style="width:11px;height:11px;stroke:currentColor;fill:none;stroke-width:2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg> Confirm</button></div>';
      }
    }

    async function confirmDeleteTemplate(id) {
      emailTemplates = emailTemplates.filter(function(t) { return t.id !== id; });
      renderTemplatesModal();

      try {
        var res = await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
          body: JSON.stringify({ action: 'deleteEmailTemplate', templateId: id })
        });
        var data = await res.json();
        if (data.status !== 'success') throw new Error(data.message || 'Delete failed');
      } catch(e) {
        showToast('Error: ' + e.message, 'error');
        loadTemplatesFromBackend();
      }
    }

    // ?? Preview template before sending ??
    function previewTemplate(templateId) {
      etPreviewTemplateId = templateId;
      renderTemplatesModal();
    }

    function fillPlaceholders(text, action) {
      if (!text && text !== 0) return '';
      text = String(text);
      var a = action || {};
      var today = new Date();
      var mm = String(today.getMonth()+1).padStart(2,'0');
      var dd = String(today.getDate()).padStart(2,'0');
      var yyyy = today.getFullYear();
      return text
        .replace(/\{Company\}/gi, a.company || '')
        .replace(/\{Contact\}/gi, a.contact || '')
        .replace(/\{Email\}/gi, a.email || '')
        .replace(/\{Phone\}/gi, a.phone || '')
        .replace(/\{Rep\}/gi, Object.values(a.who || {})[0] || '')
        .replace(/\{Date\}/gi, mm + '/' + dd + '/' + yyyy);
    }

    function renderSendPreview(body) {
      var template = emailTemplates.find(function(t) { return t.id === etPreviewTemplateId; });
      var action = allActions.find(function(a) { return a.id === etSendingActionId; });
      if (!template || !action) { etPreviewTemplateId = null; renderTemplatesModal(); return; }

      var filledSubject = fillPlaceholders(template.subject || '', action);
      var filledBody = fillPlaceholders(template.body || '', action);
      var recipientEmail = action.email || '';
      var recipientName = action.contact || action.company || '';

      var h = '';
      h += '<div style="margin-bottom:16px">';
      h += '<button class="tbtn" style="padding:5px 12px;font-size:11px;background:#64748b" onclick="etPreviewTemplateId=null;renderTemplatesModal()">\u2190 Back to Templates</button>';
      h += '</div>';

      // Recipient info
      h += '<div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:14px;margin-bottom:14px">';
      h += '<div style="display:flex;gap:12px;align-items:start;flex-wrap:wrap">';
      h += '<div style="flex:1;min-width:200px"><div style="font-size:11px;color:#64748b;font-weight:600;margin-bottom:2px">TO</div>';
      h += '<div style="font-size:13px;font-weight:600;color:#1e293b">' + esc(recipientName) + '</div>';
      h += '<div style="font-size:12px;color:#2563eb">' + (recipientEmail ? esc(recipientEmail) : '<span style="color:#ef4444;font-weight:600">No email on file &mdash; add email in Lead Database first</span>') + '</div></div>';
      h += '<div style="flex:1;min-width:200px"><div style="font-size:11px;color:#64748b;font-weight:600;margin-bottom:2px">SUBJECT</div>';
      h += '<div style="font-size:13px;color:#1e293b">' + esc(filledSubject) + '</div></div>';
      h += '</div></div>';

      // Body preview
      h += '<div style="background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:16px;margin-bottom:14px;min-height:120px">';
      h += '<div style="font-size:11px;color:#64748b;font-weight:600;margin-bottom:8px">BODY PREVIEW</div>';
      h += '<div style="font-size:13px;color:#2d3748;line-height:1.6;white-space:pre-wrap">' + esc(filledBody) + '</div>';
      h += '</div>';

      // Send button
      h += '<div style="display:flex;justify-content:flex-end;gap:8px">';
      h += '<button class="btn-cancel" onclick="etPreviewTemplateId=null;renderTemplatesModal()" style="padding:8px 16px;font-size:12px">Cancel</button>';
      if (recipientEmail) {
        h += '<button class="btn-save" id="sendEmailBtn" onclick="sendTemplateEmail()" style="padding:8px 20px;font-size:13px;background:linear-gradient(135deg,#10b981,#059669)"><svg viewBox="0 0 24 24" style="width:14px;height:14px;stroke:#fff;fill:none;stroke-width:2;vertical-align:-2px;margin-right:4px"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>Send Email</button>';
      } else {
        h += '<button disabled style="padding:8px 20px;font-size:13px;background:#cbd5e0;color:#fff;border:none;border-radius:6px;cursor:not-allowed">No Email Address</button>';
      }
      h += '</div>';

      body.innerHTML = h;
    }

    async function sendTemplateEmail() {
      var template = emailTemplates.find(function(t) { return t.id === etPreviewTemplateId; });
      var action = allActions.find(function(a) { return a.id === etSendingActionId; });
      if (!template || !action || !action.email) return;

      var btn = document.getElementById('sendEmailBtn');
      if (btn) { btn.disabled = true; btn.textContent = 'Sending...'; }

      var filledSubject = fillPlaceholders(template.subject || '', action);
      var filledBody = fillPlaceholders(template.body || '', action);

      try {
        var res = await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
          body: JSON.stringify({
            action: 'sendFollowUpEmail',
            to: action.email,
            subject: filledSubject,
            body: filledBody,
            actionId: action.id,
            templateId: template.id
          })
        });
        var data = await res.json();
        if (data.status !== 'success') throw new Error(data.message || 'Send failed');
        showToast('Email sent to ' + action.email, 'success');
        closeTemplatesModal();
      } catch(e) {
        showToast('Error sending email: ' + e.message, 'error');
        if (btn) { btn.disabled = false; btn.innerHTML = '<svg viewBox="0 0 24 24" style="width:14px;height:14px;stroke:#fff;fill:none;stroke-width:2;vertical-align:-2px;margin-right:4px"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>Send Email'; }
      }
    }


    // ??????????????????????????????????????????????
    //  LABEL SETTINGS MODAL ? FULL IMPLEMENTATION
    // ??????????????????????????????????????????????

    function openLabelsModal() {
      labelsExpandedIndex = -1;
      document.getElementById('labelsModal').classList.add('show');
      document.getElementById('labelsModalBody').innerHTML = '<div class="loading" style="padding:30px"><div class="spinner"></div><p style="margin-top:8px">Loading labels...</p></div>';
      loadLabelsFromBackend();
    }

    function closeLabelsModal() {
      document.getElementById('labelsModal').classList.remove('show');
    }

    async function loadLabelsFromBackend() {
      try {
        var res = await fetch(WEB_APP_URL + '?action=getLabels');
        var data = await res.json();
        if (data.status === 'success' && data.labels && data.labels.length > 0) {
          labelsConfig = JSON.parse(JSON.stringify(data.labels));
        } else {
          labelsConfig = JSON.parse(JSON.stringify(DEFAULT_LABELS));
        }
      } catch(e) {
        labelsConfig = JSON.parse(JSON.stringify(DEFAULT_LABELS));
      }
      renderLabelsModal();
    }

    function renderLabelsModal() {
      var body = document.getElementById('labelsModalBody');
      var h = '';

      // Add label button
      h += '<div class="ls-add-row"><button class="tbtn tbtn-green" onclick="addNewLabel()" style="font-size:12px;padding:8px 16px"><svg viewBox="0 0 24 24" style="width:14px;height:14px"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg> Add Label</button></div>';

      for (var i = 0; i < labelsConfig.length; i++) {
        var lb = labelsConfig[i];
        var pillCss = getLabelPillStyle(lb);
        var isExpanded = (labelsExpandedIndex === i);

        // Summary tags
        var tags = '';
        if (lb.requiresDate) {
          tags += '<span class="ls-tag ls-tag-date"><svg viewBox="0 0 24 24" style="width:10px;height:10px;stroke:currentColor;fill:none;stroke-width:2;vertical-align:-1px;margin-right:2px"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg> Date Required</span>';
        } else {
          tags += '<span class="ls-tag ls-tag-nodate">No Date</span>';
        }
        if (lb.emailReminder) {
          tags += '<span class="ls-tag ls-tag-email-rem"><svg viewBox="0 0 24 24" style="width:10px;height:10px;stroke:currentColor;fill:none;stroke-width:2;vertical-align:-1px;margin-right:2px"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg> Email: ' + lb.emailDaysBefore + 'd before</span>';
        }
        if (lb.loginPopup) {
          tags += '<span class="ls-tag ls-tag-popup"><svg viewBox="0 0 24 24" style="width:10px;height:10px;stroke:currentColor;fill:none;stroke-width:2;vertical-align:-1px;margin-right:2px"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg> Popup: ' + lb.loginDaysAfter + 'd after</span>';
        }
        if (!lb.emailReminder && !lb.loginPopup) {
          tags += '<span class="ls-tag ls-tag-norem">No Reminders</span>';
        }
        if (lb.trackAttempts === false) {
          tags += '<span class="ls-tag" style="background:#f1f5f9;color:#64748b">No Counter</span>';
        }

        // Label item row
        h += '<div class="ls-item" id="ls-item-' + i + '">';
        h += '  <span class="ls-pill" style="' + pillCss + '">' + esc(lb.name) + '</span>';
        h += '  <div class="ls-tags">' + tags + '</div>';
        h += '  <button class="ls-edit-btn" onclick="toggleLabelPanel(' + i + ')">';
        h += '    <svg viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>';
        h += '    Edit';
        h += '  </button>';
        h += '</div>';

        // Expandable edit panel
        h += '<div class="ls-panel' + (isExpanded ? ' open' : '') + '" id="ls-panel-' + i + '">';
        h += '  <h4><svg viewBox="0 0 24 24" style="width:16px;height:16px;stroke:#1e293b;fill:none;stroke-width:2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg> Edit: ' + esc(lb.name) + '</h4>';

        // Label Name
        h += '  <div class="ls-field"><label>Label Name</label><input type="text" value="' + esc(lb.name) + '" onchange="updateLabelField(' + i + ',\'name\',this.value)"/></div>';

        // Requires Date toggle
        h += '  <div class="ls-toggle-row"><div class="ls-toggle' + (lb.requiresDate ? ' on' : '') + '" onclick="toggleLabelBool(' + i + ',\'requiresDate\',this)"></div><span class="ls-toggle-label">Requires Date</span></div>';

        // Track Attempts toggle
        h += '  <div class="ls-toggle-row"><div class="ls-toggle' + (lb.trackAttempts !== false ? ' on' : '') + '" onclick="toggleLabelBool(' + i + ',\'trackAttempts\',this)"></div><span class="ls-toggle-label">Track Attempts</span></div>';

        // Email Reminder toggle
        h += '  <div class="ls-toggle-row"><div class="ls-toggle' + (lb.emailReminder ? ' on' : '') + '" onclick="toggleLabelBool(' + i + ',\'emailReminder\',this)"></div><span class="ls-toggle-label">Email Reminder</span></div>';

        // Days BEFORE (shown if emailReminder on)
        h += '  <div class="ls-indent" id="ls-emaildays-' + i + '" style="' + (lb.emailReminder ? '' : 'display:none') + '"><label>Days BEFORE date</label><input type="number" min="0" max="30" value="' + (lb.emailDaysBefore || 0) + '" onchange="updateLabelField(' + i + ',\'emailDaysBefore\',parseInt(this.value)||0)"/></div>';

        // Login Popup toggle
        h += '  <div class="ls-toggle-row"><div class="ls-toggle' + (lb.loginPopup ? ' on' : '') + '" onclick="toggleLabelBool(' + i + ',\'loginPopup\',this)"></div><span class="ls-toggle-label">Follow-Up Reminder (login popup)</span></div>';

        // Days AFTER (shown if loginPopup on)
        h += '  <div class="ls-indent" id="ls-popupdays-' + i + '" style="' + (lb.loginPopup ? '' : 'display:none') + '"><label>Days AFTER date to force follow-up</label><input type="number" min="0" max="30" value="' + (lb.loginDaysAfter || 0) + '" onchange="updateLabelField(' + i + ',\'loginDaysAfter\',parseInt(this.value)||0)"/></div>';

        // Delete label
        h += '  <div class="ls-delete-row"><button class="ls-delete-btn" onclick="deleteLabel(' + i + ')"><svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg> Delete Label</button></div>';

        h += '</div>';
      }

      body.innerHTML = h;
    }

    function getLabelPillStyle(lb) {
      return 'background:' + (lb.color || '#e2e8f0') + ';color:' + (lb.textColor || '#4a5568');
    }

    function toggleLabelPanel(index) {
      if (labelsExpandedIndex === index) {
        labelsExpandedIndex = -1;
      } else {
        labelsExpandedIndex = index;
      }
      renderLabelsModal();
    }

    function updateLabelField(index, field, value) {
      if (index >= 0 && index < labelsConfig.length) {
        labelsConfig[index][field] = value;
        // Re-render to update summary tags if name changed
        if (field === 'name') renderLabelsModal();
      }
    }

    function toggleLabelBool(index, field, el) {
      if (index >= 0 && index < labelsConfig.length) {
        labelsConfig[index][field] = !labelsConfig[index][field];
        el.classList.toggle('on');

        // Show/hide related indent fields
        if (field === 'emailReminder') {
          var indent = document.getElementById('ls-emaildays-' + index);
          if (indent) indent.style.display = labelsConfig[index][field] ? '' : 'none';
        }
        if (field === 'loginPopup') {
          var indent = document.getElementById('ls-popupdays-' + index);
          if (indent) indent.style.display = labelsConfig[index][field] ? '' : 'none';
        }
      }
    }

    function addNewLabel() {
      labelsConfig.push({
        name: 'New Label',
        requiresDate: false,
        emailReminder: false,
        emailDaysBefore: 0,
        loginPopup: false,
        loginDaysAfter: 0,
        trackAttempts: true,
        color: '#e2e8f0',
        textColor: '#4a5568'
      });
      labelsExpandedIndex = labelsConfig.length - 1;
      renderLabelsModal();
      // Scroll to bottom
      var body = document.getElementById('labelsModalBody');
      body.scrollTop = body.scrollHeight;
    }

    function deleteLabel(index) {
      if (labelsConfig.length <= 1) {
        showToast('Cannot delete the last label', 'error');
        return;
      }
      var name = labelsConfig[index].name;
      // Show inline confirmation
      var panel = document.getElementById('ls-panel-' + index);
      var item = document.getElementById('ls-item-' + index);
      if (panel) panel.remove();
      if (item) {
        item.style.background = '#fef2f2';
        item.style.borderColor = '#fecaca';
        item.innerHTML = '<span style="color:#ef4444;font-weight:600;font-size:12px">Delete "' + esc(name) + '"?</span><div style="display:flex;gap:6px;margin-left:auto"><button class="ls-edit-btn" style="color:#4a5568;border-color:#cbd5e0" onclick="renderLabelsModal()">Cancel</button><button class="ls-edit-btn" style="color:#ef4444;border-color:#fecaca;background:#fef2f2" onclick="confirmDeleteLabel(' + index + ')"><svg viewBox="0 0 24 24" style="width:12px;height:12px;stroke:currentColor;fill:none;stroke-width:2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg> Confirm</button></div>';
      }
    }

    function confirmDeleteLabel(index) {
      labelsConfig.splice(index, 1);
      if (labelsExpandedIndex === index) labelsExpandedIndex = -1;
      else if (labelsExpandedIndex > index) labelsExpandedIndex--;
      renderLabelsModal();
    }

    async function saveLabelsToBackend() {
      // Validate: no empty names, no duplicates
      for (var i = 0; i < labelsConfig.length; i++) {
        if (!labelsConfig[i].name || !labelsConfig[i].name.trim()) {
          showToast('Label at position ' + (i + 1) + ' has no name', 'error');
          return;
        }
      }
      var names = labelsConfig.map(function(l) { return l.name.trim().toLowerCase(); });
      var unique = new Set(names);
      if (unique.size !== names.length) {
        showToast('Duplicate label names found ? each label must have a unique name', 'error');
        return;
      }

      var btn = document.getElementById('saveLabelsBtn');
      btn.disabled = true;
      btn.textContent = 'Saving...';

      try {
        var res = await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
          body: JSON.stringify({ action: 'saveLabels', labels: labelsConfig })
        });
        var data = await res.json();
        if (data.status !== 'success') throw new Error(data.message || 'Save failed');
        showToast('Label settings saved', 'success');
        closeLabelsModal();
      } catch(e) {
        showToast('Error saving labels: ' + e.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Save Labels';
      }
    }

    // ?????????? UTILS ??????????
    function esc(s) {
      if (!s) return '';
      var d = document.createElement('div');
      d.textContent = String(s);
      return d.innerHTML;
    }

    function showToast(msg, type) {
      var c = document.getElementById('toastContainer');
      var icon = type === 'success'
        ? '<svg viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>'
        : '<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>';
      var t = document.createElement('div');
      t.className = 'toast toast-' + (type || 'success');
      t.innerHTML = icon + esc(msg);
      c.appendChild(t);
      setTimeout(function() { t.style.opacity = '0'; t.style.transform = 'translateY(-20px)'; setTimeout(function() { t.remove(); }, 300); }, 3000);
    }
  </script>
</body>
</html>







